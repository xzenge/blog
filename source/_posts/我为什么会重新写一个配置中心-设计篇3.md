---
title: 我为什么会手撸一个配置中心-设计篇（三）
date: 2020-04-12 14:29:58
tags: 
    - Java
    - Redis
    - 配置中心
categories :
    - Technology
---

## 功能&架构选型
在做具体的架构选型前，先要明确两个问题：我们的技术栈是什么？我们是为怎样的技术团队提供服务的。

#### 选型前的讨论
当前公司后端团队大量的采用了JAVA的技术栈，随着公司的发展围绕着Spring Cloud全家桶，团队已经搭建了相当多的业务服务。可以说我们设计的配合中心服务在最大限度上会以JAVA为基础，围绕着Spring的生态圈进行设计并开发。

那么回到我们之前的架构选型话题，可以将问题改为：如何围绕Spring的生命周期，实现一套配置灵活、管理简洁、值热更新的系统。
<!-- more -->
确定我们必须结合Spring后，接下来需要明确的就是，如何实现配置的热更新。目前开源的配置中心有这么几种解决方案：

方式|中间件|优点|缺点
|---|---|---|---|
|服务端调用客户端Api进行推送|无需|实现简单<br>无需引入第三方中间件|依赖Http请求过于重<br>自定义协议开发复杂<br>需要自己保证请求的可靠性 |
|客户端调用服务端Api进行拉取|无需|实现简单<br>无需引入第三方中间件|依赖Http请求过于重<br>自定义协议开发复杂<br>需要自己保证请求的可靠性 |
|依赖第三方中间件推送|Zookeeper、Redis、Nasco等|开发简单、不需要自己实现通讯<br>可依赖中间件自身的HA做高可用|增加了项目的复杂度<br>需要考虑中间件和当前项目的冲突问题|

对比了市场上的设计和我们的自身的人力成本，我们决定引入一款成熟中间件来解决大部分的通讯和配置发现问题。这个时候摆在我们面前的可选项其实还是很有限的，能胜任我们的需求的无非就是Zk、redis、MQ这几个。

这几个耳熟能详的中间件上来我们就放弃了zk，考虑主要有以下几点。
1. zk不适合做大量数据的存储，特别是配置这种结构化的数据。虽然zk的CP特性能为我们带来精准的配置推送特性，但是遇到大量的配置内容zk就显得力不从心。
2. zk的snapshot功能，一旦发现数据对其问题，需要停机人工处理。
3. 近年来zk在服务注册发现上大展拳脚，但我始终认为zk在作为注册中心时会显得捉襟见肘，元数据管理才是它真正运用的领域。这一点正好契合我们的契机，不过不巧的是我们想要开发的并不是一个分布式的配置中心，或者说分布式并不是我们的中心。反而分布式的配置管理才是我们最好的选择。
   
剩下就是MQ和redis中做选择，他们两个就比较好抉择了。MQ和Redis都可以做到HA、变更的实时推送、但是MQ没法做到数据的管理。加上我们的系统里已近大量的使用到了redis，对redis的操作也比较熟悉。最终我们选择了redis作为中间件为我们的配置中心做配置的统一管理。