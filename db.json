{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"themes/minos/source/css/insight.scss","path":"css/insight.scss","modified":0,"renderable":1},{"_id":"themes/minos/source/css/style.scss","path":"css/style.scss","modified":0,"renderable":1},{"_id":"themes/minos/source/images/check.svg","path":"images/check.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/exclamation.svg","path":"images/exclamation.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/info.svg","path":"images/info.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/logo.png","path":"images/logo.png","modified":0,"renderable":1},{"_id":"themes/minos/source/images/question.svg","path":"images/question.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/images/quote-left.svg","path":"images/quote-left.svg","modified":0,"renderable":1},{"_id":"themes/minos/source/js/insight.js","path":"js/insight.js","modified":0,"renderable":1},{"_id":"themes/minos/source/js/script.js","path":"js/script.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/about/index.md","hash":"b643368607613240c4742a761c9be09abbd05379","modified":1607939484080},{"_id":"source/_posts/CSAPP-Docker实验环境搭建.md","hash":"5e3a2161cb779453ae28358f42fd3affc889fbb9","modified":1607942260145},{"_id":"source/_posts/Harmonica.md","hash":"4e2d76fe1a62f1bfd884e14c99bf55390d0ad343","modified":1607942434911},{"_id":"source/_posts/JVM-整理.md","hash":"7b44bfe755f72bcc8171139cfa2140da217bb0b4","modified":1607939484008},{"_id":"source/_posts/NIO.md","hash":"8ead196555b8d598e0f5219f6106229e78509f76","modified":1607939484008},{"_id":"source/_posts/Spring-Boot.md","hash":"d5955ad7f7f0448aa515e2a559d4a12c0e3eadae","modified":1607939484008},{"_id":"source/_posts/fastjson序列化异常排查.md","hash":"c74cfffbe76bd32bfa1a6c3b4162587b7c065a14","modified":1607942386423},{"_id":"source/_posts/hexo搭建问题【-no-layout-index-html】.md","hash":"bf224ed7bb81c5298e6d7a9fea9a1048ed5ba948","modified":1607942439272},{"_id":"source/_posts/linux提供加载、处理动态链接库的系统调用方法.md","hash":"2e4648cf9536cd2f66105aa8a3833fe9dca9b1bf","modified":1607939484016},{"_id":"source/_posts/一个事故引起的缓存.md","hash":"497e9ecf448a4836949efa1230bc018f0d5f52ce","modified":1607942123746},{"_id":"source/_posts/分布式一致性算法整理.md","hash":"3fabac6594716259e343ceb1d6202ce8f252b098","modified":1607939484018},{"_id":"source/_posts/分布式事务整理.md","hash":"f22d9fd94e4bdf027990d4bc815c17510ef1e6ad","modified":1607939484018},{"_id":"source/_posts/分支预测-GCC-builtin-expect.md","hash":"153e57bde8c81aa14015e001a69cf86e8bda8d14","modified":1608170153102},{"_id":"source/_posts/基于Flink实现简单的日志异常推送.md","hash":"5f01d2b41a6b635a0837dfae23d4cc8c65d7e2e1","modified":1607939484018},{"_id":"source/_posts/基于Flink推送报警信息-测试.md","hash":"e8f416fd2efbca2b4552af9ef1986f7c38f2658b","modified":1607941412989},{"_id":"source/_posts/基于Flink设计统一报警平台.md","hash":"e6f7f521cec24e72372185c417b22aa62e001d4d","modified":1607939484020},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇.md","hash":"95f463c2166cdea44dae52aef8a723cb433db2dc","modified":1607942024564},{"_id":"source/_posts/我为什么会重新写一个配置中心-代码篇.md","hash":"0c1f19088800d271f3afd480aa0efd05cc486dd0","modified":1607939484047},{"_id":"source/_posts/我为什么会重新写一个配置中心-设计篇.md","hash":"20d15e2ad79a7f6224cdf2a962cf60552311e3b8","modified":1607939484047},{"_id":"source/_posts/我为什么会重新写一个配置中心-设计篇2.md","hash":"5a441935628a02cedb414f68b63f610ced08939c","modified":1607942074801},{"_id":"source/_posts/我为什么会重新写一个配置中心-设计篇3.md","hash":"d05084c5fb7b282325c4ac71b0c08091c219c530","modified":1607939484049},{"_id":"source/_posts/我为什么会重新写一个配置中心-起源篇.md","hash":"e78fe30dd28d0f57535391e478e25325bc38ecf5","modified":1607939484050},{"_id":"source/_posts/搜寻流浪狗APP.md","hash":"d6bdcdfd64e797326fb059651936a4a7ec1b7d2d","modified":1607939484050},{"_id":"source/_posts/深度解析JVM-动态Attach原理.md","hash":"5ceb2899191e733898a9ed8c18c9216b29b694d7","modified":1607941677231},{"_id":"source/_posts/自己动手写Java虚拟机-笔记1.md","hash":"25fc284fe9b1359d3143e3eb274126d4fde9cb3e","modified":1607942149430},{"_id":"source/_posts/自定义配置文件读取-解析.md","hash":"0eb726e12b9ef0716402b2a684013a2db66b47b5","modified":1607939484054},{"_id":"source/_posts/自己动手写Java虚拟机-笔记2.md","hash":"21c2f49bd18fa61934828232874d5fc15d0622da","modified":1607939484055},{"_id":"source/_posts/自己动手写Java虚拟机-笔记3.md","hash":"dbc3737adfd45fb433822e6dab03a34bcf14e5bc","modified":1607939484056},{"_id":"source/_posts/自己动手写Java虚拟机-笔记4.md","hash":"b2c93b956937ace9dbf5cf59280b5a3277d8a475","modified":1607942174566},{"_id":"source/_posts/记一次序列化失败导致的生产问题.md","hash":"75f7bb0d613c30c31b3c2d8ffcf409dc60e7ec12","modified":1607941551707},{"_id":"source/categories/index.md","hash":"57a6b0750e78381e5bd96be4d3fd3a34a9147638","modified":1607939484080},{"_id":"source/_posts/🐇.md","hash":"e520a57f6e7778bd00ba12cf407ce0c4e759e4b8","modified":1607941076593},{"_id":"source/tags/index.md","hash":"5bc40eb8067b1b802f2f5e1beb961b72527b2355","modified":1607939484172},{"_id":"source/_posts/CSAPP-Docker实验环境搭建/pull.png","hash":"75df3bb37ab4153db6a76effdd1f3caa3fd26aae","modified":1607939484005},{"_id":"source/_posts/fastjson序列化异常排查/classload断点.png","hash":"b23555690fff99fec7bc4dd33042c62de64194ca","modified":1607939484012},{"_id":"source/_posts/fastjson序列化异常排查/idea.png","hash":"e3aa184adced51bc89141426a7e9eae9724dbb55","modified":1607939484014},{"_id":"source/_posts/fastjson序列化异常排查/jps.png","hash":"fdaf08415d96c17407a1f77a4c67bd69e218f8ad","modified":1607939484014},{"_id":"source/_posts/hexo搭建问题【-no-layout-index-html】/nolayout.jpg","hash":"b7e6217718a630562255060b224ee116d1caf824","modified":1607939484016},{"_id":"source/_posts/一个事故引起的缓存/springCache.png","hash":"244dfd7e60a2e01dbd8ed66d5f0828db5737c32d","modified":1607939484017},{"_id":"source/_posts/基于Flink推送报警信息-测试/flink-local.png","hash":"7b4ba65ffb265a902ba1857a4d9b44b87e780b77","modified":1607939484019},{"_id":"source/_posts/基于Flink推送报警信息-测试/rocketmq-dashboard.png","hash":"3992562c00d407b4e57860b7037eb0d8e63e22d8","modified":1607939484019},{"_id":"source/_posts/基于Flink推送报警信息-测试/rocketmq-message.png","hash":"71a6a78f475da2a55fae3fc6ae1339e1e9840238","modified":1607939484019},{"_id":"source/_posts/基于Flink推送报警信息-测试/rocketmq-topic.png","hash":"8e3049784ffdb24584139f37b5d6aff0943663fe","modified":1607939484020},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/addGroup.png","hash":"a5b0ba884bb632b2125bee606bf3016966692e4a","modified":1607939484021},{"_id":"source/_posts/基于Flink推送报警信息-测试/wechat-message.png","hash":"2f4f5d8186da8887cc614bc0941c3a0aa47377d0","modified":1607939484020},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/history.png","hash":"eb8dac42b2ba7119a89b7c74cbb81e56d03410f9","modified":1607939484030},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/instanceConfig.png","hash":"764b4c39797d533ab1195b65f32d06cc32ce819a","modified":1607939484031},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/switch.png","hash":"92060e35ba1f4220ebb8164c07cdf9da2e280fb7","modified":1607939484039},{"_id":"source/_posts/我为什么会重新写一个配置中心-设计篇2/CentOS6-Base-163.repo","hash":"c601efdaeb8c55cb0dea2cade8976c5a8de366ac","modified":1607939484048},{"_id":"source/_posts/我为什么会重新写一个配置中心-设计篇2/客户端启动并更新配置.png","hash":"fbae1f8e0ac320887b72000346d5dd079ed12a06","modified":1607939484049},{"_id":"source/_posts/我为什么会重新写一个配置中心-设计篇2/服务端热更新配置.png","hash":"985f1bfbd2bbdf087c49ff3b6f81f51ac5c81afc","modified":1607939484049},{"_id":"source/_posts/自己动手写Java虚拟机-笔记1/gopath.png","hash":"651d1a1fb00e3250828a1e1570d1ee3f842774ca","modified":1607939484055},{"_id":"themes/minos/.gitignore","hash":"8b02e7219e2dd9b50d198819fd7d8f74ebc9db2a","modified":1607939484172},{"_id":"themes/minos/LICENSE","hash":"ca01a2d52b59346e82f079c593df6cb26dd9a7a5","modified":1607939484172},{"_id":"themes/minos/README.md","hash":"ba6b4e134d718704cfd030e106bf24d6ef8b496d","modified":1607939484173},{"_id":"themes/minos/_config.yml","hash":"7ef78f4e125fc8453a76bcff6182e78c78b0acd1","modified":1607939484173},{"_id":"themes/minos/_config.yml.example","hash":"c16bbed955c4209e6bfdff834fa6281eb5be417d","modified":1607939484173},{"_id":"themes/minos/package.json","hash":"f9d450db80149dea6c372990cdf51dfde901e5cc","modified":1607939484186},{"_id":"themes/minos/languages/de.yml","hash":"3d6abea8c2990b04fcd54ffd88ab15356b5171e8","modified":1607939484173},{"_id":"themes/minos/languages/en.yml","hash":"24b8cf6b8fc989be612333aa5121808bb8cf029b","modified":1607939484174},{"_id":"themes/minos/languages/es.yml","hash":"5c35950221411e34e7a9821d0b0671da9a458d8c","modified":1607939484174},{"_id":"themes/minos/package-lock.json","hash":"e1fbecec56fb65379bf651f21fb485376e692b38","modified":1607939484186},{"_id":"themes/minos/languages/fr.yml","hash":"cca90260b00842bf73fadb3154c2969102cf80c0","modified":1607939484174},{"_id":"themes/minos/languages/ko.yml","hash":"1acf3f959f1d2b4f7a77e7e82851821aa8635362","modified":1607939484174},{"_id":"themes/minos/languages/pl.yml","hash":"cfd7c898b2841bf7a1490ebfaa3cbb40fd7da50d","modified":1607939484175},{"_id":"themes/minos/languages/ru.yml","hash":"dbb9bee79348e29098af6c56b14bbca6986e9795","modified":1607939484175},{"_id":"themes/minos/languages/zh-cn.yml","hash":"9c5a489b11a056d1ea7b9d4a0e127aef9e192ee4","modified":1607939484175},{"_id":"themes/minos/languages/zh-tw.yml","hash":"f61b67b9c454d16bc3973f6cb142b98a4e19f9b0","modified":1607939484175},{"_id":"themes/minos/layout/archive.ejs","hash":"e3eefe819d61b4d0ee069bb705a9f5707a8bf3da","modified":1607939484176},{"_id":"themes/minos/layout/categories.ejs","hash":"fff6f911d0f548ee749292bc1942f8fbbb1fbfe7","modified":1607939484176},{"_id":"themes/minos/layout/category.ejs","hash":"403c646878834964883ac41e63952f7b1595c0ba","modified":1607939484176},{"_id":"themes/minos/layout/layout.ejs","hash":"45588aa46857cf9403fa79d738ab37a46ddcf773","modified":1607939484182},{"_id":"themes/minos/layout/index.ejs","hash":"dff9e199d394f82c5416b814f9e644edbe4090f0","modified":1607939484181},{"_id":"themes/minos/lib/i18n.js","hash":"4c90aa27420e0e2ff74f80e976fe146e96354f61","modified":1607939484185},{"_id":"themes/minos/layout/tag.ejs","hash":"5593c7cf9618ef5650c779ed9d75424f057aa210","modified":1607939484185},{"_id":"themes/minos/layout/post.ejs","hash":"68b84a717efc5ca59ee9eb6202ccf05c5a8abda5","modified":1607939484183},{"_id":"themes/minos/lib/rfc5646.js","hash":"8ecf38d0ec7145720ea8e888da314131712770e8","modified":1607939484186},{"_id":"themes/minos/layout/tags.ejs","hash":"e4a9909119294f131a45f10b2cb1058af5fb9be1","modified":1607939484185},{"_id":"themes/minos/scripts/01_check.js","hash":"e53508ef82a1518ed7e663ce2d87544c20a50779","modified":1607939484187},{"_id":"themes/minos/scripts/10_i18n.js","hash":"9c1f9e3ec3c6299fc599769783925d1898a632f0","modified":1607939484187},{"_id":"themes/minos/scripts/99_config.js","hash":"d41a5df0a442728fbc66514476fe043e416d7438","modified":1607939484187},{"_id":"themes/minos/scripts/99_content.js","hash":"ff61d3d631b06024509d4fe28b4e31590a02f05b","modified":1607939484188},{"_id":"themes/minos/scripts/99_tags.js","hash":"f97c2332a7e13fed99672b27c4380a6183d8600e","modified":1607939484188},{"_id":"themes/minos/layout/comment/changyan.ejs","hash":"9ccc7ec354b968e60bdcfcd1dba451d38de61f12","modified":1607939484176},{"_id":"themes/minos/layout/comment/disqus.ejs","hash":"a2becdc02214a673c804af93488489807fa2c99c","modified":1607939484177},{"_id":"themes/minos/layout/comment/facebook.ejs","hash":"e73b6f93d98b27ba9068c1685874ecccfbac737b","modified":1607939484177},{"_id":"themes/minos/layout/comment/gitment.ejs","hash":"430416210933b7edcbfcc67ede4aa55539da2750","modified":1607939484177},{"_id":"themes/minos/layout/comment/isso.ejs","hash":"cc6a43bd24be764086f88ad7c5c97ff04df87e0b","modified":1607939484177},{"_id":"themes/minos/layout/comment/livere.ejs","hash":"12ff9a345f6bba2f732f592e39508c2afde89b00","modified":1607939484178},{"_id":"themes/minos/layout/comment/youyan.ejs","hash":"3d6cf9c523a7a5510ec2864bb29f861f9bb78af3","modified":1607939484178},{"_id":"themes/minos/layout/comment/valine.ejs","hash":"b0eef3bea0a54b4b66f860ad69889f87e0408f22","modified":1607939484178},{"_id":"themes/minos/layout/common/footer.ejs","hash":"cbf141464dbf127294370e843e6a10cd2ac7ea38","modified":1607939484179},{"_id":"themes/minos/layout/common/head.ejs","hash":"4dd9352ea5f5a59d3af2bedac7d545c08bb08531","modified":1607939484179},{"_id":"themes/minos/layout/common/article.ejs","hash":"3f0ae9f2bf5aae5a6824ee824c552a5af9dc98f0","modified":1607939484179},{"_id":"themes/minos/layout/common/navbar.ejs","hash":"f3aa16f357450651d0454f1ddc06a032f3dc4de3","modified":1607939484180},{"_id":"themes/minos/layout/common/languages.ejs","hash":"89665c656a1ffebc9c97f03e7f9c12dd1d90702a","modified":1607939484180},{"_id":"themes/minos/layout/common/paginator.ejs","hash":"8f5060e4c8a86a3f4e58455c41c98e831e23e4a4","modified":1607939484180},{"_id":"themes/minos/layout/common/scripts.ejs","hash":"7a5a5271930423b95046836597e30e31fa708f66","modified":1607939484180},{"_id":"themes/minos/layout/plugins/clipboard.ejs","hash":"a448757bb8a2c29bd9501c625f7df5087bb18dbe","modified":1607939484182},{"_id":"themes/minos/layout/plugins/gallery.ejs","hash":"7c2becafdf6b60e677cdd5756b9d55eba2af4944","modified":1607939484182},{"_id":"themes/minos/layout/plugins/google-analytics.ejs","hash":"2a9d944a60aff7df27def5215bdc071e605c3c42","modified":1607939484183},{"_id":"themes/minos/layout/plugins/katex.ejs","hash":"c8a7ecdc5802007f8fec46a299790ce4e0834acd","modified":1607939484183},{"_id":"themes/minos/layout/plugins/mathjax.ejs","hash":"b92fc2b30040e09145d80ebb9bad6813dda8acf2","modified":1607939484183},{"_id":"themes/minos/layout/search/google-cse.ejs","hash":"a6bf5c30339735126efa7efa684f9eb14dd6136a","modified":1607939484184},{"_id":"themes/minos/layout/search/insight.ejs","hash":"6fb7d27ef40145d8587b46b44a43516135b5a81a","modified":1607939484184},{"_id":"themes/minos/layout/share/addthis.ejs","hash":"f1c5f337333009d5f00dfbac4864a16ef8f9cb8d","modified":1607939484184},{"_id":"themes/minos/layout/share/sharethis.ejs","hash":"4f2c40f790f3be0a4e79db04f02ea41ba2f4d4c0","modified":1607939484185},{"_id":"themes/minos/source/css/insight.scss","hash":"f785fc6574d2853c660be39b2e3149d4846b577f","modified":1607939484188},{"_id":"themes/minos/source/css/style.scss","hash":"5c8f648617899ff05c62f27da3bfb91755dff595","modified":1607939484189},{"_id":"themes/minos/source/images/check.svg","hash":"029b8b3523b7daa4005983b4463cd93408308aab","modified":1607939484189},{"_id":"themes/minos/source/images/info.svg","hash":"c8aa387e935ba9a7fa72c5dd000b7d46f2e030c4","modified":1607939484189},{"_id":"themes/minos/source/images/exclamation.svg","hash":"b2db56f2cc13fce73dbea46c7b446d9bcb3bf0fd","modified":1607939484189},{"_id":"themes/minos/source/images/logo.png","hash":"4e012d9ba58cb8f87ee775262ef871c158ac5948","modified":1607939484190},{"_id":"themes/minos/source/images/question.svg","hash":"7153fa2a0c21e32da6a1f96a333d8b66a178569d","modified":1607939484190},{"_id":"themes/minos/source/images/quote-left.svg","hash":"d2561fa8d13e63ff196b71232a5968415ec6e372","modified":1607939484190},{"_id":"themes/minos/source/js/insight.js","hash":"eb23c31141784eef7300f1d1c548950e77883f56","modified":1607939484191},{"_id":"themes/minos/source/js/script.js","hash":"6b670ec4f90fb43b21a0bbd750a217af5d8aab6b","modified":1607939484191},{"_id":"source/_posts/CSAPP-Docker实验环境搭建/search.png","hash":"315b8aae526635a45d325d6ea6c649cffc3d8043","modified":1607939484006},{"_id":"source/_posts/fastjson序列化异常排查/BytecodeVerificationJunit.png","hash":"2bd9676494ca25f8c2dd764a699dbc1bc2313f25","modified":1607939484010},{"_id":"source/_posts/fastjson序列化异常排查/BytecodeVerificationWithApp.png","hash":"5d99578cc973f9f91e331e522855b49671335fff","modified":1607939484010},{"_id":"source/_posts/fastjson序列化异常排查/hdbs_attach.png","hash":"46e16f350e4b03fcdc63c3091fda3ced1df1c6a6","modified":1607939484014},{"_id":"source/_posts/一个事故引起的缓存/多级缓存.png","hash":"22fa4a74b7c688ad6fbb3a3a56c585d2acf0dfef","modified":1607939484017},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/allocateConfigs.png","hash":"a7f351d59d8948559064c6ed1d808e31ef76c91f","modified":1607939484023},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/instance.png","hash":"3a743c6ff182b6f977979beaad06c4d94c4646bc","modified":1607939484031},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/服务部署图.png","hash":"04a4f44f1a92e70be92a938141b08baba5105f78","modified":1607939484045},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/注册.png","hash":"8adb68e1e6c05139f9fabb380ba6a984e058fbca","modified":1607939484046},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/登录.png","hash":"df8b35801e8237cb7eb74a269c1e1c8b1899eeac","modified":1607939484046},{"_id":"source/_posts/深度解析JVM-动态Attach原理/flow.png","hash":"f63f7bc7a865169a4803508758f08ac516202f7c","modified":1607939484053},{"_id":"source/_posts/自己动手写Java虚拟机-笔记4/运行时数据区.png","hash":"5057a5c3a444bc1720a6bf1951d4d3c373386042","modified":1607939484057},{"_id":"source/_posts/Harmonica/GodenMelody.jpeg","hash":"1776a2747e1fc0461dd769cb7ec7aa577b973f40","modified":1607939484007},{"_id":"source/_posts/Harmonica/SilverStar.jpeg","hash":"6eb1ea1ca65799a6ed267b9ebc12d34a5ea0c19c","modified":1607939484008},{"_id":"source/_posts/fastjson序列化异常排查/class_browser.png","hash":"f7e9280fe7d8b713553007e01090c60d647e6642","modified":1607939484011},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/processingTask.png","hash":"5c6ee9c2839a24498c22fff99e8e3a5dc6e9b009","modified":1607939484036},{"_id":"source/_posts/深度解析JVM-动态Attach原理/JVM_start.png","hash":"5b2169fad1184aec8b62f8e544a4fd27b66a9453","modified":1607939484052},{"_id":"source/_posts/记一次序列化失败导致的生产问题/wenti.png","hash":"e6843d420e7ad46c852f2f041812eb927fb1399d","modified":1607939484058},{"_id":"source/_posts/fastjson序列化异常排查/constantpool.png","hash":"a0154820aa5801757cfaf904dcbe4c857a51ef8b","modified":1607939484013},{"_id":"source/_posts/fastjson序列化异常排查/visualVM.png","hash":"fa05315b76c1eeedb588d86dd6d2443e3b3dca57","modified":1607939484016},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/compare.png","hash":"6b238e8bf72dbef0c21966e8ce06dead8f79e73f","modified":1607939484027},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/completeTask.png","hash":"18c9d03bc8c0aa4819d08f019774a966bfe1f210","modified":1607939484028},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/configs.png","hash":"c238a9fe76aaab46faef9dee3478e0683959f7ad","modified":1607939484030},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/metadata.png","hash":"713f1ece021f460bc8aa35e145464d6ee39b6712","modified":1607939484032},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/pendingTask.png","hash":"7fe73f7083117304989e685121fef0eacf97cd02","modified":1607939484035},{"_id":"source/_posts/深度解析JVM-动态Attach原理/load_agent_library.png","hash":"50b8fd1d0dd9a7fdd344fed44dbf237acca73451","modified":1607939484054},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/allocate.png","hash":"bcc93b6de9ee67bf69cffa491ba32bacf5882942","modified":1607939484023},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/operationLog.png","hash":"5b01191dd79eedd699843c15bbde293d7fa49a7c","modified":1607939484034},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/role.png","hash":"1a2a190711181260a79e264b5d4cdde5cf3ec50b","modified":1607939484038},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/user.png","hash":"5359c185d0fd367bc7bb02155fb4958c968ea693","modified":1607939484042},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/主页面.png","hash":"db0311a84f696ee037daad0f5615a276e3dd5b45","modified":1607939484044},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/clientLog.png","hash":"c6e768d071372e78d14584fb0c14b2794e5e788f","modified":1607939484026},{"_id":"source/_posts/🐇/牌子.jpeg","hash":"24f95dd5ddc228a74e8ff4887a29431510ec6620","modified":1607939484079},{"_id":"source/_posts/🐇/全景.jpeg","hash":"147aba5c942fd21ed61065267d438905756dc1fb","modified":1607939484070},{"_id":"public/content.json","hash":"85ca2cb097dc277477d4cd363b12032021282a73","modified":1608170243337},{"_id":"public/about/index.html","hash":"7f7bd263a36bdbc8484ad45f980cf4381de807e7","modified":1608170243337},{"_id":"public/categories/index.html","hash":"59a4f1780a5ce909a2fcc305edb2cefcaa5f207e","modified":1608170243337},{"_id":"public/tags/index.html","hash":"ea79614d7d74c996c5ae2599ee5207adc12c4655","modified":1608170243337},{"_id":"public/2019/09/07/hexo搭建问题【-no-layout-index-html】/index.html","hash":"c9473ef8c72b2febb85a8f4788a0bc44cb9ca013","modified":1608170243337},{"_id":"public/2019/09/05/🐇/index.html","hash":"af061a9f0d4132a005f119630505f2388066ce57","modified":1608170243337},{"_id":"public/archives/index.html","hash":"c30f788d892d7547448562dbdec114613f2377e7","modified":1608170243337},{"_id":"public/archives/page/2/index.html","hash":"1ddc9437fe692c0a66585efd027b325d59976cd2","modified":1608170243337},{"_id":"public/archives/page/3/index.html","hash":"f62e88bad186482835123c94c4fbc370df5a8ecc","modified":1608170243337},{"_id":"public/archives/2019/index.html","hash":"7187fc043c6064f9ef8af99cacae2fa88bf9dfd6","modified":1608170243337},{"_id":"public/archives/2019/09/index.html","hash":"03d4ebb36c58f7a8f9f197f3e3c4a4ad004282ab","modified":1608170243337},{"_id":"public/archives/2020/index.html","hash":"08ac67495e4f043730c0cfd08dbd105a0ca69b36","modified":1608170243337},{"_id":"public/archives/2020/page/2/index.html","hash":"53f071193d4ea61c8f31c39a1bac38cb848fcbc7","modified":1608170243337},{"_id":"public/archives/2020/page/3/index.html","hash":"e942b3a83f01aca136aa1c1caedc4b95dc5e9502","modified":1608170243337},{"_id":"public/archives/2020/01/index.html","hash":"d3f298dd5803ea5042dc22ef07d37dceaec1d55d","modified":1608170243337},{"_id":"public/archives/2020/02/index.html","hash":"419e8361185d4c16fced07d795a9ab66094f7099","modified":1608170243337},{"_id":"public/archives/2020/03/index.html","hash":"78ef289fef963f910992d533a60077862f9abc31","modified":1608170243337},{"_id":"public/archives/2020/04/index.html","hash":"e984777b5693ac0250c22c1348071fbdb1de8fbe","modified":1608170243337},{"_id":"public/archives/2020/05/index.html","hash":"fc2a0f74c8960a84613d23de9949e4003f9f4e20","modified":1608170243337},{"_id":"public/archives/2020/06/index.html","hash":"c565736ad960021d2d7e66f19da8ffc01ade9064","modified":1608170243337},{"_id":"public/archives/2020/08/index.html","hash":"63f13f7f6e4209f7a3f4ff67a8da402f84d02727","modified":1608170243337},{"_id":"public/archives/2020/09/index.html","hash":"cc574969040002d6087f7496dafa42ea77ae4404","modified":1608170243337},{"_id":"public/archives/2020/10/index.html","hash":"d5dd1a1821acb2b03bcd6aee545760a63bc5bed4","modified":1608170243337},{"_id":"public/archives/2020/12/index.html","hash":"e50b35d07b4f228034393a954ddece31fb5b6c4c","modified":1608170243337},{"_id":"public/categories/Music/index.html","hash":"0fa68dd62cc33c504bce964dd0672b2b67b84461","modified":1608170243337},{"_id":"public/categories/Translation/index.html","hash":"53a5e06c0b0504e48470031e994e938c40e42486","modified":1608170243337},{"_id":"public/categories/Life/index.html","hash":"aae8461be9c43fe34b1ebe1572a204c1bea9615d","modified":1608170243337},{"_id":"public/tags/CSAPP/index.html","hash":"31030269aee6d7bf177b42cf672bf414d7e2b7e9","modified":1608170243337},{"_id":"public/tags/Harmonica/index.html","hash":"978e0a57c03de216631697eb26f7efa5464f1c30","modified":1608170243337},{"_id":"public/tags/Java/page/3/index.html","hash":"76745acffbc5f24e881312b06b1e6b3d46d2430f","modified":1608170243337},{"_id":"public/tags/IO/index.html","hash":"0e02955700828c5c1176b2275737d2327a916d5f","modified":1608170243337},{"_id":"public/tags/Springboot/index.html","hash":"3b1e4606c49a5f9b4f81049f19583afee5184bd8","modified":1608170243337},{"_id":"public/tags/Hexo/index.html","hash":"36e9d72f9ddf22cfa95626c3ceb120dc97348b0d","modified":1608170243337},{"_id":"public/tags/Linux/index.html","hash":"6bb5196fce5f902ce95356349362f8b7c9d0b743","modified":1608170243337},{"_id":"public/tags/Cache/index.html","hash":"04a3fb5b928136b497a7fd88f8e082d3694c96b7","modified":1608170243337},{"_id":"public/tags/GCC/index.html","hash":"b5340c46121a9220998da4d1f5eb2ab8e89d61df","modified":1608170243337},{"_id":"public/tags/代码优化/index.html","hash":"5b234d74d4d1a64cb119a7ee2b44a777373f1378","modified":1608170243337},{"_id":"public/tags/AI/index.html","hash":"b23c89db5b5d7a62f61c363021a31091d8ac359e","modified":1608170243337},{"_id":"public/tags/APP/index.html","hash":"91329d3de5359521c9ce32d7c7b153aef8c97370","modified":1608170243337},{"_id":"public/tags/Spring-Boot/index.html","hash":"d03c9cafac9509e2f970972b5ed36f90d0af93af","modified":1608170243337},{"_id":"public/tags/Food/index.html","hash":"d5dc5e91b178d8d393e4642ad5703a157f2d8319","modified":1608170243337},{"_id":"public/tags/fastjson/index.html","hash":"ae2cd1cc83ac8aad41b8ef5df33e0786472aaf56","modified":1608170243337},{"_id":"public/tags/ASM/index.html","hash":"a1f3f0b6b89a3869ecf030896b564f16c6ff57cb","modified":1608170243337},{"_id":"public/2020/12/14/分支预测-GCC-builtin-expect/index.html","hash":"387b32c7eb16d65ae41cac365bb1feb2e33b889f","modified":1608170243337},{"_id":"public/2020/12/11/自定义配置文件读取-解析/index.html","hash":"d7c95220e98f9256983a3c86b301025e8061950d","modified":1608170243337},{"_id":"public/2020/10/11/CSAPP-Docker实验环境搭建/index.html","hash":"4bea0fabd4a7b99a3533a831d449eef58949cacd","modified":1608170243337},{"_id":"public/2020/09/24/linux提供加载、处理动态链接库的系统调用方法/index.html","hash":"d19750892a186e2060c5a78da3a4891e98520b9b","modified":1608170243337},{"_id":"public/2020/09/21/深度解析JVM-动态Attach原理/index.html","hash":"df00a59c92cf80713cbb2d71c65b7c839c80702f","modified":1608170243337},{"_id":"public/2020/08/17/fastjson序列化异常排查/index.html","hash":"a37950f2eccd4073545130a16b2f9099a9307cb8","modified":1608170243337},{"_id":"public/2020/06/13/Harmonica/index.html","hash":"5ac0c9d0974216300077938b9f95fe5fb43826e0","modified":1608170243337},{"_id":"public/2020/05/30/基于Flink实现简单的日志异常推送/index.html","hash":"c81e015c8c70b66a3f78e06e96cb42dfce6d6732","modified":1608170243337},{"_id":"public/2020/05/21/基于Flink推送报警信息-测试/index.html","hash":"c26292bc70335b2a4bd77cd3bee3850665ed1120","modified":1608170243337},{"_id":"public/2020/05/16/基于Flink设计统一报警平台/index.html","hash":"2443f2e628a0c4052baa5b90f7b897c47f90f075","modified":1608170243337},{"_id":"public/2020/04/18/我为什么会重新写一个配置中心-代码篇/index.html","hash":"a6de1e317756388afa774824988dc27d431ee9a4","modified":1608170243337},{"_id":"public/2020/04/12/我为什么会重新写一个配置中心-设计篇3/index.html","hash":"a4edb286287d0ebac9db96b09281bf5ec572f150","modified":1608170243337},{"_id":"public/2020/04/11/我为什么会重新写一个配置中心-设计篇2/index.html","hash":"40c2f2c9bc07e43b36e7aa6f065d70616f750336","modified":1608170243337},{"_id":"public/2020/03/24/我为什么会重新写一个配置中心-设计篇/index.html","hash":"133857a2cc0cf4a2248b6c99bc77cd7ae79ac6c7","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/index.html","hash":"94b22e467c6f57687c967ad8dbefa2717d1c694f","modified":1608170243337},{"_id":"public/2020/03/19/我为什么会重新写一个配置中心-起源篇/index.html","hash":"f0c9d14530e77375f8857988096f24d55f43664c","modified":1608170243337},{"_id":"public/2020/03/01/分布式一致性算法整理/index.html","hash":"f10a0712a7cc9d3d215e79def47cec4c2996315e","modified":1608170243337},{"_id":"public/2020/03/01/分布式事务整理/index.html","hash":"5c9280a24d9c6dc2b562a002a41830cb85a63d3d","modified":1608170243337},{"_id":"public/2020/02/22/JVM-整理/index.html","hash":"5127ebe1b824dd37f2b43bfcfa9c7ed2b3377654","modified":1608170243337},{"_id":"public/2020/01/29/Spring-Boot/index.html","hash":"dcadcb74f34e3110150301a744d39bb6140a4ee9","modified":1608170243337},{"_id":"public/2020/01/29/NIO/index.html","hash":"17b194c5c59a71e7213fad8ca680581601dc145f","modified":1608170243337},{"_id":"public/2019/09/26/自己动手写Java虚拟机-笔记4/index.html","hash":"425c6f047910886840f5cf02f4d4206e2b303f63","modified":1608170243337},{"_id":"public/2019/09/24/记一次序列化失败导致的生产问题/index.html","hash":"f871c5f3b4ff537561c90206d326fd3ad0804948","modified":1608170243337},{"_id":"public/2019/09/13/自己动手写Java虚拟机-笔记3/index.html","hash":"1cb9391db2c825e4171787193cae24af1cfa507a","modified":1608170243337},{"_id":"public/2019/09/10/自己动手写Java虚拟机-笔记2/index.html","hash":"ce6add6fa52d06ca7e0fcadf9f584262f3c16c22","modified":1608170243337},{"_id":"public/2019/09/09/自己动手写Java虚拟机-笔记1/index.html","hash":"43c45d56dbe22f256f8c6b8a3e03d22b969be14d","modified":1608170243337},{"_id":"public/2019/09/06/搜寻流浪狗APP/index.html","hash":"d43cfa298c9356ceccdb072eec957da14ae2214c","modified":1608170243337},{"_id":"public/2019/09/04/一个事故引起的缓存/index.html","hash":"eff0400de92e712cb84d19dd441c526d88827f0d","modified":1608170243337},{"_id":"public/categories/Technology/index.html","hash":"5ff8c6b653a834bc73953ecf5918419bfac2d115","modified":1608170243337},{"_id":"public/categories/Technology/page/2/index.html","hash":"4f0075fe1165fa232e77ea73e55d595ef74a0ff1","modified":1608170243337},{"_id":"public/categories/Technology/page/3/index.html","hash":"5deb83cc7d4ba5e5d01a117112b37a9cc21f1254","modified":1608170243337},{"_id":"public/index.html","hash":"e12eb5d152f9e9e9c395cc5a0a4dbe3079aaf3ba","modified":1608170243337},{"_id":"public/page/2/index.html","hash":"61066b815f20d3453915fbffb987765c294250f8","modified":1608170243337},{"_id":"public/page/3/index.html","hash":"2cf68b2e6e51435bf0153267784d234ffa386705","modified":1608170243337},{"_id":"public/tags/C/index.html","hash":"11876a302e0894ea904a5c85bc38267d19504eba","modified":1608170243337},{"_id":"public/tags/JVM/index.html","hash":"5736f92ffa21db804b7df05c4f4ae521d25abf22","modified":1608170243337},{"_id":"public/tags/Java/index.html","hash":"c9a1ad0c8178180853414260e41801c17627b663","modified":1608170243337},{"_id":"public/tags/Java/page/2/index.html","hash":"3e3e0327e995490e861e5136f8261c0a8e61b9f5","modified":1608170243337},{"_id":"public/tags/Redis/index.html","hash":"4d6e184e2fced4eff90b5ddb4f0a1087ef4b0987","modified":1608170243337},{"_id":"public/tags/Flink/index.html","hash":"f2243ea57faf0df084c90704c3d8d5c71ed6ef71","modified":1608170243337},{"_id":"public/tags/监控/index.html","hash":"5a46173daf728bad9f19420416b453770d07d8be","modified":1608170243337},{"_id":"public/tags/配置中心/index.html","hash":"82d08e930c2a30e191c5c9a91586c6b72a058a61","modified":1608170243337},{"_id":"public/tags/Go/index.html","hash":"494e11fd67a3d6972b0a75b51db04c934e97fc02","modified":1608170243337},{"_id":"public/images/check.svg","hash":"029b8b3523b7daa4005983b4463cd93408308aab","modified":1608170243337},{"_id":"public/images/exclamation.svg","hash":"b2db56f2cc13fce73dbea46c7b446d9bcb3bf0fd","modified":1608170243337},{"_id":"public/images/info.svg","hash":"c8aa387e935ba9a7fa72c5dd000b7d46f2e030c4","modified":1608170243337},{"_id":"public/images/logo.png","hash":"4e012d9ba58cb8f87ee775262ef871c158ac5948","modified":1608170243337},{"_id":"public/images/question.svg","hash":"7153fa2a0c21e32da6a1f96a333d8b66a178569d","modified":1608170243337},{"_id":"public/images/quote-left.svg","hash":"d2561fa8d13e63ff196b71232a5968415ec6e372","modified":1608170243337},{"_id":"public/2020/10/11/CSAPP-Docker实验环境搭建/pull.png","hash":"75df3bb37ab4153db6a76effdd1f3caa3fd26aae","modified":1608170243337},{"_id":"public/2019/09/07/hexo搭建问题【-no-layout-index-html】/nolayout.jpg","hash":"b7e6217718a630562255060b224ee116d1caf824","modified":1608170243337},{"_id":"public/2019/09/04/一个事故引起的缓存/springCache.png","hash":"244dfd7e60a2e01dbd8ed66d5f0828db5737c32d","modified":1608170243337},{"_id":"public/2020/05/21/基于Flink推送报警信息-测试/flink-local.png","hash":"7b4ba65ffb265a902ba1857a4d9b44b87e780b77","modified":1608170243337},{"_id":"public/2020/05/21/基于Flink推送报警信息-测试/rocketmq-dashboard.png","hash":"3992562c00d407b4e57860b7037eb0d8e63e22d8","modified":1608170243337},{"_id":"public/2020/05/21/基于Flink推送报警信息-测试/rocketmq-message.png","hash":"71a6a78f475da2a55fae3fc6ae1339e1e9840238","modified":1608170243337},{"_id":"public/2020/05/21/基于Flink推送报警信息-测试/rocketmq-topic.png","hash":"8e3049784ffdb24584139f37b5d6aff0943663fe","modified":1608170243337},{"_id":"public/2020/05/21/基于Flink推送报警信息-测试/wechat-message.png","hash":"2f4f5d8186da8887cc614bc0941c3a0aa47377d0","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/addGroup.png","hash":"a5b0ba884bb632b2125bee606bf3016966692e4a","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/history.png","hash":"eb8dac42b2ba7119a89b7c74cbb81e56d03410f9","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/instanceConfig.png","hash":"764b4c39797d533ab1195b65f32d06cc32ce819a","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/switch.png","hash":"92060e35ba1f4220ebb8164c07cdf9da2e280fb7","modified":1608170243337},{"_id":"public/2020/04/11/我为什么会重新写一个配置中心-设计篇2/CentOS6-Base-163.repo","hash":"c601efdaeb8c55cb0dea2cade8976c5a8de366ac","modified":1608170243337},{"_id":"public/2020/04/11/我为什么会重新写一个配置中心-设计篇2/客户端启动并更新配置.png","hash":"fbae1f8e0ac320887b72000346d5dd079ed12a06","modified":1608170243337},{"_id":"public/2020/04/11/我为什么会重新写一个配置中心-设计篇2/服务端热更新配置.png","hash":"985f1bfbd2bbdf087c49ff3b6f81f51ac5c81afc","modified":1608170243337},{"_id":"public/2019/09/09/自己动手写Java虚拟机-笔记1/gopath.png","hash":"651d1a1fb00e3250828a1e1570d1ee3f842774ca","modified":1608170243337},{"_id":"public/2020/08/17/fastjson序列化异常排查/classload断点.png","hash":"b23555690fff99fec7bc4dd33042c62de64194ca","modified":1608170243337},{"_id":"public/2020/08/17/fastjson序列化异常排查/idea.png","hash":"e3aa184adced51bc89141426a7e9eae9724dbb55","modified":1608170243337},{"_id":"public/2020/08/17/fastjson序列化异常排查/jps.png","hash":"fdaf08415d96c17407a1f77a4c67bd69e218f8ad","modified":1608170243337},{"_id":"public/2020/10/11/CSAPP-Docker实验环境搭建/search.png","hash":"315b8aae526635a45d325d6ea6c649cffc3d8043","modified":1608170243337},{"_id":"public/2019/09/04/一个事故引起的缓存/多级缓存.png","hash":"22fa4a74b7c688ad6fbb3a3a56c585d2acf0dfef","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/allocateConfigs.png","hash":"a7f351d59d8948559064c6ed1d808e31ef76c91f","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/instance.png","hash":"3a743c6ff182b6f977979beaad06c4d94c4646bc","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/服务部署图.png","hash":"04a4f44f1a92e70be92a938141b08baba5105f78","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/注册.png","hash":"8adb68e1e6c05139f9fabb380ba6a984e058fbca","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/登录.png","hash":"df8b35801e8237cb7eb74a269c1e1c8b1899eeac","modified":1608170243337},{"_id":"public/2019/09/26/自己动手写Java虚拟机-笔记4/运行时数据区.png","hash":"5057a5c3a444bc1720a6bf1951d4d3c373386042","modified":1608170243337},{"_id":"public/2020/08/17/fastjson序列化异常排查/BytecodeVerificationJunit.png","hash":"2bd9676494ca25f8c2dd764a699dbc1bc2313f25","modified":1608170243337},{"_id":"public/2020/08/17/fastjson序列化异常排查/BytecodeVerificationWithApp.png","hash":"5d99578cc973f9f91e331e522855b49671335fff","modified":1608170243337},{"_id":"public/2020/08/17/fastjson序列化异常排查/hdbs_attach.png","hash":"46e16f350e4b03fcdc63c3091fda3ced1df1c6a6","modified":1608170243337},{"_id":"public/2020/09/21/深度解析JVM-动态Attach原理/flow.png","hash":"f63f7bc7a865169a4803508758f08ac516202f7c","modified":1608170243337},{"_id":"public/2020/06/13/Harmonica/GodenMelody.jpeg","hash":"1776a2747e1fc0461dd769cb7ec7aa577b973f40","modified":1608170243337},{"_id":"public/2020/06/13/Harmonica/SilverStar.jpeg","hash":"6eb1ea1ca65799a6ed267b9ebc12d34a5ea0c19c","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/processingTask.png","hash":"5c6ee9c2839a24498c22fff99e8e3a5dc6e9b009","modified":1608170243337},{"_id":"public/css/insight.css","hash":"f376dcda6bb50b708f3206c15a49f7530b3c534d","modified":1608170243337},{"_id":"public/css/style.css","hash":"414ec8f0ec0ca697461584b0fec4ec5862ff253d","modified":1608170243337},{"_id":"public/js/insight.js","hash":"eb23c31141784eef7300f1d1c548950e77883f56","modified":1608170243337},{"_id":"public/js/script.js","hash":"6b670ec4f90fb43b21a0bbd750a217af5d8aab6b","modified":1608170243337},{"_id":"public/2019/09/24/记一次序列化失败导致的生产问题/wenti.png","hash":"e6843d420e7ad46c852f2f041812eb927fb1399d","modified":1608170243337},{"_id":"public/2020/08/17/fastjson序列化异常排查/class_browser.png","hash":"f7e9280fe7d8b713553007e01090c60d647e6642","modified":1608170243337},{"_id":"public/2020/09/21/深度解析JVM-动态Attach原理/JVM_start.png","hash":"5b2169fad1184aec8b62f8e544a4fd27b66a9453","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/compare.png","hash":"6b238e8bf72dbef0c21966e8ce06dead8f79e73f","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/completeTask.png","hash":"18c9d03bc8c0aa4819d08f019774a966bfe1f210","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/configs.png","hash":"c238a9fe76aaab46faef9dee3478e0683959f7ad","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/metadata.png","hash":"713f1ece021f460bc8aa35e145464d6ee39b6712","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/pendingTask.png","hash":"7fe73f7083117304989e685121fef0eacf97cd02","modified":1608170243337},{"_id":"public/2020/08/17/fastjson序列化异常排查/constantpool.png","hash":"a0154820aa5801757cfaf904dcbe4c857a51ef8b","modified":1608170243337},{"_id":"public/2020/08/17/fastjson序列化异常排查/visualVM.png","hash":"fa05315b76c1eeedb588d86dd6d2443e3b3dca57","modified":1608170243337},{"_id":"public/2020/09/21/深度解析JVM-动态Attach原理/load_agent_library.png","hash":"50b8fd1d0dd9a7fdd344fed44dbf237acca73451","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/allocate.png","hash":"bcc93b6de9ee67bf69cffa491ba32bacf5882942","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/operationLog.png","hash":"5b01191dd79eedd699843c15bbde293d7fa49a7c","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/role.png","hash":"1a2a190711181260a79e264b5d4cdde5cf3ec50b","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/user.png","hash":"5359c185d0fd367bc7bb02155fb4958c968ea693","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/主页面.png","hash":"db0311a84f696ee037daad0f5615a276e3dd5b45","modified":1608170243337},{"_id":"public/2020/03/20/我为什么会重新写一个配置中心-介绍篇/clientLog.png","hash":"c6e768d071372e78d14584fb0c14b2794e5e788f","modified":1608170243337},{"_id":"public/2019/09/05/🐇/牌子.jpeg","hash":"24f95dd5ddc228a74e8ff4887a29431510ec6620","modified":1608170243337},{"_id":"public/2019/09/05/🐇/全景.jpeg","hash":"147aba5c942fd21ed61065267d438905756dc1fb","modified":1608170243337}],"Category":[{"name":"Technology","_id":"ckis71ht00004v25299na538q"},{"name":"Music","_id":"ckis71ht5000av252cpwx47dv"},{"name":"Translation","_id":"ckis71htr001mv252fp9k9bwp"},{"name":"Life","_id":"ckis71hu00028v252enjlgu71"}],"Data":[],"Page":[{"title":"about","date":"2019-09-04T03:48:57.000Z","_content":"","source":"about/index.md","raw":"---\ntitle: about\ndate: 2019-09-04 11:48:57\n---\n","updated":"2020-12-14T09:51:24.080Z","path":"about/index.html","comments":1,"layout":"page","_id":"ckis71hsp0000v2526pag8h39","content":"","site":{"data":{}},"_categories":[],"_tags":[],"excerpt":"","more":""},{"title":"categories","date":"2019-09-04T03:49:09.000Z","_content":"","source":"categories/index.md","raw":"---\ntitle: categories\ndate: 2019-09-04 11:49:09\n---\n","updated":"2020-12-14T09:51:24.080Z","path":"categories/index.html","comments":1,"layout":"page","_id":"ckis71hsy0002v2529gck34k8","content":"","site":{"data":{}},"_categories":[],"_tags":[],"excerpt":"","more":""},{"title":"tags","date":"2019-09-04T03:48:44.000Z","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2019-09-04 11:48:44\n---\n","updated":"2020-12-14T09:51:24.172Z","path":"tags/index.html","comments":1,"layout":"page","_id":"ckis71ht20006v2524e2q455n","content":"","site":{"data":{}},"_categories":[],"_tags":[],"excerpt":"","more":""}],"Post":[{"title":"CSAPP Docker实验环境搭建","date":"2020-10-11T09:57:26.000Z","_content":"\nCSAPP 的Docker实验环境在windows下的安装过程，MacOS下一致。\n<!-- more -->\n### 搜索ubuntu镜像\n``` shell\ndocker search ubuntu\n```\n\n![01](CSAPP-Docker实验环境搭建/search.png)\n\n### 拉取最新镜像\n``` shell\ndocker pull ubuntu:latest\n```\n\n![02](CSAPP-Docker实验环境搭建/pull.png)\n\n### 配置并启动ubuntu容器\n1. -it 中断交互式\n2. -v 共享目录最好指定自己的的实验目录 (D:\\work\\workspace_c\\CSAPP_LAB:csapplab)\n3. -name 容器名称\n4. /bin/bash 容器启动后运行bash\n``` shell\ndocker run -it -v D:\\work\\workspace_c\\CSAPP_LAB:/csapplab --name=csapp_env ubuntu:latest /bin/bash\n```\n\n### 配置ubuntu实验环境\n1. 更新apt软件源\n``` shell\napt-get update\n```\n\n2. 安装sudo\n``` shell\napt-get instull sudo\n```\n\n3. 安装vim\n``` shell\napt-get instull vim\n```\n\n4. 安装c/c++编译环境\n``` shell\nsudo apt-get install build-essential\nsudo apt-get install gcc-multilib\n```\n\n### 退出容器\n``` shell\nexit\n```\n\n### 停止容器\n``` shell\ndocker stop csapp_env\n```\n\n### 启动&进入容器\n``` shell\ndocker start csapp_env\ndocker exec -it csapp_env /bin/bash\n```","source":"_posts/CSAPP-Docker实验环境搭建.md","raw":"---\ntitle: CSAPP Docker实验环境搭建\ndate: 2020-10-11 17:57:26\ntags: \n    - CSAPP\n    - C\ncategories :\n    - Technology\n---\n\nCSAPP 的Docker实验环境在windows下的安装过程，MacOS下一致。\n<!-- more -->\n### 搜索ubuntu镜像\n``` shell\ndocker search ubuntu\n```\n\n![01](CSAPP-Docker实验环境搭建/search.png)\n\n### 拉取最新镜像\n``` shell\ndocker pull ubuntu:latest\n```\n\n![02](CSAPP-Docker实验环境搭建/pull.png)\n\n### 配置并启动ubuntu容器\n1. -it 中断交互式\n2. -v 共享目录最好指定自己的的实验目录 (D:\\work\\workspace_c\\CSAPP_LAB:csapplab)\n3. -name 容器名称\n4. /bin/bash 容器启动后运行bash\n``` shell\ndocker run -it -v D:\\work\\workspace_c\\CSAPP_LAB:/csapplab --name=csapp_env ubuntu:latest /bin/bash\n```\n\n### 配置ubuntu实验环境\n1. 更新apt软件源\n``` shell\napt-get update\n```\n\n2. 安装sudo\n``` shell\napt-get instull sudo\n```\n\n3. 安装vim\n``` shell\napt-get instull vim\n```\n\n4. 安装c/c++编译环境\n``` shell\nsudo apt-get install build-essential\nsudo apt-get install gcc-multilib\n```\n\n### 退出容器\n``` shell\nexit\n```\n\n### 停止容器\n``` shell\ndocker stop csapp_env\n```\n\n### 启动&进入容器\n``` shell\ndocker start csapp_env\ndocker exec -it csapp_env /bin/bash\n```","slug":"CSAPP-Docker实验环境搭建","published":1,"updated":"2020-12-14T10:37:40.145Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71hsv0001v252awm830es","content":"<html><head></head><body><p>CSAPP &#x7684;Docker&#x5B9E;&#x9A8C;&#x73AF;&#x5883;&#x5728;windows&#x4E0B;&#x7684;&#x5B89;&#x88C5;&#x8FC7;&#x7A0B;&#xFF0C;MacOS&#x4E0B;&#x4E00;&#x81F4;&#x3002;</p>\n<a id=\"more\"></a>\n<h3 id=\"&#x641C;&#x7D22;ubuntu&#x955C;&#x50CF;\"><a href=\"#&#x641C;&#x7D22;ubuntu&#x955C;&#x50CF;\" class=\"headerlink\" title=\"&#x641C;&#x7D22;ubuntu&#x955C;&#x50CF;\"></a>&#x641C;&#x7D22;ubuntu&#x955C;&#x50CF;</h3><figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker search ubuntu</span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src=\"/2020/10/11/CSAPP-Docker%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/search.png\" alt=\"01\"></p>\n<h3 id=\"&#x62C9;&#x53D6;&#x6700;&#x65B0;&#x955C;&#x50CF;\"><a href=\"#&#x62C9;&#x53D6;&#x6700;&#x65B0;&#x955C;&#x50CF;\" class=\"headerlink\" title=\"&#x62C9;&#x53D6;&#x6700;&#x65B0;&#x955C;&#x50CF;\"></a>&#x62C9;&#x53D6;&#x6700;&#x65B0;&#x955C;&#x50CF;</h3><figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull ubuntu:latest</span><br></pre></td></tr></tbody></table></figure>\n\n<p><img src=\"/2020/10/11/CSAPP-Docker%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/pull.png\" alt=\"02\"></p>\n<h3 id=\"&#x914D;&#x7F6E;&#x5E76;&#x542F;&#x52A8;ubuntu&#x5BB9;&#x5668;\"><a href=\"#&#x914D;&#x7F6E;&#x5E76;&#x542F;&#x52A8;ubuntu&#x5BB9;&#x5668;\" class=\"headerlink\" title=\"&#x914D;&#x7F6E;&#x5E76;&#x542F;&#x52A8;ubuntu&#x5BB9;&#x5668;\"></a>&#x914D;&#x7F6E;&#x5E76;&#x542F;&#x52A8;ubuntu&#x5BB9;&#x5668;</h3><ol>\n<li>-it &#x4E2D;&#x65AD;&#x4EA4;&#x4E92;&#x5F0F;</li>\n<li>-v &#x5171;&#x4EAB;&#x76EE;&#x5F55;&#x6700;&#x597D;&#x6307;&#x5B9A;&#x81EA;&#x5DF1;&#x7684;&#x7684;&#x5B9E;&#x9A8C;&#x76EE;&#x5F55; (D:\\work\\workspace_c\\CSAPP_LAB:csapplab)</li>\n<li>-name &#x5BB9;&#x5668;&#x540D;&#x79F0;</li>\n<li>/bin/bash &#x5BB9;&#x5668;&#x542F;&#x52A8;&#x540E;&#x8FD0;&#x884C;bash<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it -v D:\\work\\workspace_c\\CSAPP_LAB:/csapplab --name=csapp_env ubuntu:latest /bin/bash</span><br></pre></td></tr></tbody></table></figure>\n\n</li>\n</ol>\n<h3 id=\"&#x914D;&#x7F6E;ubuntu&#x5B9E;&#x9A8C;&#x73AF;&#x5883;\"><a href=\"#&#x914D;&#x7F6E;ubuntu&#x5B9E;&#x9A8C;&#x73AF;&#x5883;\" class=\"headerlink\" title=\"&#x914D;&#x7F6E;ubuntu&#x5B9E;&#x9A8C;&#x73AF;&#x5883;\"></a>&#x914D;&#x7F6E;ubuntu&#x5B9E;&#x9A8C;&#x73AF;&#x5883;</h3><ol>\n<li><p>&#x66F4;&#x65B0;apt&#x8F6F;&#x4EF6;&#x6E90;</p>\n<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>&#x5B89;&#x88C5;sudo</p>\n<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get instull sudo</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>&#x5B89;&#x88C5;vim</p>\n<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get instull vim</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>&#x5B89;&#x88C5;c/c++&#x7F16;&#x8BD1;&#x73AF;&#x5883;</p>\n<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get install build-essential</span><br><span class=\"line\">sudo apt-get install gcc-multilib</span><br></pre></td></tr></tbody></table></figure>\n\n</li>\n</ol>\n<h3 id=\"&#x9000;&#x51FA;&#x5BB9;&#x5668;\"><a href=\"#&#x9000;&#x51FA;&#x5BB9;&#x5668;\" class=\"headerlink\" title=\"&#x9000;&#x51FA;&#x5BB9;&#x5668;\"></a>&#x9000;&#x51FA;&#x5BB9;&#x5668;</h3><figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exit</span><br></pre></td></tr></tbody></table></figure>\n\n<h3 id=\"&#x505C;&#x6B62;&#x5BB9;&#x5668;\"><a href=\"#&#x505C;&#x6B62;&#x5BB9;&#x5668;\" class=\"headerlink\" title=\"&#x505C;&#x6B62;&#x5BB9;&#x5668;\"></a>&#x505C;&#x6B62;&#x5BB9;&#x5668;</h3><figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker stop csapp_env</span><br></pre></td></tr></tbody></table></figure>\n\n<h3 id=\"&#x542F;&#x52A8;-amp-&#x8FDB;&#x5165;&#x5BB9;&#x5668;\"><a href=\"#&#x542F;&#x52A8;-amp-&#x8FDB;&#x5165;&#x5BB9;&#x5668;\" class=\"headerlink\" title=\"&#x542F;&#x52A8;&amp;&#x8FDB;&#x5165;&#x5BB9;&#x5668;\"></a>&#x542F;&#x52A8;&amp;&#x8FDB;&#x5165;&#x5BB9;&#x5668;</h3><figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker start csapp_env</span><br><span class=\"line\">docker exec -it csapp_env /bin/bash</span><br></pre></td></tr></tbody></table></figure></body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"CSAPP","path":"tags/CSAPP/"},{"name":"C","path":"tags/C/"}],"excerpt":"<html><head></head><body><p>CSAPP &#x7684;Docker&#x5B9E;&#x9A8C;&#x73AF;&#x5883;&#x5728;windows&#x4E0B;&#x7684;&#x5B89;&#x88C5;&#x8FC7;&#x7A0B;&#xFF0C;MacOS&#x4E0B;&#x4E00;&#x81F4;&#x3002;</p></body></html>","more":"<h3 id=\"搜索ubuntu镜像\"><a href=\"#搜索ubuntu镜像\" class=\"headerlink\" title=\"搜索ubuntu镜像\"></a>搜索ubuntu镜像</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker search ubuntu</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/2020/10/11/CSAPP-Docker%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/search.png\" alt=\"01\"></p>\n<h3 id=\"拉取最新镜像\"><a href=\"#拉取最新镜像\" class=\"headerlink\" title=\"拉取最新镜像\"></a>拉取最新镜像</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull ubuntu:latest</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/2020/10/11/CSAPP-Docker%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/pull.png\" alt=\"02\"></p>\n<h3 id=\"配置并启动ubuntu容器\"><a href=\"#配置并启动ubuntu容器\" class=\"headerlink\" title=\"配置并启动ubuntu容器\"></a>配置并启动ubuntu容器</h3><ol>\n<li>-it 中断交互式</li>\n<li>-v 共享目录最好指定自己的的实验目录 (D:\\work\\workspace_c\\CSAPP_LAB:csapplab)</li>\n<li>-name 容器名称</li>\n<li>/bin/bash 容器启动后运行bash<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it -v D:\\work\\workspace_c\\CSAPP_LAB:/csapplab --name=csapp_env ubuntu:latest /bin/bash</span><br></pre></td></tr></table></figure>\n\n</li>\n</ol>\n<h3 id=\"配置ubuntu实验环境\"><a href=\"#配置ubuntu实验环境\" class=\"headerlink\" title=\"配置ubuntu实验环境\"></a>配置ubuntu实验环境</h3><ol>\n<li><p>更新apt软件源</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get update</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>安装sudo</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get instull sudo</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>安装vim</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt-get instull vim</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>安装c/c++编译环境</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo apt-get install build-essential</span><br><span class=\"line\">sudo apt-get install gcc-multilib</span><br></pre></td></tr></table></figure>\n\n</li>\n</ol>\n<h3 id=\"退出容器\"><a href=\"#退出容器\" class=\"headerlink\" title=\"退出容器\"></a>退出容器</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exit</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"停止容器\"><a href=\"#停止容器\" class=\"headerlink\" title=\"停止容器\"></a>停止容器</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker stop csapp_env</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"启动-amp-进入容器\"><a href=\"#启动-amp-进入容器\" class=\"headerlink\" title=\"启动&amp;进入容器\"></a>启动&amp;进入容器</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker start csapp_env</span><br><span class=\"line\">docker exec -it csapp_env /bin/bash</span><br></pre></td></tr></table></figure>"},{"title":"Harmonica","date":"2020-06-13T02:07:08.000Z","_content":"\n开个坑，时不时分享下自己和口琴，权当记录自己和音乐那仅有的缘分了😂。\n<!-- more -->\n音乐白痴想要学乐器，网上随便一搜，大多数人都会推荐吉他，其次可能是电子琴。美其名曰吉他上手快，而且可以伴奏。那我这种五音不全加木耳肯定第一个就淘汰了,正巧这个时候在网上看到了一段视屏 龙登杰演奏的Flower Dance。\n<iframe src=\"//player.bilibili.com/player.html?aid=27879949&bvid=BV17s411A7bv&cid=48145340&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n\nFlower Dance已经被各种乐器大神演绎过了，但龙登杰的半音阶真的是让我浑身鸡皮疙瘩。口琴虽然没有钢琴版优美的音色，也没有吉他版的自然，但是现场的感染力真的是无人能比。打个比方，钢琴适合为他人演奏，但口琴更像是给自己的音乐。最重要的是，对我们这种五音不全的意味着根本不用考虑唱歌这件事了😂。\n\n口琴本身也分很多种：半音阶、复音、布鲁斯等。作为初学者的话个人认为布鲁斯会是比较好的选择。虽然不像半音阶能吹出全音符，也不像复音音阶比较多（其实我们小时候接触的大不符口琴都是复音口琴）。但布鲁斯本身小巧，在不掌握复杂技巧的前提下就能吹奏大量的乐曲。\n唯一值得注意的是，布鲁斯就如其名，过去是黑人乐手大量吹奏布鲁斯音乐时使用的。所以它的音色交半音阶个人觉得稍显浑厚。不过我觉得这也是布鲁斯口琴最大的特色。吹对的歌，或者说掌控了音色，那时候就是布鲁斯最强的时候。同时最为即兴，布鲁斯也是最为适合的，当然那都是大神们的领域就是了。\n\n我的第一把布鲁斯口琴：\n\n![01](Harmonica/SilverStar.jpeg)\n\nHohner(赫莱)在口琴界是几大品牌之一，最为德国的品牌其质量一直是广大琴友口口相传的。但这吧SilverStar就另当别论了，要比喻的话就类似德国宝马和国产宝马的区别。\n\n首先做工就不经如人意，运气不好的话，有些音口可能会有气密性的问题。直接导致了有些音可能很难吹。\n\n其次簧片反馈很诡异，这也是我个人的感觉。有些音很容易就吹出来了，但越是低音或者高音，吹奏难度就越高。口琴新手最大的一个坎就是压音，如果不巧需要压音的那几个音很难吹，那对新手来说可能是毁灭性的打击。。。记得最早练习压音的时候，这把SilverStar死活都没法成功，只要换了把更好的后才渐渐找到压音的感觉。日后回到这把SilverStar上居然神奇的也找到了压音的感觉，说来也是奇妙啊。\n\n第二把口琴：\n\n![02](Harmonica/GodenMelody.jpeg)\n\n我的第二把口琴还是Hohner，但这把是真真切切的原厂口琴。小300的价格也算布鲁斯里的劳力士了😂。\n\n这把口琴的造型就非常有特色，梳子型设计非常别致。和其他高端口琴一样，琴尺采用了全包围的设计。与日厂铃木的口轻相比，铃木给人的感觉更加圆润，而这把在圆润的前提下又不失豪放的设计。纯银色的琴身和红色的琴尺相得益彰。\n\n和之前一把口琴吹起来，上嘴的那一刹那仿佛拿到了一个新乐器。绝对是要适应下才能正常演奏的，不过一旦习惯后，不论音色还是反馈都远远强于之前的那把贴牌货。更重要的是，我也是在这把口琴上学会的如何压音。如果可以，以后再买一把收藏了。","source":"_posts/Harmonica.md","raw":"---\ntitle: Harmonica\ndate: 2020-06-13 10:07:08\ntags:\n    - Harmonica\ncategories:\n    - Music\n---\n\n开个坑，时不时分享下自己和口琴，权当记录自己和音乐那仅有的缘分了😂。\n<!-- more -->\n音乐白痴想要学乐器，网上随便一搜，大多数人都会推荐吉他，其次可能是电子琴。美其名曰吉他上手快，而且可以伴奏。那我这种五音不全加木耳肯定第一个就淘汰了,正巧这个时候在网上看到了一段视屏 龙登杰演奏的Flower Dance。\n<iframe src=\"//player.bilibili.com/player.html?aid=27879949&bvid=BV17s411A7bv&cid=48145340&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n\nFlower Dance已经被各种乐器大神演绎过了，但龙登杰的半音阶真的是让我浑身鸡皮疙瘩。口琴虽然没有钢琴版优美的音色，也没有吉他版的自然，但是现场的感染力真的是无人能比。打个比方，钢琴适合为他人演奏，但口琴更像是给自己的音乐。最重要的是，对我们这种五音不全的意味着根本不用考虑唱歌这件事了😂。\n\n口琴本身也分很多种：半音阶、复音、布鲁斯等。作为初学者的话个人认为布鲁斯会是比较好的选择。虽然不像半音阶能吹出全音符，也不像复音音阶比较多（其实我们小时候接触的大不符口琴都是复音口琴）。但布鲁斯本身小巧，在不掌握复杂技巧的前提下就能吹奏大量的乐曲。\n唯一值得注意的是，布鲁斯就如其名，过去是黑人乐手大量吹奏布鲁斯音乐时使用的。所以它的音色交半音阶个人觉得稍显浑厚。不过我觉得这也是布鲁斯口琴最大的特色。吹对的歌，或者说掌控了音色，那时候就是布鲁斯最强的时候。同时最为即兴，布鲁斯也是最为适合的，当然那都是大神们的领域就是了。\n\n我的第一把布鲁斯口琴：\n\n![01](Harmonica/SilverStar.jpeg)\n\nHohner(赫莱)在口琴界是几大品牌之一，最为德国的品牌其质量一直是广大琴友口口相传的。但这吧SilverStar就另当别论了，要比喻的话就类似德国宝马和国产宝马的区别。\n\n首先做工就不经如人意，运气不好的话，有些音口可能会有气密性的问题。直接导致了有些音可能很难吹。\n\n其次簧片反馈很诡异，这也是我个人的感觉。有些音很容易就吹出来了，但越是低音或者高音，吹奏难度就越高。口琴新手最大的一个坎就是压音，如果不巧需要压音的那几个音很难吹，那对新手来说可能是毁灭性的打击。。。记得最早练习压音的时候，这把SilverStar死活都没法成功，只要换了把更好的后才渐渐找到压音的感觉。日后回到这把SilverStar上居然神奇的也找到了压音的感觉，说来也是奇妙啊。\n\n第二把口琴：\n\n![02](Harmonica/GodenMelody.jpeg)\n\n我的第二把口琴还是Hohner，但这把是真真切切的原厂口琴。小300的价格也算布鲁斯里的劳力士了😂。\n\n这把口琴的造型就非常有特色，梳子型设计非常别致。和其他高端口琴一样，琴尺采用了全包围的设计。与日厂铃木的口轻相比，铃木给人的感觉更加圆润，而这把在圆润的前提下又不失豪放的设计。纯银色的琴身和红色的琴尺相得益彰。\n\n和之前一把口琴吹起来，上嘴的那一刹那仿佛拿到了一个新乐器。绝对是要适应下才能正常演奏的，不过一旦习惯后，不论音色还是反馈都远远强于之前的那把贴牌货。更重要的是，我也是在这把口琴上学会的如何压音。如果可以，以后再买一把收藏了。","slug":"Harmonica","published":1,"updated":"2020-12-14T10:40:34.911Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71hsz0003v2522odqc0cl","content":"<html><head></head><body><p>&#x5F00;&#x4E2A;&#x5751;&#xFF0C;&#x65F6;&#x4E0D;&#x65F6;&#x5206;&#x4EAB;&#x4E0B;&#x81EA;&#x5DF1;&#x548C;&#x53E3;&#x7434;&#xFF0C;&#x6743;&#x5F53;&#x8BB0;&#x5F55;&#x81EA;&#x5DF1;&#x548C;&#x97F3;&#x4E50;&#x90A3;&#x4EC5;&#x6709;&#x7684;&#x7F18;&#x5206;&#x4E86;&#x1F602;&#x3002;</p>\n<a id=\"more\"></a>\n<p>&#x97F3;&#x4E50;&#x767D;&#x75F4;&#x60F3;&#x8981;&#x5B66;&#x4E50;&#x5668;&#xFF0C;&#x7F51;&#x4E0A;&#x968F;&#x4FBF;&#x4E00;&#x641C;&#xFF0C;&#x5927;&#x591A;&#x6570;&#x4EBA;&#x90FD;&#x4F1A;&#x63A8;&#x8350;&#x5409;&#x4ED6;&#xFF0C;&#x5176;&#x6B21;&#x53EF;&#x80FD;&#x662F;&#x7535;&#x5B50;&#x7434;&#x3002;&#x7F8E;&#x5176;&#x540D;&#x66F0;&#x5409;&#x4ED6;&#x4E0A;&#x624B;&#x5FEB;&#xFF0C;&#x800C;&#x4E14;&#x53EF;&#x4EE5;&#x4F34;&#x594F;&#x3002;&#x90A3;&#x6211;&#x8FD9;&#x79CD;&#x4E94;&#x97F3;&#x4E0D;&#x5168;&#x52A0;&#x6728;&#x8033;&#x80AF;&#x5B9A;&#x7B2C;&#x4E00;&#x4E2A;&#x5C31;&#x6DD8;&#x6C70;&#x4E86;,&#x6B63;&#x5DE7;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x5728;&#x7F51;&#x4E0A;&#x770B;&#x5230;&#x4E86;&#x4E00;&#x6BB5;&#x89C6;&#x5C4F; &#x9F99;&#x767B;&#x6770;&#x6F14;&#x594F;&#x7684;Flower Dance&#x3002;</p>\n<iframe src=\"//player.bilibili.com/player.html?aid=27879949&amp;bvid=BV17s411A7bv&amp;cid=48145340&amp;page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n\n<p>Flower Dance&#x5DF2;&#x7ECF;&#x88AB;&#x5404;&#x79CD;&#x4E50;&#x5668;&#x5927;&#x795E;&#x6F14;&#x7ECE;&#x8FC7;&#x4E86;&#xFF0C;&#x4F46;&#x9F99;&#x767B;&#x6770;&#x7684;&#x534A;&#x97F3;&#x9636;&#x771F;&#x7684;&#x662F;&#x8BA9;&#x6211;&#x6D51;&#x8EAB;&#x9E21;&#x76AE;&#x7599;&#x7629;&#x3002;&#x53E3;&#x7434;&#x867D;&#x7136;&#x6CA1;&#x6709;&#x94A2;&#x7434;&#x7248;&#x4F18;&#x7F8E;&#x7684;&#x97F3;&#x8272;&#xFF0C;&#x4E5F;&#x6CA1;&#x6709;&#x5409;&#x4ED6;&#x7248;&#x7684;&#x81EA;&#x7136;&#xFF0C;&#x4F46;&#x662F;&#x73B0;&#x573A;&#x7684;&#x611F;&#x67D3;&#x529B;&#x771F;&#x7684;&#x662F;&#x65E0;&#x4EBA;&#x80FD;&#x6BD4;&#x3002;&#x6253;&#x4E2A;&#x6BD4;&#x65B9;&#xFF0C;&#x94A2;&#x7434;&#x9002;&#x5408;&#x4E3A;&#x4ED6;&#x4EBA;&#x6F14;&#x594F;&#xFF0C;&#x4F46;&#x53E3;&#x7434;&#x66F4;&#x50CF;&#x662F;&#x7ED9;&#x81EA;&#x5DF1;&#x7684;&#x97F3;&#x4E50;&#x3002;&#x6700;&#x91CD;&#x8981;&#x7684;&#x662F;&#xFF0C;&#x5BF9;&#x6211;&#x4EEC;&#x8FD9;&#x79CD;&#x4E94;&#x97F3;&#x4E0D;&#x5168;&#x7684;&#x610F;&#x5473;&#x7740;&#x6839;&#x672C;&#x4E0D;&#x7528;&#x8003;&#x8651;&#x5531;&#x6B4C;&#x8FD9;&#x4EF6;&#x4E8B;&#x4E86;&#x1F602;&#x3002;</p>\n<p>&#x53E3;&#x7434;&#x672C;&#x8EAB;&#x4E5F;&#x5206;&#x5F88;&#x591A;&#x79CD;&#xFF1A;&#x534A;&#x97F3;&#x9636;&#x3001;&#x590D;&#x97F3;&#x3001;&#x5E03;&#x9C81;&#x65AF;&#x7B49;&#x3002;&#x4F5C;&#x4E3A;&#x521D;&#x5B66;&#x8005;&#x7684;&#x8BDD;&#x4E2A;&#x4EBA;&#x8BA4;&#x4E3A;&#x5E03;&#x9C81;&#x65AF;&#x4F1A;&#x662F;&#x6BD4;&#x8F83;&#x597D;&#x7684;&#x9009;&#x62E9;&#x3002;&#x867D;&#x7136;&#x4E0D;&#x50CF;&#x534A;&#x97F3;&#x9636;&#x80FD;&#x5439;&#x51FA;&#x5168;&#x97F3;&#x7B26;&#xFF0C;&#x4E5F;&#x4E0D;&#x50CF;&#x590D;&#x97F3;&#x97F3;&#x9636;&#x6BD4;&#x8F83;&#x591A;&#xFF08;&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x5C0F;&#x65F6;&#x5019;&#x63A5;&#x89E6;&#x7684;&#x5927;&#x4E0D;&#x7B26;&#x53E3;&#x7434;&#x90FD;&#x662F;&#x590D;&#x97F3;&#x53E3;&#x7434;&#xFF09;&#x3002;&#x4F46;&#x5E03;&#x9C81;&#x65AF;&#x672C;&#x8EAB;&#x5C0F;&#x5DE7;&#xFF0C;&#x5728;&#x4E0D;&#x638C;&#x63E1;&#x590D;&#x6742;&#x6280;&#x5DE7;&#x7684;&#x524D;&#x63D0;&#x4E0B;&#x5C31;&#x80FD;&#x5439;&#x594F;&#x5927;&#x91CF;&#x7684;&#x4E50;&#x66F2;&#x3002;<br>&#x552F;&#x4E00;&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x5E03;&#x9C81;&#x65AF;&#x5C31;&#x5982;&#x5176;&#x540D;&#xFF0C;&#x8FC7;&#x53BB;&#x662F;&#x9ED1;&#x4EBA;&#x4E50;&#x624B;&#x5927;&#x91CF;&#x5439;&#x594F;&#x5E03;&#x9C81;&#x65AF;&#x97F3;&#x4E50;&#x65F6;&#x4F7F;&#x7528;&#x7684;&#x3002;&#x6240;&#x4EE5;&#x5B83;&#x7684;&#x97F3;&#x8272;&#x4EA4;&#x534A;&#x97F3;&#x9636;&#x4E2A;&#x4EBA;&#x89C9;&#x5F97;&#x7A0D;&#x663E;&#x6D51;&#x539A;&#x3002;&#x4E0D;&#x8FC7;&#x6211;&#x89C9;&#x5F97;&#x8FD9;&#x4E5F;&#x662F;&#x5E03;&#x9C81;&#x65AF;&#x53E3;&#x7434;&#x6700;&#x5927;&#x7684;&#x7279;&#x8272;&#x3002;&#x5439;&#x5BF9;&#x7684;&#x6B4C;&#xFF0C;&#x6216;&#x8005;&#x8BF4;&#x638C;&#x63A7;&#x4E86;&#x97F3;&#x8272;&#xFF0C;&#x90A3;&#x65F6;&#x5019;&#x5C31;&#x662F;&#x5E03;&#x9C81;&#x65AF;&#x6700;&#x5F3A;&#x7684;&#x65F6;&#x5019;&#x3002;&#x540C;&#x65F6;&#x6700;&#x4E3A;&#x5373;&#x5174;&#xFF0C;&#x5E03;&#x9C81;&#x65AF;&#x4E5F;&#x662F;&#x6700;&#x4E3A;&#x9002;&#x5408;&#x7684;&#xFF0C;&#x5F53;&#x7136;&#x90A3;&#x90FD;&#x662F;&#x5927;&#x795E;&#x4EEC;&#x7684;&#x9886;&#x57DF;&#x5C31;&#x662F;&#x4E86;&#x3002;</p>\n<p>&#x6211;&#x7684;&#x7B2C;&#x4E00;&#x628A;&#x5E03;&#x9C81;&#x65AF;&#x53E3;&#x7434;&#xFF1A;</p>\n<p><img src=\"/2020/06/13/Harmonica/SilverStar.jpeg\" alt=\"01\"></p>\n<p>Hohner(&#x8D6B;&#x83B1;)&#x5728;&#x53E3;&#x7434;&#x754C;&#x662F;&#x51E0;&#x5927;&#x54C1;&#x724C;&#x4E4B;&#x4E00;&#xFF0C;&#x6700;&#x4E3A;&#x5FB7;&#x56FD;&#x7684;&#x54C1;&#x724C;&#x5176;&#x8D28;&#x91CF;&#x4E00;&#x76F4;&#x662F;&#x5E7F;&#x5927;&#x7434;&#x53CB;&#x53E3;&#x53E3;&#x76F8;&#x4F20;&#x7684;&#x3002;&#x4F46;&#x8FD9;&#x5427;SilverStar&#x5C31;&#x53E6;&#x5F53;&#x522B;&#x8BBA;&#x4E86;&#xFF0C;&#x8981;&#x6BD4;&#x55BB;&#x7684;&#x8BDD;&#x5C31;&#x7C7B;&#x4F3C;&#x5FB7;&#x56FD;&#x5B9D;&#x9A6C;&#x548C;&#x56FD;&#x4EA7;&#x5B9D;&#x9A6C;&#x7684;&#x533A;&#x522B;&#x3002;</p>\n<p>&#x9996;&#x5148;&#x505A;&#x5DE5;&#x5C31;&#x4E0D;&#x7ECF;&#x5982;&#x4EBA;&#x610F;&#xFF0C;&#x8FD0;&#x6C14;&#x4E0D;&#x597D;&#x7684;&#x8BDD;&#xFF0C;&#x6709;&#x4E9B;&#x97F3;&#x53E3;&#x53EF;&#x80FD;&#x4F1A;&#x6709;&#x6C14;&#x5BC6;&#x6027;&#x7684;&#x95EE;&#x9898;&#x3002;&#x76F4;&#x63A5;&#x5BFC;&#x81F4;&#x4E86;&#x6709;&#x4E9B;&#x97F3;&#x53EF;&#x80FD;&#x5F88;&#x96BE;&#x5439;&#x3002;</p>\n<p>&#x5176;&#x6B21;&#x7C27;&#x7247;&#x53CD;&#x9988;&#x5F88;&#x8BE1;&#x5F02;&#xFF0C;&#x8FD9;&#x4E5F;&#x662F;&#x6211;&#x4E2A;&#x4EBA;&#x7684;&#x611F;&#x89C9;&#x3002;&#x6709;&#x4E9B;&#x97F3;&#x5F88;&#x5BB9;&#x6613;&#x5C31;&#x5439;&#x51FA;&#x6765;&#x4E86;&#xFF0C;&#x4F46;&#x8D8A;&#x662F;&#x4F4E;&#x97F3;&#x6216;&#x8005;&#x9AD8;&#x97F3;&#xFF0C;&#x5439;&#x594F;&#x96BE;&#x5EA6;&#x5C31;&#x8D8A;&#x9AD8;&#x3002;&#x53E3;&#x7434;&#x65B0;&#x624B;&#x6700;&#x5927;&#x7684;&#x4E00;&#x4E2A;&#x574E;&#x5C31;&#x662F;&#x538B;&#x97F3;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x5DE7;&#x9700;&#x8981;&#x538B;&#x97F3;&#x7684;&#x90A3;&#x51E0;&#x4E2A;&#x97F3;&#x5F88;&#x96BE;&#x5439;&#xFF0C;&#x90A3;&#x5BF9;&#x65B0;&#x624B;&#x6765;&#x8BF4;&#x53EF;&#x80FD;&#x662F;&#x6BC1;&#x706D;&#x6027;&#x7684;&#x6253;&#x51FB;&#x3002;&#x3002;&#x3002;&#x8BB0;&#x5F97;&#x6700;&#x65E9;&#x7EC3;&#x4E60;&#x538B;&#x97F3;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FD9;&#x628A;SilverStar&#x6B7B;&#x6D3B;&#x90FD;&#x6CA1;&#x6CD5;&#x6210;&#x529F;&#xFF0C;&#x53EA;&#x8981;&#x6362;&#x4E86;&#x628A;&#x66F4;&#x597D;&#x7684;&#x540E;&#x624D;&#x6E10;&#x6E10;&#x627E;&#x5230;&#x538B;&#x97F3;&#x7684;&#x611F;&#x89C9;&#x3002;&#x65E5;&#x540E;&#x56DE;&#x5230;&#x8FD9;&#x628A;SilverStar&#x4E0A;&#x5C45;&#x7136;&#x795E;&#x5947;&#x7684;&#x4E5F;&#x627E;&#x5230;&#x4E86;&#x538B;&#x97F3;&#x7684;&#x611F;&#x89C9;&#xFF0C;&#x8BF4;&#x6765;&#x4E5F;&#x662F;&#x5947;&#x5999;&#x554A;&#x3002;</p>\n<p>&#x7B2C;&#x4E8C;&#x628A;&#x53E3;&#x7434;&#xFF1A;</p>\n<p><img src=\"/2020/06/13/Harmonica/GodenMelody.jpeg\" alt=\"02\"></p>\n<p>&#x6211;&#x7684;&#x7B2C;&#x4E8C;&#x628A;&#x53E3;&#x7434;&#x8FD8;&#x662F;Hohner&#xFF0C;&#x4F46;&#x8FD9;&#x628A;&#x662F;&#x771F;&#x771F;&#x5207;&#x5207;&#x7684;&#x539F;&#x5382;&#x53E3;&#x7434;&#x3002;&#x5C0F;300&#x7684;&#x4EF7;&#x683C;&#x4E5F;&#x7B97;&#x5E03;&#x9C81;&#x65AF;&#x91CC;&#x7684;&#x52B3;&#x529B;&#x58EB;&#x4E86;&#x1F602;&#x3002;</p>\n<p>&#x8FD9;&#x628A;&#x53E3;&#x7434;&#x7684;&#x9020;&#x578B;&#x5C31;&#x975E;&#x5E38;&#x6709;&#x7279;&#x8272;&#xFF0C;&#x68B3;&#x5B50;&#x578B;&#x8BBE;&#x8BA1;&#x975E;&#x5E38;&#x522B;&#x81F4;&#x3002;&#x548C;&#x5176;&#x4ED6;&#x9AD8;&#x7AEF;&#x53E3;&#x7434;&#x4E00;&#x6837;&#xFF0C;&#x7434;&#x5C3A;&#x91C7;&#x7528;&#x4E86;&#x5168;&#x5305;&#x56F4;&#x7684;&#x8BBE;&#x8BA1;&#x3002;&#x4E0E;&#x65E5;&#x5382;&#x94C3;&#x6728;&#x7684;&#x53E3;&#x8F7B;&#x76F8;&#x6BD4;&#xFF0C;&#x94C3;&#x6728;&#x7ED9;&#x4EBA;&#x7684;&#x611F;&#x89C9;&#x66F4;&#x52A0;&#x5706;&#x6DA6;&#xFF0C;&#x800C;&#x8FD9;&#x628A;&#x5728;&#x5706;&#x6DA6;&#x7684;&#x524D;&#x63D0;&#x4E0B;&#x53C8;&#x4E0D;&#x5931;&#x8C6A;&#x653E;&#x7684;&#x8BBE;&#x8BA1;&#x3002;&#x7EAF;&#x94F6;&#x8272;&#x7684;&#x7434;&#x8EAB;&#x548C;&#x7EA2;&#x8272;&#x7684;&#x7434;&#x5C3A;&#x76F8;&#x5F97;&#x76CA;&#x5F70;&#x3002;</p>\n<p>&#x548C;&#x4E4B;&#x524D;&#x4E00;&#x628A;&#x53E3;&#x7434;&#x5439;&#x8D77;&#x6765;&#xFF0C;&#x4E0A;&#x5634;&#x7684;&#x90A3;&#x4E00;&#x5239;&#x90A3;&#x4EFF;&#x4F5B;&#x62FF;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x4E50;&#x5668;&#x3002;&#x7EDD;&#x5BF9;&#x662F;&#x8981;&#x9002;&#x5E94;&#x4E0B;&#x624D;&#x80FD;&#x6B63;&#x5E38;&#x6F14;&#x594F;&#x7684;&#xFF0C;&#x4E0D;&#x8FC7;&#x4E00;&#x65E6;&#x4E60;&#x60EF;&#x540E;&#xFF0C;&#x4E0D;&#x8BBA;&#x97F3;&#x8272;&#x8FD8;&#x662F;&#x53CD;&#x9988;&#x90FD;&#x8FDC;&#x8FDC;&#x5F3A;&#x4E8E;&#x4E4B;&#x524D;&#x7684;&#x90A3;&#x628A;&#x8D34;&#x724C;&#x8D27;&#x3002;&#x66F4;&#x91CD;&#x8981;&#x7684;&#x662F;&#xFF0C;&#x6211;&#x4E5F;&#x662F;&#x5728;&#x8FD9;&#x628A;&#x53E3;&#x7434;&#x4E0A;&#x5B66;&#x4F1A;&#x7684;&#x5982;&#x4F55;&#x538B;&#x97F3;&#x3002;&#x5982;&#x679C;&#x53EF;&#x4EE5;&#xFF0C;&#x4EE5;&#x540E;&#x518D;&#x4E70;&#x4E00;&#x628A;&#x6536;&#x85CF;&#x4E86;&#x3002;</p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Music","path":"categories/Music/"}],"_tags":[{"name":"Harmonica","path":"tags/Harmonica/"}],"excerpt":"<html><head></head><body><p>&#x5F00;&#x4E2A;&#x5751;&#xFF0C;&#x65F6;&#x4E0D;&#x65F6;&#x5206;&#x4EAB;&#x4E0B;&#x81EA;&#x5DF1;&#x548C;&#x53E3;&#x7434;&#xFF0C;&#x6743;&#x5F53;&#x8BB0;&#x5F55;&#x81EA;&#x5DF1;&#x548C;&#x97F3;&#x4E50;&#x90A3;&#x4EC5;&#x6709;&#x7684;&#x7F18;&#x5206;&#x4E86;&#x1F602;&#x3002;</p></body></html>","more":"<p>音乐白痴想要学乐器，网上随便一搜，大多数人都会推荐吉他，其次可能是电子琴。美其名曰吉他上手快，而且可以伴奏。那我这种五音不全加木耳肯定第一个就淘汰了,正巧这个时候在网上看到了一段视屏 龙登杰演奏的Flower Dance。</p>\n<iframe src=\"//player.bilibili.com/player.html?aid=27879949&bvid=BV17s411A7bv&cid=48145340&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\"> </iframe>\n\n<p>Flower Dance已经被各种乐器大神演绎过了，但龙登杰的半音阶真的是让我浑身鸡皮疙瘩。口琴虽然没有钢琴版优美的音色，也没有吉他版的自然，但是现场的感染力真的是无人能比。打个比方，钢琴适合为他人演奏，但口琴更像是给自己的音乐。最重要的是，对我们这种五音不全的意味着根本不用考虑唱歌这件事了😂。</p>\n<p>口琴本身也分很多种：半音阶、复音、布鲁斯等。作为初学者的话个人认为布鲁斯会是比较好的选择。虽然不像半音阶能吹出全音符，也不像复音音阶比较多（其实我们小时候接触的大不符口琴都是复音口琴）。但布鲁斯本身小巧，在不掌握复杂技巧的前提下就能吹奏大量的乐曲。<br>唯一值得注意的是，布鲁斯就如其名，过去是黑人乐手大量吹奏布鲁斯音乐时使用的。所以它的音色交半音阶个人觉得稍显浑厚。不过我觉得这也是布鲁斯口琴最大的特色。吹对的歌，或者说掌控了音色，那时候就是布鲁斯最强的时候。同时最为即兴，布鲁斯也是最为适合的，当然那都是大神们的领域就是了。</p>\n<p>我的第一把布鲁斯口琴：</p>\n<p><img src=\"/2020/06/13/Harmonica/SilverStar.jpeg\" alt=\"01\"></p>\n<p>Hohner(赫莱)在口琴界是几大品牌之一，最为德国的品牌其质量一直是广大琴友口口相传的。但这吧SilverStar就另当别论了，要比喻的话就类似德国宝马和国产宝马的区别。</p>\n<p>首先做工就不经如人意，运气不好的话，有些音口可能会有气密性的问题。直接导致了有些音可能很难吹。</p>\n<p>其次簧片反馈很诡异，这也是我个人的感觉。有些音很容易就吹出来了，但越是低音或者高音，吹奏难度就越高。口琴新手最大的一个坎就是压音，如果不巧需要压音的那几个音很难吹，那对新手来说可能是毁灭性的打击。。。记得最早练习压音的时候，这把SilverStar死活都没法成功，只要换了把更好的后才渐渐找到压音的感觉。日后回到这把SilverStar上居然神奇的也找到了压音的感觉，说来也是奇妙啊。</p>\n<p>第二把口琴：</p>\n<p><img src=\"/2020/06/13/Harmonica/GodenMelody.jpeg\" alt=\"02\"></p>\n<p>我的第二把口琴还是Hohner，但这把是真真切切的原厂口琴。小300的价格也算布鲁斯里的劳力士了😂。</p>\n<p>这把口琴的造型就非常有特色，梳子型设计非常别致。和其他高端口琴一样，琴尺采用了全包围的设计。与日厂铃木的口轻相比，铃木给人的感觉更加圆润，而这把在圆润的前提下又不失豪放的设计。纯银色的琴身和红色的琴尺相得益彰。</p>\n<p>和之前一把口琴吹起来，上嘴的那一刹那仿佛拿到了一个新乐器。绝对是要适应下才能正常演奏的，不过一旦习惯后，不论音色还是反馈都远远强于之前的那把贴牌货。更重要的是，我也是在这把口琴上学会的如何压音。如果可以，以后再买一把收藏了。</p>"},{"title":"JVM 整理","date":"2020-02-22T07:03:19.000Z","_content":"\n# JVM 相关知识整理\n1. 内存分配\n2. 垃圾回收器的参数配置\n\n## 类的加载\n<!-- more -->\n加载->验证->准备->解析->初始化->使用->卸载\n\n### 加载流程\n\n- 加载\n\n  代码中使用到这个类的时候，.class字节码文件就会加载这个类到JVM内存中。\n\n- 链接\n\n\t- 验证\n\n\t  根据JVM规范，校验.class文件。\n\n\t- 准备\n\n\t  给加载的类分配内存空间，同时给类的static变量分配内存空间，并设置默认值0。\n\t  clint()\n\n\t- 解析\n\n\t  把符号引用替换为直接引用。\n\n- 初始化\n\n  为类变量赋值：静态方法，静态变量，静态块。\n  初始化一个类的时候，如果发现有父类还没初始化，会先初始化他的父类。\n\n### 类加载器\n\n- 加载器\n\n\t- BootStrap ClassLoader\n\n\t  加载lib目录下的类库\n\n\t- Extension ClassLoader\n\n\t  加载lib\\ext目录下的类库\n\n\t- Application ClassLoader\n\n\t  加载ClassPath下的类\n\n\t- 自定义加载器\n\n- 双亲委派机制\n\n  先找父亲加载，加载不了再找儿子加载\n\n## 内存结构\n\n### 方法区、元空间、永久代\n\n存放类的定义，常量池等。\nmatespace满后会触发Full GC。\n方法区垃圾回收：\n1.该类的所有实例已经被回收\n2.加载该类的ClassLoader已经被回收\n3.该类的Class对象没有被任何引用\n\n### 程序技术器\n\n记录当前执行的字节码指令的位置。\n线程私有。\n\n### Java虚拟机栈\n\n保存方法信息。\n线程私有。\n\n- 栈帧\n\n\t- 局部变量表\n\t- 操作数栈\n\t- 动态链接\n\t- 方法返回地址\n\t- 其他\n\n### Java堆内存\n\n存放类的实例对象。\n\n- 分代\n\n\t- 年轻代\n\n\t  新生代进入老年代：默认15次\n\n\t\t- Eden区\n\n\t\t  默认新生代80%空间。\n\t\t  新建对象产生在Eden区。\n\t\t  Eden区满后会发生Minor GC。\n\n\t\t- Survivor0,1区\n\n\t\t  默认年轻代20%。Survivor 0:10%  Survivor 1:10%。\n\t\t  默认对象幸存15次后，会进入老年区。\n\n\t\t\t- 动态年龄判断\n\n\t\t\t  当一批对象的大小大于Survivor区大小的50%，这批对象将不询问年龄，直接进入老年代。\n\n\t- 老年代\n\n\t\t- 进入老年代的规则\n\n\t\t\t- 年龄超过MaxTenuring\n\t\t\t- 动态年龄判断\n\t\t\t- 超过PretenureSize的大对象\n\t\t\t- Eden区幸存对象超过Survivor区大小\n\n- JVM参数\n\n\t- -Xms\n\n\t  Java堆内存的大小\n\n\t- -Xmx\n\n\t  Java堆内存的最大大小\n\n\t- -Xmn\n\n\t  Java对内存中的新生代大小。\n\t  老年代=总大小-新生代\n\n\t- -XX:PermSize\n\n\t  永久代大小\n\n\t- -XX:MaxPermSize\n\n\t  永久代最大大小\n\n\t- -XX:MetaspaceSize\n\n\t  元空间大小\n\n\t- -XX:MaxMetaspaceSize\n\n\t  元空间最大大小\n\n\t- -Xss\n\n\t  Java栈内存大小\n\n\t- -XX:MaxTenuringThreshold\n\n\t  对象在年轻代中幸存的最大轮数。\n\t  默认15，且不能超过15.\n\n\t- -XX:PretenureSizeThreshold\n\n\t  当对象大小超过该值时，对象直接进入老年代，不会进过年轻代。\n\t  避免大对象在Survivor中多次复制，减少无谓的操作。\n\n\t- -XX:-HandlePromotionFailure\n\n\t  判断老年代内存大小是否大于之前每一次Minor GC后进入老年代的对象的平均大小。\n\t  判断失败进行Full GC，再执行Minor GC。\n\n\t- -XX:SurvivorRatio\n\n\t  调整Eden区和Survivor区内存比率\n\t  - XX:SurvivorRatio=8  ： Eden 80%\n\n\t- -XX:+PrintGCDetils\n\n\t  打印详细的GC日志。\n\n\t- -XX:+PrintGCTimeStamps\n\n\t  打印GC发生的时间。\n\n\t- -Xloggc:gc.log\n\n\t  将CG日志输入到文件。\n\n\t- -XX:TraceClassLoading\n\n\t  追踪加载的类\n\n\t- -XX:TraceClassUnloading\n\n\t  追踪卸载的类\n\n\t- -XX:+HeapDumpOnOutOfMemoryError  \n\n\t  OOM时自动dump快照\n\n\t- -XX:HeapDumpPath=/usr/local/app/oom\n\n\t  将快照存放至指定目录\n\n\t- CMS\n\n\t\t- -XX:CMSInitiatingOccupancyFaction\n\n\t\t  设置老年代占用多少比例时触发CMS\n\n\t\t- -XX:+UseCMSCompactAtFullCollection\n\n\t\t  Full GC后STW，整理内存碎片。\n\n\t\t- -XX:CMSFullGCsBeforeCompaction\n\n\t\t  默认0，设置多少次Full GC后进行内存碎片整理。\n\n\t\t- -XX:+CMSParallelInitialMarkEnabled\n\n\t\t  初始标记阶段开启并发执行\n\n\t- G1\n\n\t\t- -XX:+UseG1GC\n\n\t\t  指定G1垃圾回收器。\n\n\t\t- -XX:G1HeapRegionSize\n\n\t\t  手动指定G1的Region的大小。\n\n\t\t- -XX:G1NewSizePercent\n\n\t\t  调整新生代在堆中的占比。\n\t\t  默认5%。\n\n\t\t- -XX:G1MaxNewSizePercent\n\n\t\t  新生代占比堆空间的最大大小。\n\n\t\t- -XX:MaxGCPauseMills\n\n\t\t  默认200ms。\n\t\t  设置G1垃圾回收器GC时的最大停顿时间。\n\n\t\t- -XX:InitiatingHeapOccupancyPercent\n\n\t\t  默认45%。\n\t\t  老年代占据的堆内存超多该值，将会进行新老生代的混合回收。\n\n\t\t- -XX:G1MixedGCCountTarget\n\n\t\t  一次G1混合回收过程中，最后阶段混合回收阶段分几次完成。\n\t\t  默认8。\n\n\t\t- -XX:G1HeapWastePercent\n\n\t\t  默认值5%。\n\t\t  混合回收阶段中，空间Region占比堆空间超多该值，会停止混合回收。\n\n\t\t- -XX:G1MixedGCLiveThresholdPercent\n\n\t\t  默认值85%。\n\t\t  一个Region中的存活对象低于该值时才会被回收。\n\n\t\t- -XX:+CMSScavengeBeforeRemark\n\n\t\t  重新标记前，尽量执行一次Young GC。\n\t\t  提前回收年轻代没有引用的对象，减少重新标记扫描的对象数，提高效率。\n\n- 垃圾回收\n\n\t- 可达性分析\n\n\t  对一个对象层层向上分析，判断是否有一个GC Root。\n\n\t\t- GC Root\n\n\t\t\t- 本地变量表中的局部变量\n\t\t\t- 方法区内的静态变量\n\n\t- java 引用类型\n\n\t\t- 强引用\n\n\t\t  GC不会回收强引用\n\n\t\t- 软引用\n\n\t\t  内存空间足够时，GC不会回收软引用\n\n\t\t- 弱引用\n\n\t\t  GC时必定回收弱引用\n\n\t\t- 虚引用\n\n\t\t  继承Object的finalize()方法，在该对象被回收的时候通知自己。\n\n\t- 垃圾回收算法\n\n\t\t- 年轻代\n\n\t\t\t- 复制\n\n\t\t\t  在新生代幸存者0,1区使用。将标记为可用的内存复制到另外一片连续的内存区域中，并删除当前内存区域中的全部数据。\n\n\t\t\t\t- 优点\n\n\t\t\t\t  不会产生内存碎片\n\n\t\t\t\t- 缺点\n\n\t\t\t\t  增加内存的消耗\n\n\t\t- 老年代\n\n\t\t\t- 标记整理\n\n\t\t\t  标记存活对象，删除死亡对象，整理内存碎片。\n\n\t\t\t\t- 优点\n\n\t\t\t\t  不会产生内存碎片。内存利用率高。\n\n\t\t\t\t- 缺点\n\n\t\t\t\t  比起标记清楚，执行效率慢。\n\n\t- JVM垃圾回收器\n\n\t\t- 年轻代\n\n\t\t\t- ParNew\n\n\t\t\t  多线程，复制算法。\n\t\t\t  开启：-XX:+UseParNewGC\n\t\t\t  调整回收线程数：-XX:ParallelGCThreads\n\n\t\t- 老年代\n\n\t\t\t- CMS\n\n\t\t\t  标记清理算法\n\n\t\t\t\t- 回收过程\n\n\t\t\t\t\t- 初始标记\n\n\t\t\t\t\t  STW。\n\t\t\t\t\t  标记所有GC Roots直接引用的对象，被直接引用的对象所引用的对象不会被标记。\n\n\t\t\t\t\t- 并发标记\n\n\t\t\t\t\t  寻找被GC Roots间接引用的对象。\n\n\t\t\t\t\t- 重新标记\n\n\t\t\t\t\t  STW。\n\t\t\t\t\t  重新标记并发标记时产生的新对象。\n\n\t\t\t\t\t- 并发清除\n\n\t\t\t\t\t  清理标记的对象。\n\n\t\t\t\t- 缺点\n\n\t\t\t\t  默认启动垃圾回收线程：（CPU核数 +3）/4。\n\t\t\t\t  本身会消耗CPU资源。\n\t\t\t\t  针对浮动垃圾，初始标记后产生的垃圾没法回收。\n\t\t\t\t  CMS回收期间，新生代进入老年代对象大于可用空间时，会发生Concurrent Mode Failure ，并自动使用Serial Old回收器替代CMS工作。\n\n\t\t- G1\n\n\t\t  基于复制算法。\n\t\t  把Java堆内存划分为多个大小相等的Region。\n\t\t  可以设置STW的时间，追踪每个Region里可回收对象的预估时间。\n\t\t  G1中的分代是逻辑上的分代，同一个Region会随着分配的内存对象不同，而属于不同分代。\n\t\t  每个Region的大小：堆大小/2048。\n\t\t  新生代的Region同时分Eden和Survivor，可通过-XX:SurvivorRatio调整占比。\n\t\t  适合大内存的机器，G1可以设置停顿时间，来确保对服务不会有较大的影响。\n\n\t\t\t- 大对象\n\n\t\t\t  超多Region大小50%即为大对象。\n\t\t\t  大对象可能横跨多个Region。\n\t\t\t  空的Region都可以存放大对象。\n\t\t\t  新老生代GC时都会回收大对象。\n\n\t\t\t- 回收过程\n\n\t\t\t\t- 初始标记\n\n\t\t\t\t  STW。\n\t\t\t\t  标记所有GC Roots直接引用的对象，被直接引用的对象所引用的对象不会被标记。\n\n\t\t\t\t- 并发标记\n\n\t\t\t\t  进行GC Roots的追踪，追踪所有存活对象。\n\t\t\t\t  同时JVM会记录该阶段中新建或失去引用的对象。\n\n\t\t\t\t- 最终标记\n\n\t\t\t\t  STW。\n\t\t\t\t  通过多并发标记中JVM堆新增或失去引用的对象，进行重新标记。\n\n\t\t\t\t- 混合回收\n\n\t\t\t\t  分析Region大小，执行效率。\n\t\t\t\t  STW。\n\t\t\t\t  在指定时间内进行回收。\n\n\t\t\t- 问题\n\n\t\t\t  回收中发现Region空间不够时，将会SWT，并单线程进行标记、清除、整理，效率很低。\n\n\t- CG触发时间\n\n\t\t- Minor GC\n\n\t\t  Eden区满时采用复制算法。\n\n\t\t- Old GC\n\n\t\t  1.老年代连续可用空间 < 新生代历次GC后升入老年代对象内存和的平均大小。\n\t\t  2.老年代不够存放，Minor GC后升入老年代的对象时。\n\t\t  3.老年代内存使用率超过92%时（可设置）。\n\n\t\t- 永久代GC\n\n\t\t  永久代不够使产生Full GC。\n\n### 本地方法栈\n\n存放native方法。\n\n### 堆外内存空间\n\n通过调用操作系统接口，直接分配对外内存空间。\nNIO->allocateDirect(DirectByteBuffer)\n\n## 工具\n\n### jstat\n\n通过jps查找java进程，再用jstat -gc PID查看GC状况。\n\n- 指标\n\n\t- S0C\n\n\t  From Survivor区大小\n\n\t- S1C\n\n\t  To Survivor区大小\n\n\t- S0U\n\n\t  From Survivor区当前使用大小\n\n\t- S1U\n\n\t  To Survivor区当前使用大小\n\n\t- EC\n\n\t  Eden区大小\n\n\t- EU\n\n\t  Eden区当前使用的大小\n\n\t- OC\n\n\t  老年代的大小\n\n\t- OU\n\n\t  老年代当前使用的大小\n\n\t- MC\n\n\t  方法区（永久代、元空间）的大小\n\n\t- MU\n\n\t  方法区（永久代、元空间）当前使用的大小\n\n\t- YGC\n\n\t  系统迄今为止Young GC的次数\n\n\t- YGCT\n\n\t  Young GC耗时\n\n\t- FGC\n\n\t  系统迄今为止Full GC的次数\n\n\t- FGCT\n\n\t  Full GC的耗时\n\n\t- GCT\n\n\t  所有GC的总耗时\n\n- 命令\n\n\t- jstat -gc PID\n\n\t  查看GC状况\n\n\t- jstat -gccapacity PID\n\n\t  堆内存分析\n\n\t- jstat -gcnew PID\n\n\t  新生代分析\n\n\t- jstat -gcnewcapacity PID\n\n\t  年轻代内存分析\n\n\t- jstat -gcold PID\n\n\t  老年代GC分析\n\n\t- jstat -gcoldcapacity PID\n\n\t  老年代内存分析\n\n\t- jstat -gcmetacapacity PID\n\n\t  元数据内存分析\n\n### jmap\n\n了解运行时的内存区域\n\n- 命令\n\n\t- jmap -heap PID\n\n\t  打印堆内存相关参数设置。\n\t  当前堆内各个区的基本情况。\n\n\t- jmap -histo PID\n\n\t  按照对象在内存中占用大小排序，降序。\n\t  可以了解哪个对象在堆中占用了大量的空间。\n\n\t- jmap -dump:live,format=b,file=dump.hprof PID\n\n\t  生成内存快照并输出到文件。\n\n### jhat\n\n分析堆内存快照，可以使用工具内置的浏览器查看。\n\n- 命令\n\n\t- jhat dump.hprof -port 7000\n\n\t  分析快照文件dump.hprof ，访问端口7000。\n\n### MAT\n\n内存分析工具\n\n## JVM优化总结\n\n### 调整新生代的大小\n\n尽量让每次Young GC后的存活对象⼩于Survivor区域的50%，都留存在年轻代⾥。尽量别让对象进 ⼊⽼年代。尽量减少Full GC的频率，避免频繁Full GC对JVM性能的影响\n\n### 调整老年代碎片回收的频率\n\nCMS一次Full GC会产生内存随便，调整碎片整理的触发轮数，可以有效的降低Full  GC产生的碎片从而降低Full GC的频次。\n\n### JVM参数模板\n\n-Xms4096M -Xmx4096M -Xmn3072M -Xss1M -XX:MetaspaceSize=256M -XX:MaxMetaspaceSize=256M -XX:+UseParNewGC - XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFaction=92 -XX:+UseCMSCompactAtFullCollection - XX:CMSFullGCsBeforeCompaction=0 -XX:+CMSParallelInitialMarkEnabled -XX:+CMSScavengeBeforeRemark - XX:+DisableExplicitGC -XX:+PrintGCDetails -Xloggc:gc.log -XX:+HeapDumpOnOutOfMemoryError - XX:HeapDumpPath=/usr/local/app/oom\n\n### -XX:SoftRefLRUPolicyMSPerMB\n\n在有大量反射的情况下建议增大该值，保证软引用不会被马上回收\n\n### -XX:+DisableExplicitGC\n\n禁止显示执行GC\n性质System.gc()\n\n### 使用缓存淘汰机制\n\n避免本地缓存无限增大，使得老年代常驻对象无法回收，从而导致的内存溢出和频繁的Full GC。\n\n### 频繁Full GC的可能原因\n\n1.系统压力大，频繁Young GC后存活对象大于Survivor区，导致直接进入老年代。\n2.频繁产生大对象。\n3.对象始终不释放，导致内存泄漏。\n4.方法区频繁有类反射加载。\n5.错误使用System.gc()。\n\n*XMind: ZEN - Trial Version*","source":"_posts/JVM-整理.md","raw":"---\ntitle: JVM 整理\ndate: 2020-02-22 15:03:19\ntags: \n    - JVM\n    - Java\ncategories :\n    - Technology\n---\n\n# JVM 相关知识整理\n1. 内存分配\n2. 垃圾回收器的参数配置\n\n## 类的加载\n<!-- more -->\n加载->验证->准备->解析->初始化->使用->卸载\n\n### 加载流程\n\n- 加载\n\n  代码中使用到这个类的时候，.class字节码文件就会加载这个类到JVM内存中。\n\n- 链接\n\n\t- 验证\n\n\t  根据JVM规范，校验.class文件。\n\n\t- 准备\n\n\t  给加载的类分配内存空间，同时给类的static变量分配内存空间，并设置默认值0。\n\t  clint()\n\n\t- 解析\n\n\t  把符号引用替换为直接引用。\n\n- 初始化\n\n  为类变量赋值：静态方法，静态变量，静态块。\n  初始化一个类的时候，如果发现有父类还没初始化，会先初始化他的父类。\n\n### 类加载器\n\n- 加载器\n\n\t- BootStrap ClassLoader\n\n\t  加载lib目录下的类库\n\n\t- Extension ClassLoader\n\n\t  加载lib\\ext目录下的类库\n\n\t- Application ClassLoader\n\n\t  加载ClassPath下的类\n\n\t- 自定义加载器\n\n- 双亲委派机制\n\n  先找父亲加载，加载不了再找儿子加载\n\n## 内存结构\n\n### 方法区、元空间、永久代\n\n存放类的定义，常量池等。\nmatespace满后会触发Full GC。\n方法区垃圾回收：\n1.该类的所有实例已经被回收\n2.加载该类的ClassLoader已经被回收\n3.该类的Class对象没有被任何引用\n\n### 程序技术器\n\n记录当前执行的字节码指令的位置。\n线程私有。\n\n### Java虚拟机栈\n\n保存方法信息。\n线程私有。\n\n- 栈帧\n\n\t- 局部变量表\n\t- 操作数栈\n\t- 动态链接\n\t- 方法返回地址\n\t- 其他\n\n### Java堆内存\n\n存放类的实例对象。\n\n- 分代\n\n\t- 年轻代\n\n\t  新生代进入老年代：默认15次\n\n\t\t- Eden区\n\n\t\t  默认新生代80%空间。\n\t\t  新建对象产生在Eden区。\n\t\t  Eden区满后会发生Minor GC。\n\n\t\t- Survivor0,1区\n\n\t\t  默认年轻代20%。Survivor 0:10%  Survivor 1:10%。\n\t\t  默认对象幸存15次后，会进入老年区。\n\n\t\t\t- 动态年龄判断\n\n\t\t\t  当一批对象的大小大于Survivor区大小的50%，这批对象将不询问年龄，直接进入老年代。\n\n\t- 老年代\n\n\t\t- 进入老年代的规则\n\n\t\t\t- 年龄超过MaxTenuring\n\t\t\t- 动态年龄判断\n\t\t\t- 超过PretenureSize的大对象\n\t\t\t- Eden区幸存对象超过Survivor区大小\n\n- JVM参数\n\n\t- -Xms\n\n\t  Java堆内存的大小\n\n\t- -Xmx\n\n\t  Java堆内存的最大大小\n\n\t- -Xmn\n\n\t  Java对内存中的新生代大小。\n\t  老年代=总大小-新生代\n\n\t- -XX:PermSize\n\n\t  永久代大小\n\n\t- -XX:MaxPermSize\n\n\t  永久代最大大小\n\n\t- -XX:MetaspaceSize\n\n\t  元空间大小\n\n\t- -XX:MaxMetaspaceSize\n\n\t  元空间最大大小\n\n\t- -Xss\n\n\t  Java栈内存大小\n\n\t- -XX:MaxTenuringThreshold\n\n\t  对象在年轻代中幸存的最大轮数。\n\t  默认15，且不能超过15.\n\n\t- -XX:PretenureSizeThreshold\n\n\t  当对象大小超过该值时，对象直接进入老年代，不会进过年轻代。\n\t  避免大对象在Survivor中多次复制，减少无谓的操作。\n\n\t- -XX:-HandlePromotionFailure\n\n\t  判断老年代内存大小是否大于之前每一次Minor GC后进入老年代的对象的平均大小。\n\t  判断失败进行Full GC，再执行Minor GC。\n\n\t- -XX:SurvivorRatio\n\n\t  调整Eden区和Survivor区内存比率\n\t  - XX:SurvivorRatio=8  ： Eden 80%\n\n\t- -XX:+PrintGCDetils\n\n\t  打印详细的GC日志。\n\n\t- -XX:+PrintGCTimeStamps\n\n\t  打印GC发生的时间。\n\n\t- -Xloggc:gc.log\n\n\t  将CG日志输入到文件。\n\n\t- -XX:TraceClassLoading\n\n\t  追踪加载的类\n\n\t- -XX:TraceClassUnloading\n\n\t  追踪卸载的类\n\n\t- -XX:+HeapDumpOnOutOfMemoryError  \n\n\t  OOM时自动dump快照\n\n\t- -XX:HeapDumpPath=/usr/local/app/oom\n\n\t  将快照存放至指定目录\n\n\t- CMS\n\n\t\t- -XX:CMSInitiatingOccupancyFaction\n\n\t\t  设置老年代占用多少比例时触发CMS\n\n\t\t- -XX:+UseCMSCompactAtFullCollection\n\n\t\t  Full GC后STW，整理内存碎片。\n\n\t\t- -XX:CMSFullGCsBeforeCompaction\n\n\t\t  默认0，设置多少次Full GC后进行内存碎片整理。\n\n\t\t- -XX:+CMSParallelInitialMarkEnabled\n\n\t\t  初始标记阶段开启并发执行\n\n\t- G1\n\n\t\t- -XX:+UseG1GC\n\n\t\t  指定G1垃圾回收器。\n\n\t\t- -XX:G1HeapRegionSize\n\n\t\t  手动指定G1的Region的大小。\n\n\t\t- -XX:G1NewSizePercent\n\n\t\t  调整新生代在堆中的占比。\n\t\t  默认5%。\n\n\t\t- -XX:G1MaxNewSizePercent\n\n\t\t  新生代占比堆空间的最大大小。\n\n\t\t- -XX:MaxGCPauseMills\n\n\t\t  默认200ms。\n\t\t  设置G1垃圾回收器GC时的最大停顿时间。\n\n\t\t- -XX:InitiatingHeapOccupancyPercent\n\n\t\t  默认45%。\n\t\t  老年代占据的堆内存超多该值，将会进行新老生代的混合回收。\n\n\t\t- -XX:G1MixedGCCountTarget\n\n\t\t  一次G1混合回收过程中，最后阶段混合回收阶段分几次完成。\n\t\t  默认8。\n\n\t\t- -XX:G1HeapWastePercent\n\n\t\t  默认值5%。\n\t\t  混合回收阶段中，空间Region占比堆空间超多该值，会停止混合回收。\n\n\t\t- -XX:G1MixedGCLiveThresholdPercent\n\n\t\t  默认值85%。\n\t\t  一个Region中的存活对象低于该值时才会被回收。\n\n\t\t- -XX:+CMSScavengeBeforeRemark\n\n\t\t  重新标记前，尽量执行一次Young GC。\n\t\t  提前回收年轻代没有引用的对象，减少重新标记扫描的对象数，提高效率。\n\n- 垃圾回收\n\n\t- 可达性分析\n\n\t  对一个对象层层向上分析，判断是否有一个GC Root。\n\n\t\t- GC Root\n\n\t\t\t- 本地变量表中的局部变量\n\t\t\t- 方法区内的静态变量\n\n\t- java 引用类型\n\n\t\t- 强引用\n\n\t\t  GC不会回收强引用\n\n\t\t- 软引用\n\n\t\t  内存空间足够时，GC不会回收软引用\n\n\t\t- 弱引用\n\n\t\t  GC时必定回收弱引用\n\n\t\t- 虚引用\n\n\t\t  继承Object的finalize()方法，在该对象被回收的时候通知自己。\n\n\t- 垃圾回收算法\n\n\t\t- 年轻代\n\n\t\t\t- 复制\n\n\t\t\t  在新生代幸存者0,1区使用。将标记为可用的内存复制到另外一片连续的内存区域中，并删除当前内存区域中的全部数据。\n\n\t\t\t\t- 优点\n\n\t\t\t\t  不会产生内存碎片\n\n\t\t\t\t- 缺点\n\n\t\t\t\t  增加内存的消耗\n\n\t\t- 老年代\n\n\t\t\t- 标记整理\n\n\t\t\t  标记存活对象，删除死亡对象，整理内存碎片。\n\n\t\t\t\t- 优点\n\n\t\t\t\t  不会产生内存碎片。内存利用率高。\n\n\t\t\t\t- 缺点\n\n\t\t\t\t  比起标记清楚，执行效率慢。\n\n\t- JVM垃圾回收器\n\n\t\t- 年轻代\n\n\t\t\t- ParNew\n\n\t\t\t  多线程，复制算法。\n\t\t\t  开启：-XX:+UseParNewGC\n\t\t\t  调整回收线程数：-XX:ParallelGCThreads\n\n\t\t- 老年代\n\n\t\t\t- CMS\n\n\t\t\t  标记清理算法\n\n\t\t\t\t- 回收过程\n\n\t\t\t\t\t- 初始标记\n\n\t\t\t\t\t  STW。\n\t\t\t\t\t  标记所有GC Roots直接引用的对象，被直接引用的对象所引用的对象不会被标记。\n\n\t\t\t\t\t- 并发标记\n\n\t\t\t\t\t  寻找被GC Roots间接引用的对象。\n\n\t\t\t\t\t- 重新标记\n\n\t\t\t\t\t  STW。\n\t\t\t\t\t  重新标记并发标记时产生的新对象。\n\n\t\t\t\t\t- 并发清除\n\n\t\t\t\t\t  清理标记的对象。\n\n\t\t\t\t- 缺点\n\n\t\t\t\t  默认启动垃圾回收线程：（CPU核数 +3）/4。\n\t\t\t\t  本身会消耗CPU资源。\n\t\t\t\t  针对浮动垃圾，初始标记后产生的垃圾没法回收。\n\t\t\t\t  CMS回收期间，新生代进入老年代对象大于可用空间时，会发生Concurrent Mode Failure ，并自动使用Serial Old回收器替代CMS工作。\n\n\t\t- G1\n\n\t\t  基于复制算法。\n\t\t  把Java堆内存划分为多个大小相等的Region。\n\t\t  可以设置STW的时间，追踪每个Region里可回收对象的预估时间。\n\t\t  G1中的分代是逻辑上的分代，同一个Region会随着分配的内存对象不同，而属于不同分代。\n\t\t  每个Region的大小：堆大小/2048。\n\t\t  新生代的Region同时分Eden和Survivor，可通过-XX:SurvivorRatio调整占比。\n\t\t  适合大内存的机器，G1可以设置停顿时间，来确保对服务不会有较大的影响。\n\n\t\t\t- 大对象\n\n\t\t\t  超多Region大小50%即为大对象。\n\t\t\t  大对象可能横跨多个Region。\n\t\t\t  空的Region都可以存放大对象。\n\t\t\t  新老生代GC时都会回收大对象。\n\n\t\t\t- 回收过程\n\n\t\t\t\t- 初始标记\n\n\t\t\t\t  STW。\n\t\t\t\t  标记所有GC Roots直接引用的对象，被直接引用的对象所引用的对象不会被标记。\n\n\t\t\t\t- 并发标记\n\n\t\t\t\t  进行GC Roots的追踪，追踪所有存活对象。\n\t\t\t\t  同时JVM会记录该阶段中新建或失去引用的对象。\n\n\t\t\t\t- 最终标记\n\n\t\t\t\t  STW。\n\t\t\t\t  通过多并发标记中JVM堆新增或失去引用的对象，进行重新标记。\n\n\t\t\t\t- 混合回收\n\n\t\t\t\t  分析Region大小，执行效率。\n\t\t\t\t  STW。\n\t\t\t\t  在指定时间内进行回收。\n\n\t\t\t- 问题\n\n\t\t\t  回收中发现Region空间不够时，将会SWT，并单线程进行标记、清除、整理，效率很低。\n\n\t- CG触发时间\n\n\t\t- Minor GC\n\n\t\t  Eden区满时采用复制算法。\n\n\t\t- Old GC\n\n\t\t  1.老年代连续可用空间 < 新生代历次GC后升入老年代对象内存和的平均大小。\n\t\t  2.老年代不够存放，Minor GC后升入老年代的对象时。\n\t\t  3.老年代内存使用率超过92%时（可设置）。\n\n\t\t- 永久代GC\n\n\t\t  永久代不够使产生Full GC。\n\n### 本地方法栈\n\n存放native方法。\n\n### 堆外内存空间\n\n通过调用操作系统接口，直接分配对外内存空间。\nNIO->allocateDirect(DirectByteBuffer)\n\n## 工具\n\n### jstat\n\n通过jps查找java进程，再用jstat -gc PID查看GC状况。\n\n- 指标\n\n\t- S0C\n\n\t  From Survivor区大小\n\n\t- S1C\n\n\t  To Survivor区大小\n\n\t- S0U\n\n\t  From Survivor区当前使用大小\n\n\t- S1U\n\n\t  To Survivor区当前使用大小\n\n\t- EC\n\n\t  Eden区大小\n\n\t- EU\n\n\t  Eden区当前使用的大小\n\n\t- OC\n\n\t  老年代的大小\n\n\t- OU\n\n\t  老年代当前使用的大小\n\n\t- MC\n\n\t  方法区（永久代、元空间）的大小\n\n\t- MU\n\n\t  方法区（永久代、元空间）当前使用的大小\n\n\t- YGC\n\n\t  系统迄今为止Young GC的次数\n\n\t- YGCT\n\n\t  Young GC耗时\n\n\t- FGC\n\n\t  系统迄今为止Full GC的次数\n\n\t- FGCT\n\n\t  Full GC的耗时\n\n\t- GCT\n\n\t  所有GC的总耗时\n\n- 命令\n\n\t- jstat -gc PID\n\n\t  查看GC状况\n\n\t- jstat -gccapacity PID\n\n\t  堆内存分析\n\n\t- jstat -gcnew PID\n\n\t  新生代分析\n\n\t- jstat -gcnewcapacity PID\n\n\t  年轻代内存分析\n\n\t- jstat -gcold PID\n\n\t  老年代GC分析\n\n\t- jstat -gcoldcapacity PID\n\n\t  老年代内存分析\n\n\t- jstat -gcmetacapacity PID\n\n\t  元数据内存分析\n\n### jmap\n\n了解运行时的内存区域\n\n- 命令\n\n\t- jmap -heap PID\n\n\t  打印堆内存相关参数设置。\n\t  当前堆内各个区的基本情况。\n\n\t- jmap -histo PID\n\n\t  按照对象在内存中占用大小排序，降序。\n\t  可以了解哪个对象在堆中占用了大量的空间。\n\n\t- jmap -dump:live,format=b,file=dump.hprof PID\n\n\t  生成内存快照并输出到文件。\n\n### jhat\n\n分析堆内存快照，可以使用工具内置的浏览器查看。\n\n- 命令\n\n\t- jhat dump.hprof -port 7000\n\n\t  分析快照文件dump.hprof ，访问端口7000。\n\n### MAT\n\n内存分析工具\n\n## JVM优化总结\n\n### 调整新生代的大小\n\n尽量让每次Young GC后的存活对象⼩于Survivor区域的50%，都留存在年轻代⾥。尽量别让对象进 ⼊⽼年代。尽量减少Full GC的频率，避免频繁Full GC对JVM性能的影响\n\n### 调整老年代碎片回收的频率\n\nCMS一次Full GC会产生内存随便，调整碎片整理的触发轮数，可以有效的降低Full  GC产生的碎片从而降低Full GC的频次。\n\n### JVM参数模板\n\n-Xms4096M -Xmx4096M -Xmn3072M -Xss1M -XX:MetaspaceSize=256M -XX:MaxMetaspaceSize=256M -XX:+UseParNewGC - XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFaction=92 -XX:+UseCMSCompactAtFullCollection - XX:CMSFullGCsBeforeCompaction=0 -XX:+CMSParallelInitialMarkEnabled -XX:+CMSScavengeBeforeRemark - XX:+DisableExplicitGC -XX:+PrintGCDetails -Xloggc:gc.log -XX:+HeapDumpOnOutOfMemoryError - XX:HeapDumpPath=/usr/local/app/oom\n\n### -XX:SoftRefLRUPolicyMSPerMB\n\n在有大量反射的情况下建议增大该值，保证软引用不会被马上回收\n\n### -XX:+DisableExplicitGC\n\n禁止显示执行GC\n性质System.gc()\n\n### 使用缓存淘汰机制\n\n避免本地缓存无限增大，使得老年代常驻对象无法回收，从而导致的内存溢出和频繁的Full GC。\n\n### 频繁Full GC的可能原因\n\n1.系统压力大，频繁Young GC后存活对象大于Survivor区，导致直接进入老年代。\n2.频繁产生大对象。\n3.对象始终不释放，导致内存泄漏。\n4.方法区频繁有类反射加载。\n5.错误使用System.gc()。\n\n*XMind: ZEN - Trial Version*","slug":"JVM-整理","published":1,"updated":"2020-12-14T09:51:24.008Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71ht20007v252axr85fg5","content":"<html><head></head><body><h1 id=\"JVM-&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x6574;&#x7406;\"><a href=\"#JVM-&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x6574;&#x7406;\" class=\"headerlink\" title=\"JVM &#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x6574;&#x7406;\"></a>JVM &#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x6574;&#x7406;</h1><ol>\n<li>&#x5185;&#x5B58;&#x5206;&#x914D;</li>\n<li>&#x5783;&#x573E;&#x56DE;&#x6536;&#x5668;&#x7684;&#x53C2;&#x6570;&#x914D;&#x7F6E;</li>\n</ol>\n<h2 id=\"&#x7C7B;&#x7684;&#x52A0;&#x8F7D;\"><a href=\"#&#x7C7B;&#x7684;&#x52A0;&#x8F7D;\" class=\"headerlink\" title=\"&#x7C7B;&#x7684;&#x52A0;&#x8F7D;\"></a>&#x7C7B;&#x7684;&#x52A0;&#x8F7D;</h2><a id=\"more\"></a>\n<p>&#x52A0;&#x8F7D;-&gt;&#x9A8C;&#x8BC1;-&gt;&#x51C6;&#x5907;-&gt;&#x89E3;&#x6790;-&gt;&#x521D;&#x59CB;&#x5316;-&gt;&#x4F7F;&#x7528;-&gt;&#x5378;&#x8F7D;</p>\n<h3 id=\"&#x52A0;&#x8F7D;&#x6D41;&#x7A0B;\"><a href=\"#&#x52A0;&#x8F7D;&#x6D41;&#x7A0B;\" class=\"headerlink\" title=\"&#x52A0;&#x8F7D;&#x6D41;&#x7A0B;\"></a>&#x52A0;&#x8F7D;&#x6D41;&#x7A0B;</h3><ul>\n<li><p>&#x52A0;&#x8F7D;</p>\n<p>&#x4EE3;&#x7801;&#x4E2D;&#x4F7F;&#x7528;&#x5230;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x65F6;&#x5019;&#xFF0C;.class&#x5B57;&#x8282;&#x7801;&#x6587;&#x4EF6;&#x5C31;&#x4F1A;&#x52A0;&#x8F7D;&#x8FD9;&#x4E2A;&#x7C7B;&#x5230;JVM&#x5185;&#x5B58;&#x4E2D;&#x3002;</p>\n</li>\n<li><p>&#x94FE;&#x63A5;</p>\n<ul>\n<li><p>&#x9A8C;&#x8BC1;</p>\n<p>&#x6839;&#x636E;JVM&#x89C4;&#x8303;&#xFF0C;&#x6821;&#x9A8C;.class&#x6587;&#x4EF6;&#x3002;</p>\n</li>\n<li><p>&#x51C6;&#x5907;</p>\n<p>&#x7ED9;&#x52A0;&#x8F7D;&#x7684;&#x7C7B;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x540C;&#x65F6;&#x7ED9;&#x7C7B;&#x7684;static&#x53D8;&#x91CF;&#x5206;&#x914D;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;&#x9ED8;&#x8BA4;&#x503C;0&#x3002;<br>clint()</p>\n</li>\n<li><p>&#x89E3;&#x6790;</p>\n<p>&#x628A;&#x7B26;&#x53F7;&#x5F15;&#x7528;&#x66FF;&#x6362;&#x4E3A;&#x76F4;&#x63A5;&#x5F15;&#x7528;&#x3002;</p>\n</li>\n</ul>\n</li>\n<li><p>&#x521D;&#x59CB;&#x5316;</p>\n<p>&#x4E3A;&#x7C7B;&#x53D8;&#x91CF;&#x8D4B;&#x503C;&#xFF1A;&#x9759;&#x6001;&#x65B9;&#x6CD5;&#xFF0C;&#x9759;&#x6001;&#x53D8;&#x91CF;&#xFF0C;&#x9759;&#x6001;&#x5757;&#x3002;<br>&#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;&#x7C7B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5982;&#x679C;&#x53D1;&#x73B0;&#x6709;&#x7236;&#x7C7B;&#x8FD8;&#x6CA1;&#x521D;&#x59CB;&#x5316;&#xFF0C;&#x4F1A;&#x5148;&#x521D;&#x59CB;&#x5316;&#x4ED6;&#x7684;&#x7236;&#x7C7B;&#x3002;</p>\n</li>\n</ul>\n<h3 id=\"&#x7C7B;&#x52A0;&#x8F7D;&#x5668;\"><a href=\"#&#x7C7B;&#x52A0;&#x8F7D;&#x5668;\" class=\"headerlink\" title=\"&#x7C7B;&#x52A0;&#x8F7D;&#x5668;\"></a>&#x7C7B;&#x52A0;&#x8F7D;&#x5668;</h3><ul>\n<li><p>&#x52A0;&#x8F7D;&#x5668;</p>\n<ul>\n<li><p>BootStrap ClassLoader</p>\n<p>&#x52A0;&#x8F7D;lib&#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x7C7B;&#x5E93;</p>\n</li>\n<li><p>Extension ClassLoader</p>\n<p>&#x52A0;&#x8F7D;lib\\ext&#x76EE;&#x5F55;&#x4E0B;&#x7684;&#x7C7B;&#x5E93;</p>\n</li>\n<li><p>Application ClassLoader</p>\n<p>&#x52A0;&#x8F7D;ClassPath&#x4E0B;&#x7684;&#x7C7B;</p>\n</li>\n<li><p>&#x81EA;&#x5B9A;&#x4E49;&#x52A0;&#x8F7D;&#x5668;</p>\n</li>\n</ul>\n</li>\n<li><p>&#x53CC;&#x4EB2;&#x59D4;&#x6D3E;&#x673A;&#x5236;</p>\n<p>&#x5148;&#x627E;&#x7236;&#x4EB2;&#x52A0;&#x8F7D;&#xFF0C;&#x52A0;&#x8F7D;&#x4E0D;&#x4E86;&#x518D;&#x627E;&#x513F;&#x5B50;&#x52A0;&#x8F7D;</p>\n</li>\n</ul>\n<h2 id=\"&#x5185;&#x5B58;&#x7ED3;&#x6784;\"><a href=\"#&#x5185;&#x5B58;&#x7ED3;&#x6784;\" class=\"headerlink\" title=\"&#x5185;&#x5B58;&#x7ED3;&#x6784;\"></a>&#x5185;&#x5B58;&#x7ED3;&#x6784;</h2><h3 id=\"&#x65B9;&#x6CD5;&#x533A;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#x3001;&#x6C38;&#x4E45;&#x4EE3;\"><a href=\"#&#x65B9;&#x6CD5;&#x533A;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#x3001;&#x6C38;&#x4E45;&#x4EE3;\" class=\"headerlink\" title=\"&#x65B9;&#x6CD5;&#x533A;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#x3001;&#x6C38;&#x4E45;&#x4EE3;\"></a>&#x65B9;&#x6CD5;&#x533A;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#x3001;&#x6C38;&#x4E45;&#x4EE3;</h3><p>&#x5B58;&#x653E;&#x7C7B;&#x7684;&#x5B9A;&#x4E49;&#xFF0C;&#x5E38;&#x91CF;&#x6C60;&#x7B49;&#x3002;<br>matespace&#x6EE1;&#x540E;&#x4F1A;&#x89E6;&#x53D1;Full GC&#x3002;<br>&#x65B9;&#x6CD5;&#x533A;&#x5783;&#x573E;&#x56DE;&#x6536;&#xFF1A;<br>1.&#x8BE5;&#x7C7B;&#x7684;&#x6240;&#x6709;&#x5B9E;&#x4F8B;&#x5DF2;&#x7ECF;&#x88AB;&#x56DE;&#x6536;<br>2.&#x52A0;&#x8F7D;&#x8BE5;&#x7C7B;&#x7684;ClassLoader&#x5DF2;&#x7ECF;&#x88AB;&#x56DE;&#x6536;<br>3.&#x8BE5;&#x7C7B;&#x7684;Class&#x5BF9;&#x8C61;&#x6CA1;&#x6709;&#x88AB;&#x4EFB;&#x4F55;&#x5F15;&#x7528;</p>\n<h3 id=\"&#x7A0B;&#x5E8F;&#x6280;&#x672F;&#x5668;\"><a href=\"#&#x7A0B;&#x5E8F;&#x6280;&#x672F;&#x5668;\" class=\"headerlink\" title=\"&#x7A0B;&#x5E8F;&#x6280;&#x672F;&#x5668;\"></a>&#x7A0B;&#x5E8F;&#x6280;&#x672F;&#x5668;</h3><p>&#x8BB0;&#x5F55;&#x5F53;&#x524D;&#x6267;&#x884C;&#x7684;&#x5B57;&#x8282;&#x7801;&#x6307;&#x4EE4;&#x7684;&#x4F4D;&#x7F6E;&#x3002;<br>&#x7EBF;&#x7A0B;&#x79C1;&#x6709;&#x3002;</p>\n<h3 id=\"Java&#x865A;&#x62DF;&#x673A;&#x6808;\"><a href=\"#Java&#x865A;&#x62DF;&#x673A;&#x6808;\" class=\"headerlink\" title=\"Java&#x865A;&#x62DF;&#x673A;&#x6808;\"></a>Java&#x865A;&#x62DF;&#x673A;&#x6808;</h3><p>&#x4FDD;&#x5B58;&#x65B9;&#x6CD5;&#x4FE1;&#x606F;&#x3002;<br>&#x7EBF;&#x7A0B;&#x79C1;&#x6709;&#x3002;</p>\n<ul>\n<li><p>&#x6808;&#x5E27;</p>\n<ul>\n<li>&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;</li>\n<li>&#x64CD;&#x4F5C;&#x6570;&#x6808;</li>\n<li>&#x52A8;&#x6001;&#x94FE;&#x63A5;</li>\n<li>&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x5730;&#x5740;</li>\n<li>&#x5176;&#x4ED6;</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Java&#x5806;&#x5185;&#x5B58;\"><a href=\"#Java&#x5806;&#x5185;&#x5B58;\" class=\"headerlink\" title=\"Java&#x5806;&#x5185;&#x5B58;\"></a>Java&#x5806;&#x5185;&#x5B58;</h3><p>&#x5B58;&#x653E;&#x7C7B;&#x7684;&#x5B9E;&#x4F8B;&#x5BF9;&#x8C61;&#x3002;</p>\n<ul>\n<li><p>&#x5206;&#x4EE3;</p>\n<ul>\n<li><p>&#x5E74;&#x8F7B;&#x4EE3;</p>\n<p>&#x65B0;&#x751F;&#x4EE3;&#x8FDB;&#x5165;&#x8001;&#x5E74;&#x4EE3;&#xFF1A;&#x9ED8;&#x8BA4;15&#x6B21;</p>\n<ul>\n<li><p>Eden&#x533A;</p>\n<p>&#x9ED8;&#x8BA4;&#x65B0;&#x751F;&#x4EE3;80%&#x7A7A;&#x95F4;&#x3002;<br>&#x65B0;&#x5EFA;&#x5BF9;&#x8C61;&#x4EA7;&#x751F;&#x5728;Eden&#x533A;&#x3002;<br>Eden&#x533A;&#x6EE1;&#x540E;&#x4F1A;&#x53D1;&#x751F;Minor GC&#x3002;</p>\n</li>\n<li><p>Survivor0,1&#x533A;</p>\n<p>&#x9ED8;&#x8BA4;&#x5E74;&#x8F7B;&#x4EE3;20%&#x3002;Survivor 0:10%  Survivor 1:10%&#x3002;<br>&#x9ED8;&#x8BA4;&#x5BF9;&#x8C61;&#x5E78;&#x5B58;15&#x6B21;&#x540E;&#xFF0C;&#x4F1A;&#x8FDB;&#x5165;&#x8001;&#x5E74;&#x533A;&#x3002;</p>\n<ul>\n<li><p>&#x52A8;&#x6001;&#x5E74;&#x9F84;&#x5224;&#x65AD;</p>\n<p>&#x5F53;&#x4E00;&#x6279;&#x5BF9;&#x8C61;&#x7684;&#x5927;&#x5C0F;&#x5927;&#x4E8E;Survivor&#x533A;&#x5927;&#x5C0F;&#x7684;50%&#xFF0C;&#x8FD9;&#x6279;&#x5BF9;&#x8C61;&#x5C06;&#x4E0D;&#x8BE2;&#x95EE;&#x5E74;&#x9F84;&#xFF0C;&#x76F4;&#x63A5;&#x8FDB;&#x5165;&#x8001;&#x5E74;&#x4EE3;&#x3002;</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>&#x8001;&#x5E74;&#x4EE3;</p>\n<ul>\n<li><p>&#x8FDB;&#x5165;&#x8001;&#x5E74;&#x4EE3;&#x7684;&#x89C4;&#x5219;</p>\n<ul>\n<li>&#x5E74;&#x9F84;&#x8D85;&#x8FC7;MaxTenuring</li>\n<li>&#x52A8;&#x6001;&#x5E74;&#x9F84;&#x5224;&#x65AD;</li>\n<li>&#x8D85;&#x8FC7;PretenureSize&#x7684;&#x5927;&#x5BF9;&#x8C61;</li>\n<li>Eden&#x533A;&#x5E78;&#x5B58;&#x5BF9;&#x8C61;&#x8D85;&#x8FC7;Survivor&#x533A;&#x5927;&#x5C0F;</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>JVM&#x53C2;&#x6570;</p>\n<ul>\n<li><p>-Xms</p>\n<p>Java&#x5806;&#x5185;&#x5B58;&#x7684;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>-Xmx</p>\n<p>Java&#x5806;&#x5185;&#x5B58;&#x7684;&#x6700;&#x5927;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>-Xmn</p>\n<p>Java&#x5BF9;&#x5185;&#x5B58;&#x4E2D;&#x7684;&#x65B0;&#x751F;&#x4EE3;&#x5927;&#x5C0F;&#x3002;<br>&#x8001;&#x5E74;&#x4EE3;=&#x603B;&#x5927;&#x5C0F;-&#x65B0;&#x751F;&#x4EE3;</p>\n</li>\n<li><p>-XX:PermSize</p>\n<p>&#x6C38;&#x4E45;&#x4EE3;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>-XX:MaxPermSize</p>\n<p>&#x6C38;&#x4E45;&#x4EE3;&#x6700;&#x5927;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>-XX:MetaspaceSize</p>\n<p>&#x5143;&#x7A7A;&#x95F4;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>-XX:MaxMetaspaceSize</p>\n<p>&#x5143;&#x7A7A;&#x95F4;&#x6700;&#x5927;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>-Xss</p>\n<p>Java&#x6808;&#x5185;&#x5B58;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>-XX:MaxTenuringThreshold</p>\n<p>&#x5BF9;&#x8C61;&#x5728;&#x5E74;&#x8F7B;&#x4EE3;&#x4E2D;&#x5E78;&#x5B58;&#x7684;&#x6700;&#x5927;&#x8F6E;&#x6570;&#x3002;<br>&#x9ED8;&#x8BA4;15&#xFF0C;&#x4E14;&#x4E0D;&#x80FD;&#x8D85;&#x8FC7;15.</p>\n</li>\n<li><p>-XX:PretenureSizeThreshold</p>\n<p>&#x5F53;&#x5BF9;&#x8C61;&#x5927;&#x5C0F;&#x8D85;&#x8FC7;&#x8BE5;&#x503C;&#x65F6;&#xFF0C;&#x5BF9;&#x8C61;&#x76F4;&#x63A5;&#x8FDB;&#x5165;&#x8001;&#x5E74;&#x4EE3;&#xFF0C;&#x4E0D;&#x4F1A;&#x8FDB;&#x8FC7;&#x5E74;&#x8F7B;&#x4EE3;&#x3002;<br>&#x907F;&#x514D;&#x5927;&#x5BF9;&#x8C61;&#x5728;Survivor&#x4E2D;&#x591A;&#x6B21;&#x590D;&#x5236;&#xFF0C;&#x51CF;&#x5C11;&#x65E0;&#x8C13;&#x7684;&#x64CD;&#x4F5C;&#x3002;</p>\n</li>\n<li><p>-XX:-HandlePromotionFailure</p>\n<p>&#x5224;&#x65AD;&#x8001;&#x5E74;&#x4EE3;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x662F;&#x5426;&#x5927;&#x4E8E;&#x4E4B;&#x524D;&#x6BCF;&#x4E00;&#x6B21;Minor GC&#x540E;&#x8FDB;&#x5165;&#x8001;&#x5E74;&#x4EE3;&#x7684;&#x5BF9;&#x8C61;&#x7684;&#x5E73;&#x5747;&#x5927;&#x5C0F;&#x3002;<br>&#x5224;&#x65AD;&#x5931;&#x8D25;&#x8FDB;&#x884C;Full GC&#xFF0C;&#x518D;&#x6267;&#x884C;Minor GC&#x3002;</p>\n</li>\n<li><p>-XX:SurvivorRatio</p>\n<p>&#x8C03;&#x6574;Eden&#x533A;&#x548C;Survivor&#x533A;&#x5185;&#x5B58;&#x6BD4;&#x7387;</p>\n<ul>\n<li>XX:SurvivorRatio=8  &#xFF1A; Eden 80%</li>\n</ul>\n</li>\n<li><p>-XX:+PrintGCDetils</p>\n<p>&#x6253;&#x5370;&#x8BE6;&#x7EC6;&#x7684;GC&#x65E5;&#x5FD7;&#x3002;</p>\n</li>\n<li><p>-XX:+PrintGCTimeStamps</p>\n<p>&#x6253;&#x5370;GC&#x53D1;&#x751F;&#x7684;&#x65F6;&#x95F4;&#x3002;</p>\n</li>\n<li><p>-Xloggc:gc.log</p>\n<p>&#x5C06;CG&#x65E5;&#x5FD7;&#x8F93;&#x5165;&#x5230;&#x6587;&#x4EF6;&#x3002;</p>\n</li>\n<li><p>-XX:TraceClassLoading</p>\n<p>&#x8FFD;&#x8E2A;&#x52A0;&#x8F7D;&#x7684;&#x7C7B;</p>\n</li>\n<li><p>-XX:TraceClassUnloading</p>\n<p>&#x8FFD;&#x8E2A;&#x5378;&#x8F7D;&#x7684;&#x7C7B;</p>\n</li>\n<li><p>-XX:+HeapDumpOnOutOfMemoryError  </p>\n<p>OOM&#x65F6;&#x81EA;&#x52A8;dump&#x5FEB;&#x7167;</p>\n</li>\n<li><p>-XX:HeapDumpPath=/usr/local/app/oom</p>\n<p>&#x5C06;&#x5FEB;&#x7167;&#x5B58;&#x653E;&#x81F3;&#x6307;&#x5B9A;&#x76EE;&#x5F55;</p>\n</li>\n<li><p>CMS</p>\n<ul>\n<li><p>-XX:CMSInitiatingOccupancyFaction</p>\n<p>&#x8BBE;&#x7F6E;&#x8001;&#x5E74;&#x4EE3;&#x5360;&#x7528;&#x591A;&#x5C11;&#x6BD4;&#x4F8B;&#x65F6;&#x89E6;&#x53D1;CMS</p>\n</li>\n<li><p>-XX:+UseCMSCompactAtFullCollection</p>\n<p>Full GC&#x540E;STW&#xFF0C;&#x6574;&#x7406;&#x5185;&#x5B58;&#x788E;&#x7247;&#x3002;</p>\n</li>\n<li><p>-XX:CMSFullGCsBeforeCompaction</p>\n<p>&#x9ED8;&#x8BA4;0&#xFF0C;&#x8BBE;&#x7F6E;&#x591A;&#x5C11;&#x6B21;Full GC&#x540E;&#x8FDB;&#x884C;&#x5185;&#x5B58;&#x788E;&#x7247;&#x6574;&#x7406;&#x3002;</p>\n</li>\n<li><p>-XX:+CMSParallelInitialMarkEnabled</p>\n<p>&#x521D;&#x59CB;&#x6807;&#x8BB0;&#x9636;&#x6BB5;&#x5F00;&#x542F;&#x5E76;&#x53D1;&#x6267;&#x884C;</p>\n</li>\n</ul>\n</li>\n<li><p>G1</p>\n<ul>\n<li><p>-XX:+UseG1GC</p>\n<p>&#x6307;&#x5B9A;G1&#x5783;&#x573E;&#x56DE;&#x6536;&#x5668;&#x3002;</p>\n</li>\n<li><p>-XX:G1HeapRegionSize</p>\n<p>&#x624B;&#x52A8;&#x6307;&#x5B9A;G1&#x7684;Region&#x7684;&#x5927;&#x5C0F;&#x3002;</p>\n</li>\n<li><p>-XX:G1NewSizePercent</p>\n<p>&#x8C03;&#x6574;&#x65B0;&#x751F;&#x4EE3;&#x5728;&#x5806;&#x4E2D;&#x7684;&#x5360;&#x6BD4;&#x3002;<br>&#x9ED8;&#x8BA4;5%&#x3002;</p>\n</li>\n<li><p>-XX:G1MaxNewSizePercent</p>\n<p>&#x65B0;&#x751F;&#x4EE3;&#x5360;&#x6BD4;&#x5806;&#x7A7A;&#x95F4;&#x7684;&#x6700;&#x5927;&#x5927;&#x5C0F;&#x3002;</p>\n</li>\n<li><p>-XX:MaxGCPauseMills</p>\n<p>&#x9ED8;&#x8BA4;200ms&#x3002;<br>&#x8BBE;&#x7F6E;G1&#x5783;&#x573E;&#x56DE;&#x6536;&#x5668;GC&#x65F6;&#x7684;&#x6700;&#x5927;&#x505C;&#x987F;&#x65F6;&#x95F4;&#x3002;</p>\n</li>\n<li><p>-XX:InitiatingHeapOccupancyPercent</p>\n<p>&#x9ED8;&#x8BA4;45%&#x3002;<br>&#x8001;&#x5E74;&#x4EE3;&#x5360;&#x636E;&#x7684;&#x5806;&#x5185;&#x5B58;&#x8D85;&#x591A;&#x8BE5;&#x503C;&#xFF0C;&#x5C06;&#x4F1A;&#x8FDB;&#x884C;&#x65B0;&#x8001;&#x751F;&#x4EE3;&#x7684;&#x6DF7;&#x5408;&#x56DE;&#x6536;&#x3002;</p>\n</li>\n<li><p>-XX:G1MixedGCCountTarget</p>\n<p>&#x4E00;&#x6B21;G1&#x6DF7;&#x5408;&#x56DE;&#x6536;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6700;&#x540E;&#x9636;&#x6BB5;&#x6DF7;&#x5408;&#x56DE;&#x6536;&#x9636;&#x6BB5;&#x5206;&#x51E0;&#x6B21;&#x5B8C;&#x6210;&#x3002;<br>&#x9ED8;&#x8BA4;8&#x3002;</p>\n</li>\n<li><p>-XX:G1HeapWastePercent</p>\n<p>&#x9ED8;&#x8BA4;&#x503C;5%&#x3002;<br>&#x6DF7;&#x5408;&#x56DE;&#x6536;&#x9636;&#x6BB5;&#x4E2D;&#xFF0C;&#x7A7A;&#x95F4;Region&#x5360;&#x6BD4;&#x5806;&#x7A7A;&#x95F4;&#x8D85;&#x591A;&#x8BE5;&#x503C;&#xFF0C;&#x4F1A;&#x505C;&#x6B62;&#x6DF7;&#x5408;&#x56DE;&#x6536;&#x3002;</p>\n</li>\n<li><p>-XX:G1MixedGCLiveThresholdPercent</p>\n<p>&#x9ED8;&#x8BA4;&#x503C;85%&#x3002;<br>&#x4E00;&#x4E2A;Region&#x4E2D;&#x7684;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x4F4E;&#x4E8E;&#x8BE5;&#x503C;&#x65F6;&#x624D;&#x4F1A;&#x88AB;&#x56DE;&#x6536;&#x3002;</p>\n</li>\n<li><p>-XX:+CMSScavengeBeforeRemark</p>\n<p>&#x91CD;&#x65B0;&#x6807;&#x8BB0;&#x524D;&#xFF0C;&#x5C3D;&#x91CF;&#x6267;&#x884C;&#x4E00;&#x6B21;Young GC&#x3002;<br>&#x63D0;&#x524D;&#x56DE;&#x6536;&#x5E74;&#x8F7B;&#x4EE3;&#x6CA1;&#x6709;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x51CF;&#x5C11;&#x91CD;&#x65B0;&#x6807;&#x8BB0;&#x626B;&#x63CF;&#x7684;&#x5BF9;&#x8C61;&#x6570;&#xFF0C;&#x63D0;&#x9AD8;&#x6548;&#x7387;&#x3002;</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>&#x5783;&#x573E;&#x56DE;&#x6536;</p>\n<ul>\n<li><p>&#x53EF;&#x8FBE;&#x6027;&#x5206;&#x6790;</p>\n<p>&#x5BF9;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x5C42;&#x5C42;&#x5411;&#x4E0A;&#x5206;&#x6790;&#xFF0C;&#x5224;&#x65AD;&#x662F;&#x5426;&#x6709;&#x4E00;&#x4E2A;GC Root&#x3002;</p>\n<ul>\n<li><p>GC Root</p>\n<ul>\n<li>&#x672C;&#x5730;&#x53D8;&#x91CF;&#x8868;&#x4E2D;&#x7684;&#x5C40;&#x90E8;&#x53D8;&#x91CF;</li>\n<li>&#x65B9;&#x6CD5;&#x533A;&#x5185;&#x7684;&#x9759;&#x6001;&#x53D8;&#x91CF;</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>java &#x5F15;&#x7528;&#x7C7B;&#x578B;</p>\n<ul>\n<li><p>&#x5F3A;&#x5F15;&#x7528;</p>\n<p>GC&#x4E0D;&#x4F1A;&#x56DE;&#x6536;&#x5F3A;&#x5F15;&#x7528;</p>\n</li>\n<li><p>&#x8F6F;&#x5F15;&#x7528;</p>\n<p>&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x8DB3;&#x591F;&#x65F6;&#xFF0C;GC&#x4E0D;&#x4F1A;&#x56DE;&#x6536;&#x8F6F;&#x5F15;&#x7528;</p>\n</li>\n<li><p>&#x5F31;&#x5F15;&#x7528;</p>\n<p>GC&#x65F6;&#x5FC5;&#x5B9A;&#x56DE;&#x6536;&#x5F31;&#x5F15;&#x7528;</p>\n</li>\n<li><p>&#x865A;&#x5F15;&#x7528;</p>\n<p>&#x7EE7;&#x627F;Object&#x7684;finalize()&#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x8BE5;&#x5BF9;&#x8C61;&#x88AB;&#x56DE;&#x6536;&#x7684;&#x65F6;&#x5019;&#x901A;&#x77E5;&#x81EA;&#x5DF1;&#x3002;</p>\n</li>\n</ul>\n</li>\n<li><p>&#x5783;&#x573E;&#x56DE;&#x6536;&#x7B97;&#x6CD5;</p>\n<ul>\n<li><p>&#x5E74;&#x8F7B;&#x4EE3;</p>\n<ul>\n<li><p>&#x590D;&#x5236;</p>\n<p>&#x5728;&#x65B0;&#x751F;&#x4EE3;&#x5E78;&#x5B58;&#x8005;0,1&#x533A;&#x4F7F;&#x7528;&#x3002;&#x5C06;&#x6807;&#x8BB0;&#x4E3A;&#x53EF;&#x7528;&#x7684;&#x5185;&#x5B58;&#x590D;&#x5236;&#x5230;&#x53E6;&#x5916;&#x4E00;&#x7247;&#x8FDE;&#x7EED;&#x7684;&#x5185;&#x5B58;&#x533A;&#x57DF;&#x4E2D;&#xFF0C;&#x5E76;&#x5220;&#x9664;&#x5F53;&#x524D;&#x5185;&#x5B58;&#x533A;&#x57DF;&#x4E2D;&#x7684;&#x5168;&#x90E8;&#x6570;&#x636E;&#x3002;</p>\n<ul>\n<li><p>&#x4F18;&#x70B9;</p>\n<p>&#x4E0D;&#x4F1A;&#x4EA7;&#x751F;&#x5185;&#x5B58;&#x788E;&#x7247;</p>\n</li>\n<li><p>&#x7F3A;&#x70B9;</p>\n<p>&#x589E;&#x52A0;&#x5185;&#x5B58;&#x7684;&#x6D88;&#x8017;</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>&#x8001;&#x5E74;&#x4EE3;</p>\n<ul>\n<li><p>&#x6807;&#x8BB0;&#x6574;&#x7406;</p>\n<p>&#x6807;&#x8BB0;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#xFF0C;&#x5220;&#x9664;&#x6B7B;&#x4EA1;&#x5BF9;&#x8C61;&#xFF0C;&#x6574;&#x7406;&#x5185;&#x5B58;&#x788E;&#x7247;&#x3002;</p>\n<ul>\n<li><p>&#x4F18;&#x70B9;</p>\n<p>&#x4E0D;&#x4F1A;&#x4EA7;&#x751F;&#x5185;&#x5B58;&#x788E;&#x7247;&#x3002;&#x5185;&#x5B58;&#x5229;&#x7528;&#x7387;&#x9AD8;&#x3002;</p>\n</li>\n<li><p>&#x7F3A;&#x70B9;</p>\n<p>&#x6BD4;&#x8D77;&#x6807;&#x8BB0;&#x6E05;&#x695A;&#xFF0C;&#x6267;&#x884C;&#x6548;&#x7387;&#x6162;&#x3002;</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>JVM&#x5783;&#x573E;&#x56DE;&#x6536;&#x5668;</p>\n<ul>\n<li><p>&#x5E74;&#x8F7B;&#x4EE3;</p>\n<ul>\n<li><p>ParNew</p>\n<p>&#x591A;&#x7EBF;&#x7A0B;&#xFF0C;&#x590D;&#x5236;&#x7B97;&#x6CD5;&#x3002;<br>&#x5F00;&#x542F;&#xFF1A;-XX:+UseParNewGC<br>&#x8C03;&#x6574;&#x56DE;&#x6536;&#x7EBF;&#x7A0B;&#x6570;&#xFF1A;-XX:ParallelGCThreads</p>\n</li>\n</ul>\n</li>\n<li><p>&#x8001;&#x5E74;&#x4EE3;</p>\n<ul>\n<li><p>CMS</p>\n<p>&#x6807;&#x8BB0;&#x6E05;&#x7406;&#x7B97;&#x6CD5;</p>\n<ul>\n<li><p>&#x56DE;&#x6536;&#x8FC7;&#x7A0B;</p>\n<ul>\n<li><p>&#x521D;&#x59CB;&#x6807;&#x8BB0;</p>\n<p>STW&#x3002;<br>&#x6807;&#x8BB0;&#x6240;&#x6709;GC Roots&#x76F4;&#x63A5;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x88AB;&#x76F4;&#x63A5;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x6240;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x4E0D;&#x4F1A;&#x88AB;&#x6807;&#x8BB0;&#x3002;</p>\n</li>\n<li><p>&#x5E76;&#x53D1;&#x6807;&#x8BB0;</p>\n<p>&#x5BFB;&#x627E;&#x88AB;GC Roots&#x95F4;&#x63A5;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x3002;</p>\n</li>\n<li><p>&#x91CD;&#x65B0;&#x6807;&#x8BB0;</p>\n<p>STW&#x3002;<br>&#x91CD;&#x65B0;&#x6807;&#x8BB0;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x65F6;&#x4EA7;&#x751F;&#x7684;&#x65B0;&#x5BF9;&#x8C61;&#x3002;</p>\n</li>\n<li><p>&#x5E76;&#x53D1;&#x6E05;&#x9664;</p>\n<p>&#x6E05;&#x7406;&#x6807;&#x8BB0;&#x7684;&#x5BF9;&#x8C61;&#x3002;</p>\n</li>\n</ul>\n</li>\n<li><p>&#x7F3A;&#x70B9;</p>\n<p>&#x9ED8;&#x8BA4;&#x542F;&#x52A8;&#x5783;&#x573E;&#x56DE;&#x6536;&#x7EBF;&#x7A0B;&#xFF1A;&#xFF08;CPU&#x6838;&#x6570; +3&#xFF09;/4&#x3002;<br>&#x672C;&#x8EAB;&#x4F1A;&#x6D88;&#x8017;CPU&#x8D44;&#x6E90;&#x3002;<br>&#x9488;&#x5BF9;&#x6D6E;&#x52A8;&#x5783;&#x573E;&#xFF0C;&#x521D;&#x59CB;&#x6807;&#x8BB0;&#x540E;&#x4EA7;&#x751F;&#x7684;&#x5783;&#x573E;&#x6CA1;&#x6CD5;&#x56DE;&#x6536;&#x3002;<br>CMS&#x56DE;&#x6536;&#x671F;&#x95F4;&#xFF0C;&#x65B0;&#x751F;&#x4EE3;&#x8FDB;&#x5165;&#x8001;&#x5E74;&#x4EE3;&#x5BF9;&#x8C61;&#x5927;&#x4E8E;&#x53EF;&#x7528;&#x7A7A;&#x95F4;&#x65F6;&#xFF0C;&#x4F1A;&#x53D1;&#x751F;Concurrent Mode Failure &#xFF0C;&#x5E76;&#x81EA;&#x52A8;&#x4F7F;&#x7528;Serial Old&#x56DE;&#x6536;&#x5668;&#x66FF;&#x4EE3;CMS&#x5DE5;&#x4F5C;&#x3002;</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>G1</p>\n<p>&#x57FA;&#x4E8E;&#x590D;&#x5236;&#x7B97;&#x6CD5;&#x3002;<br>&#x628A;Java&#x5806;&#x5185;&#x5B58;&#x5212;&#x5206;&#x4E3A;&#x591A;&#x4E2A;&#x5927;&#x5C0F;&#x76F8;&#x7B49;&#x7684;Region&#x3002;<br>&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;STW&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x8FFD;&#x8E2A;&#x6BCF;&#x4E2A;Region&#x91CC;&#x53EF;&#x56DE;&#x6536;&#x5BF9;&#x8C61;&#x7684;&#x9884;&#x4F30;&#x65F6;&#x95F4;&#x3002;<br>G1&#x4E2D;&#x7684;&#x5206;&#x4EE3;&#x662F;&#x903B;&#x8F91;&#x4E0A;&#x7684;&#x5206;&#x4EE3;&#xFF0C;&#x540C;&#x4E00;&#x4E2A;Region&#x4F1A;&#x968F;&#x7740;&#x5206;&#x914D;&#x7684;&#x5185;&#x5B58;&#x5BF9;&#x8C61;&#x4E0D;&#x540C;&#xFF0C;&#x800C;&#x5C5E;&#x4E8E;&#x4E0D;&#x540C;&#x5206;&#x4EE3;&#x3002;<br>&#x6BCF;&#x4E2A;Region&#x7684;&#x5927;&#x5C0F;&#xFF1A;&#x5806;&#x5927;&#x5C0F;/2048&#x3002;<br>&#x65B0;&#x751F;&#x4EE3;&#x7684;Region&#x540C;&#x65F6;&#x5206;Eden&#x548C;Survivor&#xFF0C;&#x53EF;&#x901A;&#x8FC7;-XX:SurvivorRatio&#x8C03;&#x6574;&#x5360;&#x6BD4;&#x3002;<br>&#x9002;&#x5408;&#x5927;&#x5185;&#x5B58;&#x7684;&#x673A;&#x5668;&#xFF0C;G1&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;&#x505C;&#x987F;&#x65F6;&#x95F4;&#xFF0C;&#x6765;&#x786E;&#x4FDD;&#x5BF9;&#x670D;&#x52A1;&#x4E0D;&#x4F1A;&#x6709;&#x8F83;&#x5927;&#x7684;&#x5F71;&#x54CD;&#x3002;</p>\n<ul>\n<li><p>&#x5927;&#x5BF9;&#x8C61;</p>\n<p>&#x8D85;&#x591A;Region&#x5927;&#x5C0F;50%&#x5373;&#x4E3A;&#x5927;&#x5BF9;&#x8C61;&#x3002;<br>&#x5927;&#x5BF9;&#x8C61;&#x53EF;&#x80FD;&#x6A2A;&#x8DE8;&#x591A;&#x4E2A;Region&#x3002;<br>&#x7A7A;&#x7684;Region&#x90FD;&#x53EF;&#x4EE5;&#x5B58;&#x653E;&#x5927;&#x5BF9;&#x8C61;&#x3002;<br>&#x65B0;&#x8001;&#x751F;&#x4EE3;GC&#x65F6;&#x90FD;&#x4F1A;&#x56DE;&#x6536;&#x5927;&#x5BF9;&#x8C61;&#x3002;</p>\n</li>\n<li><p>&#x56DE;&#x6536;&#x8FC7;&#x7A0B;</p>\n<ul>\n<li><p>&#x521D;&#x59CB;&#x6807;&#x8BB0;</p>\n<p>STW&#x3002;<br>&#x6807;&#x8BB0;&#x6240;&#x6709;GC Roots&#x76F4;&#x63A5;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x88AB;&#x76F4;&#x63A5;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x6240;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x4E0D;&#x4F1A;&#x88AB;&#x6807;&#x8BB0;&#x3002;</p>\n</li>\n<li><p>&#x5E76;&#x53D1;&#x6807;&#x8BB0;</p>\n<p>&#x8FDB;&#x884C;GC Roots&#x7684;&#x8FFD;&#x8E2A;&#xFF0C;&#x8FFD;&#x8E2A;&#x6240;&#x6709;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x3002;<br>&#x540C;&#x65F6;JVM&#x4F1A;&#x8BB0;&#x5F55;&#x8BE5;&#x9636;&#x6BB5;&#x4E2D;&#x65B0;&#x5EFA;&#x6216;&#x5931;&#x53BB;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#x3002;</p>\n</li>\n<li><p>&#x6700;&#x7EC8;&#x6807;&#x8BB0;</p>\n<p>STW&#x3002;<br>&#x901A;&#x8FC7;&#x591A;&#x5E76;&#x53D1;&#x6807;&#x8BB0;&#x4E2D;JVM&#x5806;&#x65B0;&#x589E;&#x6216;&#x5931;&#x53BB;&#x5F15;&#x7528;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x8FDB;&#x884C;&#x91CD;&#x65B0;&#x6807;&#x8BB0;&#x3002;</p>\n</li>\n<li><p>&#x6DF7;&#x5408;&#x56DE;&#x6536;</p>\n<p>&#x5206;&#x6790;Region&#x5927;&#x5C0F;&#xFF0C;&#x6267;&#x884C;&#x6548;&#x7387;&#x3002;<br>STW&#x3002;<br>&#x5728;&#x6307;&#x5B9A;&#x65F6;&#x95F4;&#x5185;&#x8FDB;&#x884C;&#x56DE;&#x6536;&#x3002;</p>\n</li>\n</ul>\n</li>\n<li><p>&#x95EE;&#x9898;</p>\n<p>&#x56DE;&#x6536;&#x4E2D;&#x53D1;&#x73B0;Region&#x7A7A;&#x95F4;&#x4E0D;&#x591F;&#x65F6;&#xFF0C;&#x5C06;&#x4F1A;SWT&#xFF0C;&#x5E76;&#x5355;&#x7EBF;&#x7A0B;&#x8FDB;&#x884C;&#x6807;&#x8BB0;&#x3001;&#x6E05;&#x9664;&#x3001;&#x6574;&#x7406;&#xFF0C;&#x6548;&#x7387;&#x5F88;&#x4F4E;&#x3002;</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>CG&#x89E6;&#x53D1;&#x65F6;&#x95F4;</p>\n<ul>\n<li><p>Minor GC</p>\n<p>Eden&#x533A;&#x6EE1;&#x65F6;&#x91C7;&#x7528;&#x590D;&#x5236;&#x7B97;&#x6CD5;&#x3002;</p>\n</li>\n<li><p>Old GC</p>\n<p>1.&#x8001;&#x5E74;&#x4EE3;&#x8FDE;&#x7EED;&#x53EF;&#x7528;&#x7A7A;&#x95F4; &lt; &#x65B0;&#x751F;&#x4EE3;&#x5386;&#x6B21;GC&#x540E;&#x5347;&#x5165;&#x8001;&#x5E74;&#x4EE3;&#x5BF9;&#x8C61;&#x5185;&#x5B58;&#x548C;&#x7684;&#x5E73;&#x5747;&#x5927;&#x5C0F;&#x3002;<br>2.&#x8001;&#x5E74;&#x4EE3;&#x4E0D;&#x591F;&#x5B58;&#x653E;&#xFF0C;Minor GC&#x540E;&#x5347;&#x5165;&#x8001;&#x5E74;&#x4EE3;&#x7684;&#x5BF9;&#x8C61;&#x65F6;&#x3002;<br>3.&#x8001;&#x5E74;&#x4EE3;&#x5185;&#x5B58;&#x4F7F;&#x7528;&#x7387;&#x8D85;&#x8FC7;92%&#x65F6;&#xFF08;&#x53EF;&#x8BBE;&#x7F6E;&#xFF09;&#x3002;</p>\n</li>\n<li><p>&#x6C38;&#x4E45;&#x4EE3;GC</p>\n<p>&#x6C38;&#x4E45;&#x4EE3;&#x4E0D;&#x591F;&#x4F7F;&#x4EA7;&#x751F;Full GC&#x3002;</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"&#x672C;&#x5730;&#x65B9;&#x6CD5;&#x6808;\"><a href=\"#&#x672C;&#x5730;&#x65B9;&#x6CD5;&#x6808;\" class=\"headerlink\" title=\"&#x672C;&#x5730;&#x65B9;&#x6CD5;&#x6808;\"></a>&#x672C;&#x5730;&#x65B9;&#x6CD5;&#x6808;</h3><p>&#x5B58;&#x653E;native&#x65B9;&#x6CD5;&#x3002;</p>\n<h3 id=\"&#x5806;&#x5916;&#x5185;&#x5B58;&#x7A7A;&#x95F4;\"><a href=\"#&#x5806;&#x5916;&#x5185;&#x5B58;&#x7A7A;&#x95F4;\" class=\"headerlink\" title=\"&#x5806;&#x5916;&#x5185;&#x5B58;&#x7A7A;&#x95F4;\"></a>&#x5806;&#x5916;&#x5185;&#x5B58;&#x7A7A;&#x95F4;</h3><p>&#x901A;&#x8FC7;&#x8C03;&#x7528;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x63A5;&#x53E3;&#xFF0C;&#x76F4;&#x63A5;&#x5206;&#x914D;&#x5BF9;&#x5916;&#x5185;&#x5B58;&#x7A7A;&#x95F4;&#x3002;<br>NIO-&gt;allocateDirect(DirectByteBuffer)</p>\n<h2 id=\"&#x5DE5;&#x5177;\"><a href=\"#&#x5DE5;&#x5177;\" class=\"headerlink\" title=\"&#x5DE5;&#x5177;\"></a>&#x5DE5;&#x5177;</h2><h3 id=\"jstat\"><a href=\"#jstat\" class=\"headerlink\" title=\"jstat\"></a>jstat</h3><p>&#x901A;&#x8FC7;jps&#x67E5;&#x627E;java&#x8FDB;&#x7A0B;&#xFF0C;&#x518D;&#x7528;jstat -gc PID&#x67E5;&#x770B;GC&#x72B6;&#x51B5;&#x3002;</p>\n<ul>\n<li><p>&#x6307;&#x6807;</p>\n<ul>\n<li><p>S0C</p>\n<p>From Survivor&#x533A;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>S1C</p>\n<p>To Survivor&#x533A;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>S0U</p>\n<p>From Survivor&#x533A;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>S1U</p>\n<p>To Survivor&#x533A;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>EC</p>\n<p>Eden&#x533A;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>EU</p>\n<p>Eden&#x533A;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x7684;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>OC</p>\n<p>&#x8001;&#x5E74;&#x4EE3;&#x7684;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>OU</p>\n<p>&#x8001;&#x5E74;&#x4EE3;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x7684;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>MC</p>\n<p>&#x65B9;&#x6CD5;&#x533A;&#xFF08;&#x6C38;&#x4E45;&#x4EE3;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#xFF09;&#x7684;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>MU</p>\n<p>&#x65B9;&#x6CD5;&#x533A;&#xFF08;&#x6C38;&#x4E45;&#x4EE3;&#x3001;&#x5143;&#x7A7A;&#x95F4;&#xFF09;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x7684;&#x5927;&#x5C0F;</p>\n</li>\n<li><p>YGC</p>\n<p>&#x7CFB;&#x7EDF;&#x8FC4;&#x4ECA;&#x4E3A;&#x6B62;Young GC&#x7684;&#x6B21;&#x6570;</p>\n</li>\n<li><p>YGCT</p>\n<p>Young GC&#x8017;&#x65F6;</p>\n</li>\n<li><p>FGC</p>\n<p>&#x7CFB;&#x7EDF;&#x8FC4;&#x4ECA;&#x4E3A;&#x6B62;Full GC&#x7684;&#x6B21;&#x6570;</p>\n</li>\n<li><p>FGCT</p>\n<p>Full GC&#x7684;&#x8017;&#x65F6;</p>\n</li>\n<li><p>GCT</p>\n<p>&#x6240;&#x6709;GC&#x7684;&#x603B;&#x8017;&#x65F6;</p>\n</li>\n</ul>\n</li>\n<li><p>&#x547D;&#x4EE4;</p>\n<ul>\n<li><p>jstat -gc PID</p>\n<p>&#x67E5;&#x770B;GC&#x72B6;&#x51B5;</p>\n</li>\n<li><p>jstat -gccapacity PID</p>\n<p>&#x5806;&#x5185;&#x5B58;&#x5206;&#x6790;</p>\n</li>\n<li><p>jstat -gcnew PID</p>\n<p>&#x65B0;&#x751F;&#x4EE3;&#x5206;&#x6790;</p>\n</li>\n<li><p>jstat -gcnewcapacity PID</p>\n<p>&#x5E74;&#x8F7B;&#x4EE3;&#x5185;&#x5B58;&#x5206;&#x6790;</p>\n</li>\n<li><p>jstat -gcold PID</p>\n<p>&#x8001;&#x5E74;&#x4EE3;GC&#x5206;&#x6790;</p>\n</li>\n<li><p>jstat -gcoldcapacity PID</p>\n<p>&#x8001;&#x5E74;&#x4EE3;&#x5185;&#x5B58;&#x5206;&#x6790;</p>\n</li>\n<li><p>jstat -gcmetacapacity PID</p>\n<p>&#x5143;&#x6570;&#x636E;&#x5185;&#x5B58;&#x5206;&#x6790;</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"jmap\"><a href=\"#jmap\" class=\"headerlink\" title=\"jmap\"></a>jmap</h3><p>&#x4E86;&#x89E3;&#x8FD0;&#x884C;&#x65F6;&#x7684;&#x5185;&#x5B58;&#x533A;&#x57DF;</p>\n<ul>\n<li><p>&#x547D;&#x4EE4;</p>\n<ul>\n<li><p>jmap -heap PID</p>\n<p>&#x6253;&#x5370;&#x5806;&#x5185;&#x5B58;&#x76F8;&#x5173;&#x53C2;&#x6570;&#x8BBE;&#x7F6E;&#x3002;<br>&#x5F53;&#x524D;&#x5806;&#x5185;&#x5404;&#x4E2A;&#x533A;&#x7684;&#x57FA;&#x672C;&#x60C5;&#x51B5;&#x3002;</p>\n</li>\n<li><p>jmap -histo PID</p>\n<p>&#x6309;&#x7167;&#x5BF9;&#x8C61;&#x5728;&#x5185;&#x5B58;&#x4E2D;&#x5360;&#x7528;&#x5927;&#x5C0F;&#x6392;&#x5E8F;&#xFF0C;&#x964D;&#x5E8F;&#x3002;<br>&#x53EF;&#x4EE5;&#x4E86;&#x89E3;&#x54EA;&#x4E2A;&#x5BF9;&#x8C61;&#x5728;&#x5806;&#x4E2D;&#x5360;&#x7528;&#x4E86;&#x5927;&#x91CF;&#x7684;&#x7A7A;&#x95F4;&#x3002;</p>\n</li>\n<li><p>jmap -dump:live,format=b,file=dump.hprof PID</p>\n<p>&#x751F;&#x6210;&#x5185;&#x5B58;&#x5FEB;&#x7167;&#x5E76;&#x8F93;&#x51FA;&#x5230;&#x6587;&#x4EF6;&#x3002;</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"jhat\"><a href=\"#jhat\" class=\"headerlink\" title=\"jhat\"></a>jhat</h3><p>&#x5206;&#x6790;&#x5806;&#x5185;&#x5B58;&#x5FEB;&#x7167;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5DE5;&#x5177;&#x5185;&#x7F6E;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#x67E5;&#x770B;&#x3002;</p>\n<ul>\n<li><p>&#x547D;&#x4EE4;</p>\n<ul>\n<li><p>jhat dump.hprof -port 7000</p>\n<p>&#x5206;&#x6790;&#x5FEB;&#x7167;&#x6587;&#x4EF6;dump.hprof &#xFF0C;&#x8BBF;&#x95EE;&#x7AEF;&#x53E3;7000&#x3002;</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"MAT\"><a href=\"#MAT\" class=\"headerlink\" title=\"MAT\"></a>MAT</h3><p>&#x5185;&#x5B58;&#x5206;&#x6790;&#x5DE5;&#x5177;</p>\n<h2 id=\"JVM&#x4F18;&#x5316;&#x603B;&#x7ED3;\"><a href=\"#JVM&#x4F18;&#x5316;&#x603B;&#x7ED3;\" class=\"headerlink\" title=\"JVM&#x4F18;&#x5316;&#x603B;&#x7ED3;\"></a>JVM&#x4F18;&#x5316;&#x603B;&#x7ED3;</h2><h3 id=\"&#x8C03;&#x6574;&#x65B0;&#x751F;&#x4EE3;&#x7684;&#x5927;&#x5C0F;\"><a href=\"#&#x8C03;&#x6574;&#x65B0;&#x751F;&#x4EE3;&#x7684;&#x5927;&#x5C0F;\" class=\"headerlink\" title=\"&#x8C03;&#x6574;&#x65B0;&#x751F;&#x4EE3;&#x7684;&#x5927;&#x5C0F;\"></a>&#x8C03;&#x6574;&#x65B0;&#x751F;&#x4EE3;&#x7684;&#x5927;&#x5C0F;</h3><p>&#x5C3D;&#x91CF;&#x8BA9;&#x6BCF;&#x6B21;Young GC&#x540E;&#x7684;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x2F29;&#x4E8E;Survivor&#x533A;&#x57DF;&#x7684;50%&#xFF0C;&#x90FD;&#x7559;&#x5B58;&#x5728;&#x5E74;&#x8F7B;&#x4EE3;&#x2FA5;&#x3002;&#x5C3D;&#x91CF;&#x522B;&#x8BA9;&#x5BF9;&#x8C61;&#x8FDB; &#x2F0A;&#x2F7C;&#x5E74;&#x4EE3;&#x3002;&#x5C3D;&#x91CF;&#x51CF;&#x5C11;Full GC&#x7684;&#x9891;&#x7387;&#xFF0C;&#x907F;&#x514D;&#x9891;&#x7E41;Full GC&#x5BF9;JVM&#x6027;&#x80FD;&#x7684;&#x5F71;&#x54CD;</p>\n<h3 id=\"&#x8C03;&#x6574;&#x8001;&#x5E74;&#x4EE3;&#x788E;&#x7247;&#x56DE;&#x6536;&#x7684;&#x9891;&#x7387;\"><a href=\"#&#x8C03;&#x6574;&#x8001;&#x5E74;&#x4EE3;&#x788E;&#x7247;&#x56DE;&#x6536;&#x7684;&#x9891;&#x7387;\" class=\"headerlink\" title=\"&#x8C03;&#x6574;&#x8001;&#x5E74;&#x4EE3;&#x788E;&#x7247;&#x56DE;&#x6536;&#x7684;&#x9891;&#x7387;\"></a>&#x8C03;&#x6574;&#x8001;&#x5E74;&#x4EE3;&#x788E;&#x7247;&#x56DE;&#x6536;&#x7684;&#x9891;&#x7387;</h3><p>CMS&#x4E00;&#x6B21;Full GC&#x4F1A;&#x4EA7;&#x751F;&#x5185;&#x5B58;&#x968F;&#x4FBF;&#xFF0C;&#x8C03;&#x6574;&#x788E;&#x7247;&#x6574;&#x7406;&#x7684;&#x89E6;&#x53D1;&#x8F6E;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x6709;&#x6548;&#x7684;&#x964D;&#x4F4E;Full  GC&#x4EA7;&#x751F;&#x7684;&#x788E;&#x7247;&#x4ECE;&#x800C;&#x964D;&#x4F4E;Full GC&#x7684;&#x9891;&#x6B21;&#x3002;</p>\n<h3 id=\"JVM&#x53C2;&#x6570;&#x6A21;&#x677F;\"><a href=\"#JVM&#x53C2;&#x6570;&#x6A21;&#x677F;\" class=\"headerlink\" title=\"JVM&#x53C2;&#x6570;&#x6A21;&#x677F;\"></a>JVM&#x53C2;&#x6570;&#x6A21;&#x677F;</h3><p>-Xms4096M -Xmx4096M -Xmn3072M -Xss1M&#xA0;-XX:MetaspaceSize=256M -XX:MaxMetaspaceSize=256M -XX:+UseParNewGC - XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFaction=92 -XX:+UseCMSCompactAtFullCollection - XX:CMSFullGCsBeforeCompaction=0 -XX:+CMSParallelInitialMarkEnabled -XX:+CMSScavengeBeforeRemark - XX:+DisableExplicitGC -XX:+PrintGCDetails -Xloggc:gc.log -XX:+HeapDumpOnOutOfMemoryError&#xA0;- XX:HeapDumpPath=/usr/local/app/oom</p>\n<h3 id=\"XX-SoftRefLRUPolicyMSPerMB\"><a href=\"#XX-SoftRefLRUPolicyMSPerMB\" class=\"headerlink\" title=\"-XX:SoftRefLRUPolicyMSPerMB\"></a>-XX:SoftRefLRUPolicyMSPerMB</h3><p>&#x5728;&#x6709;&#x5927;&#x91CF;&#x53CD;&#x5C04;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x5EFA;&#x8BAE;&#x589E;&#x5927;&#x8BE5;&#x503C;&#xFF0C;&#x4FDD;&#x8BC1;&#x8F6F;&#x5F15;&#x7528;&#x4E0D;&#x4F1A;&#x88AB;&#x9A6C;&#x4E0A;&#x56DE;&#x6536;</p>\n<h3 id=\"XX-DisableExplicitGC\"><a href=\"#XX-DisableExplicitGC\" class=\"headerlink\" title=\"-XX:+DisableExplicitGC\"></a>-XX:+DisableExplicitGC</h3><p>&#x7981;&#x6B62;&#x663E;&#x793A;&#x6267;&#x884C;GC<br>&#x6027;&#x8D28;System.gc()</p>\n<h3 id=\"&#x4F7F;&#x7528;&#x7F13;&#x5B58;&#x6DD8;&#x6C70;&#x673A;&#x5236;\"><a href=\"#&#x4F7F;&#x7528;&#x7F13;&#x5B58;&#x6DD8;&#x6C70;&#x673A;&#x5236;\" class=\"headerlink\" title=\"&#x4F7F;&#x7528;&#x7F13;&#x5B58;&#x6DD8;&#x6C70;&#x673A;&#x5236;\"></a>&#x4F7F;&#x7528;&#x7F13;&#x5B58;&#x6DD8;&#x6C70;&#x673A;&#x5236;</h3><p>&#x907F;&#x514D;&#x672C;&#x5730;&#x7F13;&#x5B58;&#x65E0;&#x9650;&#x589E;&#x5927;&#xFF0C;&#x4F7F;&#x5F97;&#x8001;&#x5E74;&#x4EE3;&#x5E38;&#x9A7B;&#x5BF9;&#x8C61;&#x65E0;&#x6CD5;&#x56DE;&#x6536;&#xFF0C;&#x4ECE;&#x800C;&#x5BFC;&#x81F4;&#x7684;&#x5185;&#x5B58;&#x6EA2;&#x51FA;&#x548C;&#x9891;&#x7E41;&#x7684;Full GC&#x3002;</p>\n<h3 id=\"&#x9891;&#x7E41;Full-GC&#x7684;&#x53EF;&#x80FD;&#x539F;&#x56E0;\"><a href=\"#&#x9891;&#x7E41;Full-GC&#x7684;&#x53EF;&#x80FD;&#x539F;&#x56E0;\" class=\"headerlink\" title=\"&#x9891;&#x7E41;Full GC&#x7684;&#x53EF;&#x80FD;&#x539F;&#x56E0;\"></a>&#x9891;&#x7E41;Full GC&#x7684;&#x53EF;&#x80FD;&#x539F;&#x56E0;</h3><p>1.&#x7CFB;&#x7EDF;&#x538B;&#x529B;&#x5927;&#xFF0C;&#x9891;&#x7E41;Young GC&#x540E;&#x5B58;&#x6D3B;&#x5BF9;&#x8C61;&#x5927;&#x4E8E;Survivor&#x533A;&#xFF0C;&#x5BFC;&#x81F4;&#x76F4;&#x63A5;&#x8FDB;&#x5165;&#x8001;&#x5E74;&#x4EE3;&#x3002;<br>2.&#x9891;&#x7E41;&#x4EA7;&#x751F;&#x5927;&#x5BF9;&#x8C61;&#x3002;<br>3.&#x5BF9;&#x8C61;&#x59CB;&#x7EC8;&#x4E0D;&#x91CA;&#x653E;&#xFF0C;&#x5BFC;&#x81F4;&#x5185;&#x5B58;&#x6CC4;&#x6F0F;&#x3002;<br>4.&#x65B9;&#x6CD5;&#x533A;&#x9891;&#x7E41;&#x6709;&#x7C7B;&#x53CD;&#x5C04;&#x52A0;&#x8F7D;&#x3002;<br>5.&#x9519;&#x8BEF;&#x4F7F;&#x7528;System.gc()&#x3002;</p>\n<p><em>XMind: ZEN - Trial Version</em></p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"JVM","path":"tags/JVM/"},{"name":"Java","path":"tags/Java/"}],"excerpt":"<html><head></head><body><h1 id=\"JVM-&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x6574;&#x7406;\"><a href=\"#JVM-&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x6574;&#x7406;\" class=\"headerlink\" title=\"JVM &#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x6574;&#x7406;\"></a>JVM &#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x6574;&#x7406;</h1><ol>\n<li>&#x5185;&#x5B58;&#x5206;&#x914D;</li>\n<li>&#x5783;&#x573E;&#x56DE;&#x6536;&#x5668;&#x7684;&#x53C2;&#x6570;&#x914D;&#x7F6E;</li>\n</ol>\n<h2 id=\"&#x7C7B;&#x7684;&#x52A0;&#x8F7D;\"><a href=\"#&#x7C7B;&#x7684;&#x52A0;&#x8F7D;\" class=\"headerlink\" title=\"&#x7C7B;&#x7684;&#x52A0;&#x8F7D;\"></a>&#x7C7B;&#x7684;&#x52A0;&#x8F7D;</h2></body></html>","more":"<p>加载-&gt;验证-&gt;准备-&gt;解析-&gt;初始化-&gt;使用-&gt;卸载</p>\n<h3 id=\"加载流程\"><a href=\"#加载流程\" class=\"headerlink\" title=\"加载流程\"></a>加载流程</h3><ul>\n<li><p>加载</p>\n<p>代码中使用到这个类的时候，.class字节码文件就会加载这个类到JVM内存中。</p>\n</li>\n<li><p>链接</p>\n<ul>\n<li><p>验证</p>\n<p>根据JVM规范，校验.class文件。</p>\n</li>\n<li><p>准备</p>\n<p>给加载的类分配内存空间，同时给类的static变量分配内存空间，并设置默认值0。<br>clint()</p>\n</li>\n<li><p>解析</p>\n<p>把符号引用替换为直接引用。</p>\n</li>\n</ul>\n</li>\n<li><p>初始化</p>\n<p>为类变量赋值：静态方法，静态变量，静态块。<br>初始化一个类的时候，如果发现有父类还没初始化，会先初始化他的父类。</p>\n</li>\n</ul>\n<h3 id=\"类加载器\"><a href=\"#类加载器\" class=\"headerlink\" title=\"类加载器\"></a>类加载器</h3><ul>\n<li><p>加载器</p>\n<ul>\n<li><p>BootStrap ClassLoader</p>\n<p>加载lib目录下的类库</p>\n</li>\n<li><p>Extension ClassLoader</p>\n<p>加载lib\\ext目录下的类库</p>\n</li>\n<li><p>Application ClassLoader</p>\n<p>加载ClassPath下的类</p>\n</li>\n<li><p>自定义加载器</p>\n</li>\n</ul>\n</li>\n<li><p>双亲委派机制</p>\n<p>先找父亲加载，加载不了再找儿子加载</p>\n</li>\n</ul>\n<h2 id=\"内存结构\"><a href=\"#内存结构\" class=\"headerlink\" title=\"内存结构\"></a>内存结构</h2><h3 id=\"方法区、元空间、永久代\"><a href=\"#方法区、元空间、永久代\" class=\"headerlink\" title=\"方法区、元空间、永久代\"></a>方法区、元空间、永久代</h3><p>存放类的定义，常量池等。<br>matespace满后会触发Full GC。<br>方法区垃圾回收：<br>1.该类的所有实例已经被回收<br>2.加载该类的ClassLoader已经被回收<br>3.该类的Class对象没有被任何引用</p>\n<h3 id=\"程序技术器\"><a href=\"#程序技术器\" class=\"headerlink\" title=\"程序技术器\"></a>程序技术器</h3><p>记录当前执行的字节码指令的位置。<br>线程私有。</p>\n<h3 id=\"Java虚拟机栈\"><a href=\"#Java虚拟机栈\" class=\"headerlink\" title=\"Java虚拟机栈\"></a>Java虚拟机栈</h3><p>保存方法信息。<br>线程私有。</p>\n<ul>\n<li><p>栈帧</p>\n<ul>\n<li>局部变量表</li>\n<li>操作数栈</li>\n<li>动态链接</li>\n<li>方法返回地址</li>\n<li>其他</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Java堆内存\"><a href=\"#Java堆内存\" class=\"headerlink\" title=\"Java堆内存\"></a>Java堆内存</h3><p>存放类的实例对象。</p>\n<ul>\n<li><p>分代</p>\n<ul>\n<li><p>年轻代</p>\n<p>新生代进入老年代：默认15次</p>\n<ul>\n<li><p>Eden区</p>\n<p>默认新生代80%空间。<br>新建对象产生在Eden区。<br>Eden区满后会发生Minor GC。</p>\n</li>\n<li><p>Survivor0,1区</p>\n<p>默认年轻代20%。Survivor 0:10%  Survivor 1:10%。<br>默认对象幸存15次后，会进入老年区。</p>\n<ul>\n<li><p>动态年龄判断</p>\n<p>当一批对象的大小大于Survivor区大小的50%，这批对象将不询问年龄，直接进入老年代。</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>老年代</p>\n<ul>\n<li><p>进入老年代的规则</p>\n<ul>\n<li>年龄超过MaxTenuring</li>\n<li>动态年龄判断</li>\n<li>超过PretenureSize的大对象</li>\n<li>Eden区幸存对象超过Survivor区大小</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>JVM参数</p>\n<ul>\n<li><p>-Xms</p>\n<p>Java堆内存的大小</p>\n</li>\n<li><p>-Xmx</p>\n<p>Java堆内存的最大大小</p>\n</li>\n<li><p>-Xmn</p>\n<p>Java对内存中的新生代大小。<br>老年代=总大小-新生代</p>\n</li>\n<li><p>-XX:PermSize</p>\n<p>永久代大小</p>\n</li>\n<li><p>-XX:MaxPermSize</p>\n<p>永久代最大大小</p>\n</li>\n<li><p>-XX:MetaspaceSize</p>\n<p>元空间大小</p>\n</li>\n<li><p>-XX:MaxMetaspaceSize</p>\n<p>元空间最大大小</p>\n</li>\n<li><p>-Xss</p>\n<p>Java栈内存大小</p>\n</li>\n<li><p>-XX:MaxTenuringThreshold</p>\n<p>对象在年轻代中幸存的最大轮数。<br>默认15，且不能超过15.</p>\n</li>\n<li><p>-XX:PretenureSizeThreshold</p>\n<p>当对象大小超过该值时，对象直接进入老年代，不会进过年轻代。<br>避免大对象在Survivor中多次复制，减少无谓的操作。</p>\n</li>\n<li><p>-XX:-HandlePromotionFailure</p>\n<p>判断老年代内存大小是否大于之前每一次Minor GC后进入老年代的对象的平均大小。<br>判断失败进行Full GC，再执行Minor GC。</p>\n</li>\n<li><p>-XX:SurvivorRatio</p>\n<p>调整Eden区和Survivor区内存比率</p>\n<ul>\n<li>XX:SurvivorRatio=8  ： Eden 80%</li>\n</ul>\n</li>\n<li><p>-XX:+PrintGCDetils</p>\n<p>打印详细的GC日志。</p>\n</li>\n<li><p>-XX:+PrintGCTimeStamps</p>\n<p>打印GC发生的时间。</p>\n</li>\n<li><p>-Xloggc:gc.log</p>\n<p>将CG日志输入到文件。</p>\n</li>\n<li><p>-XX:TraceClassLoading</p>\n<p>追踪加载的类</p>\n</li>\n<li><p>-XX:TraceClassUnloading</p>\n<p>追踪卸载的类</p>\n</li>\n<li><p>-XX:+HeapDumpOnOutOfMemoryError  </p>\n<p>OOM时自动dump快照</p>\n</li>\n<li><p>-XX:HeapDumpPath=/usr/local/app/oom</p>\n<p>将快照存放至指定目录</p>\n</li>\n<li><p>CMS</p>\n<ul>\n<li><p>-XX:CMSInitiatingOccupancyFaction</p>\n<p>设置老年代占用多少比例时触发CMS</p>\n</li>\n<li><p>-XX:+UseCMSCompactAtFullCollection</p>\n<p>Full GC后STW，整理内存碎片。</p>\n</li>\n<li><p>-XX:CMSFullGCsBeforeCompaction</p>\n<p>默认0，设置多少次Full GC后进行内存碎片整理。</p>\n</li>\n<li><p>-XX:+CMSParallelInitialMarkEnabled</p>\n<p>初始标记阶段开启并发执行</p>\n</li>\n</ul>\n</li>\n<li><p>G1</p>\n<ul>\n<li><p>-XX:+UseG1GC</p>\n<p>指定G1垃圾回收器。</p>\n</li>\n<li><p>-XX:G1HeapRegionSize</p>\n<p>手动指定G1的Region的大小。</p>\n</li>\n<li><p>-XX:G1NewSizePercent</p>\n<p>调整新生代在堆中的占比。<br>默认5%。</p>\n</li>\n<li><p>-XX:G1MaxNewSizePercent</p>\n<p>新生代占比堆空间的最大大小。</p>\n</li>\n<li><p>-XX:MaxGCPauseMills</p>\n<p>默认200ms。<br>设置G1垃圾回收器GC时的最大停顿时间。</p>\n</li>\n<li><p>-XX:InitiatingHeapOccupancyPercent</p>\n<p>默认45%。<br>老年代占据的堆内存超多该值，将会进行新老生代的混合回收。</p>\n</li>\n<li><p>-XX:G1MixedGCCountTarget</p>\n<p>一次G1混合回收过程中，最后阶段混合回收阶段分几次完成。<br>默认8。</p>\n</li>\n<li><p>-XX:G1HeapWastePercent</p>\n<p>默认值5%。<br>混合回收阶段中，空间Region占比堆空间超多该值，会停止混合回收。</p>\n</li>\n<li><p>-XX:G1MixedGCLiveThresholdPercent</p>\n<p>默认值85%。<br>一个Region中的存活对象低于该值时才会被回收。</p>\n</li>\n<li><p>-XX:+CMSScavengeBeforeRemark</p>\n<p>重新标记前，尽量执行一次Young GC。<br>提前回收年轻代没有引用的对象，减少重新标记扫描的对象数，提高效率。</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>垃圾回收</p>\n<ul>\n<li><p>可达性分析</p>\n<p>对一个对象层层向上分析，判断是否有一个GC Root。</p>\n<ul>\n<li><p>GC Root</p>\n<ul>\n<li>本地变量表中的局部变量</li>\n<li>方法区内的静态变量</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>java 引用类型</p>\n<ul>\n<li><p>强引用</p>\n<p>GC不会回收强引用</p>\n</li>\n<li><p>软引用</p>\n<p>内存空间足够时，GC不会回收软引用</p>\n</li>\n<li><p>弱引用</p>\n<p>GC时必定回收弱引用</p>\n</li>\n<li><p>虚引用</p>\n<p>继承Object的finalize()方法，在该对象被回收的时候通知自己。</p>\n</li>\n</ul>\n</li>\n<li><p>垃圾回收算法</p>\n<ul>\n<li><p>年轻代</p>\n<ul>\n<li><p>复制</p>\n<p>在新生代幸存者0,1区使用。将标记为可用的内存复制到另外一片连续的内存区域中，并删除当前内存区域中的全部数据。</p>\n<ul>\n<li><p>优点</p>\n<p>不会产生内存碎片</p>\n</li>\n<li><p>缺点</p>\n<p>增加内存的消耗</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>老年代</p>\n<ul>\n<li><p>标记整理</p>\n<p>标记存活对象，删除死亡对象，整理内存碎片。</p>\n<ul>\n<li><p>优点</p>\n<p>不会产生内存碎片。内存利用率高。</p>\n</li>\n<li><p>缺点</p>\n<p>比起标记清楚，执行效率慢。</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>JVM垃圾回收器</p>\n<ul>\n<li><p>年轻代</p>\n<ul>\n<li><p>ParNew</p>\n<p>多线程，复制算法。<br>开启：-XX:+UseParNewGC<br>调整回收线程数：-XX:ParallelGCThreads</p>\n</li>\n</ul>\n</li>\n<li><p>老年代</p>\n<ul>\n<li><p>CMS</p>\n<p>标记清理算法</p>\n<ul>\n<li><p>回收过程</p>\n<ul>\n<li><p>初始标记</p>\n<p>STW。<br>标记所有GC Roots直接引用的对象，被直接引用的对象所引用的对象不会被标记。</p>\n</li>\n<li><p>并发标记</p>\n<p>寻找被GC Roots间接引用的对象。</p>\n</li>\n<li><p>重新标记</p>\n<p>STW。<br>重新标记并发标记时产生的新对象。</p>\n</li>\n<li><p>并发清除</p>\n<p>清理标记的对象。</p>\n</li>\n</ul>\n</li>\n<li><p>缺点</p>\n<p>默认启动垃圾回收线程：（CPU核数 +3）/4。<br>本身会消耗CPU资源。<br>针对浮动垃圾，初始标记后产生的垃圾没法回收。<br>CMS回收期间，新生代进入老年代对象大于可用空间时，会发生Concurrent Mode Failure ，并自动使用Serial Old回收器替代CMS工作。</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>G1</p>\n<p>基于复制算法。<br>把Java堆内存划分为多个大小相等的Region。<br>可以设置STW的时间，追踪每个Region里可回收对象的预估时间。<br>G1中的分代是逻辑上的分代，同一个Region会随着分配的内存对象不同，而属于不同分代。<br>每个Region的大小：堆大小/2048。<br>新生代的Region同时分Eden和Survivor，可通过-XX:SurvivorRatio调整占比。<br>适合大内存的机器，G1可以设置停顿时间，来确保对服务不会有较大的影响。</p>\n<ul>\n<li><p>大对象</p>\n<p>超多Region大小50%即为大对象。<br>大对象可能横跨多个Region。<br>空的Region都可以存放大对象。<br>新老生代GC时都会回收大对象。</p>\n</li>\n<li><p>回收过程</p>\n<ul>\n<li><p>初始标记</p>\n<p>STW。<br>标记所有GC Roots直接引用的对象，被直接引用的对象所引用的对象不会被标记。</p>\n</li>\n<li><p>并发标记</p>\n<p>进行GC Roots的追踪，追踪所有存活对象。<br>同时JVM会记录该阶段中新建或失去引用的对象。</p>\n</li>\n<li><p>最终标记</p>\n<p>STW。<br>通过多并发标记中JVM堆新增或失去引用的对象，进行重新标记。</p>\n</li>\n<li><p>混合回收</p>\n<p>分析Region大小，执行效率。<br>STW。<br>在指定时间内进行回收。</p>\n</li>\n</ul>\n</li>\n<li><p>问题</p>\n<p>回收中发现Region空间不够时，将会SWT，并单线程进行标记、清除、整理，效率很低。</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>CG触发时间</p>\n<ul>\n<li><p>Minor GC</p>\n<p>Eden区满时采用复制算法。</p>\n</li>\n<li><p>Old GC</p>\n<p>1.老年代连续可用空间 &lt; 新生代历次GC后升入老年代对象内存和的平均大小。<br>2.老年代不够存放，Minor GC后升入老年代的对象时。<br>3.老年代内存使用率超过92%时（可设置）。</p>\n</li>\n<li><p>永久代GC</p>\n<p>永久代不够使产生Full GC。</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"本地方法栈\"><a href=\"#本地方法栈\" class=\"headerlink\" title=\"本地方法栈\"></a>本地方法栈</h3><p>存放native方法。</p>\n<h3 id=\"堆外内存空间\"><a href=\"#堆外内存空间\" class=\"headerlink\" title=\"堆外内存空间\"></a>堆外内存空间</h3><p>通过调用操作系统接口，直接分配对外内存空间。<br>NIO-&gt;allocateDirect(DirectByteBuffer)</p>\n<h2 id=\"工具\"><a href=\"#工具\" class=\"headerlink\" title=\"工具\"></a>工具</h2><h3 id=\"jstat\"><a href=\"#jstat\" class=\"headerlink\" title=\"jstat\"></a>jstat</h3><p>通过jps查找java进程，再用jstat -gc PID查看GC状况。</p>\n<ul>\n<li><p>指标</p>\n<ul>\n<li><p>S0C</p>\n<p>From Survivor区大小</p>\n</li>\n<li><p>S1C</p>\n<p>To Survivor区大小</p>\n</li>\n<li><p>S0U</p>\n<p>From Survivor区当前使用大小</p>\n</li>\n<li><p>S1U</p>\n<p>To Survivor区当前使用大小</p>\n</li>\n<li><p>EC</p>\n<p>Eden区大小</p>\n</li>\n<li><p>EU</p>\n<p>Eden区当前使用的大小</p>\n</li>\n<li><p>OC</p>\n<p>老年代的大小</p>\n</li>\n<li><p>OU</p>\n<p>老年代当前使用的大小</p>\n</li>\n<li><p>MC</p>\n<p>方法区（永久代、元空间）的大小</p>\n</li>\n<li><p>MU</p>\n<p>方法区（永久代、元空间）当前使用的大小</p>\n</li>\n<li><p>YGC</p>\n<p>系统迄今为止Young GC的次数</p>\n</li>\n<li><p>YGCT</p>\n<p>Young GC耗时</p>\n</li>\n<li><p>FGC</p>\n<p>系统迄今为止Full GC的次数</p>\n</li>\n<li><p>FGCT</p>\n<p>Full GC的耗时</p>\n</li>\n<li><p>GCT</p>\n<p>所有GC的总耗时</p>\n</li>\n</ul>\n</li>\n<li><p>命令</p>\n<ul>\n<li><p>jstat -gc PID</p>\n<p>查看GC状况</p>\n</li>\n<li><p>jstat -gccapacity PID</p>\n<p>堆内存分析</p>\n</li>\n<li><p>jstat -gcnew PID</p>\n<p>新生代分析</p>\n</li>\n<li><p>jstat -gcnewcapacity PID</p>\n<p>年轻代内存分析</p>\n</li>\n<li><p>jstat -gcold PID</p>\n<p>老年代GC分析</p>\n</li>\n<li><p>jstat -gcoldcapacity PID</p>\n<p>老年代内存分析</p>\n</li>\n<li><p>jstat -gcmetacapacity PID</p>\n<p>元数据内存分析</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"jmap\"><a href=\"#jmap\" class=\"headerlink\" title=\"jmap\"></a>jmap</h3><p>了解运行时的内存区域</p>\n<ul>\n<li><p>命令</p>\n<ul>\n<li><p>jmap -heap PID</p>\n<p>打印堆内存相关参数设置。<br>当前堆内各个区的基本情况。</p>\n</li>\n<li><p>jmap -histo PID</p>\n<p>按照对象在内存中占用大小排序，降序。<br>可以了解哪个对象在堆中占用了大量的空间。</p>\n</li>\n<li><p>jmap -dump:live,format=b,file=dump.hprof PID</p>\n<p>生成内存快照并输出到文件。</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"jhat\"><a href=\"#jhat\" class=\"headerlink\" title=\"jhat\"></a>jhat</h3><p>分析堆内存快照，可以使用工具内置的浏览器查看。</p>\n<ul>\n<li><p>命令</p>\n<ul>\n<li><p>jhat dump.hprof -port 7000</p>\n<p>分析快照文件dump.hprof ，访问端口7000。</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"MAT\"><a href=\"#MAT\" class=\"headerlink\" title=\"MAT\"></a>MAT</h3><p>内存分析工具</p>\n<h2 id=\"JVM优化总结\"><a href=\"#JVM优化总结\" class=\"headerlink\" title=\"JVM优化总结\"></a>JVM优化总结</h2><h3 id=\"调整新生代的大小\"><a href=\"#调整新生代的大小\" class=\"headerlink\" title=\"调整新生代的大小\"></a>调整新生代的大小</h3><p>尽量让每次Young GC后的存活对象⼩于Survivor区域的50%，都留存在年轻代⾥。尽量别让对象进 ⼊⽼年代。尽量减少Full GC的频率，避免频繁Full GC对JVM性能的影响</p>\n<h3 id=\"调整老年代碎片回收的频率\"><a href=\"#调整老年代碎片回收的频率\" class=\"headerlink\" title=\"调整老年代碎片回收的频率\"></a>调整老年代碎片回收的频率</h3><p>CMS一次Full GC会产生内存随便，调整碎片整理的触发轮数，可以有效的降低Full  GC产生的碎片从而降低Full GC的频次。</p>\n<h3 id=\"JVM参数模板\"><a href=\"#JVM参数模板\" class=\"headerlink\" title=\"JVM参数模板\"></a>JVM参数模板</h3><p>-Xms4096M -Xmx4096M -Xmn3072M -Xss1M -XX:MetaspaceSize=256M -XX:MaxMetaspaceSize=256M -XX:+UseParNewGC - XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFaction=92 -XX:+UseCMSCompactAtFullCollection - XX:CMSFullGCsBeforeCompaction=0 -XX:+CMSParallelInitialMarkEnabled -XX:+CMSScavengeBeforeRemark - XX:+DisableExplicitGC -XX:+PrintGCDetails -Xloggc:gc.log -XX:+HeapDumpOnOutOfMemoryError - XX:HeapDumpPath=/usr/local/app/oom</p>\n<h3 id=\"XX-SoftRefLRUPolicyMSPerMB\"><a href=\"#XX-SoftRefLRUPolicyMSPerMB\" class=\"headerlink\" title=\"-XX:SoftRefLRUPolicyMSPerMB\"></a>-XX:SoftRefLRUPolicyMSPerMB</h3><p>在有大量反射的情况下建议增大该值，保证软引用不会被马上回收</p>\n<h3 id=\"XX-DisableExplicitGC\"><a href=\"#XX-DisableExplicitGC\" class=\"headerlink\" title=\"-XX:+DisableExplicitGC\"></a>-XX:+DisableExplicitGC</h3><p>禁止显示执行GC<br>性质System.gc()</p>\n<h3 id=\"使用缓存淘汰机制\"><a href=\"#使用缓存淘汰机制\" class=\"headerlink\" title=\"使用缓存淘汰机制\"></a>使用缓存淘汰机制</h3><p>避免本地缓存无限增大，使得老年代常驻对象无法回收，从而导致的内存溢出和频繁的Full GC。</p>\n<h3 id=\"频繁Full-GC的可能原因\"><a href=\"#频繁Full-GC的可能原因\" class=\"headerlink\" title=\"频繁Full GC的可能原因\"></a>频繁Full GC的可能原因</h3><p>1.系统压力大，频繁Young GC后存活对象大于Survivor区，导致直接进入老年代。<br>2.频繁产生大对象。<br>3.对象始终不释放，导致内存泄漏。<br>4.方法区频繁有类反射加载。<br>5.错误使用System.gc()。</p>\n<p><em>XMind: ZEN - Trial Version</em></p>"},{"title":"NIO","date":"2020-01-29T12:52:57.000Z","_content":"\n## Buffer\n\n负责数据的存取。缓冲区及时数组。用于存储不同数据类型的数据。（boolean除外）\n通过allocate()获取缓冲区\nput()，get()\n缓冲区中的核心属性\ncapacity:容量，表示缓冲区中最大存储数据的容量。一旦申明不能改变。\nlimit:界限，表示缓冲区中可以操作数据的大小。limit后端的数据不能进行读写。\nposition:位置，表示缓冲区中正在操作的位置。\n0<=mark<=posiotion<=limit<=capacity\nflip() 切换读取数据模式\nrewind() 可重复读\nclear()清空缓冲区，数据并没有被清空\nmark:标记，表示记录当前position的位置。可以通过reset()恢复到mark的位置。\nhasRemaining()：缓冲区中是否还有剩余的数据\n<!-- more -->\n### 实现类\n\n- ByteBuffer\n- CharBuffer\n- ShortBuffer\n- IntBuffer\n- LongBuffer\n- FloatBuffer\n- DoubleBuffer\n\n### 直接缓冲区&非直接缓冲区\n\n可以通过isDirect()判断是否为直接缓冲区&非直接缓冲区\n\n- 直接缓冲区(物理内存映射文件)\n\n  通过allocateDirec()方法分配直接缓冲区，将缓冲区建立在物理内存中。\n  可以提高执行效率。\n  \n  物理磁盘-内核地址空间-物理内存映射文件-用户地址空间-应用程序\n\n- 非直接缓冲区\n\n  通过allocatie()方法分配缓冲区，将缓冲区建立在JVM的内存中。\n  \n  磁盘-内核地址空间-用户地址空间-应用程序\n\n## Channel\n\n负责缓冲区中的数据传输。Channel本身不存储数据，因此需要配合缓冲区进行传输。 \n针对支持通道的泪提供了getChannel()方法：\n本地IO：\nFileInputStream/FileOutputStream\nRandomAccessFile\n网路IO：\nSocket\nSeverSocket\nDatagramSocket\n\n在JDK1.7中的NIO.2针对各个通道提供了静态方法open()\n咋JDK1.7中的NIO.2的Files工具类的newByteChannel()\n\n### 实现类\n\n- FileChannel\n- SocketChannel\n- ServerSocketChannel\n- DatagramChannel\n\n### 通道之间的数据传输\n\n- transferFrom()\n- transferTo()\n\n### 分散与聚集\n\n- 分散(Scatter)\n\n  分散读取(Scattering Reads)：将通道中的数据分散到多个缓冲区中\n\n- 聚集(Gather)\n\n  聚集写入(Gathering Writes)：将多个缓冲区中的数据聚集到通道中\n\n### 字符集(Charest)\n\n- 编码\n\n  字符串 -> 字节数组\n\n- 解码\n\n  字节数组 -> 字符串\n\n## Selector","source":"_posts/NIO.md","raw":"---\ntitle: NIO\ndate: 2020-01-29 20:52:57\ntags:\n    - Java\n    - IO\ncategories:\n    - Technology\n---\n\n## Buffer\n\n负责数据的存取。缓冲区及时数组。用于存储不同数据类型的数据。（boolean除外）\n通过allocate()获取缓冲区\nput()，get()\n缓冲区中的核心属性\ncapacity:容量，表示缓冲区中最大存储数据的容量。一旦申明不能改变。\nlimit:界限，表示缓冲区中可以操作数据的大小。limit后端的数据不能进行读写。\nposition:位置，表示缓冲区中正在操作的位置。\n0<=mark<=posiotion<=limit<=capacity\nflip() 切换读取数据模式\nrewind() 可重复读\nclear()清空缓冲区，数据并没有被清空\nmark:标记，表示记录当前position的位置。可以通过reset()恢复到mark的位置。\nhasRemaining()：缓冲区中是否还有剩余的数据\n<!-- more -->\n### 实现类\n\n- ByteBuffer\n- CharBuffer\n- ShortBuffer\n- IntBuffer\n- LongBuffer\n- FloatBuffer\n- DoubleBuffer\n\n### 直接缓冲区&非直接缓冲区\n\n可以通过isDirect()判断是否为直接缓冲区&非直接缓冲区\n\n- 直接缓冲区(物理内存映射文件)\n\n  通过allocateDirec()方法分配直接缓冲区，将缓冲区建立在物理内存中。\n  可以提高执行效率。\n  \n  物理磁盘-内核地址空间-物理内存映射文件-用户地址空间-应用程序\n\n- 非直接缓冲区\n\n  通过allocatie()方法分配缓冲区，将缓冲区建立在JVM的内存中。\n  \n  磁盘-内核地址空间-用户地址空间-应用程序\n\n## Channel\n\n负责缓冲区中的数据传输。Channel本身不存储数据，因此需要配合缓冲区进行传输。 \n针对支持通道的泪提供了getChannel()方法：\n本地IO：\nFileInputStream/FileOutputStream\nRandomAccessFile\n网路IO：\nSocket\nSeverSocket\nDatagramSocket\n\n在JDK1.7中的NIO.2针对各个通道提供了静态方法open()\n咋JDK1.7中的NIO.2的Files工具类的newByteChannel()\n\n### 实现类\n\n- FileChannel\n- SocketChannel\n- ServerSocketChannel\n- DatagramChannel\n\n### 通道之间的数据传输\n\n- transferFrom()\n- transferTo()\n\n### 分散与聚集\n\n- 分散(Scatter)\n\n  分散读取(Scattering Reads)：将通道中的数据分散到多个缓冲区中\n\n- 聚集(Gather)\n\n  聚集写入(Gathering Writes)：将多个缓冲区中的数据聚集到通道中\n\n### 字符集(Charest)\n\n- 编码\n\n  字符串 -> 字节数组\n\n- 解码\n\n  字节数组 -> 字符串\n\n## Selector","slug":"NIO","published":1,"updated":"2020-12-14T09:51:24.008Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71ht30008v252fd3b0ipn","content":"<html><head></head><body><h2 id=\"Buffer\"><a href=\"#Buffer\" class=\"headerlink\" title=\"Buffer\"></a>Buffer</h2><p>&#x8D1F;&#x8D23;&#x6570;&#x636E;&#x7684;&#x5B58;&#x53D6;&#x3002;&#x7F13;&#x51B2;&#x533A;&#x53CA;&#x65F6;&#x6570;&#x7EC4;&#x3002;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x4E0D;&#x540C;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x7684;&#x6570;&#x636E;&#x3002;&#xFF08;boolean&#x9664;&#x5916;&#xFF09;<br>&#x901A;&#x8FC7;allocate()&#x83B7;&#x53D6;&#x7F13;&#x51B2;&#x533A;<br>put()&#xFF0C;get()<br>&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x7684;&#x6838;&#x5FC3;&#x5C5E;&#x6027;<br>capacity:&#x5BB9;&#x91CF;&#xFF0C;&#x8868;&#x793A;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x6700;&#x5927;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x5BB9;&#x91CF;&#x3002;&#x4E00;&#x65E6;&#x7533;&#x660E;&#x4E0D;&#x80FD;&#x6539;&#x53D8;&#x3002;<br>limit:&#x754C;&#x9650;&#xFF0C;&#x8868;&#x793A;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x53EF;&#x4EE5;&#x64CD;&#x4F5C;&#x6570;&#x636E;&#x7684;&#x5927;&#x5C0F;&#x3002;limit&#x540E;&#x7AEF;&#x7684;&#x6570;&#x636E;&#x4E0D;&#x80FD;&#x8FDB;&#x884C;&#x8BFB;&#x5199;&#x3002;<br>position:&#x4F4D;&#x7F6E;&#xFF0C;&#x8868;&#x793A;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x6B63;&#x5728;&#x64CD;&#x4F5C;&#x7684;&#x4F4D;&#x7F6E;&#x3002;<br>0&lt;=mark&lt;=posiotion&lt;=limit&lt;=capacity<br>flip() &#x5207;&#x6362;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x6A21;&#x5F0F;<br>rewind() &#x53EF;&#x91CD;&#x590D;&#x8BFB;<br>clear()&#x6E05;&#x7A7A;&#x7F13;&#x51B2;&#x533A;&#xFF0C;&#x6570;&#x636E;&#x5E76;&#x6CA1;&#x6709;&#x88AB;&#x6E05;&#x7A7A;<br>mark:&#x6807;&#x8BB0;&#xFF0C;&#x8868;&#x793A;&#x8BB0;&#x5F55;&#x5F53;&#x524D;position&#x7684;&#x4F4D;&#x7F6E;&#x3002;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;reset()&#x6062;&#x590D;&#x5230;mark&#x7684;&#x4F4D;&#x7F6E;&#x3002;<br>hasRemaining()&#xFF1A;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x662F;&#x5426;&#x8FD8;&#x6709;&#x5269;&#x4F59;&#x7684;&#x6570;&#x636E;</p>\n<a id=\"more\"></a>\n<h3 id=\"&#x5B9E;&#x73B0;&#x7C7B;\"><a href=\"#&#x5B9E;&#x73B0;&#x7C7B;\" class=\"headerlink\" title=\"&#x5B9E;&#x73B0;&#x7C7B;\"></a>&#x5B9E;&#x73B0;&#x7C7B;</h3><ul>\n<li>ByteBuffer</li>\n<li>CharBuffer</li>\n<li>ShortBuffer</li>\n<li>IntBuffer</li>\n<li>LongBuffer</li>\n<li>FloatBuffer</li>\n<li>DoubleBuffer</li>\n</ul>\n<h3 id=\"&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;-amp-&#x975E;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;\"><a href=\"#&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;-amp-&#x975E;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;\" class=\"headerlink\" title=\"&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;&amp;&#x975E;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;\"></a>&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;&amp;&#x975E;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;</h3><p>&#x53EF;&#x4EE5;&#x901A;&#x8FC7;isDirect()&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;&amp;&#x975E;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;</p>\n<ul>\n<li><p>&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;(&#x7269;&#x7406;&#x5185;&#x5B58;&#x6620;&#x5C04;&#x6587;&#x4EF6;)</p>\n<p>&#x901A;&#x8FC7;allocateDirec()&#x65B9;&#x6CD5;&#x5206;&#x914D;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;&#xFF0C;&#x5C06;&#x7F13;&#x51B2;&#x533A;&#x5EFA;&#x7ACB;&#x5728;&#x7269;&#x7406;&#x5185;&#x5B58;&#x4E2D;&#x3002;<br>&#x53EF;&#x4EE5;&#x63D0;&#x9AD8;&#x6267;&#x884C;&#x6548;&#x7387;&#x3002;</p>\n<p>&#x7269;&#x7406;&#x78C1;&#x76D8;-&#x5185;&#x6838;&#x5730;&#x5740;&#x7A7A;&#x95F4;-&#x7269;&#x7406;&#x5185;&#x5B58;&#x6620;&#x5C04;&#x6587;&#x4EF6;-&#x7528;&#x6237;&#x5730;&#x5740;&#x7A7A;&#x95F4;-&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</p>\n</li>\n<li><p>&#x975E;&#x76F4;&#x63A5;&#x7F13;&#x51B2;&#x533A;</p>\n<p>&#x901A;&#x8FC7;allocatie()&#x65B9;&#x6CD5;&#x5206;&#x914D;&#x7F13;&#x51B2;&#x533A;&#xFF0C;&#x5C06;&#x7F13;&#x51B2;&#x533A;&#x5EFA;&#x7ACB;&#x5728;JVM&#x7684;&#x5185;&#x5B58;&#x4E2D;&#x3002;</p>\n<p>&#x78C1;&#x76D8;-&#x5185;&#x6838;&#x5730;&#x5740;&#x7A7A;&#x95F4;-&#x7528;&#x6237;&#x5730;&#x5740;&#x7A7A;&#x95F4;-&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</p>\n</li>\n</ul>\n<h2 id=\"Channel\"><a href=\"#Channel\" class=\"headerlink\" title=\"Channel\"></a>Channel</h2><p>&#x8D1F;&#x8D23;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x4F20;&#x8F93;&#x3002;Channel&#x672C;&#x8EAB;&#x4E0D;&#x5B58;&#x50A8;&#x6570;&#x636E;&#xFF0C;&#x56E0;&#x6B64;&#x9700;&#x8981;&#x914D;&#x5408;&#x7F13;&#x51B2;&#x533A;&#x8FDB;&#x884C;&#x4F20;&#x8F93;&#x3002;<br>&#x9488;&#x5BF9;&#x652F;&#x6301;&#x901A;&#x9053;&#x7684;&#x6CEA;&#x63D0;&#x4F9B;&#x4E86;getChannel()&#x65B9;&#x6CD5;&#xFF1A;<br>&#x672C;&#x5730;IO&#xFF1A;<br>FileInputStream/FileOutputStream<br>RandomAccessFile<br>&#x7F51;&#x8DEF;IO&#xFF1A;<br>Socket<br>SeverSocket<br>DatagramSocket</p>\n<p>&#x5728;JDK1.7&#x4E2D;&#x7684;NIO.2&#x9488;&#x5BF9;&#x5404;&#x4E2A;&#x901A;&#x9053;&#x63D0;&#x4F9B;&#x4E86;&#x9759;&#x6001;&#x65B9;&#x6CD5;open()<br>&#x548B;JDK1.7&#x4E2D;&#x7684;NIO.2&#x7684;Files&#x5DE5;&#x5177;&#x7C7B;&#x7684;newByteChannel()</p>\n<h3 id=\"&#x5B9E;&#x73B0;&#x7C7B;-1\"><a href=\"#&#x5B9E;&#x73B0;&#x7C7B;-1\" class=\"headerlink\" title=\"&#x5B9E;&#x73B0;&#x7C7B;\"></a>&#x5B9E;&#x73B0;&#x7C7B;</h3><ul>\n<li>FileChannel</li>\n<li>SocketChannel</li>\n<li>ServerSocketChannel</li>\n<li>DatagramChannel</li>\n</ul>\n<h3 id=\"&#x901A;&#x9053;&#x4E4B;&#x95F4;&#x7684;&#x6570;&#x636E;&#x4F20;&#x8F93;\"><a href=\"#&#x901A;&#x9053;&#x4E4B;&#x95F4;&#x7684;&#x6570;&#x636E;&#x4F20;&#x8F93;\" class=\"headerlink\" title=\"&#x901A;&#x9053;&#x4E4B;&#x95F4;&#x7684;&#x6570;&#x636E;&#x4F20;&#x8F93;\"></a>&#x901A;&#x9053;&#x4E4B;&#x95F4;&#x7684;&#x6570;&#x636E;&#x4F20;&#x8F93;</h3><ul>\n<li>transferFrom()</li>\n<li>transferTo()</li>\n</ul>\n<h3 id=\"&#x5206;&#x6563;&#x4E0E;&#x805A;&#x96C6;\"><a href=\"#&#x5206;&#x6563;&#x4E0E;&#x805A;&#x96C6;\" class=\"headerlink\" title=\"&#x5206;&#x6563;&#x4E0E;&#x805A;&#x96C6;\"></a>&#x5206;&#x6563;&#x4E0E;&#x805A;&#x96C6;</h3><ul>\n<li><p>&#x5206;&#x6563;(Scatter)</p>\n<p>&#x5206;&#x6563;&#x8BFB;&#x53D6;(Scattering Reads)&#xFF1A;&#x5C06;&#x901A;&#x9053;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x5206;&#x6563;&#x5230;&#x591A;&#x4E2A;&#x7F13;&#x51B2;&#x533A;&#x4E2D;</p>\n</li>\n<li><p>&#x805A;&#x96C6;(Gather)</p>\n<p>&#x805A;&#x96C6;&#x5199;&#x5165;(Gathering Writes)&#xFF1A;&#x5C06;&#x591A;&#x4E2A;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x805A;&#x96C6;&#x5230;&#x901A;&#x9053;&#x4E2D;</p>\n</li>\n</ul>\n<h3 id=\"&#x5B57;&#x7B26;&#x96C6;-Charest\"><a href=\"#&#x5B57;&#x7B26;&#x96C6;-Charest\" class=\"headerlink\" title=\"&#x5B57;&#x7B26;&#x96C6;(Charest)\"></a>&#x5B57;&#x7B26;&#x96C6;(Charest)</h3><ul>\n<li><p>&#x7F16;&#x7801;</p>\n<p>&#x5B57;&#x7B26;&#x4E32; -&gt; &#x5B57;&#x8282;&#x6570;&#x7EC4;</p>\n</li>\n<li><p>&#x89E3;&#x7801;</p>\n<p>&#x5B57;&#x8282;&#x6570;&#x7EC4; -&gt; &#x5B57;&#x7B26;&#x4E32;</p>\n</li>\n</ul>\n<h2 id=\"Selector\"><a href=\"#Selector\" class=\"headerlink\" title=\"Selector\"></a>Selector</h2></body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"IO","path":"tags/IO/"}],"excerpt":"<html><head></head><body><h2 id=\"Buffer\"><a href=\"#Buffer\" class=\"headerlink\" title=\"Buffer\"></a>Buffer</h2><p>&#x8D1F;&#x8D23;&#x6570;&#x636E;&#x7684;&#x5B58;&#x53D6;&#x3002;&#x7F13;&#x51B2;&#x533A;&#x53CA;&#x65F6;&#x6570;&#x7EC4;&#x3002;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x4E0D;&#x540C;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x7684;&#x6570;&#x636E;&#x3002;&#xFF08;boolean&#x9664;&#x5916;&#xFF09;<br>&#x901A;&#x8FC7;allocate()&#x83B7;&#x53D6;&#x7F13;&#x51B2;&#x533A;<br>put()&#xFF0C;get()<br>&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x7684;&#x6838;&#x5FC3;&#x5C5E;&#x6027;<br>capacity:&#x5BB9;&#x91CF;&#xFF0C;&#x8868;&#x793A;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x6700;&#x5927;&#x5B58;&#x50A8;&#x6570;&#x636E;&#x7684;&#x5BB9;&#x91CF;&#x3002;&#x4E00;&#x65E6;&#x7533;&#x660E;&#x4E0D;&#x80FD;&#x6539;&#x53D8;&#x3002;<br>limit:&#x754C;&#x9650;&#xFF0C;&#x8868;&#x793A;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x53EF;&#x4EE5;&#x64CD;&#x4F5C;&#x6570;&#x636E;&#x7684;&#x5927;&#x5C0F;&#x3002;limit&#x540E;&#x7AEF;&#x7684;&#x6570;&#x636E;&#x4E0D;&#x80FD;&#x8FDB;&#x884C;&#x8BFB;&#x5199;&#x3002;<br>position:&#x4F4D;&#x7F6E;&#xFF0C;&#x8868;&#x793A;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x6B63;&#x5728;&#x64CD;&#x4F5C;&#x7684;&#x4F4D;&#x7F6E;&#x3002;<br>0&lt;=mark&lt;=posiotion&lt;=limit&lt;=capacity<br>flip() &#x5207;&#x6362;&#x8BFB;&#x53D6;&#x6570;&#x636E;&#x6A21;&#x5F0F;<br>rewind() &#x53EF;&#x91CD;&#x590D;&#x8BFB;<br>clear()&#x6E05;&#x7A7A;&#x7F13;&#x51B2;&#x533A;&#xFF0C;&#x6570;&#x636E;&#x5E76;&#x6CA1;&#x6709;&#x88AB;&#x6E05;&#x7A7A;<br>mark:&#x6807;&#x8BB0;&#xFF0C;&#x8868;&#x793A;&#x8BB0;&#x5F55;&#x5F53;&#x524D;position&#x7684;&#x4F4D;&#x7F6E;&#x3002;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;reset()&#x6062;&#x590D;&#x5230;mark&#x7684;&#x4F4D;&#x7F6E;&#x3002;<br>hasRemaining()&#xFF1A;&#x7F13;&#x51B2;&#x533A;&#x4E2D;&#x662F;&#x5426;&#x8FD8;&#x6709;&#x5269;&#x4F59;&#x7684;&#x6570;&#x636E;</p></body></html>","more":"<h3 id=\"实现类\"><a href=\"#实现类\" class=\"headerlink\" title=\"实现类\"></a>实现类</h3><ul>\n<li>ByteBuffer</li>\n<li>CharBuffer</li>\n<li>ShortBuffer</li>\n<li>IntBuffer</li>\n<li>LongBuffer</li>\n<li>FloatBuffer</li>\n<li>DoubleBuffer</li>\n</ul>\n<h3 id=\"直接缓冲区-amp-非直接缓冲区\"><a href=\"#直接缓冲区-amp-非直接缓冲区\" class=\"headerlink\" title=\"直接缓冲区&amp;非直接缓冲区\"></a>直接缓冲区&amp;非直接缓冲区</h3><p>可以通过isDirect()判断是否为直接缓冲区&amp;非直接缓冲区</p>\n<ul>\n<li><p>直接缓冲区(物理内存映射文件)</p>\n<p>通过allocateDirec()方法分配直接缓冲区，将缓冲区建立在物理内存中。<br>可以提高执行效率。</p>\n<p>物理磁盘-内核地址空间-物理内存映射文件-用户地址空间-应用程序</p>\n</li>\n<li><p>非直接缓冲区</p>\n<p>通过allocatie()方法分配缓冲区，将缓冲区建立在JVM的内存中。</p>\n<p>磁盘-内核地址空间-用户地址空间-应用程序</p>\n</li>\n</ul>\n<h2 id=\"Channel\"><a href=\"#Channel\" class=\"headerlink\" title=\"Channel\"></a>Channel</h2><p>负责缓冲区中的数据传输。Channel本身不存储数据，因此需要配合缓冲区进行传输。<br>针对支持通道的泪提供了getChannel()方法：<br>本地IO：<br>FileInputStream/FileOutputStream<br>RandomAccessFile<br>网路IO：<br>Socket<br>SeverSocket<br>DatagramSocket</p>\n<p>在JDK1.7中的NIO.2针对各个通道提供了静态方法open()<br>咋JDK1.7中的NIO.2的Files工具类的newByteChannel()</p>\n<h3 id=\"实现类-1\"><a href=\"#实现类-1\" class=\"headerlink\" title=\"实现类\"></a>实现类</h3><ul>\n<li>FileChannel</li>\n<li>SocketChannel</li>\n<li>ServerSocketChannel</li>\n<li>DatagramChannel</li>\n</ul>\n<h3 id=\"通道之间的数据传输\"><a href=\"#通道之间的数据传输\" class=\"headerlink\" title=\"通道之间的数据传输\"></a>通道之间的数据传输</h3><ul>\n<li>transferFrom()</li>\n<li>transferTo()</li>\n</ul>\n<h3 id=\"分散与聚集\"><a href=\"#分散与聚集\" class=\"headerlink\" title=\"分散与聚集\"></a>分散与聚集</h3><ul>\n<li><p>分散(Scatter)</p>\n<p>分散读取(Scattering Reads)：将通道中的数据分散到多个缓冲区中</p>\n</li>\n<li><p>聚集(Gather)</p>\n<p>聚集写入(Gathering Writes)：将多个缓冲区中的数据聚集到通道中</p>\n</li>\n</ul>\n<h3 id=\"字符集-Charest\"><a href=\"#字符集-Charest\" class=\"headerlink\" title=\"字符集(Charest)\"></a>字符集(Charest)</h3><ul>\n<li><p>编码</p>\n<p>字符串 -&gt; 字节数组</p>\n</li>\n<li><p>解码</p>\n<p>字节数组 -&gt; 字符串</p>\n</li>\n</ul>\n<h2 id=\"Selector\"><a href=\"#Selector\" class=\"headerlink\" title=\"Selector\"></a>Selector</h2>"},{"title":"Spring Boot","date":"2020-01-29T12:57:11.000Z","_content":"\n## 容器\n\n### IOC\n<!-- more -->\nspring-context\n\n- @Configuration\n\n  告诉Spring这是一个配置类\n\n- @Bean\n\n  给容器中注册一个Bean，类型为返回值的类型，id默认是用方法\n  默认都是单例\n\n- AnnotationConfigApplicationContext\n- @ComponetScan、@ComponetScans\n\n  value：扫描@Service @Controller @Repositroy @Componet\n  excludeFlters：排除的规则\n  includeFilters：只需要包含的规则\n\n\t- FilterType.ANNOTATION\n\n\t  按照注解\n\n\t- FilterType.ASSIGNABLE_TYPE\n\n\t  按照给定类型\n\n\t- FilterType.ASPECTJ\n\n\t  使用ASPECTJ表达式\n\n\t- FilterType.REGEX\n\n\t  使用正则指定\n\n\t- FilterType.CUSTOM\n\n\t  自定义规则，必须实现TypeFilter类\n\n- @Scope\n\n\t- SCOPE_PROTOTPE\n\n\t  多实例\n\t  IOC容器启动不回去调用方法床架你对象，获取的时候创建对象\n\n\t- SCOPE_SINGLETON\n\n\t  单实例（默认值）\n\t  IOC容器启动会调用方法创建对象放到IOC容器中\n\n\t- SCOPE_REQUEST\n\n\t  同一次请求创建一个实例\n\n\t- SCOPE_SESSION\n\n\t  同一个Session创建一个实例\n\n- @Lazy \n\n  懒加载：容器启动不创建对象。第一次使用（获取）Bean对象时调用创建对象放入容器\n\n- @Conditional\n\n  按照一定的条件进行判断，满足条件给容器中注册Bean\n  需要实现Condition 接口：ConditionContext 判断条件能使用的上下文；AnnotatedTypeMetadate 注释信息\n\n- @Import\n\n  导入组件，id默认是组件的全类名（com.xxx.xxx.xx）\n\n\t- ImportSelector\n\n\t  自定义逻辑返回需要导入的组件。\n\t  返回值就是导入到容器中的组件全类名，方法不要返回null。\n\t  AnnotationMetadata 当前标注@Import注解的类的所有注释信息。\n\n\t- ImportBeanDefinitionRegistrar\n\n\t  BeanDefinitionRegistry：BeanDefinition注册类。\n\t  调用registerBeanDefinition手工注册Bean\n\n- FactoryBean\n\n  实现FactoryBean接口\n  1.工厂Bean获取的是调用getObject创建的对象\n  2.要获取工程Bean本身，需要给id前面加一个&\n\n### bean的生命周期\n\n- 初始化\n\n\t- @Bean(initMethod)\n\t- InitializingBean\n\n\t  通过让Bean实现该接口，实现Bean初始化逻辑\n\n\t- @PostConstruct\n\t- BeanPostProcessor\n\n\t  Bean后置处理器，在Bean初始化前后进行一些处理工作\n\n\t\t- postProcessBeforeInitialization\n\n\t\t  在初始化之前\n\n\t\t- postProcessAfterInitialization\n\n\t\t  在初始化工作之后\n\n\t\t- ApplicationContextAwareProcessor\n\n\t\t  实现该接口，Spring容器可以将当前容器传给实现类\n\n\t\t- InitDestroyAnnotationBeanPostProcessor\n\n\t\t  处理@PostConstruct，@PreDestory注解\n\n\t\t- AutowiredAnnotationBeanPostProcessor\n\n\t\t  处理@Autowired注解\n\n- 销毁\n\n\t- @Bean(destroyMethod)\n\n\t  多实例的bean，容器不会调用销毁方法\n\n\t- DisposableBean\n\n\t  通过实现该接口，实现销毁逻辑\n\n\t- @PreDestory\n\n### 属性赋值\n\n- @Value\n\n\t- 基本数值\n\t- SpEL  #{}\n\t- 配置文件 ${}\n\n\t  @PropertySource 读取外部配置文件，保存至环境变量中\n\n### 自动装配\n\n- @Autowired\n\n  1.默认按照类型在容器中找相应的组件\n  2.如果找到多个相同类型的组件，再将属性的名称作为组件的id组容易中寻找\n  3.使用@Qualifier指定需要装配的组件的id\n  4.自动装配默认一定要指定存在的属性（如果不强制指定，使用require=false）\n  5.@Primary,让Spring进行自动装配的时候，默认是用首选的bean\n\n\t- 构造器\n\n\t  构造器用到的自定义类型的值从IOC容器中获取\n\t  如果组建只有一个有参构造器，这个有参构造器的@Autowired可以省略，参数位置的组件还是可以从容器中获取\n\n\t- 方法\n\n\t  标注在方法，Spring容器创建当前对象，就会调用方法完成赋值\n\t  方法使用的参数，自定义类型的值从IOC容器中获取\n\n\t- 属性\n\n\t  值从IOC容器中获取\n\n- @Resource\n\n  可以和@Autowired一样实现自动装配，默认按照属性名称进行装配\n  没有支持@Primary功能，reqiured=false\n\n- @Inject\n\n  需要依赖javax.inject包，和Autowired一样，没有reqiured=false\n\n- 实现xxxAware接口\n\n  在创建对象的时候，会调用接口的回调方法\n  把Spring底层的组件注册到自定义的Bean中\n  xxxAware功能使用xxxProcessor处理的\n\n\t- ApplicationContextAware\n\n\t  获取ApplicationContext\n\n\t- BeanNameAware\n\t- EmbeddedValueResolverAware\n\n- Profile\n\n  加了环境表示的bean，只有这个环境被激活的时候才能注册到容器中，默认是default环境\n\n\t- 启动参数\n\n\t  -Dspring.profiles.active=xxx\n\n\t- 代码\n\n\t  1.创建一个aplicationContext\n\t  2.设置需要激活的环境.getEnvironment().setActiveProfiles()\n\t  3.注册朱配置类  .register()\n\t  4.启动刷新容器 .refresh()\n\n### AOP\n\n在程序运行期间动态的将某段代码切入到指定方法指定位置进行运行的编程方式\nspring-aspects\n容器中保存了组建的代理对象(cglib增强后的对象),这个对象里面保存了详细信息(比如增强器，目标对象)\n\n- @Before\n\n  在目标方法之前切入：切入点表达式（指定在那个方法切入）\n\n- @After\n\n  在目标方法之后切入：切入点表达式\n\n- @PointCut\n\n  切入点表达式\n\n- @AfterReturning\n\n  再放标方法正常返回之后运行\n\n- @AfterThrowing\n\n  在目标方法出现异常之后运行\n\n- @Aspect\n\n  告诉Spring当前类是一个切面类\n\n- @EnableAspectJAutoProxy\n\n  开启基于注解的AOP\n  1.给容器中导入AspectJAutoProxyRegistrar，给容器中注册一个AnnotationAwareAspectJAutoProxyCreator\n\n\t- AnnotationAwareAspectJAutoProxyCreator\n\n\t\t- AspectJAwareAdvisorAutoProxyCreator\n\n\t\t\t- AbstractAdvisorAutoProxyCreator\n\n\t\t\t\t- AbstractAutoProxyCreator\n\n\t\t\t\t\t- SmartInstantiationAwareBeanPostProcessor\n\t\t\t\t\t- BeanFactroyAware\n\n- JoinPoint\n\n  JoinPoint一定要出现在参数表的第一位\n\n- 目标方法执行\n\n  1.CglibAopProxy.intercept()。拦截目标方法的执行。\n  2.根据PoxyFactory对象获取将要执行的目标方法拦截器链\n  \ta)如果没有拦截器链，直接执行目标方法\n  \tb)如果有拦截器链，把需要执行的目标对象，目标方法，拦截器链等信息出入创建一个CglibMethodInvocation，并调用proceed()方法\n  \tc)拦截器链触发过程\n  \t\t1.如果没有拦截器执行目标方法，或者懒机器的索引和拦截器数组-1大小一样(指定到了最后一个拦截器)，执行目标方法。\n\n### 声明式事务\n\n1.导入相关依赖spring-jdbc\n2.配置数据源 JdbcTmplate\n3.给方法标注@Transactional\n4.@EnableTransactionManagement 开启基于注解的事物\n5.配置事物管理器管理事物\n\n- @Transactional\n- @EnableTransactionManagement\n\n\t- TransactionManagementConfigurationSelection\n\n\t  给容器中导入组件\n\n\t\t- AutoProxyRegistrar\n\n\t\t  给容器中注册InfrastructureAdvisorAutoProxyCreator组件\n\n\t\t\t- InfrastructureAdvisorAutoProxyCreator\n\n\t\t\t  利用后置处理器机制在对象创建后，包装对象，返回一个代理对象（增强器），代理对象执行方法利用拦截器链执行方法\n\n\t\t- ProxyTransactionManagementConfiguration\n\n\t\t  1.给容器中注册事物增强器\n\t\t  \t事物增强器要用事物注解信息\n\t\t  \t事物拦截器，保存了事物的属性信息，事物管理器，是一个MethodInterceptor，在目标方法执行时执行拦截器链\n\n## 扩展原理\n\n### BeanFactoryPostProcessor\n\nBeanFactory后置处理器\n\t在BeanFactory标准初始化之后调用，所有的bean定义以保存在遭到beanFactory，但是bean还未创建\n\n- BeanDefinitionRegistryPostProcessor\n\n  在所有bean定义信息将要被加载，bean实力还未被创建时执行\n\n### ApplicationListener\n\n监听容器中发布的事件\n\t1.写一个监听器，ApplicationListener实现类，来监听某个事件ApplicationEvent机器子类\n\t2.把监听器加入到容器\n\t3.只要容器中有相关事件的腹部，我们就能监听到这个事件：\n\t\tContextRefreshedEvent：容器舒心完成(所有bean都完全创建)会发布这个事件；\n\t\tContextClosedEvent：关闭容器会发布这个事件\n\t4.发布一个事件，applicationContext.publishEvent()\n\n### 容器的创建\n\n1.Spring容器在启动的时候，先会保存所有注册进来的Bean的定义信息\n\txml\n\t注解\n2.Spring容器会合适的时机创建这些Bean\n\t用到这个bean的时候，利用getBean创建bean，创建好以后保存在容器中\n\t统一创建剩下所有的bean的时候，finshBeanFactoryInitialization()\n3.后置处理器\n\t每个bean创建完成，都会使用各种后置处理器，来增强bean的功能\n4.事件驱动模型\n\tApplicationListener，事件监听\n事件派发，ApplicationEvenMulticator\n\n- refresh()\n\n\t- prepareRefresh()\n\n\t  刷新预处理工作:\n\t  清缓存\n\t  置状态\n\n\t\t- initPropertySources()\n\n\t\t  初始化属性设置，子类自定义个性化的属性设置方法。\n\n\t\t- getEnvironment().validateRequiredProperties()\n\n\t\t  检验属性的合法\n\n\t\t- earlyApplicationEvents\n\n\t\t  保存容器中的一起早起事件\n\n\t- obtainFreshBeanFactory()\n\n\t  获取BeanFactory\n\n\t\t- refreshBeanFactory()\n\n\t\t  刷新BeanFactory工厂，创建BeanFactory对象。\n\n\t\t- getBeanFactory()【DefaultListableBeanFactory】\n\n\t\t  获取之前创建好的BeanFactory\n\n\t\t- prepareBeanFactory()\n\n\t\t  BeanFactory的预准备工作（BeanFactory进行一些设置）\n\t\t  1.设置BeanFactory的类加载器，支持表达式解析器。。。\n\t\t  2.添加部分BeanPostProcessor【ApplicationContextAwareProcessor】\n\t\t  3.设置忽略的自动装配的接口，EnvironmentAware、EmbeddedValueResolverAware。。。\n\t\t  4.注册可以解析的自动装配，我们能直接在仍和组件中自动注入：BeanFactory、ResourceLoader、ApplicationEventPublisher、ApplicationContext\n\t\t  5.添加BeanPostProcessor【ApplicationListenerDetector】\n\t\t  6.添加编译是的AspectJ支持\n\t\t  7.给BeanFactory中注册一些能用的组件：environment【ConfigurableEnvironment】、systemProperties【Map】\n\n\t\t- postProcessBeanFactory()\n\n\t\t  BeanFactory准备完成后的后置处理工作，子类用过重写这个发方法来在BeanFactory初始化完成后进行更进一步的工作\n\n\t\t- invokeBeanFactoryPostProcessors()\n\n\t\t  执行BeanFactoryPostProcessor：BeanFactory的后置处理器，在BeanFactory标准初始化之后执行\n\t\t  \n\t\t  执行BeanFactoryPostProcessor的方法：\n\t\t  1.先执行BeanDefinitonRegistryPostProcessor\n\t\t  \t获取所有的BeanDefinitonRegistryPostProcessor\n\t\t  \t先执行实现了PriorityOrdered接口的\n\t\t  \t再执行实现了Ordered接口的\n\t\t  \t最后执行剩下的\n\t\t  2.再执行BeanFactoryPostProcessor的方法\n\t\t  \t先执行实现了PriorityOrdered接口的\n\t\t  \t再执行实现了Ordered接口的\n\t\t  \t最后执行剩下的\n\n\t- registerBeanPostProcessors()\n\n\t  注册BeanPostProcessor，Bean的后置处理器。\n\t  1.获取所有的BeanPostProcessor，不同接口类型的BeanPostProcessor，在Bean船舰前后的执行实际是不一样的。\n\t  \tBeanPostProcessor\n\t  \tDestructionAwareBeanPostProcessor\n\t  \tInstantiationAwareBeanPostProcessor\n\t  \tSmartInstantiationAwareBeanPostProcessor\n\t  \tMergedBeanDefinitionPostProcessor\n\n\t- initMessageSource()\n\n\t  初始化MessageSource组件（做国际化功能，消息绑定、解析）\n\t  1.获取BeanFactory\n\t  2.看容器中是否有id为messageSource的组件\n\t  \t如果有赋值给messageSource，如果没有自己创建【DelegatingMessageSource】\n\t  3.把创建好的MessageSource注册在容器中\n\n\t- initApplicationEventMulticaster()\n\n\t  初始化事件派发器\n\t  1.从BeanFactory中获取applicationEventMulticaster的ApplicationEventMulticaster\n\t  2.如果没有配置，创建SimpleApplicationEventMulticaster\n\t  3.注册到容器中\n\n\t- onRefresh()\n\n\t  留给子容器的（子类）\n\t  1.子类重写这个方法，在容器刷新的时候可以自定义逻辑\n\n\t- registerLiseners()\n\n\t  给容器中将所有的项目的ApplicationListener注册进来。\n\t  1.从容器中拿到所有ApplicationListener组件\n\t  2.将每个监听器添加到事件派发器中\n\t  3.派发之前步骤产生的事件\n\n\t- finishBeanFactoryInitialization()\n\n\t  初始化剩下的所有单实例bean\n\n\t\t- beanFactory.preInstantiateSingletons()\n\n\t\t  初始化剩下的单实例bean\n\t\t  1.获取容器中所有的Bean定义\n\t\t  2.拿到Bean的定义信息\n\t\t  3.Bean不是抽象的，是单实例的，不是懒加载的\n\t\t  \t1.判断是否是FactoryBean，是否是实现FactoryBean接口的Bean\n\t\t  \t2.不是FactoryBean，用getBean创建对象\n\t\t  \t3.doGetBean()\n\t\t  \t4.先获取缓存中保存的单实例Bean。如果获取到，说明这个Bean之前被创建国（所有创建国的单实例Bean都是会被缓存起来的）\n\t\t  \t5.换种种获取不到，开始Bean的创建对象流程\n\t\t  \t6.标记当前bean已经被创建\n\t\t  \t7.获取Bean的定义信息\n\t\t  \t8.获取当前Bean依赖的其他Bean，如果有就按照getBean()把以来的Bean先创建出来。\n\t\t  \t9.启动单实例Bean的创建流程\n\t\t  \t\t1.createBean()\n\t\t  \t\t2.resolveBeforeInstantiation()让BeanPostProcessor先拦截返回代理对象【InstantiationAwareBeanPostProcessors】提前执行\n\t\t  \t\t3.如果前面的InstantiationAwareBeanPostProcessors没有返回代理对象\n\t\t  \t\t4.doCreateBean()创建Bean\n\t\t  \t\t\t1.创建Bean实例，createBeanInstance()利用工厂方法或者对象的构造器创建出Bean实例\n\t\t  \t\t\t2.applyMergedBeanDefinitionPostProcessors()，调用【MergedBeanDefinitionPostProcessors】\n\t\t  \t\t\t3.populateBean() Bean属性赋值\n\n\t- finishRefresh()\n\n\t  完成BeanFactory的初始化创建工作，IOC容器就创建完成\n\n\t\t- initLifecycleProcessor()\n\n\t\t  初始化和生命周期有关的后置处理器：LifecycleProcessor。\n\t\t  写一个LifecycleProcessor的实现类，可以在BeanFactory的onRefresh(),onClose()进行拦截\n\n\t\t- getLifecycleProcessor().onRefresh()\n\n\t\t  拿到前面定义的生命周期处理器，回调onRefresh()\n\n\t\t- publishEvent()\n\n\t\t  发布容器完成事件","source":"_posts/Spring-Boot.md","raw":"---\ntitle: Spring Boot\ndate: 2020-01-29 20:57:11\ntags:\n    - Java\n    - Springboot\ncategories:\n    - Technology\n---\n\n## 容器\n\n### IOC\n<!-- more -->\nspring-context\n\n- @Configuration\n\n  告诉Spring这是一个配置类\n\n- @Bean\n\n  给容器中注册一个Bean，类型为返回值的类型，id默认是用方法\n  默认都是单例\n\n- AnnotationConfigApplicationContext\n- @ComponetScan、@ComponetScans\n\n  value：扫描@Service @Controller @Repositroy @Componet\n  excludeFlters：排除的规则\n  includeFilters：只需要包含的规则\n\n\t- FilterType.ANNOTATION\n\n\t  按照注解\n\n\t- FilterType.ASSIGNABLE_TYPE\n\n\t  按照给定类型\n\n\t- FilterType.ASPECTJ\n\n\t  使用ASPECTJ表达式\n\n\t- FilterType.REGEX\n\n\t  使用正则指定\n\n\t- FilterType.CUSTOM\n\n\t  自定义规则，必须实现TypeFilter类\n\n- @Scope\n\n\t- SCOPE_PROTOTPE\n\n\t  多实例\n\t  IOC容器启动不回去调用方法床架你对象，获取的时候创建对象\n\n\t- SCOPE_SINGLETON\n\n\t  单实例（默认值）\n\t  IOC容器启动会调用方法创建对象放到IOC容器中\n\n\t- SCOPE_REQUEST\n\n\t  同一次请求创建一个实例\n\n\t- SCOPE_SESSION\n\n\t  同一个Session创建一个实例\n\n- @Lazy \n\n  懒加载：容器启动不创建对象。第一次使用（获取）Bean对象时调用创建对象放入容器\n\n- @Conditional\n\n  按照一定的条件进行判断，满足条件给容器中注册Bean\n  需要实现Condition 接口：ConditionContext 判断条件能使用的上下文；AnnotatedTypeMetadate 注释信息\n\n- @Import\n\n  导入组件，id默认是组件的全类名（com.xxx.xxx.xx）\n\n\t- ImportSelector\n\n\t  自定义逻辑返回需要导入的组件。\n\t  返回值就是导入到容器中的组件全类名，方法不要返回null。\n\t  AnnotationMetadata 当前标注@Import注解的类的所有注释信息。\n\n\t- ImportBeanDefinitionRegistrar\n\n\t  BeanDefinitionRegistry：BeanDefinition注册类。\n\t  调用registerBeanDefinition手工注册Bean\n\n- FactoryBean\n\n  实现FactoryBean接口\n  1.工厂Bean获取的是调用getObject创建的对象\n  2.要获取工程Bean本身，需要给id前面加一个&\n\n### bean的生命周期\n\n- 初始化\n\n\t- @Bean(initMethod)\n\t- InitializingBean\n\n\t  通过让Bean实现该接口，实现Bean初始化逻辑\n\n\t- @PostConstruct\n\t- BeanPostProcessor\n\n\t  Bean后置处理器，在Bean初始化前后进行一些处理工作\n\n\t\t- postProcessBeforeInitialization\n\n\t\t  在初始化之前\n\n\t\t- postProcessAfterInitialization\n\n\t\t  在初始化工作之后\n\n\t\t- ApplicationContextAwareProcessor\n\n\t\t  实现该接口，Spring容器可以将当前容器传给实现类\n\n\t\t- InitDestroyAnnotationBeanPostProcessor\n\n\t\t  处理@PostConstruct，@PreDestory注解\n\n\t\t- AutowiredAnnotationBeanPostProcessor\n\n\t\t  处理@Autowired注解\n\n- 销毁\n\n\t- @Bean(destroyMethod)\n\n\t  多实例的bean，容器不会调用销毁方法\n\n\t- DisposableBean\n\n\t  通过实现该接口，实现销毁逻辑\n\n\t- @PreDestory\n\n### 属性赋值\n\n- @Value\n\n\t- 基本数值\n\t- SpEL  #{}\n\t- 配置文件 ${}\n\n\t  @PropertySource 读取外部配置文件，保存至环境变量中\n\n### 自动装配\n\n- @Autowired\n\n  1.默认按照类型在容器中找相应的组件\n  2.如果找到多个相同类型的组件，再将属性的名称作为组件的id组容易中寻找\n  3.使用@Qualifier指定需要装配的组件的id\n  4.自动装配默认一定要指定存在的属性（如果不强制指定，使用require=false）\n  5.@Primary,让Spring进行自动装配的时候，默认是用首选的bean\n\n\t- 构造器\n\n\t  构造器用到的自定义类型的值从IOC容器中获取\n\t  如果组建只有一个有参构造器，这个有参构造器的@Autowired可以省略，参数位置的组件还是可以从容器中获取\n\n\t- 方法\n\n\t  标注在方法，Spring容器创建当前对象，就会调用方法完成赋值\n\t  方法使用的参数，自定义类型的值从IOC容器中获取\n\n\t- 属性\n\n\t  值从IOC容器中获取\n\n- @Resource\n\n  可以和@Autowired一样实现自动装配，默认按照属性名称进行装配\n  没有支持@Primary功能，reqiured=false\n\n- @Inject\n\n  需要依赖javax.inject包，和Autowired一样，没有reqiured=false\n\n- 实现xxxAware接口\n\n  在创建对象的时候，会调用接口的回调方法\n  把Spring底层的组件注册到自定义的Bean中\n  xxxAware功能使用xxxProcessor处理的\n\n\t- ApplicationContextAware\n\n\t  获取ApplicationContext\n\n\t- BeanNameAware\n\t- EmbeddedValueResolverAware\n\n- Profile\n\n  加了环境表示的bean，只有这个环境被激活的时候才能注册到容器中，默认是default环境\n\n\t- 启动参数\n\n\t  -Dspring.profiles.active=xxx\n\n\t- 代码\n\n\t  1.创建一个aplicationContext\n\t  2.设置需要激活的环境.getEnvironment().setActiveProfiles()\n\t  3.注册朱配置类  .register()\n\t  4.启动刷新容器 .refresh()\n\n### AOP\n\n在程序运行期间动态的将某段代码切入到指定方法指定位置进行运行的编程方式\nspring-aspects\n容器中保存了组建的代理对象(cglib增强后的对象),这个对象里面保存了详细信息(比如增强器，目标对象)\n\n- @Before\n\n  在目标方法之前切入：切入点表达式（指定在那个方法切入）\n\n- @After\n\n  在目标方法之后切入：切入点表达式\n\n- @PointCut\n\n  切入点表达式\n\n- @AfterReturning\n\n  再放标方法正常返回之后运行\n\n- @AfterThrowing\n\n  在目标方法出现异常之后运行\n\n- @Aspect\n\n  告诉Spring当前类是一个切面类\n\n- @EnableAspectJAutoProxy\n\n  开启基于注解的AOP\n  1.给容器中导入AspectJAutoProxyRegistrar，给容器中注册一个AnnotationAwareAspectJAutoProxyCreator\n\n\t- AnnotationAwareAspectJAutoProxyCreator\n\n\t\t- AspectJAwareAdvisorAutoProxyCreator\n\n\t\t\t- AbstractAdvisorAutoProxyCreator\n\n\t\t\t\t- AbstractAutoProxyCreator\n\n\t\t\t\t\t- SmartInstantiationAwareBeanPostProcessor\n\t\t\t\t\t- BeanFactroyAware\n\n- JoinPoint\n\n  JoinPoint一定要出现在参数表的第一位\n\n- 目标方法执行\n\n  1.CglibAopProxy.intercept()。拦截目标方法的执行。\n  2.根据PoxyFactory对象获取将要执行的目标方法拦截器链\n  \ta)如果没有拦截器链，直接执行目标方法\n  \tb)如果有拦截器链，把需要执行的目标对象，目标方法，拦截器链等信息出入创建一个CglibMethodInvocation，并调用proceed()方法\n  \tc)拦截器链触发过程\n  \t\t1.如果没有拦截器执行目标方法，或者懒机器的索引和拦截器数组-1大小一样(指定到了最后一个拦截器)，执行目标方法。\n\n### 声明式事务\n\n1.导入相关依赖spring-jdbc\n2.配置数据源 JdbcTmplate\n3.给方法标注@Transactional\n4.@EnableTransactionManagement 开启基于注解的事物\n5.配置事物管理器管理事物\n\n- @Transactional\n- @EnableTransactionManagement\n\n\t- TransactionManagementConfigurationSelection\n\n\t  给容器中导入组件\n\n\t\t- AutoProxyRegistrar\n\n\t\t  给容器中注册InfrastructureAdvisorAutoProxyCreator组件\n\n\t\t\t- InfrastructureAdvisorAutoProxyCreator\n\n\t\t\t  利用后置处理器机制在对象创建后，包装对象，返回一个代理对象（增强器），代理对象执行方法利用拦截器链执行方法\n\n\t\t- ProxyTransactionManagementConfiguration\n\n\t\t  1.给容器中注册事物增强器\n\t\t  \t事物增强器要用事物注解信息\n\t\t  \t事物拦截器，保存了事物的属性信息，事物管理器，是一个MethodInterceptor，在目标方法执行时执行拦截器链\n\n## 扩展原理\n\n### BeanFactoryPostProcessor\n\nBeanFactory后置处理器\n\t在BeanFactory标准初始化之后调用，所有的bean定义以保存在遭到beanFactory，但是bean还未创建\n\n- BeanDefinitionRegistryPostProcessor\n\n  在所有bean定义信息将要被加载，bean实力还未被创建时执行\n\n### ApplicationListener\n\n监听容器中发布的事件\n\t1.写一个监听器，ApplicationListener实现类，来监听某个事件ApplicationEvent机器子类\n\t2.把监听器加入到容器\n\t3.只要容器中有相关事件的腹部，我们就能监听到这个事件：\n\t\tContextRefreshedEvent：容器舒心完成(所有bean都完全创建)会发布这个事件；\n\t\tContextClosedEvent：关闭容器会发布这个事件\n\t4.发布一个事件，applicationContext.publishEvent()\n\n### 容器的创建\n\n1.Spring容器在启动的时候，先会保存所有注册进来的Bean的定义信息\n\txml\n\t注解\n2.Spring容器会合适的时机创建这些Bean\n\t用到这个bean的时候，利用getBean创建bean，创建好以后保存在容器中\n\t统一创建剩下所有的bean的时候，finshBeanFactoryInitialization()\n3.后置处理器\n\t每个bean创建完成，都会使用各种后置处理器，来增强bean的功能\n4.事件驱动模型\n\tApplicationListener，事件监听\n事件派发，ApplicationEvenMulticator\n\n- refresh()\n\n\t- prepareRefresh()\n\n\t  刷新预处理工作:\n\t  清缓存\n\t  置状态\n\n\t\t- initPropertySources()\n\n\t\t  初始化属性设置，子类自定义个性化的属性设置方法。\n\n\t\t- getEnvironment().validateRequiredProperties()\n\n\t\t  检验属性的合法\n\n\t\t- earlyApplicationEvents\n\n\t\t  保存容器中的一起早起事件\n\n\t- obtainFreshBeanFactory()\n\n\t  获取BeanFactory\n\n\t\t- refreshBeanFactory()\n\n\t\t  刷新BeanFactory工厂，创建BeanFactory对象。\n\n\t\t- getBeanFactory()【DefaultListableBeanFactory】\n\n\t\t  获取之前创建好的BeanFactory\n\n\t\t- prepareBeanFactory()\n\n\t\t  BeanFactory的预准备工作（BeanFactory进行一些设置）\n\t\t  1.设置BeanFactory的类加载器，支持表达式解析器。。。\n\t\t  2.添加部分BeanPostProcessor【ApplicationContextAwareProcessor】\n\t\t  3.设置忽略的自动装配的接口，EnvironmentAware、EmbeddedValueResolverAware。。。\n\t\t  4.注册可以解析的自动装配，我们能直接在仍和组件中自动注入：BeanFactory、ResourceLoader、ApplicationEventPublisher、ApplicationContext\n\t\t  5.添加BeanPostProcessor【ApplicationListenerDetector】\n\t\t  6.添加编译是的AspectJ支持\n\t\t  7.给BeanFactory中注册一些能用的组件：environment【ConfigurableEnvironment】、systemProperties【Map】\n\n\t\t- postProcessBeanFactory()\n\n\t\t  BeanFactory准备完成后的后置处理工作，子类用过重写这个发方法来在BeanFactory初始化完成后进行更进一步的工作\n\n\t\t- invokeBeanFactoryPostProcessors()\n\n\t\t  执行BeanFactoryPostProcessor：BeanFactory的后置处理器，在BeanFactory标准初始化之后执行\n\t\t  \n\t\t  执行BeanFactoryPostProcessor的方法：\n\t\t  1.先执行BeanDefinitonRegistryPostProcessor\n\t\t  \t获取所有的BeanDefinitonRegistryPostProcessor\n\t\t  \t先执行实现了PriorityOrdered接口的\n\t\t  \t再执行实现了Ordered接口的\n\t\t  \t最后执行剩下的\n\t\t  2.再执行BeanFactoryPostProcessor的方法\n\t\t  \t先执行实现了PriorityOrdered接口的\n\t\t  \t再执行实现了Ordered接口的\n\t\t  \t最后执行剩下的\n\n\t- registerBeanPostProcessors()\n\n\t  注册BeanPostProcessor，Bean的后置处理器。\n\t  1.获取所有的BeanPostProcessor，不同接口类型的BeanPostProcessor，在Bean船舰前后的执行实际是不一样的。\n\t  \tBeanPostProcessor\n\t  \tDestructionAwareBeanPostProcessor\n\t  \tInstantiationAwareBeanPostProcessor\n\t  \tSmartInstantiationAwareBeanPostProcessor\n\t  \tMergedBeanDefinitionPostProcessor\n\n\t- initMessageSource()\n\n\t  初始化MessageSource组件（做国际化功能，消息绑定、解析）\n\t  1.获取BeanFactory\n\t  2.看容器中是否有id为messageSource的组件\n\t  \t如果有赋值给messageSource，如果没有自己创建【DelegatingMessageSource】\n\t  3.把创建好的MessageSource注册在容器中\n\n\t- initApplicationEventMulticaster()\n\n\t  初始化事件派发器\n\t  1.从BeanFactory中获取applicationEventMulticaster的ApplicationEventMulticaster\n\t  2.如果没有配置，创建SimpleApplicationEventMulticaster\n\t  3.注册到容器中\n\n\t- onRefresh()\n\n\t  留给子容器的（子类）\n\t  1.子类重写这个方法，在容器刷新的时候可以自定义逻辑\n\n\t- registerLiseners()\n\n\t  给容器中将所有的项目的ApplicationListener注册进来。\n\t  1.从容器中拿到所有ApplicationListener组件\n\t  2.将每个监听器添加到事件派发器中\n\t  3.派发之前步骤产生的事件\n\n\t- finishBeanFactoryInitialization()\n\n\t  初始化剩下的所有单实例bean\n\n\t\t- beanFactory.preInstantiateSingletons()\n\n\t\t  初始化剩下的单实例bean\n\t\t  1.获取容器中所有的Bean定义\n\t\t  2.拿到Bean的定义信息\n\t\t  3.Bean不是抽象的，是单实例的，不是懒加载的\n\t\t  \t1.判断是否是FactoryBean，是否是实现FactoryBean接口的Bean\n\t\t  \t2.不是FactoryBean，用getBean创建对象\n\t\t  \t3.doGetBean()\n\t\t  \t4.先获取缓存中保存的单实例Bean。如果获取到，说明这个Bean之前被创建国（所有创建国的单实例Bean都是会被缓存起来的）\n\t\t  \t5.换种种获取不到，开始Bean的创建对象流程\n\t\t  \t6.标记当前bean已经被创建\n\t\t  \t7.获取Bean的定义信息\n\t\t  \t8.获取当前Bean依赖的其他Bean，如果有就按照getBean()把以来的Bean先创建出来。\n\t\t  \t9.启动单实例Bean的创建流程\n\t\t  \t\t1.createBean()\n\t\t  \t\t2.resolveBeforeInstantiation()让BeanPostProcessor先拦截返回代理对象【InstantiationAwareBeanPostProcessors】提前执行\n\t\t  \t\t3.如果前面的InstantiationAwareBeanPostProcessors没有返回代理对象\n\t\t  \t\t4.doCreateBean()创建Bean\n\t\t  \t\t\t1.创建Bean实例，createBeanInstance()利用工厂方法或者对象的构造器创建出Bean实例\n\t\t  \t\t\t2.applyMergedBeanDefinitionPostProcessors()，调用【MergedBeanDefinitionPostProcessors】\n\t\t  \t\t\t3.populateBean() Bean属性赋值\n\n\t- finishRefresh()\n\n\t  完成BeanFactory的初始化创建工作，IOC容器就创建完成\n\n\t\t- initLifecycleProcessor()\n\n\t\t  初始化和生命周期有关的后置处理器：LifecycleProcessor。\n\t\t  写一个LifecycleProcessor的实现类，可以在BeanFactory的onRefresh(),onClose()进行拦截\n\n\t\t- getLifecycleProcessor().onRefresh()\n\n\t\t  拿到前面定义的生命周期处理器，回调onRefresh()\n\n\t\t- publishEvent()\n\n\t\t  发布容器完成事件","slug":"Spring-Boot","published":1,"updated":"2020-12-14T09:51:24.008Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71ht40009v252hkw3edgq","content":"<html><head></head><body><h2 id=\"&#x5BB9;&#x5668;\"><a href=\"#&#x5BB9;&#x5668;\" class=\"headerlink\" title=\"&#x5BB9;&#x5668;\"></a>&#x5BB9;&#x5668;</h2><h3 id=\"IOC\"><a href=\"#IOC\" class=\"headerlink\" title=\"IOC\"></a>IOC</h3><a id=\"more\"></a>\n<p>spring-context</p>\n<ul>\n<li><p>@Configuration</p>\n<p>&#x544A;&#x8BC9;Spring&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;</p>\n</li>\n<li><p>@Bean</p>\n<p>&#x7ED9;&#x5BB9;&#x5668;&#x4E2D;&#x6CE8;&#x518C;&#x4E00;&#x4E2A;Bean&#xFF0C;&#x7C7B;&#x578B;&#x4E3A;&#x8FD4;&#x56DE;&#x503C;&#x7684;&#x7C7B;&#x578B;&#xFF0C;id&#x9ED8;&#x8BA4;&#x662F;&#x7528;&#x65B9;&#x6CD5;<br>&#x9ED8;&#x8BA4;&#x90FD;&#x662F;&#x5355;&#x4F8B;</p>\n</li>\n<li><p>AnnotationConfigApplicationContext</p>\n</li>\n<li><p>@ComponetScan&#x3001;@ComponetScans</p>\n<p>value&#xFF1A;&#x626B;&#x63CF;@Service @Controller @Repositroy @Componet<br>excludeFlters&#xFF1A;&#x6392;&#x9664;&#x7684;&#x89C4;&#x5219;<br>includeFilters&#xFF1A;&#x53EA;&#x9700;&#x8981;&#x5305;&#x542B;&#x7684;&#x89C4;&#x5219;</p>\n<ul>\n<li><p>FilterType.ANNOTATION</p>\n<p>&#x6309;&#x7167;&#x6CE8;&#x89E3;</p>\n</li>\n<li><p>FilterType.ASSIGNABLE_TYPE</p>\n<p>&#x6309;&#x7167;&#x7ED9;&#x5B9A;&#x7C7B;&#x578B;</p>\n</li>\n<li><p>FilterType.ASPECTJ</p>\n<p>&#x4F7F;&#x7528;ASPECTJ&#x8868;&#x8FBE;&#x5F0F;</p>\n</li>\n<li><p>FilterType.REGEX</p>\n<p>&#x4F7F;&#x7528;&#x6B63;&#x5219;&#x6307;&#x5B9A;</p>\n</li>\n<li><p>FilterType.CUSTOM</p>\n<p>&#x81EA;&#x5B9A;&#x4E49;&#x89C4;&#x5219;&#xFF0C;&#x5FC5;&#x987B;&#x5B9E;&#x73B0;TypeFilter&#x7C7B;</p>\n</li>\n</ul>\n</li>\n<li><p>@Scope</p>\n<ul>\n<li><p>SCOPE_PROTOTPE</p>\n<p>&#x591A;&#x5B9E;&#x4F8B;<br>IOC&#x5BB9;&#x5668;&#x542F;&#x52A8;&#x4E0D;&#x56DE;&#x53BB;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x5E8A;&#x67B6;&#x4F60;&#x5BF9;&#x8C61;&#xFF0C;&#x83B7;&#x53D6;&#x7684;&#x65F6;&#x5019;&#x521B;&#x5EFA;&#x5BF9;&#x8C61;</p>\n</li>\n<li><p>SCOPE_SINGLETON</p>\n<p>&#x5355;&#x5B9E;&#x4F8B;&#xFF08;&#x9ED8;&#x8BA4;&#x503C;&#xFF09;<br>IOC&#x5BB9;&#x5668;&#x542F;&#x52A8;&#x4F1A;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x653E;&#x5230;IOC&#x5BB9;&#x5668;&#x4E2D;</p>\n</li>\n<li><p>SCOPE_REQUEST</p>\n<p>&#x540C;&#x4E00;&#x6B21;&#x8BF7;&#x6C42;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;</p>\n</li>\n<li><p>SCOPE_SESSION</p>\n<p>&#x540C;&#x4E00;&#x4E2A;Session&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5B9E;&#x4F8B;</p>\n</li>\n</ul>\n</li>\n<li><p>@Lazy </p>\n<p>&#x61D2;&#x52A0;&#x8F7D;&#xFF1A;&#x5BB9;&#x5668;&#x542F;&#x52A8;&#x4E0D;&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x3002;&#x7B2C;&#x4E00;&#x6B21;&#x4F7F;&#x7528;&#xFF08;&#x83B7;&#x53D6;&#xFF09;Bean&#x5BF9;&#x8C61;&#x65F6;&#x8C03;&#x7528;&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x653E;&#x5165;&#x5BB9;&#x5668;</p>\n</li>\n<li><p>@Conditional</p>\n<p>&#x6309;&#x7167;&#x4E00;&#x5B9A;&#x7684;&#x6761;&#x4EF6;&#x8FDB;&#x884C;&#x5224;&#x65AD;&#xFF0C;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x7ED9;&#x5BB9;&#x5668;&#x4E2D;&#x6CE8;&#x518C;Bean<br>&#x9700;&#x8981;&#x5B9E;&#x73B0;Condition &#x63A5;&#x53E3;&#xFF1A;ConditionContext &#x5224;&#x65AD;&#x6761;&#x4EF6;&#x80FD;&#x4F7F;&#x7528;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#xFF1B;AnnotatedTypeMetadate &#x6CE8;&#x91CA;&#x4FE1;&#x606F;</p>\n</li>\n<li><p>@Import</p>\n<p>&#x5BFC;&#x5165;&#x7EC4;&#x4EF6;&#xFF0C;id&#x9ED8;&#x8BA4;&#x662F;&#x7EC4;&#x4EF6;&#x7684;&#x5168;&#x7C7B;&#x540D;&#xFF08;com.xxx.xxx.xx&#xFF09;</p>\n<ul>\n<li><p>ImportSelector</p>\n<p>&#x81EA;&#x5B9A;&#x4E49;&#x903B;&#x8F91;&#x8FD4;&#x56DE;&#x9700;&#x8981;&#x5BFC;&#x5165;&#x7684;&#x7EC4;&#x4EF6;&#x3002;<br>&#x8FD4;&#x56DE;&#x503C;&#x5C31;&#x662F;&#x5BFC;&#x5165;&#x5230;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x7EC4;&#x4EF6;&#x5168;&#x7C7B;&#x540D;&#xFF0C;&#x65B9;&#x6CD5;&#x4E0D;&#x8981;&#x8FD4;&#x56DE;null&#x3002;<br>AnnotationMetadata &#x5F53;&#x524D;&#x6807;&#x6CE8;@Import&#x6CE8;&#x89E3;&#x7684;&#x7C7B;&#x7684;&#x6240;&#x6709;&#x6CE8;&#x91CA;&#x4FE1;&#x606F;&#x3002;</p>\n</li>\n<li><p>ImportBeanDefinitionRegistrar</p>\n<p>BeanDefinitionRegistry&#xFF1A;BeanDefinition&#x6CE8;&#x518C;&#x7C7B;&#x3002;<br>&#x8C03;&#x7528;registerBeanDefinition&#x624B;&#x5DE5;&#x6CE8;&#x518C;Bean</p>\n</li>\n</ul>\n</li>\n<li><p>FactoryBean</p>\n<p>&#x5B9E;&#x73B0;FactoryBean&#x63A5;&#x53E3;<br>1.&#x5DE5;&#x5382;Bean&#x83B7;&#x53D6;&#x7684;&#x662F;&#x8C03;&#x7528;getObject&#x521B;&#x5EFA;&#x7684;&#x5BF9;&#x8C61;<br>2.&#x8981;&#x83B7;&#x53D6;&#x5DE5;&#x7A0B;Bean&#x672C;&#x8EAB;&#xFF0C;&#x9700;&#x8981;&#x7ED9;id&#x524D;&#x9762;&#x52A0;&#x4E00;&#x4E2A;&amp;</p>\n</li>\n</ul>\n<h3 id=\"bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;\"><a href=\"#bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;\" class=\"headerlink\" title=\"bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;\"></a>bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;</h3><ul>\n<li><p>&#x521D;&#x59CB;&#x5316;</p>\n<ul>\n<li><p>@Bean(initMethod)</p>\n</li>\n<li><p>InitializingBean</p>\n<p>&#x901A;&#x8FC7;&#x8BA9;Bean&#x5B9E;&#x73B0;&#x8BE5;&#x63A5;&#x53E3;&#xFF0C;&#x5B9E;&#x73B0;Bean&#x521D;&#x59CB;&#x5316;&#x903B;&#x8F91;</p>\n</li>\n<li><p>@PostConstruct</p>\n</li>\n<li><p>BeanPostProcessor</p>\n<p>Bean&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x5728;Bean&#x521D;&#x59CB;&#x5316;&#x524D;&#x540E;&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x5904;&#x7406;&#x5DE5;&#x4F5C;</p>\n<ul>\n<li><p>postProcessBeforeInitialization</p>\n<p>&#x5728;&#x521D;&#x59CB;&#x5316;&#x4E4B;&#x524D;</p>\n</li>\n<li><p>postProcessAfterInitialization</p>\n<p>&#x5728;&#x521D;&#x59CB;&#x5316;&#x5DE5;&#x4F5C;&#x4E4B;&#x540E;</p>\n</li>\n<li><p>ApplicationContextAwareProcessor</p>\n<p>&#x5B9E;&#x73B0;&#x8BE5;&#x63A5;&#x53E3;&#xFF0C;Spring&#x5BB9;&#x5668;&#x53EF;&#x4EE5;&#x5C06;&#x5F53;&#x524D;&#x5BB9;&#x5668;&#x4F20;&#x7ED9;&#x5B9E;&#x73B0;&#x7C7B;</p>\n</li>\n<li><p>InitDestroyAnnotationBeanPostProcessor</p>\n<p>&#x5904;&#x7406;@PostConstruct&#xFF0C;@PreDestory&#x6CE8;&#x89E3;</p>\n</li>\n<li><p>AutowiredAnnotationBeanPostProcessor</p>\n<p>&#x5904;&#x7406;@Autowired&#x6CE8;&#x89E3;</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>&#x9500;&#x6BC1;</p>\n<ul>\n<li><p>@Bean(destroyMethod)</p>\n<p>&#x591A;&#x5B9E;&#x4F8B;&#x7684;bean&#xFF0C;&#x5BB9;&#x5668;&#x4E0D;&#x4F1A;&#x8C03;&#x7528;&#x9500;&#x6BC1;&#x65B9;&#x6CD5;</p>\n</li>\n<li><p>DisposableBean</p>\n<p>&#x901A;&#x8FC7;&#x5B9E;&#x73B0;&#x8BE5;&#x63A5;&#x53E3;&#xFF0C;&#x5B9E;&#x73B0;&#x9500;&#x6BC1;&#x903B;&#x8F91;</p>\n</li>\n<li><p>@PreDestory</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"&#x5C5E;&#x6027;&#x8D4B;&#x503C;\"><a href=\"#&#x5C5E;&#x6027;&#x8D4B;&#x503C;\" class=\"headerlink\" title=\"&#x5C5E;&#x6027;&#x8D4B;&#x503C;\"></a>&#x5C5E;&#x6027;&#x8D4B;&#x503C;</h3><ul>\n<li><p>@Value</p>\n<ul>\n<li><p>&#x57FA;&#x672C;&#x6570;&#x503C;</p>\n</li>\n<li><p>SpEL  #{}</p>\n</li>\n<li><p>&#x914D;&#x7F6E;&#x6587;&#x4EF6; ${}</p>\n<p>@PropertySource &#x8BFB;&#x53D6;&#x5916;&#x90E8;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x4FDD;&#x5B58;&#x81F3;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x4E2D;</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"&#x81EA;&#x52A8;&#x88C5;&#x914D;\"><a href=\"#&#x81EA;&#x52A8;&#x88C5;&#x914D;\" class=\"headerlink\" title=\"&#x81EA;&#x52A8;&#x88C5;&#x914D;\"></a>&#x81EA;&#x52A8;&#x88C5;&#x914D;</h3><ul>\n<li><p>@Autowired</p>\n<p>1.&#x9ED8;&#x8BA4;&#x6309;&#x7167;&#x7C7B;&#x578B;&#x5728;&#x5BB9;&#x5668;&#x4E2D;&#x627E;&#x76F8;&#x5E94;&#x7684;&#x7EC4;&#x4EF6;<br>2.&#x5982;&#x679C;&#x627E;&#x5230;&#x591A;&#x4E2A;&#x76F8;&#x540C;&#x7C7B;&#x578B;&#x7684;&#x7EC4;&#x4EF6;&#xFF0C;&#x518D;&#x5C06;&#x5C5E;&#x6027;&#x7684;&#x540D;&#x79F0;&#x4F5C;&#x4E3A;&#x7EC4;&#x4EF6;&#x7684;id&#x7EC4;&#x5BB9;&#x6613;&#x4E2D;&#x5BFB;&#x627E;<br>3.&#x4F7F;&#x7528;@Qualifier&#x6307;&#x5B9A;&#x9700;&#x8981;&#x88C5;&#x914D;&#x7684;&#x7EC4;&#x4EF6;&#x7684;id<br>4.&#x81EA;&#x52A8;&#x88C5;&#x914D;&#x9ED8;&#x8BA4;&#x4E00;&#x5B9A;&#x8981;&#x6307;&#x5B9A;&#x5B58;&#x5728;&#x7684;&#x5C5E;&#x6027;&#xFF08;&#x5982;&#x679C;&#x4E0D;&#x5F3A;&#x5236;&#x6307;&#x5B9A;&#xFF0C;&#x4F7F;&#x7528;require=false&#xFF09;<br>5.@Primary,&#x8BA9;Spring&#x8FDB;&#x884C;&#x81EA;&#x52A8;&#x88C5;&#x914D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;&#x7528;&#x9996;&#x9009;&#x7684;bean</p>\n<ul>\n<li><p>&#x6784;&#x9020;&#x5668;</p>\n<p>&#x6784;&#x9020;&#x5668;&#x7528;&#x5230;&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x7684;&#x503C;&#x4ECE;IOC&#x5BB9;&#x5668;&#x4E2D;&#x83B7;&#x53D6;<br>&#x5982;&#x679C;&#x7EC4;&#x5EFA;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x6709;&#x53C2;&#x6784;&#x9020;&#x5668;&#xFF0C;&#x8FD9;&#x4E2A;&#x6709;&#x53C2;&#x6784;&#x9020;&#x5668;&#x7684;@Autowired&#x53EF;&#x4EE5;&#x7701;&#x7565;&#xFF0C;&#x53C2;&#x6570;&#x4F4D;&#x7F6E;&#x7684;&#x7EC4;&#x4EF6;&#x8FD8;&#x662F;&#x53EF;&#x4EE5;&#x4ECE;&#x5BB9;&#x5668;&#x4E2D;&#x83B7;&#x53D6;</p>\n</li>\n<li><p>&#x65B9;&#x6CD5;</p>\n<p>&#x6807;&#x6CE8;&#x5728;&#x65B9;&#x6CD5;&#xFF0C;Spring&#x5BB9;&#x5668;&#x521B;&#x5EFA;&#x5F53;&#x524D;&#x5BF9;&#x8C61;&#xFF0C;&#x5C31;&#x4F1A;&#x8C03;&#x7528;&#x65B9;&#x6CD5;&#x5B8C;&#x6210;&#x8D4B;&#x503C;<br>&#x65B9;&#x6CD5;&#x4F7F;&#x7528;&#x7684;&#x53C2;&#x6570;&#xFF0C;&#x81EA;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x7684;&#x503C;&#x4ECE;IOC&#x5BB9;&#x5668;&#x4E2D;&#x83B7;&#x53D6;</p>\n</li>\n<li><p>&#x5C5E;&#x6027;</p>\n<p>&#x503C;&#x4ECE;IOC&#x5BB9;&#x5668;&#x4E2D;&#x83B7;&#x53D6;</p>\n</li>\n</ul>\n</li>\n<li><p>@Resource</p>\n<p>&#x53EF;&#x4EE5;&#x548C;@Autowired&#x4E00;&#x6837;&#x5B9E;&#x73B0;&#x81EA;&#x52A8;&#x88C5;&#x914D;&#xFF0C;&#x9ED8;&#x8BA4;&#x6309;&#x7167;&#x5C5E;&#x6027;&#x540D;&#x79F0;&#x8FDB;&#x884C;&#x88C5;&#x914D;<br>&#x6CA1;&#x6709;&#x652F;&#x6301;@Primary&#x529F;&#x80FD;&#xFF0C;reqiured=false</p>\n</li>\n<li><p>@Inject</p>\n<p>&#x9700;&#x8981;&#x4F9D;&#x8D56;javax.inject&#x5305;&#xFF0C;&#x548C;Autowired&#x4E00;&#x6837;&#xFF0C;&#x6CA1;&#x6709;reqiured=false</p>\n</li>\n<li><p>&#x5B9E;&#x73B0;xxxAware&#x63A5;&#x53E3;</p>\n<p>&#x5728;&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;&#x63A5;&#x53E3;&#x7684;&#x56DE;&#x8C03;&#x65B9;&#x6CD5;<br>&#x628A;Spring&#x5E95;&#x5C42;&#x7684;&#x7EC4;&#x4EF6;&#x6CE8;&#x518C;&#x5230;&#x81EA;&#x5B9A;&#x4E49;&#x7684;Bean&#x4E2D;<br>xxxAware&#x529F;&#x80FD;&#x4F7F;&#x7528;xxxProcessor&#x5904;&#x7406;&#x7684;</p>\n<ul>\n<li><p>ApplicationContextAware</p>\n<p>&#x83B7;&#x53D6;ApplicationContext</p>\n</li>\n<li><p>BeanNameAware</p>\n</li>\n<li><p>EmbeddedValueResolverAware</p>\n</li>\n</ul>\n</li>\n<li><p>Profile</p>\n<p>&#x52A0;&#x4E86;&#x73AF;&#x5883;&#x8868;&#x793A;&#x7684;bean&#xFF0C;&#x53EA;&#x6709;&#x8FD9;&#x4E2A;&#x73AF;&#x5883;&#x88AB;&#x6FC0;&#x6D3B;&#x7684;&#x65F6;&#x5019;&#x624D;&#x80FD;&#x6CE8;&#x518C;&#x5230;&#x5BB9;&#x5668;&#x4E2D;&#xFF0C;&#x9ED8;&#x8BA4;&#x662F;default&#x73AF;&#x5883;</p>\n<ul>\n<li><p>&#x542F;&#x52A8;&#x53C2;&#x6570;</p>\n<p>-Dspring.profiles.active=xxx</p>\n</li>\n<li><p>&#x4EE3;&#x7801;</p>\n<p>1.&#x521B;&#x5EFA;&#x4E00;&#x4E2A;aplicationContext<br>2.&#x8BBE;&#x7F6E;&#x9700;&#x8981;&#x6FC0;&#x6D3B;&#x7684;&#x73AF;&#x5883;.getEnvironment().setActiveProfiles()<br>3.&#x6CE8;&#x518C;&#x6731;&#x914D;&#x7F6E;&#x7C7B;  .register()<br>4.&#x542F;&#x52A8;&#x5237;&#x65B0;&#x5BB9;&#x5668; .refresh()</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"AOP\"><a href=\"#AOP\" class=\"headerlink\" title=\"AOP\"></a>AOP</h3><p>&#x5728;&#x7A0B;&#x5E8F;&#x8FD0;&#x884C;&#x671F;&#x95F4;&#x52A8;&#x6001;&#x7684;&#x5C06;&#x67D0;&#x6BB5;&#x4EE3;&#x7801;&#x5207;&#x5165;&#x5230;&#x6307;&#x5B9A;&#x65B9;&#x6CD5;&#x6307;&#x5B9A;&#x4F4D;&#x7F6E;&#x8FDB;&#x884C;&#x8FD0;&#x884C;&#x7684;&#x7F16;&#x7A0B;&#x65B9;&#x5F0F;<br>spring-aspects<br>&#x5BB9;&#x5668;&#x4E2D;&#x4FDD;&#x5B58;&#x4E86;&#x7EC4;&#x5EFA;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;(cglib&#x589E;&#x5F3A;&#x540E;&#x7684;&#x5BF9;&#x8C61;),&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x91CC;&#x9762;&#x4FDD;&#x5B58;&#x4E86;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;(&#x6BD4;&#x5982;&#x589E;&#x5F3A;&#x5668;&#xFF0C;&#x76EE;&#x6807;&#x5BF9;&#x8C61;)</p>\n<ul>\n<li><p>@Before</p>\n<p>&#x5728;&#x76EE;&#x6807;&#x65B9;&#x6CD5;&#x4E4B;&#x524D;&#x5207;&#x5165;&#xFF1A;&#x5207;&#x5165;&#x70B9;&#x8868;&#x8FBE;&#x5F0F;&#xFF08;&#x6307;&#x5B9A;&#x5728;&#x90A3;&#x4E2A;&#x65B9;&#x6CD5;&#x5207;&#x5165;&#xFF09;</p>\n</li>\n<li><p>@After</p>\n<p>&#x5728;&#x76EE;&#x6807;&#x65B9;&#x6CD5;&#x4E4B;&#x540E;&#x5207;&#x5165;&#xFF1A;&#x5207;&#x5165;&#x70B9;&#x8868;&#x8FBE;&#x5F0F;</p>\n</li>\n<li><p>@PointCut</p>\n<p>&#x5207;&#x5165;&#x70B9;&#x8868;&#x8FBE;&#x5F0F;</p>\n</li>\n<li><p>@AfterReturning</p>\n<p>&#x518D;&#x653E;&#x6807;&#x65B9;&#x6CD5;&#x6B63;&#x5E38;&#x8FD4;&#x56DE;&#x4E4B;&#x540E;&#x8FD0;&#x884C;</p>\n</li>\n<li><p>@AfterThrowing</p>\n<p>&#x5728;&#x76EE;&#x6807;&#x65B9;&#x6CD5;&#x51FA;&#x73B0;&#x5F02;&#x5E38;&#x4E4B;&#x540E;&#x8FD0;&#x884C;</p>\n</li>\n<li><p>@Aspect</p>\n<p>&#x544A;&#x8BC9;Spring&#x5F53;&#x524D;&#x7C7B;&#x662F;&#x4E00;&#x4E2A;&#x5207;&#x9762;&#x7C7B;</p>\n</li>\n<li><p>@EnableAspectJAutoProxy</p>\n<p>&#x5F00;&#x542F;&#x57FA;&#x4E8E;&#x6CE8;&#x89E3;&#x7684;AOP<br>1.&#x7ED9;&#x5BB9;&#x5668;&#x4E2D;&#x5BFC;&#x5165;AspectJAutoProxyRegistrar&#xFF0C;&#x7ED9;&#x5BB9;&#x5668;&#x4E2D;&#x6CE8;&#x518C;&#x4E00;&#x4E2A;AnnotationAwareAspectJAutoProxyCreator</p>\n<ul>\n<li><p>AnnotationAwareAspectJAutoProxyCreator</p>\n<ul>\n<li><p>AspectJAwareAdvisorAutoProxyCreator</p>\n<ul>\n<li><p>AbstractAdvisorAutoProxyCreator</p>\n<ul>\n<li><p>AbstractAutoProxyCreator</p>\n<ul>\n<li>SmartInstantiationAwareBeanPostProcessor</li>\n<li>BeanFactroyAware</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>JoinPoint</p>\n<p>JoinPoint&#x4E00;&#x5B9A;&#x8981;&#x51FA;&#x73B0;&#x5728;&#x53C2;&#x6570;&#x8868;&#x7684;&#x7B2C;&#x4E00;&#x4F4D;</p>\n</li>\n<li><p>&#x76EE;&#x6807;&#x65B9;&#x6CD5;&#x6267;&#x884C;</p>\n<p>1.CglibAopProxy.intercept()&#x3002;&#x62E6;&#x622A;&#x76EE;&#x6807;&#x65B9;&#x6CD5;&#x7684;&#x6267;&#x884C;&#x3002;<br>2.&#x6839;&#x636E;PoxyFactory&#x5BF9;&#x8C61;&#x83B7;&#x53D6;&#x5C06;&#x8981;&#x6267;&#x884C;&#x7684;&#x76EE;&#x6807;&#x65B9;&#x6CD5;&#x62E6;&#x622A;&#x5668;&#x94FE;</p>\n<pre><code>a)&#x5982;&#x679C;&#x6CA1;&#x6709;&#x62E6;&#x622A;&#x5668;&#x94FE;&#xFF0C;&#x76F4;&#x63A5;&#x6267;&#x884C;&#x76EE;&#x6807;&#x65B9;&#x6CD5;\nb)&#x5982;&#x679C;&#x6709;&#x62E6;&#x622A;&#x5668;&#x94FE;&#xFF0C;&#x628A;&#x9700;&#x8981;&#x6267;&#x884C;&#x7684;&#x76EE;&#x6807;&#x5BF9;&#x8C61;&#xFF0C;&#x76EE;&#x6807;&#x65B9;&#x6CD5;&#xFF0C;&#x62E6;&#x622A;&#x5668;&#x94FE;&#x7B49;&#x4FE1;&#x606F;&#x51FA;&#x5165;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;CglibMethodInvocation&#xFF0C;&#x5E76;&#x8C03;&#x7528;proceed()&#x65B9;&#x6CD5;\nc)&#x62E6;&#x622A;&#x5668;&#x94FE;&#x89E6;&#x53D1;&#x8FC7;&#x7A0B;\n    1.&#x5982;&#x679C;&#x6CA1;&#x6709;&#x62E6;&#x622A;&#x5668;&#x6267;&#x884C;&#x76EE;&#x6807;&#x65B9;&#x6CD5;&#xFF0C;&#x6216;&#x8005;&#x61D2;&#x673A;&#x5668;&#x7684;&#x7D22;&#x5F15;&#x548C;&#x62E6;&#x622A;&#x5668;&#x6570;&#x7EC4;-1&#x5927;&#x5C0F;&#x4E00;&#x6837;(&#x6307;&#x5B9A;&#x5230;&#x4E86;&#x6700;&#x540E;&#x4E00;&#x4E2A;&#x62E6;&#x622A;&#x5668;)&#xFF0C;&#x6267;&#x884C;&#x76EE;&#x6807;&#x65B9;&#x6CD5;&#x3002;</code></pre>\n</li>\n</ul>\n<h3 id=\"&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;\"><a href=\"#&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;\" class=\"headerlink\" title=\"&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;\"></a>&#x58F0;&#x660E;&#x5F0F;&#x4E8B;&#x52A1;</h3><p>1.&#x5BFC;&#x5165;&#x76F8;&#x5173;&#x4F9D;&#x8D56;spring-jdbc<br>2.&#x914D;&#x7F6E;&#x6570;&#x636E;&#x6E90; JdbcTmplate<br>3.&#x7ED9;&#x65B9;&#x6CD5;&#x6807;&#x6CE8;@Transactional<br>4.@EnableTransactionManagement &#x5F00;&#x542F;&#x57FA;&#x4E8E;&#x6CE8;&#x89E3;&#x7684;&#x4E8B;&#x7269;<br>5.&#x914D;&#x7F6E;&#x4E8B;&#x7269;&#x7BA1;&#x7406;&#x5668;&#x7BA1;&#x7406;&#x4E8B;&#x7269;</p>\n<ul>\n<li><p>@Transactional</p>\n</li>\n<li><p>@EnableTransactionManagement</p>\n<ul>\n<li><p>TransactionManagementConfigurationSelection</p>\n<p>&#x7ED9;&#x5BB9;&#x5668;&#x4E2D;&#x5BFC;&#x5165;&#x7EC4;&#x4EF6;</p>\n<ul>\n<li><p>AutoProxyRegistrar</p>\n<p>&#x7ED9;&#x5BB9;&#x5668;&#x4E2D;&#x6CE8;&#x518C;InfrastructureAdvisorAutoProxyCreator&#x7EC4;&#x4EF6;</p>\n<ul>\n<li><p>InfrastructureAdvisorAutoProxyCreator</p>\n<p>&#x5229;&#x7528;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x673A;&#x5236;&#x5728;&#x5BF9;&#x8C61;&#x521B;&#x5EFA;&#x540E;&#xFF0C;&#x5305;&#x88C5;&#x5BF9;&#x8C61;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#xFF08;&#x589E;&#x5F3A;&#x5668;&#xFF09;&#xFF0C;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x6267;&#x884C;&#x65B9;&#x6CD5;&#x5229;&#x7528;&#x62E6;&#x622A;&#x5668;&#x94FE;&#x6267;&#x884C;&#x65B9;&#x6CD5;</p>\n</li>\n</ul>\n</li>\n<li><p>ProxyTransactionManagementConfiguration</p>\n<p>1.&#x7ED9;&#x5BB9;&#x5668;&#x4E2D;&#x6CE8;&#x518C;&#x4E8B;&#x7269;&#x589E;&#x5F3A;&#x5668;</p>\n<pre><code>&#x4E8B;&#x7269;&#x589E;&#x5F3A;&#x5668;&#x8981;&#x7528;&#x4E8B;&#x7269;&#x6CE8;&#x89E3;&#x4FE1;&#x606F;\n&#x4E8B;&#x7269;&#x62E6;&#x622A;&#x5668;&#xFF0C;&#x4FDD;&#x5B58;&#x4E86;&#x4E8B;&#x7269;&#x7684;&#x5C5E;&#x6027;&#x4FE1;&#x606F;&#xFF0C;&#x4E8B;&#x7269;&#x7BA1;&#x7406;&#x5668;&#xFF0C;&#x662F;&#x4E00;&#x4E2A;MethodInterceptor&#xFF0C;&#x5728;&#x76EE;&#x6807;&#x65B9;&#x6CD5;&#x6267;&#x884C;&#x65F6;&#x6267;&#x884C;&#x62E6;&#x622A;&#x5668;&#x94FE;</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"&#x6269;&#x5C55;&#x539F;&#x7406;\"><a href=\"#&#x6269;&#x5C55;&#x539F;&#x7406;\" class=\"headerlink\" title=\"&#x6269;&#x5C55;&#x539F;&#x7406;\"></a>&#x6269;&#x5C55;&#x539F;&#x7406;</h2><h3 id=\"BeanFactoryPostProcessor\"><a href=\"#BeanFactoryPostProcessor\" class=\"headerlink\" title=\"BeanFactoryPostProcessor\"></a>BeanFactoryPostProcessor</h3><p>BeanFactory&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;<br>    &#x5728;BeanFactory&#x6807;&#x51C6;&#x521D;&#x59CB;&#x5316;&#x4E4B;&#x540E;&#x8C03;&#x7528;&#xFF0C;&#x6240;&#x6709;&#x7684;bean&#x5B9A;&#x4E49;&#x4EE5;&#x4FDD;&#x5B58;&#x5728;&#x906D;&#x5230;beanFactory&#xFF0C;&#x4F46;&#x662F;bean&#x8FD8;&#x672A;&#x521B;&#x5EFA;</p>\n<ul>\n<li><p>BeanDefinitionRegistryPostProcessor</p>\n<p>&#x5728;&#x6240;&#x6709;bean&#x5B9A;&#x4E49;&#x4FE1;&#x606F;&#x5C06;&#x8981;&#x88AB;&#x52A0;&#x8F7D;&#xFF0C;bean&#x5B9E;&#x529B;&#x8FD8;&#x672A;&#x88AB;&#x521B;&#x5EFA;&#x65F6;&#x6267;&#x884C;</p>\n</li>\n</ul>\n<h3 id=\"ApplicationListener\"><a href=\"#ApplicationListener\" class=\"headerlink\" title=\"ApplicationListener\"></a>ApplicationListener</h3><p>&#x76D1;&#x542C;&#x5BB9;&#x5668;&#x4E2D;&#x53D1;&#x5E03;&#x7684;&#x4E8B;&#x4EF6;<br>    1.&#x5199;&#x4E00;&#x4E2A;&#x76D1;&#x542C;&#x5668;&#xFF0C;ApplicationListener&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x6765;&#x76D1;&#x542C;&#x67D0;&#x4E2A;&#x4E8B;&#x4EF6;ApplicationEvent&#x673A;&#x5668;&#x5B50;&#x7C7B;<br>    2.&#x628A;&#x76D1;&#x542C;&#x5668;&#x52A0;&#x5165;&#x5230;&#x5BB9;&#x5668;<br>    3.&#x53EA;&#x8981;&#x5BB9;&#x5668;&#x4E2D;&#x6709;&#x76F8;&#x5173;&#x4E8B;&#x4EF6;&#x7684;&#x8179;&#x90E8;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x80FD;&#x76D1;&#x542C;&#x5230;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#xFF1A;<br>        ContextRefreshedEvent&#xFF1A;&#x5BB9;&#x5668;&#x8212;&#x5FC3;&#x5B8C;&#x6210;(&#x6240;&#x6709;bean&#x90FD;&#x5B8C;&#x5168;&#x521B;&#x5EFA;)&#x4F1A;&#x53D1;&#x5E03;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;&#xFF1B;<br>        ContextClosedEvent&#xFF1A;&#x5173;&#x95ED;&#x5BB9;&#x5668;&#x4F1A;&#x53D1;&#x5E03;&#x8FD9;&#x4E2A;&#x4E8B;&#x4EF6;<br>    4.&#x53D1;&#x5E03;&#x4E00;&#x4E2A;&#x4E8B;&#x4EF6;&#xFF0C;applicationContext.publishEvent()</p>\n<h3 id=\"&#x5BB9;&#x5668;&#x7684;&#x521B;&#x5EFA;\"><a href=\"#&#x5BB9;&#x5668;&#x7684;&#x521B;&#x5EFA;\" class=\"headerlink\" title=\"&#x5BB9;&#x5668;&#x7684;&#x521B;&#x5EFA;\"></a>&#x5BB9;&#x5668;&#x7684;&#x521B;&#x5EFA;</h3><p>1.Spring&#x5BB9;&#x5668;&#x5728;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5148;&#x4F1A;&#x4FDD;&#x5B58;&#x6240;&#x6709;&#x6CE8;&#x518C;&#x8FDB;&#x6765;&#x7684;Bean&#x7684;&#x5B9A;&#x4E49;&#x4FE1;&#x606F;<br>    xml<br>    &#x6CE8;&#x89E3;<br>2.Spring&#x5BB9;&#x5668;&#x4F1A;&#x5408;&#x9002;&#x7684;&#x65F6;&#x673A;&#x521B;&#x5EFA;&#x8FD9;&#x4E9B;Bean<br>    &#x7528;&#x5230;&#x8FD9;&#x4E2A;bean&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5229;&#x7528;getBean&#x521B;&#x5EFA;bean&#xFF0C;&#x521B;&#x5EFA;&#x597D;&#x4EE5;&#x540E;&#x4FDD;&#x5B58;&#x5728;&#x5BB9;&#x5668;&#x4E2D;<br>    &#x7EDF;&#x4E00;&#x521B;&#x5EFA;&#x5269;&#x4E0B;&#x6240;&#x6709;&#x7684;bean&#x7684;&#x65F6;&#x5019;&#xFF0C;finshBeanFactoryInitialization()<br>3.&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;<br>    &#x6BCF;&#x4E2A;bean&#x521B;&#x5EFA;&#x5B8C;&#x6210;&#xFF0C;&#x90FD;&#x4F1A;&#x4F7F;&#x7528;&#x5404;&#x79CD;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x6765;&#x589E;&#x5F3A;bean&#x7684;&#x529F;&#x80FD;<br>4.&#x4E8B;&#x4EF6;&#x9A71;&#x52A8;&#x6A21;&#x578B;<br>    ApplicationListener&#xFF0C;&#x4E8B;&#x4EF6;&#x76D1;&#x542C;<br>&#x4E8B;&#x4EF6;&#x6D3E;&#x53D1;&#xFF0C;ApplicationEvenMulticator</p>\n<ul>\n<li><p>refresh()</p>\n<ul>\n<li><p>prepareRefresh()</p>\n<p>&#x5237;&#x65B0;&#x9884;&#x5904;&#x7406;&#x5DE5;&#x4F5C;:<br>&#x6E05;&#x7F13;&#x5B58;<br>&#x7F6E;&#x72B6;&#x6001;</p>\n<ul>\n<li><p>initPropertySources()</p>\n<p>&#x521D;&#x59CB;&#x5316;&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;&#xFF0C;&#x5B50;&#x7C7B;&#x81EA;&#x5B9A;&#x4E49;&#x4E2A;&#x6027;&#x5316;&#x7684;&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;&#x65B9;&#x6CD5;&#x3002;</p>\n</li>\n<li><p>getEnvironment().validateRequiredProperties()</p>\n<p>&#x68C0;&#x9A8C;&#x5C5E;&#x6027;&#x7684;&#x5408;&#x6CD5;</p>\n</li>\n<li><p>earlyApplicationEvents</p>\n<p>&#x4FDD;&#x5B58;&#x5BB9;&#x5668;&#x4E2D;&#x7684;&#x4E00;&#x8D77;&#x65E9;&#x8D77;&#x4E8B;&#x4EF6;</p>\n</li>\n</ul>\n</li>\n<li><p>obtainFreshBeanFactory()</p>\n<p>&#x83B7;&#x53D6;BeanFactory</p>\n<ul>\n<li><p>refreshBeanFactory()</p>\n<p>&#x5237;&#x65B0;BeanFactory&#x5DE5;&#x5382;&#xFF0C;&#x521B;&#x5EFA;BeanFactory&#x5BF9;&#x8C61;&#x3002;</p>\n</li>\n<li><p>getBeanFactory()&#x3010;DefaultListableBeanFactory&#x3011;</p>\n<p>&#x83B7;&#x53D6;&#x4E4B;&#x524D;&#x521B;&#x5EFA;&#x597D;&#x7684;BeanFactory</p>\n</li>\n<li><p>prepareBeanFactory()</p>\n<p>BeanFactory&#x7684;&#x9884;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#xFF08;BeanFactory&#x8FDB;&#x884C;&#x4E00;&#x4E9B;&#x8BBE;&#x7F6E;&#xFF09;<br>1.&#x8BBE;&#x7F6E;BeanFactory&#x7684;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;&#xFF0C;&#x652F;&#x6301;&#x8868;&#x8FBE;&#x5F0F;&#x89E3;&#x6790;&#x5668;&#x3002;&#x3002;&#x3002;<br>2.&#x6DFB;&#x52A0;&#x90E8;&#x5206;BeanPostProcessor&#x3010;ApplicationContextAwareProcessor&#x3011;<br>3.&#x8BBE;&#x7F6E;&#x5FFD;&#x7565;&#x7684;&#x81EA;&#x52A8;&#x88C5;&#x914D;&#x7684;&#x63A5;&#x53E3;&#xFF0C;EnvironmentAware&#x3001;EmbeddedValueResolverAware&#x3002;&#x3002;&#x3002;<br>4.&#x6CE8;&#x518C;&#x53EF;&#x4EE5;&#x89E3;&#x6790;&#x7684;&#x81EA;&#x52A8;&#x88C5;&#x914D;&#xFF0C;&#x6211;&#x4EEC;&#x80FD;&#x76F4;&#x63A5;&#x5728;&#x4ECD;&#x548C;&#x7EC4;&#x4EF6;&#x4E2D;&#x81EA;&#x52A8;&#x6CE8;&#x5165;&#xFF1A;BeanFactory&#x3001;ResourceLoader&#x3001;ApplicationEventPublisher&#x3001;ApplicationContext<br>5.&#x6DFB;&#x52A0;BeanPostProcessor&#x3010;ApplicationListenerDetector&#x3011;<br>6.&#x6DFB;&#x52A0;&#x7F16;&#x8BD1;&#x662F;&#x7684;AspectJ&#x652F;&#x6301;<br>7.&#x7ED9;BeanFactory&#x4E2D;&#x6CE8;&#x518C;&#x4E00;&#x4E9B;&#x80FD;&#x7528;&#x7684;&#x7EC4;&#x4EF6;&#xFF1A;environment&#x3010;ConfigurableEnvironment&#x3011;&#x3001;systemProperties&#x3010;Map&#x3011;</p>\n</li>\n<li><p>postProcessBeanFactory()</p>\n<p>BeanFactory&#x51C6;&#x5907;&#x5B8C;&#x6210;&#x540E;&#x7684;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5DE5;&#x4F5C;&#xFF0C;&#x5B50;&#x7C7B;&#x7528;&#x8FC7;&#x91CD;&#x5199;&#x8FD9;&#x4E2A;&#x53D1;&#x65B9;&#x6CD5;&#x6765;&#x5728;BeanFactory&#x521D;&#x59CB;&#x5316;&#x5B8C;&#x6210;&#x540E;&#x8FDB;&#x884C;&#x66F4;&#x8FDB;&#x4E00;&#x6B65;&#x7684;&#x5DE5;&#x4F5C;</p>\n</li>\n<li><p>invokeBeanFactoryPostProcessors()</p>\n<p>&#x6267;&#x884C;BeanFactoryPostProcessor&#xFF1A;BeanFactory&#x7684;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x5728;BeanFactory&#x6807;&#x51C6;&#x521D;&#x59CB;&#x5316;&#x4E4B;&#x540E;&#x6267;&#x884C;</p>\n<p>&#x6267;&#x884C;BeanFactoryPostProcessor&#x7684;&#x65B9;&#x6CD5;&#xFF1A;<br>1.&#x5148;&#x6267;&#x884C;BeanDefinitonRegistryPostProcessor</p>\n<pre><code>&#x83B7;&#x53D6;&#x6240;&#x6709;&#x7684;BeanDefinitonRegistryPostProcessor\n&#x5148;&#x6267;&#x884C;&#x5B9E;&#x73B0;&#x4E86;PriorityOrdered&#x63A5;&#x53E3;&#x7684;\n&#x518D;&#x6267;&#x884C;&#x5B9E;&#x73B0;&#x4E86;Ordered&#x63A5;&#x53E3;&#x7684;\n&#x6700;&#x540E;&#x6267;&#x884C;&#x5269;&#x4E0B;&#x7684;</code></pre>\n<p>2.&#x518D;&#x6267;&#x884C;BeanFactoryPostProcessor&#x7684;&#x65B9;&#x6CD5;</p>\n<pre><code>&#x5148;&#x6267;&#x884C;&#x5B9E;&#x73B0;&#x4E86;PriorityOrdered&#x63A5;&#x53E3;&#x7684;\n&#x518D;&#x6267;&#x884C;&#x5B9E;&#x73B0;&#x4E86;Ordered&#x63A5;&#x53E3;&#x7684;\n&#x6700;&#x540E;&#x6267;&#x884C;&#x5269;&#x4E0B;&#x7684;</code></pre>\n</li>\n</ul>\n</li>\n<li><p>registerBeanPostProcessors()</p>\n<p>&#x6CE8;&#x518C;BeanPostProcessor&#xFF0C;Bean&#x7684;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x3002;<br>1.&#x83B7;&#x53D6;&#x6240;&#x6709;&#x7684;BeanPostProcessor&#xFF0C;&#x4E0D;&#x540C;&#x63A5;&#x53E3;&#x7C7B;&#x578B;&#x7684;BeanPostProcessor&#xFF0C;&#x5728;Bean&#x8239;&#x8230;&#x524D;&#x540E;&#x7684;&#x6267;&#x884C;&#x5B9E;&#x9645;&#x662F;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x3002;</p>\n<pre><code>BeanPostProcessor\nDestructionAwareBeanPostProcessor\nInstantiationAwareBeanPostProcessor\nSmartInstantiationAwareBeanPostProcessor\nMergedBeanDefinitionPostProcessor</code></pre>\n</li>\n<li><p>initMessageSource()</p>\n<p>&#x521D;&#x59CB;&#x5316;MessageSource&#x7EC4;&#x4EF6;&#xFF08;&#x505A;&#x56FD;&#x9645;&#x5316;&#x529F;&#x80FD;&#xFF0C;&#x6D88;&#x606F;&#x7ED1;&#x5B9A;&#x3001;&#x89E3;&#x6790;&#xFF09;<br>1.&#x83B7;&#x53D6;BeanFactory<br>2.&#x770B;&#x5BB9;&#x5668;&#x4E2D;&#x662F;&#x5426;&#x6709;id&#x4E3A;messageSource&#x7684;&#x7EC4;&#x4EF6;</p>\n<pre><code>&#x5982;&#x679C;&#x6709;&#x8D4B;&#x503C;&#x7ED9;messageSource&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x81EA;&#x5DF1;&#x521B;&#x5EFA;&#x3010;DelegatingMessageSource&#x3011;</code></pre>\n<p>3.&#x628A;&#x521B;&#x5EFA;&#x597D;&#x7684;MessageSource&#x6CE8;&#x518C;&#x5728;&#x5BB9;&#x5668;&#x4E2D;</p>\n</li>\n<li><p>initApplicationEventMulticaster()</p>\n<p>&#x521D;&#x59CB;&#x5316;&#x4E8B;&#x4EF6;&#x6D3E;&#x53D1;&#x5668;<br>1.&#x4ECE;BeanFactory&#x4E2D;&#x83B7;&#x53D6;applicationEventMulticaster&#x7684;ApplicationEventMulticaster<br>2.&#x5982;&#x679C;&#x6CA1;&#x6709;&#x914D;&#x7F6E;&#xFF0C;&#x521B;&#x5EFA;SimpleApplicationEventMulticaster<br>3.&#x6CE8;&#x518C;&#x5230;&#x5BB9;&#x5668;&#x4E2D;</p>\n</li>\n<li><p>onRefresh()</p>\n<p>&#x7559;&#x7ED9;&#x5B50;&#x5BB9;&#x5668;&#x7684;&#xFF08;&#x5B50;&#x7C7B;&#xFF09;<br>1.&#x5B50;&#x7C7B;&#x91CD;&#x5199;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x5BB9;&#x5668;&#x5237;&#x65B0;&#x7684;&#x65F6;&#x5019;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x903B;&#x8F91;</p>\n</li>\n<li><p>registerLiseners()</p>\n<p>&#x7ED9;&#x5BB9;&#x5668;&#x4E2D;&#x5C06;&#x6240;&#x6709;&#x7684;&#x9879;&#x76EE;&#x7684;ApplicationListener&#x6CE8;&#x518C;&#x8FDB;&#x6765;&#x3002;<br>1.&#x4ECE;&#x5BB9;&#x5668;&#x4E2D;&#x62FF;&#x5230;&#x6240;&#x6709;ApplicationListener&#x7EC4;&#x4EF6;<br>2.&#x5C06;&#x6BCF;&#x4E2A;&#x76D1;&#x542C;&#x5668;&#x6DFB;&#x52A0;&#x5230;&#x4E8B;&#x4EF6;&#x6D3E;&#x53D1;&#x5668;&#x4E2D;<br>3.&#x6D3E;&#x53D1;&#x4E4B;&#x524D;&#x6B65;&#x9AA4;&#x4EA7;&#x751F;&#x7684;&#x4E8B;&#x4EF6;</p>\n</li>\n<li><p>finishBeanFactoryInitialization()</p>\n<p>&#x521D;&#x59CB;&#x5316;&#x5269;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x5355;&#x5B9E;&#x4F8B;bean</p>\n<ul>\n<li><p>beanFactory.preInstantiateSingletons()</p>\n<p>&#x521D;&#x59CB;&#x5316;&#x5269;&#x4E0B;&#x7684;&#x5355;&#x5B9E;&#x4F8B;bean<br>1.&#x83B7;&#x53D6;&#x5BB9;&#x5668;&#x4E2D;&#x6240;&#x6709;&#x7684;Bean&#x5B9A;&#x4E49;<br>2.&#x62FF;&#x5230;Bean&#x7684;&#x5B9A;&#x4E49;&#x4FE1;&#x606F;<br>3.Bean&#x4E0D;&#x662F;&#x62BD;&#x8C61;&#x7684;&#xFF0C;&#x662F;&#x5355;&#x5B9E;&#x4F8B;&#x7684;&#xFF0C;&#x4E0D;&#x662F;&#x61D2;&#x52A0;&#x8F7D;&#x7684;</p>\n<pre><code>1.&#x5224;&#x65AD;&#x662F;&#x5426;&#x662F;FactoryBean&#xFF0C;&#x662F;&#x5426;&#x662F;&#x5B9E;&#x73B0;FactoryBean&#x63A5;&#x53E3;&#x7684;Bean\n2.&#x4E0D;&#x662F;FactoryBean&#xFF0C;&#x7528;getBean&#x521B;&#x5EFA;&#x5BF9;&#x8C61;\n3.doGetBean()\n4.&#x5148;&#x83B7;&#x53D6;&#x7F13;&#x5B58;&#x4E2D;&#x4FDD;&#x5B58;&#x7684;&#x5355;&#x5B9E;&#x4F8B;Bean&#x3002;&#x5982;&#x679C;&#x83B7;&#x53D6;&#x5230;&#xFF0C;&#x8BF4;&#x660E;&#x8FD9;&#x4E2A;Bean&#x4E4B;&#x524D;&#x88AB;&#x521B;&#x5EFA;&#x56FD;&#xFF08;&#x6240;&#x6709;&#x521B;&#x5EFA;&#x56FD;&#x7684;&#x5355;&#x5B9E;&#x4F8B;Bean&#x90FD;&#x662F;&#x4F1A;&#x88AB;&#x7F13;&#x5B58;&#x8D77;&#x6765;&#x7684;&#xFF09;\n5.&#x6362;&#x79CD;&#x79CD;&#x83B7;&#x53D6;&#x4E0D;&#x5230;&#xFF0C;&#x5F00;&#x59CB;Bean&#x7684;&#x521B;&#x5EFA;&#x5BF9;&#x8C61;&#x6D41;&#x7A0B;\n6.&#x6807;&#x8BB0;&#x5F53;&#x524D;bean&#x5DF2;&#x7ECF;&#x88AB;&#x521B;&#x5EFA;\n7.&#x83B7;&#x53D6;Bean&#x7684;&#x5B9A;&#x4E49;&#x4FE1;&#x606F;\n8.&#x83B7;&#x53D6;&#x5F53;&#x524D;Bean&#x4F9D;&#x8D56;&#x7684;&#x5176;&#x4ED6;Bean&#xFF0C;&#x5982;&#x679C;&#x6709;&#x5C31;&#x6309;&#x7167;getBean()&#x628A;&#x4EE5;&#x6765;&#x7684;Bean&#x5148;&#x521B;&#x5EFA;&#x51FA;&#x6765;&#x3002;\n9.&#x542F;&#x52A8;&#x5355;&#x5B9E;&#x4F8B;Bean&#x7684;&#x521B;&#x5EFA;&#x6D41;&#x7A0B;\n    1.createBean()\n    2.resolveBeforeInstantiation()&#x8BA9;BeanPostProcessor&#x5148;&#x62E6;&#x622A;&#x8FD4;&#x56DE;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x3010;InstantiationAwareBeanPostProcessors&#x3011;&#x63D0;&#x524D;&#x6267;&#x884C;\n    3.&#x5982;&#x679C;&#x524D;&#x9762;&#x7684;InstantiationAwareBeanPostProcessors&#x6CA1;&#x6709;&#x8FD4;&#x56DE;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;\n    4.doCreateBean()&#x521B;&#x5EFA;Bean\n        1.&#x521B;&#x5EFA;Bean&#x5B9E;&#x4F8B;&#xFF0C;createBeanInstance()&#x5229;&#x7528;&#x5DE5;&#x5382;&#x65B9;&#x6CD5;&#x6216;&#x8005;&#x5BF9;&#x8C61;&#x7684;&#x6784;&#x9020;&#x5668;&#x521B;&#x5EFA;&#x51FA;Bean&#x5B9E;&#x4F8B;\n        2.applyMergedBeanDefinitionPostProcessors()&#xFF0C;&#x8C03;&#x7528;&#x3010;MergedBeanDefinitionPostProcessors&#x3011;\n        3.populateBean() Bean&#x5C5E;&#x6027;&#x8D4B;&#x503C;</code></pre>\n</li>\n</ul>\n</li>\n<li><p>finishRefresh()</p>\n<p>&#x5B8C;&#x6210;BeanFactory&#x7684;&#x521D;&#x59CB;&#x5316;&#x521B;&#x5EFA;&#x5DE5;&#x4F5C;&#xFF0C;IOC&#x5BB9;&#x5668;&#x5C31;&#x521B;&#x5EFA;&#x5B8C;&#x6210;</p>\n<ul>\n<li><p>initLifecycleProcessor()</p>\n<p>&#x521D;&#x59CB;&#x5316;&#x548C;&#x751F;&#x547D;&#x5468;&#x671F;&#x6709;&#x5173;&#x7684;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF1A;LifecycleProcessor&#x3002;<br>&#x5199;&#x4E00;&#x4E2A;LifecycleProcessor&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;BeanFactory&#x7684;onRefresh(),onClose()&#x8FDB;&#x884C;&#x62E6;&#x622A;</p>\n</li>\n<li><p>getLifecycleProcessor().onRefresh()</p>\n<p>&#x62FF;&#x5230;&#x524D;&#x9762;&#x5B9A;&#x4E49;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x56DE;&#x8C03;onRefresh()</p>\n</li>\n<li><p>publishEvent()</p>\n<p>&#x53D1;&#x5E03;&#x5BB9;&#x5668;&#x5B8C;&#x6210;&#x4E8B;&#x4EF6;</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Springboot","path":"tags/Springboot/"}],"excerpt":"<html><head></head><body><h2 id=\"&#x5BB9;&#x5668;\"><a href=\"#&#x5BB9;&#x5668;\" class=\"headerlink\" title=\"&#x5BB9;&#x5668;\"></a>&#x5BB9;&#x5668;</h2><h3 id=\"IOC\"><a href=\"#IOC\" class=\"headerlink\" title=\"IOC\"></a>IOC</h3></body></html>","more":"<p>spring-context</p>\n<ul>\n<li><p>@Configuration</p>\n<p>告诉Spring这是一个配置类</p>\n</li>\n<li><p>@Bean</p>\n<p>给容器中注册一个Bean，类型为返回值的类型，id默认是用方法<br>默认都是单例</p>\n</li>\n<li><p>AnnotationConfigApplicationContext</p>\n</li>\n<li><p>@ComponetScan、@ComponetScans</p>\n<p>value：扫描@Service @Controller @Repositroy @Componet<br>excludeFlters：排除的规则<br>includeFilters：只需要包含的规则</p>\n<ul>\n<li><p>FilterType.ANNOTATION</p>\n<p>按照注解</p>\n</li>\n<li><p>FilterType.ASSIGNABLE_TYPE</p>\n<p>按照给定类型</p>\n</li>\n<li><p>FilterType.ASPECTJ</p>\n<p>使用ASPECTJ表达式</p>\n</li>\n<li><p>FilterType.REGEX</p>\n<p>使用正则指定</p>\n</li>\n<li><p>FilterType.CUSTOM</p>\n<p>自定义规则，必须实现TypeFilter类</p>\n</li>\n</ul>\n</li>\n<li><p>@Scope</p>\n<ul>\n<li><p>SCOPE_PROTOTPE</p>\n<p>多实例<br>IOC容器启动不回去调用方法床架你对象，获取的时候创建对象</p>\n</li>\n<li><p>SCOPE_SINGLETON</p>\n<p>单实例（默认值）<br>IOC容器启动会调用方法创建对象放到IOC容器中</p>\n</li>\n<li><p>SCOPE_REQUEST</p>\n<p>同一次请求创建一个实例</p>\n</li>\n<li><p>SCOPE_SESSION</p>\n<p>同一个Session创建一个实例</p>\n</li>\n</ul>\n</li>\n<li><p>@Lazy </p>\n<p>懒加载：容器启动不创建对象。第一次使用（获取）Bean对象时调用创建对象放入容器</p>\n</li>\n<li><p>@Conditional</p>\n<p>按照一定的条件进行判断，满足条件给容器中注册Bean<br>需要实现Condition 接口：ConditionContext 判断条件能使用的上下文；AnnotatedTypeMetadate 注释信息</p>\n</li>\n<li><p>@Import</p>\n<p>导入组件，id默认是组件的全类名（com.xxx.xxx.xx）</p>\n<ul>\n<li><p>ImportSelector</p>\n<p>自定义逻辑返回需要导入的组件。<br>返回值就是导入到容器中的组件全类名，方法不要返回null。<br>AnnotationMetadata 当前标注@Import注解的类的所有注释信息。</p>\n</li>\n<li><p>ImportBeanDefinitionRegistrar</p>\n<p>BeanDefinitionRegistry：BeanDefinition注册类。<br>调用registerBeanDefinition手工注册Bean</p>\n</li>\n</ul>\n</li>\n<li><p>FactoryBean</p>\n<p>实现FactoryBean接口<br>1.工厂Bean获取的是调用getObject创建的对象<br>2.要获取工程Bean本身，需要给id前面加一个&amp;</p>\n</li>\n</ul>\n<h3 id=\"bean的生命周期\"><a href=\"#bean的生命周期\" class=\"headerlink\" title=\"bean的生命周期\"></a>bean的生命周期</h3><ul>\n<li><p>初始化</p>\n<ul>\n<li><p>@Bean(initMethod)</p>\n</li>\n<li><p>InitializingBean</p>\n<p>通过让Bean实现该接口，实现Bean初始化逻辑</p>\n</li>\n<li><p>@PostConstruct</p>\n</li>\n<li><p>BeanPostProcessor</p>\n<p>Bean后置处理器，在Bean初始化前后进行一些处理工作</p>\n<ul>\n<li><p>postProcessBeforeInitialization</p>\n<p>在初始化之前</p>\n</li>\n<li><p>postProcessAfterInitialization</p>\n<p>在初始化工作之后</p>\n</li>\n<li><p>ApplicationContextAwareProcessor</p>\n<p>实现该接口，Spring容器可以将当前容器传给实现类</p>\n</li>\n<li><p>InitDestroyAnnotationBeanPostProcessor</p>\n<p>处理@PostConstruct，@PreDestory注解</p>\n</li>\n<li><p>AutowiredAnnotationBeanPostProcessor</p>\n<p>处理@Autowired注解</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>销毁</p>\n<ul>\n<li><p>@Bean(destroyMethod)</p>\n<p>多实例的bean，容器不会调用销毁方法</p>\n</li>\n<li><p>DisposableBean</p>\n<p>通过实现该接口，实现销毁逻辑</p>\n</li>\n<li><p>@PreDestory</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"属性赋值\"><a href=\"#属性赋值\" class=\"headerlink\" title=\"属性赋值\"></a>属性赋值</h3><ul>\n<li><p>@Value</p>\n<ul>\n<li><p>基本数值</p>\n</li>\n<li><p>SpEL  #{}</p>\n</li>\n<li><p>配置文件 ${}</p>\n<p>@PropertySource 读取外部配置文件，保存至环境变量中</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"自动装配\"><a href=\"#自动装配\" class=\"headerlink\" title=\"自动装配\"></a>自动装配</h3><ul>\n<li><p>@Autowired</p>\n<p>1.默认按照类型在容器中找相应的组件<br>2.如果找到多个相同类型的组件，再将属性的名称作为组件的id组容易中寻找<br>3.使用@Qualifier指定需要装配的组件的id<br>4.自动装配默认一定要指定存在的属性（如果不强制指定，使用require=false）<br>5.@Primary,让Spring进行自动装配的时候，默认是用首选的bean</p>\n<ul>\n<li><p>构造器</p>\n<p>构造器用到的自定义类型的值从IOC容器中获取<br>如果组建只有一个有参构造器，这个有参构造器的@Autowired可以省略，参数位置的组件还是可以从容器中获取</p>\n</li>\n<li><p>方法</p>\n<p>标注在方法，Spring容器创建当前对象，就会调用方法完成赋值<br>方法使用的参数，自定义类型的值从IOC容器中获取</p>\n</li>\n<li><p>属性</p>\n<p>值从IOC容器中获取</p>\n</li>\n</ul>\n</li>\n<li><p>@Resource</p>\n<p>可以和@Autowired一样实现自动装配，默认按照属性名称进行装配<br>没有支持@Primary功能，reqiured=false</p>\n</li>\n<li><p>@Inject</p>\n<p>需要依赖javax.inject包，和Autowired一样，没有reqiured=false</p>\n</li>\n<li><p>实现xxxAware接口</p>\n<p>在创建对象的时候，会调用接口的回调方法<br>把Spring底层的组件注册到自定义的Bean中<br>xxxAware功能使用xxxProcessor处理的</p>\n<ul>\n<li><p>ApplicationContextAware</p>\n<p>获取ApplicationContext</p>\n</li>\n<li><p>BeanNameAware</p>\n</li>\n<li><p>EmbeddedValueResolverAware</p>\n</li>\n</ul>\n</li>\n<li><p>Profile</p>\n<p>加了环境表示的bean，只有这个环境被激活的时候才能注册到容器中，默认是default环境</p>\n<ul>\n<li><p>启动参数</p>\n<p>-Dspring.profiles.active=xxx</p>\n</li>\n<li><p>代码</p>\n<p>1.创建一个aplicationContext<br>2.设置需要激活的环境.getEnvironment().setActiveProfiles()<br>3.注册朱配置类  .register()<br>4.启动刷新容器 .refresh()</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"AOP\"><a href=\"#AOP\" class=\"headerlink\" title=\"AOP\"></a>AOP</h3><p>在程序运行期间动态的将某段代码切入到指定方法指定位置进行运行的编程方式<br>spring-aspects<br>容器中保存了组建的代理对象(cglib增强后的对象),这个对象里面保存了详细信息(比如增强器，目标对象)</p>\n<ul>\n<li><p>@Before</p>\n<p>在目标方法之前切入：切入点表达式（指定在那个方法切入）</p>\n</li>\n<li><p>@After</p>\n<p>在目标方法之后切入：切入点表达式</p>\n</li>\n<li><p>@PointCut</p>\n<p>切入点表达式</p>\n</li>\n<li><p>@AfterReturning</p>\n<p>再放标方法正常返回之后运行</p>\n</li>\n<li><p>@AfterThrowing</p>\n<p>在目标方法出现异常之后运行</p>\n</li>\n<li><p>@Aspect</p>\n<p>告诉Spring当前类是一个切面类</p>\n</li>\n<li><p>@EnableAspectJAutoProxy</p>\n<p>开启基于注解的AOP<br>1.给容器中导入AspectJAutoProxyRegistrar，给容器中注册一个AnnotationAwareAspectJAutoProxyCreator</p>\n<ul>\n<li><p>AnnotationAwareAspectJAutoProxyCreator</p>\n<ul>\n<li><p>AspectJAwareAdvisorAutoProxyCreator</p>\n<ul>\n<li><p>AbstractAdvisorAutoProxyCreator</p>\n<ul>\n<li><p>AbstractAutoProxyCreator</p>\n<ul>\n<li>SmartInstantiationAwareBeanPostProcessor</li>\n<li>BeanFactroyAware</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li><p>JoinPoint</p>\n<p>JoinPoint一定要出现在参数表的第一位</p>\n</li>\n<li><p>目标方法执行</p>\n<p>1.CglibAopProxy.intercept()。拦截目标方法的执行。<br>2.根据PoxyFactory对象获取将要执行的目标方法拦截器链</p>\n<pre><code>a)如果没有拦截器链，直接执行目标方法\nb)如果有拦截器链，把需要执行的目标对象，目标方法，拦截器链等信息出入创建一个CglibMethodInvocation，并调用proceed()方法\nc)拦截器链触发过程\n    1.如果没有拦截器执行目标方法，或者懒机器的索引和拦截器数组-1大小一样(指定到了最后一个拦截器)，执行目标方法。</code></pre>\n</li>\n</ul>\n<h3 id=\"声明式事务\"><a href=\"#声明式事务\" class=\"headerlink\" title=\"声明式事务\"></a>声明式事务</h3><p>1.导入相关依赖spring-jdbc<br>2.配置数据源 JdbcTmplate<br>3.给方法标注@Transactional<br>4.@EnableTransactionManagement 开启基于注解的事物<br>5.配置事物管理器管理事物</p>\n<ul>\n<li><p>@Transactional</p>\n</li>\n<li><p>@EnableTransactionManagement</p>\n<ul>\n<li><p>TransactionManagementConfigurationSelection</p>\n<p>给容器中导入组件</p>\n<ul>\n<li><p>AutoProxyRegistrar</p>\n<p>给容器中注册InfrastructureAdvisorAutoProxyCreator组件</p>\n<ul>\n<li><p>InfrastructureAdvisorAutoProxyCreator</p>\n<p>利用后置处理器机制在对象创建后，包装对象，返回一个代理对象（增强器），代理对象执行方法利用拦截器链执行方法</p>\n</li>\n</ul>\n</li>\n<li><p>ProxyTransactionManagementConfiguration</p>\n<p>1.给容器中注册事物增强器</p>\n<pre><code>事物增强器要用事物注解信息\n事物拦截器，保存了事物的属性信息，事物管理器，是一个MethodInterceptor，在目标方法执行时执行拦截器链</code></pre>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"扩展原理\"><a href=\"#扩展原理\" class=\"headerlink\" title=\"扩展原理\"></a>扩展原理</h2><h3 id=\"BeanFactoryPostProcessor\"><a href=\"#BeanFactoryPostProcessor\" class=\"headerlink\" title=\"BeanFactoryPostProcessor\"></a>BeanFactoryPostProcessor</h3><p>BeanFactory后置处理器<br>    在BeanFactory标准初始化之后调用，所有的bean定义以保存在遭到beanFactory，但是bean还未创建</p>\n<ul>\n<li><p>BeanDefinitionRegistryPostProcessor</p>\n<p>在所有bean定义信息将要被加载，bean实力还未被创建时执行</p>\n</li>\n</ul>\n<h3 id=\"ApplicationListener\"><a href=\"#ApplicationListener\" class=\"headerlink\" title=\"ApplicationListener\"></a>ApplicationListener</h3><p>监听容器中发布的事件<br>    1.写一个监听器，ApplicationListener实现类，来监听某个事件ApplicationEvent机器子类<br>    2.把监听器加入到容器<br>    3.只要容器中有相关事件的腹部，我们就能监听到这个事件：<br>        ContextRefreshedEvent：容器舒心完成(所有bean都完全创建)会发布这个事件；<br>        ContextClosedEvent：关闭容器会发布这个事件<br>    4.发布一个事件，applicationContext.publishEvent()</p>\n<h3 id=\"容器的创建\"><a href=\"#容器的创建\" class=\"headerlink\" title=\"容器的创建\"></a>容器的创建</h3><p>1.Spring容器在启动的时候，先会保存所有注册进来的Bean的定义信息<br>    xml<br>    注解<br>2.Spring容器会合适的时机创建这些Bean<br>    用到这个bean的时候，利用getBean创建bean，创建好以后保存在容器中<br>    统一创建剩下所有的bean的时候，finshBeanFactoryInitialization()<br>3.后置处理器<br>    每个bean创建完成，都会使用各种后置处理器，来增强bean的功能<br>4.事件驱动模型<br>    ApplicationListener，事件监听<br>事件派发，ApplicationEvenMulticator</p>\n<ul>\n<li><p>refresh()</p>\n<ul>\n<li><p>prepareRefresh()</p>\n<p>刷新预处理工作:<br>清缓存<br>置状态</p>\n<ul>\n<li><p>initPropertySources()</p>\n<p>初始化属性设置，子类自定义个性化的属性设置方法。</p>\n</li>\n<li><p>getEnvironment().validateRequiredProperties()</p>\n<p>检验属性的合法</p>\n</li>\n<li><p>earlyApplicationEvents</p>\n<p>保存容器中的一起早起事件</p>\n</li>\n</ul>\n</li>\n<li><p>obtainFreshBeanFactory()</p>\n<p>获取BeanFactory</p>\n<ul>\n<li><p>refreshBeanFactory()</p>\n<p>刷新BeanFactory工厂，创建BeanFactory对象。</p>\n</li>\n<li><p>getBeanFactory()【DefaultListableBeanFactory】</p>\n<p>获取之前创建好的BeanFactory</p>\n</li>\n<li><p>prepareBeanFactory()</p>\n<p>BeanFactory的预准备工作（BeanFactory进行一些设置）<br>1.设置BeanFactory的类加载器，支持表达式解析器。。。<br>2.添加部分BeanPostProcessor【ApplicationContextAwareProcessor】<br>3.设置忽略的自动装配的接口，EnvironmentAware、EmbeddedValueResolverAware。。。<br>4.注册可以解析的自动装配，我们能直接在仍和组件中自动注入：BeanFactory、ResourceLoader、ApplicationEventPublisher、ApplicationContext<br>5.添加BeanPostProcessor【ApplicationListenerDetector】<br>6.添加编译是的AspectJ支持<br>7.给BeanFactory中注册一些能用的组件：environment【ConfigurableEnvironment】、systemProperties【Map】</p>\n</li>\n<li><p>postProcessBeanFactory()</p>\n<p>BeanFactory准备完成后的后置处理工作，子类用过重写这个发方法来在BeanFactory初始化完成后进行更进一步的工作</p>\n</li>\n<li><p>invokeBeanFactoryPostProcessors()</p>\n<p>执行BeanFactoryPostProcessor：BeanFactory的后置处理器，在BeanFactory标准初始化之后执行</p>\n<p>执行BeanFactoryPostProcessor的方法：<br>1.先执行BeanDefinitonRegistryPostProcessor</p>\n<pre><code>获取所有的BeanDefinitonRegistryPostProcessor\n先执行实现了PriorityOrdered接口的\n再执行实现了Ordered接口的\n最后执行剩下的</code></pre>\n<p>2.再执行BeanFactoryPostProcessor的方法</p>\n<pre><code>先执行实现了PriorityOrdered接口的\n再执行实现了Ordered接口的\n最后执行剩下的</code></pre>\n</li>\n</ul>\n</li>\n<li><p>registerBeanPostProcessors()</p>\n<p>注册BeanPostProcessor，Bean的后置处理器。<br>1.获取所有的BeanPostProcessor，不同接口类型的BeanPostProcessor，在Bean船舰前后的执行实际是不一样的。</p>\n<pre><code>BeanPostProcessor\nDestructionAwareBeanPostProcessor\nInstantiationAwareBeanPostProcessor\nSmartInstantiationAwareBeanPostProcessor\nMergedBeanDefinitionPostProcessor</code></pre>\n</li>\n<li><p>initMessageSource()</p>\n<p>初始化MessageSource组件（做国际化功能，消息绑定、解析）<br>1.获取BeanFactory<br>2.看容器中是否有id为messageSource的组件</p>\n<pre><code>如果有赋值给messageSource，如果没有自己创建【DelegatingMessageSource】</code></pre>\n<p>3.把创建好的MessageSource注册在容器中</p>\n</li>\n<li><p>initApplicationEventMulticaster()</p>\n<p>初始化事件派发器<br>1.从BeanFactory中获取applicationEventMulticaster的ApplicationEventMulticaster<br>2.如果没有配置，创建SimpleApplicationEventMulticaster<br>3.注册到容器中</p>\n</li>\n<li><p>onRefresh()</p>\n<p>留给子容器的（子类）<br>1.子类重写这个方法，在容器刷新的时候可以自定义逻辑</p>\n</li>\n<li><p>registerLiseners()</p>\n<p>给容器中将所有的项目的ApplicationListener注册进来。<br>1.从容器中拿到所有ApplicationListener组件<br>2.将每个监听器添加到事件派发器中<br>3.派发之前步骤产生的事件</p>\n</li>\n<li><p>finishBeanFactoryInitialization()</p>\n<p>初始化剩下的所有单实例bean</p>\n<ul>\n<li><p>beanFactory.preInstantiateSingletons()</p>\n<p>初始化剩下的单实例bean<br>1.获取容器中所有的Bean定义<br>2.拿到Bean的定义信息<br>3.Bean不是抽象的，是单实例的，不是懒加载的</p>\n<pre><code>1.判断是否是FactoryBean，是否是实现FactoryBean接口的Bean\n2.不是FactoryBean，用getBean创建对象\n3.doGetBean()\n4.先获取缓存中保存的单实例Bean。如果获取到，说明这个Bean之前被创建国（所有创建国的单实例Bean都是会被缓存起来的）\n5.换种种获取不到，开始Bean的创建对象流程\n6.标记当前bean已经被创建\n7.获取Bean的定义信息\n8.获取当前Bean依赖的其他Bean，如果有就按照getBean()把以来的Bean先创建出来。\n9.启动单实例Bean的创建流程\n    1.createBean()\n    2.resolveBeforeInstantiation()让BeanPostProcessor先拦截返回代理对象【InstantiationAwareBeanPostProcessors】提前执行\n    3.如果前面的InstantiationAwareBeanPostProcessors没有返回代理对象\n    4.doCreateBean()创建Bean\n        1.创建Bean实例，createBeanInstance()利用工厂方法或者对象的构造器创建出Bean实例\n        2.applyMergedBeanDefinitionPostProcessors()，调用【MergedBeanDefinitionPostProcessors】\n        3.populateBean() Bean属性赋值</code></pre>\n</li>\n</ul>\n</li>\n<li><p>finishRefresh()</p>\n<p>完成BeanFactory的初始化创建工作，IOC容器就创建完成</p>\n<ul>\n<li><p>initLifecycleProcessor()</p>\n<p>初始化和生命周期有关的后置处理器：LifecycleProcessor。<br>写一个LifecycleProcessor的实现类，可以在BeanFactory的onRefresh(),onClose()进行拦截</p>\n</li>\n<li><p>getLifecycleProcessor().onRefresh()</p>\n<p>拿到前面定义的生命周期处理器，回调onRefresh()</p>\n</li>\n<li><p>publishEvent()</p>\n<p>发布容器完成事件</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>"},{"title":"hexo搭建问题【 no layout: index.html】","date":"2019-09-07T08:03:18.000Z","_content":"\n由于在公司都是用MAC写博客，回到家想用Windows搭一套环境。\n\n但是启动的时候总是提示no layout: index.html 的错误。\n\n找了半天原因原来是个很傻的问题，这里mark下以免下次再犯。\n\n![01](hexo搭建问题【-no-layout-index-html】/nolayout.jpg)\n\n模板是空的！！！模板是空的！！！模板是空的！！！","source":"_posts/hexo搭建问题【-no-layout-index-html】.md","raw":"---\ntitle: 'hexo搭建问题【 no layout: index.html】'\ndate: 2019-09-07 16:03:18\ntags: \n    - Hexo\ncategories :\n    - Technology\n---\n\n由于在公司都是用MAC写博客，回到家想用Windows搭一套环境。\n\n但是启动的时候总是提示no layout: index.html 的错误。\n\n找了半天原因原来是个很傻的问题，这里mark下以免下次再犯。\n\n![01](hexo搭建问题【-no-layout-index-html】/nolayout.jpg)\n\n模板是空的！！！模板是空的！！！模板是空的！！！","slug":"hexo搭建问题【-no-layout-index-html】","published":1,"updated":"2020-12-14T10:40:39.272Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71ht6000cv2526aao0clh","content":"<html><head></head><body><p>&#x7531;&#x4E8E;&#x5728;&#x516C;&#x53F8;&#x90FD;&#x662F;&#x7528;MAC&#x5199;&#x535A;&#x5BA2;&#xFF0C;&#x56DE;&#x5230;&#x5BB6;&#x60F3;&#x7528;Windows&#x642D;&#x4E00;&#x5957;&#x73AF;&#x5883;&#x3002;</p>\n<p>&#x4F46;&#x662F;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x603B;&#x662F;&#x63D0;&#x793A;no layout: index.html &#x7684;&#x9519;&#x8BEF;&#x3002;</p>\n<p>&#x627E;&#x4E86;&#x534A;&#x5929;&#x539F;&#x56E0;&#x539F;&#x6765;&#x662F;&#x4E2A;&#x5F88;&#x50BB;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x8FD9;&#x91CC;mark&#x4E0B;&#x4EE5;&#x514D;&#x4E0B;&#x6B21;&#x518D;&#x72AF;&#x3002;</p>\n<p><img src=\"/2019/09/07/hexo%E6%90%AD%E5%BB%BA%E9%97%AE%E9%A2%98%E3%80%90-no-layout-index-html%E3%80%91/nolayout.jpg\" alt=\"01\"></p>\n<p>&#x6A21;&#x677F;&#x662F;&#x7A7A;&#x7684;&#xFF01;&#xFF01;&#xFF01;&#x6A21;&#x677F;&#x662F;&#x7A7A;&#x7684;&#xFF01;&#xFF01;&#xFF01;&#x6A21;&#x677F;&#x662F;&#x7A7A;&#x7684;&#xFF01;&#xFF01;&#xFF01;</p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Hexo","path":"tags/Hexo/"}],"excerpt":"","more":"<p>由于在公司都是用MAC写博客，回到家想用Windows搭一套环境。</p>\n<p>但是启动的时候总是提示no layout: index.html 的错误。</p>\n<p>找了半天原因原来是个很傻的问题，这里mark下以免下次再犯。</p>\n<p><img src=\"/2019/09/07/hexo%E6%90%AD%E5%BB%BA%E9%97%AE%E9%A2%98%E3%80%90-no-layout-index-html%E3%80%91/nolayout.jpg\" alt=\"01\"></p>\n<p>模板是空的！！！模板是空的！！！模板是空的！！！</p>\n"},{"title":"linux提供加载、处理动态链接库的系统调用方法","date":"2020-09-24T06:44:08.000Z","_content":"\n我们知道目前Java提供的工具如javac、jps、jstat、jmap等都是通过Java的自举实现的。然而启动JVM的命令的java却是由C语言开发的。至于原因通过翻阅OpenJdk源码我猜测：是为了不提供JNI接口的前提下，需要动态链接调用JVM库所导致的。\n<!-- more -->\n\n### java.c中动态链接jvm库相关代码\n\n>代码清单：src/solaris/bin/java_md_solinux.c\n```C\njboolean\nLoadJavaVM(const char *jvmpath, InvocationFunctions *ifn)\n{\n    void *libjvm;\n\n    JLI_TraceLauncher(\"JVM path is %s\\n\", jvmpath);\n\n    libjvm = dlopen(jvmpath, RTLD_NOW + RTLD_GLOBAL);\n    if (libjvm == NULL) {\n#if defined(__solaris__) && defined(__sparc) && !defined(_LP64) /* i.e. 32-bit sparc */\n      FILE * fp;\n      Elf32_Ehdr elf_head;\n      int count;\n      int location;\n\n      fp = fopen(jvmpath, \"r\");\n      if (fp == NULL) {\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n      }\n\n      /* read in elf header */\n      count = fread((void*)(&elf_head), sizeof(Elf32_Ehdr), 1, fp);\n      fclose(fp);\n      if (count < 1) {\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n      }\n\n      /*\n       * Check for running a server vm (compiled with -xarch=v8plus)\n       * on a stock v8 processor.  In this case, the machine type in\n       * the elf header would not be included the architecture list\n       * provided by the isalist command, which is turn is gotten from\n       * sysinfo.  This case cannot occur on 64-bit hardware and thus\n       * does not have to be checked for in binaries with an LP64 data\n       * model.\n       */\n      if (elf_head.e_machine == EM_SPARC32PLUS) {\n        char buf[257];  /* recommended buffer size from sysinfo man\n                           page */\n        long length;\n        char* location;\n\n        length = sysinfo(SI_ISALIST, buf, 257);\n        if (length > 0) {\n            location = JLI_StrStr(buf, \"sparcv8plus \");\n          if (location == NULL) {\n            JLI_ReportErrorMessage(JVM_ERROR3);\n            return JNI_FALSE;\n          }\n        }\n      }\n#endif\n        JLI_ReportErrorMessage(DLL_ERROR1, __LINE__);\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n    }\n\n    ifn->CreateJavaVM = (CreateJavaVM_t)\n        dlsym(libjvm, \"JNI_CreateJavaVM\");\n    if (ifn->CreateJavaVM == NULL) {\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n    }\n\n    ifn->GetDefaultJavaVMInitArgs = (GetDefaultJavaVMInitArgs_t)\n        dlsym(libjvm, \"JNI_GetDefaultJavaVMInitArgs\");\n    if (ifn->GetDefaultJavaVMInitArgs == NULL) {\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n    }\n\n    ifn->GetCreatedJavaVMs = (GetCreatedJavaVMs_t)\n        dlsym(libjvm, \"JNI_GetCreatedJavaVMs\");\n    if (ifn->GetCreatedJavaVMs == NULL) {\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n    }\n\n    return JNI_TRUE;\n}\n```\n\n### 总结下Linux下动态链接的使用\n\n1. dlopen\n以指定模式打开指定的动态链接库文件，并返回一个句柄给调用进程\n\n##### 方法定义\n```C\nvoid *dlopen(const char *filename, int flag);\n```\n\n- filename 文件路径\n- flag \n    1. RTLD_LAZY 暂缓决定，等有需要是再解出符号\n    2. RTLD_NOW 立即决定，返回前解除所有未决定的符号\n    \n##### 方法使用\n```c\nvoid *handle;\nhandle = dlopen(动态链接库路径, RTLD_LAZY);\n```\n\n2. dlsym\n通过句柄和连接符名称获取函数名或者变量名\n\n##### 方法定义\n```C\nvoid *dlsym(void *handle, const char *symbol);\n```\n\n##### 方法使用\n```C\nifn->CreateJavaVM = (CreateJavaVM_t)\n        dlsym(libjvm, \"JNI_CreateJavaVM\");\n```\n\n\n3. dlclose\n卸载打开的库\n\n##### 方法定义\n```C\nint dlclose(void *handle);\n```\n\n##### 方法使用\n```C\ndlclose(handle);\n```","source":"_posts/linux提供加载、处理动态链接库的系统调用方法.md","raw":"---\ntitle: linux提供加载、处理动态链接库的系统调用方法\ndate: 2020-09-24 14:44:08\ntags: \n    - Linux\n    - C\ncategories :\n    - Technology\n---\n\n我们知道目前Java提供的工具如javac、jps、jstat、jmap等都是通过Java的自举实现的。然而启动JVM的命令的java却是由C语言开发的。至于原因通过翻阅OpenJdk源码我猜测：是为了不提供JNI接口的前提下，需要动态链接调用JVM库所导致的。\n<!-- more -->\n\n### java.c中动态链接jvm库相关代码\n\n>代码清单：src/solaris/bin/java_md_solinux.c\n```C\njboolean\nLoadJavaVM(const char *jvmpath, InvocationFunctions *ifn)\n{\n    void *libjvm;\n\n    JLI_TraceLauncher(\"JVM path is %s\\n\", jvmpath);\n\n    libjvm = dlopen(jvmpath, RTLD_NOW + RTLD_GLOBAL);\n    if (libjvm == NULL) {\n#if defined(__solaris__) && defined(__sparc) && !defined(_LP64) /* i.e. 32-bit sparc */\n      FILE * fp;\n      Elf32_Ehdr elf_head;\n      int count;\n      int location;\n\n      fp = fopen(jvmpath, \"r\");\n      if (fp == NULL) {\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n      }\n\n      /* read in elf header */\n      count = fread((void*)(&elf_head), sizeof(Elf32_Ehdr), 1, fp);\n      fclose(fp);\n      if (count < 1) {\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n      }\n\n      /*\n       * Check for running a server vm (compiled with -xarch=v8plus)\n       * on a stock v8 processor.  In this case, the machine type in\n       * the elf header would not be included the architecture list\n       * provided by the isalist command, which is turn is gotten from\n       * sysinfo.  This case cannot occur on 64-bit hardware and thus\n       * does not have to be checked for in binaries with an LP64 data\n       * model.\n       */\n      if (elf_head.e_machine == EM_SPARC32PLUS) {\n        char buf[257];  /* recommended buffer size from sysinfo man\n                           page */\n        long length;\n        char* location;\n\n        length = sysinfo(SI_ISALIST, buf, 257);\n        if (length > 0) {\n            location = JLI_StrStr(buf, \"sparcv8plus \");\n          if (location == NULL) {\n            JLI_ReportErrorMessage(JVM_ERROR3);\n            return JNI_FALSE;\n          }\n        }\n      }\n#endif\n        JLI_ReportErrorMessage(DLL_ERROR1, __LINE__);\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n    }\n\n    ifn->CreateJavaVM = (CreateJavaVM_t)\n        dlsym(libjvm, \"JNI_CreateJavaVM\");\n    if (ifn->CreateJavaVM == NULL) {\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n    }\n\n    ifn->GetDefaultJavaVMInitArgs = (GetDefaultJavaVMInitArgs_t)\n        dlsym(libjvm, \"JNI_GetDefaultJavaVMInitArgs\");\n    if (ifn->GetDefaultJavaVMInitArgs == NULL) {\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n    }\n\n    ifn->GetCreatedJavaVMs = (GetCreatedJavaVMs_t)\n        dlsym(libjvm, \"JNI_GetCreatedJavaVMs\");\n    if (ifn->GetCreatedJavaVMs == NULL) {\n        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());\n        return JNI_FALSE;\n    }\n\n    return JNI_TRUE;\n}\n```\n\n### 总结下Linux下动态链接的使用\n\n1. dlopen\n以指定模式打开指定的动态链接库文件，并返回一个句柄给调用进程\n\n##### 方法定义\n```C\nvoid *dlopen(const char *filename, int flag);\n```\n\n- filename 文件路径\n- flag \n    1. RTLD_LAZY 暂缓决定，等有需要是再解出符号\n    2. RTLD_NOW 立即决定，返回前解除所有未决定的符号\n    \n##### 方法使用\n```c\nvoid *handle;\nhandle = dlopen(动态链接库路径, RTLD_LAZY);\n```\n\n2. dlsym\n通过句柄和连接符名称获取函数名或者变量名\n\n##### 方法定义\n```C\nvoid *dlsym(void *handle, const char *symbol);\n```\n\n##### 方法使用\n```C\nifn->CreateJavaVM = (CreateJavaVM_t)\n        dlsym(libjvm, \"JNI_CreateJavaVM\");\n```\n\n\n3. dlclose\n卸载打开的库\n\n##### 方法定义\n```C\nint dlclose(void *handle);\n```\n\n##### 方法使用\n```C\ndlclose(handle);\n```","slug":"linux提供加载、处理动态链接库的系统调用方法","published":1,"updated":"2020-12-14T09:51:24.016Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71ht7000dv2527ey8fo8p","content":"<html><head></head><body><p>&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x76EE;&#x524D;Java&#x63D0;&#x4F9B;&#x7684;&#x5DE5;&#x5177;&#x5982;javac&#x3001;jps&#x3001;jstat&#x3001;jmap&#x7B49;&#x90FD;&#x662F;&#x901A;&#x8FC7;Java&#x7684;&#x81EA;&#x4E3E;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x7136;&#x800C;&#x542F;&#x52A8;JVM&#x7684;&#x547D;&#x4EE4;&#x7684;java&#x5374;&#x662F;&#x7531;C&#x8BED;&#x8A00;&#x5F00;&#x53D1;&#x7684;&#x3002;&#x81F3;&#x4E8E;&#x539F;&#x56E0;&#x901A;&#x8FC7;&#x7FFB;&#x9605;OpenJdk&#x6E90;&#x7801;&#x6211;&#x731C;&#x6D4B;&#xFF1A;&#x662F;&#x4E3A;&#x4E86;&#x4E0D;&#x63D0;&#x4F9B;JNI&#x63A5;&#x53E3;&#x7684;&#x524D;&#x63D0;&#x4E0B;&#xFF0C;&#x9700;&#x8981;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x8C03;&#x7528;JVM&#x5E93;&#x6240;&#x5BFC;&#x81F4;&#x7684;&#x3002;</p>\n<a id=\"more\"></a>\n\n<h3 id=\"java-c&#x4E2D;&#x52A8;&#x6001;&#x94FE;&#x63A5;jvm&#x5E93;&#x76F8;&#x5173;&#x4EE3;&#x7801;\"><a href=\"#java-c&#x4E2D;&#x52A8;&#x6001;&#x94FE;&#x63A5;jvm&#x5E93;&#x76F8;&#x5173;&#x4EE3;&#x7801;\" class=\"headerlink\" title=\"java.c&#x4E2D;&#x52A8;&#x6001;&#x94FE;&#x63A5;jvm&#x5E93;&#x76F8;&#x5173;&#x4EE3;&#x7801;\"></a>java.c&#x4E2D;&#x52A8;&#x6001;&#x94FE;&#x63A5;jvm&#x5E93;&#x76F8;&#x5173;&#x4EE3;&#x7801;</h3><blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/solaris/bin/java_md_solinux.c</p>\n</blockquote>\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jboolean</span><br><span class=\"line\">LoadJavaVM(<span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">char</span> *jvmpath, InvocationFunctions *ifn)</span><br><span class=\"line\">{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">void</span> *libjvm;</span><br><span class=\"line\"></span><br><span class=\"line\">    JLI_TraceLauncher(<span class=\"hljs-string\">&quot;JVM path is %s\\n&quot;</span>, jvmpath);</span><br><span class=\"line\"></span><br><span class=\"line\">    libjvm = dlopen(jvmpath, RTLD_NOW + RTLD_GLOBAL);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (libjvm == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">if</span> defined(__solaris__) &amp;&amp; defined(__sparc) &amp;&amp; !defined(_LP64) <span class=\"hljs-comment\">/* i.e. 32-bit sparc */</span></span></span><br><span class=\"line\">      FILE * fp;</span><br><span class=\"line\">      Elf32_Ehdr elf_head;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">int</span> count;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">int</span> location;</span><br><span class=\"line\"></span><br><span class=\"line\">      fp = fopen(jvmpath, <span class=\"hljs-string\">&quot;r&quot;</span>);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (fp == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">      }</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">/* read in elf header */</span></span><br><span class=\"line\">      count = fread((<span class=\"hljs-keyword\">void</span>*)(&amp;elf_head), <span class=\"hljs-keyword\">sizeof</span>(Elf32_Ehdr), <span class=\"hljs-number\">1</span>, fp);</span><br><span class=\"line\">      fclose(fp);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (count &lt; <span class=\"hljs-number\">1</span>) {</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">      }</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">/*</span></span><br><span class=\"line\"><span class=\"hljs-comment\">       * Check for running a server vm (compiled with -xarch=v8plus)</span></span><br><span class=\"line\"><span class=\"hljs-comment\">       * on a stock v8 processor.  In this case, the machine type in</span></span><br><span class=\"line\"><span class=\"hljs-comment\">       * the elf header would not be included the architecture list</span></span><br><span class=\"line\"><span class=\"hljs-comment\">       * provided by the isalist command, which is turn is gotten from</span></span><br><span class=\"line\"><span class=\"hljs-comment\">       * sysinfo.  This case cannot occur on 64-bit hardware and thus</span></span><br><span class=\"line\"><span class=\"hljs-comment\">       * does not have to be checked for in binaries with an LP64 data</span></span><br><span class=\"line\"><span class=\"hljs-comment\">       * model.</span></span><br><span class=\"line\"><span class=\"hljs-comment\">       */</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (elf_head.e_machine == EM_SPARC32PLUS) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">char</span> buf[<span class=\"hljs-number\">257</span>];  <span class=\"hljs-comment\">/* recommended buffer size from sysinfo man</span></span><br><span class=\"line\"><span class=\"hljs-comment\">                           page */</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">long</span> length;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">char</span>* location;</span><br><span class=\"line\"></span><br><span class=\"line\">        length = sysinfo(SI_ISALIST, buf, <span class=\"hljs-number\">257</span>);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (length &gt; <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">            location = JLI_StrStr(buf, <span class=\"hljs-string\">&quot;sparcv8plus &quot;</span>);</span><br><span class=\"line\">          <span class=\"hljs-keyword\">if</span> (location == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">            JLI_ReportErrorMessage(JVM_ERROR3);</span><br><span class=\"line\">            <span class=\"hljs-keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">          }</span><br><span class=\"line\">        }</span><br><span class=\"line\">      }</span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">endif</span></span></span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR1, __LINE__);</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    ifn-&gt;CreateJavaVM = (CreateJavaVM_t)</span><br><span class=\"line\">        dlsym(libjvm, <span class=\"hljs-string\">&quot;JNI_CreateJavaVM&quot;</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (ifn-&gt;CreateJavaVM == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    ifn-&gt;GetDefaultJavaVMInitArgs = (GetDefaultJavaVMInitArgs_t)</span><br><span class=\"line\">        dlsym(libjvm, <span class=\"hljs-string\">&quot;JNI_GetDefaultJavaVMInitArgs&quot;</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (ifn-&gt;GetDefaultJavaVMInitArgs == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    ifn-&gt;GetCreatedJavaVMs = (GetCreatedJavaVMs_t)</span><br><span class=\"line\">        dlsym(libjvm, <span class=\"hljs-string\">&quot;JNI_GetCreatedJavaVMs&quot;</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (ifn-&gt;GetCreatedJavaVMs == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> JNI_TRUE;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h3 id=\"&#x603B;&#x7ED3;&#x4E0B;Linux&#x4E0B;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x7684;&#x4F7F;&#x7528;\"><a href=\"#&#x603B;&#x7ED3;&#x4E0B;Linux&#x4E0B;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x7684;&#x4F7F;&#x7528;\" class=\"headerlink\" title=\"&#x603B;&#x7ED3;&#x4E0B;Linux&#x4E0B;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x7684;&#x4F7F;&#x7528;\"></a>&#x603B;&#x7ED3;&#x4E0B;Linux&#x4E0B;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x7684;&#x4F7F;&#x7528;</h3><ol>\n<li>dlopen<br>&#x4EE5;&#x6307;&#x5B9A;&#x6A21;&#x5F0F;&#x6253;&#x5F00;&#x6307;&#x5B9A;&#x7684;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x5E93;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;&#x53E5;&#x67C4;&#x7ED9;&#x8C03;&#x7528;&#x8FDB;&#x7A0B;</li>\n</ol>\n<h5 id=\"&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;\"><a href=\"#&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;\" class=\"headerlink\" title=\"&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;\"></a>&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;</h5><figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> *<span class=\"hljs-title\">dlopen</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">char</span> *filename, <span class=\"hljs-keyword\">int</span> flag)</span></span>;</span><br></pre></td></tr></tbody></table></figure>\n\n<ul>\n<li>filename &#x6587;&#x4EF6;&#x8DEF;&#x5F84;</li>\n<li>flag <ol>\n<li>RTLD_LAZY &#x6682;&#x7F13;&#x51B3;&#x5B9A;&#xFF0C;&#x7B49;&#x6709;&#x9700;&#x8981;&#x662F;&#x518D;&#x89E3;&#x51FA;&#x7B26;&#x53F7;</li>\n<li>RTLD_NOW &#x7ACB;&#x5373;&#x51B3;&#x5B9A;&#xFF0C;&#x8FD4;&#x56DE;&#x524D;&#x89E3;&#x9664;&#x6240;&#x6709;&#x672A;&#x51B3;&#x5B9A;&#x7684;&#x7B26;&#x53F7;</li>\n</ol>\n</li>\n</ul>\n<h5 id=\"&#x65B9;&#x6CD5;&#x4F7F;&#x7528;\"><a href=\"#&#x65B9;&#x6CD5;&#x4F7F;&#x7528;\" class=\"headerlink\" title=\"&#x65B9;&#x6CD5;&#x4F7F;&#x7528;\"></a>&#x65B9;&#x6CD5;&#x4F7F;&#x7528;</h5><figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">void</span> *handle;</span><br><span class=\"line\">handle = dlopen(&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x5E93;&#x8DEF;&#x5F84;, RTLD_LAZY);</span><br></pre></td></tr></tbody></table></figure>\n\n<ol start=\"2\">\n<li>dlsym<br>&#x901A;&#x8FC7;&#x53E5;&#x67C4;&#x548C;&#x8FDE;&#x63A5;&#x7B26;&#x540D;&#x79F0;&#x83B7;&#x53D6;&#x51FD;&#x6570;&#x540D;&#x6216;&#x8005;&#x53D8;&#x91CF;&#x540D;</li>\n</ol>\n<h5 id=\"&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;-1\"><a href=\"#&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;-1\" class=\"headerlink\" title=\"&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;\"></a>&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;</h5><figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> *<span class=\"hljs-title\">dlsym</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">void</span> *handle, <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">char</span> *symbol)</span></span>;</span><br></pre></td></tr></tbody></table></figure>\n\n<h5 id=\"&#x65B9;&#x6CD5;&#x4F7F;&#x7528;-1\"><a href=\"#&#x65B9;&#x6CD5;&#x4F7F;&#x7528;-1\" class=\"headerlink\" title=\"&#x65B9;&#x6CD5;&#x4F7F;&#x7528;\"></a>&#x65B9;&#x6CD5;&#x4F7F;&#x7528;</h5><figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ifn-&gt;CreateJavaVM = (CreateJavaVM_t)</span><br><span class=\"line\">        dlsym(libjvm, <span class=\"hljs-string\">&quot;JNI_CreateJavaVM&quot;</span>);</span><br></pre></td></tr></tbody></table></figure>\n\n\n<ol start=\"3\">\n<li>dlclose<br>&#x5378;&#x8F7D;&#x6253;&#x5F00;&#x7684;&#x5E93;</li>\n</ol>\n<h5 id=\"&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;-2\"><a href=\"#&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;-2\" class=\"headerlink\" title=\"&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;\"></a>&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;</h5><figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">dlclose</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">void</span> *handle)</span></span>;</span><br></pre></td></tr></tbody></table></figure>\n\n<h5 id=\"&#x65B9;&#x6CD5;&#x4F7F;&#x7528;-2\"><a href=\"#&#x65B9;&#x6CD5;&#x4F7F;&#x7528;-2\" class=\"headerlink\" title=\"&#x65B9;&#x6CD5;&#x4F7F;&#x7528;\"></a>&#x65B9;&#x6CD5;&#x4F7F;&#x7528;</h5><figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dlclose(handle);</span><br></pre></td></tr></tbody></table></figure></body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"C","path":"tags/C/"},{"name":"Linux","path":"tags/Linux/"}],"excerpt":"<html><head></head><body><p>&#x6211;&#x4EEC;&#x77E5;&#x9053;&#x76EE;&#x524D;Java&#x63D0;&#x4F9B;&#x7684;&#x5DE5;&#x5177;&#x5982;javac&#x3001;jps&#x3001;jstat&#x3001;jmap&#x7B49;&#x90FD;&#x662F;&#x901A;&#x8FC7;Java&#x7684;&#x81EA;&#x4E3E;&#x5B9E;&#x73B0;&#x7684;&#x3002;&#x7136;&#x800C;&#x542F;&#x52A8;JVM&#x7684;&#x547D;&#x4EE4;&#x7684;java&#x5374;&#x662F;&#x7531;C&#x8BED;&#x8A00;&#x5F00;&#x53D1;&#x7684;&#x3002;&#x81F3;&#x4E8E;&#x539F;&#x56E0;&#x901A;&#x8FC7;&#x7FFB;&#x9605;OpenJdk&#x6E90;&#x7801;&#x6211;&#x731C;&#x6D4B;&#xFF1A;&#x662F;&#x4E3A;&#x4E86;&#x4E0D;&#x63D0;&#x4F9B;JNI&#x63A5;&#x53E3;&#x7684;&#x524D;&#x63D0;&#x4E0B;&#xFF0C;&#x9700;&#x8981;&#x52A8;&#x6001;&#x94FE;&#x63A5;&#x8C03;&#x7528;JVM&#x5E93;&#x6240;&#x5BFC;&#x81F4;&#x7684;&#x3002;</p></body></html>","more":"<h3 id=\"java-c中动态链接jvm库相关代码\"><a href=\"#java-c中动态链接jvm库相关代码\" class=\"headerlink\" title=\"java.c中动态链接jvm库相关代码\"></a>java.c中动态链接jvm库相关代码</h3><blockquote>\n<p>代码清单：src/solaris/bin/java_md_solinux.c</p>\n</blockquote>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jboolean</span><br><span class=\"line\">LoadJavaVM(<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *jvmpath, InvocationFunctions *ifn)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"keyword\">void</span> *libjvm;</span><br><span class=\"line\"></span><br><span class=\"line\">    JLI_TraceLauncher(<span class=\"string\">&quot;JVM path is %s\\n&quot;</span>, jvmpath);</span><br><span class=\"line\"></span><br><span class=\"line\">    libjvm = dlopen(jvmpath, RTLD_NOW + RTLD_GLOBAL);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (libjvm == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">if</span> defined(__solaris__) &amp;&amp; defined(__sparc) &amp;&amp; !defined(_LP64) <span class=\"comment\">/* i.e. 32-bit sparc */</span></span></span><br><span class=\"line\">      FILE * fp;</span><br><span class=\"line\">      Elf32_Ehdr elf_head;</span><br><span class=\"line\">      <span class=\"keyword\">int</span> count;</span><br><span class=\"line\">      <span class=\"keyword\">int</span> location;</span><br><span class=\"line\"></span><br><span class=\"line\">      fp = fopen(jvmpath, <span class=\"string\">&quot;r&quot;</span>);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (fp == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">/* read in elf header */</span></span><br><span class=\"line\">      count = fread((<span class=\"keyword\">void</span>*)(&amp;elf_head), <span class=\"keyword\">sizeof</span>(Elf32_Ehdr), <span class=\"number\">1</span>, fp);</span><br><span class=\"line\">      fclose(fp);</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (count &lt; <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">       * Check for running a server vm (compiled with -xarch=v8plus)</span></span><br><span class=\"line\"><span class=\"comment\">       * on a stock v8 processor.  In this case, the machine type in</span></span><br><span class=\"line\"><span class=\"comment\">       * the elf header would not be included the architecture list</span></span><br><span class=\"line\"><span class=\"comment\">       * provided by the isalist command, which is turn is gotten from</span></span><br><span class=\"line\"><span class=\"comment\">       * sysinfo.  This case cannot occur on 64-bit hardware and thus</span></span><br><span class=\"line\"><span class=\"comment\">       * does not have to be checked for in binaries with an LP64 data</span></span><br><span class=\"line\"><span class=\"comment\">       * model.</span></span><br><span class=\"line\"><span class=\"comment\">       */</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (elf_head.e_machine == EM_SPARC32PLUS) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">char</span> buf[<span class=\"number\">257</span>];  <span class=\"comment\">/* recommended buffer size from sysinfo man</span></span><br><span class=\"line\"><span class=\"comment\">                           page */</span></span><br><span class=\"line\">        <span class=\"keyword\">long</span> length;</span><br><span class=\"line\">        <span class=\"keyword\">char</span>* location;</span><br><span class=\"line\"></span><br><span class=\"line\">        length = sysinfo(SI_ISALIST, buf, <span class=\"number\">257</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (length &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            location = JLI_StrStr(buf, <span class=\"string\">&quot;sparcv8plus &quot;</span>);</span><br><span class=\"line\">          <span class=\"keyword\">if</span> (location == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">            JLI_ReportErrorMessage(JVM_ERROR3);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">endif</span></span></span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR1, __LINE__);</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ifn-&gt;CreateJavaVM = (CreateJavaVM_t)</span><br><span class=\"line\">        dlsym(libjvm, <span class=\"string\">&quot;JNI_CreateJavaVM&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ifn-&gt;CreateJavaVM == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ifn-&gt;GetDefaultJavaVMInitArgs = (GetDefaultJavaVMInitArgs_t)</span><br><span class=\"line\">        dlsym(libjvm, <span class=\"string\">&quot;JNI_GetDefaultJavaVMInitArgs&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ifn-&gt;GetDefaultJavaVMInitArgs == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ifn-&gt;GetCreatedJavaVMs = (GetCreatedJavaVMs_t)</span><br><span class=\"line\">        dlsym(libjvm, <span class=\"string\">&quot;JNI_GetCreatedJavaVMs&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ifn-&gt;GetCreatedJavaVMs == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">        JLI_ReportErrorMessage(DLL_ERROR2, jvmpath, dlerror());</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JNI_FALSE;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> JNI_TRUE;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"总结下Linux下动态链接的使用\"><a href=\"#总结下Linux下动态链接的使用\" class=\"headerlink\" title=\"总结下Linux下动态链接的使用\"></a>总结下Linux下动态链接的使用</h3><ol>\n<li>dlopen<br>以指定模式打开指定的动态链接库文件，并返回一个句柄给调用进程</li>\n</ol>\n<h5 id=\"方法定义\"><a href=\"#方法定义\" class=\"headerlink\" title=\"方法定义\"></a>方法定义</h5><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> *<span class=\"title\">dlopen</span><span class=\"params\">(<span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *filename, <span class=\"keyword\">int</span> flag)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>filename 文件路径</li>\n<li>flag <ol>\n<li>RTLD_LAZY 暂缓决定，等有需要是再解出符号</li>\n<li>RTLD_NOW 立即决定，返回前解除所有未决定的符号</li>\n</ol>\n</li>\n</ul>\n<h5 id=\"方法使用\"><a href=\"#方法使用\" class=\"headerlink\" title=\"方法使用\"></a>方法使用</h5><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">void</span> *handle;</span><br><span class=\"line\">handle = dlopen(动态链接库路径, RTLD_LAZY);</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>dlsym<br>通过句柄和连接符名称获取函数名或者变量名</li>\n</ol>\n<h5 id=\"方法定义-1\"><a href=\"#方法定义-1\" class=\"headerlink\" title=\"方法定义\"></a>方法定义</h5><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> *<span class=\"title\">dlsym</span><span class=\"params\">(<span class=\"keyword\">void</span> *handle, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *symbol)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"方法使用-1\"><a href=\"#方法使用-1\" class=\"headerlink\" title=\"方法使用\"></a>方法使用</h5><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ifn-&gt;CreateJavaVM = (CreateJavaVM_t)</span><br><span class=\"line\">        dlsym(libjvm, <span class=\"string\">&quot;JNI_CreateJavaVM&quot;</span>);</span><br></pre></td></tr></table></figure>\n\n\n<ol start=\"3\">\n<li>dlclose<br>卸载打开的库</li>\n</ol>\n<h5 id=\"方法定义-2\"><a href=\"#方法定义-2\" class=\"headerlink\" title=\"方法定义\"></a>方法定义</h5><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">dlclose</span><span class=\"params\">(<span class=\"keyword\">void</span> *handle)</span></span>;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"方法使用-2\"><a href=\"#方法使用-2\" class=\"headerlink\" title=\"方法使用\"></a>方法使用</h5><figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dlclose(handle);</span><br></pre></td></tr></table></figure>"},{"title":"多级缓存","date":"2019-09-04T07:35:11.000Z","_content":"### 起因\n项目平稳的已经运行快一年了，某天早上监控突然告警大量核心服务不可能，虽然运维紧急处理并重启了服务。但这种非正常的服务宕机着实让人捏了把冷汗（还好创业公司还没有生产事故惩罚机制）。\n\n随后我们Dump下了服务起的日志，发现事故期间JVM存在大量的Full GC，配合CAT的监控指标发现某几个接口的调用量剧增。。。。大概我们是被刷接口了。\n\n查看具体接口，发现前端反复查询配置信息而且没有做缓存，大量的大对象堆积不频繁Full GC才怪。。。。知道问题那我们就开始优化吧\n\n<!-- more -->\n\n### 缓存\n\n### Spring Cache\n\n\n注解|功能\n---|---\nCacheable|\nCacheEvict|\nCachePut|\nCaching|\n\n#### spring boot cache 流程\n\n![01](一个事故引起的缓存/springCache.png)\n\n\n#### 多级缓存流程\n\n![02](一个事故引起的缓存/多级缓存.png)\n\n\n\n#### springboot 开启缓存很方便\n1. 依赖org.springframework.boot:spring-boot-starter-cache\n2. 在启动类增加注解@EnableCaching\n3. 在想要增加缓存的方法或者成员变量上增加以下注解\n\n#### 启用多级缓存\n1. 引入组件\n\n```gradle \n\n``` \n\n2. 开启缓存\n   \n###### 无参缓存\n```java\n\n``` \n\n###### 带参缓存1\n```java\n\n``` \n\n###### 带参缓存2\n```java\n\n``` \n\n###### 组合参数缓存\n```java\n\n``` ","source":"_posts/一个事故引起的缓存.md","raw":"---\ntitle: 多级缓存\ndate: 2019-09-04 15:35:11\ntags: \n    - Java\n    - Redis\n    - Cache\ncategories :\n    - Technology\n---\n### 起因\n项目平稳的已经运行快一年了，某天早上监控突然告警大量核心服务不可能，虽然运维紧急处理并重启了服务。但这种非正常的服务宕机着实让人捏了把冷汗（还好创业公司还没有生产事故惩罚机制）。\n\n随后我们Dump下了服务起的日志，发现事故期间JVM存在大量的Full GC，配合CAT的监控指标发现某几个接口的调用量剧增。。。。大概我们是被刷接口了。\n\n查看具体接口，发现前端反复查询配置信息而且没有做缓存，大量的大对象堆积不频繁Full GC才怪。。。。知道问题那我们就开始优化吧\n\n<!-- more -->\n\n### 缓存\n\n### Spring Cache\n\n\n注解|功能\n---|---\nCacheable|\nCacheEvict|\nCachePut|\nCaching|\n\n#### spring boot cache 流程\n\n![01](一个事故引起的缓存/springCache.png)\n\n\n#### 多级缓存流程\n\n![02](一个事故引起的缓存/多级缓存.png)\n\n\n\n#### springboot 开启缓存很方便\n1. 依赖org.springframework.boot:spring-boot-starter-cache\n2. 在启动类增加注解@EnableCaching\n3. 在想要增加缓存的方法或者成员变量上增加以下注解\n\n#### 启用多级缓存\n1. 引入组件\n\n```gradle \n\n``` \n\n2. 开启缓存\n   \n###### 无参缓存\n```java\n\n``` \n\n###### 带参缓存1\n```java\n\n``` \n\n###### 带参缓存2\n```java\n\n``` \n\n###### 组合参数缓存\n```java\n\n``` ","slug":"一个事故引起的缓存","published":1,"updated":"2020-12-14T10:35:23.746Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71hta000hv252gby12mkn","content":"<html><head></head><body><h3 id=\"&#x8D77;&#x56E0;\"><a href=\"#&#x8D77;&#x56E0;\" class=\"headerlink\" title=\"&#x8D77;&#x56E0;\"></a>&#x8D77;&#x56E0;</h3><p>&#x9879;&#x76EE;&#x5E73;&#x7A33;&#x7684;&#x5DF2;&#x7ECF;&#x8FD0;&#x884C;&#x5FEB;&#x4E00;&#x5E74;&#x4E86;&#xFF0C;&#x67D0;&#x5929;&#x65E9;&#x4E0A;&#x76D1;&#x63A7;&#x7A81;&#x7136;&#x544A;&#x8B66;&#x5927;&#x91CF;&#x6838;&#x5FC3;&#x670D;&#x52A1;&#x4E0D;&#x53EF;&#x80FD;&#xFF0C;&#x867D;&#x7136;&#x8FD0;&#x7EF4;&#x7D27;&#x6025;&#x5904;&#x7406;&#x5E76;&#x91CD;&#x542F;&#x4E86;&#x670D;&#x52A1;&#x3002;&#x4F46;&#x8FD9;&#x79CD;&#x975E;&#x6B63;&#x5E38;&#x7684;&#x670D;&#x52A1;&#x5B95;&#x673A;&#x7740;&#x5B9E;&#x8BA9;&#x4EBA;&#x634F;&#x4E86;&#x628A;&#x51B7;&#x6C57;&#xFF08;&#x8FD8;&#x597D;&#x521B;&#x4E1A;&#x516C;&#x53F8;&#x8FD8;&#x6CA1;&#x6709;&#x751F;&#x4EA7;&#x4E8B;&#x6545;&#x60E9;&#x7F5A;&#x673A;&#x5236;&#xFF09;&#x3002;</p>\n<p>&#x968F;&#x540E;&#x6211;&#x4EEC;Dump&#x4E0B;&#x4E86;&#x670D;&#x52A1;&#x8D77;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x53D1;&#x73B0;&#x4E8B;&#x6545;&#x671F;&#x95F4;JVM&#x5B58;&#x5728;&#x5927;&#x91CF;&#x7684;Full GC&#xFF0C;&#x914D;&#x5408;CAT&#x7684;&#x76D1;&#x63A7;&#x6307;&#x6807;&#x53D1;&#x73B0;&#x67D0;&#x51E0;&#x4E2A;&#x63A5;&#x53E3;&#x7684;&#x8C03;&#x7528;&#x91CF;&#x5267;&#x589E;&#x3002;&#x3002;&#x3002;&#x3002;&#x5927;&#x6982;&#x6211;&#x4EEC;&#x662F;&#x88AB;&#x5237;&#x63A5;&#x53E3;&#x4E86;&#x3002;</p>\n<p>&#x67E5;&#x770B;&#x5177;&#x4F53;&#x63A5;&#x53E3;&#xFF0C;&#x53D1;&#x73B0;&#x524D;&#x7AEF;&#x53CD;&#x590D;&#x67E5;&#x8BE2;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x800C;&#x4E14;&#x6CA1;&#x6709;&#x505A;&#x7F13;&#x5B58;&#xFF0C;&#x5927;&#x91CF;&#x7684;&#x5927;&#x5BF9;&#x8C61;&#x5806;&#x79EF;&#x4E0D;&#x9891;&#x7E41;Full GC&#x624D;&#x602A;&#x3002;&#x3002;&#x3002;&#x3002;&#x77E5;&#x9053;&#x95EE;&#x9898;&#x90A3;&#x6211;&#x4EEC;&#x5C31;&#x5F00;&#x59CB;&#x4F18;&#x5316;&#x5427;</p>\n<a id=\"more\"></a>\n\n<h3 id=\"&#x7F13;&#x5B58;\"><a href=\"#&#x7F13;&#x5B58;\" class=\"headerlink\" title=\"&#x7F13;&#x5B58;\"></a>&#x7F13;&#x5B58;</h3><h3 id=\"Spring-Cache\"><a href=\"#Spring-Cache\" class=\"headerlink\" title=\"Spring Cache\"></a>Spring Cache</h3><table>\n<thead>\n<tr>\n<th>&#x6CE8;&#x89E3;</th>\n<th>&#x529F;&#x80FD;</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Cacheable</td>\n<td></td>\n</tr>\n<tr>\n<td>CacheEvict</td>\n<td></td>\n</tr>\n<tr>\n<td>CachePut</td>\n<td></td>\n</tr>\n<tr>\n<td>Caching</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"spring-boot-cache-&#x6D41;&#x7A0B;\"><a href=\"#spring-boot-cache-&#x6D41;&#x7A0B;\" class=\"headerlink\" title=\"spring boot cache &#x6D41;&#x7A0B;\"></a>spring boot cache &#x6D41;&#x7A0B;</h4><p><img src=\"/2019/09/04/%E4%B8%80%E4%B8%AA%E4%BA%8B%E6%95%85%E5%BC%95%E8%B5%B7%E7%9A%84%E7%BC%93%E5%AD%98/springCache.png\" alt=\"01\"></p>\n<h4 id=\"&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x6D41;&#x7A0B;\"><a href=\"#&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x6D41;&#x7A0B;\" class=\"headerlink\" title=\"&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x6D41;&#x7A0B;\"></a>&#x591A;&#x7EA7;&#x7F13;&#x5B58;&#x6D41;&#x7A0B;</h4><p><img src=\"/2019/09/04/%E4%B8%80%E4%B8%AA%E4%BA%8B%E6%95%85%E5%BC%95%E8%B5%B7%E7%9A%84%E7%BC%93%E5%AD%98/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98.png\" alt=\"02\"></p>\n<h4 id=\"springboot-&#x5F00;&#x542F;&#x7F13;&#x5B58;&#x5F88;&#x65B9;&#x4FBF;\"><a href=\"#springboot-&#x5F00;&#x542F;&#x7F13;&#x5B58;&#x5F88;&#x65B9;&#x4FBF;\" class=\"headerlink\" title=\"springboot &#x5F00;&#x542F;&#x7F13;&#x5B58;&#x5F88;&#x65B9;&#x4FBF;\"></a>springboot &#x5F00;&#x542F;&#x7F13;&#x5B58;&#x5F88;&#x65B9;&#x4FBF;</h4><ol>\n<li>&#x4F9D;&#x8D56;org.springframework.boot:spring-boot-starter-cache</li>\n<li>&#x5728;&#x542F;&#x52A8;&#x7C7B;&#x589E;&#x52A0;&#x6CE8;&#x89E3;@EnableCaching</li>\n<li>&#x5728;&#x60F3;&#x8981;&#x589E;&#x52A0;&#x7F13;&#x5B58;&#x7684;&#x65B9;&#x6CD5;&#x6216;&#x8005;&#x6210;&#x5458;&#x53D8;&#x91CF;&#x4E0A;&#x589E;&#x52A0;&#x4EE5;&#x4E0B;&#x6CE8;&#x89E3;</li>\n</ol>\n<h4 id=\"&#x542F;&#x7528;&#x591A;&#x7EA7;&#x7F13;&#x5B58;\"><a href=\"#&#x542F;&#x7528;&#x591A;&#x7EA7;&#x7F13;&#x5B58;\" class=\"headerlink\" title=\"&#x542F;&#x7528;&#x591A;&#x7EA7;&#x7F13;&#x5B58;\"></a>&#x542F;&#x7528;&#x591A;&#x7EA7;&#x7F13;&#x5B58;</h4><ol>\n<li>&#x5F15;&#x5165;&#x7EC4;&#x4EF6;</li>\n</ol>\n<pre><code class=\"gradle\"></code></pre>\n<ol start=\"2\">\n<li>&#x5F00;&#x542F;&#x7F13;&#x5B58;</li>\n</ol>\n<h6 id=\"&#x65E0;&#x53C2;&#x7F13;&#x5B58;\"><a href=\"#&#x65E0;&#x53C2;&#x7F13;&#x5B58;\" class=\"headerlink\" title=\"&#x65E0;&#x53C2;&#x7F13;&#x5B58;\"></a>&#x65E0;&#x53C2;&#x7F13;&#x5B58;</h6><pre><code class=\"java\"></code></pre>\n<h6 id=\"&#x5E26;&#x53C2;&#x7F13;&#x5B58;1\"><a href=\"#&#x5E26;&#x53C2;&#x7F13;&#x5B58;1\" class=\"headerlink\" title=\"&#x5E26;&#x53C2;&#x7F13;&#x5B58;1\"></a>&#x5E26;&#x53C2;&#x7F13;&#x5B58;1</h6><pre><code class=\"java\"></code></pre>\n<h6 id=\"&#x5E26;&#x53C2;&#x7F13;&#x5B58;2\"><a href=\"#&#x5E26;&#x53C2;&#x7F13;&#x5B58;2\" class=\"headerlink\" title=\"&#x5E26;&#x53C2;&#x7F13;&#x5B58;2\"></a>&#x5E26;&#x53C2;&#x7F13;&#x5B58;2</h6><pre><code class=\"java\"></code></pre>\n<h6 id=\"&#x7EC4;&#x5408;&#x53C2;&#x6570;&#x7F13;&#x5B58;\"><a href=\"#&#x7EC4;&#x5408;&#x53C2;&#x6570;&#x7F13;&#x5B58;\" class=\"headerlink\" title=\"&#x7EC4;&#x5408;&#x53C2;&#x6570;&#x7F13;&#x5B58;\"></a>&#x7EC4;&#x5408;&#x53C2;&#x6570;&#x7F13;&#x5B58;</h6><pre><code class=\"java\"></code></pre>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Redis","path":"tags/Redis/"},{"name":"Cache","path":"tags/Cache/"}],"excerpt":"<html><head></head><body><h3 id=\"&#x8D77;&#x56E0;\"><a href=\"#&#x8D77;&#x56E0;\" class=\"headerlink\" title=\"&#x8D77;&#x56E0;\"></a>&#x8D77;&#x56E0;</h3><p>&#x9879;&#x76EE;&#x5E73;&#x7A33;&#x7684;&#x5DF2;&#x7ECF;&#x8FD0;&#x884C;&#x5FEB;&#x4E00;&#x5E74;&#x4E86;&#xFF0C;&#x67D0;&#x5929;&#x65E9;&#x4E0A;&#x76D1;&#x63A7;&#x7A81;&#x7136;&#x544A;&#x8B66;&#x5927;&#x91CF;&#x6838;&#x5FC3;&#x670D;&#x52A1;&#x4E0D;&#x53EF;&#x80FD;&#xFF0C;&#x867D;&#x7136;&#x8FD0;&#x7EF4;&#x7D27;&#x6025;&#x5904;&#x7406;&#x5E76;&#x91CD;&#x542F;&#x4E86;&#x670D;&#x52A1;&#x3002;&#x4F46;&#x8FD9;&#x79CD;&#x975E;&#x6B63;&#x5E38;&#x7684;&#x670D;&#x52A1;&#x5B95;&#x673A;&#x7740;&#x5B9E;&#x8BA9;&#x4EBA;&#x634F;&#x4E86;&#x628A;&#x51B7;&#x6C57;&#xFF08;&#x8FD8;&#x597D;&#x521B;&#x4E1A;&#x516C;&#x53F8;&#x8FD8;&#x6CA1;&#x6709;&#x751F;&#x4EA7;&#x4E8B;&#x6545;&#x60E9;&#x7F5A;&#x673A;&#x5236;&#xFF09;&#x3002;</p>\n<p>&#x968F;&#x540E;&#x6211;&#x4EEC;Dump&#x4E0B;&#x4E86;&#x670D;&#x52A1;&#x8D77;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x53D1;&#x73B0;&#x4E8B;&#x6545;&#x671F;&#x95F4;JVM&#x5B58;&#x5728;&#x5927;&#x91CF;&#x7684;Full GC&#xFF0C;&#x914D;&#x5408;CAT&#x7684;&#x76D1;&#x63A7;&#x6307;&#x6807;&#x53D1;&#x73B0;&#x67D0;&#x51E0;&#x4E2A;&#x63A5;&#x53E3;&#x7684;&#x8C03;&#x7528;&#x91CF;&#x5267;&#x589E;&#x3002;&#x3002;&#x3002;&#x3002;&#x5927;&#x6982;&#x6211;&#x4EEC;&#x662F;&#x88AB;&#x5237;&#x63A5;&#x53E3;&#x4E86;&#x3002;</p>\n<p>&#x67E5;&#x770B;&#x5177;&#x4F53;&#x63A5;&#x53E3;&#xFF0C;&#x53D1;&#x73B0;&#x524D;&#x7AEF;&#x53CD;&#x590D;&#x67E5;&#x8BE2;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x800C;&#x4E14;&#x6CA1;&#x6709;&#x505A;&#x7F13;&#x5B58;&#xFF0C;&#x5927;&#x91CF;&#x7684;&#x5927;&#x5BF9;&#x8C61;&#x5806;&#x79EF;&#x4E0D;&#x9891;&#x7E41;Full GC&#x624D;&#x602A;&#x3002;&#x3002;&#x3002;&#x3002;&#x77E5;&#x9053;&#x95EE;&#x9898;&#x90A3;&#x6211;&#x4EEC;&#x5C31;&#x5F00;&#x59CB;&#x4F18;&#x5316;&#x5427;</p></body></html>","more":"<h3 id=\"缓存\"><a href=\"#缓存\" class=\"headerlink\" title=\"缓存\"></a>缓存</h3><h3 id=\"Spring-Cache\"><a href=\"#Spring-Cache\" class=\"headerlink\" title=\"Spring Cache\"></a>Spring Cache</h3><table>\n<thead>\n<tr>\n<th>注解</th>\n<th>功能</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Cacheable</td>\n<td></td>\n</tr>\n<tr>\n<td>CacheEvict</td>\n<td></td>\n</tr>\n<tr>\n<td>CachePut</td>\n<td></td>\n</tr>\n<tr>\n<td>Caching</td>\n<td></td>\n</tr>\n</tbody></table>\n<h4 id=\"spring-boot-cache-流程\"><a href=\"#spring-boot-cache-流程\" class=\"headerlink\" title=\"spring boot cache 流程\"></a>spring boot cache 流程</h4><p><img src=\"/2019/09/04/%E4%B8%80%E4%B8%AA%E4%BA%8B%E6%95%85%E5%BC%95%E8%B5%B7%E7%9A%84%E7%BC%93%E5%AD%98/springCache.png\" alt=\"01\"></p>\n<h4 id=\"多级缓存流程\"><a href=\"#多级缓存流程\" class=\"headerlink\" title=\"多级缓存流程\"></a>多级缓存流程</h4><p><img src=\"/2019/09/04/%E4%B8%80%E4%B8%AA%E4%BA%8B%E6%95%85%E5%BC%95%E8%B5%B7%E7%9A%84%E7%BC%93%E5%AD%98/%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98.png\" alt=\"02\"></p>\n<h4 id=\"springboot-开启缓存很方便\"><a href=\"#springboot-开启缓存很方便\" class=\"headerlink\" title=\"springboot 开启缓存很方便\"></a>springboot 开启缓存很方便</h4><ol>\n<li>依赖org.springframework.boot:spring-boot-starter-cache</li>\n<li>在启动类增加注解@EnableCaching</li>\n<li>在想要增加缓存的方法或者成员变量上增加以下注解</li>\n</ol>\n<h4 id=\"启用多级缓存\"><a href=\"#启用多级缓存\" class=\"headerlink\" title=\"启用多级缓存\"></a>启用多级缓存</h4><ol>\n<li>引入组件</li>\n</ol>\n<pre><code class=\"gradle\"></code></pre>\n<ol start=\"2\">\n<li>开启缓存</li>\n</ol>\n<h6 id=\"无参缓存\"><a href=\"#无参缓存\" class=\"headerlink\" title=\"无参缓存\"></a>无参缓存</h6><pre><code class=\"java\"></code></pre>\n<h6 id=\"带参缓存1\"><a href=\"#带参缓存1\" class=\"headerlink\" title=\"带参缓存1\"></a>带参缓存1</h6><pre><code class=\"java\"></code></pre>\n<h6 id=\"带参缓存2\"><a href=\"#带参缓存2\" class=\"headerlink\" title=\"带参缓存2\"></a>带参缓存2</h6><pre><code class=\"java\"></code></pre>\n<h6 id=\"组合参数缓存\"><a href=\"#组合参数缓存\" class=\"headerlink\" title=\"组合参数缓存\"></a>组合参数缓存</h6><pre><code class=\"java\"></code></pre>"},{"title":"分布式一致性算法整理","date":"2020-03-01T12:56:56.000Z","_content":"\n# 分布式算法相关知识总结（施工中）\n总结当前使用较多的一种分布式一致性算法的原理及其运用。\n\n## Raft\n<!-- more -->\n### 角色\n\n最多只有一个Leader，正常工作时期只有Leader和Follower\n\n- 成员\n\n\t- Leader\n\n\t  接受客户端请求，并向Follower同步请求日志，当日志同步到大多数节点上后告诉Follower提交日志。\n\n\t- Follower\n\n\t  接受并持久化Leader同步的日志，在Leader告之日志可以提交之后，提交日志。\n\n\t- Candidate\n\n\t  Leader选举过程中的临时角色。\n\n- 角色变化\n\n\t- Leader\n\n\t  Leader在当前任期term中失去服务链接，将会变为Candidate。\n\n\t- Follower\n\n\t  1.节点初始状态为Follower。\n\t  2.Follower超时没有收到Leader的消息，会转变为Candidate，并开始选举。\n\n\t- Candidate\n\n\t  1.选举成功成为Leader。\n\t  2.选举失败成为Follower。\n\t  3.超时重新选举，还是Candidate。\n\n### Leader选举\n\n1.Follower超时没有收到Leader的心跳时会发起选举，选举时会将自己的term+1，并转化为Candidate且投票给自己，并向集群内发送RequestVote RPC。\n\n- 赢得最多选票成为Leader\n- 收到其他Leader信息，被抢先选举\n- 没有服务获得最多选票，等待重新发起选举\n\n### 日志同步\n\n1.Leader接受客户端信息。\n2.Leader向Follower发起日志复制，AppendEntries RPC。\n3.Follower未成功接受时，Leader会持续向Follower发起AppendEntries RPC。\n4.大部分Follower返回成功时，Leader向客户端返回成功结果，并允许改条日志commit。\n\n- 日志\n\n  日志包含索引，当前term号，和状态机的执行命令。\n\n- 同步\n\n  1.相同索引和term号的命令是相同的。\n  2.相同索引和term号之前的日志都是相同的。\n  \n  Leader为了使Followers的日志同自己的一致，Leader需要找到Followers同它的日志一致的地方，然后覆盖Followers在该位置之后的条目\n\n### 安全性\n\n1.拥有最新的已提交的log entry的Follower才有资格成为Leader。\n2.Leader只能推进commit index来提交当前term的已经复制到大多数服务器上的日志，旧term日志的提交要等到提交当前term的日志来间接提交（log index 小于 commit index的日志被间接提交）。\n\n### 日志压缩\n\nRaft采用对整个系统进行snapshot来解决，snapshot之前的日志都可以丢弃。\n每个副本独立的对自己的系统状态进行snapshot，并且只能对已经提交的日志记录进行snapshot。\n\n- Snapshot\n\n  1.日志元数据。最后一条已提交的 log entry的 log index和term。这两个值在snapshot之后的第一条log entry的AppendEntries RPC的完整性检查的时候会被用上。\n  2.系统当前状态。\n  \n  Leader会以Snapshot的形式发给日志落后太多或新上线的Follower，使用InstalledSnapshot RPC。\n\n## Paxos\n\n*XMind: ZEN - Trial Version*","source":"_posts/分布式一致性算法整理.md","raw":"---\ntitle: 分布式一致性算法整理\ndate: 2020-03-01 20:56:56\ntags: \n    - Java\ncategories :\n    - Technology\n---\n\n# 分布式算法相关知识总结（施工中）\n总结当前使用较多的一种分布式一致性算法的原理及其运用。\n\n## Raft\n<!-- more -->\n### 角色\n\n最多只有一个Leader，正常工作时期只有Leader和Follower\n\n- 成员\n\n\t- Leader\n\n\t  接受客户端请求，并向Follower同步请求日志，当日志同步到大多数节点上后告诉Follower提交日志。\n\n\t- Follower\n\n\t  接受并持久化Leader同步的日志，在Leader告之日志可以提交之后，提交日志。\n\n\t- Candidate\n\n\t  Leader选举过程中的临时角色。\n\n- 角色变化\n\n\t- Leader\n\n\t  Leader在当前任期term中失去服务链接，将会变为Candidate。\n\n\t- Follower\n\n\t  1.节点初始状态为Follower。\n\t  2.Follower超时没有收到Leader的消息，会转变为Candidate，并开始选举。\n\n\t- Candidate\n\n\t  1.选举成功成为Leader。\n\t  2.选举失败成为Follower。\n\t  3.超时重新选举，还是Candidate。\n\n### Leader选举\n\n1.Follower超时没有收到Leader的心跳时会发起选举，选举时会将自己的term+1，并转化为Candidate且投票给自己，并向集群内发送RequestVote RPC。\n\n- 赢得最多选票成为Leader\n- 收到其他Leader信息，被抢先选举\n- 没有服务获得最多选票，等待重新发起选举\n\n### 日志同步\n\n1.Leader接受客户端信息。\n2.Leader向Follower发起日志复制，AppendEntries RPC。\n3.Follower未成功接受时，Leader会持续向Follower发起AppendEntries RPC。\n4.大部分Follower返回成功时，Leader向客户端返回成功结果，并允许改条日志commit。\n\n- 日志\n\n  日志包含索引，当前term号，和状态机的执行命令。\n\n- 同步\n\n  1.相同索引和term号的命令是相同的。\n  2.相同索引和term号之前的日志都是相同的。\n  \n  Leader为了使Followers的日志同自己的一致，Leader需要找到Followers同它的日志一致的地方，然后覆盖Followers在该位置之后的条目\n\n### 安全性\n\n1.拥有最新的已提交的log entry的Follower才有资格成为Leader。\n2.Leader只能推进commit index来提交当前term的已经复制到大多数服务器上的日志，旧term日志的提交要等到提交当前term的日志来间接提交（log index 小于 commit index的日志被间接提交）。\n\n### 日志压缩\n\nRaft采用对整个系统进行snapshot来解决，snapshot之前的日志都可以丢弃。\n每个副本独立的对自己的系统状态进行snapshot，并且只能对已经提交的日志记录进行snapshot。\n\n- Snapshot\n\n  1.日志元数据。最后一条已提交的 log entry的 log index和term。这两个值在snapshot之后的第一条log entry的AppendEntries RPC的完整性检查的时候会被用上。\n  2.系统当前状态。\n  \n  Leader会以Snapshot的形式发给日志落后太多或新上线的Follower，使用InstalledSnapshot RPC。\n\n## Paxos\n\n*XMind: ZEN - Trial Version*","slug":"分布式一致性算法整理","published":1,"updated":"2020-12-14T09:51:24.018Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htc000kv25248magx16","content":"<html><head></head><body><h1 id=\"&#x5206;&#x5E03;&#x5F0F;&#x7B97;&#x6CD5;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x603B;&#x7ED3;&#xFF08;&#x65BD;&#x5DE5;&#x4E2D;&#xFF09;\"><a href=\"#&#x5206;&#x5E03;&#x5F0F;&#x7B97;&#x6CD5;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x603B;&#x7ED3;&#xFF08;&#x65BD;&#x5DE5;&#x4E2D;&#xFF09;\" class=\"headerlink\" title=\"&#x5206;&#x5E03;&#x5F0F;&#x7B97;&#x6CD5;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x603B;&#x7ED3;&#xFF08;&#x65BD;&#x5DE5;&#x4E2D;&#xFF09;\"></a>&#x5206;&#x5E03;&#x5F0F;&#x7B97;&#x6CD5;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x603B;&#x7ED3;&#xFF08;&#x65BD;&#x5DE5;&#x4E2D;&#xFF09;</h1><p>&#x603B;&#x7ED3;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x8F83;&#x591A;&#x7684;&#x4E00;&#x79CD;&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;&#x7B97;&#x6CD5;&#x7684;&#x539F;&#x7406;&#x53CA;&#x5176;&#x8FD0;&#x7528;&#x3002;</p>\n<h2 id=\"Raft\"><a href=\"#Raft\" class=\"headerlink\" title=\"Raft\"></a>Raft</h2><a id=\"more\"></a>\n<h3 id=\"&#x89D2;&#x8272;\"><a href=\"#&#x89D2;&#x8272;\" class=\"headerlink\" title=\"&#x89D2;&#x8272;\"></a>&#x89D2;&#x8272;</h3><p>&#x6700;&#x591A;&#x53EA;&#x6709;&#x4E00;&#x4E2A;Leader&#xFF0C;&#x6B63;&#x5E38;&#x5DE5;&#x4F5C;&#x65F6;&#x671F;&#x53EA;&#x6709;Leader&#x548C;Follower</p>\n<ul>\n<li><p>&#x6210;&#x5458;</p>\n<ul>\n<li><p>Leader</p>\n<p>&#x63A5;&#x53D7;&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42;&#xFF0C;&#x5E76;&#x5411;Follower&#x540C;&#x6B65;&#x8BF7;&#x6C42;&#x65E5;&#x5FD7;&#xFF0C;&#x5F53;&#x65E5;&#x5FD7;&#x540C;&#x6B65;&#x5230;&#x5927;&#x591A;&#x6570;&#x8282;&#x70B9;&#x4E0A;&#x540E;&#x544A;&#x8BC9;Follower&#x63D0;&#x4EA4;&#x65E5;&#x5FD7;&#x3002;</p>\n</li>\n<li><p>Follower</p>\n<p>&#x63A5;&#x53D7;&#x5E76;&#x6301;&#x4E45;&#x5316;Leader&#x540C;&#x6B65;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x5728;Leader&#x544A;&#x4E4B;&#x65E5;&#x5FD7;&#x53EF;&#x4EE5;&#x63D0;&#x4EA4;&#x4E4B;&#x540E;&#xFF0C;&#x63D0;&#x4EA4;&#x65E5;&#x5FD7;&#x3002;</p>\n</li>\n<li><p>Candidate</p>\n<p>Leader&#x9009;&#x4E3E;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x4E34;&#x65F6;&#x89D2;&#x8272;&#x3002;</p>\n</li>\n</ul>\n</li>\n<li><p>&#x89D2;&#x8272;&#x53D8;&#x5316;</p>\n<ul>\n<li><p>Leader</p>\n<p>Leader&#x5728;&#x5F53;&#x524D;&#x4EFB;&#x671F;term&#x4E2D;&#x5931;&#x53BB;&#x670D;&#x52A1;&#x94FE;&#x63A5;&#xFF0C;&#x5C06;&#x4F1A;&#x53D8;&#x4E3A;Candidate&#x3002;</p>\n</li>\n<li><p>Follower</p>\n<p>1.&#x8282;&#x70B9;&#x521D;&#x59CB;&#x72B6;&#x6001;&#x4E3A;Follower&#x3002;<br>2.Follower&#x8D85;&#x65F6;&#x6CA1;&#x6709;&#x6536;&#x5230;Leader&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x4F1A;&#x8F6C;&#x53D8;&#x4E3A;Candidate&#xFF0C;&#x5E76;&#x5F00;&#x59CB;&#x9009;&#x4E3E;&#x3002;</p>\n</li>\n<li><p>Candidate</p>\n<p>1.&#x9009;&#x4E3E;&#x6210;&#x529F;&#x6210;&#x4E3A;Leader&#x3002;<br>2.&#x9009;&#x4E3E;&#x5931;&#x8D25;&#x6210;&#x4E3A;Follower&#x3002;<br>3.&#x8D85;&#x65F6;&#x91CD;&#x65B0;&#x9009;&#x4E3E;&#xFF0C;&#x8FD8;&#x662F;Candidate&#x3002;</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Leader&#x9009;&#x4E3E;\"><a href=\"#Leader&#x9009;&#x4E3E;\" class=\"headerlink\" title=\"Leader&#x9009;&#x4E3E;\"></a>Leader&#x9009;&#x4E3E;</h3><p>1.Follower&#x8D85;&#x65F6;&#x6CA1;&#x6709;&#x6536;&#x5230;Leader&#x7684;&#x5FC3;&#x8DF3;&#x65F6;&#x4F1A;&#x53D1;&#x8D77;&#x9009;&#x4E3E;&#xFF0C;&#x9009;&#x4E3E;&#x65F6;&#x4F1A;&#x5C06;&#x81EA;&#x5DF1;&#x7684;term+1&#xFF0C;&#x5E76;&#x8F6C;&#x5316;&#x4E3A;Candidate&#x4E14;&#x6295;&#x7968;&#x7ED9;&#x81EA;&#x5DF1;&#xFF0C;&#x5E76;&#x5411;&#x96C6;&#x7FA4;&#x5185;&#x53D1;&#x9001;RequestVote RPC&#x3002;</p>\n<ul>\n<li>&#x8D62;&#x5F97;&#x6700;&#x591A;&#x9009;&#x7968;&#x6210;&#x4E3A;Leader</li>\n<li>&#x6536;&#x5230;&#x5176;&#x4ED6;Leader&#x4FE1;&#x606F;&#xFF0C;&#x88AB;&#x62A2;&#x5148;&#x9009;&#x4E3E;</li>\n<li>&#x6CA1;&#x6709;&#x670D;&#x52A1;&#x83B7;&#x5F97;&#x6700;&#x591A;&#x9009;&#x7968;&#xFF0C;&#x7B49;&#x5F85;&#x91CD;&#x65B0;&#x53D1;&#x8D77;&#x9009;&#x4E3E;</li>\n</ul>\n<h3 id=\"&#x65E5;&#x5FD7;&#x540C;&#x6B65;\"><a href=\"#&#x65E5;&#x5FD7;&#x540C;&#x6B65;\" class=\"headerlink\" title=\"&#x65E5;&#x5FD7;&#x540C;&#x6B65;\"></a>&#x65E5;&#x5FD7;&#x540C;&#x6B65;</h3><p>1.Leader&#x63A5;&#x53D7;&#x5BA2;&#x6237;&#x7AEF;&#x4FE1;&#x606F;&#x3002;<br>2.Leader&#x5411;Follower&#x53D1;&#x8D77;&#x65E5;&#x5FD7;&#x590D;&#x5236;&#xFF0C;AppendEntries RPC&#x3002;<br>3.Follower&#x672A;&#x6210;&#x529F;&#x63A5;&#x53D7;&#x65F6;&#xFF0C;Leader&#x4F1A;&#x6301;&#x7EED;&#x5411;Follower&#x53D1;&#x8D77;AppendEntries RPC&#x3002;<br>4.&#x5927;&#x90E8;&#x5206;Follower&#x8FD4;&#x56DE;&#x6210;&#x529F;&#x65F6;&#xFF0C;Leader&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x8FD4;&#x56DE;&#x6210;&#x529F;&#x7ED3;&#x679C;&#xFF0C;&#x5E76;&#x5141;&#x8BB8;&#x6539;&#x6761;&#x65E5;&#x5FD7;commit&#x3002;</p>\n<ul>\n<li><p>&#x65E5;&#x5FD7;</p>\n<p>&#x65E5;&#x5FD7;&#x5305;&#x542B;&#x7D22;&#x5F15;&#xFF0C;&#x5F53;&#x524D;term&#x53F7;&#xFF0C;&#x548C;&#x72B6;&#x6001;&#x673A;&#x7684;&#x6267;&#x884C;&#x547D;&#x4EE4;&#x3002;</p>\n</li>\n<li><p>&#x540C;&#x6B65;</p>\n<p>1.&#x76F8;&#x540C;&#x7D22;&#x5F15;&#x548C;term&#x53F7;&#x7684;&#x547D;&#x4EE4;&#x662F;&#x76F8;&#x540C;&#x7684;&#x3002;<br>2.&#x76F8;&#x540C;&#x7D22;&#x5F15;&#x548C;term&#x53F7;&#x4E4B;&#x524D;&#x7684;&#x65E5;&#x5FD7;&#x90FD;&#x662F;&#x76F8;&#x540C;&#x7684;&#x3002;</p>\n<p>Leader&#x4E3A;&#x4E86;&#x4F7F;Followers&#x7684;&#x65E5;&#x5FD7;&#x540C;&#x81EA;&#x5DF1;&#x7684;&#x4E00;&#x81F4;&#xFF0C;Leader&#x9700;&#x8981;&#x627E;&#x5230;Followers&#x540C;&#x5B83;&#x7684;&#x65E5;&#x5FD7;&#x4E00;&#x81F4;&#x7684;&#x5730;&#x65B9;&#xFF0C;&#x7136;&#x540E;&#x8986;&#x76D6;Followers&#x5728;&#x8BE5;&#x4F4D;&#x7F6E;&#x4E4B;&#x540E;&#x7684;&#x6761;&#x76EE;</p>\n</li>\n</ul>\n<h3 id=\"&#x5B89;&#x5168;&#x6027;\"><a href=\"#&#x5B89;&#x5168;&#x6027;\" class=\"headerlink\" title=\"&#x5B89;&#x5168;&#x6027;\"></a>&#x5B89;&#x5168;&#x6027;</h3><p>1.&#x62E5;&#x6709;&#x6700;&#x65B0;&#x7684;&#x5DF2;&#x63D0;&#x4EA4;&#x7684;log entry&#x7684;Follower&#x624D;&#x6709;&#x8D44;&#x683C;&#x6210;&#x4E3A;Leader&#x3002;<br>2.Leader&#x53EA;&#x80FD;&#x63A8;&#x8FDB;commit index&#x6765;&#x63D0;&#x4EA4;&#x5F53;&#x524D;term&#x7684;&#x5DF2;&#x7ECF;&#x590D;&#x5236;&#x5230;&#x5927;&#x591A;&#x6570;&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x7684;&#x65E5;&#x5FD7;&#xFF0C;&#x65E7;term&#x65E5;&#x5FD7;&#x7684;&#x63D0;&#x4EA4;&#x8981;&#x7B49;&#x5230;&#x63D0;&#x4EA4;&#x5F53;&#x524D;term&#x7684;&#x65E5;&#x5FD7;&#x6765;&#x95F4;&#x63A5;&#x63D0;&#x4EA4;&#xFF08;log index &#x5C0F;&#x4E8E; commit index&#x7684;&#x65E5;&#x5FD7;&#x88AB;&#x95F4;&#x63A5;&#x63D0;&#x4EA4;&#xFF09;&#x3002;</p>\n<h3 id=\"&#x65E5;&#x5FD7;&#x538B;&#x7F29;\"><a href=\"#&#x65E5;&#x5FD7;&#x538B;&#x7F29;\" class=\"headerlink\" title=\"&#x65E5;&#x5FD7;&#x538B;&#x7F29;\"></a>&#x65E5;&#x5FD7;&#x538B;&#x7F29;</h3><p>Raft&#x91C7;&#x7528;&#x5BF9;&#x6574;&#x4E2A;&#x7CFB;&#x7EDF;&#x8FDB;&#x884C;snapshot&#x6765;&#x89E3;&#x51B3;&#xFF0C;snapshot&#x4E4B;&#x524D;&#x7684;&#x65E5;&#x5FD7;&#x90FD;&#x53EF;&#x4EE5;&#x4E22;&#x5F03;&#x3002;<br>&#x6BCF;&#x4E2A;&#x526F;&#x672C;&#x72EC;&#x7ACB;&#x7684;&#x5BF9;&#x81EA;&#x5DF1;&#x7684;&#x7CFB;&#x7EDF;&#x72B6;&#x6001;&#x8FDB;&#x884C;snapshot&#xFF0C;&#x5E76;&#x4E14;&#x53EA;&#x80FD;&#x5BF9;&#x5DF2;&#x7ECF;&#x63D0;&#x4EA4;&#x7684;&#x65E5;&#x5FD7;&#x8BB0;&#x5F55;&#x8FDB;&#x884C;snapshot&#x3002;</p>\n<ul>\n<li><p>Snapshot</p>\n<p>1.&#x65E5;&#x5FD7;&#x5143;&#x6570;&#x636E;&#x3002;&#x6700;&#x540E;&#x4E00;&#x6761;&#x5DF2;&#x63D0;&#x4EA4;&#x7684; log entry&#x7684; log index&#x548C;term&#x3002;&#x8FD9;&#x4E24;&#x4E2A;&#x503C;&#x5728;snapshot&#x4E4B;&#x540E;&#x7684;&#x7B2C;&#x4E00;&#x6761;log entry&#x7684;AppendEntries RPC&#x7684;&#x5B8C;&#x6574;&#x6027;&#x68C0;&#x67E5;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x88AB;&#x7528;&#x4E0A;&#x3002;<br>2.&#x7CFB;&#x7EDF;&#x5F53;&#x524D;&#x72B6;&#x6001;&#x3002;</p>\n<p>Leader&#x4F1A;&#x4EE5;Snapshot&#x7684;&#x5F62;&#x5F0F;&#x53D1;&#x7ED9;&#x65E5;&#x5FD7;&#x843D;&#x540E;&#x592A;&#x591A;&#x6216;&#x65B0;&#x4E0A;&#x7EBF;&#x7684;Follower&#xFF0C;&#x4F7F;&#x7528;InstalledSnapshot RPC&#x3002;</p>\n</li>\n</ul>\n<h2 id=\"Paxos\"><a href=\"#Paxos\" class=\"headerlink\" title=\"Paxos\"></a>Paxos</h2><p><em>XMind: ZEN - Trial Version</em></p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"}],"excerpt":"<html><head></head><body><h1 id=\"&#x5206;&#x5E03;&#x5F0F;&#x7B97;&#x6CD5;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x603B;&#x7ED3;&#xFF08;&#x65BD;&#x5DE5;&#x4E2D;&#xFF09;\"><a href=\"#&#x5206;&#x5E03;&#x5F0F;&#x7B97;&#x6CD5;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x603B;&#x7ED3;&#xFF08;&#x65BD;&#x5DE5;&#x4E2D;&#xFF09;\" class=\"headerlink\" title=\"&#x5206;&#x5E03;&#x5F0F;&#x7B97;&#x6CD5;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x603B;&#x7ED3;&#xFF08;&#x65BD;&#x5DE5;&#x4E2D;&#xFF09;\"></a>&#x5206;&#x5E03;&#x5F0F;&#x7B97;&#x6CD5;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x603B;&#x7ED3;&#xFF08;&#x65BD;&#x5DE5;&#x4E2D;&#xFF09;</h1><p>&#x603B;&#x7ED3;&#x5F53;&#x524D;&#x4F7F;&#x7528;&#x8F83;&#x591A;&#x7684;&#x4E00;&#x79CD;&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;&#x7B97;&#x6CD5;&#x7684;&#x539F;&#x7406;&#x53CA;&#x5176;&#x8FD0;&#x7528;&#x3002;</p>\n<h2 id=\"Raft\"><a href=\"#Raft\" class=\"headerlink\" title=\"Raft\"></a>Raft</h2></body></html>","more":"<h3 id=\"角色\"><a href=\"#角色\" class=\"headerlink\" title=\"角色\"></a>角色</h3><p>最多只有一个Leader，正常工作时期只有Leader和Follower</p>\n<ul>\n<li><p>成员</p>\n<ul>\n<li><p>Leader</p>\n<p>接受客户端请求，并向Follower同步请求日志，当日志同步到大多数节点上后告诉Follower提交日志。</p>\n</li>\n<li><p>Follower</p>\n<p>接受并持久化Leader同步的日志，在Leader告之日志可以提交之后，提交日志。</p>\n</li>\n<li><p>Candidate</p>\n<p>Leader选举过程中的临时角色。</p>\n</li>\n</ul>\n</li>\n<li><p>角色变化</p>\n<ul>\n<li><p>Leader</p>\n<p>Leader在当前任期term中失去服务链接，将会变为Candidate。</p>\n</li>\n<li><p>Follower</p>\n<p>1.节点初始状态为Follower。<br>2.Follower超时没有收到Leader的消息，会转变为Candidate，并开始选举。</p>\n</li>\n<li><p>Candidate</p>\n<p>1.选举成功成为Leader。<br>2.选举失败成为Follower。<br>3.超时重新选举，还是Candidate。</p>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Leader选举\"><a href=\"#Leader选举\" class=\"headerlink\" title=\"Leader选举\"></a>Leader选举</h3><p>1.Follower超时没有收到Leader的心跳时会发起选举，选举时会将自己的term+1，并转化为Candidate且投票给自己，并向集群内发送RequestVote RPC。</p>\n<ul>\n<li>赢得最多选票成为Leader</li>\n<li>收到其他Leader信息，被抢先选举</li>\n<li>没有服务获得最多选票，等待重新发起选举</li>\n</ul>\n<h3 id=\"日志同步\"><a href=\"#日志同步\" class=\"headerlink\" title=\"日志同步\"></a>日志同步</h3><p>1.Leader接受客户端信息。<br>2.Leader向Follower发起日志复制，AppendEntries RPC。<br>3.Follower未成功接受时，Leader会持续向Follower发起AppendEntries RPC。<br>4.大部分Follower返回成功时，Leader向客户端返回成功结果，并允许改条日志commit。</p>\n<ul>\n<li><p>日志</p>\n<p>日志包含索引，当前term号，和状态机的执行命令。</p>\n</li>\n<li><p>同步</p>\n<p>1.相同索引和term号的命令是相同的。<br>2.相同索引和term号之前的日志都是相同的。</p>\n<p>Leader为了使Followers的日志同自己的一致，Leader需要找到Followers同它的日志一致的地方，然后覆盖Followers在该位置之后的条目</p>\n</li>\n</ul>\n<h3 id=\"安全性\"><a href=\"#安全性\" class=\"headerlink\" title=\"安全性\"></a>安全性</h3><p>1.拥有最新的已提交的log entry的Follower才有资格成为Leader。<br>2.Leader只能推进commit index来提交当前term的已经复制到大多数服务器上的日志，旧term日志的提交要等到提交当前term的日志来间接提交（log index 小于 commit index的日志被间接提交）。</p>\n<h3 id=\"日志压缩\"><a href=\"#日志压缩\" class=\"headerlink\" title=\"日志压缩\"></a>日志压缩</h3><p>Raft采用对整个系统进行snapshot来解决，snapshot之前的日志都可以丢弃。<br>每个副本独立的对自己的系统状态进行snapshot，并且只能对已经提交的日志记录进行snapshot。</p>\n<ul>\n<li><p>Snapshot</p>\n<p>1.日志元数据。最后一条已提交的 log entry的 log index和term。这两个值在snapshot之后的第一条log entry的AppendEntries RPC的完整性检查的时候会被用上。<br>2.系统当前状态。</p>\n<p>Leader会以Snapshot的形式发给日志落后太多或新上线的Follower，使用InstalledSnapshot RPC。</p>\n</li>\n</ul>\n<h2 id=\"Paxos\"><a href=\"#Paxos\" class=\"headerlink\" title=\"Paxos\"></a>Paxos</h2><p><em>XMind: ZEN - Trial Version</em></p>"},{"title":"分布式事务其实很简单","date":"2020-03-01T12:54:06.000Z","_content":"\n# 什么是分布式事务？为什么我们要有分布式事务？\n\n## 先聊聊我们的项目开发\n工作中随着业务的逐渐扩展，我们的业务系统也会慢慢变得庞大。\n拿借贷系统来说，从金融借贷产品的上架，商户的申请、审核，贷款的进件、KYC、放贷，再到用户的还款甚至催收。\n而业务往往为了快速落地，我们会将所有业务融入到一个服务中，快速开发、快速上线。\n好处自然是公司业务蹭蹭往上走，业务提出的需求也能快速落地并投放至市场，但长此以往开发测试人员会变得疲惫不堪。\n这里我们就要聊到服务的拆分，由于这次主要讲的是分布式事务，我们下次有时间再来讨论讨论微服务的拆分和现在大热门的DDD领域模型。\n\n## 服务拆分后。。。\n在互联网公司工作的话，大家应该都经历过一个大系统，经过不停的迭代，最后拆成数个微服务的过程。\n其中的好处自然不用说，系统解耦、业务解耦、快速发版、更少的维护等等等等。\n但是一旦拆出多个微服务，我们也会遇到一个棘手问题。\n<!-- more -->\n## 为什么我们要有分布式事务？这个问题凸显了出来\n假设我们有这样一个业务：客户申请了一个贷款，这个时候我们需要做的是\n1. 收集用户信息\n2. 审核用户信息\n3. 创建贷款订单及分期订单等\n4. 选取投资人\n5. 放款\n   \n其中收集用户信息和审核用户信息并不是一个实时操作，我们可能会交由消息去异步处理。\n但是第三、四、五步是审核通过后一一执行的，当然我们也可以交由消息异步处理，但是试想一个场景。用户再分期购买产品的时候虽然对用户只是一次交易操作，但是我们后台可能已经把这笔交易作为一笔分期借款进行了落款。但是客户不知道，不是说异步处理不好，但如果能实时的告诉用户支付结果，是不是能提高用户体验和转换率呢。\n回头看下我们的系统，已经被拆成订单服务、用户体系服务、放款服务了，随之带来的是每个微服务有自己对应的数据库，分别保存的是订单信息、投资人|借款人信息、放款信息。\n一不做二不休，我们把以前同一个服务内的方法调用改成不同服务之间的异步调用，但随之而来的是生产上不时会出现漏数据或订单无法正常完成的问题。\n聪明的小伙伴应该早就发现了，为了保证分布式服务间调用的事务性，分布式事务就孕育而生了。\n\n\n## 两阶段提交/XA\n\n常见于单系统操作多数据源。\n由于依赖数据库的事务，导致效率低，不适合高并发场景。\n\n### 事务管理器\n\n### 流程\n\n- 第一阶段\n\n\t- 发起事务\n\t- 取消事务\n\n- 第二阶段\n\n\t- 通知执行每一个任务\n\n## TCC\n\n适合对分布式一致性要求要的系统，如支付、交易等\n\n### 流程\n\n- Try\n\n  对各个服务的资源进行检查，业务校验等。\n\n- Confirm\n\n  进行实际的操作\n\n- Cancel\n\n  错误发生时，对之前的操作进行回滚\n\n### 问题\n\n业务耦合比较大，需要大量的业务代码支持\n\n## 本地消息表\n\n可以保证事务的最终一致性，但不适用于高并发场景\n\n### 流程\n\n- A系统业务操作后落消息表并MQ通知B系统\n- B系统接收消息后执行业务操作，并更新A、B信息消息状态\n- B系统未成功时，A系统会一直重试到成功\n\n## 可靠消息最终一致性\n\n依赖RMQ的消息事务，和高可用，保证消息一定通知到，并最终保证事务的一致性\n\n### 流程\n\n- A系统发送prepare消息至MQ，并处理业务\n- A系统处理业务成功后发送Confirm消息至MQ\n- B系统收到Confirm消息后执行业务\n\n## 最大努力通知方案\n\n可以允许一定程度上的事务失败，一般用在对分布式事务不要个的系统，比如日志收集等\n\n### A系统发送消息至MQ\n\n### 最大努力系统接收MQ通知并调用B系统\n\n*XMind: ZEN - Trial Version*","source":"_posts/分布式事务整理.md","raw":"---\ntitle: 分布式事务其实很简单\ndate: 2020-03-01 20:54:06\ntags: \n    - Java\ncategories :\n    - Technology\n---\n\n# 什么是分布式事务？为什么我们要有分布式事务？\n\n## 先聊聊我们的项目开发\n工作中随着业务的逐渐扩展，我们的业务系统也会慢慢变得庞大。\n拿借贷系统来说，从金融借贷产品的上架，商户的申请、审核，贷款的进件、KYC、放贷，再到用户的还款甚至催收。\n而业务往往为了快速落地，我们会将所有业务融入到一个服务中，快速开发、快速上线。\n好处自然是公司业务蹭蹭往上走，业务提出的需求也能快速落地并投放至市场，但长此以往开发测试人员会变得疲惫不堪。\n这里我们就要聊到服务的拆分，由于这次主要讲的是分布式事务，我们下次有时间再来讨论讨论微服务的拆分和现在大热门的DDD领域模型。\n\n## 服务拆分后。。。\n在互联网公司工作的话，大家应该都经历过一个大系统，经过不停的迭代，最后拆成数个微服务的过程。\n其中的好处自然不用说，系统解耦、业务解耦、快速发版、更少的维护等等等等。\n但是一旦拆出多个微服务，我们也会遇到一个棘手问题。\n<!-- more -->\n## 为什么我们要有分布式事务？这个问题凸显了出来\n假设我们有这样一个业务：客户申请了一个贷款，这个时候我们需要做的是\n1. 收集用户信息\n2. 审核用户信息\n3. 创建贷款订单及分期订单等\n4. 选取投资人\n5. 放款\n   \n其中收集用户信息和审核用户信息并不是一个实时操作，我们可能会交由消息去异步处理。\n但是第三、四、五步是审核通过后一一执行的，当然我们也可以交由消息异步处理，但是试想一个场景。用户再分期购买产品的时候虽然对用户只是一次交易操作，但是我们后台可能已经把这笔交易作为一笔分期借款进行了落款。但是客户不知道，不是说异步处理不好，但如果能实时的告诉用户支付结果，是不是能提高用户体验和转换率呢。\n回头看下我们的系统，已经被拆成订单服务、用户体系服务、放款服务了，随之带来的是每个微服务有自己对应的数据库，分别保存的是订单信息、投资人|借款人信息、放款信息。\n一不做二不休，我们把以前同一个服务内的方法调用改成不同服务之间的异步调用，但随之而来的是生产上不时会出现漏数据或订单无法正常完成的问题。\n聪明的小伙伴应该早就发现了，为了保证分布式服务间调用的事务性，分布式事务就孕育而生了。\n\n\n## 两阶段提交/XA\n\n常见于单系统操作多数据源。\n由于依赖数据库的事务，导致效率低，不适合高并发场景。\n\n### 事务管理器\n\n### 流程\n\n- 第一阶段\n\n\t- 发起事务\n\t- 取消事务\n\n- 第二阶段\n\n\t- 通知执行每一个任务\n\n## TCC\n\n适合对分布式一致性要求要的系统，如支付、交易等\n\n### 流程\n\n- Try\n\n  对各个服务的资源进行检查，业务校验等。\n\n- Confirm\n\n  进行实际的操作\n\n- Cancel\n\n  错误发生时，对之前的操作进行回滚\n\n### 问题\n\n业务耦合比较大，需要大量的业务代码支持\n\n## 本地消息表\n\n可以保证事务的最终一致性，但不适用于高并发场景\n\n### 流程\n\n- A系统业务操作后落消息表并MQ通知B系统\n- B系统接收消息后执行业务操作，并更新A、B信息消息状态\n- B系统未成功时，A系统会一直重试到成功\n\n## 可靠消息最终一致性\n\n依赖RMQ的消息事务，和高可用，保证消息一定通知到，并最终保证事务的一致性\n\n### 流程\n\n- A系统发送prepare消息至MQ，并处理业务\n- A系统处理业务成功后发送Confirm消息至MQ\n- B系统收到Confirm消息后执行业务\n\n## 最大努力通知方案\n\n可以允许一定程度上的事务失败，一般用在对分布式事务不要个的系统，比如日志收集等\n\n### A系统发送消息至MQ\n\n### 最大努力系统接收MQ通知并调用B系统\n\n*XMind: ZEN - Trial Version*","slug":"分布式事务整理","published":1,"updated":"2020-12-14T09:51:24.018Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htd000ov2529oao6um7","content":"<html><head></head><body><h1 id=\"&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;\"><a href=\"#&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;\" class=\"headerlink\" title=\"&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;\"></a>&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;</h1><h2 id=\"&#x5148;&#x804A;&#x804A;&#x6211;&#x4EEC;&#x7684;&#x9879;&#x76EE;&#x5F00;&#x53D1;\"><a href=\"#&#x5148;&#x804A;&#x804A;&#x6211;&#x4EEC;&#x7684;&#x9879;&#x76EE;&#x5F00;&#x53D1;\" class=\"headerlink\" title=\"&#x5148;&#x804A;&#x804A;&#x6211;&#x4EEC;&#x7684;&#x9879;&#x76EE;&#x5F00;&#x53D1;\"></a>&#x5148;&#x804A;&#x804A;&#x6211;&#x4EEC;&#x7684;&#x9879;&#x76EE;&#x5F00;&#x53D1;</h2><p>&#x5DE5;&#x4F5C;&#x4E2D;&#x968F;&#x7740;&#x4E1A;&#x52A1;&#x7684;&#x9010;&#x6E10;&#x6269;&#x5C55;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;&#x4E5F;&#x4F1A;&#x6162;&#x6162;&#x53D8;&#x5F97;&#x5E9E;&#x5927;&#x3002;<br>&#x62FF;&#x501F;&#x8D37;&#x7CFB;&#x7EDF;&#x6765;&#x8BF4;&#xFF0C;&#x4ECE;&#x91D1;&#x878D;&#x501F;&#x8D37;&#x4EA7;&#x54C1;&#x7684;&#x4E0A;&#x67B6;&#xFF0C;&#x5546;&#x6237;&#x7684;&#x7533;&#x8BF7;&#x3001;&#x5BA1;&#x6838;&#xFF0C;&#x8D37;&#x6B3E;&#x7684;&#x8FDB;&#x4EF6;&#x3001;KYC&#x3001;&#x653E;&#x8D37;&#xFF0C;&#x518D;&#x5230;&#x7528;&#x6237;&#x7684;&#x8FD8;&#x6B3E;&#x751A;&#x81F3;&#x50AC;&#x6536;&#x3002;<br>&#x800C;&#x4E1A;&#x52A1;&#x5F80;&#x5F80;&#x4E3A;&#x4E86;&#x5FEB;&#x901F;&#x843D;&#x5730;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5C06;&#x6240;&#x6709;&#x4E1A;&#x52A1;&#x878D;&#x5165;&#x5230;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x4E2D;&#xFF0C;&#x5FEB;&#x901F;&#x5F00;&#x53D1;&#x3001;&#x5FEB;&#x901F;&#x4E0A;&#x7EBF;&#x3002;<br>&#x597D;&#x5904;&#x81EA;&#x7136;&#x662F;&#x516C;&#x53F8;&#x4E1A;&#x52A1;&#x8E6D;&#x8E6D;&#x5F80;&#x4E0A;&#x8D70;&#xFF0C;&#x4E1A;&#x52A1;&#x63D0;&#x51FA;&#x7684;&#x9700;&#x6C42;&#x4E5F;&#x80FD;&#x5FEB;&#x901F;&#x843D;&#x5730;&#x5E76;&#x6295;&#x653E;&#x81F3;&#x5E02;&#x573A;&#xFF0C;&#x4F46;&#x957F;&#x6B64;&#x4EE5;&#x5F80;&#x5F00;&#x53D1;&#x6D4B;&#x8BD5;&#x4EBA;&#x5458;&#x4F1A;&#x53D8;&#x5F97;&#x75B2;&#x60EB;&#x4E0D;&#x582A;&#x3002;<br>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5C31;&#x8981;&#x804A;&#x5230;&#x670D;&#x52A1;&#x7684;&#x62C6;&#x5206;&#xFF0C;&#x7531;&#x4E8E;&#x8FD9;&#x6B21;&#x4E3B;&#x8981;&#x8BB2;&#x7684;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF0C;&#x6211;&#x4EEC;&#x4E0B;&#x6B21;&#x6709;&#x65F6;&#x95F4;&#x518D;&#x6765;&#x8BA8;&#x8BBA;&#x8BA8;&#x8BBA;&#x5FAE;&#x670D;&#x52A1;&#x7684;&#x62C6;&#x5206;&#x548C;&#x73B0;&#x5728;&#x5927;&#x70ED;&#x95E8;&#x7684;DDD&#x9886;&#x57DF;&#x6A21;&#x578B;&#x3002;</p>\n<h2 id=\"&#x670D;&#x52A1;&#x62C6;&#x5206;&#x540E;&#x3002;&#x3002;&#x3002;\"><a href=\"#&#x670D;&#x52A1;&#x62C6;&#x5206;&#x540E;&#x3002;&#x3002;&#x3002;\" class=\"headerlink\" title=\"&#x670D;&#x52A1;&#x62C6;&#x5206;&#x540E;&#x3002;&#x3002;&#x3002;\"></a>&#x670D;&#x52A1;&#x62C6;&#x5206;&#x540E;&#x3002;&#x3002;&#x3002;</h2><p>&#x5728;&#x4E92;&#x8054;&#x7F51;&#x516C;&#x53F8;&#x5DE5;&#x4F5C;&#x7684;&#x8BDD;&#xFF0C;&#x5927;&#x5BB6;&#x5E94;&#x8BE5;&#x90FD;&#x7ECF;&#x5386;&#x8FC7;&#x4E00;&#x4E2A;&#x5927;&#x7CFB;&#x7EDF;&#xFF0C;&#x7ECF;&#x8FC7;&#x4E0D;&#x505C;&#x7684;&#x8FED;&#x4EE3;&#xFF0C;&#x6700;&#x540E;&#x62C6;&#x6210;&#x6570;&#x4E2A;&#x5FAE;&#x670D;&#x52A1;&#x7684;&#x8FC7;&#x7A0B;&#x3002;<br>&#x5176;&#x4E2D;&#x7684;&#x597D;&#x5904;&#x81EA;&#x7136;&#x4E0D;&#x7528;&#x8BF4;&#xFF0C;&#x7CFB;&#x7EDF;&#x89E3;&#x8026;&#x3001;&#x4E1A;&#x52A1;&#x89E3;&#x8026;&#x3001;&#x5FEB;&#x901F;&#x53D1;&#x7248;&#x3001;&#x66F4;&#x5C11;&#x7684;&#x7EF4;&#x62A4;&#x7B49;&#x7B49;&#x7B49;&#x7B49;&#x3002;<br>&#x4F46;&#x662F;&#x4E00;&#x65E6;&#x62C6;&#x51FA;&#x591A;&#x4E2A;&#x5FAE;&#x670D;&#x52A1;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x4F1A;&#x9047;&#x5230;&#x4E00;&#x4E2A;&#x68D8;&#x624B;&#x95EE;&#x9898;&#x3002;</p>\n<a id=\"more\"></a>\n<h2 id=\"&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x51F8;&#x663E;&#x4E86;&#x51FA;&#x6765;\"><a href=\"#&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x51F8;&#x663E;&#x4E86;&#x51FA;&#x6765;\" class=\"headerlink\" title=\"&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x51F8;&#x663E;&#x4E86;&#x51FA;&#x6765;\"></a>&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x51F8;&#x663E;&#x4E86;&#x51FA;&#x6765;</h2><p>&#x5047;&#x8BBE;&#x6211;&#x4EEC;&#x6709;&#x8FD9;&#x6837;&#x4E00;&#x4E2A;&#x4E1A;&#x52A1;&#xFF1A;&#x5BA2;&#x6237;&#x7533;&#x8BF7;&#x4E86;&#x4E00;&#x4E2A;&#x8D37;&#x6B3E;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x505A;&#x7684;&#x662F;</p>\n<ol>\n<li>&#x6536;&#x96C6;&#x7528;&#x6237;&#x4FE1;&#x606F;</li>\n<li>&#x5BA1;&#x6838;&#x7528;&#x6237;&#x4FE1;&#x606F;</li>\n<li>&#x521B;&#x5EFA;&#x8D37;&#x6B3E;&#x8BA2;&#x5355;&#x53CA;&#x5206;&#x671F;&#x8BA2;&#x5355;&#x7B49;</li>\n<li>&#x9009;&#x53D6;&#x6295;&#x8D44;&#x4EBA;</li>\n<li>&#x653E;&#x6B3E;</li>\n</ol>\n<p>&#x5176;&#x4E2D;&#x6536;&#x96C6;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x548C;&#x5BA1;&#x6838;&#x7528;&#x6237;&#x4FE1;&#x606F;&#x5E76;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x5B9E;&#x65F6;&#x64CD;&#x4F5C;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x80FD;&#x4F1A;&#x4EA4;&#x7531;&#x6D88;&#x606F;&#x53BB;&#x5F02;&#x6B65;&#x5904;&#x7406;&#x3002;<br>&#x4F46;&#x662F;&#x7B2C;&#x4E09;&#x3001;&#x56DB;&#x3001;&#x4E94;&#x6B65;&#x662F;&#x5BA1;&#x6838;&#x901A;&#x8FC7;&#x540E;&#x4E00;&#x4E00;&#x6267;&#x884C;&#x7684;&#xFF0C;&#x5F53;&#x7136;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x4EA4;&#x7531;&#x6D88;&#x606F;&#x5F02;&#x6B65;&#x5904;&#x7406;&#xFF0C;&#x4F46;&#x662F;&#x8BD5;&#x60F3;&#x4E00;&#x4E2A;&#x573A;&#x666F;&#x3002;&#x7528;&#x6237;&#x518D;&#x5206;&#x671F;&#x8D2D;&#x4E70;&#x4EA7;&#x54C1;&#x7684;&#x65F6;&#x5019;&#x867D;&#x7136;&#x5BF9;&#x7528;&#x6237;&#x53EA;&#x662F;&#x4E00;&#x6B21;&#x4EA4;&#x6613;&#x64CD;&#x4F5C;&#xFF0C;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x540E;&#x53F0;&#x53EF;&#x80FD;&#x5DF2;&#x7ECF;&#x628A;&#x8FD9;&#x7B14;&#x4EA4;&#x6613;&#x4F5C;&#x4E3A;&#x4E00;&#x7B14;&#x5206;&#x671F;&#x501F;&#x6B3E;&#x8FDB;&#x884C;&#x4E86;&#x843D;&#x6B3E;&#x3002;&#x4F46;&#x662F;&#x5BA2;&#x6237;&#x4E0D;&#x77E5;&#x9053;&#xFF0C;&#x4E0D;&#x662F;&#x8BF4;&#x5F02;&#x6B65;&#x5904;&#x7406;&#x4E0D;&#x597D;&#xFF0C;&#x4F46;&#x5982;&#x679C;&#x80FD;&#x5B9E;&#x65F6;&#x7684;&#x544A;&#x8BC9;&#x7528;&#x6237;&#x652F;&#x4ED8;&#x7ED3;&#x679C;&#xFF0C;&#x662F;&#x4E0D;&#x662F;&#x80FD;&#x63D0;&#x9AD8;&#x7528;&#x6237;&#x4F53;&#x9A8C;&#x548C;&#x8F6C;&#x6362;&#x7387;&#x5462;&#x3002;<br>&#x56DE;&#x5934;&#x770B;&#x4E0B;&#x6211;&#x4EEC;&#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x5DF2;&#x7ECF;&#x88AB;&#x62C6;&#x6210;&#x8BA2;&#x5355;&#x670D;&#x52A1;&#x3001;&#x7528;&#x6237;&#x4F53;&#x7CFB;&#x670D;&#x52A1;&#x3001;&#x653E;&#x6B3E;&#x670D;&#x52A1;&#x4E86;&#xFF0C;&#x968F;&#x4E4B;&#x5E26;&#x6765;&#x7684;&#x662F;&#x6BCF;&#x4E2A;&#x5FAE;&#x670D;&#x52A1;&#x6709;&#x81EA;&#x5DF1;&#x5BF9;&#x5E94;&#x7684;&#x6570;&#x636E;&#x5E93;&#xFF0C;&#x5206;&#x522B;&#x4FDD;&#x5B58;&#x7684;&#x662F;&#x8BA2;&#x5355;&#x4FE1;&#x606F;&#x3001;&#x6295;&#x8D44;&#x4EBA;|&#x501F;&#x6B3E;&#x4EBA;&#x4FE1;&#x606F;&#x3001;&#x653E;&#x6B3E;&#x4FE1;&#x606F;&#x3002;<br>&#x4E00;&#x4E0D;&#x505A;&#x4E8C;&#x4E0D;&#x4F11;&#xFF0C;&#x6211;&#x4EEC;&#x628A;&#x4EE5;&#x524D;&#x540C;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x5185;&#x7684;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x6539;&#x6210;&#x4E0D;&#x540C;&#x670D;&#x52A1;&#x4E4B;&#x95F4;&#x7684;&#x5F02;&#x6B65;&#x8C03;&#x7528;&#xFF0C;&#x4F46;&#x968F;&#x4E4B;&#x800C;&#x6765;&#x7684;&#x662F;&#x751F;&#x4EA7;&#x4E0A;&#x4E0D;&#x65F6;&#x4F1A;&#x51FA;&#x73B0;&#x6F0F;&#x6570;&#x636E;&#x6216;&#x8BA2;&#x5355;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x5B8C;&#x6210;&#x7684;&#x95EE;&#x9898;&#x3002;<br>&#x806A;&#x660E;&#x7684;&#x5C0F;&#x4F19;&#x4F34;&#x5E94;&#x8BE5;&#x65E9;&#x5C31;&#x53D1;&#x73B0;&#x4E86;&#xFF0C;&#x4E3A;&#x4E86;&#x4FDD;&#x8BC1;&#x5206;&#x5E03;&#x5F0F;&#x670D;&#x52A1;&#x95F4;&#x8C03;&#x7528;&#x7684;&#x4E8B;&#x52A1;&#x6027;&#xFF0C;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x5C31;&#x5B55;&#x80B2;&#x800C;&#x751F;&#x4E86;&#x3002;</p>\n<h2 id=\"&#x4E24;&#x9636;&#x6BB5;&#x63D0;&#x4EA4;-XA\"><a href=\"#&#x4E24;&#x9636;&#x6BB5;&#x63D0;&#x4EA4;-XA\" class=\"headerlink\" title=\"&#x4E24;&#x9636;&#x6BB5;&#x63D0;&#x4EA4;/XA\"></a>&#x4E24;&#x9636;&#x6BB5;&#x63D0;&#x4EA4;/XA</h2><p>&#x5E38;&#x89C1;&#x4E8E;&#x5355;&#x7CFB;&#x7EDF;&#x64CD;&#x4F5C;&#x591A;&#x6570;&#x636E;&#x6E90;&#x3002;<br>&#x7531;&#x4E8E;&#x4F9D;&#x8D56;&#x6570;&#x636E;&#x5E93;&#x7684;&#x4E8B;&#x52A1;&#xFF0C;&#x5BFC;&#x81F4;&#x6548;&#x7387;&#x4F4E;&#xFF0C;&#x4E0D;&#x9002;&#x5408;&#x9AD8;&#x5E76;&#x53D1;&#x573A;&#x666F;&#x3002;</p>\n<h3 id=\"&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5668;\"><a href=\"#&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5668;\" class=\"headerlink\" title=\"&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5668;\"></a>&#x4E8B;&#x52A1;&#x7BA1;&#x7406;&#x5668;</h3><h3 id=\"&#x6D41;&#x7A0B;\"><a href=\"#&#x6D41;&#x7A0B;\" class=\"headerlink\" title=\"&#x6D41;&#x7A0B;\"></a>&#x6D41;&#x7A0B;</h3><ul>\n<li><p>&#x7B2C;&#x4E00;&#x9636;&#x6BB5;</p>\n<ul>\n<li>&#x53D1;&#x8D77;&#x4E8B;&#x52A1;</li>\n<li>&#x53D6;&#x6D88;&#x4E8B;&#x52A1;</li>\n</ul>\n</li>\n<li><p>&#x7B2C;&#x4E8C;&#x9636;&#x6BB5;</p>\n<ul>\n<li>&#x901A;&#x77E5;&#x6267;&#x884C;&#x6BCF;&#x4E00;&#x4E2A;&#x4EFB;&#x52A1;</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"TCC\"><a href=\"#TCC\" class=\"headerlink\" title=\"TCC\"></a>TCC</h2><p>&#x9002;&#x5408;&#x5BF9;&#x5206;&#x5E03;&#x5F0F;&#x4E00;&#x81F4;&#x6027;&#x8981;&#x6C42;&#x8981;&#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x5982;&#x652F;&#x4ED8;&#x3001;&#x4EA4;&#x6613;&#x7B49;</p>\n<h3 id=\"&#x6D41;&#x7A0B;-1\"><a href=\"#&#x6D41;&#x7A0B;-1\" class=\"headerlink\" title=\"&#x6D41;&#x7A0B;\"></a>&#x6D41;&#x7A0B;</h3><ul>\n<li><p>Try</p>\n<p>&#x5BF9;&#x5404;&#x4E2A;&#x670D;&#x52A1;&#x7684;&#x8D44;&#x6E90;&#x8FDB;&#x884C;&#x68C0;&#x67E5;&#xFF0C;&#x4E1A;&#x52A1;&#x6821;&#x9A8C;&#x7B49;&#x3002;</p>\n</li>\n<li><p>Confirm</p>\n<p>&#x8FDB;&#x884C;&#x5B9E;&#x9645;&#x7684;&#x64CD;&#x4F5C;</p>\n</li>\n<li><p>Cancel</p>\n<p>&#x9519;&#x8BEF;&#x53D1;&#x751F;&#x65F6;&#xFF0C;&#x5BF9;&#x4E4B;&#x524D;&#x7684;&#x64CD;&#x4F5C;&#x8FDB;&#x884C;&#x56DE;&#x6EDA;</p>\n</li>\n</ul>\n<h3 id=\"&#x95EE;&#x9898;\"><a href=\"#&#x95EE;&#x9898;\" class=\"headerlink\" title=\"&#x95EE;&#x9898;\"></a>&#x95EE;&#x9898;</h3><p>&#x4E1A;&#x52A1;&#x8026;&#x5408;&#x6BD4;&#x8F83;&#x5927;&#xFF0C;&#x9700;&#x8981;&#x5927;&#x91CF;&#x7684;&#x4E1A;&#x52A1;&#x4EE3;&#x7801;&#x652F;&#x6301;</p>\n<h2 id=\"&#x672C;&#x5730;&#x6D88;&#x606F;&#x8868;\"><a href=\"#&#x672C;&#x5730;&#x6D88;&#x606F;&#x8868;\" class=\"headerlink\" title=\"&#x672C;&#x5730;&#x6D88;&#x606F;&#x8868;\"></a>&#x672C;&#x5730;&#x6D88;&#x606F;&#x8868;</h2><p>&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x4E8B;&#x52A1;&#x7684;&#x6700;&#x7EC8;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x4F46;&#x4E0D;&#x9002;&#x7528;&#x4E8E;&#x9AD8;&#x5E76;&#x53D1;&#x573A;&#x666F;</p>\n<h3 id=\"&#x6D41;&#x7A0B;-2\"><a href=\"#&#x6D41;&#x7A0B;-2\" class=\"headerlink\" title=\"&#x6D41;&#x7A0B;\"></a>&#x6D41;&#x7A0B;</h3><ul>\n<li>A&#x7CFB;&#x7EDF;&#x4E1A;&#x52A1;&#x64CD;&#x4F5C;&#x540E;&#x843D;&#x6D88;&#x606F;&#x8868;&#x5E76;MQ&#x901A;&#x77E5;B&#x7CFB;&#x7EDF;</li>\n<li>B&#x7CFB;&#x7EDF;&#x63A5;&#x6536;&#x6D88;&#x606F;&#x540E;&#x6267;&#x884C;&#x4E1A;&#x52A1;&#x64CD;&#x4F5C;&#xFF0C;&#x5E76;&#x66F4;&#x65B0;A&#x3001;B&#x4FE1;&#x606F;&#x6D88;&#x606F;&#x72B6;&#x6001;</li>\n<li>B&#x7CFB;&#x7EDF;&#x672A;&#x6210;&#x529F;&#x65F6;&#xFF0C;A&#x7CFB;&#x7EDF;&#x4F1A;&#x4E00;&#x76F4;&#x91CD;&#x8BD5;&#x5230;&#x6210;&#x529F;</li>\n</ul>\n<h2 id=\"&#x53EF;&#x9760;&#x6D88;&#x606F;&#x6700;&#x7EC8;&#x4E00;&#x81F4;&#x6027;\"><a href=\"#&#x53EF;&#x9760;&#x6D88;&#x606F;&#x6700;&#x7EC8;&#x4E00;&#x81F4;&#x6027;\" class=\"headerlink\" title=\"&#x53EF;&#x9760;&#x6D88;&#x606F;&#x6700;&#x7EC8;&#x4E00;&#x81F4;&#x6027;\"></a>&#x53EF;&#x9760;&#x6D88;&#x606F;&#x6700;&#x7EC8;&#x4E00;&#x81F4;&#x6027;</h2><p>&#x4F9D;&#x8D56;RMQ&#x7684;&#x6D88;&#x606F;&#x4E8B;&#x52A1;&#xFF0C;&#x548C;&#x9AD8;&#x53EF;&#x7528;&#xFF0C;&#x4FDD;&#x8BC1;&#x6D88;&#x606F;&#x4E00;&#x5B9A;&#x901A;&#x77E5;&#x5230;&#xFF0C;&#x5E76;&#x6700;&#x7EC8;&#x4FDD;&#x8BC1;&#x4E8B;&#x52A1;&#x7684;&#x4E00;&#x81F4;&#x6027;</p>\n<h3 id=\"&#x6D41;&#x7A0B;-3\"><a href=\"#&#x6D41;&#x7A0B;-3\" class=\"headerlink\" title=\"&#x6D41;&#x7A0B;\"></a>&#x6D41;&#x7A0B;</h3><ul>\n<li>A&#x7CFB;&#x7EDF;&#x53D1;&#x9001;prepare&#x6D88;&#x606F;&#x81F3;MQ&#xFF0C;&#x5E76;&#x5904;&#x7406;&#x4E1A;&#x52A1;</li>\n<li>A&#x7CFB;&#x7EDF;&#x5904;&#x7406;&#x4E1A;&#x52A1;&#x6210;&#x529F;&#x540E;&#x53D1;&#x9001;Confirm&#x6D88;&#x606F;&#x81F3;MQ</li>\n<li>B&#x7CFB;&#x7EDF;&#x6536;&#x5230;Confirm&#x6D88;&#x606F;&#x540E;&#x6267;&#x884C;&#x4E1A;&#x52A1;</li>\n</ul>\n<h2 id=\"&#x6700;&#x5927;&#x52AA;&#x529B;&#x901A;&#x77E5;&#x65B9;&#x6848;\"><a href=\"#&#x6700;&#x5927;&#x52AA;&#x529B;&#x901A;&#x77E5;&#x65B9;&#x6848;\" class=\"headerlink\" title=\"&#x6700;&#x5927;&#x52AA;&#x529B;&#x901A;&#x77E5;&#x65B9;&#x6848;\"></a>&#x6700;&#x5927;&#x52AA;&#x529B;&#x901A;&#x77E5;&#x65B9;&#x6848;</h2><p>&#x53EF;&#x4EE5;&#x5141;&#x8BB8;&#x4E00;&#x5B9A;&#x7A0B;&#x5EA6;&#x4E0A;&#x7684;&#x4E8B;&#x52A1;&#x5931;&#x8D25;&#xFF0C;&#x4E00;&#x822C;&#x7528;&#x5728;&#x5BF9;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#x4E0D;&#x8981;&#x4E2A;&#x7684;&#x7CFB;&#x7EDF;&#xFF0C;&#x6BD4;&#x5982;&#x65E5;&#x5FD7;&#x6536;&#x96C6;&#x7B49;</p>\n<h3 id=\"A&#x7CFB;&#x7EDF;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x81F3;MQ\"><a href=\"#A&#x7CFB;&#x7EDF;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x81F3;MQ\" class=\"headerlink\" title=\"A&#x7CFB;&#x7EDF;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x81F3;MQ\"></a>A&#x7CFB;&#x7EDF;&#x53D1;&#x9001;&#x6D88;&#x606F;&#x81F3;MQ</h3><h3 id=\"&#x6700;&#x5927;&#x52AA;&#x529B;&#x7CFB;&#x7EDF;&#x63A5;&#x6536;MQ&#x901A;&#x77E5;&#x5E76;&#x8C03;&#x7528;B&#x7CFB;&#x7EDF;\"><a href=\"#&#x6700;&#x5927;&#x52AA;&#x529B;&#x7CFB;&#x7EDF;&#x63A5;&#x6536;MQ&#x901A;&#x77E5;&#x5E76;&#x8C03;&#x7528;B&#x7CFB;&#x7EDF;\" class=\"headerlink\" title=\"&#x6700;&#x5927;&#x52AA;&#x529B;&#x7CFB;&#x7EDF;&#x63A5;&#x6536;MQ&#x901A;&#x77E5;&#x5E76;&#x8C03;&#x7528;B&#x7CFB;&#x7EDF;\"></a>&#x6700;&#x5927;&#x52AA;&#x529B;&#x7CFB;&#x7EDF;&#x63A5;&#x6536;MQ&#x901A;&#x77E5;&#x5E76;&#x8C03;&#x7528;B&#x7CFB;&#x7EDF;</h3><p><em>XMind: ZEN - Trial Version</em></p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"}],"excerpt":"<html><head></head><body><h1 id=\"&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;\"><a href=\"#&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;\" class=\"headerlink\" title=\"&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;\"></a>&#x4EC0;&#x4E48;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x4EEC;&#x8981;&#x6709;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF1F;</h1><h2 id=\"&#x5148;&#x804A;&#x804A;&#x6211;&#x4EEC;&#x7684;&#x9879;&#x76EE;&#x5F00;&#x53D1;\"><a href=\"#&#x5148;&#x804A;&#x804A;&#x6211;&#x4EEC;&#x7684;&#x9879;&#x76EE;&#x5F00;&#x53D1;\" class=\"headerlink\" title=\"&#x5148;&#x804A;&#x804A;&#x6211;&#x4EEC;&#x7684;&#x9879;&#x76EE;&#x5F00;&#x53D1;\"></a>&#x5148;&#x804A;&#x804A;&#x6211;&#x4EEC;&#x7684;&#x9879;&#x76EE;&#x5F00;&#x53D1;</h2><p>&#x5DE5;&#x4F5C;&#x4E2D;&#x968F;&#x7740;&#x4E1A;&#x52A1;&#x7684;&#x9010;&#x6E10;&#x6269;&#x5C55;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;&#x4E5F;&#x4F1A;&#x6162;&#x6162;&#x53D8;&#x5F97;&#x5E9E;&#x5927;&#x3002;<br>&#x62FF;&#x501F;&#x8D37;&#x7CFB;&#x7EDF;&#x6765;&#x8BF4;&#xFF0C;&#x4ECE;&#x91D1;&#x878D;&#x501F;&#x8D37;&#x4EA7;&#x54C1;&#x7684;&#x4E0A;&#x67B6;&#xFF0C;&#x5546;&#x6237;&#x7684;&#x7533;&#x8BF7;&#x3001;&#x5BA1;&#x6838;&#xFF0C;&#x8D37;&#x6B3E;&#x7684;&#x8FDB;&#x4EF6;&#x3001;KYC&#x3001;&#x653E;&#x8D37;&#xFF0C;&#x518D;&#x5230;&#x7528;&#x6237;&#x7684;&#x8FD8;&#x6B3E;&#x751A;&#x81F3;&#x50AC;&#x6536;&#x3002;<br>&#x800C;&#x4E1A;&#x52A1;&#x5F80;&#x5F80;&#x4E3A;&#x4E86;&#x5FEB;&#x901F;&#x843D;&#x5730;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x5C06;&#x6240;&#x6709;&#x4E1A;&#x52A1;&#x878D;&#x5165;&#x5230;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x4E2D;&#xFF0C;&#x5FEB;&#x901F;&#x5F00;&#x53D1;&#x3001;&#x5FEB;&#x901F;&#x4E0A;&#x7EBF;&#x3002;<br>&#x597D;&#x5904;&#x81EA;&#x7136;&#x662F;&#x516C;&#x53F8;&#x4E1A;&#x52A1;&#x8E6D;&#x8E6D;&#x5F80;&#x4E0A;&#x8D70;&#xFF0C;&#x4E1A;&#x52A1;&#x63D0;&#x51FA;&#x7684;&#x9700;&#x6C42;&#x4E5F;&#x80FD;&#x5FEB;&#x901F;&#x843D;&#x5730;&#x5E76;&#x6295;&#x653E;&#x81F3;&#x5E02;&#x573A;&#xFF0C;&#x4F46;&#x957F;&#x6B64;&#x4EE5;&#x5F80;&#x5F00;&#x53D1;&#x6D4B;&#x8BD5;&#x4EBA;&#x5458;&#x4F1A;&#x53D8;&#x5F97;&#x75B2;&#x60EB;&#x4E0D;&#x582A;&#x3002;<br>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x5C31;&#x8981;&#x804A;&#x5230;&#x670D;&#x52A1;&#x7684;&#x62C6;&#x5206;&#xFF0C;&#x7531;&#x4E8E;&#x8FD9;&#x6B21;&#x4E3B;&#x8981;&#x8BB2;&#x7684;&#x662F;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x52A1;&#xFF0C;&#x6211;&#x4EEC;&#x4E0B;&#x6B21;&#x6709;&#x65F6;&#x95F4;&#x518D;&#x6765;&#x8BA8;&#x8BBA;&#x8BA8;&#x8BBA;&#x5FAE;&#x670D;&#x52A1;&#x7684;&#x62C6;&#x5206;&#x548C;&#x73B0;&#x5728;&#x5927;&#x70ED;&#x95E8;&#x7684;DDD&#x9886;&#x57DF;&#x6A21;&#x578B;&#x3002;</p>\n<h2 id=\"&#x670D;&#x52A1;&#x62C6;&#x5206;&#x540E;&#x3002;&#x3002;&#x3002;\"><a href=\"#&#x670D;&#x52A1;&#x62C6;&#x5206;&#x540E;&#x3002;&#x3002;&#x3002;\" class=\"headerlink\" title=\"&#x670D;&#x52A1;&#x62C6;&#x5206;&#x540E;&#x3002;&#x3002;&#x3002;\"></a>&#x670D;&#x52A1;&#x62C6;&#x5206;&#x540E;&#x3002;&#x3002;&#x3002;</h2><p>&#x5728;&#x4E92;&#x8054;&#x7F51;&#x516C;&#x53F8;&#x5DE5;&#x4F5C;&#x7684;&#x8BDD;&#xFF0C;&#x5927;&#x5BB6;&#x5E94;&#x8BE5;&#x90FD;&#x7ECF;&#x5386;&#x8FC7;&#x4E00;&#x4E2A;&#x5927;&#x7CFB;&#x7EDF;&#xFF0C;&#x7ECF;&#x8FC7;&#x4E0D;&#x505C;&#x7684;&#x8FED;&#x4EE3;&#xFF0C;&#x6700;&#x540E;&#x62C6;&#x6210;&#x6570;&#x4E2A;&#x5FAE;&#x670D;&#x52A1;&#x7684;&#x8FC7;&#x7A0B;&#x3002;<br>&#x5176;&#x4E2D;&#x7684;&#x597D;&#x5904;&#x81EA;&#x7136;&#x4E0D;&#x7528;&#x8BF4;&#xFF0C;&#x7CFB;&#x7EDF;&#x89E3;&#x8026;&#x3001;&#x4E1A;&#x52A1;&#x89E3;&#x8026;&#x3001;&#x5FEB;&#x901F;&#x53D1;&#x7248;&#x3001;&#x66F4;&#x5C11;&#x7684;&#x7EF4;&#x62A4;&#x7B49;&#x7B49;&#x7B49;&#x7B49;&#x3002;<br>&#x4F46;&#x662F;&#x4E00;&#x65E6;&#x62C6;&#x51FA;&#x591A;&#x4E2A;&#x5FAE;&#x670D;&#x52A1;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x4F1A;&#x9047;&#x5230;&#x4E00;&#x4E2A;&#x68D8;&#x624B;&#x95EE;&#x9898;&#x3002;</p></body></html>","more":"<h2 id=\"为什么我们要有分布式事务？这个问题凸显了出来\"><a href=\"#为什么我们要有分布式事务？这个问题凸显了出来\" class=\"headerlink\" title=\"为什么我们要有分布式事务？这个问题凸显了出来\"></a>为什么我们要有分布式事务？这个问题凸显了出来</h2><p>假设我们有这样一个业务：客户申请了一个贷款，这个时候我们需要做的是</p>\n<ol>\n<li>收集用户信息</li>\n<li>审核用户信息</li>\n<li>创建贷款订单及分期订单等</li>\n<li>选取投资人</li>\n<li>放款</li>\n</ol>\n<p>其中收集用户信息和审核用户信息并不是一个实时操作，我们可能会交由消息去异步处理。<br>但是第三、四、五步是审核通过后一一执行的，当然我们也可以交由消息异步处理，但是试想一个场景。用户再分期购买产品的时候虽然对用户只是一次交易操作，但是我们后台可能已经把这笔交易作为一笔分期借款进行了落款。但是客户不知道，不是说异步处理不好，但如果能实时的告诉用户支付结果，是不是能提高用户体验和转换率呢。<br>回头看下我们的系统，已经被拆成订单服务、用户体系服务、放款服务了，随之带来的是每个微服务有自己对应的数据库，分别保存的是订单信息、投资人|借款人信息、放款信息。<br>一不做二不休，我们把以前同一个服务内的方法调用改成不同服务之间的异步调用，但随之而来的是生产上不时会出现漏数据或订单无法正常完成的问题。<br>聪明的小伙伴应该早就发现了，为了保证分布式服务间调用的事务性，分布式事务就孕育而生了。</p>\n<h2 id=\"两阶段提交-XA\"><a href=\"#两阶段提交-XA\" class=\"headerlink\" title=\"两阶段提交/XA\"></a>两阶段提交/XA</h2><p>常见于单系统操作多数据源。<br>由于依赖数据库的事务，导致效率低，不适合高并发场景。</p>\n<h3 id=\"事务管理器\"><a href=\"#事务管理器\" class=\"headerlink\" title=\"事务管理器\"></a>事务管理器</h3><h3 id=\"流程\"><a href=\"#流程\" class=\"headerlink\" title=\"流程\"></a>流程</h3><ul>\n<li><p>第一阶段</p>\n<ul>\n<li>发起事务</li>\n<li>取消事务</li>\n</ul>\n</li>\n<li><p>第二阶段</p>\n<ul>\n<li>通知执行每一个任务</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"TCC\"><a href=\"#TCC\" class=\"headerlink\" title=\"TCC\"></a>TCC</h2><p>适合对分布式一致性要求要的系统，如支付、交易等</p>\n<h3 id=\"流程-1\"><a href=\"#流程-1\" class=\"headerlink\" title=\"流程\"></a>流程</h3><ul>\n<li><p>Try</p>\n<p>对各个服务的资源进行检查，业务校验等。</p>\n</li>\n<li><p>Confirm</p>\n<p>进行实际的操作</p>\n</li>\n<li><p>Cancel</p>\n<p>错误发生时，对之前的操作进行回滚</p>\n</li>\n</ul>\n<h3 id=\"问题\"><a href=\"#问题\" class=\"headerlink\" title=\"问题\"></a>问题</h3><p>业务耦合比较大，需要大量的业务代码支持</p>\n<h2 id=\"本地消息表\"><a href=\"#本地消息表\" class=\"headerlink\" title=\"本地消息表\"></a>本地消息表</h2><p>可以保证事务的最终一致性，但不适用于高并发场景</p>\n<h3 id=\"流程-2\"><a href=\"#流程-2\" class=\"headerlink\" title=\"流程\"></a>流程</h3><ul>\n<li>A系统业务操作后落消息表并MQ通知B系统</li>\n<li>B系统接收消息后执行业务操作，并更新A、B信息消息状态</li>\n<li>B系统未成功时，A系统会一直重试到成功</li>\n</ul>\n<h2 id=\"可靠消息最终一致性\"><a href=\"#可靠消息最终一致性\" class=\"headerlink\" title=\"可靠消息最终一致性\"></a>可靠消息最终一致性</h2><p>依赖RMQ的消息事务，和高可用，保证消息一定通知到，并最终保证事务的一致性</p>\n<h3 id=\"流程-3\"><a href=\"#流程-3\" class=\"headerlink\" title=\"流程\"></a>流程</h3><ul>\n<li>A系统发送prepare消息至MQ，并处理业务</li>\n<li>A系统处理业务成功后发送Confirm消息至MQ</li>\n<li>B系统收到Confirm消息后执行业务</li>\n</ul>\n<h2 id=\"最大努力通知方案\"><a href=\"#最大努力通知方案\" class=\"headerlink\" title=\"最大努力通知方案\"></a>最大努力通知方案</h2><p>可以允许一定程度上的事务失败，一般用在对分布式事务不要个的系统，比如日志收集等</p>\n<h3 id=\"A系统发送消息至MQ\"><a href=\"#A系统发送消息至MQ\" class=\"headerlink\" title=\"A系统发送消息至MQ\"></a>A系统发送消息至MQ</h3><h3 id=\"最大努力系统接收MQ通知并调用B系统\"><a href=\"#最大努力系统接收MQ通知并调用B系统\" class=\"headerlink\" title=\"最大努力系统接收MQ通知并调用B系统\"></a>最大努力系统接收MQ通知并调用B系统</h3><p><em>XMind: ZEN - Trial Version</em></p>"},{"title":"分支预测 GCC __builtin_expect 有用吗？","date":"2020-12-14T14:57:18.000Z","_content":"\n我们日常编写的代码中常见的分支语句，解释行语言能够根据代码运行期间收集分支的跳转的趋势动态优化分支跳转。而编译言语由于编译后直接生成可执行文件，因此很难在编译期推断出最好的优化条件。GCC为开发者提供了手动优化分支预测的方法__builtin_expect，通过显示编程向编译器提供优化建议从而优化分支的走向。\n<!-- more -->\n编译器是如何处理分支条件的？使用__builtin_expect的分支是如何得到优化的？使用GCC默认的优化级别会有什么不同？\n\n为了解开这些疑惑，我们直接上代码。\n\n* 平台 Ubuntu 20.04.1 LTS\n* 内核 Linux b13a1870ebc6 5.4.39-linuxkit #1 SMP Fri May 8 23:03:06 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\n* 编译工具 gcc (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0\n\n``` C\n#include <stdio.h>\n#include <stdlib.h>\n\n//x很可能为true\n#define likely(x) __builtin_expect(!!(x), 1)  \n//x很可能为false\n#define unlikely(x) __builtin_expect(!!(x), 0)\n\nvoid foo(){\n    printf(\"foo\\n\");\n}\nvoid foo1(){\n    printf(\"foo1\\n\");\n}\n\nvoid doLikely(int a){\n    \n    if(likely(a)){\n        foo();    \n    }else {\n        foo1();\n    }\n}\n\nvoid doLikelyNocall(int a){\n    int x;\n    if(likely(a)){\n        x = a*a;\n    }else {\n        x = a+a;\n    }\n}\n\nvoid doUnlikely(int a){\n    \n    if(unlikely(a)){\n        foo();\n    }else {\n        foo1();\n    }\n}\n\nvoid doUnlikelyNocall(int a){\n    int x;\n    if(unlikely(a)){\n        x = a*a;\n    }else {\n        x = a+a;\n    }\n}\n\nvoid normal(int a){\n    \n    if(a){\n        foo();\n    }else {\n        foo1();\n    }\n}\n\nvoid normalNocall(int a){\n    int x;\n    if(a){\n        x = a*a;\n    }else {\n        x = a+a;\n    }\n}\n\n\nint main(int argc, char **argv){\n    //为了排除常量导致编译器的优化，这里使用不定参数作为入参，防止编译器优化相关代码\n    int a = atoi(argv[1]);\n    doLikely(a);\n    doUnlikely(a);\n    normal(a);\n    doLikelyNocall(a);\n    doUnlikelyNocall(a);\n    normalNocall(a);\n    return 0;\n}\n```\n\n开始编辑，这里显示的指定-O0 -O1 -O2 -O3这四个优化等级。\n``` bash\nroot@b13a1870ebc6:/workspace_c/builtin_expect# gcc -O0 -o test_0 builtin_expect.c\nroot@b13a1870ebc6:/workspace_c/builtin_expect# gcc -O1 -o test_1 builtin_expect.c\nroot@b13a1870ebc6:/workspace_c/builtin_expect# gcc -O2 -o test_2 builtin_expect.c\nroot@b13a1870ebc6:/workspace_c/builtin_expect# gcc -O3 -o test_3 builtin_expect.c\n```\n\n将编译后的目标文件反汇编\n``` bash\nroot@b13a1870ebc6:/workspace_c/builtin_expect# objdump -d test_0 >test_0.a\nroot@b13a1870ebc6:/workspace_c/builtin_expect# objdump -d test_1 >test_1.a\nroot@b13a1870ebc6:/workspace_c/builtin_expect# objdump -d test_2 >test_2.a\nroot@b13a1870ebc6:/workspace_c/builtin_expect# objdump -d test_3 >test_3.a\n```\n\n最终我们得到了4个优化等级不同的汇编代码，并依次对比相关逻辑。\n\n1.-O0等级下，编译器默认不执行任何优化，我们对比原始分支代码和经过__builtin_expect优化后的代码在汇编码上有何区别。\n\n``` x86asm\n0000000000001197 <doLikely>:\n    1197:\tf3 0f 1e fa          \tendbr64 \n    119b:\t55                   \tpush   %rbp\n    119c:\t48 89 e5             \tmov    %rsp,%rbp\n    119f:\t48 83 ec 10          \tsub    $0x10,%rsp\n    11a3:\t89 7d fc             \tmov    %edi,-0x4(%rbp)      #参数a存放至-0x4(%rbp)处\n    11a6:\t83 7d fc 00          \tcmpl   $0x0,-0x4(%rbp)      #参数a和0比较\n    11aa:\t0f 95 c0             \tsetne  %al                  #条件设置，al中保存~ZF。if a = 1 then al = 1 ; if a = 0 then al = 0\n    11ad:\t0f b6 c0             \tmovzbl %al,%eax             #eax = 0000000000000000 -> 00000000000000000000000000000000 or 0000000000000001 -> 00000000000000000000000000000001\n    11b0:\t48 85 c0             \ttest   %rax,%rax            #判断eax是否为0\n    11b3:\t74 0c                \tje     11c1 <doLikely+0x2a> #eax = 0(a = 0)时，跳转至11c1，call foo1\n    11b5:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    11ba:\te8 aa ff ff ff       \tcallq  1169 <foo>           #eax!=0(a = 0)时，call foo\n    11bf:\teb 0a                \tjmp    11cb <doLikely+0x34> #跳转至11cb，结束\n    11c1:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    11c6:\te8 b5 ff ff ff       \tcallq  1180 <foo1>\n    11cb:\t90                   \tnop\n    11cc:\tc9                   \tleaveq \n    11cd:\tc3                   \tretq   \n\n\n0000000000001265 <normal>:\n    1265:\tf3 0f 1e fa          \tendbr64 \n    1269:\t55                   \tpush   %rbp\n    126a:\t48 89 e5             \tmov    %rsp,%rbp\n    126d:\t48 83 ec 10          \tsub    $0x10,%rsp\n    1271:\t89 7d fc             \tmov    %edi,-0x4(%rbp)      #参数a存放至-0x4(%rbp)处\n    1274:\t83 7d fc 00          \tcmpl   $0x0,-0x4(%rbp)      #参数a和0比较\n    1278:\t74 0c                \tje     1286 <normal+0x21>   #如果a=0，则跳转至1286，执行foo1\n    127a:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    127f:\te8 e5 fe ff ff       \tcallq  1169 <foo>           #如果a!=0,则执行foo\n    1284:\teb 0a                \tjmp    1290 <normal+0x2b>   #跳转至1290，结束\n    1286:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    128b:\te8 f0 fe ff ff       \tcallq  1180 <foo1>\n    1290:\t90                   \tnop\n    1291:\tc9                   \tleaveq \n    1292:\tc3                   \tretq   \n```\n\n通过对比，结果令人惊讶。虽然执行结果一直，但是没有经过_builtin_expect优化的分支判断，反而比标识_builtin_expect的汇编代码更加简洁。\n\n分析Unlikely的汇编代码，也存在同样的问题，编译器貌似会多此一举增加一步的判断\n``` x86asm\n00000000000011fe <doUnlikely>:\n    11fe:\tf3 0f 1e fa          \tendbr64 \n    1202:\t55                   \tpush   %rbp\n    1203:\t48 89 e5             \tmov    %rsp,%rbp\n    1206:\t48 83 ec 10          \tsub    $0x10,%rsp\n    120a:\t89 7d fc             \tmov    %edi,-0x4(%rbp)\n    120d:\t83 7d fc 00          \tcmpl   $0x0,-0x4(%rbp)\n    1211:\t0f 95 c0             \tsetne  %al\n    1214:\t0f b6 c0             \tmovzbl %al,%eax\n    1217:\t48 85 c0             \ttest   %rax,%rax\n    121a:\t74 0c                \tje     1228 <doUnlikely+0x2a>\n    121c:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    1221:\te8 43 ff ff ff       \tcallq  1169 <foo>\n    1226:\teb 0a                \tjmp    1232 <doUnlikely+0x34>\n    1228:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    122d:\te8 4e ff ff ff       \tcallq  1180 <foo1>\n    1232:\t90                   \tnop\n    1233:\tc9                   \tleaveq \n    1234:\tc3                   \tretq   \n```\n\n此外，我们也写了个非内部调用的版本，结果也是同样。编译器没有对_builtin_expect做出不一样的优化。\n\n``` x86asm\n00000000000011ce <doLikelyNocall>:\n    11ce:\tf3 0f 1e fa          \tendbr64 \n    11d2:\t55                   \tpush   %rbp\n    11d3:\t48 89 e5             \tmov    %rsp,%rbp\n    11d6:\t89 7d ec             \tmov    %edi,-0x14(%rbp)\n    11d9:\t83 7d ec 00          \tcmpl   $0x0,-0x14(%rbp)\n    11dd:\t0f 95 c0             \tsetne  %al\n    11e0:\t0f b6 c0             \tmovzbl %al,%eax\n    11e3:\t48 85 c0             \ttest   %rax,%rax\n    11e6:\t74 0b                \tje     11f3 <doLikelyNocall+0x25>\n    11e8:\t8b 45 ec             \tmov    -0x14(%rbp),%eax\n    11eb:\t0f af c0             \timul   %eax,%eax\n    11ee:\t89 45 fc             \tmov    %eax,-0x4(%rbp)\n    11f1:\teb 08                \tjmp    11fb <doLikelyNocall+0x2d>\n    11f3:\t8b 45 ec             \tmov    -0x14(%rbp),%eax\n    11f6:\t01 c0                \tadd    %eax,%eax\n    11f8:\t89 45 fc             \tmov    %eax,-0x4(%rbp)\n    11fb:\t90                   \tnop\n    11fc:\t5d                   \tpop    %rbp\n    11fd:\tc3                   \tretq   \n```\n\n2.为了了解_builtin_expect是否真的有用，我们再看看其他优化等级 -O1。\n\n``` x86asm\n000000000000119b <doLikely>:\n    119b:\tf3 0f 1e fa          \tendbr64 \n    119f:\t48 83 ec 08          \tsub    $0x8,%rsp\n    11a3:\t85 ff                \ttest   %edi,%edi\n    11a5:\t74 0f                \tje     11b6 <doLikely+0x1b>\n    11a7:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    11ac:\te8 b8 ff ff ff       \tcallq  1169 <foo>\n    11b1:\t48 83 c4 08          \tadd    $0x8,%rsp\n    11b5:\tc3                   \tretq   \n    11b6:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    11bb:\te8 c2 ff ff ff       \tcallq  1182 <foo1>\n    11c0:\teb ef                \tjmp    11b1 <doLikely+0x16>\n\n00000000000011f3 <normal>:\n    11f3:\tf3 0f 1e fa          \tendbr64 \n    11f7:\t48 83 ec 08          \tsub    $0x8,%rsp\n    11fb:\t85 ff                \ttest   %edi,%edi\n    11fd:\t74 0f                \tje     120e <normal+0x1b>\n    11ff:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    1204:\te8 60 ff ff ff       \tcallq  1169 <foo>\n    1209:\t48 83 c4 08          \tadd    $0x8,%rsp\n    120d:\tc3                   \tretq   \n    120e:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    1213:\te8 6a ff ff ff       \tcallq  1182 <foo1>\n    1218:\teb ef                \tjmp    1209 <normal+0x16>\n\n00000000000011ee <doUnlikelyNocall>:\n    11ee:\tf3 0f 1e fa          \tendbr64 \n    11f2:\tc3                   \tretq   \n```\n\n观察-O1优化后的汇编代码，代码风格有了质的飞越。去除了公式化的参数传递，费劲的值比较。但是依然没有体现出_builtin_expect有没有的区别。\n同样的，我们的非调用版本由于无返回值，已经被编译器完全优化掉了。\n\n我们再看看-O2。\n\n``` x86asm\n0000000000001210 <doLikely>:\n    1210:\tf3 0f 1e fa          \tendbr64 \n    1214:\t85 ff                \ttest   %edi,%edi\n    1216:\t74 10                \tje     1228 <doLikely+0x18>\n    1218:\t48 8d 3d e5 0d 00 00 \tlea    0xde5(%rip),%rdi        # 2004 <_IO_stdin_used+0x4>\n    121f:\te9 3c fe ff ff       \tjmpq   1060 <puts@plt>\n    1224:\t0f 1f 40 00          \tnopl   0x0(%rax)\n    1228:\t48 8d 3d d9 0d 00 00 \tlea    0xdd9(%rip),%rdi        # 2008 <_IO_stdin_used+0x8>\n    122f:\te9 2c fe ff ff       \tjmpq   1060 <puts@plt>\n    1234:\t66 66 2e 0f 1f 84 00 \tdata16 nopw %cs:0x0(%rax,%rax,1)\n    123b:\t00 00 00 00 \n    123f:\t90                   \tnop\n\n0000000000001290 <normal>:\n    1290:\tf3 0f 1e fa          \tendbr64 \n    1294:\t85 ff                \ttest   %edi,%edi\n    1296:\t74 10                \tje     12a8 <normal+0x18>\n    1298:\t48 8d 3d 65 0d 00 00 \tlea    0xd65(%rip),%rdi        # 2004 <_IO_stdin_used+0x4>\n    129f:\te9 bc fd ff ff       \tjmpq   1060 <puts@plt>\n    12a4:\t0f 1f 40 00          \tnopl   0x0(%rax)\n    12a8:\t48 8d 3d 59 0d 00 00 \tlea    0xd59(%rip),%rdi        # 2008 <_IO_stdin_used+0x8>\n    12af:\te9 ac fd ff ff       \tjmpq   1060 <puts@plt>\n    12b4:\t66 66 2e 0f 1f 84 00 \tdata16 nopw %cs:0x0(%rax,%rax,1)\n    12bb:\t00 00 00 00 \n    12bf:\t90                   \tnop\n```\n\n代码进一步的被优化，从汇编代码中可以看出，方法调用完全优化掉了栈上调用。去除了栈上传递，将call指令变为了jmp指令，进一步减少了指令上的开销。\n但结果仍然没有改变，_builtin_expect依然没有发光发热。\n\n最后我们只能把希望寄托于-O3上看看了。\n\n``` x86asm\n0000000000001210 <doLikely>:\n    1210:\tf3 0f 1e fa          \tendbr64 \n    1214:\t85 ff                \ttest   %edi,%edi\n    1216:\t74 10                \tje     1228 <doLikely+0x18>\n    1218:\t48 8d 3d e5 0d 00 00 \tlea    0xde5(%rip),%rdi        # 2004 <_IO_stdin_used+0x4>\n    121f:\te9 3c fe ff ff       \tjmpq   1060 <puts@plt>\n    1224:\t0f 1f 40 00          \tnopl   0x0(%rax)\n    1228:\t48 8d 3d d9 0d 00 00 \tlea    0xdd9(%rip),%rdi        # 2008 <_IO_stdin_used+0x8>\n    122f:\te9 2c fe ff ff       \tjmpq   1060 <puts@plt>\n    1234:\t66 66 2e 0f 1f 84 00 \tdata16 nopw %cs:0x0(%rax,%rax,1)\n    123b:\t00 00 00 00 \n    123f:\t90                   \tnop\n\n0000000000001290 <normal>:\n    1290:\tf3 0f 1e fa          \tendbr64 \n    1294:\t85 ff                \ttest   %edi,%edi\n    1296:\t74 10                \tje     12a8 <normal+0x18>\n    1298:\t48 8d 3d 65 0d 00 00 \tlea    0xd65(%rip),%rdi        # 2004 <_IO_stdin_used+0x4>\n    129f:\te9 bc fd ff ff       \tjmpq   1060 <puts@plt>\n    12a4:\t0f 1f 40 00          \tnopl   0x0(%rax)\n    12a8:\t48 8d 3d 59 0d 00 00 \tlea    0xd59(%rip),%rdi        # 2008 <_IO_stdin_used+0x8>\n    12af:\te9 ac fd ff ff       \tjmpq   1060 <puts@plt>\n    12b4:\t66 66 2e 0f 1f 84 00 \tdata16 nopw %cs:0x0(%rax,%rax,1)\n    12bb:\t00 00 00 00 \n    12bf:\t90                   \tnop\n```\n\n可见，O3已经没有任何优化空间了，_builtin_expect的存在感也已然是0。\n\n这次的实验是否失败呢，结果上看起来的确如此。但是我们并没有尝试更多的平台，同时各个平台的版本或GCC的版本都可能对编译的结果造成不同的影响。\n_builtin_expect到底有没有用？我能确信的是，再更加激进的优化等级下，_builtin_expect的存在感必然是稀薄的。但是GCC在遇到_builtin_expect时具体做了些什么，希望某一天阅读完GCC相关的源码后找到一个满意的答案吧！~\n","source":"_posts/分支预测-GCC-builtin-expect.md","raw":"---\ntitle: 分支预测 GCC __builtin_expect 有用吗？\ndate: 2020-12-14 22:57:18\ntags: \n    - C\n    - GCC\n    - 代码优化\ncategories :\n    - Technology\n---\n\n我们日常编写的代码中常见的分支语句，解释行语言能够根据代码运行期间收集分支的跳转的趋势动态优化分支跳转。而编译言语由于编译后直接生成可执行文件，因此很难在编译期推断出最好的优化条件。GCC为开发者提供了手动优化分支预测的方法__builtin_expect，通过显示编程向编译器提供优化建议从而优化分支的走向。\n<!-- more -->\n编译器是如何处理分支条件的？使用__builtin_expect的分支是如何得到优化的？使用GCC默认的优化级别会有什么不同？\n\n为了解开这些疑惑，我们直接上代码。\n\n* 平台 Ubuntu 20.04.1 LTS\n* 内核 Linux b13a1870ebc6 5.4.39-linuxkit #1 SMP Fri May 8 23:03:06 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\n* 编译工具 gcc (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0\n\n``` C\n#include <stdio.h>\n#include <stdlib.h>\n\n//x很可能为true\n#define likely(x) __builtin_expect(!!(x), 1)  \n//x很可能为false\n#define unlikely(x) __builtin_expect(!!(x), 0)\n\nvoid foo(){\n    printf(\"foo\\n\");\n}\nvoid foo1(){\n    printf(\"foo1\\n\");\n}\n\nvoid doLikely(int a){\n    \n    if(likely(a)){\n        foo();    \n    }else {\n        foo1();\n    }\n}\n\nvoid doLikelyNocall(int a){\n    int x;\n    if(likely(a)){\n        x = a*a;\n    }else {\n        x = a+a;\n    }\n}\n\nvoid doUnlikely(int a){\n    \n    if(unlikely(a)){\n        foo();\n    }else {\n        foo1();\n    }\n}\n\nvoid doUnlikelyNocall(int a){\n    int x;\n    if(unlikely(a)){\n        x = a*a;\n    }else {\n        x = a+a;\n    }\n}\n\nvoid normal(int a){\n    \n    if(a){\n        foo();\n    }else {\n        foo1();\n    }\n}\n\nvoid normalNocall(int a){\n    int x;\n    if(a){\n        x = a*a;\n    }else {\n        x = a+a;\n    }\n}\n\n\nint main(int argc, char **argv){\n    //为了排除常量导致编译器的优化，这里使用不定参数作为入参，防止编译器优化相关代码\n    int a = atoi(argv[1]);\n    doLikely(a);\n    doUnlikely(a);\n    normal(a);\n    doLikelyNocall(a);\n    doUnlikelyNocall(a);\n    normalNocall(a);\n    return 0;\n}\n```\n\n开始编辑，这里显示的指定-O0 -O1 -O2 -O3这四个优化等级。\n``` bash\nroot@b13a1870ebc6:/workspace_c/builtin_expect# gcc -O0 -o test_0 builtin_expect.c\nroot@b13a1870ebc6:/workspace_c/builtin_expect# gcc -O1 -o test_1 builtin_expect.c\nroot@b13a1870ebc6:/workspace_c/builtin_expect# gcc -O2 -o test_2 builtin_expect.c\nroot@b13a1870ebc6:/workspace_c/builtin_expect# gcc -O3 -o test_3 builtin_expect.c\n```\n\n将编译后的目标文件反汇编\n``` bash\nroot@b13a1870ebc6:/workspace_c/builtin_expect# objdump -d test_0 >test_0.a\nroot@b13a1870ebc6:/workspace_c/builtin_expect# objdump -d test_1 >test_1.a\nroot@b13a1870ebc6:/workspace_c/builtin_expect# objdump -d test_2 >test_2.a\nroot@b13a1870ebc6:/workspace_c/builtin_expect# objdump -d test_3 >test_3.a\n```\n\n最终我们得到了4个优化等级不同的汇编代码，并依次对比相关逻辑。\n\n1.-O0等级下，编译器默认不执行任何优化，我们对比原始分支代码和经过__builtin_expect优化后的代码在汇编码上有何区别。\n\n``` x86asm\n0000000000001197 <doLikely>:\n    1197:\tf3 0f 1e fa          \tendbr64 \n    119b:\t55                   \tpush   %rbp\n    119c:\t48 89 e5             \tmov    %rsp,%rbp\n    119f:\t48 83 ec 10          \tsub    $0x10,%rsp\n    11a3:\t89 7d fc             \tmov    %edi,-0x4(%rbp)      #参数a存放至-0x4(%rbp)处\n    11a6:\t83 7d fc 00          \tcmpl   $0x0,-0x4(%rbp)      #参数a和0比较\n    11aa:\t0f 95 c0             \tsetne  %al                  #条件设置，al中保存~ZF。if a = 1 then al = 1 ; if a = 0 then al = 0\n    11ad:\t0f b6 c0             \tmovzbl %al,%eax             #eax = 0000000000000000 -> 00000000000000000000000000000000 or 0000000000000001 -> 00000000000000000000000000000001\n    11b0:\t48 85 c0             \ttest   %rax,%rax            #判断eax是否为0\n    11b3:\t74 0c                \tje     11c1 <doLikely+0x2a> #eax = 0(a = 0)时，跳转至11c1，call foo1\n    11b5:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    11ba:\te8 aa ff ff ff       \tcallq  1169 <foo>           #eax!=0(a = 0)时，call foo\n    11bf:\teb 0a                \tjmp    11cb <doLikely+0x34> #跳转至11cb，结束\n    11c1:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    11c6:\te8 b5 ff ff ff       \tcallq  1180 <foo1>\n    11cb:\t90                   \tnop\n    11cc:\tc9                   \tleaveq \n    11cd:\tc3                   \tretq   \n\n\n0000000000001265 <normal>:\n    1265:\tf3 0f 1e fa          \tendbr64 \n    1269:\t55                   \tpush   %rbp\n    126a:\t48 89 e5             \tmov    %rsp,%rbp\n    126d:\t48 83 ec 10          \tsub    $0x10,%rsp\n    1271:\t89 7d fc             \tmov    %edi,-0x4(%rbp)      #参数a存放至-0x4(%rbp)处\n    1274:\t83 7d fc 00          \tcmpl   $0x0,-0x4(%rbp)      #参数a和0比较\n    1278:\t74 0c                \tje     1286 <normal+0x21>   #如果a=0，则跳转至1286，执行foo1\n    127a:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    127f:\te8 e5 fe ff ff       \tcallq  1169 <foo>           #如果a!=0,则执行foo\n    1284:\teb 0a                \tjmp    1290 <normal+0x2b>   #跳转至1290，结束\n    1286:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    128b:\te8 f0 fe ff ff       \tcallq  1180 <foo1>\n    1290:\t90                   \tnop\n    1291:\tc9                   \tleaveq \n    1292:\tc3                   \tretq   \n```\n\n通过对比，结果令人惊讶。虽然执行结果一直，但是没有经过_builtin_expect优化的分支判断，反而比标识_builtin_expect的汇编代码更加简洁。\n\n分析Unlikely的汇编代码，也存在同样的问题，编译器貌似会多此一举增加一步的判断\n``` x86asm\n00000000000011fe <doUnlikely>:\n    11fe:\tf3 0f 1e fa          \tendbr64 \n    1202:\t55                   \tpush   %rbp\n    1203:\t48 89 e5             \tmov    %rsp,%rbp\n    1206:\t48 83 ec 10          \tsub    $0x10,%rsp\n    120a:\t89 7d fc             \tmov    %edi,-0x4(%rbp)\n    120d:\t83 7d fc 00          \tcmpl   $0x0,-0x4(%rbp)\n    1211:\t0f 95 c0             \tsetne  %al\n    1214:\t0f b6 c0             \tmovzbl %al,%eax\n    1217:\t48 85 c0             \ttest   %rax,%rax\n    121a:\t74 0c                \tje     1228 <doUnlikely+0x2a>\n    121c:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    1221:\te8 43 ff ff ff       \tcallq  1169 <foo>\n    1226:\teb 0a                \tjmp    1232 <doUnlikely+0x34>\n    1228:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    122d:\te8 4e ff ff ff       \tcallq  1180 <foo1>\n    1232:\t90                   \tnop\n    1233:\tc9                   \tleaveq \n    1234:\tc3                   \tretq   \n```\n\n此外，我们也写了个非内部调用的版本，结果也是同样。编译器没有对_builtin_expect做出不一样的优化。\n\n``` x86asm\n00000000000011ce <doLikelyNocall>:\n    11ce:\tf3 0f 1e fa          \tendbr64 \n    11d2:\t55                   \tpush   %rbp\n    11d3:\t48 89 e5             \tmov    %rsp,%rbp\n    11d6:\t89 7d ec             \tmov    %edi,-0x14(%rbp)\n    11d9:\t83 7d ec 00          \tcmpl   $0x0,-0x14(%rbp)\n    11dd:\t0f 95 c0             \tsetne  %al\n    11e0:\t0f b6 c0             \tmovzbl %al,%eax\n    11e3:\t48 85 c0             \ttest   %rax,%rax\n    11e6:\t74 0b                \tje     11f3 <doLikelyNocall+0x25>\n    11e8:\t8b 45 ec             \tmov    -0x14(%rbp),%eax\n    11eb:\t0f af c0             \timul   %eax,%eax\n    11ee:\t89 45 fc             \tmov    %eax,-0x4(%rbp)\n    11f1:\teb 08                \tjmp    11fb <doLikelyNocall+0x2d>\n    11f3:\t8b 45 ec             \tmov    -0x14(%rbp),%eax\n    11f6:\t01 c0                \tadd    %eax,%eax\n    11f8:\t89 45 fc             \tmov    %eax,-0x4(%rbp)\n    11fb:\t90                   \tnop\n    11fc:\t5d                   \tpop    %rbp\n    11fd:\tc3                   \tretq   \n```\n\n2.为了了解_builtin_expect是否真的有用，我们再看看其他优化等级 -O1。\n\n``` x86asm\n000000000000119b <doLikely>:\n    119b:\tf3 0f 1e fa          \tendbr64 \n    119f:\t48 83 ec 08          \tsub    $0x8,%rsp\n    11a3:\t85 ff                \ttest   %edi,%edi\n    11a5:\t74 0f                \tje     11b6 <doLikely+0x1b>\n    11a7:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    11ac:\te8 b8 ff ff ff       \tcallq  1169 <foo>\n    11b1:\t48 83 c4 08          \tadd    $0x8,%rsp\n    11b5:\tc3                   \tretq   \n    11b6:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    11bb:\te8 c2 ff ff ff       \tcallq  1182 <foo1>\n    11c0:\teb ef                \tjmp    11b1 <doLikely+0x16>\n\n00000000000011f3 <normal>:\n    11f3:\tf3 0f 1e fa          \tendbr64 \n    11f7:\t48 83 ec 08          \tsub    $0x8,%rsp\n    11fb:\t85 ff                \ttest   %edi,%edi\n    11fd:\t74 0f                \tje     120e <normal+0x1b>\n    11ff:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    1204:\te8 60 ff ff ff       \tcallq  1169 <foo>\n    1209:\t48 83 c4 08          \tadd    $0x8,%rsp\n    120d:\tc3                   \tretq   \n    120e:\tb8 00 00 00 00       \tmov    $0x0,%eax\n    1213:\te8 6a ff ff ff       \tcallq  1182 <foo1>\n    1218:\teb ef                \tjmp    1209 <normal+0x16>\n\n00000000000011ee <doUnlikelyNocall>:\n    11ee:\tf3 0f 1e fa          \tendbr64 \n    11f2:\tc3                   \tretq   \n```\n\n观察-O1优化后的汇编代码，代码风格有了质的飞越。去除了公式化的参数传递，费劲的值比较。但是依然没有体现出_builtin_expect有没有的区别。\n同样的，我们的非调用版本由于无返回值，已经被编译器完全优化掉了。\n\n我们再看看-O2。\n\n``` x86asm\n0000000000001210 <doLikely>:\n    1210:\tf3 0f 1e fa          \tendbr64 \n    1214:\t85 ff                \ttest   %edi,%edi\n    1216:\t74 10                \tje     1228 <doLikely+0x18>\n    1218:\t48 8d 3d e5 0d 00 00 \tlea    0xde5(%rip),%rdi        # 2004 <_IO_stdin_used+0x4>\n    121f:\te9 3c fe ff ff       \tjmpq   1060 <puts@plt>\n    1224:\t0f 1f 40 00          \tnopl   0x0(%rax)\n    1228:\t48 8d 3d d9 0d 00 00 \tlea    0xdd9(%rip),%rdi        # 2008 <_IO_stdin_used+0x8>\n    122f:\te9 2c fe ff ff       \tjmpq   1060 <puts@plt>\n    1234:\t66 66 2e 0f 1f 84 00 \tdata16 nopw %cs:0x0(%rax,%rax,1)\n    123b:\t00 00 00 00 \n    123f:\t90                   \tnop\n\n0000000000001290 <normal>:\n    1290:\tf3 0f 1e fa          \tendbr64 \n    1294:\t85 ff                \ttest   %edi,%edi\n    1296:\t74 10                \tje     12a8 <normal+0x18>\n    1298:\t48 8d 3d 65 0d 00 00 \tlea    0xd65(%rip),%rdi        # 2004 <_IO_stdin_used+0x4>\n    129f:\te9 bc fd ff ff       \tjmpq   1060 <puts@plt>\n    12a4:\t0f 1f 40 00          \tnopl   0x0(%rax)\n    12a8:\t48 8d 3d 59 0d 00 00 \tlea    0xd59(%rip),%rdi        # 2008 <_IO_stdin_used+0x8>\n    12af:\te9 ac fd ff ff       \tjmpq   1060 <puts@plt>\n    12b4:\t66 66 2e 0f 1f 84 00 \tdata16 nopw %cs:0x0(%rax,%rax,1)\n    12bb:\t00 00 00 00 \n    12bf:\t90                   \tnop\n```\n\n代码进一步的被优化，从汇编代码中可以看出，方法调用完全优化掉了栈上调用。去除了栈上传递，将call指令变为了jmp指令，进一步减少了指令上的开销。\n但结果仍然没有改变，_builtin_expect依然没有发光发热。\n\n最后我们只能把希望寄托于-O3上看看了。\n\n``` x86asm\n0000000000001210 <doLikely>:\n    1210:\tf3 0f 1e fa          \tendbr64 \n    1214:\t85 ff                \ttest   %edi,%edi\n    1216:\t74 10                \tje     1228 <doLikely+0x18>\n    1218:\t48 8d 3d e5 0d 00 00 \tlea    0xde5(%rip),%rdi        # 2004 <_IO_stdin_used+0x4>\n    121f:\te9 3c fe ff ff       \tjmpq   1060 <puts@plt>\n    1224:\t0f 1f 40 00          \tnopl   0x0(%rax)\n    1228:\t48 8d 3d d9 0d 00 00 \tlea    0xdd9(%rip),%rdi        # 2008 <_IO_stdin_used+0x8>\n    122f:\te9 2c fe ff ff       \tjmpq   1060 <puts@plt>\n    1234:\t66 66 2e 0f 1f 84 00 \tdata16 nopw %cs:0x0(%rax,%rax,1)\n    123b:\t00 00 00 00 \n    123f:\t90                   \tnop\n\n0000000000001290 <normal>:\n    1290:\tf3 0f 1e fa          \tendbr64 \n    1294:\t85 ff                \ttest   %edi,%edi\n    1296:\t74 10                \tje     12a8 <normal+0x18>\n    1298:\t48 8d 3d 65 0d 00 00 \tlea    0xd65(%rip),%rdi        # 2004 <_IO_stdin_used+0x4>\n    129f:\te9 bc fd ff ff       \tjmpq   1060 <puts@plt>\n    12a4:\t0f 1f 40 00          \tnopl   0x0(%rax)\n    12a8:\t48 8d 3d 59 0d 00 00 \tlea    0xd59(%rip),%rdi        # 2008 <_IO_stdin_used+0x8>\n    12af:\te9 ac fd ff ff       \tjmpq   1060 <puts@plt>\n    12b4:\t66 66 2e 0f 1f 84 00 \tdata16 nopw %cs:0x0(%rax,%rax,1)\n    12bb:\t00 00 00 00 \n    12bf:\t90                   \tnop\n```\n\n可见，O3已经没有任何优化空间了，_builtin_expect的存在感也已然是0。\n\n这次的实验是否失败呢，结果上看起来的确如此。但是我们并没有尝试更多的平台，同时各个平台的版本或GCC的版本都可能对编译的结果造成不同的影响。\n_builtin_expect到底有没有用？我能确信的是，再更加激进的优化等级下，_builtin_expect的存在感必然是稀薄的。但是GCC在遇到_builtin_expect时具体做了些什么，希望某一天阅读完GCC相关的源码后找到一个满意的答案吧！~\n","slug":"分支预测-GCC-builtin-expect","published":1,"updated":"2020-12-17T01:55:53.102Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htf000rv2524z0l9tfk","content":"<html><head></head><body><p>&#x6211;&#x4EEC;&#x65E5;&#x5E38;&#x7F16;&#x5199;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x5E38;&#x89C1;&#x7684;&#x5206;&#x652F;&#x8BED;&#x53E5;&#xFF0C;&#x89E3;&#x91CA;&#x884C;&#x8BED;&#x8A00;&#x80FD;&#x591F;&#x6839;&#x636E;&#x4EE3;&#x7801;&#x8FD0;&#x884C;&#x671F;&#x95F4;&#x6536;&#x96C6;&#x5206;&#x652F;&#x7684;&#x8DF3;&#x8F6C;&#x7684;&#x8D8B;&#x52BF;&#x52A8;&#x6001;&#x4F18;&#x5316;&#x5206;&#x652F;&#x8DF3;&#x8F6C;&#x3002;&#x800C;&#x7F16;&#x8BD1;&#x8A00;&#x8BED;&#x7531;&#x4E8E;&#x7F16;&#x8BD1;&#x540E;&#x76F4;&#x63A5;&#x751F;&#x6210;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#xFF0C;&#x56E0;&#x6B64;&#x5F88;&#x96BE;&#x5728;&#x7F16;&#x8BD1;&#x671F;&#x63A8;&#x65AD;&#x51FA;&#x6700;&#x597D;&#x7684;&#x4F18;&#x5316;&#x6761;&#x4EF6;&#x3002;GCC&#x4E3A;&#x5F00;&#x53D1;&#x8005;&#x63D0;&#x4F9B;&#x4E86;&#x624B;&#x52A8;&#x4F18;&#x5316;&#x5206;&#x652F;&#x9884;&#x6D4B;&#x7684;&#x65B9;&#x6CD5;__builtin_expect&#xFF0C;&#x901A;&#x8FC7;&#x663E;&#x793A;&#x7F16;&#x7A0B;&#x5411;&#x7F16;&#x8BD1;&#x5668;&#x63D0;&#x4F9B;&#x4F18;&#x5316;&#x5EFA;&#x8BAE;&#x4ECE;&#x800C;&#x4F18;&#x5316;&#x5206;&#x652F;&#x7684;&#x8D70;&#x5411;&#x3002;</p>\n<a id=\"more\"></a>\n<p>&#x7F16;&#x8BD1;&#x5668;&#x662F;&#x5982;&#x4F55;&#x5904;&#x7406;&#x5206;&#x652F;&#x6761;&#x4EF6;&#x7684;&#xFF1F;&#x4F7F;&#x7528;__builtin_expect&#x7684;&#x5206;&#x652F;&#x662F;&#x5982;&#x4F55;&#x5F97;&#x5230;&#x4F18;&#x5316;&#x7684;&#xFF1F;&#x4F7F;&#x7528;GCC&#x9ED8;&#x8BA4;&#x7684;&#x4F18;&#x5316;&#x7EA7;&#x522B;&#x4F1A;&#x6709;&#x4EC0;&#x4E48;&#x4E0D;&#x540C;&#xFF1F;</p>\n<p>&#x4E3A;&#x4E86;&#x89E3;&#x5F00;&#x8FD9;&#x4E9B;&#x7591;&#x60D1;&#xFF0C;&#x6211;&#x4EEC;&#x76F4;&#x63A5;&#x4E0A;&#x4EE3;&#x7801;&#x3002;</p>\n<ul>\n<li>&#x5E73;&#x53F0; Ubuntu 20.04.1 LTS</li>\n<li>&#x5185;&#x6838; Linux b13a1870ebc6 5.4.39-linuxkit #1 SMP Fri May 8 23:03:06 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</li>\n<li>&#x7F16;&#x8BD1;&#x5DE5;&#x5177; gcc (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0</li>\n</ul>\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">include</span> <span class=\"hljs-meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">include</span> <span class=\"hljs-meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//x&#x5F88;&#x53EF;&#x80FD;&#x4E3A;true</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> likely(x) __builtin_expect(!!(x), 1)  </span></span><br><span class=\"line\"><span class=\"hljs-comment\">//x&#x5F88;&#x53EF;&#x80FD;&#x4E3A;false</span></span><br><span class=\"line\"><span class=\"hljs-meta\">#<span class=\"hljs-meta-keyword\">define</span> unlikely(x) __builtin_expect(!!(x), 0)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">foo</span><span class=\"hljs-params\">()</span></span>{</span><br><span class=\"line\">    <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;foo\\n&quot;</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">foo1</span><span class=\"hljs-params\">()</span></span>{</span><br><span class=\"line\">    <span class=\"hljs-built_in\">printf</span>(<span class=\"hljs-string\">&quot;foo1\\n&quot;</span>);</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">doLikely</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">int</span> a)</span></span>{</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span>(likely(a)){</span><br><span class=\"line\">        foo();    </span><br><span class=\"line\">    }<span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        foo1();</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">doLikelyNocall</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">int</span> a)</span></span>{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">int</span> x;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span>(likely(a)){</span><br><span class=\"line\">        x = a*a;</span><br><span class=\"line\">    }<span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        x = a+a;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">doUnlikely</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">int</span> a)</span></span>{</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span>(unlikely(a)){</span><br><span class=\"line\">        foo();</span><br><span class=\"line\">    }<span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        foo1();</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">doUnlikelyNocall</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">int</span> a)</span></span>{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">int</span> x;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span>(unlikely(a)){</span><br><span class=\"line\">        x = a*a;</span><br><span class=\"line\">    }<span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        x = a+a;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">normal</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">int</span> a)</span></span>{</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span>(a){</span><br><span class=\"line\">        foo();</span><br><span class=\"line\">    }<span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        foo1();</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">normalNocall</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">int</span> a)</span></span>{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">int</span> x;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span>(a){</span><br><span class=\"line\">        x = a*a;</span><br><span class=\"line\">    }<span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        x = a+a;</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">int</span> argc, <span class=\"hljs-keyword\">char</span> **argv)</span></span>{</span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x4E3A;&#x4E86;&#x6392;&#x9664;&#x5E38;&#x91CF;&#x5BFC;&#x81F4;&#x7F16;&#x8BD1;&#x5668;&#x7684;&#x4F18;&#x5316;&#xFF0C;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E0D;&#x5B9A;&#x53C2;&#x6570;&#x4F5C;&#x4E3A;&#x5165;&#x53C2;&#xFF0C;&#x9632;&#x6B62;&#x7F16;&#x8BD1;&#x5668;&#x4F18;&#x5316;&#x76F8;&#x5173;&#x4EE3;&#x7801;</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">int</span> a = atoi(argv[<span class=\"hljs-number\">1</span>]);</span><br><span class=\"line\">    doLikely(a);</span><br><span class=\"line\">    doUnlikely(a);</span><br><span class=\"line\">    normal(a);</span><br><span class=\"line\">    doLikelyNocall(a);</span><br><span class=\"line\">    doUnlikelyNocall(a);</span><br><span class=\"line\">    normalNocall(a);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x5F00;&#x59CB;&#x7F16;&#x8F91;&#xFF0C;&#x8FD9;&#x91CC;&#x663E;&#x793A;&#x7684;&#x6307;&#x5B9A;-O0 -O1 -O2 -O3&#x8FD9;&#x56DB;&#x4E2A;&#x4F18;&#x5316;&#x7B49;&#x7EA7;&#x3002;</p>\n<figure class=\"highlight bash hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"hljs-comment\"># gcc -O0 -o test_0 builtin_expect.c</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"hljs-comment\"># gcc -O1 -o test_1 builtin_expect.c</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"hljs-comment\"># gcc -O2 -o test_2 builtin_expect.c</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"hljs-comment\"># gcc -O3 -o test_3 builtin_expect.c</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x5C06;&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x76EE;&#x6807;&#x6587;&#x4EF6;&#x53CD;&#x6C47;&#x7F16;</p>\n<figure class=\"highlight bash hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"hljs-comment\"># objdump -d test_0 &gt;test_0.a</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"hljs-comment\"># objdump -d test_1 &gt;test_1.a</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"hljs-comment\"># objdump -d test_2 &gt;test_2.a</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"hljs-comment\"># objdump -d test_3 &gt;test_3.a</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x6700;&#x7EC8;&#x6211;&#x4EEC;&#x5F97;&#x5230;&#x4E86;4&#x4E2A;&#x4F18;&#x5316;&#x7B49;&#x7EA7;&#x4E0D;&#x540C;&#x7684;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#xFF0C;&#x5E76;&#x4F9D;&#x6B21;&#x5BF9;&#x6BD4;&#x76F8;&#x5173;&#x903B;&#x8F91;&#x3002;</p>\n<p>1.-O0&#x7B49;&#x7EA7;&#x4E0B;&#xFF0C;&#x7F16;&#x8BD1;&#x5668;&#x9ED8;&#x8BA4;&#x4E0D;&#x6267;&#x884C;&#x4EFB;&#x4F55;&#x4F18;&#x5316;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9;&#x6BD4;&#x539F;&#x59CB;&#x5206;&#x652F;&#x4EE3;&#x7801;&#x548C;&#x7ECF;&#x8FC7;__builtin_expect&#x4F18;&#x5316;&#x540E;&#x7684;&#x4EE3;&#x7801;&#x5728;&#x6C47;&#x7F16;&#x7801;&#x4E0A;&#x6709;&#x4F55;&#x533A;&#x522B;&#x3002;</p>\n<figure class=\"highlight x86asm hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-number\">0000000000001197</span> &lt;doLikely&gt;:</span><br><span class=\"line\">    <span class=\"hljs-number\">1197</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    119b:\t<span class=\"hljs-number\">55</span>                   \t<span class=\"hljs-keyword\">push</span>   %rbp</span><br><span class=\"line\">    119c:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">89</span> e5             \t<span class=\"hljs-keyword\">mov</span>    %rsp,%rbp</span><br><span class=\"line\">    119f:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">83</span> ec <span class=\"hljs-number\">10</span>          \t<span class=\"hljs-keyword\">sub</span>    <span class=\"hljs-number\">$0</span>x10,%rsp</span><br><span class=\"line\">    11a3:\t<span class=\"hljs-number\">89</span> <span class=\"hljs-number\">7d</span> fc             \t<span class=\"hljs-keyword\">mov</span>    %edi,-<span class=\"hljs-number\">0x4</span>(%rbp)      #&#x53C2;&#x6570;a&#x5B58;&#x653E;&#x81F3;-<span class=\"hljs-number\">0x4</span>(%rbp)&#x5904;</span><br><span class=\"line\">    11a6:\t<span class=\"hljs-number\">83</span> <span class=\"hljs-number\">7d</span> fc <span class=\"hljs-number\">00</span>          \tcmpl   <span class=\"hljs-number\">$0</span>x0,-<span class=\"hljs-number\">0x4</span>(%rbp)      #&#x53C2;&#x6570;a&#x548C;<span class=\"hljs-number\">0</span>&#x6BD4;&#x8F83;</span><br><span class=\"line\">    11aa:\t0f <span class=\"hljs-number\">95</span> c0             \t<span class=\"hljs-keyword\">setne</span>  %al                  #&#x6761;&#x4EF6;&#x8BBE;&#x7F6E;&#xFF0C;<span class=\"hljs-built_in\">al</span>&#x4E2D;&#x4FDD;&#x5B58;~ZF&#x3002;if a = <span class=\"hljs-number\">1</span> then <span class=\"hljs-built_in\">al</span> = <span class=\"hljs-number\">1</span> <span class=\"hljs-comment\">; if a = 0 then al = 0</span></span><br><span class=\"line\">    11ad:\t0f b6 c0             \tmovzbl %al,%eax             #<span class=\"hljs-built_in\">eax</span> = <span class=\"hljs-number\">0000000000000000</span> -&gt; <span class=\"hljs-number\">00000000000000000000000000000000</span> <span class=\"hljs-keyword\">or</span> <span class=\"hljs-number\">0000000000000001</span> -&gt; <span class=\"hljs-number\">00000000000000000000000000000001</span></span><br><span class=\"line\">    11b0:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">85</span> c0             \t<span class=\"hljs-keyword\">test</span>   %rax,%rax            #&#x5224;&#x65AD;<span class=\"hljs-built_in\">eax</span>&#x662F;&#x5426;&#x4E3A;<span class=\"hljs-number\">0</span></span><br><span class=\"line\">    11b3:\t<span class=\"hljs-number\">74</span> 0c                \t<span class=\"hljs-keyword\">je</span>     11c1 &lt;doLikely+<span class=\"hljs-number\">0x2a</span>&gt; #<span class=\"hljs-built_in\">eax</span> = <span class=\"hljs-number\">0</span>(a = <span class=\"hljs-number\">0</span>)&#x65F6;&#xFF0C;&#x8DF3;&#x8F6C;&#x81F3;11c1&#xFF0C;<span class=\"hljs-keyword\">call</span> foo1</span><br><span class=\"line\">    11b5:\tb8 <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span>       \t<span class=\"hljs-keyword\">mov</span>    <span class=\"hljs-number\">$0</span>x0,%eax</span><br><span class=\"line\">    11ba:\te8 aa ff ff ff       \tcallq  <span class=\"hljs-number\">1169</span> &lt;foo&gt;           #<span class=\"hljs-built_in\">eax</span>!=<span class=\"hljs-number\">0</span>(a = <span class=\"hljs-number\">0</span>)&#x65F6;&#xFF0C;<span class=\"hljs-keyword\">call</span> foo</span><br><span class=\"line\">    11bf:\teb 0a                \t<span class=\"hljs-keyword\">jmp</span>    11cb &lt;doLikely+<span class=\"hljs-number\">0x34</span>&gt; #&#x8DF3;&#x8F6C;&#x81F3;11cb&#xFF0C;&#x7ED3;&#x675F;</span><br><span class=\"line\">    11c1:\tb8 <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span>       \t<span class=\"hljs-keyword\">mov</span>    <span class=\"hljs-number\">$0</span>x0,%eax</span><br><span class=\"line\">    11c6:\te8 b5 ff ff ff       \tcallq  <span class=\"hljs-number\">1180</span> &lt;foo1&gt;</span><br><span class=\"line\">    11cb:\t<span class=\"hljs-number\">90</span>                   \t<span class=\"hljs-keyword\">nop</span></span><br><span class=\"line\">    11cc:\tc9                   \tleaveq </span><br><span class=\"line\">    11cd:\tc3                   \tretq   </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-number\">0000000000001265</span> &lt;normal&gt;:</span><br><span class=\"line\">    <span class=\"hljs-number\">1265</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"hljs-number\">1269</span>:\t<span class=\"hljs-number\">55</span>                   \t<span class=\"hljs-keyword\">push</span>   %rbp</span><br><span class=\"line\">    126a:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">89</span> e5             \t<span class=\"hljs-keyword\">mov</span>    %rsp,%rbp</span><br><span class=\"line\">    <span class=\"hljs-number\">126d</span>:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">83</span> ec <span class=\"hljs-number\">10</span>          \t<span class=\"hljs-keyword\">sub</span>    <span class=\"hljs-number\">$0</span>x10,%rsp</span><br><span class=\"line\">    <span class=\"hljs-number\">1271</span>:\t<span class=\"hljs-number\">89</span> <span class=\"hljs-number\">7d</span> fc             \t<span class=\"hljs-keyword\">mov</span>    %edi,-<span class=\"hljs-number\">0x4</span>(%rbp)      #&#x53C2;&#x6570;a&#x5B58;&#x653E;&#x81F3;-<span class=\"hljs-number\">0x4</span>(%rbp)&#x5904;</span><br><span class=\"line\">    <span class=\"hljs-number\">1274</span>:\t<span class=\"hljs-number\">83</span> <span class=\"hljs-number\">7d</span> fc <span class=\"hljs-number\">00</span>          \tcmpl   <span class=\"hljs-number\">$0</span>x0,-<span class=\"hljs-number\">0x4</span>(%rbp)      #&#x53C2;&#x6570;a&#x548C;<span class=\"hljs-number\">0</span>&#x6BD4;&#x8F83;</span><br><span class=\"line\">    <span class=\"hljs-number\">1278</span>:\t<span class=\"hljs-number\">74</span> 0c                \t<span class=\"hljs-keyword\">je</span>     <span class=\"hljs-number\">1286</span> &lt;normal+<span class=\"hljs-number\">0x21</span>&gt;   #&#x5982;&#x679C;a=<span class=\"hljs-number\">0</span>&#xFF0C;&#x5219;&#x8DF3;&#x8F6C;&#x81F3;<span class=\"hljs-number\">1286</span>&#xFF0C;&#x6267;&#x884C;foo1</span><br><span class=\"line\">    127a:\tb8 <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span>       \t<span class=\"hljs-keyword\">mov</span>    <span class=\"hljs-number\">$0</span>x0,%eax</span><br><span class=\"line\">    127f:\te8 e5 fe ff ff       \tcallq  <span class=\"hljs-number\">1169</span> &lt;foo&gt;           #&#x5982;&#x679C;a!=<span class=\"hljs-number\">0</span>,&#x5219;&#x6267;&#x884C;foo</span><br><span class=\"line\">    <span class=\"hljs-number\">1284</span>:\teb 0a                \t<span class=\"hljs-keyword\">jmp</span>    <span class=\"hljs-number\">1290</span> &lt;normal+<span class=\"hljs-number\">0x2b</span>&gt;   #&#x8DF3;&#x8F6C;&#x81F3;<span class=\"hljs-number\">1290</span>&#xFF0C;&#x7ED3;&#x675F;</span><br><span class=\"line\">    <span class=\"hljs-number\">1286</span>:\tb8 <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span>       \t<span class=\"hljs-keyword\">mov</span>    <span class=\"hljs-number\">$0</span>x0,%eax</span><br><span class=\"line\">    128b:\te8 f0 fe ff ff       \tcallq  <span class=\"hljs-number\">1180</span> &lt;foo1&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1290</span>:\t<span class=\"hljs-number\">90</span>                   \t<span class=\"hljs-keyword\">nop</span></span><br><span class=\"line\">    <span class=\"hljs-number\">1291</span>:\tc9                   \tleaveq </span><br><span class=\"line\">    <span class=\"hljs-number\">1292</span>:\tc3                   \tretq   </span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x901A;&#x8FC7;&#x5BF9;&#x6BD4;&#xFF0C;&#x7ED3;&#x679C;&#x4EE4;&#x4EBA;&#x60CA;&#x8BB6;&#x3002;&#x867D;&#x7136;&#x6267;&#x884C;&#x7ED3;&#x679C;&#x4E00;&#x76F4;&#xFF0C;&#x4F46;&#x662F;&#x6CA1;&#x6709;&#x7ECF;&#x8FC7;_builtin_expect&#x4F18;&#x5316;&#x7684;&#x5206;&#x652F;&#x5224;&#x65AD;&#xFF0C;&#x53CD;&#x800C;&#x6BD4;&#x6807;&#x8BC6;_builtin_expect&#x7684;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#x66F4;&#x52A0;&#x7B80;&#x6D01;&#x3002;</p>\n<p>&#x5206;&#x6790;Unlikely&#x7684;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#xFF0C;&#x4E5F;&#x5B58;&#x5728;&#x540C;&#x6837;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x7F16;&#x8BD1;&#x5668;&#x8C8C;&#x4F3C;&#x4F1A;&#x591A;&#x6B64;&#x4E00;&#x4E3E;&#x589E;&#x52A0;&#x4E00;&#x6B65;&#x7684;&#x5224;&#x65AD;</p>\n<figure class=\"highlight x86asm hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00000000000011fe &lt;doUnlikely&gt;:</span><br><span class=\"line\">    11fe:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"hljs-number\">1202</span>:\t<span class=\"hljs-number\">55</span>                   \t<span class=\"hljs-keyword\">push</span>   %rbp</span><br><span class=\"line\">    <span class=\"hljs-number\">1203</span>:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">89</span> e5             \t<span class=\"hljs-keyword\">mov</span>    %rsp,%rbp</span><br><span class=\"line\">    <span class=\"hljs-number\">1206</span>:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">83</span> ec <span class=\"hljs-number\">10</span>          \t<span class=\"hljs-keyword\">sub</span>    <span class=\"hljs-number\">$0</span>x10,%rsp</span><br><span class=\"line\">    120a:\t<span class=\"hljs-number\">89</span> <span class=\"hljs-number\">7d</span> fc             \t<span class=\"hljs-keyword\">mov</span>    %edi,-<span class=\"hljs-number\">0x4</span>(%rbp)</span><br><span class=\"line\">    <span class=\"hljs-number\">120d</span>:\t<span class=\"hljs-number\">83</span> <span class=\"hljs-number\">7d</span> fc <span class=\"hljs-number\">00</span>          \tcmpl   <span class=\"hljs-number\">$0</span>x0,-<span class=\"hljs-number\">0x4</span>(%rbp)</span><br><span class=\"line\">    <span class=\"hljs-number\">1211</span>:\t0f <span class=\"hljs-number\">95</span> c0             \t<span class=\"hljs-keyword\">setne</span>  %al</span><br><span class=\"line\">    <span class=\"hljs-number\">1214</span>:\t0f b6 c0             \tmovzbl %al,%eax</span><br><span class=\"line\">    <span class=\"hljs-number\">1217</span>:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">85</span> c0             \t<span class=\"hljs-keyword\">test</span>   %rax,%rax</span><br><span class=\"line\">    121a:\t<span class=\"hljs-number\">74</span> 0c                \t<span class=\"hljs-keyword\">je</span>     <span class=\"hljs-number\">1228</span> &lt;doUnlikely+<span class=\"hljs-number\">0x2a</span>&gt;</span><br><span class=\"line\">    121c:\tb8 <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span>       \t<span class=\"hljs-keyword\">mov</span>    <span class=\"hljs-number\">$0</span>x0,%eax</span><br><span class=\"line\">    <span class=\"hljs-number\">1221</span>:\te8 <span class=\"hljs-number\">43</span> ff ff ff       \tcallq  <span class=\"hljs-number\">1169</span> &lt;foo&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1226</span>:\teb 0a                \t<span class=\"hljs-keyword\">jmp</span>    <span class=\"hljs-number\">1232</span> &lt;doUnlikely+<span class=\"hljs-number\">0x34</span>&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1228</span>:\tb8 <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span>       \t<span class=\"hljs-keyword\">mov</span>    <span class=\"hljs-number\">$0</span>x0,%eax</span><br><span class=\"line\">    <span class=\"hljs-number\">122d</span>:\te8 4e ff ff ff       \tcallq  <span class=\"hljs-number\">1180</span> &lt;foo1&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1232</span>:\t<span class=\"hljs-number\">90</span>                   \t<span class=\"hljs-keyword\">nop</span></span><br><span class=\"line\">    <span class=\"hljs-number\">1233</span>:\tc9                   \tleaveq </span><br><span class=\"line\">    <span class=\"hljs-number\">1234</span>:\tc3                   \tretq   </span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x6B64;&#x5916;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x5199;&#x4E86;&#x4E2A;&#x975E;&#x5185;&#x90E8;&#x8C03;&#x7528;&#x7684;&#x7248;&#x672C;&#xFF0C;&#x7ED3;&#x679C;&#x4E5F;&#x662F;&#x540C;&#x6837;&#x3002;&#x7F16;&#x8BD1;&#x5668;&#x6CA1;&#x6709;&#x5BF9;_builtin_expect&#x505A;&#x51FA;&#x4E0D;&#x4E00;&#x6837;&#x7684;&#x4F18;&#x5316;&#x3002;</p>\n<figure class=\"highlight x86asm hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00000000000011ce &lt;doLikelyNocall&gt;:</span><br><span class=\"line\">    11ce:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    11d2:\t<span class=\"hljs-number\">55</span>                   \t<span class=\"hljs-keyword\">push</span>   %rbp</span><br><span class=\"line\">    11d3:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">89</span> e5             \t<span class=\"hljs-keyword\">mov</span>    %rsp,%rbp</span><br><span class=\"line\">    11d6:\t<span class=\"hljs-number\">89</span> <span class=\"hljs-number\">7d</span> ec             \t<span class=\"hljs-keyword\">mov</span>    %edi,-<span class=\"hljs-number\">0x14</span>(%rbp)</span><br><span class=\"line\">    11d9:\t<span class=\"hljs-number\">83</span> <span class=\"hljs-number\">7d</span> ec <span class=\"hljs-number\">00</span>          \tcmpl   <span class=\"hljs-number\">$0</span>x0,-<span class=\"hljs-number\">0x14</span>(%rbp)</span><br><span class=\"line\">    11<span class=\"hljs-built_in\">dd</span>:\t0f <span class=\"hljs-number\">95</span> c0             \t<span class=\"hljs-keyword\">setne</span>  %al</span><br><span class=\"line\">    11e0:\t0f b6 c0             \tmovzbl %al,%eax</span><br><span class=\"line\">    11e3:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">85</span> c0             \t<span class=\"hljs-keyword\">test</span>   %rax,%rax</span><br><span class=\"line\">    11e6:\t<span class=\"hljs-number\">74</span> <span class=\"hljs-number\">0b</span>                \t<span class=\"hljs-keyword\">je</span>     11f3 &lt;doLikelyNocall+<span class=\"hljs-number\">0x25</span>&gt;</span><br><span class=\"line\">    11e8:\t8b <span class=\"hljs-number\">45</span> ec             \t<span class=\"hljs-keyword\">mov</span>    -<span class=\"hljs-number\">0x14</span>(%rbp),%eax</span><br><span class=\"line\">    11eb:\t0f af c0             \t<span class=\"hljs-keyword\">imul</span>   %eax,%eax</span><br><span class=\"line\">    11ee:\t<span class=\"hljs-number\">89</span> <span class=\"hljs-number\">45</span> fc             \t<span class=\"hljs-keyword\">mov</span>    %eax,-<span class=\"hljs-number\">0x4</span>(%rbp)</span><br><span class=\"line\">    11f1:\teb <span class=\"hljs-number\">08</span>                \t<span class=\"hljs-keyword\">jmp</span>    11fb &lt;doLikelyNocall+<span class=\"hljs-number\">0x2d</span>&gt;</span><br><span class=\"line\">    11f3:\t8b <span class=\"hljs-number\">45</span> ec             \t<span class=\"hljs-keyword\">mov</span>    -<span class=\"hljs-number\">0x14</span>(%rbp),%eax</span><br><span class=\"line\">    11f6:\t<span class=\"hljs-number\">01</span> c0                \t<span class=\"hljs-keyword\">add</span>    %eax,%eax</span><br><span class=\"line\">    11f8:\t<span class=\"hljs-number\">89</span> <span class=\"hljs-number\">45</span> fc             \t<span class=\"hljs-keyword\">mov</span>    %eax,-<span class=\"hljs-number\">0x4</span>(%rbp)</span><br><span class=\"line\">    11fb:\t<span class=\"hljs-number\">90</span>                   \t<span class=\"hljs-keyword\">nop</span></span><br><span class=\"line\">    11fc:\t<span class=\"hljs-number\">5d</span>                   \t<span class=\"hljs-keyword\">pop</span>    %rbp</span><br><span class=\"line\">    11fd:\tc3                   \tretq   </span><br></pre></td></tr></tbody></table></figure>\n\n<p>2.&#x4E3A;&#x4E86;&#x4E86;&#x89E3;_builtin_expect&#x662F;&#x5426;&#x771F;&#x7684;&#x6709;&#x7528;&#xFF0C;&#x6211;&#x4EEC;&#x518D;&#x770B;&#x770B;&#x5176;&#x4ED6;&#x4F18;&#x5316;&#x7B49;&#x7EA7; -O1&#x3002;</p>\n<figure class=\"highlight x86asm hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">000000000000119b &lt;doLikely&gt;:</span><br><span class=\"line\">    119b:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    119f:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">83</span> ec <span class=\"hljs-number\">08</span>          \t<span class=\"hljs-keyword\">sub</span>    <span class=\"hljs-number\">$0</span>x8,%rsp</span><br><span class=\"line\">    11a3:\t<span class=\"hljs-number\">85</span> ff                \t<span class=\"hljs-keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    11a5:\t<span class=\"hljs-number\">74</span> 0f                \t<span class=\"hljs-keyword\">je</span>     11b6 &lt;doLikely+<span class=\"hljs-number\">0x1b</span>&gt;</span><br><span class=\"line\">    11a7:\tb8 <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span>       \t<span class=\"hljs-keyword\">mov</span>    <span class=\"hljs-number\">$0</span>x0,%eax</span><br><span class=\"line\">    11ac:\te8 b8 ff ff ff       \tcallq  <span class=\"hljs-number\">1169</span> &lt;foo&gt;</span><br><span class=\"line\">    11b1:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">83</span> c4 <span class=\"hljs-number\">08</span>          \t<span class=\"hljs-keyword\">add</span>    <span class=\"hljs-number\">$0</span>x8,%rsp</span><br><span class=\"line\">    11b5:\tc3                   \tretq   </span><br><span class=\"line\">    11b6:\tb8 <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span>       \t<span class=\"hljs-keyword\">mov</span>    <span class=\"hljs-number\">$0</span>x0,%eax</span><br><span class=\"line\">    11bb:\te8 c2 ff ff ff       \tcallq  <span class=\"hljs-number\">1182</span> &lt;foo1&gt;</span><br><span class=\"line\">    11c0:\teb ef                \t<span class=\"hljs-keyword\">jmp</span>    11b1 &lt;doLikely+<span class=\"hljs-number\">0x16</span>&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">00000000000011f3 &lt;normal&gt;:</span><br><span class=\"line\">    11f3:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    11f7:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">83</span> ec <span class=\"hljs-number\">08</span>          \t<span class=\"hljs-keyword\">sub</span>    <span class=\"hljs-number\">$0</span>x8,%rsp</span><br><span class=\"line\">    11fb:\t<span class=\"hljs-number\">85</span> ff                \t<span class=\"hljs-keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    11fd:\t<span class=\"hljs-number\">74</span> 0f                \t<span class=\"hljs-keyword\">je</span>     120e &lt;normal+<span class=\"hljs-number\">0x1b</span>&gt;</span><br><span class=\"line\">    11ff:\tb8 <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span>       \t<span class=\"hljs-keyword\">mov</span>    <span class=\"hljs-number\">$0</span>x0,%eax</span><br><span class=\"line\">    <span class=\"hljs-number\">1204</span>:\te8 <span class=\"hljs-number\">60</span> ff ff ff       \tcallq  <span class=\"hljs-number\">1169</span> &lt;foo&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1209</span>:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">83</span> c4 <span class=\"hljs-number\">08</span>          \t<span class=\"hljs-keyword\">add</span>    <span class=\"hljs-number\">$0</span>x8,%rsp</span><br><span class=\"line\">    <span class=\"hljs-number\">120d</span>:\tc3                   \tretq   </span><br><span class=\"line\">    120e:\tb8 <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span>       \t<span class=\"hljs-keyword\">mov</span>    <span class=\"hljs-number\">$0</span>x0,%eax</span><br><span class=\"line\">    <span class=\"hljs-number\">1213</span>:\te8 6a ff ff ff       \tcallq  <span class=\"hljs-number\">1182</span> &lt;foo1&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1218</span>:\teb ef                \t<span class=\"hljs-keyword\">jmp</span>    <span class=\"hljs-number\">1209</span> &lt;normal+<span class=\"hljs-number\">0x16</span>&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">00000000000011ee &lt;doUnlikelyNocall&gt;:</span><br><span class=\"line\">    11ee:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    11f2:\tc3                   \tretq   </span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x89C2;&#x5BDF;-O1&#x4F18;&#x5316;&#x540E;&#x7684;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#xFF0C;&#x4EE3;&#x7801;&#x98CE;&#x683C;&#x6709;&#x4E86;&#x8D28;&#x7684;&#x98DE;&#x8D8A;&#x3002;&#x53BB;&#x9664;&#x4E86;&#x516C;&#x5F0F;&#x5316;&#x7684;&#x53C2;&#x6570;&#x4F20;&#x9012;&#xFF0C;&#x8D39;&#x52B2;&#x7684;&#x503C;&#x6BD4;&#x8F83;&#x3002;&#x4F46;&#x662F;&#x4F9D;&#x7136;&#x6CA1;&#x6709;&#x4F53;&#x73B0;&#x51FA;_builtin_expect&#x6709;&#x6CA1;&#x6709;&#x7684;&#x533A;&#x522B;&#x3002;<br>&#x540C;&#x6837;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x7684;&#x975E;&#x8C03;&#x7528;&#x7248;&#x672C;&#x7531;&#x4E8E;&#x65E0;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x5DF2;&#x7ECF;&#x88AB;&#x7F16;&#x8BD1;&#x5668;&#x5B8C;&#x5168;&#x4F18;&#x5316;&#x6389;&#x4E86;&#x3002;</p>\n<p>&#x6211;&#x4EEC;&#x518D;&#x770B;&#x770B;-O2&#x3002;</p>\n<figure class=\"highlight x86asm hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-number\">0000000000001210</span> &lt;doLikely&gt;:</span><br><span class=\"line\">    <span class=\"hljs-number\">1210</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"hljs-number\">1214</span>:\t<span class=\"hljs-number\">85</span> ff                \t<span class=\"hljs-keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    <span class=\"hljs-number\">1216</span>:\t<span class=\"hljs-number\">74</span> <span class=\"hljs-number\">10</span>                \t<span class=\"hljs-keyword\">je</span>     <span class=\"hljs-number\">1228</span> &lt;doLikely+<span class=\"hljs-number\">0x18</span>&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1218</span>:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">8d</span> <span class=\"hljs-number\">3d</span> e5 <span class=\"hljs-number\">0d</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> \t<span class=\"hljs-keyword\">lea</span>    <span class=\"hljs-number\">0xde5</span>(%rip),%rdi        # <span class=\"hljs-number\">2004</span> &lt;_IO_stdin_used+<span class=\"hljs-number\">0x4</span>&gt;</span><br><span class=\"line\">    121f:\te9 3c fe ff ff       \tjmpq   <span class=\"hljs-number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1224</span>:\t0f 1f <span class=\"hljs-number\">40</span> <span class=\"hljs-number\">00</span>          \tnopl   <span class=\"hljs-number\">0x0</span>(%rax)</span><br><span class=\"line\">    <span class=\"hljs-number\">1228</span>:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">8d</span> <span class=\"hljs-number\">3d</span> d9 <span class=\"hljs-number\">0d</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> \t<span class=\"hljs-keyword\">lea</span>    <span class=\"hljs-number\">0xdd9</span>(%rip),%rdi        # <span class=\"hljs-number\">2008</span> &lt;_IO_stdin_used+<span class=\"hljs-number\">0x8</span>&gt;</span><br><span class=\"line\">    122f:\te9 2c fe ff ff       \tjmpq   <span class=\"hljs-number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1234</span>:\t<span class=\"hljs-number\">66</span> <span class=\"hljs-number\">66</span> 2e 0f 1f <span class=\"hljs-number\">84</span> <span class=\"hljs-number\">00</span> \tdata16 nopw %cs:<span class=\"hljs-number\">0x0</span>(%rax,%rax,<span class=\"hljs-number\">1</span>)</span><br><span class=\"line\">    123b:\t<span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> </span><br><span class=\"line\">    123f:\t<span class=\"hljs-number\">90</span>                   \t<span class=\"hljs-keyword\">nop</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-number\">0000000000001290</span> &lt;normal&gt;:</span><br><span class=\"line\">    <span class=\"hljs-number\">1290</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"hljs-number\">1294</span>:\t<span class=\"hljs-number\">85</span> ff                \t<span class=\"hljs-keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    <span class=\"hljs-number\">1296</span>:\t<span class=\"hljs-number\">74</span> <span class=\"hljs-number\">10</span>                \t<span class=\"hljs-keyword\">je</span>     12a8 &lt;normal+<span class=\"hljs-number\">0x18</span>&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1298</span>:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">8d</span> <span class=\"hljs-number\">3d</span> <span class=\"hljs-number\">65</span> <span class=\"hljs-number\">0d</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> \t<span class=\"hljs-keyword\">lea</span>    <span class=\"hljs-number\">0xd65</span>(%rip),%rdi        # <span class=\"hljs-number\">2004</span> &lt;_IO_stdin_used+<span class=\"hljs-number\">0x4</span>&gt;</span><br><span class=\"line\">    129f:\te9 bc fd ff ff       \tjmpq   <span class=\"hljs-number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    12a4:\t0f 1f <span class=\"hljs-number\">40</span> <span class=\"hljs-number\">00</span>          \tnopl   <span class=\"hljs-number\">0x0</span>(%rax)</span><br><span class=\"line\">    12a8:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">8d</span> <span class=\"hljs-number\">3d</span> <span class=\"hljs-number\">59</span> <span class=\"hljs-number\">0d</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> \t<span class=\"hljs-keyword\">lea</span>    <span class=\"hljs-number\">0xd59</span>(%rip),%rdi        # <span class=\"hljs-number\">2008</span> &lt;_IO_stdin_used+<span class=\"hljs-number\">0x8</span>&gt;</span><br><span class=\"line\">    12af:\te9 ac fd ff ff       \tjmpq   <span class=\"hljs-number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    12b4:\t<span class=\"hljs-number\">66</span> <span class=\"hljs-number\">66</span> 2e 0f 1f <span class=\"hljs-number\">84</span> <span class=\"hljs-number\">00</span> \tdata16 nopw %cs:<span class=\"hljs-number\">0x0</span>(%rax,%rax,<span class=\"hljs-number\">1</span>)</span><br><span class=\"line\">    12bb:\t<span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> </span><br><span class=\"line\">    12bf:\t<span class=\"hljs-number\">90</span>                   \t<span class=\"hljs-keyword\">nop</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x4EE3;&#x7801;&#x8FDB;&#x4E00;&#x6B65;&#x7684;&#x88AB;&#x4F18;&#x5316;&#xFF0C;&#x4ECE;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#x4E2D;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#xFF0C;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x5B8C;&#x5168;&#x4F18;&#x5316;&#x6389;&#x4E86;&#x6808;&#x4E0A;&#x8C03;&#x7528;&#x3002;&#x53BB;&#x9664;&#x4E86;&#x6808;&#x4E0A;&#x4F20;&#x9012;&#xFF0C;&#x5C06;call&#x6307;&#x4EE4;&#x53D8;&#x4E3A;&#x4E86;jmp&#x6307;&#x4EE4;&#xFF0C;&#x8FDB;&#x4E00;&#x6B65;&#x51CF;&#x5C11;&#x4E86;&#x6307;&#x4EE4;&#x4E0A;&#x7684;&#x5F00;&#x9500;&#x3002;<br>&#x4F46;&#x7ED3;&#x679C;&#x4ECD;&#x7136;&#x6CA1;&#x6709;&#x6539;&#x53D8;&#xFF0C;_builtin_expect&#x4F9D;&#x7136;&#x6CA1;&#x6709;&#x53D1;&#x5149;&#x53D1;&#x70ED;&#x3002;</p>\n<p>&#x6700;&#x540E;&#x6211;&#x4EEC;&#x53EA;&#x80FD;&#x628A;&#x5E0C;&#x671B;&#x5BC4;&#x6258;&#x4E8E;-O3&#x4E0A;&#x770B;&#x770B;&#x4E86;&#x3002;</p>\n<figure class=\"highlight x86asm hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-number\">0000000000001210</span> &lt;doLikely&gt;:</span><br><span class=\"line\">    <span class=\"hljs-number\">1210</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"hljs-number\">1214</span>:\t<span class=\"hljs-number\">85</span> ff                \t<span class=\"hljs-keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    <span class=\"hljs-number\">1216</span>:\t<span class=\"hljs-number\">74</span> <span class=\"hljs-number\">10</span>                \t<span class=\"hljs-keyword\">je</span>     <span class=\"hljs-number\">1228</span> &lt;doLikely+<span class=\"hljs-number\">0x18</span>&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1218</span>:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">8d</span> <span class=\"hljs-number\">3d</span> e5 <span class=\"hljs-number\">0d</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> \t<span class=\"hljs-keyword\">lea</span>    <span class=\"hljs-number\">0xde5</span>(%rip),%rdi        # <span class=\"hljs-number\">2004</span> &lt;_IO_stdin_used+<span class=\"hljs-number\">0x4</span>&gt;</span><br><span class=\"line\">    121f:\te9 3c fe ff ff       \tjmpq   <span class=\"hljs-number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1224</span>:\t0f 1f <span class=\"hljs-number\">40</span> <span class=\"hljs-number\">00</span>          \tnopl   <span class=\"hljs-number\">0x0</span>(%rax)</span><br><span class=\"line\">    <span class=\"hljs-number\">1228</span>:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">8d</span> <span class=\"hljs-number\">3d</span> d9 <span class=\"hljs-number\">0d</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> \t<span class=\"hljs-keyword\">lea</span>    <span class=\"hljs-number\">0xdd9</span>(%rip),%rdi        # <span class=\"hljs-number\">2008</span> &lt;_IO_stdin_used+<span class=\"hljs-number\">0x8</span>&gt;</span><br><span class=\"line\">    122f:\te9 2c fe ff ff       \tjmpq   <span class=\"hljs-number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1234</span>:\t<span class=\"hljs-number\">66</span> <span class=\"hljs-number\">66</span> 2e 0f 1f <span class=\"hljs-number\">84</span> <span class=\"hljs-number\">00</span> \tdata16 nopw %cs:<span class=\"hljs-number\">0x0</span>(%rax,%rax,<span class=\"hljs-number\">1</span>)</span><br><span class=\"line\">    123b:\t<span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> </span><br><span class=\"line\">    123f:\t<span class=\"hljs-number\">90</span>                   \t<span class=\"hljs-keyword\">nop</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-number\">0000000000001290</span> &lt;normal&gt;:</span><br><span class=\"line\">    <span class=\"hljs-number\">1290</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"hljs-number\">1294</span>:\t<span class=\"hljs-number\">85</span> ff                \t<span class=\"hljs-keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    <span class=\"hljs-number\">1296</span>:\t<span class=\"hljs-number\">74</span> <span class=\"hljs-number\">10</span>                \t<span class=\"hljs-keyword\">je</span>     12a8 &lt;normal+<span class=\"hljs-number\">0x18</span>&gt;</span><br><span class=\"line\">    <span class=\"hljs-number\">1298</span>:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">8d</span> <span class=\"hljs-number\">3d</span> <span class=\"hljs-number\">65</span> <span class=\"hljs-number\">0d</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> \t<span class=\"hljs-keyword\">lea</span>    <span class=\"hljs-number\">0xd65</span>(%rip),%rdi        # <span class=\"hljs-number\">2004</span> &lt;_IO_stdin_used+<span class=\"hljs-number\">0x4</span>&gt;</span><br><span class=\"line\">    129f:\te9 bc fd ff ff       \tjmpq   <span class=\"hljs-number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    12a4:\t0f 1f <span class=\"hljs-number\">40</span> <span class=\"hljs-number\">00</span>          \tnopl   <span class=\"hljs-number\">0x0</span>(%rax)</span><br><span class=\"line\">    12a8:\t<span class=\"hljs-number\">48</span> <span class=\"hljs-number\">8d</span> <span class=\"hljs-number\">3d</span> <span class=\"hljs-number\">59</span> <span class=\"hljs-number\">0d</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> \t<span class=\"hljs-keyword\">lea</span>    <span class=\"hljs-number\">0xd59</span>(%rip),%rdi        # <span class=\"hljs-number\">2008</span> &lt;_IO_stdin_used+<span class=\"hljs-number\">0x8</span>&gt;</span><br><span class=\"line\">    12af:\te9 ac fd ff ff       \tjmpq   <span class=\"hljs-number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    12b4:\t<span class=\"hljs-number\">66</span> <span class=\"hljs-number\">66</span> 2e 0f 1f <span class=\"hljs-number\">84</span> <span class=\"hljs-number\">00</span> \tdata16 nopw %cs:<span class=\"hljs-number\">0x0</span>(%rax,%rax,<span class=\"hljs-number\">1</span>)</span><br><span class=\"line\">    12bb:\t<span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> <span class=\"hljs-number\">00</span> </span><br><span class=\"line\">    12bf:\t<span class=\"hljs-number\">90</span>                   \t<span class=\"hljs-keyword\">nop</span></span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x53EF;&#x89C1;&#xFF0C;O3&#x5DF2;&#x7ECF;&#x6CA1;&#x6709;&#x4EFB;&#x4F55;&#x4F18;&#x5316;&#x7A7A;&#x95F4;&#x4E86;&#xFF0C;_builtin_expect&#x7684;&#x5B58;&#x5728;&#x611F;&#x4E5F;&#x5DF2;&#x7136;&#x662F;0&#x3002;</p>\n<p>&#x8FD9;&#x6B21;&#x7684;&#x5B9E;&#x9A8C;&#x662F;&#x5426;&#x5931;&#x8D25;&#x5462;&#xFF0C;&#x7ED3;&#x679C;&#x4E0A;&#x770B;&#x8D77;&#x6765;&#x7684;&#x786E;&#x5982;&#x6B64;&#x3002;&#x4F46;&#x662F;&#x6211;&#x4EEC;&#x5E76;&#x6CA1;&#x6709;&#x5C1D;&#x8BD5;&#x66F4;&#x591A;&#x7684;&#x5E73;&#x53F0;&#xFF0C;&#x540C;&#x65F6;&#x5404;&#x4E2A;&#x5E73;&#x53F0;&#x7684;&#x7248;&#x672C;&#x6216;GCC&#x7684;&#x7248;&#x672C;&#x90FD;&#x53EF;&#x80FD;&#x5BF9;&#x7F16;&#x8BD1;&#x7684;&#x7ED3;&#x679C;&#x9020;&#x6210;&#x4E0D;&#x540C;&#x7684;&#x5F71;&#x54CD;&#x3002;<br>_builtin_expect&#x5230;&#x5E95;&#x6709;&#x6CA1;&#x6709;&#x7528;&#xFF1F;&#x6211;&#x80FD;&#x786E;&#x4FE1;&#x7684;&#x662F;&#xFF0C;&#x518D;&#x66F4;&#x52A0;&#x6FC0;&#x8FDB;&#x7684;&#x4F18;&#x5316;&#x7B49;&#x7EA7;&#x4E0B;&#xFF0C;_builtin_expect&#x7684;&#x5B58;&#x5728;&#x611F;&#x5FC5;&#x7136;&#x662F;&#x7A00;&#x8584;&#x7684;&#x3002;&#x4F46;&#x662F;GCC&#x5728;&#x9047;&#x5230;_builtin_expect&#x65F6;&#x5177;&#x4F53;&#x505A;&#x4E86;&#x4E9B;&#x4EC0;&#x4E48;&#xFF0C;&#x5E0C;&#x671B;&#x67D0;&#x4E00;&#x5929;&#x9605;&#x8BFB;&#x5B8C;GCC&#x76F8;&#x5173;&#x7684;&#x6E90;&#x7801;&#x540E;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#x6EE1;&#x610F;&#x7684;&#x7B54;&#x6848;&#x5427;&#xFF01;~</p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"C","path":"tags/C/"},{"name":"GCC","path":"tags/GCC/"},{"name":"代码优化","path":"tags/代码优化/"}],"excerpt":"<html><head></head><body><p>&#x6211;&#x4EEC;&#x65E5;&#x5E38;&#x7F16;&#x5199;&#x7684;&#x4EE3;&#x7801;&#x4E2D;&#x5E38;&#x89C1;&#x7684;&#x5206;&#x652F;&#x8BED;&#x53E5;&#xFF0C;&#x89E3;&#x91CA;&#x884C;&#x8BED;&#x8A00;&#x80FD;&#x591F;&#x6839;&#x636E;&#x4EE3;&#x7801;&#x8FD0;&#x884C;&#x671F;&#x95F4;&#x6536;&#x96C6;&#x5206;&#x652F;&#x7684;&#x8DF3;&#x8F6C;&#x7684;&#x8D8B;&#x52BF;&#x52A8;&#x6001;&#x4F18;&#x5316;&#x5206;&#x652F;&#x8DF3;&#x8F6C;&#x3002;&#x800C;&#x7F16;&#x8BD1;&#x8A00;&#x8BED;&#x7531;&#x4E8E;&#x7F16;&#x8BD1;&#x540E;&#x76F4;&#x63A5;&#x751F;&#x6210;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#xFF0C;&#x56E0;&#x6B64;&#x5F88;&#x96BE;&#x5728;&#x7F16;&#x8BD1;&#x671F;&#x63A8;&#x65AD;&#x51FA;&#x6700;&#x597D;&#x7684;&#x4F18;&#x5316;&#x6761;&#x4EF6;&#x3002;GCC&#x4E3A;&#x5F00;&#x53D1;&#x8005;&#x63D0;&#x4F9B;&#x4E86;&#x624B;&#x52A8;&#x4F18;&#x5316;&#x5206;&#x652F;&#x9884;&#x6D4B;&#x7684;&#x65B9;&#x6CD5;__builtin_expect&#xFF0C;&#x901A;&#x8FC7;&#x663E;&#x793A;&#x7F16;&#x7A0B;&#x5411;&#x7F16;&#x8BD1;&#x5668;&#x63D0;&#x4F9B;&#x4F18;&#x5316;&#x5EFA;&#x8BAE;&#x4ECE;&#x800C;&#x4F18;&#x5316;&#x5206;&#x652F;&#x7684;&#x8D70;&#x5411;&#x3002;</p></body></html>","more":"<p>编译器是如何处理分支条件的？使用__builtin_expect的分支是如何得到优化的？使用GCC默认的优化级别会有什么不同？</p>\n<p>为了解开这些疑惑，我们直接上代码。</p>\n<ul>\n<li>平台 Ubuntu 20.04.1 LTS</li>\n<li>内核 Linux b13a1870ebc6 5.4.39-linuxkit #1 SMP Fri May 8 23:03:06 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</li>\n<li>编译工具 gcc (Ubuntu 9.3.0-17ubuntu1~20.04) 9.3.0</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//x很可能为true</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> likely(x) __builtin_expect(!!(x), 1)  </span></span><br><span class=\"line\"><span class=\"comment\">//x很可能为false</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">define</span> unlikely(x) __builtin_expect(!!(x), 0)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">foo</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;foo\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">foo1</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">printf</span>(<span class=\"string\">&quot;foo1\\n&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">doLikely</span><span class=\"params\">(<span class=\"keyword\">int</span> a)</span></span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(likely(a))&#123;</span><br><span class=\"line\">        foo();    </span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        foo1();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">doLikelyNocall</span><span class=\"params\">(<span class=\"keyword\">int</span> a)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> x;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(likely(a))&#123;</span><br><span class=\"line\">        x = a*a;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        x = a+a;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">doUnlikely</span><span class=\"params\">(<span class=\"keyword\">int</span> a)</span></span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(unlikely(a))&#123;</span><br><span class=\"line\">        foo();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        foo1();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">doUnlikelyNocall</span><span class=\"params\">(<span class=\"keyword\">int</span> a)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> x;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(unlikely(a))&#123;</span><br><span class=\"line\">        x = a*a;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        x = a+a;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">normal</span><span class=\"params\">(<span class=\"keyword\">int</span> a)</span></span>&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(a)&#123;</span><br><span class=\"line\">        foo();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        foo1();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">normalNocall</span><span class=\"params\">(<span class=\"keyword\">int</span> a)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> x;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(a)&#123;</span><br><span class=\"line\">        x = a*a;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        x = a+a;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span> **argv)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//为了排除常量导致编译器的优化，这里使用不定参数作为入参，防止编译器优化相关代码</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> a = atoi(argv[<span class=\"number\">1</span>]);</span><br><span class=\"line\">    doLikely(a);</span><br><span class=\"line\">    doUnlikely(a);</span><br><span class=\"line\">    normal(a);</span><br><span class=\"line\">    doLikelyNocall(a);</span><br><span class=\"line\">    doUnlikelyNocall(a);</span><br><span class=\"line\">    normalNocall(a);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>开始编辑，这里显示的指定-O0 -O1 -O2 -O3这四个优化等级。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"comment\"># gcc -O0 -o test_0 builtin_expect.c</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"comment\"># gcc -O1 -o test_1 builtin_expect.c</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"comment\"># gcc -O2 -o test_2 builtin_expect.c</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"comment\"># gcc -O3 -o test_3 builtin_expect.c</span></span><br></pre></td></tr></table></figure>\n\n<p>将编译后的目标文件反汇编</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"comment\"># objdump -d test_0 &gt;test_0.a</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"comment\"># objdump -d test_1 &gt;test_1.a</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"comment\"># objdump -d test_2 &gt;test_2.a</span></span><br><span class=\"line\">root@b13a1870ebc6:/workspace_c/builtin_expect<span class=\"comment\"># objdump -d test_3 &gt;test_3.a</span></span><br></pre></td></tr></table></figure>\n\n<p>最终我们得到了4个优化等级不同的汇编代码，并依次对比相关逻辑。</p>\n<p>1.-O0等级下，编译器默认不执行任何优化，我们对比原始分支代码和经过__builtin_expect优化后的代码在汇编码上有何区别。</p>\n<figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0000000000001197</span> &lt;doLikely&gt;:</span><br><span class=\"line\">    <span class=\"number\">1197</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    119b:\t<span class=\"number\">55</span>                   \t<span class=\"keyword\">push</span>   %rbp</span><br><span class=\"line\">    119c:\t<span class=\"number\">48</span> <span class=\"number\">89</span> e5             \t<span class=\"keyword\">mov</span>    %rsp,%rbp</span><br><span class=\"line\">    119f:\t<span class=\"number\">48</span> <span class=\"number\">83</span> ec <span class=\"number\">10</span>          \t<span class=\"keyword\">sub</span>    <span class=\"number\">$0</span>x10,%rsp</span><br><span class=\"line\">    11a3:\t<span class=\"number\">89</span> <span class=\"number\">7d</span> fc             \t<span class=\"keyword\">mov</span>    %edi,-<span class=\"number\">0x4</span>(%rbp)      #参数a存放至-<span class=\"number\">0x4</span>(%rbp)处</span><br><span class=\"line\">    11a6:\t<span class=\"number\">83</span> <span class=\"number\">7d</span> fc <span class=\"number\">00</span>          \tcmpl   <span class=\"number\">$0</span>x0,-<span class=\"number\">0x4</span>(%rbp)      #参数a和<span class=\"number\">0</span>比较</span><br><span class=\"line\">    11aa:\t0f <span class=\"number\">95</span> c0             \t<span class=\"keyword\">setne</span>  %al                  #条件设置，<span class=\"built_in\">al</span>中保存~ZF。if a = <span class=\"number\">1</span> then <span class=\"built_in\">al</span> = <span class=\"number\">1</span> <span class=\"comment\">; if a = 0 then al = 0</span></span><br><span class=\"line\">    11ad:\t0f b6 c0             \tmovzbl %al,%eax             #<span class=\"built_in\">eax</span> = <span class=\"number\">0000000000000000</span> -&gt; <span class=\"number\">00000000000000000000000000000000</span> <span class=\"keyword\">or</span> <span class=\"number\">0000000000000001</span> -&gt; <span class=\"number\">00000000000000000000000000000001</span></span><br><span class=\"line\">    11b0:\t<span class=\"number\">48</span> <span class=\"number\">85</span> c0             \t<span class=\"keyword\">test</span>   %rax,%rax            #判断<span class=\"built_in\">eax</span>是否为<span class=\"number\">0</span></span><br><span class=\"line\">    11b3:\t<span class=\"number\">74</span> 0c                \t<span class=\"keyword\">je</span>     11c1 &lt;doLikely+<span class=\"number\">0x2a</span>&gt; #<span class=\"built_in\">eax</span> = <span class=\"number\">0</span>(a = <span class=\"number\">0</span>)时，跳转至11c1，<span class=\"keyword\">call</span> foo1</span><br><span class=\"line\">    11b5:\tb8 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       \t<span class=\"keyword\">mov</span>    <span class=\"number\">$0</span>x0,%eax</span><br><span class=\"line\">    11ba:\te8 aa ff ff ff       \tcallq  <span class=\"number\">1169</span> &lt;foo&gt;           #<span class=\"built_in\">eax</span>!=<span class=\"number\">0</span>(a = <span class=\"number\">0</span>)时，<span class=\"keyword\">call</span> foo</span><br><span class=\"line\">    11bf:\teb 0a                \t<span class=\"keyword\">jmp</span>    11cb &lt;doLikely+<span class=\"number\">0x34</span>&gt; #跳转至11cb，结束</span><br><span class=\"line\">    11c1:\tb8 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       \t<span class=\"keyword\">mov</span>    <span class=\"number\">$0</span>x0,%eax</span><br><span class=\"line\">    11c6:\te8 b5 ff ff ff       \tcallq  <span class=\"number\">1180</span> &lt;foo1&gt;</span><br><span class=\"line\">    11cb:\t<span class=\"number\">90</span>                   \t<span class=\"keyword\">nop</span></span><br><span class=\"line\">    11cc:\tc9                   \tleaveq </span><br><span class=\"line\">    11cd:\tc3                   \tretq   </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0000000000001265</span> &lt;normal&gt;:</span><br><span class=\"line\">    <span class=\"number\">1265</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"number\">1269</span>:\t<span class=\"number\">55</span>                   \t<span class=\"keyword\">push</span>   %rbp</span><br><span class=\"line\">    126a:\t<span class=\"number\">48</span> <span class=\"number\">89</span> e5             \t<span class=\"keyword\">mov</span>    %rsp,%rbp</span><br><span class=\"line\">    <span class=\"number\">126d</span>:\t<span class=\"number\">48</span> <span class=\"number\">83</span> ec <span class=\"number\">10</span>          \t<span class=\"keyword\">sub</span>    <span class=\"number\">$0</span>x10,%rsp</span><br><span class=\"line\">    <span class=\"number\">1271</span>:\t<span class=\"number\">89</span> <span class=\"number\">7d</span> fc             \t<span class=\"keyword\">mov</span>    %edi,-<span class=\"number\">0x4</span>(%rbp)      #参数a存放至-<span class=\"number\">0x4</span>(%rbp)处</span><br><span class=\"line\">    <span class=\"number\">1274</span>:\t<span class=\"number\">83</span> <span class=\"number\">7d</span> fc <span class=\"number\">00</span>          \tcmpl   <span class=\"number\">$0</span>x0,-<span class=\"number\">0x4</span>(%rbp)      #参数a和<span class=\"number\">0</span>比较</span><br><span class=\"line\">    <span class=\"number\">1278</span>:\t<span class=\"number\">74</span> 0c                \t<span class=\"keyword\">je</span>     <span class=\"number\">1286</span> &lt;normal+<span class=\"number\">0x21</span>&gt;   #如果a=<span class=\"number\">0</span>，则跳转至<span class=\"number\">1286</span>，执行foo1</span><br><span class=\"line\">    127a:\tb8 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       \t<span class=\"keyword\">mov</span>    <span class=\"number\">$0</span>x0,%eax</span><br><span class=\"line\">    127f:\te8 e5 fe ff ff       \tcallq  <span class=\"number\">1169</span> &lt;foo&gt;           #如果a!=<span class=\"number\">0</span>,则执行foo</span><br><span class=\"line\">    <span class=\"number\">1284</span>:\teb 0a                \t<span class=\"keyword\">jmp</span>    <span class=\"number\">1290</span> &lt;normal+<span class=\"number\">0x2b</span>&gt;   #跳转至<span class=\"number\">1290</span>，结束</span><br><span class=\"line\">    <span class=\"number\">1286</span>:\tb8 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       \t<span class=\"keyword\">mov</span>    <span class=\"number\">$0</span>x0,%eax</span><br><span class=\"line\">    128b:\te8 f0 fe ff ff       \tcallq  <span class=\"number\">1180</span> &lt;foo1&gt;</span><br><span class=\"line\">    <span class=\"number\">1290</span>:\t<span class=\"number\">90</span>                   \t<span class=\"keyword\">nop</span></span><br><span class=\"line\">    <span class=\"number\">1291</span>:\tc9                   \tleaveq </span><br><span class=\"line\">    <span class=\"number\">1292</span>:\tc3                   \tretq   </span><br></pre></td></tr></table></figure>\n\n<p>通过对比，结果令人惊讶。虽然执行结果一直，但是没有经过_builtin_expect优化的分支判断，反而比标识_builtin_expect的汇编代码更加简洁。</p>\n<p>分析Unlikely的汇编代码，也存在同样的问题，编译器貌似会多此一举增加一步的判断</p>\n<figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00000000000011fe &lt;doUnlikely&gt;:</span><br><span class=\"line\">    11fe:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"number\">1202</span>:\t<span class=\"number\">55</span>                   \t<span class=\"keyword\">push</span>   %rbp</span><br><span class=\"line\">    <span class=\"number\">1203</span>:\t<span class=\"number\">48</span> <span class=\"number\">89</span> e5             \t<span class=\"keyword\">mov</span>    %rsp,%rbp</span><br><span class=\"line\">    <span class=\"number\">1206</span>:\t<span class=\"number\">48</span> <span class=\"number\">83</span> ec <span class=\"number\">10</span>          \t<span class=\"keyword\">sub</span>    <span class=\"number\">$0</span>x10,%rsp</span><br><span class=\"line\">    120a:\t<span class=\"number\">89</span> <span class=\"number\">7d</span> fc             \t<span class=\"keyword\">mov</span>    %edi,-<span class=\"number\">0x4</span>(%rbp)</span><br><span class=\"line\">    <span class=\"number\">120d</span>:\t<span class=\"number\">83</span> <span class=\"number\">7d</span> fc <span class=\"number\">00</span>          \tcmpl   <span class=\"number\">$0</span>x0,-<span class=\"number\">0x4</span>(%rbp)</span><br><span class=\"line\">    <span class=\"number\">1211</span>:\t0f <span class=\"number\">95</span> c0             \t<span class=\"keyword\">setne</span>  %al</span><br><span class=\"line\">    <span class=\"number\">1214</span>:\t0f b6 c0             \tmovzbl %al,%eax</span><br><span class=\"line\">    <span class=\"number\">1217</span>:\t<span class=\"number\">48</span> <span class=\"number\">85</span> c0             \t<span class=\"keyword\">test</span>   %rax,%rax</span><br><span class=\"line\">    121a:\t<span class=\"number\">74</span> 0c                \t<span class=\"keyword\">je</span>     <span class=\"number\">1228</span> &lt;doUnlikely+<span class=\"number\">0x2a</span>&gt;</span><br><span class=\"line\">    121c:\tb8 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       \t<span class=\"keyword\">mov</span>    <span class=\"number\">$0</span>x0,%eax</span><br><span class=\"line\">    <span class=\"number\">1221</span>:\te8 <span class=\"number\">43</span> ff ff ff       \tcallq  <span class=\"number\">1169</span> &lt;foo&gt;</span><br><span class=\"line\">    <span class=\"number\">1226</span>:\teb 0a                \t<span class=\"keyword\">jmp</span>    <span class=\"number\">1232</span> &lt;doUnlikely+<span class=\"number\">0x34</span>&gt;</span><br><span class=\"line\">    <span class=\"number\">1228</span>:\tb8 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       \t<span class=\"keyword\">mov</span>    <span class=\"number\">$0</span>x0,%eax</span><br><span class=\"line\">    <span class=\"number\">122d</span>:\te8 4e ff ff ff       \tcallq  <span class=\"number\">1180</span> &lt;foo1&gt;</span><br><span class=\"line\">    <span class=\"number\">1232</span>:\t<span class=\"number\">90</span>                   \t<span class=\"keyword\">nop</span></span><br><span class=\"line\">    <span class=\"number\">1233</span>:\tc9                   \tleaveq </span><br><span class=\"line\">    <span class=\"number\">1234</span>:\tc3                   \tretq   </span><br></pre></td></tr></table></figure>\n\n<p>此外，我们也写了个非内部调用的版本，结果也是同样。编译器没有对_builtin_expect做出不一样的优化。</p>\n<figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00000000000011ce &lt;doLikelyNocall&gt;:</span><br><span class=\"line\">    11ce:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    11d2:\t<span class=\"number\">55</span>                   \t<span class=\"keyword\">push</span>   %rbp</span><br><span class=\"line\">    11d3:\t<span class=\"number\">48</span> <span class=\"number\">89</span> e5             \t<span class=\"keyword\">mov</span>    %rsp,%rbp</span><br><span class=\"line\">    11d6:\t<span class=\"number\">89</span> <span class=\"number\">7d</span> ec             \t<span class=\"keyword\">mov</span>    %edi,-<span class=\"number\">0x14</span>(%rbp)</span><br><span class=\"line\">    11d9:\t<span class=\"number\">83</span> <span class=\"number\">7d</span> ec <span class=\"number\">00</span>          \tcmpl   <span class=\"number\">$0</span>x0,-<span class=\"number\">0x14</span>(%rbp)</span><br><span class=\"line\">    11<span class=\"built_in\">dd</span>:\t0f <span class=\"number\">95</span> c0             \t<span class=\"keyword\">setne</span>  %al</span><br><span class=\"line\">    11e0:\t0f b6 c0             \tmovzbl %al,%eax</span><br><span class=\"line\">    11e3:\t<span class=\"number\">48</span> <span class=\"number\">85</span> c0             \t<span class=\"keyword\">test</span>   %rax,%rax</span><br><span class=\"line\">    11e6:\t<span class=\"number\">74</span> <span class=\"number\">0b</span>                \t<span class=\"keyword\">je</span>     11f3 &lt;doLikelyNocall+<span class=\"number\">0x25</span>&gt;</span><br><span class=\"line\">    11e8:\t8b <span class=\"number\">45</span> ec             \t<span class=\"keyword\">mov</span>    -<span class=\"number\">0x14</span>(%rbp),%eax</span><br><span class=\"line\">    11eb:\t0f af c0             \t<span class=\"keyword\">imul</span>   %eax,%eax</span><br><span class=\"line\">    11ee:\t<span class=\"number\">89</span> <span class=\"number\">45</span> fc             \t<span class=\"keyword\">mov</span>    %eax,-<span class=\"number\">0x4</span>(%rbp)</span><br><span class=\"line\">    11f1:\teb <span class=\"number\">08</span>                \t<span class=\"keyword\">jmp</span>    11fb &lt;doLikelyNocall+<span class=\"number\">0x2d</span>&gt;</span><br><span class=\"line\">    11f3:\t8b <span class=\"number\">45</span> ec             \t<span class=\"keyword\">mov</span>    -<span class=\"number\">0x14</span>(%rbp),%eax</span><br><span class=\"line\">    11f6:\t<span class=\"number\">01</span> c0                \t<span class=\"keyword\">add</span>    %eax,%eax</span><br><span class=\"line\">    11f8:\t<span class=\"number\">89</span> <span class=\"number\">45</span> fc             \t<span class=\"keyword\">mov</span>    %eax,-<span class=\"number\">0x4</span>(%rbp)</span><br><span class=\"line\">    11fb:\t<span class=\"number\">90</span>                   \t<span class=\"keyword\">nop</span></span><br><span class=\"line\">    11fc:\t<span class=\"number\">5d</span>                   \t<span class=\"keyword\">pop</span>    %rbp</span><br><span class=\"line\">    11fd:\tc3                   \tretq   </span><br></pre></td></tr></table></figure>\n\n<p>2.为了了解_builtin_expect是否真的有用，我们再看看其他优化等级 -O1。</p>\n<figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">000000000000119b &lt;doLikely&gt;:</span><br><span class=\"line\">    119b:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    119f:\t<span class=\"number\">48</span> <span class=\"number\">83</span> ec <span class=\"number\">08</span>          \t<span class=\"keyword\">sub</span>    <span class=\"number\">$0</span>x8,%rsp</span><br><span class=\"line\">    11a3:\t<span class=\"number\">85</span> ff                \t<span class=\"keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    11a5:\t<span class=\"number\">74</span> 0f                \t<span class=\"keyword\">je</span>     11b6 &lt;doLikely+<span class=\"number\">0x1b</span>&gt;</span><br><span class=\"line\">    11a7:\tb8 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       \t<span class=\"keyword\">mov</span>    <span class=\"number\">$0</span>x0,%eax</span><br><span class=\"line\">    11ac:\te8 b8 ff ff ff       \tcallq  <span class=\"number\">1169</span> &lt;foo&gt;</span><br><span class=\"line\">    11b1:\t<span class=\"number\">48</span> <span class=\"number\">83</span> c4 <span class=\"number\">08</span>          \t<span class=\"keyword\">add</span>    <span class=\"number\">$0</span>x8,%rsp</span><br><span class=\"line\">    11b5:\tc3                   \tretq   </span><br><span class=\"line\">    11b6:\tb8 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       \t<span class=\"keyword\">mov</span>    <span class=\"number\">$0</span>x0,%eax</span><br><span class=\"line\">    11bb:\te8 c2 ff ff ff       \tcallq  <span class=\"number\">1182</span> &lt;foo1&gt;</span><br><span class=\"line\">    11c0:\teb ef                \t<span class=\"keyword\">jmp</span>    11b1 &lt;doLikely+<span class=\"number\">0x16</span>&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">00000000000011f3 &lt;normal&gt;:</span><br><span class=\"line\">    11f3:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    11f7:\t<span class=\"number\">48</span> <span class=\"number\">83</span> ec <span class=\"number\">08</span>          \t<span class=\"keyword\">sub</span>    <span class=\"number\">$0</span>x8,%rsp</span><br><span class=\"line\">    11fb:\t<span class=\"number\">85</span> ff                \t<span class=\"keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    11fd:\t<span class=\"number\">74</span> 0f                \t<span class=\"keyword\">je</span>     120e &lt;normal+<span class=\"number\">0x1b</span>&gt;</span><br><span class=\"line\">    11ff:\tb8 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       \t<span class=\"keyword\">mov</span>    <span class=\"number\">$0</span>x0,%eax</span><br><span class=\"line\">    <span class=\"number\">1204</span>:\te8 <span class=\"number\">60</span> ff ff ff       \tcallq  <span class=\"number\">1169</span> &lt;foo&gt;</span><br><span class=\"line\">    <span class=\"number\">1209</span>:\t<span class=\"number\">48</span> <span class=\"number\">83</span> c4 <span class=\"number\">08</span>          \t<span class=\"keyword\">add</span>    <span class=\"number\">$0</span>x8,%rsp</span><br><span class=\"line\">    <span class=\"number\">120d</span>:\tc3                   \tretq   </span><br><span class=\"line\">    120e:\tb8 <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span>       \t<span class=\"keyword\">mov</span>    <span class=\"number\">$0</span>x0,%eax</span><br><span class=\"line\">    <span class=\"number\">1213</span>:\te8 6a ff ff ff       \tcallq  <span class=\"number\">1182</span> &lt;foo1&gt;</span><br><span class=\"line\">    <span class=\"number\">1218</span>:\teb ef                \t<span class=\"keyword\">jmp</span>    <span class=\"number\">1209</span> &lt;normal+<span class=\"number\">0x16</span>&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">00000000000011ee &lt;doUnlikelyNocall&gt;:</span><br><span class=\"line\">    11ee:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    11f2:\tc3                   \tretq   </span><br></pre></td></tr></table></figure>\n\n<p>观察-O1优化后的汇编代码，代码风格有了质的飞越。去除了公式化的参数传递，费劲的值比较。但是依然没有体现出_builtin_expect有没有的区别。<br>同样的，我们的非调用版本由于无返回值，已经被编译器完全优化掉了。</p>\n<p>我们再看看-O2。</p>\n<figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0000000000001210</span> &lt;doLikely&gt;:</span><br><span class=\"line\">    <span class=\"number\">1210</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"number\">1214</span>:\t<span class=\"number\">85</span> ff                \t<span class=\"keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    <span class=\"number\">1216</span>:\t<span class=\"number\">74</span> <span class=\"number\">10</span>                \t<span class=\"keyword\">je</span>     <span class=\"number\">1228</span> &lt;doLikely+<span class=\"number\">0x18</span>&gt;</span><br><span class=\"line\">    <span class=\"number\">1218</span>:\t<span class=\"number\">48</span> <span class=\"number\">8d</span> <span class=\"number\">3d</span> e5 <span class=\"number\">0d</span> <span class=\"number\">00</span> <span class=\"number\">00</span> \t<span class=\"keyword\">lea</span>    <span class=\"number\">0xde5</span>(%rip),%rdi        # <span class=\"number\">2004</span> &lt;_IO_stdin_used+<span class=\"number\">0x4</span>&gt;</span><br><span class=\"line\">    121f:\te9 3c fe ff ff       \tjmpq   <span class=\"number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    <span class=\"number\">1224</span>:\t0f 1f <span class=\"number\">40</span> <span class=\"number\">00</span>          \tnopl   <span class=\"number\">0x0</span>(%rax)</span><br><span class=\"line\">    <span class=\"number\">1228</span>:\t<span class=\"number\">48</span> <span class=\"number\">8d</span> <span class=\"number\">3d</span> d9 <span class=\"number\">0d</span> <span class=\"number\">00</span> <span class=\"number\">00</span> \t<span class=\"keyword\">lea</span>    <span class=\"number\">0xdd9</span>(%rip),%rdi        # <span class=\"number\">2008</span> &lt;_IO_stdin_used+<span class=\"number\">0x8</span>&gt;</span><br><span class=\"line\">    122f:\te9 2c fe ff ff       \tjmpq   <span class=\"number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    <span class=\"number\">1234</span>:\t<span class=\"number\">66</span> <span class=\"number\">66</span> 2e 0f 1f <span class=\"number\">84</span> <span class=\"number\">00</span> \tdata16 nopw %cs:<span class=\"number\">0x0</span>(%rax,%rax,<span class=\"number\">1</span>)</span><br><span class=\"line\">    123b:\t<span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> </span><br><span class=\"line\">    123f:\t<span class=\"number\">90</span>                   \t<span class=\"keyword\">nop</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0000000000001290</span> &lt;normal&gt;:</span><br><span class=\"line\">    <span class=\"number\">1290</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"number\">1294</span>:\t<span class=\"number\">85</span> ff                \t<span class=\"keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    <span class=\"number\">1296</span>:\t<span class=\"number\">74</span> <span class=\"number\">10</span>                \t<span class=\"keyword\">je</span>     12a8 &lt;normal+<span class=\"number\">0x18</span>&gt;</span><br><span class=\"line\">    <span class=\"number\">1298</span>:\t<span class=\"number\">48</span> <span class=\"number\">8d</span> <span class=\"number\">3d</span> <span class=\"number\">65</span> <span class=\"number\">0d</span> <span class=\"number\">00</span> <span class=\"number\">00</span> \t<span class=\"keyword\">lea</span>    <span class=\"number\">0xd65</span>(%rip),%rdi        # <span class=\"number\">2004</span> &lt;_IO_stdin_used+<span class=\"number\">0x4</span>&gt;</span><br><span class=\"line\">    129f:\te9 bc fd ff ff       \tjmpq   <span class=\"number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    12a4:\t0f 1f <span class=\"number\">40</span> <span class=\"number\">00</span>          \tnopl   <span class=\"number\">0x0</span>(%rax)</span><br><span class=\"line\">    12a8:\t<span class=\"number\">48</span> <span class=\"number\">8d</span> <span class=\"number\">3d</span> <span class=\"number\">59</span> <span class=\"number\">0d</span> <span class=\"number\">00</span> <span class=\"number\">00</span> \t<span class=\"keyword\">lea</span>    <span class=\"number\">0xd59</span>(%rip),%rdi        # <span class=\"number\">2008</span> &lt;_IO_stdin_used+<span class=\"number\">0x8</span>&gt;</span><br><span class=\"line\">    12af:\te9 ac fd ff ff       \tjmpq   <span class=\"number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    12b4:\t<span class=\"number\">66</span> <span class=\"number\">66</span> 2e 0f 1f <span class=\"number\">84</span> <span class=\"number\">00</span> \tdata16 nopw %cs:<span class=\"number\">0x0</span>(%rax,%rax,<span class=\"number\">1</span>)</span><br><span class=\"line\">    12bb:\t<span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> </span><br><span class=\"line\">    12bf:\t<span class=\"number\">90</span>                   \t<span class=\"keyword\">nop</span></span><br></pre></td></tr></table></figure>\n\n<p>代码进一步的被优化，从汇编代码中可以看出，方法调用完全优化掉了栈上调用。去除了栈上传递，将call指令变为了jmp指令，进一步减少了指令上的开销。<br>但结果仍然没有改变，_builtin_expect依然没有发光发热。</p>\n<p>最后我们只能把希望寄托于-O3上看看了。</p>\n<figure class=\"highlight x86asm\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">0000000000001210</span> &lt;doLikely&gt;:</span><br><span class=\"line\">    <span class=\"number\">1210</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"number\">1214</span>:\t<span class=\"number\">85</span> ff                \t<span class=\"keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    <span class=\"number\">1216</span>:\t<span class=\"number\">74</span> <span class=\"number\">10</span>                \t<span class=\"keyword\">je</span>     <span class=\"number\">1228</span> &lt;doLikely+<span class=\"number\">0x18</span>&gt;</span><br><span class=\"line\">    <span class=\"number\">1218</span>:\t<span class=\"number\">48</span> <span class=\"number\">8d</span> <span class=\"number\">3d</span> e5 <span class=\"number\">0d</span> <span class=\"number\">00</span> <span class=\"number\">00</span> \t<span class=\"keyword\">lea</span>    <span class=\"number\">0xde5</span>(%rip),%rdi        # <span class=\"number\">2004</span> &lt;_IO_stdin_used+<span class=\"number\">0x4</span>&gt;</span><br><span class=\"line\">    121f:\te9 3c fe ff ff       \tjmpq   <span class=\"number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    <span class=\"number\">1224</span>:\t0f 1f <span class=\"number\">40</span> <span class=\"number\">00</span>          \tnopl   <span class=\"number\">0x0</span>(%rax)</span><br><span class=\"line\">    <span class=\"number\">1228</span>:\t<span class=\"number\">48</span> <span class=\"number\">8d</span> <span class=\"number\">3d</span> d9 <span class=\"number\">0d</span> <span class=\"number\">00</span> <span class=\"number\">00</span> \t<span class=\"keyword\">lea</span>    <span class=\"number\">0xdd9</span>(%rip),%rdi        # <span class=\"number\">2008</span> &lt;_IO_stdin_used+<span class=\"number\">0x8</span>&gt;</span><br><span class=\"line\">    122f:\te9 2c fe ff ff       \tjmpq   <span class=\"number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    <span class=\"number\">1234</span>:\t<span class=\"number\">66</span> <span class=\"number\">66</span> 2e 0f 1f <span class=\"number\">84</span> <span class=\"number\">00</span> \tdata16 nopw %cs:<span class=\"number\">0x0</span>(%rax,%rax,<span class=\"number\">1</span>)</span><br><span class=\"line\">    123b:\t<span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> </span><br><span class=\"line\">    123f:\t<span class=\"number\">90</span>                   \t<span class=\"keyword\">nop</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">0000000000001290</span> &lt;normal&gt;:</span><br><span class=\"line\">    <span class=\"number\">1290</span>:\tf3 0f 1e fa          \tendbr64 </span><br><span class=\"line\">    <span class=\"number\">1294</span>:\t<span class=\"number\">85</span> ff                \t<span class=\"keyword\">test</span>   %edi,%edi</span><br><span class=\"line\">    <span class=\"number\">1296</span>:\t<span class=\"number\">74</span> <span class=\"number\">10</span>                \t<span class=\"keyword\">je</span>     12a8 &lt;normal+<span class=\"number\">0x18</span>&gt;</span><br><span class=\"line\">    <span class=\"number\">1298</span>:\t<span class=\"number\">48</span> <span class=\"number\">8d</span> <span class=\"number\">3d</span> <span class=\"number\">65</span> <span class=\"number\">0d</span> <span class=\"number\">00</span> <span class=\"number\">00</span> \t<span class=\"keyword\">lea</span>    <span class=\"number\">0xd65</span>(%rip),%rdi        # <span class=\"number\">2004</span> &lt;_IO_stdin_used+<span class=\"number\">0x4</span>&gt;</span><br><span class=\"line\">    129f:\te9 bc fd ff ff       \tjmpq   <span class=\"number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    12a4:\t0f 1f <span class=\"number\">40</span> <span class=\"number\">00</span>          \tnopl   <span class=\"number\">0x0</span>(%rax)</span><br><span class=\"line\">    12a8:\t<span class=\"number\">48</span> <span class=\"number\">8d</span> <span class=\"number\">3d</span> <span class=\"number\">59</span> <span class=\"number\">0d</span> <span class=\"number\">00</span> <span class=\"number\">00</span> \t<span class=\"keyword\">lea</span>    <span class=\"number\">0xd59</span>(%rip),%rdi        # <span class=\"number\">2008</span> &lt;_IO_stdin_used+<span class=\"number\">0x8</span>&gt;</span><br><span class=\"line\">    12af:\te9 ac fd ff ff       \tjmpq   <span class=\"number\">1060</span> &lt;puts@plt&gt;</span><br><span class=\"line\">    12b4:\t<span class=\"number\">66</span> <span class=\"number\">66</span> 2e 0f 1f <span class=\"number\">84</span> <span class=\"number\">00</span> \tdata16 nopw %cs:<span class=\"number\">0x0</span>(%rax,%rax,<span class=\"number\">1</span>)</span><br><span class=\"line\">    12bb:\t<span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> <span class=\"number\">00</span> </span><br><span class=\"line\">    12bf:\t<span class=\"number\">90</span>                   \t<span class=\"keyword\">nop</span></span><br></pre></td></tr></table></figure>\n\n<p>可见，O3已经没有任何优化空间了，_builtin_expect的存在感也已然是0。</p>\n<p>这次的实验是否失败呢，结果上看起来的确如此。但是我们并没有尝试更多的平台，同时各个平台的版本或GCC的版本都可能对编译的结果造成不同的影响。<br>_builtin_expect到底有没有用？我能确信的是，再更加激进的优化等级下，_builtin_expect的存在感必然是稀薄的。但是GCC在遇到_builtin_expect时具体做了些什么，希望某一天阅读完GCC相关的源码后找到一个满意的答案吧！~</p>"},{"title":"基于Flink实现简单的日志异常推送","date":"2020-05-30T08:13:42.000Z","_content":"\n## 监控系统\n业务系统经常会接入各种监控系统或APM系统，从而实现生产问题的快速报警和定位。比如CAT、PingPong、skywalking等，虽然实现原理和架构略有不同，但都为业务系统提供了调用链跟踪、异常日志、DB异常、连接超时、JVM信息等报警。甚至我们可以在监控平台上定制自己的报警规则，监控系统会根据规则向关系人提供报警信息。\n\n以上都是基于监控系统提供的功能实现各个维度的报警。最近在捯饬Flink，所以想能否用Flink实现一个简单的日志异常报警。话不多说，开始撸代码。\n<!-- more -->\n## 引入日志服务依赖\n由于系统已经全面接入阿里云日志平台，并且阿里云也非常有好的为我们提供了Flink阿里云Source的实现，所以我们只要引入阿里云提供的jar包即可，省去了自己实现的功夫。\n\n```yml\n    compile \"com.aliyun.openservices:flink-log-connector:0.1.3\"\n    compile \"com.google.protobuf:protobuf-java:2.5.0\"\n    compile \"com.aliyun.openservices:aliyun-log:0.6.10\"\n    // 由于当前只是用Source，所以不引入Sink模块\n    // compile \"com.aliyun.openservices:log-loghub-producer:0.1.8\" \n```\n可以看到，阿里云日志通过protobuf协议进行序列化传输。\n\n## 日志分析启动类\n参考官网文档，我们配置了阿里云日志服务的链接属性，指定了日志文件。\n此外我们还定义了interval参数为日志间隔；threshold为错误数；nameserverAddress为将错误信息发送至RockerMQ地址。结合上一篇文件，异常推送任务会将错误信息通过wechat推送给干系人。\n\n```java\n ParameterTool parameterTool = ParameterTool.fromArgs(args);\n        String interval = parameterTool.get(\"interval\");\n        String threshold = parameterTool.get(\"threshold\");\n        String nameserverAddress = parameterTool.get(\"nameserverAddress\");\n\n        Properties configProps = new Properties();\n        // 设置访问日志服务的域名\n        configProps.put(ConfigConstants.LOG_ENDPOINT, \"xxxxxxxxxxxx\");\n        // 设置访问ak\n        configProps.put(ConfigConstants.LOG_ACCESSSKEYID, \"xxxxxxxx\");\n        configProps.put(ConfigConstants.LOG_ACCESSKEY, \"xxxxxx\");\n        // 设置日志服务的project\n        configProps.put(ConfigConstants.LOG_PROJECT, \"xxxxxxx\");\n        // 设置日志服务的LogStore\n        configProps.put(ConfigConstants.LOG_LOGSTORE, \"xxxxxxxx\");\n        // 设置消费日志服务起始位置\n        configProps.put(ConfigConstants.LOG_CONSUMER_BEGIN_POSITION, Consts.LOG_END_CURSOR);\n        // 设置日志服务的消息反序列化方法\n        RawLogGroupListDeserializer deserializer = new RawLogGroupListDeserializer();\n        final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n\n        Properties producerProps = new Properties();\n        producerProps.setProperty(RocketMQConfig.NAME_SERVER_ADDR, nameserverAddress);\n\n        DataStream<RawLogGroupList> logTestStream = env.addSource(\n                new FlinkLogConsumer<RawLogGroupList>(deserializer, configProps));\n```\n\n### 解析阿里云日志并转换为日志流\n```java\nSingleOutputStreamOperator<LogInfo> process = logTestStream\n        .flatMap(new TransLogInfo())\n        .keyBy(\"podName\")\n        .keyBy(\"level\")\n        .process(new SplitLeveProcess());\n```\n\n#### 我们首先实现了FlatMapFunction接口，为的是将阿里云的日志流结构解析成我们自己想要的日志结构\n```java\npublic class TransLogInfo implements FlatMapFunction<RawLogGroupList, LogInfo> {\n\n\n    @Override\n    public void flatMap(RawLogGroupList value, Collector<LogInfo> out) throws Exception {\n        List<RawLogGroup> rawLogGroups = value.getRawLogGroups();\n        if(rawLogGroups != null){\n            for(RawLogGroup rawLogGroup : rawLogGroups){\n                String nodeIp = \"\";\n                Map<String, String> tags = rawLogGroup.getTags();\n                if(tags != null){\n                    nodeIp = tags.get(\"_node_ip_\");\n                }\n                if(rawLogGroup != null){\n                    List<RawLog> logs = rawLogGroup.getLogs();\n                    if(!CollectionUtils.isEmpty(logs)){\n                        for(RawLog log : logs){\n                            if(log != null){\n                                LogInfo logInfo = new LogInfo();\n                                Map<String, String> contents = log.getContents();\n                                if(contents != null){\n                                    logInfo.setNodeIp(nodeIp);\n                                    logInfo.setReceiveTime(contents.get(\"@timestamp\"));\n                                    logInfo.setLevel(contents.get(\"_level\"));\n                                    logInfo.setAccountId(contents.get(\"accountId\"));\n                                    logInfo.setPodName(contents.get(\"_pod_name_\"));\n                                    logInfo.setTraceId(contents.get(\"traceId\"));\n                                    logInfo.setMessage(contents.get(\"nte_message\"));\n                                    logInfo.setAppName(contents.get(\"appName\"));\n                                }\n                                out.collect(logInfo);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n```\n#### 将解析后的日志流按照容器名和日志等级分组(如果只是想处理ERROR级别的错误，也可以用Filter对level进行过滤)\n\n#### 我们实现了KeyedProcessFunction接口，将ERROR日志分流进行处理\n```java\npublic class SplitLeveProcess extends KeyedProcessFunction<Tuple, LogInfo, LogInfo> {\n    private static final String LEVEL_INOF = \"INFO\";\n    private static final String LEVEL_ERROR = \"ERROR\";\n\n    final OutputTag<LogInfo> outputTag = new OutputTag<LogInfo>(\"error-log\"){};\n\n    @Override\n    public void processElement(LogInfo value, Context ctx, Collector<LogInfo> out) throws Exception {\n        if(LEVEL_INOF.equals(value.getLevel())){\n            out.collect(value);\n        }else if(LEVEL_ERROR.equals(value.getLevel())){\n            ctx.output(outputTag,value);\n        }\n    }\n}\n```\n\n#### 得到ERROR日志侧输出流，处理错误日志流\n```java\n        DataStream<LogInfo> errorStream = process.getSideOutput(new OutputTag<LogInfo>(\"error-log\"){});\n        errorStream.keyBy(\"podName\").process(new ErrorProcess(Long.valueOf(interval) * 1000,Integer.valueOf(threshold)))\n//                .setParallelism(4)\n                .map(new ToMessage())\n                .addSink(new RocketMQSink(new SimpleKeyValueSerializationSchema(null, \"body\"),\n                        new DefaultTopicSelector(topic), producerProps).withBatchFlushOnCheckpoint(true));\n```\n\n#### 针对错误日志处理，同样实现了KeyedProcessFunction接口，通过注册定时器判断interval周期内，错误数量是否超过threshold。如果超过则输出错误信息流，交由后面的算子处理\n\n```java\npublic class ErrorProcess extends KeyedProcessFunction<Tuple, LogInfo, AlertInfo> {\n    private long interval;\n    private int threshold;\n//    private transient SendWechatService sendWechatService;\n    ValueState<Integer> cnt ;\n    ValueState<Long> timer ;\n    ValueState<String> pod ;\n    ValueState<List> errorMsg ;\n\n    public ErrorProcess(long interval,int threshold){\n        this.interval = interval;\n        this.threshold = threshold;\n    }\n\n    @Override\n    public void open(Configuration parameters) throws Exception {\n        super.open(parameters);\n        cnt = getRuntimeContext().getState(new ValueStateDescriptor<Integer>(\"cnt\",Integer.class,0));\n        timer = getRuntimeContext().getState(new ValueStateDescriptor<Long>(\"timer\",Long.class));\n        pod = getRuntimeContext().getState(new ValueStateDescriptor<String>(\"pod\",String.class));\n        errorMsg = getRuntimeContext().getState(new ValueStateDescriptor<>(\"errorMsg\",List.class));\n    }\n\n    @Override\n    public void processElement(LogInfo value, Context ctx, Collector<AlertInfo> out) throws Exception {\n        pod.update(value.getPodName());\n        if(\"ERROR\".equals(value.getLevel())){\n            if(timer.value() == null){\n                ctx.timerService().registerProcessingTimeTimer(ctx.timerService().currentProcessingTime() + interval);\n            }\n            cnt.update(cnt.value() + 1);\n            List em = errorMsg.value();\n            if(em == null){\n                em = new ArrayList();\n            }\n            em.add(value.getMessage());\n            errorMsg.update(em);\n        }else {\n            if(timer.value() != null){\n                ctx.timerService().deleteEventTimeTimer(timer.value());\n                cnt.clear();\n                timer.clear();\n            }\n        }\n    }\n\n    @Override\n    public void onTimer(long timestamp, OnTimerContext ctx, Collector<AlertInfo> out) throws Exception {\n        if(cnt.value() >=threshold){\n            AlertInfo alertInfo = new AlertInfo();\n            alertInfo.setErrorCnt(cnt.value());\n            alertInfo.setLevel(\"ERROR\");\n            alertInfo.setPodName(pod.value());\n            alertInfo.setMg(errorMsg.value());\n            String content = \"In \" + interval/1000 + \" seconds, pod[\" + pod.value()  + \"] over \" + threshold + \" error happened ,error count[\" + cnt.value() + \"]    detail:\" + \"\\n\"  + \"\\n\";\n            for(int i = 1 ;i<=errorMsg.value().size();i++){\n                content = content + \"[\" + i + \"]\" + errorMsg.value().get(i-1) + \"  \" + \"\\n\";\n            }\n            alertInfo.setContent(content);\n            out.collect(alertInfo);\n\n        }\n        cnt.clear();\n        timer.clear();\n        errorMsg.clear();\n    }\n```\n\n#### 后续算子将错误日志流转换成指定结构，并发给RocketMQ的Sink，交由错误推送任务进行wechat推送。\n```java\n    public static class ToMessage implements MapFunction<AlertInfo, String> {\n        @Override\n        public String map(AlertInfo value) throws Exception {\n            JSONObject messageBody = new JSONObject();\n            messageBody.put(\"alertMsg\",value.getContent());\n            messageBody.put(\"alertTo\",\"xxxxx\");\n            messageBody.put(\"bizType\",\"\");\n            return messageBody.toJSONString();\n        }\n    }\n```\n\n## 总结\n以上就是一个简单的错误日志分析及报警的流程，下次我们针对这个流程再写一篇测试文。同时这个流程中，我们对错误日志流采用的是侧流输出。所以在我们的主流中，我们还有很多正常日志值得我们分析和挖掘，后面我们也会围绕这些日志来做些有意思的东西，那这一次我们就先到这了。","source":"_posts/基于Flink实现简单的日志异常推送.md","raw":"---\ntitle: 基于Flink实现简单的日志异常推送\ndate: 2020-05-30 16:13:42\ntags: \n    - Java\n    - Flink\n    - 监控\ncategories :\n    - Technology\n---\n\n## 监控系统\n业务系统经常会接入各种监控系统或APM系统，从而实现生产问题的快速报警和定位。比如CAT、PingPong、skywalking等，虽然实现原理和架构略有不同，但都为业务系统提供了调用链跟踪、异常日志、DB异常、连接超时、JVM信息等报警。甚至我们可以在监控平台上定制自己的报警规则，监控系统会根据规则向关系人提供报警信息。\n\n以上都是基于监控系统提供的功能实现各个维度的报警。最近在捯饬Flink，所以想能否用Flink实现一个简单的日志异常报警。话不多说，开始撸代码。\n<!-- more -->\n## 引入日志服务依赖\n由于系统已经全面接入阿里云日志平台，并且阿里云也非常有好的为我们提供了Flink阿里云Source的实现，所以我们只要引入阿里云提供的jar包即可，省去了自己实现的功夫。\n\n```yml\n    compile \"com.aliyun.openservices:flink-log-connector:0.1.3\"\n    compile \"com.google.protobuf:protobuf-java:2.5.0\"\n    compile \"com.aliyun.openservices:aliyun-log:0.6.10\"\n    // 由于当前只是用Source，所以不引入Sink模块\n    // compile \"com.aliyun.openservices:log-loghub-producer:0.1.8\" \n```\n可以看到，阿里云日志通过protobuf协议进行序列化传输。\n\n## 日志分析启动类\n参考官网文档，我们配置了阿里云日志服务的链接属性，指定了日志文件。\n此外我们还定义了interval参数为日志间隔；threshold为错误数；nameserverAddress为将错误信息发送至RockerMQ地址。结合上一篇文件，异常推送任务会将错误信息通过wechat推送给干系人。\n\n```java\n ParameterTool parameterTool = ParameterTool.fromArgs(args);\n        String interval = parameterTool.get(\"interval\");\n        String threshold = parameterTool.get(\"threshold\");\n        String nameserverAddress = parameterTool.get(\"nameserverAddress\");\n\n        Properties configProps = new Properties();\n        // 设置访问日志服务的域名\n        configProps.put(ConfigConstants.LOG_ENDPOINT, \"xxxxxxxxxxxx\");\n        // 设置访问ak\n        configProps.put(ConfigConstants.LOG_ACCESSSKEYID, \"xxxxxxxx\");\n        configProps.put(ConfigConstants.LOG_ACCESSKEY, \"xxxxxx\");\n        // 设置日志服务的project\n        configProps.put(ConfigConstants.LOG_PROJECT, \"xxxxxxx\");\n        // 设置日志服务的LogStore\n        configProps.put(ConfigConstants.LOG_LOGSTORE, \"xxxxxxxx\");\n        // 设置消费日志服务起始位置\n        configProps.put(ConfigConstants.LOG_CONSUMER_BEGIN_POSITION, Consts.LOG_END_CURSOR);\n        // 设置日志服务的消息反序列化方法\n        RawLogGroupListDeserializer deserializer = new RawLogGroupListDeserializer();\n        final StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n\n        Properties producerProps = new Properties();\n        producerProps.setProperty(RocketMQConfig.NAME_SERVER_ADDR, nameserverAddress);\n\n        DataStream<RawLogGroupList> logTestStream = env.addSource(\n                new FlinkLogConsumer<RawLogGroupList>(deserializer, configProps));\n```\n\n### 解析阿里云日志并转换为日志流\n```java\nSingleOutputStreamOperator<LogInfo> process = logTestStream\n        .flatMap(new TransLogInfo())\n        .keyBy(\"podName\")\n        .keyBy(\"level\")\n        .process(new SplitLeveProcess());\n```\n\n#### 我们首先实现了FlatMapFunction接口，为的是将阿里云的日志流结构解析成我们自己想要的日志结构\n```java\npublic class TransLogInfo implements FlatMapFunction<RawLogGroupList, LogInfo> {\n\n\n    @Override\n    public void flatMap(RawLogGroupList value, Collector<LogInfo> out) throws Exception {\n        List<RawLogGroup> rawLogGroups = value.getRawLogGroups();\n        if(rawLogGroups != null){\n            for(RawLogGroup rawLogGroup : rawLogGroups){\n                String nodeIp = \"\";\n                Map<String, String> tags = rawLogGroup.getTags();\n                if(tags != null){\n                    nodeIp = tags.get(\"_node_ip_\");\n                }\n                if(rawLogGroup != null){\n                    List<RawLog> logs = rawLogGroup.getLogs();\n                    if(!CollectionUtils.isEmpty(logs)){\n                        for(RawLog log : logs){\n                            if(log != null){\n                                LogInfo logInfo = new LogInfo();\n                                Map<String, String> contents = log.getContents();\n                                if(contents != null){\n                                    logInfo.setNodeIp(nodeIp);\n                                    logInfo.setReceiveTime(contents.get(\"@timestamp\"));\n                                    logInfo.setLevel(contents.get(\"_level\"));\n                                    logInfo.setAccountId(contents.get(\"accountId\"));\n                                    logInfo.setPodName(contents.get(\"_pod_name_\"));\n                                    logInfo.setTraceId(contents.get(\"traceId\"));\n                                    logInfo.setMessage(contents.get(\"nte_message\"));\n                                    logInfo.setAppName(contents.get(\"appName\"));\n                                }\n                                out.collect(logInfo);\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n```\n#### 将解析后的日志流按照容器名和日志等级分组(如果只是想处理ERROR级别的错误，也可以用Filter对level进行过滤)\n\n#### 我们实现了KeyedProcessFunction接口，将ERROR日志分流进行处理\n```java\npublic class SplitLeveProcess extends KeyedProcessFunction<Tuple, LogInfo, LogInfo> {\n    private static final String LEVEL_INOF = \"INFO\";\n    private static final String LEVEL_ERROR = \"ERROR\";\n\n    final OutputTag<LogInfo> outputTag = new OutputTag<LogInfo>(\"error-log\"){};\n\n    @Override\n    public void processElement(LogInfo value, Context ctx, Collector<LogInfo> out) throws Exception {\n        if(LEVEL_INOF.equals(value.getLevel())){\n            out.collect(value);\n        }else if(LEVEL_ERROR.equals(value.getLevel())){\n            ctx.output(outputTag,value);\n        }\n    }\n}\n```\n\n#### 得到ERROR日志侧输出流，处理错误日志流\n```java\n        DataStream<LogInfo> errorStream = process.getSideOutput(new OutputTag<LogInfo>(\"error-log\"){});\n        errorStream.keyBy(\"podName\").process(new ErrorProcess(Long.valueOf(interval) * 1000,Integer.valueOf(threshold)))\n//                .setParallelism(4)\n                .map(new ToMessage())\n                .addSink(new RocketMQSink(new SimpleKeyValueSerializationSchema(null, \"body\"),\n                        new DefaultTopicSelector(topic), producerProps).withBatchFlushOnCheckpoint(true));\n```\n\n#### 针对错误日志处理，同样实现了KeyedProcessFunction接口，通过注册定时器判断interval周期内，错误数量是否超过threshold。如果超过则输出错误信息流，交由后面的算子处理\n\n```java\npublic class ErrorProcess extends KeyedProcessFunction<Tuple, LogInfo, AlertInfo> {\n    private long interval;\n    private int threshold;\n//    private transient SendWechatService sendWechatService;\n    ValueState<Integer> cnt ;\n    ValueState<Long> timer ;\n    ValueState<String> pod ;\n    ValueState<List> errorMsg ;\n\n    public ErrorProcess(long interval,int threshold){\n        this.interval = interval;\n        this.threshold = threshold;\n    }\n\n    @Override\n    public void open(Configuration parameters) throws Exception {\n        super.open(parameters);\n        cnt = getRuntimeContext().getState(new ValueStateDescriptor<Integer>(\"cnt\",Integer.class,0));\n        timer = getRuntimeContext().getState(new ValueStateDescriptor<Long>(\"timer\",Long.class));\n        pod = getRuntimeContext().getState(new ValueStateDescriptor<String>(\"pod\",String.class));\n        errorMsg = getRuntimeContext().getState(new ValueStateDescriptor<>(\"errorMsg\",List.class));\n    }\n\n    @Override\n    public void processElement(LogInfo value, Context ctx, Collector<AlertInfo> out) throws Exception {\n        pod.update(value.getPodName());\n        if(\"ERROR\".equals(value.getLevel())){\n            if(timer.value() == null){\n                ctx.timerService().registerProcessingTimeTimer(ctx.timerService().currentProcessingTime() + interval);\n            }\n            cnt.update(cnt.value() + 1);\n            List em = errorMsg.value();\n            if(em == null){\n                em = new ArrayList();\n            }\n            em.add(value.getMessage());\n            errorMsg.update(em);\n        }else {\n            if(timer.value() != null){\n                ctx.timerService().deleteEventTimeTimer(timer.value());\n                cnt.clear();\n                timer.clear();\n            }\n        }\n    }\n\n    @Override\n    public void onTimer(long timestamp, OnTimerContext ctx, Collector<AlertInfo> out) throws Exception {\n        if(cnt.value() >=threshold){\n            AlertInfo alertInfo = new AlertInfo();\n            alertInfo.setErrorCnt(cnt.value());\n            alertInfo.setLevel(\"ERROR\");\n            alertInfo.setPodName(pod.value());\n            alertInfo.setMg(errorMsg.value());\n            String content = \"In \" + interval/1000 + \" seconds, pod[\" + pod.value()  + \"] over \" + threshold + \" error happened ,error count[\" + cnt.value() + \"]    detail:\" + \"\\n\"  + \"\\n\";\n            for(int i = 1 ;i<=errorMsg.value().size();i++){\n                content = content + \"[\" + i + \"]\" + errorMsg.value().get(i-1) + \"  \" + \"\\n\";\n            }\n            alertInfo.setContent(content);\n            out.collect(alertInfo);\n\n        }\n        cnt.clear();\n        timer.clear();\n        errorMsg.clear();\n    }\n```\n\n#### 后续算子将错误日志流转换成指定结构，并发给RocketMQ的Sink，交由错误推送任务进行wechat推送。\n```java\n    public static class ToMessage implements MapFunction<AlertInfo, String> {\n        @Override\n        public String map(AlertInfo value) throws Exception {\n            JSONObject messageBody = new JSONObject();\n            messageBody.put(\"alertMsg\",value.getContent());\n            messageBody.put(\"alertTo\",\"xxxxx\");\n            messageBody.put(\"bizType\",\"\");\n            return messageBody.toJSONString();\n        }\n    }\n```\n\n## 总结\n以上就是一个简单的错误日志分析及报警的流程，下次我们针对这个流程再写一篇测试文。同时这个流程中，我们对错误日志流采用的是侧流输出。所以在我们的主流中，我们还有很多正常日志值得我们分析和挖掘，后面我们也会围绕这些日志来做些有意思的东西，那这一次我们就先到这了。","slug":"基于Flink实现简单的日志异常推送","published":1,"updated":"2020-12-14T09:51:24.018Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htg000uv25243rb7mpl","content":"<html><head></head><body><h2 id=\"&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;\"><a href=\"#&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;\" class=\"headerlink\" title=\"&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;\"></a>&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;</h2><p>&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;&#x7ECF;&#x5E38;&#x4F1A;&#x63A5;&#x5165;&#x5404;&#x79CD;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x6216;APM&#x7CFB;&#x7EDF;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x751F;&#x4EA7;&#x95EE;&#x9898;&#x7684;&#x5FEB;&#x901F;&#x62A5;&#x8B66;&#x548C;&#x5B9A;&#x4F4D;&#x3002;&#x6BD4;&#x5982;CAT&#x3001;PingPong&#x3001;skywalking&#x7B49;&#xFF0C;&#x867D;&#x7136;&#x5B9E;&#x73B0;&#x539F;&#x7406;&#x548C;&#x67B6;&#x6784;&#x7565;&#x6709;&#x4E0D;&#x540C;&#xFF0C;&#x4F46;&#x90FD;&#x4E3A;&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x4E86;&#x8C03;&#x7528;&#x94FE;&#x8DDF;&#x8E2A;&#x3001;&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x3001;DB&#x5F02;&#x5E38;&#x3001;&#x8FDE;&#x63A5;&#x8D85;&#x65F6;&#x3001;JVM&#x4FE1;&#x606F;&#x7B49;&#x62A5;&#x8B66;&#x3002;&#x751A;&#x81F3;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x76D1;&#x63A7;&#x5E73;&#x53F0;&#x4E0A;&#x5B9A;&#x5236;&#x81EA;&#x5DF1;&#x7684;&#x62A5;&#x8B66;&#x89C4;&#x5219;&#xFF0C;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x4F1A;&#x6839;&#x636E;&#x89C4;&#x5219;&#x5411;&#x5173;&#x7CFB;&#x4EBA;&#x63D0;&#x4F9B;&#x62A5;&#x8B66;&#x4FE1;&#x606F;&#x3002;</p>\n<p>&#x4EE5;&#x4E0A;&#x90FD;&#x662F;&#x57FA;&#x4E8E;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x7684;&#x529F;&#x80FD;&#x5B9E;&#x73B0;&#x5404;&#x4E2A;&#x7EF4;&#x5EA6;&#x7684;&#x62A5;&#x8B66;&#x3002;&#x6700;&#x8FD1;&#x5728;&#x636F;&#x996C;Flink&#xFF0C;&#x6240;&#x4EE5;&#x60F3;&#x80FD;&#x5426;&#x7528;Flink&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x65E5;&#x5FD7;&#x5F02;&#x5E38;&#x62A5;&#x8B66;&#x3002;&#x8BDD;&#x4E0D;&#x591A;&#x8BF4;&#xFF0C;&#x5F00;&#x59CB;&#x64B8;&#x4EE3;&#x7801;&#x3002;</p>\n<a id=\"more\"></a>\n<h2 id=\"&#x5F15;&#x5165;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x4F9D;&#x8D56;\"><a href=\"#&#x5F15;&#x5165;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x4F9D;&#x8D56;\" class=\"headerlink\" title=\"&#x5F15;&#x5165;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x4F9D;&#x8D56;\"></a>&#x5F15;&#x5165;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x4F9D;&#x8D56;</h2><p>&#x7531;&#x4E8E;&#x7CFB;&#x7EDF;&#x5DF2;&#x7ECF;&#x5168;&#x9762;&#x63A5;&#x5165;&#x963F;&#x91CC;&#x4E91;&#x65E5;&#x5FD7;&#x5E73;&#x53F0;&#xFF0C;&#x5E76;&#x4E14;&#x963F;&#x91CC;&#x4E91;&#x4E5F;&#x975E;&#x5E38;&#x6709;&#x597D;&#x7684;&#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;Flink&#x963F;&#x91CC;&#x4E91;Source&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EA;&#x8981;&#x5F15;&#x5165;&#x963F;&#x91CC;&#x4E91;&#x63D0;&#x4F9B;&#x7684;jar&#x5305;&#x5373;&#x53EF;&#xFF0C;&#x7701;&#x53BB;&#x4E86;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x7684;&#x529F;&#x592B;&#x3002;</p>\n<figure class=\"highlight yml hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">compile</span> <span class=\"hljs-string\">&quot;com.aliyun.openservices:flink-log-connector:0.1.3&quot;</span></span><br><span class=\"line\"><span class=\"hljs-string\">compile</span> <span class=\"hljs-string\">&quot;com.google.protobuf:protobuf-java:2.5.0&quot;</span></span><br><span class=\"line\"><span class=\"hljs-string\">compile</span> <span class=\"hljs-string\">&quot;com.aliyun.openservices:aliyun-log:0.6.10&quot;</span></span><br><span class=\"line\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">&#x7531;&#x4E8E;&#x5F53;&#x524D;&#x53EA;&#x662F;&#x7528;Source&#xFF0C;&#x6240;&#x4EE5;&#x4E0D;&#x5F15;&#x5165;Sink&#x6A21;&#x5757;</span></span><br><span class=\"line\"><span class=\"hljs-string\">//</span> <span class=\"hljs-string\">compile</span> <span class=\"hljs-string\">&quot;com.aliyun.openservices:log-loghub-producer:0.1.8&quot;</span> </span><br></pre></td></tr></tbody></table></figure>\n<p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x963F;&#x91CC;&#x4E91;&#x65E5;&#x5FD7;&#x901A;&#x8FC7;protobuf&#x534F;&#x8BAE;&#x8FDB;&#x884C;&#x5E8F;&#x5217;&#x5316;&#x4F20;&#x8F93;&#x3002;</p>\n<h2 id=\"&#x65E5;&#x5FD7;&#x5206;&#x6790;&#x542F;&#x52A8;&#x7C7B;\"><a href=\"#&#x65E5;&#x5FD7;&#x5206;&#x6790;&#x542F;&#x52A8;&#x7C7B;\" class=\"headerlink\" title=\"&#x65E5;&#x5FD7;&#x5206;&#x6790;&#x542F;&#x52A8;&#x7C7B;\"></a>&#x65E5;&#x5FD7;&#x5206;&#x6790;&#x542F;&#x52A8;&#x7C7B;</h2><p>&#x53C2;&#x8003;&#x5B98;&#x7F51;&#x6587;&#x6863;&#xFF0C;&#x6211;&#x4EEC;&#x914D;&#x7F6E;&#x4E86;&#x963F;&#x91CC;&#x4E91;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x7684;&#x94FE;&#x63A5;&#x5C5E;&#x6027;&#xFF0C;&#x6307;&#x5B9A;&#x4E86;&#x65E5;&#x5FD7;&#x6587;&#x4EF6;&#x3002;<br>&#x6B64;&#x5916;&#x6211;&#x4EEC;&#x8FD8;&#x5B9A;&#x4E49;&#x4E86;interval&#x53C2;&#x6570;&#x4E3A;&#x65E5;&#x5FD7;&#x95F4;&#x9694;&#xFF1B;threshold&#x4E3A;&#x9519;&#x8BEF;&#x6570;&#xFF1B;nameserverAddress&#x4E3A;&#x5C06;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x53D1;&#x9001;&#x81F3;RockerMQ&#x5730;&#x5740;&#x3002;&#x7ED3;&#x5408;&#x4E0A;&#x4E00;&#x7BC7;&#x6587;&#x4EF6;&#xFF0C;&#x5F02;&#x5E38;&#x63A8;&#x9001;&#x4EFB;&#x52A1;&#x4F1A;&#x5C06;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x901A;&#x8FC7;wechat&#x63A8;&#x9001;&#x7ED9;&#x5E72;&#x7CFB;&#x4EBA;&#x3002;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ParameterTool parameterTool = ParameterTool.fromArgs(args);</span><br><span class=\"line\">       String interval = parameterTool.get(<span class=\"hljs-string\">&quot;interval&quot;</span>);</span><br><span class=\"line\">       String threshold = parameterTool.get(<span class=\"hljs-string\">&quot;threshold&quot;</span>);</span><br><span class=\"line\">       String nameserverAddress = parameterTool.get(<span class=\"hljs-string\">&quot;nameserverAddress&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">       Properties configProps = <span class=\"hljs-keyword\">new</span> Properties();</span><br><span class=\"line\">       <span class=\"hljs-comment\">// &#x8BBE;&#x7F6E;&#x8BBF;&#x95EE;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x7684;&#x57DF;&#x540D;</span></span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_ENDPOINT, <span class=\"hljs-string\">&quot;xxxxxxxxxxxx&quot;</span>);</span><br><span class=\"line\">       <span class=\"hljs-comment\">// &#x8BBE;&#x7F6E;&#x8BBF;&#x95EE;ak</span></span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_ACCESSSKEYID, <span class=\"hljs-string\">&quot;xxxxxxxx&quot;</span>);</span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_ACCESSKEY, <span class=\"hljs-string\">&quot;xxxxxx&quot;</span>);</span><br><span class=\"line\">       <span class=\"hljs-comment\">// &#x8BBE;&#x7F6E;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x7684;project</span></span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_PROJECT, <span class=\"hljs-string\">&quot;xxxxxxx&quot;</span>);</span><br><span class=\"line\">       <span class=\"hljs-comment\">// &#x8BBE;&#x7F6E;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x7684;LogStore</span></span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_LOGSTORE, <span class=\"hljs-string\">&quot;xxxxxxxx&quot;</span>);</span><br><span class=\"line\">       <span class=\"hljs-comment\">// &#x8BBE;&#x7F6E;&#x6D88;&#x8D39;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x8D77;&#x59CB;&#x4F4D;&#x7F6E;</span></span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_CONSUMER_BEGIN_POSITION, Consts.LOG_END_CURSOR);</span><br><span class=\"line\">       <span class=\"hljs-comment\">// &#x8BBE;&#x7F6E;&#x65E5;&#x5FD7;&#x670D;&#x52A1;&#x7684;&#x6D88;&#x606F;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x65B9;&#x6CD5;</span></span><br><span class=\"line\">       RawLogGroupListDeserializer deserializer = <span class=\"hljs-keyword\">new</span> RawLogGroupListDeserializer();</span><br><span class=\"line\">       <span class=\"hljs-keyword\">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class=\"line\"></span><br><span class=\"line\">       Properties producerProps = <span class=\"hljs-keyword\">new</span> Properties();</span><br><span class=\"line\">       producerProps.setProperty(RocketMQConfig.NAME_SERVER_ADDR, nameserverAddress);</span><br><span class=\"line\"></span><br><span class=\"line\">       DataStream&lt;RawLogGroupList&gt; logTestStream = env.addSource(</span><br><span class=\"line\">               <span class=\"hljs-keyword\">new</span> FlinkLogConsumer&lt;RawLogGroupList&gt;(deserializer, configProps));</span><br></pre></td></tr></tbody></table></figure>\n\n<h3 id=\"&#x89E3;&#x6790;&#x963F;&#x91CC;&#x4E91;&#x65E5;&#x5FD7;&#x5E76;&#x8F6C;&#x6362;&#x4E3A;&#x65E5;&#x5FD7;&#x6D41;\"><a href=\"#&#x89E3;&#x6790;&#x963F;&#x91CC;&#x4E91;&#x65E5;&#x5FD7;&#x5E76;&#x8F6C;&#x6362;&#x4E3A;&#x65E5;&#x5FD7;&#x6D41;\" class=\"headerlink\" title=\"&#x89E3;&#x6790;&#x963F;&#x91CC;&#x4E91;&#x65E5;&#x5FD7;&#x5E76;&#x8F6C;&#x6362;&#x4E3A;&#x65E5;&#x5FD7;&#x6D41;\"></a>&#x89E3;&#x6790;&#x963F;&#x91CC;&#x4E91;&#x65E5;&#x5FD7;&#x5E76;&#x8F6C;&#x6362;&#x4E3A;&#x65E5;&#x5FD7;&#x6D41;</h3><figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SingleOutputStreamOperator&lt;LogInfo&gt; process = logTestStream</span><br><span class=\"line\">        .flatMap(<span class=\"hljs-keyword\">new</span> TransLogInfo())</span><br><span class=\"line\">        .keyBy(<span class=\"hljs-string\">&quot;podName&quot;</span>)</span><br><span class=\"line\">        .keyBy(<span class=\"hljs-string\">&quot;level&quot;</span>)</span><br><span class=\"line\">        .process(<span class=\"hljs-keyword\">new</span> SplitLeveProcess());</span><br></pre></td></tr></tbody></table></figure>\n\n<h4 id=\"&#x6211;&#x4EEC;&#x9996;&#x5148;&#x5B9E;&#x73B0;&#x4E86;FlatMapFunction&#x63A5;&#x53E3;&#xFF0C;&#x4E3A;&#x7684;&#x662F;&#x5C06;&#x963F;&#x91CC;&#x4E91;&#x7684;&#x65E5;&#x5FD7;&#x6D41;&#x7ED3;&#x6784;&#x89E3;&#x6790;&#x6210;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x60F3;&#x8981;&#x7684;&#x65E5;&#x5FD7;&#x7ED3;&#x6784;\"><a href=\"#&#x6211;&#x4EEC;&#x9996;&#x5148;&#x5B9E;&#x73B0;&#x4E86;FlatMapFunction&#x63A5;&#x53E3;&#xFF0C;&#x4E3A;&#x7684;&#x662F;&#x5C06;&#x963F;&#x91CC;&#x4E91;&#x7684;&#x65E5;&#x5FD7;&#x6D41;&#x7ED3;&#x6784;&#x89E3;&#x6790;&#x6210;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x60F3;&#x8981;&#x7684;&#x65E5;&#x5FD7;&#x7ED3;&#x6784;\" class=\"headerlink\" title=\"&#x6211;&#x4EEC;&#x9996;&#x5148;&#x5B9E;&#x73B0;&#x4E86;FlatMapFunction&#x63A5;&#x53E3;&#xFF0C;&#x4E3A;&#x7684;&#x662F;&#x5C06;&#x963F;&#x91CC;&#x4E91;&#x7684;&#x65E5;&#x5FD7;&#x6D41;&#x7ED3;&#x6784;&#x89E3;&#x6790;&#x6210;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x60F3;&#x8981;&#x7684;&#x65E5;&#x5FD7;&#x7ED3;&#x6784;\"></a>&#x6211;&#x4EEC;&#x9996;&#x5148;&#x5B9E;&#x73B0;&#x4E86;FlatMapFunction&#x63A5;&#x53E3;&#xFF0C;&#x4E3A;&#x7684;&#x662F;&#x5C06;&#x963F;&#x91CC;&#x4E91;&#x7684;&#x65E5;&#x5FD7;&#x6D41;&#x7ED3;&#x6784;&#x89E3;&#x6790;&#x6210;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x60F3;&#x8981;&#x7684;&#x65E5;&#x5FD7;&#x7ED3;&#x6784;</h4><figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">TransLogInfo</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">FlatMapFunction</span>&lt;<span class=\"hljs-title\">RawLogGroupList</span>, <span class=\"hljs-title\">LogInfo</span>&gt; </span>{</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">flatMap</span><span class=\"hljs-params\">(RawLogGroupList value, Collector&lt;LogInfo&gt; out)</span> <span class=\"hljs-keyword\">throws</span> Exception </span>{</span><br><span class=\"line\">        List&lt;RawLogGroup&gt; rawLogGroups = value.getRawLogGroups();</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span>(rawLogGroups != <span class=\"hljs-keyword\">null</span>){</span><br><span class=\"line\">            <span class=\"hljs-keyword\">for</span>(RawLogGroup rawLogGroup : rawLogGroups){</span><br><span class=\"line\">                String nodeIp = <span class=\"hljs-string\">&quot;&quot;</span>;</span><br><span class=\"line\">                Map&lt;String, String&gt; tags = rawLogGroup.getTags();</span><br><span class=\"line\">                <span class=\"hljs-keyword\">if</span>(tags != <span class=\"hljs-keyword\">null</span>){</span><br><span class=\"line\">                    nodeIp = tags.get(<span class=\"hljs-string\">&quot;_node_ip_&quot;</span>);</span><br><span class=\"line\">                }</span><br><span class=\"line\">                <span class=\"hljs-keyword\">if</span>(rawLogGroup != <span class=\"hljs-keyword\">null</span>){</span><br><span class=\"line\">                    List&lt;RawLog&gt; logs = rawLogGroup.getLogs();</span><br><span class=\"line\">                    <span class=\"hljs-keyword\">if</span>(!CollectionUtils.isEmpty(logs)){</span><br><span class=\"line\">                        <span class=\"hljs-keyword\">for</span>(RawLog log : logs){</span><br><span class=\"line\">                            <span class=\"hljs-keyword\">if</span>(log != <span class=\"hljs-keyword\">null</span>){</span><br><span class=\"line\">                                LogInfo logInfo = <span class=\"hljs-keyword\">new</span> LogInfo();</span><br><span class=\"line\">                                Map&lt;String, String&gt; contents = log.getContents();</span><br><span class=\"line\">                                <span class=\"hljs-keyword\">if</span>(contents != <span class=\"hljs-keyword\">null</span>){</span><br><span class=\"line\">                                    logInfo.setNodeIp(nodeIp);</span><br><span class=\"line\">                                    logInfo.setReceiveTime(contents.get(<span class=\"hljs-string\">&quot;@timestamp&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setLevel(contents.get(<span class=\"hljs-string\">&quot;_level&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setAccountId(contents.get(<span class=\"hljs-string\">&quot;accountId&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setPodName(contents.get(<span class=\"hljs-string\">&quot;_pod_name_&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setTraceId(contents.get(<span class=\"hljs-string\">&quot;traceId&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setMessage(contents.get(<span class=\"hljs-string\">&quot;nte_message&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setAppName(contents.get(<span class=\"hljs-string\">&quot;appName&quot;</span>));</span><br><span class=\"line\">                                }</span><br><span class=\"line\">                                out.collect(logInfo);</span><br><span class=\"line\">                            }</span><br><span class=\"line\">                        }</span><br><span class=\"line\">                    }</span><br><span class=\"line\">                }</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br></pre></td></tr></tbody></table></figure>\n<h4 id=\"&#x5C06;&#x89E3;&#x6790;&#x540E;&#x7684;&#x65E5;&#x5FD7;&#x6D41;&#x6309;&#x7167;&#x5BB9;&#x5668;&#x540D;&#x548C;&#x65E5;&#x5FD7;&#x7B49;&#x7EA7;&#x5206;&#x7EC4;-&#x5982;&#x679C;&#x53EA;&#x662F;&#x60F3;&#x5904;&#x7406;ERROR&#x7EA7;&#x522B;&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x7528;Filter&#x5BF9;level&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;\"><a href=\"#&#x5C06;&#x89E3;&#x6790;&#x540E;&#x7684;&#x65E5;&#x5FD7;&#x6D41;&#x6309;&#x7167;&#x5BB9;&#x5668;&#x540D;&#x548C;&#x65E5;&#x5FD7;&#x7B49;&#x7EA7;&#x5206;&#x7EC4;-&#x5982;&#x679C;&#x53EA;&#x662F;&#x60F3;&#x5904;&#x7406;ERROR&#x7EA7;&#x522B;&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x7528;Filter&#x5BF9;level&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;\" class=\"headerlink\" title=\"&#x5C06;&#x89E3;&#x6790;&#x540E;&#x7684;&#x65E5;&#x5FD7;&#x6D41;&#x6309;&#x7167;&#x5BB9;&#x5668;&#x540D;&#x548C;&#x65E5;&#x5FD7;&#x7B49;&#x7EA7;&#x5206;&#x7EC4;(&#x5982;&#x679C;&#x53EA;&#x662F;&#x60F3;&#x5904;&#x7406;ERROR&#x7EA7;&#x522B;&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x7528;Filter&#x5BF9;level&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;)\"></a>&#x5C06;&#x89E3;&#x6790;&#x540E;&#x7684;&#x65E5;&#x5FD7;&#x6D41;&#x6309;&#x7167;&#x5BB9;&#x5668;&#x540D;&#x548C;&#x65E5;&#x5FD7;&#x7B49;&#x7EA7;&#x5206;&#x7EC4;(&#x5982;&#x679C;&#x53EA;&#x662F;&#x60F3;&#x5904;&#x7406;ERROR&#x7EA7;&#x522B;&#x7684;&#x9519;&#x8BEF;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x7528;Filter&#x5BF9;level&#x8FDB;&#x884C;&#x8FC7;&#x6EE4;)</h4><h4 id=\"&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x4E86;KeyedProcessFunction&#x63A5;&#x53E3;&#xFF0C;&#x5C06;ERROR&#x65E5;&#x5FD7;&#x5206;&#x6D41;&#x8FDB;&#x884C;&#x5904;&#x7406;\"><a href=\"#&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x4E86;KeyedProcessFunction&#x63A5;&#x53E3;&#xFF0C;&#x5C06;ERROR&#x65E5;&#x5FD7;&#x5206;&#x6D41;&#x8FDB;&#x884C;&#x5904;&#x7406;\" class=\"headerlink\" title=\"&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x4E86;KeyedProcessFunction&#x63A5;&#x53E3;&#xFF0C;&#x5C06;ERROR&#x65E5;&#x5FD7;&#x5206;&#x6D41;&#x8FDB;&#x884C;&#x5904;&#x7406;\"></a>&#x6211;&#x4EEC;&#x5B9E;&#x73B0;&#x4E86;KeyedProcessFunction&#x63A5;&#x53E3;&#xFF0C;&#x5C06;ERROR&#x65E5;&#x5FD7;&#x5206;&#x6D41;&#x8FDB;&#x884C;&#x5904;&#x7406;</h4><figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SplitLeveProcess</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">KeyedProcessFunction</span>&lt;<span class=\"hljs-title\">Tuple</span>, <span class=\"hljs-title\">LogInfo</span>, <span class=\"hljs-title\">LogInfo</span>&gt; </span>{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> String LEVEL_INOF = <span class=\"hljs-string\">&quot;INFO&quot;</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">final</span> String LEVEL_ERROR = <span class=\"hljs-string\">&quot;ERROR&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">final</span> OutputTag&lt;LogInfo&gt; outputTag = <span class=\"hljs-keyword\">new</span> OutputTag&lt;LogInfo&gt;(<span class=\"hljs-string\">&quot;error-log&quot;</span>){};</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">processElement</span><span class=\"hljs-params\">(LogInfo value, Context ctx, Collector&lt;LogInfo&gt; out)</span> <span class=\"hljs-keyword\">throws</span> Exception </span>{</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span>(LEVEL_INOF.equals(value.getLevel())){</span><br><span class=\"line\">            out.collect(value);</span><br><span class=\"line\">        }<span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span>(LEVEL_ERROR.equals(value.getLevel())){</span><br><span class=\"line\">            ctx.output(outputTag,value);</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h4 id=\"&#x5F97;&#x5230;ERROR&#x65E5;&#x5FD7;&#x4FA7;&#x8F93;&#x51FA;&#x6D41;&#xFF0C;&#x5904;&#x7406;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x6D41;\"><a href=\"#&#x5F97;&#x5230;ERROR&#x65E5;&#x5FD7;&#x4FA7;&#x8F93;&#x51FA;&#x6D41;&#xFF0C;&#x5904;&#x7406;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x6D41;\" class=\"headerlink\" title=\"&#x5F97;&#x5230;ERROR&#x65E5;&#x5FD7;&#x4FA7;&#x8F93;&#x51FA;&#x6D41;&#xFF0C;&#x5904;&#x7406;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x6D41;\"></a>&#x5F97;&#x5230;ERROR&#x65E5;&#x5FD7;&#x4FA7;&#x8F93;&#x51FA;&#x6D41;&#xFF0C;&#x5904;&#x7406;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x6D41;</h4><figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">        DataStream&lt;LogInfo&gt; errorStream = process.getSideOutput(<span class=\"hljs-keyword\">new</span> OutputTag&lt;LogInfo&gt;(<span class=\"hljs-string\">&quot;error-log&quot;</span>){});</span><br><span class=\"line\">        errorStream.keyBy(<span class=\"hljs-string\">&quot;podName&quot;</span>).process(<span class=\"hljs-keyword\">new</span> ErrorProcess(Long.valueOf(interval) * <span class=\"hljs-number\">1000</span>,Integer.valueOf(threshold)))</span><br><span class=\"line\"><span class=\"hljs-comment\">//                .setParallelism(4)</span></span><br><span class=\"line\">                .map(<span class=\"hljs-keyword\">new</span> ToMessage())</span><br><span class=\"line\">                .addSink(<span class=\"hljs-keyword\">new</span> RocketMQSink(<span class=\"hljs-keyword\">new</span> SimpleKeyValueSerializationSchema(<span class=\"hljs-keyword\">null</span>, <span class=\"hljs-string\">&quot;body&quot;</span>),</span><br><span class=\"line\">                        <span class=\"hljs-keyword\">new</span> DefaultTopicSelector(topic), producerProps).withBatchFlushOnCheckpoint(<span class=\"hljs-keyword\">true</span>));</span><br></pre></td></tr></tbody></table></figure>\n\n<h4 id=\"&#x9488;&#x5BF9;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x5904;&#x7406;&#xFF0C;&#x540C;&#x6837;&#x5B9E;&#x73B0;&#x4E86;KeyedProcessFunction&#x63A5;&#x53E3;&#xFF0C;&#x901A;&#x8FC7;&#x6CE8;&#x518C;&#x5B9A;&#x65F6;&#x5668;&#x5224;&#x65AD;interval&#x5468;&#x671F;&#x5185;&#xFF0C;&#x9519;&#x8BEF;&#x6570;&#x91CF;&#x662F;&#x5426;&#x8D85;&#x8FC7;threshold&#x3002;&#x5982;&#x679C;&#x8D85;&#x8FC7;&#x5219;&#x8F93;&#x51FA;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x6D41;&#xFF0C;&#x4EA4;&#x7531;&#x540E;&#x9762;&#x7684;&#x7B97;&#x5B50;&#x5904;&#x7406;\"><a href=\"#&#x9488;&#x5BF9;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x5904;&#x7406;&#xFF0C;&#x540C;&#x6837;&#x5B9E;&#x73B0;&#x4E86;KeyedProcessFunction&#x63A5;&#x53E3;&#xFF0C;&#x901A;&#x8FC7;&#x6CE8;&#x518C;&#x5B9A;&#x65F6;&#x5668;&#x5224;&#x65AD;interval&#x5468;&#x671F;&#x5185;&#xFF0C;&#x9519;&#x8BEF;&#x6570;&#x91CF;&#x662F;&#x5426;&#x8D85;&#x8FC7;threshold&#x3002;&#x5982;&#x679C;&#x8D85;&#x8FC7;&#x5219;&#x8F93;&#x51FA;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x6D41;&#xFF0C;&#x4EA4;&#x7531;&#x540E;&#x9762;&#x7684;&#x7B97;&#x5B50;&#x5904;&#x7406;\" class=\"headerlink\" title=\"&#x9488;&#x5BF9;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x5904;&#x7406;&#xFF0C;&#x540C;&#x6837;&#x5B9E;&#x73B0;&#x4E86;KeyedProcessFunction&#x63A5;&#x53E3;&#xFF0C;&#x901A;&#x8FC7;&#x6CE8;&#x518C;&#x5B9A;&#x65F6;&#x5668;&#x5224;&#x65AD;interval&#x5468;&#x671F;&#x5185;&#xFF0C;&#x9519;&#x8BEF;&#x6570;&#x91CF;&#x662F;&#x5426;&#x8D85;&#x8FC7;threshold&#x3002;&#x5982;&#x679C;&#x8D85;&#x8FC7;&#x5219;&#x8F93;&#x51FA;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x6D41;&#xFF0C;&#x4EA4;&#x7531;&#x540E;&#x9762;&#x7684;&#x7B97;&#x5B50;&#x5904;&#x7406;\"></a>&#x9488;&#x5BF9;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x5904;&#x7406;&#xFF0C;&#x540C;&#x6837;&#x5B9E;&#x73B0;&#x4E86;KeyedProcessFunction&#x63A5;&#x53E3;&#xFF0C;&#x901A;&#x8FC7;&#x6CE8;&#x518C;&#x5B9A;&#x65F6;&#x5668;&#x5224;&#x65AD;interval&#x5468;&#x671F;&#x5185;&#xFF0C;&#x9519;&#x8BEF;&#x6570;&#x91CF;&#x662F;&#x5426;&#x8D85;&#x8FC7;threshold&#x3002;&#x5982;&#x679C;&#x8D85;&#x8FC7;&#x5219;&#x8F93;&#x51FA;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x6D41;&#xFF0C;&#x4EA4;&#x7531;&#x540E;&#x9762;&#x7684;&#x7B97;&#x5B50;&#x5904;&#x7406;</h4><figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ErrorProcess</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">KeyedProcessFunction</span>&lt;<span class=\"hljs-title\">Tuple</span>, <span class=\"hljs-title\">LogInfo</span>, <span class=\"hljs-title\">AlertInfo</span>&gt; </span>{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">long</span> interval;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">int</span> threshold;</span><br><span class=\"line\"><span class=\"hljs-comment\">//    private transient SendWechatService sendWechatService;</span></span><br><span class=\"line\">    ValueState&lt;Integer&gt; cnt ;</span><br><span class=\"line\">    ValueState&lt;Long&gt; timer ;</span><br><span class=\"line\">    ValueState&lt;String&gt; pod ;</span><br><span class=\"line\">    ValueState&lt;List&gt; errorMsg ;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-title\">ErrorProcess</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">long</span> interval,<span class=\"hljs-keyword\">int</span> threshold)</span></span>{</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.interval = interval;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.threshold = threshold;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">open</span><span class=\"hljs-params\">(Configuration parameters)</span> <span class=\"hljs-keyword\">throws</span> Exception </span>{</span><br><span class=\"line\">        <span class=\"hljs-keyword\">super</span>.open(parameters);</span><br><span class=\"line\">        cnt = getRuntimeContext().getState(<span class=\"hljs-keyword\">new</span> ValueStateDescriptor&lt;Integer&gt;(<span class=\"hljs-string\">&quot;cnt&quot;</span>,Integer.class,<span class=\"hljs-number\">0</span>));</span><br><span class=\"line\">        timer = getRuntimeContext().getState(<span class=\"hljs-keyword\">new</span> ValueStateDescriptor&lt;Long&gt;(<span class=\"hljs-string\">&quot;timer&quot;</span>,Long.class));</span><br><span class=\"line\">        pod = getRuntimeContext().getState(<span class=\"hljs-keyword\">new</span> ValueStateDescriptor&lt;String&gt;(<span class=\"hljs-string\">&quot;pod&quot;</span>,String.class));</span><br><span class=\"line\">        errorMsg = getRuntimeContext().getState(<span class=\"hljs-keyword\">new</span> ValueStateDescriptor&lt;&gt;(<span class=\"hljs-string\">&quot;errorMsg&quot;</span>,List.class));</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">processElement</span><span class=\"hljs-params\">(LogInfo value, Context ctx, Collector&lt;AlertInfo&gt; out)</span> <span class=\"hljs-keyword\">throws</span> Exception </span>{</span><br><span class=\"line\">        pod.update(value.getPodName());</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-string\">&quot;ERROR&quot;</span>.equals(value.getLevel())){</span><br><span class=\"line\">            <span class=\"hljs-keyword\">if</span>(timer.value() == <span class=\"hljs-keyword\">null</span>){</span><br><span class=\"line\">                ctx.timerService().registerProcessingTimeTimer(ctx.timerService().currentProcessingTime() + interval);</span><br><span class=\"line\">            }</span><br><span class=\"line\">            cnt.update(cnt.value() + <span class=\"hljs-number\">1</span>);</span><br><span class=\"line\">            List em = errorMsg.value();</span><br><span class=\"line\">            <span class=\"hljs-keyword\">if</span>(em == <span class=\"hljs-keyword\">null</span>){</span><br><span class=\"line\">                em = <span class=\"hljs-keyword\">new</span> ArrayList();</span><br><span class=\"line\">            }</span><br><span class=\"line\">            em.add(value.getMessage());</span><br><span class=\"line\">            errorMsg.update(em);</span><br><span class=\"line\">        }<span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">if</span>(timer.value() != <span class=\"hljs-keyword\">null</span>){</span><br><span class=\"line\">                ctx.timerService().deleteEventTimeTimer(timer.value());</span><br><span class=\"line\">                cnt.clear();</span><br><span class=\"line\">                timer.clear();</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">onTimer</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">long</span> timestamp, OnTimerContext ctx, Collector&lt;AlertInfo&gt; out)</span> <span class=\"hljs-keyword\">throws</span> Exception </span>{</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span>(cnt.value() &gt;=threshold){</span><br><span class=\"line\">            AlertInfo alertInfo = <span class=\"hljs-keyword\">new</span> AlertInfo();</span><br><span class=\"line\">            alertInfo.setErrorCnt(cnt.value());</span><br><span class=\"line\">            alertInfo.setLevel(<span class=\"hljs-string\">&quot;ERROR&quot;</span>);</span><br><span class=\"line\">            alertInfo.setPodName(pod.value());</span><br><span class=\"line\">            alertInfo.setMg(errorMsg.value());</span><br><span class=\"line\">            String content = <span class=\"hljs-string\">&quot;In &quot;</span> + interval/<span class=\"hljs-number\">1000</span> + <span class=\"hljs-string\">&quot; seconds, pod[&quot;</span> + pod.value()  + <span class=\"hljs-string\">&quot;] over &quot;</span> + threshold + <span class=\"hljs-string\">&quot; error happened ,error count[&quot;</span> + cnt.value() + <span class=\"hljs-string\">&quot;]    detail:&quot;</span> + <span class=\"hljs-string\">&quot;\\n&quot;</span>  + <span class=\"hljs-string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">            <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-keyword\">int</span> i = <span class=\"hljs-number\">1</span> ;i&lt;=errorMsg.value().size();i++){</span><br><span class=\"line\">                content = content + <span class=\"hljs-string\">&quot;[&quot;</span> + i + <span class=\"hljs-string\">&quot;]&quot;</span> + errorMsg.value().get(i-<span class=\"hljs-number\">1</span>) + <span class=\"hljs-string\">&quot;  &quot;</span> + <span class=\"hljs-string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">            }</span><br><span class=\"line\">            alertInfo.setContent(content);</span><br><span class=\"line\">            out.collect(alertInfo);</span><br><span class=\"line\"></span><br><span class=\"line\">        }</span><br><span class=\"line\">        cnt.clear();</span><br><span class=\"line\">        timer.clear();</span><br><span class=\"line\">        errorMsg.clear();</span><br><span class=\"line\">    }</span><br></pre></td></tr></tbody></table></figure>\n\n<h4 id=\"&#x540E;&#x7EED;&#x7B97;&#x5B50;&#x5C06;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x6D41;&#x8F6C;&#x6362;&#x6210;&#x6307;&#x5B9A;&#x7ED3;&#x6784;&#xFF0C;&#x5E76;&#x53D1;&#x7ED9;RocketMQ&#x7684;Sink&#xFF0C;&#x4EA4;&#x7531;&#x9519;&#x8BEF;&#x63A8;&#x9001;&#x4EFB;&#x52A1;&#x8FDB;&#x884C;wechat&#x63A8;&#x9001;&#x3002;\"><a href=\"#&#x540E;&#x7EED;&#x7B97;&#x5B50;&#x5C06;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x6D41;&#x8F6C;&#x6362;&#x6210;&#x6307;&#x5B9A;&#x7ED3;&#x6784;&#xFF0C;&#x5E76;&#x53D1;&#x7ED9;RocketMQ&#x7684;Sink&#xFF0C;&#x4EA4;&#x7531;&#x9519;&#x8BEF;&#x63A8;&#x9001;&#x4EFB;&#x52A1;&#x8FDB;&#x884C;wechat&#x63A8;&#x9001;&#x3002;\" class=\"headerlink\" title=\"&#x540E;&#x7EED;&#x7B97;&#x5B50;&#x5C06;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x6D41;&#x8F6C;&#x6362;&#x6210;&#x6307;&#x5B9A;&#x7ED3;&#x6784;&#xFF0C;&#x5E76;&#x53D1;&#x7ED9;RocketMQ&#x7684;Sink&#xFF0C;&#x4EA4;&#x7531;&#x9519;&#x8BEF;&#x63A8;&#x9001;&#x4EFB;&#x52A1;&#x8FDB;&#x884C;wechat&#x63A8;&#x9001;&#x3002;\"></a>&#x540E;&#x7EED;&#x7B97;&#x5B50;&#x5C06;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x6D41;&#x8F6C;&#x6362;&#x6210;&#x6307;&#x5B9A;&#x7ED3;&#x6784;&#xFF0C;&#x5E76;&#x53D1;&#x7ED9;RocketMQ&#x7684;Sink&#xFF0C;&#x4EA4;&#x7531;&#x9519;&#x8BEF;&#x63A8;&#x9001;&#x4EFB;&#x52A1;&#x8FDB;&#x884C;wechat&#x63A8;&#x9001;&#x3002;</h4><figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ToMessage</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">MapFunction</span>&lt;<span class=\"hljs-title\">AlertInfo</span>, <span class=\"hljs-title\">String</span>&gt; </span>{</span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> String <span class=\"hljs-title\">map</span><span class=\"hljs-params\">(AlertInfo value)</span> <span class=\"hljs-keyword\">throws</span> Exception </span>{</span><br><span class=\"line\">        JSONObject messageBody = <span class=\"hljs-keyword\">new</span> JSONObject();</span><br><span class=\"line\">        messageBody.put(<span class=\"hljs-string\">&quot;alertMsg&quot;</span>,value.getContent());</span><br><span class=\"line\">        messageBody.put(<span class=\"hljs-string\">&quot;alertTo&quot;</span>,<span class=\"hljs-string\">&quot;xxxxx&quot;</span>);</span><br><span class=\"line\">        messageBody.put(<span class=\"hljs-string\">&quot;bizType&quot;</span>,<span class=\"hljs-string\">&quot;&quot;</span>);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> messageBody.toJSONString();</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"&#x603B;&#x7ED3;\"><a href=\"#&#x603B;&#x7ED3;\" class=\"headerlink\" title=\"&#x603B;&#x7ED3;\"></a>&#x603B;&#x7ED3;</h2><p>&#x4EE5;&#x4E0A;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x5206;&#x6790;&#x53CA;&#x62A5;&#x8B66;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x4E0B;&#x6B21;&#x6211;&#x4EEC;&#x9488;&#x5BF9;&#x8FD9;&#x4E2A;&#x6D41;&#x7A0B;&#x518D;&#x5199;&#x4E00;&#x7BC7;&#x6D4B;&#x8BD5;&#x6587;&#x3002;&#x540C;&#x65F6;&#x8FD9;&#x4E2A;&#x6D41;&#x7A0B;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x5BF9;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x6D41;&#x91C7;&#x7528;&#x7684;&#x662F;&#x4FA7;&#x6D41;&#x8F93;&#x51FA;&#x3002;&#x6240;&#x4EE5;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x4E3B;&#x6D41;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x6709;&#x5F88;&#x591A;&#x6B63;&#x5E38;&#x65E5;&#x5FD7;&#x503C;&#x5F97;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x548C;&#x6316;&#x6398;&#xFF0C;&#x540E;&#x9762;&#x6211;&#x4EEC;&#x4E5F;&#x4F1A;&#x56F4;&#x7ED5;&#x8FD9;&#x4E9B;&#x65E5;&#x5FD7;&#x6765;&#x505A;&#x4E9B;&#x6709;&#x610F;&#x601D;&#x7684;&#x4E1C;&#x897F;&#xFF0C;&#x90A3;&#x8FD9;&#x4E00;&#x6B21;&#x6211;&#x4EEC;&#x5C31;&#x5148;&#x5230;&#x8FD9;&#x4E86;&#x3002;</p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Flink","path":"tags/Flink/"},{"name":"监控","path":"tags/监控/"}],"excerpt":"<html><head></head><body><h2 id=\"&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;\"><a href=\"#&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;\" class=\"headerlink\" title=\"&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;\"></a>&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;</h2><p>&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;&#x7ECF;&#x5E38;&#x4F1A;&#x63A5;&#x5165;&#x5404;&#x79CD;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x6216;APM&#x7CFB;&#x7EDF;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x751F;&#x4EA7;&#x95EE;&#x9898;&#x7684;&#x5FEB;&#x901F;&#x62A5;&#x8B66;&#x548C;&#x5B9A;&#x4F4D;&#x3002;&#x6BD4;&#x5982;CAT&#x3001;PingPong&#x3001;skywalking&#x7B49;&#xFF0C;&#x867D;&#x7136;&#x5B9E;&#x73B0;&#x539F;&#x7406;&#x548C;&#x67B6;&#x6784;&#x7565;&#x6709;&#x4E0D;&#x540C;&#xFF0C;&#x4F46;&#x90FD;&#x4E3A;&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x4E86;&#x8C03;&#x7528;&#x94FE;&#x8DDF;&#x8E2A;&#x3001;&#x5F02;&#x5E38;&#x65E5;&#x5FD7;&#x3001;DB&#x5F02;&#x5E38;&#x3001;&#x8FDE;&#x63A5;&#x8D85;&#x65F6;&#x3001;JVM&#x4FE1;&#x606F;&#x7B49;&#x62A5;&#x8B66;&#x3002;&#x751A;&#x81F3;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x76D1;&#x63A7;&#x5E73;&#x53F0;&#x4E0A;&#x5B9A;&#x5236;&#x81EA;&#x5DF1;&#x7684;&#x62A5;&#x8B66;&#x89C4;&#x5219;&#xFF0C;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x4F1A;&#x6839;&#x636E;&#x89C4;&#x5219;&#x5411;&#x5173;&#x7CFB;&#x4EBA;&#x63D0;&#x4F9B;&#x62A5;&#x8B66;&#x4FE1;&#x606F;&#x3002;</p>\n<p>&#x4EE5;&#x4E0A;&#x90FD;&#x662F;&#x57FA;&#x4E8E;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x63D0;&#x4F9B;&#x7684;&#x529F;&#x80FD;&#x5B9E;&#x73B0;&#x5404;&#x4E2A;&#x7EF4;&#x5EA6;&#x7684;&#x62A5;&#x8B66;&#x3002;&#x6700;&#x8FD1;&#x5728;&#x636F;&#x996C;Flink&#xFF0C;&#x6240;&#x4EE5;&#x60F3;&#x80FD;&#x5426;&#x7528;Flink&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;&#x65E5;&#x5FD7;&#x5F02;&#x5E38;&#x62A5;&#x8B66;&#x3002;&#x8BDD;&#x4E0D;&#x591A;&#x8BF4;&#xFF0C;&#x5F00;&#x59CB;&#x64B8;&#x4EE3;&#x7801;&#x3002;</p></body></html>","more":"<h2 id=\"引入日志服务依赖\"><a href=\"#引入日志服务依赖\" class=\"headerlink\" title=\"引入日志服务依赖\"></a>引入日志服务依赖</h2><p>由于系统已经全面接入阿里云日志平台，并且阿里云也非常有好的为我们提供了Flink阿里云Source的实现，所以我们只要引入阿里云提供的jar包即可，省去了自己实现的功夫。</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">compile</span> <span class=\"string\">&quot;com.aliyun.openservices:flink-log-connector:0.1.3&quot;</span></span><br><span class=\"line\"><span class=\"string\">compile</span> <span class=\"string\">&quot;com.google.protobuf:protobuf-java:2.5.0&quot;</span></span><br><span class=\"line\"><span class=\"string\">compile</span> <span class=\"string\">&quot;com.aliyun.openservices:aliyun-log:0.6.10&quot;</span></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">由于当前只是用Source，所以不引入Sink模块</span></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">compile</span> <span class=\"string\">&quot;com.aliyun.openservices:log-loghub-producer:0.1.8&quot;</span> </span><br></pre></td></tr></table></figure>\n<p>可以看到，阿里云日志通过protobuf协议进行序列化传输。</p>\n<h2 id=\"日志分析启动类\"><a href=\"#日志分析启动类\" class=\"headerlink\" title=\"日志分析启动类\"></a>日志分析启动类</h2><p>参考官网文档，我们配置了阿里云日志服务的链接属性，指定了日志文件。<br>此外我们还定义了interval参数为日志间隔；threshold为错误数；nameserverAddress为将错误信息发送至RockerMQ地址。结合上一篇文件，异常推送任务会将错误信息通过wechat推送给干系人。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ParameterTool parameterTool = ParameterTool.fromArgs(args);</span><br><span class=\"line\">       String interval = parameterTool.get(<span class=\"string\">&quot;interval&quot;</span>);</span><br><span class=\"line\">       String threshold = parameterTool.get(<span class=\"string\">&quot;threshold&quot;</span>);</span><br><span class=\"line\">       String nameserverAddress = parameterTool.get(<span class=\"string\">&quot;nameserverAddress&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">       Properties configProps = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">       <span class=\"comment\">// 设置访问日志服务的域名</span></span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_ENDPOINT, <span class=\"string\">&quot;xxxxxxxxxxxx&quot;</span>);</span><br><span class=\"line\">       <span class=\"comment\">// 设置访问ak</span></span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_ACCESSSKEYID, <span class=\"string\">&quot;xxxxxxxx&quot;</span>);</span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_ACCESSKEY, <span class=\"string\">&quot;xxxxxx&quot;</span>);</span><br><span class=\"line\">       <span class=\"comment\">// 设置日志服务的project</span></span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_PROJECT, <span class=\"string\">&quot;xxxxxxx&quot;</span>);</span><br><span class=\"line\">       <span class=\"comment\">// 设置日志服务的LogStore</span></span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_LOGSTORE, <span class=\"string\">&quot;xxxxxxxx&quot;</span>);</span><br><span class=\"line\">       <span class=\"comment\">// 设置消费日志服务起始位置</span></span><br><span class=\"line\">       configProps.put(ConfigConstants.LOG_CONSUMER_BEGIN_POSITION, Consts.LOG_END_CURSOR);</span><br><span class=\"line\">       <span class=\"comment\">// 设置日志服务的消息反序列化方法</span></span><br><span class=\"line\">       RawLogGroupListDeserializer deserializer = <span class=\"keyword\">new</span> RawLogGroupListDeserializer();</span><br><span class=\"line\">       <span class=\"keyword\">final</span> StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class=\"line\"></span><br><span class=\"line\">       Properties producerProps = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">       producerProps.setProperty(RocketMQConfig.NAME_SERVER_ADDR, nameserverAddress);</span><br><span class=\"line\"></span><br><span class=\"line\">       DataStream&lt;RawLogGroupList&gt; logTestStream = env.addSource(</span><br><span class=\"line\">               <span class=\"keyword\">new</span> FlinkLogConsumer&lt;RawLogGroupList&gt;(deserializer, configProps));</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"解析阿里云日志并转换为日志流\"><a href=\"#解析阿里云日志并转换为日志流\" class=\"headerlink\" title=\"解析阿里云日志并转换为日志流\"></a>解析阿里云日志并转换为日志流</h3><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SingleOutputStreamOperator&lt;LogInfo&gt; process = logTestStream</span><br><span class=\"line\">        .flatMap(<span class=\"keyword\">new</span> TransLogInfo())</span><br><span class=\"line\">        .keyBy(<span class=\"string\">&quot;podName&quot;</span>)</span><br><span class=\"line\">        .keyBy(<span class=\"string\">&quot;level&quot;</span>)</span><br><span class=\"line\">        .process(<span class=\"keyword\">new</span> SplitLeveProcess());</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"我们首先实现了FlatMapFunction接口，为的是将阿里云的日志流结构解析成我们自己想要的日志结构\"><a href=\"#我们首先实现了FlatMapFunction接口，为的是将阿里云的日志流结构解析成我们自己想要的日志结构\" class=\"headerlink\" title=\"我们首先实现了FlatMapFunction接口，为的是将阿里云的日志流结构解析成我们自己想要的日志结构\"></a>我们首先实现了FlatMapFunction接口，为的是将阿里云的日志流结构解析成我们自己想要的日志结构</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TransLogInfo</span> <span class=\"keyword\">implements</span> <span class=\"title\">FlatMapFunction</span>&lt;<span class=\"title\">RawLogGroupList</span>, <span class=\"title\">LogInfo</span>&gt; </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">flatMap</span><span class=\"params\">(RawLogGroupList value, Collector&lt;LogInfo&gt; out)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        List&lt;RawLogGroup&gt; rawLogGroups = value.getRawLogGroups();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(rawLogGroups != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">for</span>(RawLogGroup rawLogGroup : rawLogGroups)&#123;</span><br><span class=\"line\">                String nodeIp = <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">                Map&lt;String, String&gt; tags = rawLogGroup.getTags();</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(tags != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                    nodeIp = tags.get(<span class=\"string\">&quot;_node_ip_&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(rawLogGroup != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                    List&lt;RawLog&gt; logs = rawLogGroup.getLogs();</span><br><span class=\"line\">                    <span class=\"keyword\">if</span>(!CollectionUtils.isEmpty(logs))&#123;</span><br><span class=\"line\">                        <span class=\"keyword\">for</span>(RawLog log : logs)&#123;</span><br><span class=\"line\">                            <span class=\"keyword\">if</span>(log != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                                LogInfo logInfo = <span class=\"keyword\">new</span> LogInfo();</span><br><span class=\"line\">                                Map&lt;String, String&gt; contents = log.getContents();</span><br><span class=\"line\">                                <span class=\"keyword\">if</span>(contents != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                                    logInfo.setNodeIp(nodeIp);</span><br><span class=\"line\">                                    logInfo.setReceiveTime(contents.get(<span class=\"string\">&quot;@timestamp&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setLevel(contents.get(<span class=\"string\">&quot;_level&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setAccountId(contents.get(<span class=\"string\">&quot;accountId&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setPodName(contents.get(<span class=\"string\">&quot;_pod_name_&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setTraceId(contents.get(<span class=\"string\">&quot;traceId&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setMessage(contents.get(<span class=\"string\">&quot;nte_message&quot;</span>));</span><br><span class=\"line\">                                    logInfo.setAppName(contents.get(<span class=\"string\">&quot;appName&quot;</span>));</span><br><span class=\"line\">                                &#125;</span><br><span class=\"line\">                                out.collect(logInfo);</span><br><span class=\"line\">                            &#125;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"将解析后的日志流按照容器名和日志等级分组-如果只是想处理ERROR级别的错误，也可以用Filter对level进行过滤\"><a href=\"#将解析后的日志流按照容器名和日志等级分组-如果只是想处理ERROR级别的错误，也可以用Filter对level进行过滤\" class=\"headerlink\" title=\"将解析后的日志流按照容器名和日志等级分组(如果只是想处理ERROR级别的错误，也可以用Filter对level进行过滤)\"></a>将解析后的日志流按照容器名和日志等级分组(如果只是想处理ERROR级别的错误，也可以用Filter对level进行过滤)</h4><h4 id=\"我们实现了KeyedProcessFunction接口，将ERROR日志分流进行处理\"><a href=\"#我们实现了KeyedProcessFunction接口，将ERROR日志分流进行处理\" class=\"headerlink\" title=\"我们实现了KeyedProcessFunction接口，将ERROR日志分流进行处理\"></a>我们实现了KeyedProcessFunction接口，将ERROR日志分流进行处理</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SplitLeveProcess</span> <span class=\"keyword\">extends</span> <span class=\"title\">KeyedProcessFunction</span>&lt;<span class=\"title\">Tuple</span>, <span class=\"title\">LogInfo</span>, <span class=\"title\">LogInfo</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String LEVEL_INOF = <span class=\"string\">&quot;INFO&quot;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> String LEVEL_ERROR = <span class=\"string\">&quot;ERROR&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">final</span> OutputTag&lt;LogInfo&gt; outputTag = <span class=\"keyword\">new</span> OutputTag&lt;LogInfo&gt;(<span class=\"string\">&quot;error-log&quot;</span>)&#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">processElement</span><span class=\"params\">(LogInfo value, Context ctx, Collector&lt;LogInfo&gt; out)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(LEVEL_INOF.equals(value.getLevel()))&#123;</span><br><span class=\"line\">            out.collect(value);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(LEVEL_ERROR.equals(value.getLevel()))&#123;</span><br><span class=\"line\">            ctx.output(outputTag,value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"得到ERROR日志侧输出流，处理错误日志流\"><a href=\"#得到ERROR日志侧输出流，处理错误日志流\" class=\"headerlink\" title=\"得到ERROR日志侧输出流，处理错误日志流\"></a>得到ERROR日志侧输出流，处理错误日志流</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">        DataStream&lt;LogInfo&gt; errorStream = process.getSideOutput(<span class=\"keyword\">new</span> OutputTag&lt;LogInfo&gt;(<span class=\"string\">&quot;error-log&quot;</span>)&#123;&#125;);</span><br><span class=\"line\">        errorStream.keyBy(<span class=\"string\">&quot;podName&quot;</span>).process(<span class=\"keyword\">new</span> ErrorProcess(Long.valueOf(interval) * <span class=\"number\">1000</span>,Integer.valueOf(threshold)))</span><br><span class=\"line\"><span class=\"comment\">//                .setParallelism(4)</span></span><br><span class=\"line\">                .map(<span class=\"keyword\">new</span> ToMessage())</span><br><span class=\"line\">                .addSink(<span class=\"keyword\">new</span> RocketMQSink(<span class=\"keyword\">new</span> SimpleKeyValueSerializationSchema(<span class=\"keyword\">null</span>, <span class=\"string\">&quot;body&quot;</span>),</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> DefaultTopicSelector(topic), producerProps).withBatchFlushOnCheckpoint(<span class=\"keyword\">true</span>));</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"针对错误日志处理，同样实现了KeyedProcessFunction接口，通过注册定时器判断interval周期内，错误数量是否超过threshold。如果超过则输出错误信息流，交由后面的算子处理\"><a href=\"#针对错误日志处理，同样实现了KeyedProcessFunction接口，通过注册定时器判断interval周期内，错误数量是否超过threshold。如果超过则输出错误信息流，交由后面的算子处理\" class=\"headerlink\" title=\"针对错误日志处理，同样实现了KeyedProcessFunction接口，通过注册定时器判断interval周期内，错误数量是否超过threshold。如果超过则输出错误信息流，交由后面的算子处理\"></a>针对错误日志处理，同样实现了KeyedProcessFunction接口，通过注册定时器判断interval周期内，错误数量是否超过threshold。如果超过则输出错误信息流，交由后面的算子处理</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ErrorProcess</span> <span class=\"keyword\">extends</span> <span class=\"title\">KeyedProcessFunction</span>&lt;<span class=\"title\">Tuple</span>, <span class=\"title\">LogInfo</span>, <span class=\"title\">AlertInfo</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">long</span> interval;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">int</span> threshold;</span><br><span class=\"line\"><span class=\"comment\">//    private transient SendWechatService sendWechatService;</span></span><br><span class=\"line\">    ValueState&lt;Integer&gt; cnt ;</span><br><span class=\"line\">    ValueState&lt;Long&gt; timer ;</span><br><span class=\"line\">    ValueState&lt;String&gt; pod ;</span><br><span class=\"line\">    ValueState&lt;List&gt; errorMsg ;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"title\">ErrorProcess</span><span class=\"params\">(<span class=\"keyword\">long</span> interval,<span class=\"keyword\">int</span> threshold)</span></span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.interval = interval;</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.threshold = threshold;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">open</span><span class=\"params\">(Configuration parameters)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">super</span>.open(parameters);</span><br><span class=\"line\">        cnt = getRuntimeContext().getState(<span class=\"keyword\">new</span> ValueStateDescriptor&lt;Integer&gt;(<span class=\"string\">&quot;cnt&quot;</span>,Integer.class,<span class=\"number\">0</span>));</span><br><span class=\"line\">        timer = getRuntimeContext().getState(<span class=\"keyword\">new</span> ValueStateDescriptor&lt;Long&gt;(<span class=\"string\">&quot;timer&quot;</span>,Long.class));</span><br><span class=\"line\">        pod = getRuntimeContext().getState(<span class=\"keyword\">new</span> ValueStateDescriptor&lt;String&gt;(<span class=\"string\">&quot;pod&quot;</span>,String.class));</span><br><span class=\"line\">        errorMsg = getRuntimeContext().getState(<span class=\"keyword\">new</span> ValueStateDescriptor&lt;&gt;(<span class=\"string\">&quot;errorMsg&quot;</span>,List.class));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">processElement</span><span class=\"params\">(LogInfo value, Context ctx, Collector&lt;AlertInfo&gt; out)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        pod.update(value.getPodName());</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"string\">&quot;ERROR&quot;</span>.equals(value.getLevel()))&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(timer.value() == <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                ctx.timerService().registerProcessingTimeTimer(ctx.timerService().currentProcessingTime() + interval);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            cnt.update(cnt.value() + <span class=\"number\">1</span>);</span><br><span class=\"line\">            List em = errorMsg.value();</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(em == <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                em = <span class=\"keyword\">new</span> ArrayList();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            em.add(value.getMessage());</span><br><span class=\"line\">            errorMsg.update(em);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(timer.value() != <span class=\"keyword\">null</span>)&#123;</span><br><span class=\"line\">                ctx.timerService().deleteEventTimeTimer(timer.value());</span><br><span class=\"line\">                cnt.clear();</span><br><span class=\"line\">                timer.clear();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onTimer</span><span class=\"params\">(<span class=\"keyword\">long</span> timestamp, OnTimerContext ctx, Collector&lt;AlertInfo&gt; out)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(cnt.value() &gt;=threshold)&#123;</span><br><span class=\"line\">            AlertInfo alertInfo = <span class=\"keyword\">new</span> AlertInfo();</span><br><span class=\"line\">            alertInfo.setErrorCnt(cnt.value());</span><br><span class=\"line\">            alertInfo.setLevel(<span class=\"string\">&quot;ERROR&quot;</span>);</span><br><span class=\"line\">            alertInfo.setPodName(pod.value());</span><br><span class=\"line\">            alertInfo.setMg(errorMsg.value());</span><br><span class=\"line\">            String content = <span class=\"string\">&quot;In &quot;</span> + interval/<span class=\"number\">1000</span> + <span class=\"string\">&quot; seconds, pod[&quot;</span> + pod.value()  + <span class=\"string\">&quot;] over &quot;</span> + threshold + <span class=\"string\">&quot; error happened ,error count[&quot;</span> + cnt.value() + <span class=\"string\">&quot;]    detail:&quot;</span> + <span class=\"string\">&quot;\\n&quot;</span>  + <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">1</span> ;i&lt;=errorMsg.value().size();i++)&#123;</span><br><span class=\"line\">                content = content + <span class=\"string\">&quot;[&quot;</span> + i + <span class=\"string\">&quot;]&quot;</span> + errorMsg.value().get(i-<span class=\"number\">1</span>) + <span class=\"string\">&quot;  &quot;</span> + <span class=\"string\">&quot;\\n&quot;</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            alertInfo.setContent(content);</span><br><span class=\"line\">            out.collect(alertInfo);</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        cnt.clear();</span><br><span class=\"line\">        timer.clear();</span><br><span class=\"line\">        errorMsg.clear();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"后续算子将错误日志流转换成指定结构，并发给RocketMQ的Sink，交由错误推送任务进行wechat推送。\"><a href=\"#后续算子将错误日志流转换成指定结构，并发给RocketMQ的Sink，交由错误推送任务进行wechat推送。\" class=\"headerlink\" title=\"后续算子将错误日志流转换成指定结构，并发给RocketMQ的Sink，交由错误推送任务进行wechat推送。\"></a>后续算子将错误日志流转换成指定结构，并发给RocketMQ的Sink，交由错误推送任务进行wechat推送。</h4><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ToMessage</span> <span class=\"keyword\">implements</span> <span class=\"title\">MapFunction</span>&lt;<span class=\"title\">AlertInfo</span>, <span class=\"title\">String</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> String <span class=\"title\">map</span><span class=\"params\">(AlertInfo value)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        JSONObject messageBody = <span class=\"keyword\">new</span> JSONObject();</span><br><span class=\"line\">        messageBody.put(<span class=\"string\">&quot;alertMsg&quot;</span>,value.getContent());</span><br><span class=\"line\">        messageBody.put(<span class=\"string\">&quot;alertTo&quot;</span>,<span class=\"string\">&quot;xxxxx&quot;</span>);</span><br><span class=\"line\">        messageBody.put(<span class=\"string\">&quot;bizType&quot;</span>,<span class=\"string\">&quot;&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> messageBody.toJSONString();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>以上就是一个简单的错误日志分析及报警的流程，下次我们针对这个流程再写一篇测试文。同时这个流程中，我们对错误日志流采用的是侧流输出。所以在我们的主流中，我们还有很多正常日志值得我们分析和挖掘，后面我们也会围绕这些日志来做些有意思的东西，那这一次我们就先到这了。</p>"},{"title":"基于Flink推送报警信息-测试","date":"2020-05-21T11:41:25.000Z","_content":"\n上次我们简单的实现了如何通过Flink实现一个简单的wechat推送功能，这次我们就实际的运行起来看看。以下操作都是基于windows环境，为避免环境的影响全部采用docker部署。\n\n### 搭建本地RocketMQ环境\n1. 拉取namesrv 和broker 镜像\n   - docker pull rocketmqinc/rocketmq:4.4.0\n\n2. 启动namesrv\n   - docker run -d -p 9876:9876 -v D:\\work\\rocketmq\\data\\namesrv\\logs:/root/logs -v D:\\work\\rocketmq\\data\\namesrv\\store:/root/store --name rmqnamesrv -e \"MAX_POSSIBLE_HEAP=100000000\" rocketmqinc/rocketmq:4.4.0 sh mqnamesrv\n\n3. 配置broker.config\n   ``` yml\n    brokerClusterName = DefaultCluster\n    brokerName = broker-a\n    brokerId = 0\n    deleteWhen = 04\n    fileReservedTime = 48\n    brokerRole = ASYNC_MASTER\n    flushDiskType = ASYNC_FLUSH\n    brokerIP1 = 192.168.1.2\n   ```\n  <!-- more -->\n4. 启动broker\n   - docker run -d -p 10911:10911 -p 10909:10909 -v  D:\\work\\rocketmq\\data\\broker\\logs:/root/logs -v  D:\\work\\rocketmq\\data\\broker\\store:/root/store -v  D:\\work\\rocketmq\\conf\\broker.conf:/opt/rocketmq-4.4.0/conf/broker.conf --name rmqbroker --link rmqnamesrv:namesrv -e \"NAMESRV_ADDR=namesrv:9876\" -e \"MAX_POSSIBLE_HEAP=200000000\" rocketmqinc/rocketmq:4.4.0 sh mqbroker -c /opt/rocketmq-4.4.0/conf/broker.conf\n\n5. 拉取控制台镜像\n   - docker pull pangliang/rocketmq-console-ng\n\n6. 启动控制台\n   - docker run -e \"JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.1.2:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false\" -p 8080:8080 -t pangliang/rocketmq-console-ng\n\n### RocketMQ 设置\n以上，我们就在本地环境简单的部署好了rocketMQ的运行环境\n\n![01](基于Flink推送报警信息-测试/rocketmq-dashboard.png)\n\n我们配置下Topic\n\n![02](基于Flink推送报警信息-测试/rocketmq-topic.png)\n\n### 启动Flink本地运行时环境\n1. 配置启动参数\n\n--nameserverAddress 127.0.0.1:9876 --consumerGroup flinkGroup --consumerTopic AlertWechatTopic\n\n2. 启动Flink本地运行时Job\n   \n![03](基于Flink推送报警信息-测试/flink-local.png)\n\n3. 模拟一条报警信息\n\n![04](基于Flink推送报警信息-测试/rocketmq-message.png)\n\n4. 查看报警信息\n\n![05](基于Flink推送报警信息-测试/wechat-message.png)\n\n\n### 总结\n通过简单的操作，我们就可以定义一套统一的wechat告警信息发送机制。业务系统、告警系统、或是Flink其他的Job不需要关心告警推送的细节。只要向统一的Topic中推送告警信息，告警推送任务就是实时的把错误信息推送至wechat中。\n接下来，我们将围绕告警的核心功能：数据的采集、数据的分析。基于Flink来设计一个统一的报警平台。","source":"_posts/基于Flink推送报警信息-测试.md","raw":"---\ntitle: 基于Flink推送报警信息-测试\ndate: 2020-05-21 19:41:25\ntags: \n    - Java\n    - Flink\n    - 监控\ncategories :\n    - Technology\n---\n\n上次我们简单的实现了如何通过Flink实现一个简单的wechat推送功能，这次我们就实际的运行起来看看。以下操作都是基于windows环境，为避免环境的影响全部采用docker部署。\n\n### 搭建本地RocketMQ环境\n1. 拉取namesrv 和broker 镜像\n   - docker pull rocketmqinc/rocketmq:4.4.0\n\n2. 启动namesrv\n   - docker run -d -p 9876:9876 -v D:\\work\\rocketmq\\data\\namesrv\\logs:/root/logs -v D:\\work\\rocketmq\\data\\namesrv\\store:/root/store --name rmqnamesrv -e \"MAX_POSSIBLE_HEAP=100000000\" rocketmqinc/rocketmq:4.4.0 sh mqnamesrv\n\n3. 配置broker.config\n   ``` yml\n    brokerClusterName = DefaultCluster\n    brokerName = broker-a\n    brokerId = 0\n    deleteWhen = 04\n    fileReservedTime = 48\n    brokerRole = ASYNC_MASTER\n    flushDiskType = ASYNC_FLUSH\n    brokerIP1 = 192.168.1.2\n   ```\n  <!-- more -->\n4. 启动broker\n   - docker run -d -p 10911:10911 -p 10909:10909 -v  D:\\work\\rocketmq\\data\\broker\\logs:/root/logs -v  D:\\work\\rocketmq\\data\\broker\\store:/root/store -v  D:\\work\\rocketmq\\conf\\broker.conf:/opt/rocketmq-4.4.0/conf/broker.conf --name rmqbroker --link rmqnamesrv:namesrv -e \"NAMESRV_ADDR=namesrv:9876\" -e \"MAX_POSSIBLE_HEAP=200000000\" rocketmqinc/rocketmq:4.4.0 sh mqbroker -c /opt/rocketmq-4.4.0/conf/broker.conf\n\n5. 拉取控制台镜像\n   - docker pull pangliang/rocketmq-console-ng\n\n6. 启动控制台\n   - docker run -e \"JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.1.2:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false\" -p 8080:8080 -t pangliang/rocketmq-console-ng\n\n### RocketMQ 设置\n以上，我们就在本地环境简单的部署好了rocketMQ的运行环境\n\n![01](基于Flink推送报警信息-测试/rocketmq-dashboard.png)\n\n我们配置下Topic\n\n![02](基于Flink推送报警信息-测试/rocketmq-topic.png)\n\n### 启动Flink本地运行时环境\n1. 配置启动参数\n\n--nameserverAddress 127.0.0.1:9876 --consumerGroup flinkGroup --consumerTopic AlertWechatTopic\n\n2. 启动Flink本地运行时Job\n   \n![03](基于Flink推送报警信息-测试/flink-local.png)\n\n3. 模拟一条报警信息\n\n![04](基于Flink推送报警信息-测试/rocketmq-message.png)\n\n4. 查看报警信息\n\n![05](基于Flink推送报警信息-测试/wechat-message.png)\n\n\n### 总结\n通过简单的操作，我们就可以定义一套统一的wechat告警信息发送机制。业务系统、告警系统、或是Flink其他的Job不需要关心告警推送的细节。只要向统一的Topic中推送告警信息，告警推送任务就是实时的把错误信息推送至wechat中。\n接下来，我们将围绕告警的核心功能：数据的采集、数据的分析。基于Flink来设计一个统一的报警平台。","slug":"基于Flink推送报警信息-测试","published":1,"updated":"2020-12-14T10:23:32.989Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71hth000wv252el9hayof","content":"<html><head></head><body><p>&#x4E0A;&#x6B21;&#x6211;&#x4EEC;&#x7B80;&#x5355;&#x7684;&#x5B9E;&#x73B0;&#x4E86;&#x5982;&#x4F55;&#x901A;&#x8FC7;Flink&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;wechat&#x63A8;&#x9001;&#x529F;&#x80FD;&#xFF0C;&#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x5C31;&#x5B9E;&#x9645;&#x7684;&#x8FD0;&#x884C;&#x8D77;&#x6765;&#x770B;&#x770B;&#x3002;&#x4EE5;&#x4E0B;&#x64CD;&#x4F5C;&#x90FD;&#x662F;&#x57FA;&#x4E8E;windows&#x73AF;&#x5883;&#xFF0C;&#x4E3A;&#x907F;&#x514D;&#x73AF;&#x5883;&#x7684;&#x5F71;&#x54CD;&#x5168;&#x90E8;&#x91C7;&#x7528;docker&#x90E8;&#x7F72;&#x3002;</p>\n<h3 id=\"&#x642D;&#x5EFA;&#x672C;&#x5730;RocketMQ&#x73AF;&#x5883;\"><a href=\"#&#x642D;&#x5EFA;&#x672C;&#x5730;RocketMQ&#x73AF;&#x5883;\" class=\"headerlink\" title=\"&#x642D;&#x5EFA;&#x672C;&#x5730;RocketMQ&#x73AF;&#x5883;\"></a>&#x642D;&#x5EFA;&#x672C;&#x5730;RocketMQ&#x73AF;&#x5883;</h3><ol>\n<li><p>&#x62C9;&#x53D6;namesrv &#x548C;broker &#x955C;&#x50CF;</p>\n<ul>\n<li>docker pull rocketmqinc/rocketmq:4.4.0</li>\n</ul>\n</li>\n<li><p>&#x542F;&#x52A8;namesrv</p>\n<ul>\n<li>docker run -d -p 9876:9876 -v D:\\work\\rocketmq\\data\\namesrv\\logs:/root/logs -v D:\\work\\rocketmq\\data\\namesrv\\store:/root/store &#x2013;name rmqnamesrv -e &#x201C;MAX_POSSIBLE_HEAP=100000000&#x201D; rocketmqinc/rocketmq:4.4.0 sh mqnamesrv</li>\n</ul>\n</li>\n<li><p>&#x914D;&#x7F6E;broker.config</p>\n<figure class=\"highlight yml hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">brokerClusterName</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">DefaultCluster</span></span><br><span class=\"line\"><span class=\"hljs-string\">brokerName</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">broker-a</span></span><br><span class=\"line\"><span class=\"hljs-string\">brokerId</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-number\">0</span></span><br><span class=\"line\"><span class=\"hljs-string\">deleteWhen</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-number\">04</span></span><br><span class=\"line\"><span class=\"hljs-string\">fileReservedTime</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-number\">48</span></span><br><span class=\"line\"><span class=\"hljs-string\">brokerRole</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">ASYNC_MASTER</span></span><br><span class=\"line\"><span class=\"hljs-string\">flushDiskType</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">ASYNC_FLUSH</span></span><br><span class=\"line\"><span class=\"hljs-string\">brokerIP1</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.1</span><span class=\"hljs-number\">.2</span></span><br></pre></td></tr></tbody></table></figure>\n<a id=\"more\"></a></li>\n<li><p>&#x542F;&#x52A8;broker</p>\n<ul>\n<li>docker run -d -p 10911:10911 -p 10909:10909 -v  D:\\work\\rocketmq\\data\\broker\\logs:/root/logs -v  D:\\work\\rocketmq\\data\\broker\\store:/root/store -v  D:\\work\\rocketmq\\conf\\broker.conf:/opt/rocketmq-4.4.0/conf/broker.conf &#x2013;name rmqbroker &#x2013;link rmqnamesrv:namesrv -e &#x201C;NAMESRV_ADDR=namesrv:9876&#x201D; -e &#x201C;MAX_POSSIBLE_HEAP=200000000&#x201D; rocketmqinc/rocketmq:4.4.0 sh mqbroker -c /opt/rocketmq-4.4.0/conf/broker.conf</li>\n</ul>\n</li>\n<li><p>&#x62C9;&#x53D6;&#x63A7;&#x5236;&#x53F0;&#x955C;&#x50CF;</p>\n<ul>\n<li>docker pull pangliang/rocketmq-console-ng</li>\n</ul>\n</li>\n<li><p>&#x542F;&#x52A8;&#x63A7;&#x5236;&#x53F0;</p>\n<ul>\n<li>docker run -e &#x201C;JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.1.2:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false&#x201D; -p 8080:8080 -t pangliang/rocketmq-console-ng</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"RocketMQ-&#x8BBE;&#x7F6E;\"><a href=\"#RocketMQ-&#x8BBE;&#x7F6E;\" class=\"headerlink\" title=\"RocketMQ &#x8BBE;&#x7F6E;\"></a>RocketMQ &#x8BBE;&#x7F6E;</h3><p>&#x4EE5;&#x4E0A;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x5728;&#x672C;&#x5730;&#x73AF;&#x5883;&#x7B80;&#x5355;&#x7684;&#x90E8;&#x7F72;&#x597D;&#x4E86;rocketMQ&#x7684;&#x8FD0;&#x884C;&#x73AF;&#x5883;</p>\n<p><img src=\"/2020/05/21/%E5%9F%BA%E4%BA%8EFlink%E6%8E%A8%E9%80%81%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-%E6%B5%8B%E8%AF%95/rocketmq-dashboard.png\" alt=\"01\"></p>\n<p>&#x6211;&#x4EEC;&#x914D;&#x7F6E;&#x4E0B;Topic</p>\n<p><img src=\"/2020/05/21/%E5%9F%BA%E4%BA%8EFlink%E6%8E%A8%E9%80%81%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-%E6%B5%8B%E8%AF%95/rocketmq-topic.png\" alt=\"02\"></p>\n<h3 id=\"&#x542F;&#x52A8;Flink&#x672C;&#x5730;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;\"><a href=\"#&#x542F;&#x52A8;Flink&#x672C;&#x5730;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;\" class=\"headerlink\" title=\"&#x542F;&#x52A8;Flink&#x672C;&#x5730;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;\"></a>&#x542F;&#x52A8;Flink&#x672C;&#x5730;&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;</h3><ol>\n<li>&#x914D;&#x7F6E;&#x542F;&#x52A8;&#x53C2;&#x6570;</li>\n</ol>\n<p>&#x2013;nameserverAddress 127.0.0.1:9876 &#x2013;consumerGroup flinkGroup &#x2013;consumerTopic AlertWechatTopic</p>\n<ol start=\"2\">\n<li>&#x542F;&#x52A8;Flink&#x672C;&#x5730;&#x8FD0;&#x884C;&#x65F6;Job</li>\n</ol>\n<p><img src=\"/2020/05/21/%E5%9F%BA%E4%BA%8EFlink%E6%8E%A8%E9%80%81%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-%E6%B5%8B%E8%AF%95/flink-local.png\" alt=\"03\"></p>\n<ol start=\"3\">\n<li>&#x6A21;&#x62DF;&#x4E00;&#x6761;&#x62A5;&#x8B66;&#x4FE1;&#x606F;</li>\n</ol>\n<p><img src=\"/2020/05/21/%E5%9F%BA%E4%BA%8EFlink%E6%8E%A8%E9%80%81%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-%E6%B5%8B%E8%AF%95/rocketmq-message.png\" alt=\"04\"></p>\n<ol start=\"4\">\n<li>&#x67E5;&#x770B;&#x62A5;&#x8B66;&#x4FE1;&#x606F;</li>\n</ol>\n<p><img src=\"/2020/05/21/%E5%9F%BA%E4%BA%8EFlink%E6%8E%A8%E9%80%81%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-%E6%B5%8B%E8%AF%95/wechat-message.png\" alt=\"05\"></p>\n<h3 id=\"&#x603B;&#x7ED3;\"><a href=\"#&#x603B;&#x7ED3;\" class=\"headerlink\" title=\"&#x603B;&#x7ED3;\"></a>&#x603B;&#x7ED3;</h3><p>&#x901A;&#x8FC7;&#x7B80;&#x5355;&#x7684;&#x64CD;&#x4F5C;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x53EF;&#x4EE5;&#x5B9A;&#x4E49;&#x4E00;&#x5957;&#x7EDF;&#x4E00;&#x7684;wechat&#x544A;&#x8B66;&#x4FE1;&#x606F;&#x53D1;&#x9001;&#x673A;&#x5236;&#x3002;&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;&#x3001;&#x544A;&#x8B66;&#x7CFB;&#x7EDF;&#x3001;&#x6216;&#x662F;Flink&#x5176;&#x4ED6;&#x7684;Job&#x4E0D;&#x9700;&#x8981;&#x5173;&#x5FC3;&#x544A;&#x8B66;&#x63A8;&#x9001;&#x7684;&#x7EC6;&#x8282;&#x3002;&#x53EA;&#x8981;&#x5411;&#x7EDF;&#x4E00;&#x7684;Topic&#x4E2D;&#x63A8;&#x9001;&#x544A;&#x8B66;&#x4FE1;&#x606F;&#xFF0C;&#x544A;&#x8B66;&#x63A8;&#x9001;&#x4EFB;&#x52A1;&#x5C31;&#x662F;&#x5B9E;&#x65F6;&#x7684;&#x628A;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x63A8;&#x9001;&#x81F3;wechat&#x4E2D;&#x3002;<br>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x56F4;&#x7ED5;&#x544A;&#x8B66;&#x7684;&#x6838;&#x5FC3;&#x529F;&#x80FD;&#xFF1A;&#x6570;&#x636E;&#x7684;&#x91C7;&#x96C6;&#x3001;&#x6570;&#x636E;&#x7684;&#x5206;&#x6790;&#x3002;&#x57FA;&#x4E8E;Flink&#x6765;&#x8BBE;&#x8BA1;&#x4E00;&#x4E2A;&#x7EDF;&#x4E00;&#x7684;&#x62A5;&#x8B66;&#x5E73;&#x53F0;&#x3002;</p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Flink","path":"tags/Flink/"},{"name":"监控","path":"tags/监控/"}],"excerpt":"<html><head></head><body><p>&#x4E0A;&#x6B21;&#x6211;&#x4EEC;&#x7B80;&#x5355;&#x7684;&#x5B9E;&#x73B0;&#x4E86;&#x5982;&#x4F55;&#x901A;&#x8FC7;Flink&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;wechat&#x63A8;&#x9001;&#x529F;&#x80FD;&#xFF0C;&#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x5C31;&#x5B9E;&#x9645;&#x7684;&#x8FD0;&#x884C;&#x8D77;&#x6765;&#x770B;&#x770B;&#x3002;&#x4EE5;&#x4E0B;&#x64CD;&#x4F5C;&#x90FD;&#x662F;&#x57FA;&#x4E8E;windows&#x73AF;&#x5883;&#xFF0C;&#x4E3A;&#x907F;&#x514D;&#x73AF;&#x5883;&#x7684;&#x5F71;&#x54CD;&#x5168;&#x90E8;&#x91C7;&#x7528;docker&#x90E8;&#x7F72;&#x3002;</p>\n<h3 id=\"&#x642D;&#x5EFA;&#x672C;&#x5730;RocketMQ&#x73AF;&#x5883;\"><a href=\"#&#x642D;&#x5EFA;&#x672C;&#x5730;RocketMQ&#x73AF;&#x5883;\" class=\"headerlink\" title=\"&#x642D;&#x5EFA;&#x672C;&#x5730;RocketMQ&#x73AF;&#x5883;\"></a>&#x642D;&#x5EFA;&#x672C;&#x5730;RocketMQ&#x73AF;&#x5883;</h3><ol>\n<li><p>&#x62C9;&#x53D6;namesrv &#x548C;broker &#x955C;&#x50CF;</p>\n<ul>\n<li>docker pull rocketmqinc/rocketmq:4.4.0</li>\n</ul>\n</li>\n<li><p>&#x542F;&#x52A8;namesrv</p>\n<ul>\n<li>docker run -d -p 9876:9876 -v D:\\work\\rocketmq\\data\\namesrv\\logs:/root/logs -v D:\\work\\rocketmq\\data\\namesrv\\store:/root/store &#x2013;name rmqnamesrv -e &#x201C;MAX_POSSIBLE_HEAP=100000000&#x201D; rocketmqinc/rocketmq:4.4.0 sh mqnamesrv</li>\n</ul>\n</li>\n<li><p>&#x914D;&#x7F6E;broker.config</p>\n<figure class=\"highlight yml hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-string\">brokerClusterName</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">DefaultCluster</span></span><br><span class=\"line\"><span class=\"hljs-string\">brokerName</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">broker-a</span></span><br><span class=\"line\"><span class=\"hljs-string\">brokerId</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-number\">0</span></span><br><span class=\"line\"><span class=\"hljs-string\">deleteWhen</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-number\">04</span></span><br><span class=\"line\"><span class=\"hljs-string\">fileReservedTime</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-number\">48</span></span><br><span class=\"line\"><span class=\"hljs-string\">brokerRole</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">ASYNC_MASTER</span></span><br><span class=\"line\"><span class=\"hljs-string\">flushDiskType</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-string\">ASYNC_FLUSH</span></span><br><span class=\"line\"><span class=\"hljs-string\">brokerIP1</span> <span class=\"hljs-string\">=</span> <span class=\"hljs-number\">192.168</span><span class=\"hljs-number\">.1</span><span class=\"hljs-number\">.2</span></span><br></pre></td></tr></tbody></table></figure></li></ol></body></html>","more":"\n<li><p>启动broker</p>\n<ul>\n<li>docker run -d -p 10911:10911 -p 10909:10909 -v  D:\\work\\rocketmq\\data\\broker\\logs:/root/logs -v  D:\\work\\rocketmq\\data\\broker\\store:/root/store -v  D:\\work\\rocketmq\\conf\\broker.conf:/opt/rocketmq-4.4.0/conf/broker.conf –name rmqbroker –link rmqnamesrv:namesrv -e “NAMESRV_ADDR=namesrv:9876” -e “MAX_POSSIBLE_HEAP=200000000” rocketmqinc/rocketmq:4.4.0 sh mqbroker -c /opt/rocketmq-4.4.0/conf/broker.conf</li>\n</ul>\n</li>\n<li><p>拉取控制台镜像</p>\n<ul>\n<li>docker pull pangliang/rocketmq-console-ng</li>\n</ul>\n</li>\n<li><p>启动控制台</p>\n<ul>\n<li>docker run -e “JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.1.2:9876 -Dcom.rocketmq.sendMessageWithVIPChannel=false” -p 8080:8080 -t pangliang/rocketmq-console-ng</li>\n</ul>\n</li>\n\n<h3 id=\"RocketMQ-设置\"><a href=\"#RocketMQ-设置\" class=\"headerlink\" title=\"RocketMQ 设置\"></a>RocketMQ 设置</h3><p>以上，我们就在本地环境简单的部署好了rocketMQ的运行环境</p>\n<p><img src=\"/2020/05/21/%E5%9F%BA%E4%BA%8EFlink%E6%8E%A8%E9%80%81%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-%E6%B5%8B%E8%AF%95/rocketmq-dashboard.png\" alt=\"01\"></p>\n<p>我们配置下Topic</p>\n<p><img src=\"/2020/05/21/%E5%9F%BA%E4%BA%8EFlink%E6%8E%A8%E9%80%81%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-%E6%B5%8B%E8%AF%95/rocketmq-topic.png\" alt=\"02\"></p>\n<h3 id=\"启动Flink本地运行时环境\"><a href=\"#启动Flink本地运行时环境\" class=\"headerlink\" title=\"启动Flink本地运行时环境\"></a>启动Flink本地运行时环境</h3><ol>\n<li>配置启动参数</li>\n</ol>\n<p>–nameserverAddress 127.0.0.1:9876 –consumerGroup flinkGroup –consumerTopic AlertWechatTopic</p>\n<ol start=\"2\">\n<li>启动Flink本地运行时Job</li>\n</ol>\n<p><img src=\"/2020/05/21/%E5%9F%BA%E4%BA%8EFlink%E6%8E%A8%E9%80%81%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-%E6%B5%8B%E8%AF%95/flink-local.png\" alt=\"03\"></p>\n<ol start=\"3\">\n<li>模拟一条报警信息</li>\n</ol>\n<p><img src=\"/2020/05/21/%E5%9F%BA%E4%BA%8EFlink%E6%8E%A8%E9%80%81%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-%E6%B5%8B%E8%AF%95/rocketmq-message.png\" alt=\"04\"></p>\n<ol start=\"4\">\n<li>查看报警信息</li>\n</ol>\n<p><img src=\"/2020/05/21/%E5%9F%BA%E4%BA%8EFlink%E6%8E%A8%E9%80%81%E6%8A%A5%E8%AD%A6%E4%BF%A1%E6%81%AF-%E6%B5%8B%E8%AF%95/wechat-message.png\" alt=\"05\"></p>\n<h3 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h3><p>通过简单的操作，我们就可以定义一套统一的wechat告警信息发送机制。业务系统、告警系统、或是Flink其他的Job不需要关心告警推送的细节。只要向统一的Topic中推送告警信息，告警推送任务就是实时的把错误信息推送至wechat中。<br>接下来，我们将围绕告警的核心功能：数据的采集、数据的分析。基于Flink来设计一个统一的报警平台。</p>"},{"title":"基于Flink设计统一报警平台","date":"2020-05-16T09:24:48.000Z","_content":"\n最近在整理后端已有的错误报警，主要分两大类：\n1. 异常报警\n   - 基于监控系统。如CAT、pingpong、skywalking等APM系统的错误异常监控。开发人员针对异常类型，制定相应的阈值。对代码运行时异常、sql异常、网络异常等进行指标监控。当异常超过指定阈值时推送异常信息。我们的后端系统是基于CAT进行监控，监控的指标和配置都要人为进行配置，异常信息的推送需要开发并与CAT对接，同时微信推送这块异常信息有限，往往要通过邮件告警和登录CAT平台查看才能大概了解错误的类型。这点长期被开发人员诟病，虽然我们能够通过修改CAT的源码来改善上诉问题。但对于程序员来说，更加直观的堆错误信息进行处理是再好不过的事情。\n   - 基于系统指标。有别于服务异常，系统指标有更灵活的采集方式。我们采用了Spring Merics，基于Prometheus搭建了系统指标的监控体系，结合Grafana将近实时的系统指标展现至屏幕。同样遇到系统指标异常的时候，如Heap空间使用量异常，CPU飙高，内存告急等情况，我们通过Grafana的自定义告警将错误推送给相关开发。\n  <!-- more -->\n2. 业务告警\n   - 基于实时数据。通过对业务流程的埋点，将采集的实时数据进行计算比较。并将异常的业务数据进行推送告警。\n   - 基于离线数据。定时分析离线数据，推送异常业务数据告警。\n\n以上大概介绍了监控的几个方向及其落地方式，通过分析我们可以将整个监控行为抽象成一个数据流：监控数据源--> 监控数据清洗 --> 监控数据计算 --> 推送报警\n\n基于这个结论，正式我们会开始研究并探索Flink的契机。面对目前后端形形色色的监控方式及处理流程，每一个部分都是割裂的，无法统一思想的。面对不同的监控场景时，我们要考虑不同接处理手段，这变相的增加了开发人员的人力资源。\n\n为此我们考虑怎样可以最大限度的统一各个报警的流程，并提供一个统一的处理平台。这个时候Flink来到了我们面前。\n\nFlink是什么相比不用介绍了，官网已经介绍的相当详细了：\n<https://flink.apache.org/>\n\n上面抽象的监控流程：监控数据源--> 监控数据清洗 --> 监控数据计算 --> 推送报警\n\n用Flink可以表示为：Source--> ETL--> Operator--> Sink\n\n结合上面的分析，我打算先从推送报警功能入手。利用Flink的流式处理能力，开发一个统一的报警出口任务。\n#### 数据源\n数据源我们打算采用RocketMQ。创建一个统一的报警推送Topic，定义统一的报警消息格式。\n\n|Topic|AlertWechatTopic|\n|---|---|\n|Body|{\"alertMsg\":\"\",<br>\"alertTo\":\"\",<br>\"bizType\":\"\"<br> }\n\n#### 算子\n1. 应用RocketMQ-Extend提供的Flink支持，官方继承了RichParallelSourceFunction类。实现了注册Consumer，拉取Topic下的消息。\n\n2. 官方提供的序列化方法仅有针对key和value的String序列化SimpleKeyValueDeserializationSchema。在运用上是满足的，但是后期编程上可能自定义会更加方便。后期我们会考虑扩展序列化方式或是官方提供的拉取消息源码，做到更灵活的消息格式传输。\n\n3. 将从RocketMQ中拉取到的消息做Map，格式化成我们希望的结构。\n\n```java\npublic static void main(String[] args) {\n        ParameterTool parameterTool = ParameterTool.fromArgs(args);\n        String nameserverAddress = parameterTool.get(\"nameserverAddress\");\n        String consumerGroup = parameterTool.get(\"consumerGroup\");\n        String consumerTopic = parameterTool.get(\"consumerTopic\");\n\n        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n        SendWechatService sendWechatService = new SendWechatService();\n        // enable checkpoint\n        env.enableCheckpointing(3000);\n\n        Properties consumerProps = new Properties();\n        consumerProps.setProperty(RocketMQConfig.NAME_SERVER_ADDR, nameserverAddress);\n        consumerProps.setProperty(RocketMQConfig.CONSUMER_GROUP, consumerGroup);\n        consumerProps.setProperty(RocketMQConfig.CONSUMER_TOPIC, consumerTopic);\n\n        env.addSource(new RocketMQSource<Map>(new SimpleKeyValueDeserializationSchema(null,\"body\"),consumerProps))\n                .name(\"rocketmq-source\")\n                .map(new MapFunction<Map, WechatAlertInfo>() {\n                    @Override\n                    public WechatAlertInfo map(Map value) throws Exception {\n                        String body = (String)value.get(\"body\");\n                        WechatAlertInfo wechatAlertInfo = JSONObject.parseObject(body, WechatAlertInfo.class);\n                        return wechatAlertInfo;\n                    }\n                }).addSink(new WechatSink())\n                .name(\"wechat sink\");\n        try {\n            env.execute(\"send to wechat\");\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n```\n\n4. 将格式化完成的数据源输出到我们自定义的Sink中，该sink的功能为发送wechat信息。\n\n```java\npublic class WechatSink extends RichSinkFunction<WechatAlertInfo> {\n    private transient SendWechatService sendWechatService;\n\n    @Override\n    public void open(Configuration parameters) throws Exception {\n        sendWechatService = new SendWechatService();\n    }\n\n    @Override\n    public void invoke(WechatAlertInfo value, Context context) throws Exception {\n        sendWechatService.sendMessage(value.getAlertMsg(),value.getAlertTo());\n    }\n}\n```\n\n以上我们就简单的实现了将RocketMQ中的报警消息推送至wechat的功能，下次我们把代码跑起来看看。","source":"_posts/基于Flink设计统一报警平台.md","raw":"---\ntitle: 基于Flink设计统一报警平台\ndate: 2020-05-16 17:24:48\ntags: \n    - Java\n    - Flink\n    - 监控\ncategories :\n    - Technology\n---\n\n最近在整理后端已有的错误报警，主要分两大类：\n1. 异常报警\n   - 基于监控系统。如CAT、pingpong、skywalking等APM系统的错误异常监控。开发人员针对异常类型，制定相应的阈值。对代码运行时异常、sql异常、网络异常等进行指标监控。当异常超过指定阈值时推送异常信息。我们的后端系统是基于CAT进行监控，监控的指标和配置都要人为进行配置，异常信息的推送需要开发并与CAT对接，同时微信推送这块异常信息有限，往往要通过邮件告警和登录CAT平台查看才能大概了解错误的类型。这点长期被开发人员诟病，虽然我们能够通过修改CAT的源码来改善上诉问题。但对于程序员来说，更加直观的堆错误信息进行处理是再好不过的事情。\n   - 基于系统指标。有别于服务异常，系统指标有更灵活的采集方式。我们采用了Spring Merics，基于Prometheus搭建了系统指标的监控体系，结合Grafana将近实时的系统指标展现至屏幕。同样遇到系统指标异常的时候，如Heap空间使用量异常，CPU飙高，内存告急等情况，我们通过Grafana的自定义告警将错误推送给相关开发。\n  <!-- more -->\n2. 业务告警\n   - 基于实时数据。通过对业务流程的埋点，将采集的实时数据进行计算比较。并将异常的业务数据进行推送告警。\n   - 基于离线数据。定时分析离线数据，推送异常业务数据告警。\n\n以上大概介绍了监控的几个方向及其落地方式，通过分析我们可以将整个监控行为抽象成一个数据流：监控数据源--> 监控数据清洗 --> 监控数据计算 --> 推送报警\n\n基于这个结论，正式我们会开始研究并探索Flink的契机。面对目前后端形形色色的监控方式及处理流程，每一个部分都是割裂的，无法统一思想的。面对不同的监控场景时，我们要考虑不同接处理手段，这变相的增加了开发人员的人力资源。\n\n为此我们考虑怎样可以最大限度的统一各个报警的流程，并提供一个统一的处理平台。这个时候Flink来到了我们面前。\n\nFlink是什么相比不用介绍了，官网已经介绍的相当详细了：\n<https://flink.apache.org/>\n\n上面抽象的监控流程：监控数据源--> 监控数据清洗 --> 监控数据计算 --> 推送报警\n\n用Flink可以表示为：Source--> ETL--> Operator--> Sink\n\n结合上面的分析，我打算先从推送报警功能入手。利用Flink的流式处理能力，开发一个统一的报警出口任务。\n#### 数据源\n数据源我们打算采用RocketMQ。创建一个统一的报警推送Topic，定义统一的报警消息格式。\n\n|Topic|AlertWechatTopic|\n|---|---|\n|Body|{\"alertMsg\":\"\",<br>\"alertTo\":\"\",<br>\"bizType\":\"\"<br> }\n\n#### 算子\n1. 应用RocketMQ-Extend提供的Flink支持，官方继承了RichParallelSourceFunction类。实现了注册Consumer，拉取Topic下的消息。\n\n2. 官方提供的序列化方法仅有针对key和value的String序列化SimpleKeyValueDeserializationSchema。在运用上是满足的，但是后期编程上可能自定义会更加方便。后期我们会考虑扩展序列化方式或是官方提供的拉取消息源码，做到更灵活的消息格式传输。\n\n3. 将从RocketMQ中拉取到的消息做Map，格式化成我们希望的结构。\n\n```java\npublic static void main(String[] args) {\n        ParameterTool parameterTool = ParameterTool.fromArgs(args);\n        String nameserverAddress = parameterTool.get(\"nameserverAddress\");\n        String consumerGroup = parameterTool.get(\"consumerGroup\");\n        String consumerTopic = parameterTool.get(\"consumerTopic\");\n\n        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();\n        SendWechatService sendWechatService = new SendWechatService();\n        // enable checkpoint\n        env.enableCheckpointing(3000);\n\n        Properties consumerProps = new Properties();\n        consumerProps.setProperty(RocketMQConfig.NAME_SERVER_ADDR, nameserverAddress);\n        consumerProps.setProperty(RocketMQConfig.CONSUMER_GROUP, consumerGroup);\n        consumerProps.setProperty(RocketMQConfig.CONSUMER_TOPIC, consumerTopic);\n\n        env.addSource(new RocketMQSource<Map>(new SimpleKeyValueDeserializationSchema(null,\"body\"),consumerProps))\n                .name(\"rocketmq-source\")\n                .map(new MapFunction<Map, WechatAlertInfo>() {\n                    @Override\n                    public WechatAlertInfo map(Map value) throws Exception {\n                        String body = (String)value.get(\"body\");\n                        WechatAlertInfo wechatAlertInfo = JSONObject.parseObject(body, WechatAlertInfo.class);\n                        return wechatAlertInfo;\n                    }\n                }).addSink(new WechatSink())\n                .name(\"wechat sink\");\n        try {\n            env.execute(\"send to wechat\");\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n```\n\n4. 将格式化完成的数据源输出到我们自定义的Sink中，该sink的功能为发送wechat信息。\n\n```java\npublic class WechatSink extends RichSinkFunction<WechatAlertInfo> {\n    private transient SendWechatService sendWechatService;\n\n    @Override\n    public void open(Configuration parameters) throws Exception {\n        sendWechatService = new SendWechatService();\n    }\n\n    @Override\n    public void invoke(WechatAlertInfo value, Context context) throws Exception {\n        sendWechatService.sendMessage(value.getAlertMsg(),value.getAlertTo());\n    }\n}\n```\n\n以上我们就简单的实现了将RocketMQ中的报警消息推送至wechat的功能，下次我们把代码跑起来看看。","slug":"基于Flink设计统一报警平台","published":1,"updated":"2020-12-14T09:51:24.020Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71hti000yv252112dc7je","content":"<html><head></head><body><p>&#x6700;&#x8FD1;&#x5728;&#x6574;&#x7406;&#x540E;&#x7AEF;&#x5DF2;&#x6709;&#x7684;&#x9519;&#x8BEF;&#x62A5;&#x8B66;&#xFF0C;&#x4E3B;&#x8981;&#x5206;&#x4E24;&#x5927;&#x7C7B;&#xFF1A;</p>\n<ol>\n<li>&#x5F02;&#x5E38;&#x62A5;&#x8B66;<ul>\n<li>&#x57FA;&#x4E8E;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x3002;&#x5982;CAT&#x3001;pingpong&#x3001;skywalking&#x7B49;APM&#x7CFB;&#x7EDF;&#x7684;&#x9519;&#x8BEF;&#x5F02;&#x5E38;&#x76D1;&#x63A7;&#x3002;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x9488;&#x5BF9;&#x5F02;&#x5E38;&#x7C7B;&#x578B;&#xFF0C;&#x5236;&#x5B9A;&#x76F8;&#x5E94;&#x7684;&#x9608;&#x503C;&#x3002;&#x5BF9;&#x4EE3;&#x7801;&#x8FD0;&#x884C;&#x65F6;&#x5F02;&#x5E38;&#x3001;sql&#x5F02;&#x5E38;&#x3001;&#x7F51;&#x7EDC;&#x5F02;&#x5E38;&#x7B49;&#x8FDB;&#x884C;&#x6307;&#x6807;&#x76D1;&#x63A7;&#x3002;&#x5F53;&#x5F02;&#x5E38;&#x8D85;&#x8FC7;&#x6307;&#x5B9A;&#x9608;&#x503C;&#x65F6;&#x63A8;&#x9001;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x3002;&#x6211;&#x4EEC;&#x7684;&#x540E;&#x7AEF;&#x7CFB;&#x7EDF;&#x662F;&#x57FA;&#x4E8E;CAT&#x8FDB;&#x884C;&#x76D1;&#x63A7;&#xFF0C;&#x76D1;&#x63A7;&#x7684;&#x6307;&#x6807;&#x548C;&#x914D;&#x7F6E;&#x90FD;&#x8981;&#x4EBA;&#x4E3A;&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#xFF0C;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x7684;&#x63A8;&#x9001;&#x9700;&#x8981;&#x5F00;&#x53D1;&#x5E76;&#x4E0E;CAT&#x5BF9;&#x63A5;&#xFF0C;&#x540C;&#x65F6;&#x5FAE;&#x4FE1;&#x63A8;&#x9001;&#x8FD9;&#x5757;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x6709;&#x9650;&#xFF0C;&#x5F80;&#x5F80;&#x8981;&#x901A;&#x8FC7;&#x90AE;&#x4EF6;&#x544A;&#x8B66;&#x548C;&#x767B;&#x5F55;CAT&#x5E73;&#x53F0;&#x67E5;&#x770B;&#x624D;&#x80FD;&#x5927;&#x6982;&#x4E86;&#x89E3;&#x9519;&#x8BEF;&#x7684;&#x7C7B;&#x578B;&#x3002;&#x8FD9;&#x70B9;&#x957F;&#x671F;&#x88AB;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x8BDF;&#x75C5;&#xFF0C;&#x867D;&#x7136;&#x6211;&#x4EEC;&#x80FD;&#x591F;&#x901A;&#x8FC7;&#x4FEE;&#x6539;CAT&#x7684;&#x6E90;&#x7801;&#x6765;&#x6539;&#x5584;&#x4E0A;&#x8BC9;&#x95EE;&#x9898;&#x3002;&#x4F46;&#x5BF9;&#x4E8E;&#x7A0B;&#x5E8F;&#x5458;&#x6765;&#x8BF4;&#xFF0C;&#x66F4;&#x52A0;&#x76F4;&#x89C2;&#x7684;&#x5806;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x662F;&#x518D;&#x597D;&#x4E0D;&#x8FC7;&#x7684;&#x4E8B;&#x60C5;&#x3002;</li>\n<li>&#x57FA;&#x4E8E;&#x7CFB;&#x7EDF;&#x6307;&#x6807;&#x3002;&#x6709;&#x522B;&#x4E8E;&#x670D;&#x52A1;&#x5F02;&#x5E38;&#xFF0C;&#x7CFB;&#x7EDF;&#x6307;&#x6807;&#x6709;&#x66F4;&#x7075;&#x6D3B;&#x7684;&#x91C7;&#x96C6;&#x65B9;&#x5F0F;&#x3002;&#x6211;&#x4EEC;&#x91C7;&#x7528;&#x4E86;Spring Merics&#xFF0C;&#x57FA;&#x4E8E;Prometheus&#x642D;&#x5EFA;&#x4E86;&#x7CFB;&#x7EDF;&#x6307;&#x6807;&#x7684;&#x76D1;&#x63A7;&#x4F53;&#x7CFB;&#xFF0C;&#x7ED3;&#x5408;Grafana&#x5C06;&#x8FD1;&#x5B9E;&#x65F6;&#x7684;&#x7CFB;&#x7EDF;&#x6307;&#x6807;&#x5C55;&#x73B0;&#x81F3;&#x5C4F;&#x5E55;&#x3002;&#x540C;&#x6837;&#x9047;&#x5230;&#x7CFB;&#x7EDF;&#x6307;&#x6807;&#x5F02;&#x5E38;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5982;Heap&#x7A7A;&#x95F4;&#x4F7F;&#x7528;&#x91CF;&#x5F02;&#x5E38;&#xFF0C;CPU&#x98D9;&#x9AD8;&#xFF0C;&#x5185;&#x5B58;&#x544A;&#x6025;&#x7B49;&#x60C5;&#x51B5;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;Grafana&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x544A;&#x8B66;&#x5C06;&#x9519;&#x8BEF;&#x63A8;&#x9001;&#x7ED9;&#x76F8;&#x5173;&#x5F00;&#x53D1;&#x3002;<a id=\"more\"></a></li>\n</ul>\n</li>\n<li>&#x4E1A;&#x52A1;&#x544A;&#x8B66;<ul>\n<li>&#x57FA;&#x4E8E;&#x5B9E;&#x65F6;&#x6570;&#x636E;&#x3002;&#x901A;&#x8FC7;&#x5BF9;&#x4E1A;&#x52A1;&#x6D41;&#x7A0B;&#x7684;&#x57CB;&#x70B9;&#xFF0C;&#x5C06;&#x91C7;&#x96C6;&#x7684;&#x5B9E;&#x65F6;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x8BA1;&#x7B97;&#x6BD4;&#x8F83;&#x3002;&#x5E76;&#x5C06;&#x5F02;&#x5E38;&#x7684;&#x4E1A;&#x52A1;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x63A8;&#x9001;&#x544A;&#x8B66;&#x3002;</li>\n<li>&#x57FA;&#x4E8E;&#x79BB;&#x7EBF;&#x6570;&#x636E;&#x3002;&#x5B9A;&#x65F6;&#x5206;&#x6790;&#x79BB;&#x7EBF;&#x6570;&#x636E;&#xFF0C;&#x63A8;&#x9001;&#x5F02;&#x5E38;&#x4E1A;&#x52A1;&#x6570;&#x636E;&#x544A;&#x8B66;&#x3002;</li>\n</ul>\n</li>\n</ol>\n<p>&#x4EE5;&#x4E0A;&#x5927;&#x6982;&#x4ECB;&#x7ECD;&#x4E86;&#x76D1;&#x63A7;&#x7684;&#x51E0;&#x4E2A;&#x65B9;&#x5411;&#x53CA;&#x5176;&#x843D;&#x5730;&#x65B9;&#x5F0F;&#xFF0C;&#x901A;&#x8FC7;&#x5206;&#x6790;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5C06;&#x6574;&#x4E2A;&#x76D1;&#x63A7;&#x884C;&#x4E3A;&#x62BD;&#x8C61;&#x6210;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x6D41;&#xFF1A;&#x76D1;&#x63A7;&#x6570;&#x636E;&#x6E90;&#x2013;&gt; &#x76D1;&#x63A7;&#x6570;&#x636E;&#x6E05;&#x6D17; &#x2013;&gt; &#x76D1;&#x63A7;&#x6570;&#x636E;&#x8BA1;&#x7B97; &#x2013;&gt; &#x63A8;&#x9001;&#x62A5;&#x8B66;</p>\n<p>&#x57FA;&#x4E8E;&#x8FD9;&#x4E2A;&#x7ED3;&#x8BBA;&#xFF0C;&#x6B63;&#x5F0F;&#x6211;&#x4EEC;&#x4F1A;&#x5F00;&#x59CB;&#x7814;&#x7A76;&#x5E76;&#x63A2;&#x7D22;Flink&#x7684;&#x5951;&#x673A;&#x3002;&#x9762;&#x5BF9;&#x76EE;&#x524D;&#x540E;&#x7AEF;&#x5F62;&#x5F62;&#x8272;&#x8272;&#x7684;&#x76D1;&#x63A7;&#x65B9;&#x5F0F;&#x53CA;&#x5904;&#x7406;&#x6D41;&#x7A0B;&#xFF0C;&#x6BCF;&#x4E00;&#x4E2A;&#x90E8;&#x5206;&#x90FD;&#x662F;&#x5272;&#x88C2;&#x7684;&#xFF0C;&#x65E0;&#x6CD5;&#x7EDF;&#x4E00;&#x601D;&#x60F3;&#x7684;&#x3002;&#x9762;&#x5BF9;&#x4E0D;&#x540C;&#x7684;&#x76D1;&#x63A7;&#x573A;&#x666F;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x8003;&#x8651;&#x4E0D;&#x540C;&#x63A5;&#x5904;&#x7406;&#x624B;&#x6BB5;&#xFF0C;&#x8FD9;&#x53D8;&#x76F8;&#x7684;&#x589E;&#x52A0;&#x4E86;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x7684;&#x4EBA;&#x529B;&#x8D44;&#x6E90;&#x3002;</p>\n<p>&#x4E3A;&#x6B64;&#x6211;&#x4EEC;&#x8003;&#x8651;&#x600E;&#x6837;&#x53EF;&#x4EE5;&#x6700;&#x5927;&#x9650;&#x5EA6;&#x7684;&#x7EDF;&#x4E00;&#x5404;&#x4E2A;&#x62A5;&#x8B66;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x7EDF;&#x4E00;&#x7684;&#x5904;&#x7406;&#x5E73;&#x53F0;&#x3002;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;Flink&#x6765;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x9762;&#x524D;&#x3002;</p>\n<p>Flink&#x662F;&#x4EC0;&#x4E48;&#x76F8;&#x6BD4;&#x4E0D;&#x7528;&#x4ECB;&#x7ECD;&#x4E86;&#xFF0C;&#x5B98;&#x7F51;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x7684;&#x76F8;&#x5F53;&#x8BE6;&#x7EC6;&#x4E86;&#xFF1A;<br><a href=\"https://flink.apache.org/\">https://flink.apache.org/</a></p>\n<p>&#x4E0A;&#x9762;&#x62BD;&#x8C61;&#x7684;&#x76D1;&#x63A7;&#x6D41;&#x7A0B;&#xFF1A;&#x76D1;&#x63A7;&#x6570;&#x636E;&#x6E90;&#x2013;&gt; &#x76D1;&#x63A7;&#x6570;&#x636E;&#x6E05;&#x6D17; &#x2013;&gt; &#x76D1;&#x63A7;&#x6570;&#x636E;&#x8BA1;&#x7B97; &#x2013;&gt; &#x63A8;&#x9001;&#x62A5;&#x8B66;</p>\n<p>&#x7528;Flink&#x53EF;&#x4EE5;&#x8868;&#x793A;&#x4E3A;&#xFF1A;Source&#x2013;&gt; ETL&#x2013;&gt; Operator&#x2013;&gt; Sink</p>\n<p>&#x7ED3;&#x5408;&#x4E0A;&#x9762;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x6211;&#x6253;&#x7B97;&#x5148;&#x4ECE;&#x63A8;&#x9001;&#x62A5;&#x8B66;&#x529F;&#x80FD;&#x5165;&#x624B;&#x3002;&#x5229;&#x7528;Flink&#x7684;&#x6D41;&#x5F0F;&#x5904;&#x7406;&#x80FD;&#x529B;&#xFF0C;&#x5F00;&#x53D1;&#x4E00;&#x4E2A;&#x7EDF;&#x4E00;&#x7684;&#x62A5;&#x8B66;&#x51FA;&#x53E3;&#x4EFB;&#x52A1;&#x3002;</p>\n<h4 id=\"&#x6570;&#x636E;&#x6E90;\"><a href=\"#&#x6570;&#x636E;&#x6E90;\" class=\"headerlink\" title=\"&#x6570;&#x636E;&#x6E90;\"></a>&#x6570;&#x636E;&#x6E90;</h4><p>&#x6570;&#x636E;&#x6E90;&#x6211;&#x4EEC;&#x6253;&#x7B97;&#x91C7;&#x7528;RocketMQ&#x3002;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x7EDF;&#x4E00;&#x7684;&#x62A5;&#x8B66;&#x63A8;&#x9001;Topic&#xFF0C;&#x5B9A;&#x4E49;&#x7EDF;&#x4E00;&#x7684;&#x62A5;&#x8B66;&#x6D88;&#x606F;&#x683C;&#x5F0F;&#x3002;</p>\n<table>\n<thead>\n<tr>\n<th>Topic</th>\n<th>AlertWechatTopic</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Body</td>\n<td>{&#x201C;alertMsg&#x201D;:&#x201D;&#x201D;,<br>&#x201C;alertTo&#x201D;:&#x201D;&#x201D;,<br>&#x201C;bizType&#x201D;:&#x201D;&#x201D;<br> }</td>\n</tr>\n</tbody></table>\n<h4 id=\"&#x7B97;&#x5B50;\"><a href=\"#&#x7B97;&#x5B50;\" class=\"headerlink\" title=\"&#x7B97;&#x5B50;\"></a>&#x7B97;&#x5B50;</h4><ol>\n<li><p>&#x5E94;&#x7528;RocketMQ-Extend&#x63D0;&#x4F9B;&#x7684;Flink&#x652F;&#x6301;&#xFF0C;&#x5B98;&#x65B9;&#x7EE7;&#x627F;&#x4E86;RichParallelSourceFunction&#x7C7B;&#x3002;&#x5B9E;&#x73B0;&#x4E86;&#x6CE8;&#x518C;Consumer&#xFF0C;&#x62C9;&#x53D6;Topic&#x4E0B;&#x7684;&#x6D88;&#x606F;&#x3002;</p>\n</li>\n<li><p>&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#x7684;&#x5E8F;&#x5217;&#x5316;&#x65B9;&#x6CD5;&#x4EC5;&#x6709;&#x9488;&#x5BF9;key&#x548C;value&#x7684;String&#x5E8F;&#x5217;&#x5316;SimpleKeyValueDeserializationSchema&#x3002;&#x5728;&#x8FD0;&#x7528;&#x4E0A;&#x662F;&#x6EE1;&#x8DB3;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x540E;&#x671F;&#x7F16;&#x7A0B;&#x4E0A;&#x53EF;&#x80FD;&#x81EA;&#x5B9A;&#x4E49;&#x4F1A;&#x66F4;&#x52A0;&#x65B9;&#x4FBF;&#x3002;&#x540E;&#x671F;&#x6211;&#x4EEC;&#x4F1A;&#x8003;&#x8651;&#x6269;&#x5C55;&#x5E8F;&#x5217;&#x5316;&#x65B9;&#x5F0F;&#x6216;&#x662F;&#x5B98;&#x65B9;&#x63D0;&#x4F9B;&#x7684;&#x62C9;&#x53D6;&#x6D88;&#x606F;&#x6E90;&#x7801;&#xFF0C;&#x505A;&#x5230;&#x66F4;&#x7075;&#x6D3B;&#x7684;&#x6D88;&#x606F;&#x683C;&#x5F0F;&#x4F20;&#x8F93;&#x3002;</p>\n</li>\n<li><p>&#x5C06;&#x4ECE;RocketMQ&#x4E2D;&#x62C9;&#x53D6;&#x5230;&#x7684;&#x6D88;&#x606F;&#x505A;Map&#xFF0C;&#x683C;&#x5F0F;&#x5316;&#x6210;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x7684;&#x7ED3;&#x6784;&#x3002;</p>\n</li>\n</ol>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> </span>{</span><br><span class=\"line\">        ParameterTool parameterTool = ParameterTool.fromArgs(args);</span><br><span class=\"line\">        String nameserverAddress = parameterTool.get(<span class=\"hljs-string\">&quot;nameserverAddress&quot;</span>);</span><br><span class=\"line\">        String consumerGroup = parameterTool.get(<span class=\"hljs-string\">&quot;consumerGroup&quot;</span>);</span><br><span class=\"line\">        String consumerTopic = parameterTool.get(<span class=\"hljs-string\">&quot;consumerTopic&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class=\"line\">        SendWechatService sendWechatService = <span class=\"hljs-keyword\">new</span> SendWechatService();</span><br><span class=\"line\">        <span class=\"hljs-comment\">// enable checkpoint</span></span><br><span class=\"line\">        env.enableCheckpointing(<span class=\"hljs-number\">3000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        Properties consumerProps = <span class=\"hljs-keyword\">new</span> Properties();</span><br><span class=\"line\">        consumerProps.setProperty(RocketMQConfig.NAME_SERVER_ADDR, nameserverAddress);</span><br><span class=\"line\">        consumerProps.setProperty(RocketMQConfig.CONSUMER_GROUP, consumerGroup);</span><br><span class=\"line\">        consumerProps.setProperty(RocketMQConfig.CONSUMER_TOPIC, consumerTopic);</span><br><span class=\"line\"></span><br><span class=\"line\">        env.addSource(<span class=\"hljs-keyword\">new</span> RocketMQSource&lt;Map&gt;(<span class=\"hljs-keyword\">new</span> SimpleKeyValueDeserializationSchema(<span class=\"hljs-keyword\">null</span>,<span class=\"hljs-string\">&quot;body&quot;</span>),consumerProps))</span><br><span class=\"line\">                .name(<span class=\"hljs-string\">&quot;rocketmq-source&quot;</span>)</span><br><span class=\"line\">                .map(<span class=\"hljs-keyword\">new</span> MapFunction&lt;Map, WechatAlertInfo&gt;() {</span><br><span class=\"line\">                    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">                    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> WechatAlertInfo <span class=\"hljs-title\">map</span><span class=\"hljs-params\">(Map value)</span> <span class=\"hljs-keyword\">throws</span> Exception </span>{</span><br><span class=\"line\">                        String body = (String)value.get(<span class=\"hljs-string\">&quot;body&quot;</span>);</span><br><span class=\"line\">                        WechatAlertInfo wechatAlertInfo = JSONObject.parseObject(body, WechatAlertInfo.class);</span><br><span class=\"line\">                        <span class=\"hljs-keyword\">return</span> wechatAlertInfo;</span><br><span class=\"line\">                    }</span><br><span class=\"line\">                }).addSink(<span class=\"hljs-keyword\">new</span> WechatSink())</span><br><span class=\"line\">                .name(<span class=\"hljs-string\">&quot;wechat sink&quot;</span>);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">try</span> {</span><br><span class=\"line\">            env.execute(<span class=\"hljs-string\">&quot;send to wechat&quot;</span>);</span><br><span class=\"line\">        } <span class=\"hljs-keyword\">catch</span> (Exception e) {</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br></pre></td></tr></tbody></table></figure>\n\n<ol start=\"4\">\n<li>&#x5C06;&#x683C;&#x5F0F;&#x5316;&#x5B8C;&#x6210;&#x7684;&#x6570;&#x636E;&#x6E90;&#x8F93;&#x51FA;&#x5230;&#x6211;&#x4EEC;&#x81EA;&#x5B9A;&#x4E49;&#x7684;Sink&#x4E2D;&#xFF0C;&#x8BE5;sink&#x7684;&#x529F;&#x80FD;&#x4E3A;&#x53D1;&#x9001;wechat&#x4FE1;&#x606F;&#x3002;</li>\n</ol>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">WechatSink</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">RichSinkFunction</span>&lt;<span class=\"hljs-title\">WechatAlertInfo</span>&gt; </span>{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">transient</span> SendWechatService sendWechatService;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">open</span><span class=\"hljs-params\">(Configuration parameters)</span> <span class=\"hljs-keyword\">throws</span> Exception </span>{</span><br><span class=\"line\">        sendWechatService = <span class=\"hljs-keyword\">new</span> SendWechatService();</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">invoke</span><span class=\"hljs-params\">(WechatAlertInfo value, Context context)</span> <span class=\"hljs-keyword\">throws</span> Exception </span>{</span><br><span class=\"line\">        sendWechatService.sendMessage(value.getAlertMsg(),value.getAlertTo());</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x4EE5;&#x4E0A;&#x6211;&#x4EEC;&#x5C31;&#x7B80;&#x5355;&#x7684;&#x5B9E;&#x73B0;&#x4E86;&#x5C06;RocketMQ&#x4E2D;&#x7684;&#x62A5;&#x8B66;&#x6D88;&#x606F;&#x63A8;&#x9001;&#x81F3;wechat&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x4E0B;&#x6B21;&#x6211;&#x4EEC;&#x628A;&#x4EE3;&#x7801;&#x8DD1;&#x8D77;&#x6765;&#x770B;&#x770B;&#x3002;</p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Flink","path":"tags/Flink/"},{"name":"监控","path":"tags/监控/"}],"excerpt":"<html><head></head><body><p>&#x6700;&#x8FD1;&#x5728;&#x6574;&#x7406;&#x540E;&#x7AEF;&#x5DF2;&#x6709;&#x7684;&#x9519;&#x8BEF;&#x62A5;&#x8B66;&#xFF0C;&#x4E3B;&#x8981;&#x5206;&#x4E24;&#x5927;&#x7C7B;&#xFF1A;</p>\n<ol>\n<li>&#x5F02;&#x5E38;&#x62A5;&#x8B66;<ul>\n<li>&#x57FA;&#x4E8E;&#x76D1;&#x63A7;&#x7CFB;&#x7EDF;&#x3002;&#x5982;CAT&#x3001;pingpong&#x3001;skywalking&#x7B49;APM&#x7CFB;&#x7EDF;&#x7684;&#x9519;&#x8BEF;&#x5F02;&#x5E38;&#x76D1;&#x63A7;&#x3002;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x9488;&#x5BF9;&#x5F02;&#x5E38;&#x7C7B;&#x578B;&#xFF0C;&#x5236;&#x5B9A;&#x76F8;&#x5E94;&#x7684;&#x9608;&#x503C;&#x3002;&#x5BF9;&#x4EE3;&#x7801;&#x8FD0;&#x884C;&#x65F6;&#x5F02;&#x5E38;&#x3001;sql&#x5F02;&#x5E38;&#x3001;&#x7F51;&#x7EDC;&#x5F02;&#x5E38;&#x7B49;&#x8FDB;&#x884C;&#x6307;&#x6807;&#x76D1;&#x63A7;&#x3002;&#x5F53;&#x5F02;&#x5E38;&#x8D85;&#x8FC7;&#x6307;&#x5B9A;&#x9608;&#x503C;&#x65F6;&#x63A8;&#x9001;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x3002;&#x6211;&#x4EEC;&#x7684;&#x540E;&#x7AEF;&#x7CFB;&#x7EDF;&#x662F;&#x57FA;&#x4E8E;CAT&#x8FDB;&#x884C;&#x76D1;&#x63A7;&#xFF0C;&#x76D1;&#x63A7;&#x7684;&#x6307;&#x6807;&#x548C;&#x914D;&#x7F6E;&#x90FD;&#x8981;&#x4EBA;&#x4E3A;&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#xFF0C;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x7684;&#x63A8;&#x9001;&#x9700;&#x8981;&#x5F00;&#x53D1;&#x5E76;&#x4E0E;CAT&#x5BF9;&#x63A5;&#xFF0C;&#x540C;&#x65F6;&#x5FAE;&#x4FE1;&#x63A8;&#x9001;&#x8FD9;&#x5757;&#x5F02;&#x5E38;&#x4FE1;&#x606F;&#x6709;&#x9650;&#xFF0C;&#x5F80;&#x5F80;&#x8981;&#x901A;&#x8FC7;&#x90AE;&#x4EF6;&#x544A;&#x8B66;&#x548C;&#x767B;&#x5F55;CAT&#x5E73;&#x53F0;&#x67E5;&#x770B;&#x624D;&#x80FD;&#x5927;&#x6982;&#x4E86;&#x89E3;&#x9519;&#x8BEF;&#x7684;&#x7C7B;&#x578B;&#x3002;&#x8FD9;&#x70B9;&#x957F;&#x671F;&#x88AB;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x8BDF;&#x75C5;&#xFF0C;&#x867D;&#x7136;&#x6211;&#x4EEC;&#x80FD;&#x591F;&#x901A;&#x8FC7;&#x4FEE;&#x6539;CAT&#x7684;&#x6E90;&#x7801;&#x6765;&#x6539;&#x5584;&#x4E0A;&#x8BC9;&#x95EE;&#x9898;&#x3002;&#x4F46;&#x5BF9;&#x4E8E;&#x7A0B;&#x5E8F;&#x5458;&#x6765;&#x8BF4;&#xFF0C;&#x66F4;&#x52A0;&#x76F4;&#x89C2;&#x7684;&#x5806;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x662F;&#x518D;&#x597D;&#x4E0D;&#x8FC7;&#x7684;&#x4E8B;&#x60C5;&#x3002;</li>\n<li>&#x57FA;&#x4E8E;&#x7CFB;&#x7EDF;&#x6307;&#x6807;&#x3002;&#x6709;&#x522B;&#x4E8E;&#x670D;&#x52A1;&#x5F02;&#x5E38;&#xFF0C;&#x7CFB;&#x7EDF;&#x6307;&#x6807;&#x6709;&#x66F4;&#x7075;&#x6D3B;&#x7684;&#x91C7;&#x96C6;&#x65B9;&#x5F0F;&#x3002;&#x6211;&#x4EEC;&#x91C7;&#x7528;&#x4E86;Spring Merics&#xFF0C;&#x57FA;&#x4E8E;Prometheus&#x642D;&#x5EFA;&#x4E86;&#x7CFB;&#x7EDF;&#x6307;&#x6807;&#x7684;&#x76D1;&#x63A7;&#x4F53;&#x7CFB;&#xFF0C;&#x7ED3;&#x5408;Grafana&#x5C06;&#x8FD1;&#x5B9E;&#x65F6;&#x7684;&#x7CFB;&#x7EDF;&#x6307;&#x6807;&#x5C55;&#x73B0;&#x81F3;&#x5C4F;&#x5E55;&#x3002;&#x540C;&#x6837;&#x9047;&#x5230;&#x7CFB;&#x7EDF;&#x6307;&#x6807;&#x5F02;&#x5E38;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5982;Heap&#x7A7A;&#x95F4;&#x4F7F;&#x7528;&#x91CF;&#x5F02;&#x5E38;&#xFF0C;CPU&#x98D9;&#x9AD8;&#xFF0C;&#x5185;&#x5B58;&#x544A;&#x6025;&#x7B49;&#x60C5;&#x51B5;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;Grafana&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x544A;&#x8B66;&#x5C06;&#x9519;&#x8BEF;&#x63A8;&#x9001;&#x7ED9;&#x76F8;&#x5173;&#x5F00;&#x53D1;&#x3002;</li></ul></li></ol></body></html>","more":"\n\n\n<li>业务告警<ul>\n<li>基于实时数据。通过对业务流程的埋点，将采集的实时数据进行计算比较。并将异常的业务数据进行推送告警。</li>\n<li>基于离线数据。定时分析离线数据，推送异常业务数据告警。</li>\n</ul>\n</li>\n\n<p>以上大概介绍了监控的几个方向及其落地方式，通过分析我们可以将整个监控行为抽象成一个数据流：监控数据源–&gt; 监控数据清洗 –&gt; 监控数据计算 –&gt; 推送报警</p>\n<p>基于这个结论，正式我们会开始研究并探索Flink的契机。面对目前后端形形色色的监控方式及处理流程，每一个部分都是割裂的，无法统一思想的。面对不同的监控场景时，我们要考虑不同接处理手段，这变相的增加了开发人员的人力资源。</p>\n<p>为此我们考虑怎样可以最大限度的统一各个报警的流程，并提供一个统一的处理平台。这个时候Flink来到了我们面前。</p>\n<p>Flink是什么相比不用介绍了，官网已经介绍的相当详细了：<br><a href=\"https://flink.apache.org/\">https://flink.apache.org/</a></p>\n<p>上面抽象的监控流程：监控数据源–&gt; 监控数据清洗 –&gt; 监控数据计算 –&gt; 推送报警</p>\n<p>用Flink可以表示为：Source–&gt; ETL–&gt; Operator–&gt; Sink</p>\n<p>结合上面的分析，我打算先从推送报警功能入手。利用Flink的流式处理能力，开发一个统一的报警出口任务。</p>\n<h4 id=\"数据源\"><a href=\"#数据源\" class=\"headerlink\" title=\"数据源\"></a>数据源</h4><p>数据源我们打算采用RocketMQ。创建一个统一的报警推送Topic，定义统一的报警消息格式。</p>\n<table>\n<thead>\n<tr>\n<th>Topic</th>\n<th>AlertWechatTopic</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Body</td>\n<td>{“alertMsg”:””,<br>“alertTo”:””,<br>“bizType”:””<br> }</td>\n</tr>\n</tbody></table>\n<h4 id=\"算子\"><a href=\"#算子\" class=\"headerlink\" title=\"算子\"></a>算子</h4><ol>\n<li><p>应用RocketMQ-Extend提供的Flink支持，官方继承了RichParallelSourceFunction类。实现了注册Consumer，拉取Topic下的消息。</p>\n</li>\n<li><p>官方提供的序列化方法仅有针对key和value的String序列化SimpleKeyValueDeserializationSchema。在运用上是满足的，但是后期编程上可能自定义会更加方便。后期我们会考虑扩展序列化方式或是官方提供的拉取消息源码，做到更灵活的消息格式传输。</p>\n</li>\n<li><p>将从RocketMQ中拉取到的消息做Map，格式化成我们希望的结构。</p>\n</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> </span>&#123;</span><br><span class=\"line\">        ParameterTool parameterTool = ParameterTool.fromArgs(args);</span><br><span class=\"line\">        String nameserverAddress = parameterTool.get(<span class=\"string\">&quot;nameserverAddress&quot;</span>);</span><br><span class=\"line\">        String consumerGroup = parameterTool.get(<span class=\"string\">&quot;consumerGroup&quot;</span>);</span><br><span class=\"line\">        String consumerTopic = parameterTool.get(<span class=\"string\">&quot;consumerTopic&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class=\"line\">        SendWechatService sendWechatService = <span class=\"keyword\">new</span> SendWechatService();</span><br><span class=\"line\">        <span class=\"comment\">// enable checkpoint</span></span><br><span class=\"line\">        env.enableCheckpointing(<span class=\"number\">3000</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        Properties consumerProps = <span class=\"keyword\">new</span> Properties();</span><br><span class=\"line\">        consumerProps.setProperty(RocketMQConfig.NAME_SERVER_ADDR, nameserverAddress);</span><br><span class=\"line\">        consumerProps.setProperty(RocketMQConfig.CONSUMER_GROUP, consumerGroup);</span><br><span class=\"line\">        consumerProps.setProperty(RocketMQConfig.CONSUMER_TOPIC, consumerTopic);</span><br><span class=\"line\"></span><br><span class=\"line\">        env.addSource(<span class=\"keyword\">new</span> RocketMQSource&lt;Map&gt;(<span class=\"keyword\">new</span> SimpleKeyValueDeserializationSchema(<span class=\"keyword\">null</span>,<span class=\"string\">&quot;body&quot;</span>),consumerProps))</span><br><span class=\"line\">                .name(<span class=\"string\">&quot;rocketmq-source&quot;</span>)</span><br><span class=\"line\">                .map(<span class=\"keyword\">new</span> MapFunction&lt;Map, WechatAlertInfo&gt;() &#123;</span><br><span class=\"line\">                    <span class=\"meta\">@Override</span></span><br><span class=\"line\">                    <span class=\"function\"><span class=\"keyword\">public</span> WechatAlertInfo <span class=\"title\">map</span><span class=\"params\">(Map value)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">                        String body = (String)value.get(<span class=\"string\">&quot;body&quot;</span>);</span><br><span class=\"line\">                        WechatAlertInfo wechatAlertInfo = JSONObject.parseObject(body, WechatAlertInfo.class);</span><br><span class=\"line\">                        <span class=\"keyword\">return</span> wechatAlertInfo;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;).addSink(<span class=\"keyword\">new</span> WechatSink())</span><br><span class=\"line\">                .name(<span class=\"string\">&quot;wechat sink&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            env.execute(<span class=\"string\">&quot;send to wechat&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>将格式化完成的数据源输出到我们自定义的Sink中，该sink的功能为发送wechat信息。</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">WechatSink</span> <span class=\"keyword\">extends</span> <span class=\"title\">RichSinkFunction</span>&lt;<span class=\"title\">WechatAlertInfo</span>&gt; </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">transient</span> SendWechatService sendWechatService;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">open</span><span class=\"params\">(Configuration parameters)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        sendWechatService = <span class=\"keyword\">new</span> SendWechatService();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">invoke</span><span class=\"params\">(WechatAlertInfo value, Context context)</span> <span class=\"keyword\">throws</span> Exception </span>&#123;</span><br><span class=\"line\">        sendWechatService.sendMessage(value.getAlertMsg(),value.getAlertTo());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>以上我们就简单的实现了将RocketMQ中的报警消息推送至wechat的功能，下次我们把代码跑起来看看。</p>"},{"title":"我为什么会手撸一个配置中心--介绍篇","date":"2020-03-20T13:39:15.000Z","_content":"nadia-config是一款基于spring boot的配置中心，能够集中化管理不同环境、不同版本的集群配置，并提供配置的实时更新、回调、审批、权限管理等功能。\n>https://github.com/nadia-repository/nadia-config\n\n# Nadia Config Center\n\n## 组件介绍\n- [nadia-client](nadia-client/README.md)\n- [nadia-server](nadia-server/README.md)\n\n## Release-Note\n- v1.0\n<!-- more -->\n## 主要目标：\n\n- 兼容springboot框架，业务系统无需代码变更\n- 快速接入，jar包引用\n- 配置动态更新，实时生效\n- 支持集群分组，配置差异化\n- 提供配置统一变更平台，支持平台用户的权限管理和配置变更的权限管理\n\n#### 部署图\n\n![01](我为什么会重新写一个配置中心-介绍篇/服务部署图.png)\n\n#### 项目构成\n> nadia-config 项目根目录\n\n>> nadia-client 客户端\n\n>> nadia-core 通用代码\n\n>> nadia-server 服务端\n\n>> nadia-web 前端页面\n\n>> nadia-demo 客户端demo\n\n>> docs 文档\n\n>>> desgin 设计文档\n\n>>> sql 服务端脚本\n\n>>>> DDL.sql 建表\n\n>>>> DML.sql 初始数据\n\n\n#### 管理平台介绍\n\n#### 1. 登录页面\n\n![02](我为什么会重新写一个配置中心-介绍篇/登录.png)\n\n#### 2. 注册页面\n\n![03](我为什么会重新写一个配置中心-介绍篇/注册.png)\n\n\n#### 3. 主界面\n###### 根据登录用户的角色不同，菜单按钮会有相应变化\n\n![04](我为什么会重新写一个配置中心-介绍篇/主页面.png)\n\n\n#### 4. 配置管理--元数据管理\n###### 元数据管理是所有配置的基础，客户端使用配置项时需要指定相关的元数据\n\n![05](我为什么会重新写一个配置中心-介绍篇/metadata.png)\n\n\n###### 名词解释\n* Application 系统名称，客户端可以指定使用任意一套系统下的配置。\n* Group 组名称，客户端指定系统后，仍需要指定使用系统下的某个组。若不强制指定，客户端启动后会默认使用Default组下的配置，后期可使用组切换功能切换至不同组。\n\n###### 功能说明\n* Add 新增Application，同时新增默认Group(Default)。\n* Delete 删除Application\\Group信息。当前Group如果正在被使用，或当前组为Default组且存在非Default组时，不能删除。Defualt组删除后将同时删除Application。\n* Compare 比较同一Application下不同Group的配置差异，可多选，但至少选两个组。\n\n![06](我为什么会重新写一个配置中心-介绍篇/compare.png)\n\n\n* Edit 修改Application信息\n* Group 新增组。可选择从某个组复制所有已发布配置项，或生产新的空组。\n\n![07](我为什么会重新写一个配置中心-介绍篇/addGroup.png)\n\n\n* Instances 可将某实例调整至另一组。\n\n![08](我为什么会重新写一个配置中心-介绍篇/switch.png)\n\n\n* Inscance 查看弄实例当前的配置与服务端配置的差异。\n\n![09](我为什么会重新写一个配置中心-介绍篇/instance.png)\n\n\n#### 5. 配置管理--配置项管理\n###### 配置项管理提供具体配置的增删改查、发布等功能\n\n![10](我为什么会重新写一个配置中心-介绍篇/configs.png)\n\n\n###### 名词解释\n* Key 配置项的key，与客户端中@Value({key})相对应\n* Value 值\n* Status \n    * new 新建配置\n    * edited 配置已变更，带审批\n    * approved 配置审批通过，可发布\n    * published 配置已发布\n    * removing 配置删除，待审批\n    * deleted 配置已删除，不显示\n    * invalid 配置无效，不显示\n    \n###### 功能说明\n* Add 新增配置，可选择配置的可见权限。若不选择，则该配置为当前登录用户的角色可见。需要审批。\n* Delete 删除配置，需要审批。\n* Export 导出配置。\n* Import 导入配置，需要审批。\n* Edit 编辑配置，需要审批。\n* Instance 查看当前配置的使用情况。\n\n![11](我为什么会重新写一个配置中心-介绍篇/instanceConfig.png)\n\n\n* History 配置修改历史\n\n![12](我为什么会重新写一个配置中心-介绍篇/history.png)\n\n\n#### 6. 配置管理--配置项分配\n###### 配置项分配提供全局的角色配置可见权限设置。\n\n![13](我为什么会重新写一个配置中心-介绍篇/allocate.png)\n\n\n###### 功能说明\n* Allocate 分配角色可见配置\n\n![14](我为什么会重新写一个配置中心-介绍篇/allocateConfigs.png)\n\n\n#### 7. 消息中心--操作日志\n###### 提供管理平台所有增删改的操作日志查询和回溯。\n\n![15](我为什么会重新写一个配置中心-介绍篇/operationLog.png)\n\n\n#### 8. 消息中心--任务中心\n###### 提供审批查看、审批操作(通过、拒绝)等功能。\n* Pending Task 待审批列表，提供审批通过、决绝，审配内容查看等功能。\n\n![16](我为什么会重新写一个配置中心-介绍篇/pendingTask.png)\n\n\n* Processing Task 审批进度列表，提供审批进度的查询。\n\n![17](我为什么会重新写一个配置中心-介绍篇/processingTask.png)\n\n\n* Complete Task 完成任务列表，提供历史审批通过、拒绝的任务的查询。\n\n![18](我为什么会重新写一个配置中心-介绍篇/completeTask.png)\n\n\n#### 9. 消息中心--操作日志\n###### 提供客户端上报日志的查询。\n\n![19](我为什么会重新写一个配置中心-介绍篇/clientLog.png)\n\n\n#### 10. 用户中心--角色管理\n###### 提供角色的增删改查，角色的菜单权限、按钮权限的设置。\n\n![20](我为什么会重新写一个配置中心-介绍篇/role.png)\n\n\n#### 11. 用户中心--用户管理\n###### 提供用户的增删改查，用户的角色分配设置。\n\n![21](我为什么会重新写一个配置中心-介绍篇/user.png)\n\n","source":"_posts/我为什么会重新写一个配置中心-介绍篇.md","raw":"---\ntitle: 我为什么会手撸一个配置中心--介绍篇\ndate: 2020-03-20 21:39:15\ntags: \n    - Java\n    - Redis\n    - 配置中心\ncategories :\n    - Technology\n---\nnadia-config是一款基于spring boot的配置中心，能够集中化管理不同环境、不同版本的集群配置，并提供配置的实时更新、回调、审批、权限管理等功能。\n>https://github.com/nadia-repository/nadia-config\n\n# Nadia Config Center\n\n## 组件介绍\n- [nadia-client](nadia-client/README.md)\n- [nadia-server](nadia-server/README.md)\n\n## Release-Note\n- v1.0\n<!-- more -->\n## 主要目标：\n\n- 兼容springboot框架，业务系统无需代码变更\n- 快速接入，jar包引用\n- 配置动态更新，实时生效\n- 支持集群分组，配置差异化\n- 提供配置统一变更平台，支持平台用户的权限管理和配置变更的权限管理\n\n#### 部署图\n\n![01](我为什么会重新写一个配置中心-介绍篇/服务部署图.png)\n\n#### 项目构成\n> nadia-config 项目根目录\n\n>> nadia-client 客户端\n\n>> nadia-core 通用代码\n\n>> nadia-server 服务端\n\n>> nadia-web 前端页面\n\n>> nadia-demo 客户端demo\n\n>> docs 文档\n\n>>> desgin 设计文档\n\n>>> sql 服务端脚本\n\n>>>> DDL.sql 建表\n\n>>>> DML.sql 初始数据\n\n\n#### 管理平台介绍\n\n#### 1. 登录页面\n\n![02](我为什么会重新写一个配置中心-介绍篇/登录.png)\n\n#### 2. 注册页面\n\n![03](我为什么会重新写一个配置中心-介绍篇/注册.png)\n\n\n#### 3. 主界面\n###### 根据登录用户的角色不同，菜单按钮会有相应变化\n\n![04](我为什么会重新写一个配置中心-介绍篇/主页面.png)\n\n\n#### 4. 配置管理--元数据管理\n###### 元数据管理是所有配置的基础，客户端使用配置项时需要指定相关的元数据\n\n![05](我为什么会重新写一个配置中心-介绍篇/metadata.png)\n\n\n###### 名词解释\n* Application 系统名称，客户端可以指定使用任意一套系统下的配置。\n* Group 组名称，客户端指定系统后，仍需要指定使用系统下的某个组。若不强制指定，客户端启动后会默认使用Default组下的配置，后期可使用组切换功能切换至不同组。\n\n###### 功能说明\n* Add 新增Application，同时新增默认Group(Default)。\n* Delete 删除Application\\Group信息。当前Group如果正在被使用，或当前组为Default组且存在非Default组时，不能删除。Defualt组删除后将同时删除Application。\n* Compare 比较同一Application下不同Group的配置差异，可多选，但至少选两个组。\n\n![06](我为什么会重新写一个配置中心-介绍篇/compare.png)\n\n\n* Edit 修改Application信息\n* Group 新增组。可选择从某个组复制所有已发布配置项，或生产新的空组。\n\n![07](我为什么会重新写一个配置中心-介绍篇/addGroup.png)\n\n\n* Instances 可将某实例调整至另一组。\n\n![08](我为什么会重新写一个配置中心-介绍篇/switch.png)\n\n\n* Inscance 查看弄实例当前的配置与服务端配置的差异。\n\n![09](我为什么会重新写一个配置中心-介绍篇/instance.png)\n\n\n#### 5. 配置管理--配置项管理\n###### 配置项管理提供具体配置的增删改查、发布等功能\n\n![10](我为什么会重新写一个配置中心-介绍篇/configs.png)\n\n\n###### 名词解释\n* Key 配置项的key，与客户端中@Value({key})相对应\n* Value 值\n* Status \n    * new 新建配置\n    * edited 配置已变更，带审批\n    * approved 配置审批通过，可发布\n    * published 配置已发布\n    * removing 配置删除，待审批\n    * deleted 配置已删除，不显示\n    * invalid 配置无效，不显示\n    \n###### 功能说明\n* Add 新增配置，可选择配置的可见权限。若不选择，则该配置为当前登录用户的角色可见。需要审批。\n* Delete 删除配置，需要审批。\n* Export 导出配置。\n* Import 导入配置，需要审批。\n* Edit 编辑配置，需要审批。\n* Instance 查看当前配置的使用情况。\n\n![11](我为什么会重新写一个配置中心-介绍篇/instanceConfig.png)\n\n\n* History 配置修改历史\n\n![12](我为什么会重新写一个配置中心-介绍篇/history.png)\n\n\n#### 6. 配置管理--配置项分配\n###### 配置项分配提供全局的角色配置可见权限设置。\n\n![13](我为什么会重新写一个配置中心-介绍篇/allocate.png)\n\n\n###### 功能说明\n* Allocate 分配角色可见配置\n\n![14](我为什么会重新写一个配置中心-介绍篇/allocateConfigs.png)\n\n\n#### 7. 消息中心--操作日志\n###### 提供管理平台所有增删改的操作日志查询和回溯。\n\n![15](我为什么会重新写一个配置中心-介绍篇/operationLog.png)\n\n\n#### 8. 消息中心--任务中心\n###### 提供审批查看、审批操作(通过、拒绝)等功能。\n* Pending Task 待审批列表，提供审批通过、决绝，审配内容查看等功能。\n\n![16](我为什么会重新写一个配置中心-介绍篇/pendingTask.png)\n\n\n* Processing Task 审批进度列表，提供审批进度的查询。\n\n![17](我为什么会重新写一个配置中心-介绍篇/processingTask.png)\n\n\n* Complete Task 完成任务列表，提供历史审批通过、拒绝的任务的查询。\n\n![18](我为什么会重新写一个配置中心-介绍篇/completeTask.png)\n\n\n#### 9. 消息中心--操作日志\n###### 提供客户端上报日志的查询。\n\n![19](我为什么会重新写一个配置中心-介绍篇/clientLog.png)\n\n\n#### 10. 用户中心--角色管理\n###### 提供角色的增删改查，角色的菜单权限、按钮权限的设置。\n\n![20](我为什么会重新写一个配置中心-介绍篇/role.png)\n\n\n#### 11. 用户中心--用户管理\n###### 提供用户的增删改查，用户的角色分配设置。\n\n![21](我为什么会重新写一个配置中心-介绍篇/user.png)\n\n","slug":"我为什么会重新写一个配置中心-介绍篇","published":1,"updated":"2020-12-14T10:33:44.564Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htk0012v252dysvfnfm","content":"<html><head></head><body><p>nadia-config&#x662F;&#x4E00;&#x6B3E;&#x57FA;&#x4E8E;spring boot&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#xFF0C;&#x80FD;&#x591F;&#x96C6;&#x4E2D;&#x5316;&#x7BA1;&#x7406;&#x4E0D;&#x540C;&#x73AF;&#x5883;&#x3001;&#x4E0D;&#x540C;&#x7248;&#x672C;&#x7684;&#x96C6;&#x7FA4;&#x914D;&#x7F6E;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x914D;&#x7F6E;&#x7684;&#x5B9E;&#x65F6;&#x66F4;&#x65B0;&#x3001;&#x56DE;&#x8C03;&#x3001;&#x5BA1;&#x6279;&#x3001;&#x6743;&#x9650;&#x7BA1;&#x7406;&#x7B49;&#x529F;&#x80FD;&#x3002;</p>\n<blockquote>\n<p><a href=\"https://github.com/nadia-repository/nadia-config\">https://github.com/nadia-repository/nadia-config</a></p>\n</blockquote>\n<h1 id=\"Nadia-Config-Center\"><a href=\"#Nadia-Config-Center\" class=\"headerlink\" title=\"Nadia Config Center\"></a>Nadia Config Center</h1><h2 id=\"&#x7EC4;&#x4EF6;&#x4ECB;&#x7ECD;\"><a href=\"#&#x7EC4;&#x4EF6;&#x4ECB;&#x7ECD;\" class=\"headerlink\" title=\"&#x7EC4;&#x4EF6;&#x4ECB;&#x7ECD;\"></a>&#x7EC4;&#x4EF6;&#x4ECB;&#x7ECD;</h2><ul>\n<li><a href=\"nadia-client/README.md\">nadia-client</a></li>\n<li><a href=\"nadia-server/README.md\">nadia-server</a></li>\n</ul>\n<h2 id=\"Release-Note\"><a href=\"#Release-Note\" class=\"headerlink\" title=\"Release-Note\"></a>Release-Note</h2><ul>\n<li><p>v1.0</p>\n<a id=\"more\"></a>\n<h2 id=\"&#x4E3B;&#x8981;&#x76EE;&#x6807;&#xFF1A;\"><a href=\"#&#x4E3B;&#x8981;&#x76EE;&#x6807;&#xFF1A;\" class=\"headerlink\" title=\"&#x4E3B;&#x8981;&#x76EE;&#x6807;&#xFF1A;\"></a>&#x4E3B;&#x8981;&#x76EE;&#x6807;&#xFF1A;</h2></li>\n<li><p>&#x517C;&#x5BB9;springboot&#x6846;&#x67B6;&#xFF0C;&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;&#x65E0;&#x9700;&#x4EE3;&#x7801;&#x53D8;&#x66F4;</p>\n</li>\n<li><p>&#x5FEB;&#x901F;&#x63A5;&#x5165;&#xFF0C;jar&#x5305;&#x5F15;&#x7528;</p>\n</li>\n<li><p>&#x914D;&#x7F6E;&#x52A8;&#x6001;&#x66F4;&#x65B0;&#xFF0C;&#x5B9E;&#x65F6;&#x751F;&#x6548;</p>\n</li>\n<li><p>&#x652F;&#x6301;&#x96C6;&#x7FA4;&#x5206;&#x7EC4;&#xFF0C;&#x914D;&#x7F6E;&#x5DEE;&#x5F02;&#x5316;</p>\n</li>\n<li><p>&#x63D0;&#x4F9B;&#x914D;&#x7F6E;&#x7EDF;&#x4E00;&#x53D8;&#x66F4;&#x5E73;&#x53F0;&#xFF0C;&#x652F;&#x6301;&#x5E73;&#x53F0;&#x7528;&#x6237;&#x7684;&#x6743;&#x9650;&#x7BA1;&#x7406;&#x548C;&#x914D;&#x7F6E;&#x53D8;&#x66F4;&#x7684;&#x6743;&#x9650;&#x7BA1;&#x7406;</p>\n</li>\n</ul>\n<h4 id=\"&#x90E8;&#x7F72;&#x56FE;\"><a href=\"#&#x90E8;&#x7F72;&#x56FE;\" class=\"headerlink\" title=\"&#x90E8;&#x7F72;&#x56FE;\"></a>&#x90E8;&#x7F72;&#x56FE;</h4><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E5%9B%BE.png\" alt=\"01\"></p>\n<h4 id=\"&#x9879;&#x76EE;&#x6784;&#x6210;\"><a href=\"#&#x9879;&#x76EE;&#x6784;&#x6210;\" class=\"headerlink\" title=\"&#x9879;&#x76EE;&#x6784;&#x6210;\"></a>&#x9879;&#x76EE;&#x6784;&#x6210;</h4><blockquote>\n<p>nadia-config &#x9879;&#x76EE;&#x6839;&#x76EE;&#x5F55;</p>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>nadia-client &#x5BA2;&#x6237;&#x7AEF;</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>nadia-core &#x901A;&#x7528;&#x4EE3;&#x7801;</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>nadia-server &#x670D;&#x52A1;&#x7AEF;</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>nadia-web &#x524D;&#x7AEF;&#x9875;&#x9762;</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>nadia-demo &#x5BA2;&#x6237;&#x7AEF;demo</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>docs &#x6587;&#x6863;</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>desgin &#x8BBE;&#x8BA1;&#x6587;&#x6863;</p>\n</blockquote>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>sql &#x670D;&#x52A1;&#x7AEF;&#x811A;&#x672C;</p>\n</blockquote>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>DDL.sql &#x5EFA;&#x8868;</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>DML.sql &#x521D;&#x59CB;&#x6570;&#x636E;</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<h4 id=\"&#x7BA1;&#x7406;&#x5E73;&#x53F0;&#x4ECB;&#x7ECD;\"><a href=\"#&#x7BA1;&#x7406;&#x5E73;&#x53F0;&#x4ECB;&#x7ECD;\" class=\"headerlink\" title=\"&#x7BA1;&#x7406;&#x5E73;&#x53F0;&#x4ECB;&#x7ECD;\"></a>&#x7BA1;&#x7406;&#x5E73;&#x53F0;&#x4ECB;&#x7ECD;</h4><h4 id=\"1-&#x767B;&#x5F55;&#x9875;&#x9762;\"><a href=\"#1-&#x767B;&#x5F55;&#x9875;&#x9762;\" class=\"headerlink\" title=\"1. &#x767B;&#x5F55;&#x9875;&#x9762;\"></a>1. &#x767B;&#x5F55;&#x9875;&#x9762;</h4><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/%E7%99%BB%E5%BD%95.png\" alt=\"02\"></p>\n<h4 id=\"2-&#x6CE8;&#x518C;&#x9875;&#x9762;\"><a href=\"#2-&#x6CE8;&#x518C;&#x9875;&#x9762;\" class=\"headerlink\" title=\"2. &#x6CE8;&#x518C;&#x9875;&#x9762;\"></a>2. &#x6CE8;&#x518C;&#x9875;&#x9762;</h4><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/%E6%B3%A8%E5%86%8C.png\" alt=\"03\"></p>\n<h4 id=\"3-&#x4E3B;&#x754C;&#x9762;\"><a href=\"#3-&#x4E3B;&#x754C;&#x9762;\" class=\"headerlink\" title=\"3. &#x4E3B;&#x754C;&#x9762;\"></a>3. &#x4E3B;&#x754C;&#x9762;</h4><h6 id=\"&#x6839;&#x636E;&#x767B;&#x5F55;&#x7528;&#x6237;&#x7684;&#x89D2;&#x8272;&#x4E0D;&#x540C;&#xFF0C;&#x83DC;&#x5355;&#x6309;&#x94AE;&#x4F1A;&#x6709;&#x76F8;&#x5E94;&#x53D8;&#x5316;\"><a href=\"#&#x6839;&#x636E;&#x767B;&#x5F55;&#x7528;&#x6237;&#x7684;&#x89D2;&#x8272;&#x4E0D;&#x540C;&#xFF0C;&#x83DC;&#x5355;&#x6309;&#x94AE;&#x4F1A;&#x6709;&#x76F8;&#x5E94;&#x53D8;&#x5316;\" class=\"headerlink\" title=\"&#x6839;&#x636E;&#x767B;&#x5F55;&#x7528;&#x6237;&#x7684;&#x89D2;&#x8272;&#x4E0D;&#x540C;&#xFF0C;&#x83DC;&#x5355;&#x6309;&#x94AE;&#x4F1A;&#x6709;&#x76F8;&#x5E94;&#x53D8;&#x5316;\"></a>&#x6839;&#x636E;&#x767B;&#x5F55;&#x7528;&#x6237;&#x7684;&#x89D2;&#x8272;&#x4E0D;&#x540C;&#xFF0C;&#x83DC;&#x5355;&#x6309;&#x94AE;&#x4F1A;&#x6709;&#x76F8;&#x5E94;&#x53D8;&#x5316;</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/%E4%B8%BB%E9%A1%B5%E9%9D%A2.png\" alt=\"04\"></p>\n<h4 id=\"4-&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x5143;&#x6570;&#x636E;&#x7BA1;&#x7406;\"><a href=\"#4-&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x5143;&#x6570;&#x636E;&#x7BA1;&#x7406;\" class=\"headerlink\" title=\"4. &#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x5143;&#x6570;&#x636E;&#x7BA1;&#x7406;\"></a>4. &#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x5143;&#x6570;&#x636E;&#x7BA1;&#x7406;</h4><h6 id=\"&#x5143;&#x6570;&#x636E;&#x7BA1;&#x7406;&#x662F;&#x6240;&#x6709;&#x914D;&#x7F6E;&#x7684;&#x57FA;&#x7840;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x914D;&#x7F6E;&#x9879;&#x65F6;&#x9700;&#x8981;&#x6307;&#x5B9A;&#x76F8;&#x5173;&#x7684;&#x5143;&#x6570;&#x636E;\"><a href=\"#&#x5143;&#x6570;&#x636E;&#x7BA1;&#x7406;&#x662F;&#x6240;&#x6709;&#x914D;&#x7F6E;&#x7684;&#x57FA;&#x7840;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x914D;&#x7F6E;&#x9879;&#x65F6;&#x9700;&#x8981;&#x6307;&#x5B9A;&#x76F8;&#x5173;&#x7684;&#x5143;&#x6570;&#x636E;\" class=\"headerlink\" title=\"&#x5143;&#x6570;&#x636E;&#x7BA1;&#x7406;&#x662F;&#x6240;&#x6709;&#x914D;&#x7F6E;&#x7684;&#x57FA;&#x7840;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x914D;&#x7F6E;&#x9879;&#x65F6;&#x9700;&#x8981;&#x6307;&#x5B9A;&#x76F8;&#x5173;&#x7684;&#x5143;&#x6570;&#x636E;\"></a>&#x5143;&#x6570;&#x636E;&#x7BA1;&#x7406;&#x662F;&#x6240;&#x6709;&#x914D;&#x7F6E;&#x7684;&#x57FA;&#x7840;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x914D;&#x7F6E;&#x9879;&#x65F6;&#x9700;&#x8981;&#x6307;&#x5B9A;&#x76F8;&#x5173;&#x7684;&#x5143;&#x6570;&#x636E;</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/metadata.png\" alt=\"05\"></p>\n<h6 id=\"&#x540D;&#x8BCD;&#x89E3;&#x91CA;\"><a href=\"#&#x540D;&#x8BCD;&#x89E3;&#x91CA;\" class=\"headerlink\" title=\"&#x540D;&#x8BCD;&#x89E3;&#x91CA;\"></a>&#x540D;&#x8BCD;&#x89E3;&#x91CA;</h6><ul>\n<li>Application &#x7CFB;&#x7EDF;&#x540D;&#x79F0;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x4F7F;&#x7528;&#x4EFB;&#x610F;&#x4E00;&#x5957;&#x7CFB;&#x7EDF;&#x4E0B;&#x7684;&#x914D;&#x7F6E;&#x3002;</li>\n<li>Group &#x7EC4;&#x540D;&#x79F0;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x6307;&#x5B9A;&#x7CFB;&#x7EDF;&#x540E;&#xFF0C;&#x4ECD;&#x9700;&#x8981;&#x6307;&#x5B9A;&#x4F7F;&#x7528;&#x7CFB;&#x7EDF;&#x4E0B;&#x7684;&#x67D0;&#x4E2A;&#x7EC4;&#x3002;&#x82E5;&#x4E0D;&#x5F3A;&#x5236;&#x6307;&#x5B9A;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x542F;&#x52A8;&#x540E;&#x4F1A;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;Default&#x7EC4;&#x4E0B;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x540E;&#x671F;&#x53EF;&#x4F7F;&#x7528;&#x7EC4;&#x5207;&#x6362;&#x529F;&#x80FD;&#x5207;&#x6362;&#x81F3;&#x4E0D;&#x540C;&#x7EC4;&#x3002;</li>\n</ul>\n<h6 id=\"&#x529F;&#x80FD;&#x8BF4;&#x660E;\"><a href=\"#&#x529F;&#x80FD;&#x8BF4;&#x660E;\" class=\"headerlink\" title=\"&#x529F;&#x80FD;&#x8BF4;&#x660E;\"></a>&#x529F;&#x80FD;&#x8BF4;&#x660E;</h6><ul>\n<li>Add &#x65B0;&#x589E;Application&#xFF0C;&#x540C;&#x65F6;&#x65B0;&#x589E;&#x9ED8;&#x8BA4;Group(Default)&#x3002;</li>\n<li>Delete &#x5220;&#x9664;Application\\Group&#x4FE1;&#x606F;&#x3002;&#x5F53;&#x524D;Group&#x5982;&#x679C;&#x6B63;&#x5728;&#x88AB;&#x4F7F;&#x7528;&#xFF0C;&#x6216;&#x5F53;&#x524D;&#x7EC4;&#x4E3A;Default&#x7EC4;&#x4E14;&#x5B58;&#x5728;&#x975E;Default&#x7EC4;&#x65F6;&#xFF0C;&#x4E0D;&#x80FD;&#x5220;&#x9664;&#x3002;Defualt&#x7EC4;&#x5220;&#x9664;&#x540E;&#x5C06;&#x540C;&#x65F6;&#x5220;&#x9664;Application&#x3002;</li>\n<li>Compare &#x6BD4;&#x8F83;&#x540C;&#x4E00;Application&#x4E0B;&#x4E0D;&#x540C;Group&#x7684;&#x914D;&#x7F6E;&#x5DEE;&#x5F02;&#xFF0C;&#x53EF;&#x591A;&#x9009;&#xFF0C;&#x4F46;&#x81F3;&#x5C11;&#x9009;&#x4E24;&#x4E2A;&#x7EC4;&#x3002;</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/compare.png\" alt=\"06\"></p>\n<ul>\n<li>Edit &#x4FEE;&#x6539;Application&#x4FE1;&#x606F;</li>\n<li>Group &#x65B0;&#x589E;&#x7EC4;&#x3002;&#x53EF;&#x9009;&#x62E9;&#x4ECE;&#x67D0;&#x4E2A;&#x7EC4;&#x590D;&#x5236;&#x6240;&#x6709;&#x5DF2;&#x53D1;&#x5E03;&#x914D;&#x7F6E;&#x9879;&#xFF0C;&#x6216;&#x751F;&#x4EA7;&#x65B0;&#x7684;&#x7A7A;&#x7EC4;&#x3002;</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/addGroup.png\" alt=\"07\"></p>\n<ul>\n<li>Instances &#x53EF;&#x5C06;&#x67D0;&#x5B9E;&#x4F8B;&#x8C03;&#x6574;&#x81F3;&#x53E6;&#x4E00;&#x7EC4;&#x3002;</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/switch.png\" alt=\"08\"></p>\n<ul>\n<li>Inscance &#x67E5;&#x770B;&#x5F04;&#x5B9E;&#x4F8B;&#x5F53;&#x524D;&#x7684;&#x914D;&#x7F6E;&#x4E0E;&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x7684;&#x5DEE;&#x5F02;&#x3002;</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/instance.png\" alt=\"09\"></p>\n<h4 id=\"5-&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x914D;&#x7F6E;&#x9879;&#x7BA1;&#x7406;\"><a href=\"#5-&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x914D;&#x7F6E;&#x9879;&#x7BA1;&#x7406;\" class=\"headerlink\" title=\"5. &#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x914D;&#x7F6E;&#x9879;&#x7BA1;&#x7406;\"></a>5. &#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x914D;&#x7F6E;&#x9879;&#x7BA1;&#x7406;</h4><h6 id=\"&#x914D;&#x7F6E;&#x9879;&#x7BA1;&#x7406;&#x63D0;&#x4F9B;&#x5177;&#x4F53;&#x914D;&#x7F6E;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x3001;&#x53D1;&#x5E03;&#x7B49;&#x529F;&#x80FD;\"><a href=\"#&#x914D;&#x7F6E;&#x9879;&#x7BA1;&#x7406;&#x63D0;&#x4F9B;&#x5177;&#x4F53;&#x914D;&#x7F6E;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x3001;&#x53D1;&#x5E03;&#x7B49;&#x529F;&#x80FD;\" class=\"headerlink\" title=\"&#x914D;&#x7F6E;&#x9879;&#x7BA1;&#x7406;&#x63D0;&#x4F9B;&#x5177;&#x4F53;&#x914D;&#x7F6E;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x3001;&#x53D1;&#x5E03;&#x7B49;&#x529F;&#x80FD;\"></a>&#x914D;&#x7F6E;&#x9879;&#x7BA1;&#x7406;&#x63D0;&#x4F9B;&#x5177;&#x4F53;&#x914D;&#x7F6E;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#x3001;&#x53D1;&#x5E03;&#x7B49;&#x529F;&#x80FD;</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/configs.png\" alt=\"10\"></p>\n<h6 id=\"&#x540D;&#x8BCD;&#x89E3;&#x91CA;-1\"><a href=\"#&#x540D;&#x8BCD;&#x89E3;&#x91CA;-1\" class=\"headerlink\" title=\"&#x540D;&#x8BCD;&#x89E3;&#x91CA;\"></a>&#x540D;&#x8BCD;&#x89E3;&#x91CA;</h6><ul>\n<li>Key &#x914D;&#x7F6E;&#x9879;&#x7684;key&#xFF0C;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x4E2D;@Value({key})&#x76F8;&#x5BF9;&#x5E94;</li>\n<li>Value &#x503C;</li>\n<li>Status <ul>\n<li>new &#x65B0;&#x5EFA;&#x914D;&#x7F6E;</li>\n<li>edited &#x914D;&#x7F6E;&#x5DF2;&#x53D8;&#x66F4;&#xFF0C;&#x5E26;&#x5BA1;&#x6279;</li>\n<li>approved &#x914D;&#x7F6E;&#x5BA1;&#x6279;&#x901A;&#x8FC7;&#xFF0C;&#x53EF;&#x53D1;&#x5E03;</li>\n<li>published &#x914D;&#x7F6E;&#x5DF2;&#x53D1;&#x5E03;</li>\n<li>removing &#x914D;&#x7F6E;&#x5220;&#x9664;&#xFF0C;&#x5F85;&#x5BA1;&#x6279;</li>\n<li>deleted &#x914D;&#x7F6E;&#x5DF2;&#x5220;&#x9664;&#xFF0C;&#x4E0D;&#x663E;&#x793A;</li>\n<li>invalid &#x914D;&#x7F6E;&#x65E0;&#x6548;&#xFF0C;&#x4E0D;&#x663E;&#x793A;</li>\n</ul>\n</li>\n</ul>\n<h6 id=\"&#x529F;&#x80FD;&#x8BF4;&#x660E;-1\"><a href=\"#&#x529F;&#x80FD;&#x8BF4;&#x660E;-1\" class=\"headerlink\" title=\"&#x529F;&#x80FD;&#x8BF4;&#x660E;\"></a>&#x529F;&#x80FD;&#x8BF4;&#x660E;</h6><ul>\n<li>Add &#x65B0;&#x589E;&#x914D;&#x7F6E;&#xFF0C;&#x53EF;&#x9009;&#x62E9;&#x914D;&#x7F6E;&#x7684;&#x53EF;&#x89C1;&#x6743;&#x9650;&#x3002;&#x82E5;&#x4E0D;&#x9009;&#x62E9;&#xFF0C;&#x5219;&#x8BE5;&#x914D;&#x7F6E;&#x4E3A;&#x5F53;&#x524D;&#x767B;&#x5F55;&#x7528;&#x6237;&#x7684;&#x89D2;&#x8272;&#x53EF;&#x89C1;&#x3002;&#x9700;&#x8981;&#x5BA1;&#x6279;&#x3002;</li>\n<li>Delete &#x5220;&#x9664;&#x914D;&#x7F6E;&#xFF0C;&#x9700;&#x8981;&#x5BA1;&#x6279;&#x3002;</li>\n<li>Export &#x5BFC;&#x51FA;&#x914D;&#x7F6E;&#x3002;</li>\n<li>Import &#x5BFC;&#x5165;&#x914D;&#x7F6E;&#xFF0C;&#x9700;&#x8981;&#x5BA1;&#x6279;&#x3002;</li>\n<li>Edit &#x7F16;&#x8F91;&#x914D;&#x7F6E;&#xFF0C;&#x9700;&#x8981;&#x5BA1;&#x6279;&#x3002;</li>\n<li>Instance &#x67E5;&#x770B;&#x5F53;&#x524D;&#x914D;&#x7F6E;&#x7684;&#x4F7F;&#x7528;&#x60C5;&#x51B5;&#x3002;</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/instanceConfig.png\" alt=\"11\"></p>\n<ul>\n<li>History &#x914D;&#x7F6E;&#x4FEE;&#x6539;&#x5386;&#x53F2;</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/history.png\" alt=\"12\"></p>\n<h4 id=\"6-&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x914D;&#x7F6E;&#x9879;&#x5206;&#x914D;\"><a href=\"#6-&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x914D;&#x7F6E;&#x9879;&#x5206;&#x914D;\" class=\"headerlink\" title=\"6. &#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x914D;&#x7F6E;&#x9879;&#x5206;&#x914D;\"></a>6. &#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x2013;&#x914D;&#x7F6E;&#x9879;&#x5206;&#x914D;</h4><h6 id=\"&#x914D;&#x7F6E;&#x9879;&#x5206;&#x914D;&#x63D0;&#x4F9B;&#x5168;&#x5C40;&#x7684;&#x89D2;&#x8272;&#x914D;&#x7F6E;&#x53EF;&#x89C1;&#x6743;&#x9650;&#x8BBE;&#x7F6E;&#x3002;\"><a href=\"#&#x914D;&#x7F6E;&#x9879;&#x5206;&#x914D;&#x63D0;&#x4F9B;&#x5168;&#x5C40;&#x7684;&#x89D2;&#x8272;&#x914D;&#x7F6E;&#x53EF;&#x89C1;&#x6743;&#x9650;&#x8BBE;&#x7F6E;&#x3002;\" class=\"headerlink\" title=\"&#x914D;&#x7F6E;&#x9879;&#x5206;&#x914D;&#x63D0;&#x4F9B;&#x5168;&#x5C40;&#x7684;&#x89D2;&#x8272;&#x914D;&#x7F6E;&#x53EF;&#x89C1;&#x6743;&#x9650;&#x8BBE;&#x7F6E;&#x3002;\"></a>&#x914D;&#x7F6E;&#x9879;&#x5206;&#x914D;&#x63D0;&#x4F9B;&#x5168;&#x5C40;&#x7684;&#x89D2;&#x8272;&#x914D;&#x7F6E;&#x53EF;&#x89C1;&#x6743;&#x9650;&#x8BBE;&#x7F6E;&#x3002;</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/allocate.png\" alt=\"13\"></p>\n<h6 id=\"&#x529F;&#x80FD;&#x8BF4;&#x660E;-2\"><a href=\"#&#x529F;&#x80FD;&#x8BF4;&#x660E;-2\" class=\"headerlink\" title=\"&#x529F;&#x80FD;&#x8BF4;&#x660E;\"></a>&#x529F;&#x80FD;&#x8BF4;&#x660E;</h6><ul>\n<li>Allocate &#x5206;&#x914D;&#x89D2;&#x8272;&#x53EF;&#x89C1;&#x914D;&#x7F6E;</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/allocateConfigs.png\" alt=\"14\"></p>\n<h4 id=\"7-&#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;\"><a href=\"#7-&#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;\" class=\"headerlink\" title=\"7. &#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;\"></a>7. &#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;</h4><h6 id=\"&#x63D0;&#x4F9B;&#x7BA1;&#x7406;&#x5E73;&#x53F0;&#x6240;&#x6709;&#x589E;&#x5220;&#x6539;&#x7684;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;&#x67E5;&#x8BE2;&#x548C;&#x56DE;&#x6EAF;&#x3002;\"><a href=\"#&#x63D0;&#x4F9B;&#x7BA1;&#x7406;&#x5E73;&#x53F0;&#x6240;&#x6709;&#x589E;&#x5220;&#x6539;&#x7684;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;&#x67E5;&#x8BE2;&#x548C;&#x56DE;&#x6EAF;&#x3002;\" class=\"headerlink\" title=\"&#x63D0;&#x4F9B;&#x7BA1;&#x7406;&#x5E73;&#x53F0;&#x6240;&#x6709;&#x589E;&#x5220;&#x6539;&#x7684;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;&#x67E5;&#x8BE2;&#x548C;&#x56DE;&#x6EAF;&#x3002;\"></a>&#x63D0;&#x4F9B;&#x7BA1;&#x7406;&#x5E73;&#x53F0;&#x6240;&#x6709;&#x589E;&#x5220;&#x6539;&#x7684;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;&#x67E5;&#x8BE2;&#x548C;&#x56DE;&#x6EAF;&#x3002;</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/operationLog.png\" alt=\"15\"></p>\n<h4 id=\"8-&#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x4EFB;&#x52A1;&#x4E2D;&#x5FC3;\"><a href=\"#8-&#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x4EFB;&#x52A1;&#x4E2D;&#x5FC3;\" class=\"headerlink\" title=\"8. &#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x4EFB;&#x52A1;&#x4E2D;&#x5FC3;\"></a>8. &#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x4EFB;&#x52A1;&#x4E2D;&#x5FC3;</h4><h6 id=\"&#x63D0;&#x4F9B;&#x5BA1;&#x6279;&#x67E5;&#x770B;&#x3001;&#x5BA1;&#x6279;&#x64CD;&#x4F5C;-&#x901A;&#x8FC7;&#x3001;&#x62D2;&#x7EDD;-&#x7B49;&#x529F;&#x80FD;&#x3002;\"><a href=\"#&#x63D0;&#x4F9B;&#x5BA1;&#x6279;&#x67E5;&#x770B;&#x3001;&#x5BA1;&#x6279;&#x64CD;&#x4F5C;-&#x901A;&#x8FC7;&#x3001;&#x62D2;&#x7EDD;-&#x7B49;&#x529F;&#x80FD;&#x3002;\" class=\"headerlink\" title=\"&#x63D0;&#x4F9B;&#x5BA1;&#x6279;&#x67E5;&#x770B;&#x3001;&#x5BA1;&#x6279;&#x64CD;&#x4F5C;(&#x901A;&#x8FC7;&#x3001;&#x62D2;&#x7EDD;)&#x7B49;&#x529F;&#x80FD;&#x3002;\"></a>&#x63D0;&#x4F9B;&#x5BA1;&#x6279;&#x67E5;&#x770B;&#x3001;&#x5BA1;&#x6279;&#x64CD;&#x4F5C;(&#x901A;&#x8FC7;&#x3001;&#x62D2;&#x7EDD;)&#x7B49;&#x529F;&#x80FD;&#x3002;</h6><ul>\n<li>Pending Task &#x5F85;&#x5BA1;&#x6279;&#x5217;&#x8868;&#xFF0C;&#x63D0;&#x4F9B;&#x5BA1;&#x6279;&#x901A;&#x8FC7;&#x3001;&#x51B3;&#x7EDD;&#xFF0C;&#x5BA1;&#x914D;&#x5185;&#x5BB9;&#x67E5;&#x770B;&#x7B49;&#x529F;&#x80FD;&#x3002;</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/pendingTask.png\" alt=\"16\"></p>\n<ul>\n<li>Processing Task &#x5BA1;&#x6279;&#x8FDB;&#x5EA6;&#x5217;&#x8868;&#xFF0C;&#x63D0;&#x4F9B;&#x5BA1;&#x6279;&#x8FDB;&#x5EA6;&#x7684;&#x67E5;&#x8BE2;&#x3002;</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/processingTask.png\" alt=\"17\"></p>\n<ul>\n<li>Complete Task &#x5B8C;&#x6210;&#x4EFB;&#x52A1;&#x5217;&#x8868;&#xFF0C;&#x63D0;&#x4F9B;&#x5386;&#x53F2;&#x5BA1;&#x6279;&#x901A;&#x8FC7;&#x3001;&#x62D2;&#x7EDD;&#x7684;&#x4EFB;&#x52A1;&#x7684;&#x67E5;&#x8BE2;&#x3002;</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/completeTask.png\" alt=\"18\"></p>\n<h4 id=\"9-&#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;\"><a href=\"#9-&#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;\" class=\"headerlink\" title=\"9. &#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;\"></a>9. &#x6D88;&#x606F;&#x4E2D;&#x5FC3;&#x2013;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;</h4><h6 id=\"&#x63D0;&#x4F9B;&#x5BA2;&#x6237;&#x7AEF;&#x4E0A;&#x62A5;&#x65E5;&#x5FD7;&#x7684;&#x67E5;&#x8BE2;&#x3002;\"><a href=\"#&#x63D0;&#x4F9B;&#x5BA2;&#x6237;&#x7AEF;&#x4E0A;&#x62A5;&#x65E5;&#x5FD7;&#x7684;&#x67E5;&#x8BE2;&#x3002;\" class=\"headerlink\" title=\"&#x63D0;&#x4F9B;&#x5BA2;&#x6237;&#x7AEF;&#x4E0A;&#x62A5;&#x65E5;&#x5FD7;&#x7684;&#x67E5;&#x8BE2;&#x3002;\"></a>&#x63D0;&#x4F9B;&#x5BA2;&#x6237;&#x7AEF;&#x4E0A;&#x62A5;&#x65E5;&#x5FD7;&#x7684;&#x67E5;&#x8BE2;&#x3002;</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/clientLog.png\" alt=\"19\"></p>\n<h4 id=\"10-&#x7528;&#x6237;&#x4E2D;&#x5FC3;&#x2013;&#x89D2;&#x8272;&#x7BA1;&#x7406;\"><a href=\"#10-&#x7528;&#x6237;&#x4E2D;&#x5FC3;&#x2013;&#x89D2;&#x8272;&#x7BA1;&#x7406;\" class=\"headerlink\" title=\"10. &#x7528;&#x6237;&#x4E2D;&#x5FC3;&#x2013;&#x89D2;&#x8272;&#x7BA1;&#x7406;\"></a>10. &#x7528;&#x6237;&#x4E2D;&#x5FC3;&#x2013;&#x89D2;&#x8272;&#x7BA1;&#x7406;</h4><h6 id=\"&#x63D0;&#x4F9B;&#x89D2;&#x8272;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#xFF0C;&#x89D2;&#x8272;&#x7684;&#x83DC;&#x5355;&#x6743;&#x9650;&#x3001;&#x6309;&#x94AE;&#x6743;&#x9650;&#x7684;&#x8BBE;&#x7F6E;&#x3002;\"><a href=\"#&#x63D0;&#x4F9B;&#x89D2;&#x8272;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#xFF0C;&#x89D2;&#x8272;&#x7684;&#x83DC;&#x5355;&#x6743;&#x9650;&#x3001;&#x6309;&#x94AE;&#x6743;&#x9650;&#x7684;&#x8BBE;&#x7F6E;&#x3002;\" class=\"headerlink\" title=\"&#x63D0;&#x4F9B;&#x89D2;&#x8272;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#xFF0C;&#x89D2;&#x8272;&#x7684;&#x83DC;&#x5355;&#x6743;&#x9650;&#x3001;&#x6309;&#x94AE;&#x6743;&#x9650;&#x7684;&#x8BBE;&#x7F6E;&#x3002;\"></a>&#x63D0;&#x4F9B;&#x89D2;&#x8272;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#xFF0C;&#x89D2;&#x8272;&#x7684;&#x83DC;&#x5355;&#x6743;&#x9650;&#x3001;&#x6309;&#x94AE;&#x6743;&#x9650;&#x7684;&#x8BBE;&#x7F6E;&#x3002;</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/role.png\" alt=\"20\"></p>\n<h4 id=\"11-&#x7528;&#x6237;&#x4E2D;&#x5FC3;&#x2013;&#x7528;&#x6237;&#x7BA1;&#x7406;\"><a href=\"#11-&#x7528;&#x6237;&#x4E2D;&#x5FC3;&#x2013;&#x7528;&#x6237;&#x7BA1;&#x7406;\" class=\"headerlink\" title=\"11. &#x7528;&#x6237;&#x4E2D;&#x5FC3;&#x2013;&#x7528;&#x6237;&#x7BA1;&#x7406;\"></a>11. &#x7528;&#x6237;&#x4E2D;&#x5FC3;&#x2013;&#x7528;&#x6237;&#x7BA1;&#x7406;</h4><h6 id=\"&#x63D0;&#x4F9B;&#x7528;&#x6237;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#xFF0C;&#x7528;&#x6237;&#x7684;&#x89D2;&#x8272;&#x5206;&#x914D;&#x8BBE;&#x7F6E;&#x3002;\"><a href=\"#&#x63D0;&#x4F9B;&#x7528;&#x6237;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#xFF0C;&#x7528;&#x6237;&#x7684;&#x89D2;&#x8272;&#x5206;&#x914D;&#x8BBE;&#x7F6E;&#x3002;\" class=\"headerlink\" title=\"&#x63D0;&#x4F9B;&#x7528;&#x6237;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#xFF0C;&#x7528;&#x6237;&#x7684;&#x89D2;&#x8272;&#x5206;&#x914D;&#x8BBE;&#x7F6E;&#x3002;\"></a>&#x63D0;&#x4F9B;&#x7528;&#x6237;&#x7684;&#x589E;&#x5220;&#x6539;&#x67E5;&#xFF0C;&#x7528;&#x6237;&#x7684;&#x89D2;&#x8272;&#x5206;&#x914D;&#x8BBE;&#x7F6E;&#x3002;</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/user.png\" alt=\"21\"></p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Redis","path":"tags/Redis/"},{"name":"配置中心","path":"tags/配置中心/"}],"excerpt":"<html><head></head><body><p>nadia-config&#x662F;&#x4E00;&#x6B3E;&#x57FA;&#x4E8E;spring boot&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#xFF0C;&#x80FD;&#x591F;&#x96C6;&#x4E2D;&#x5316;&#x7BA1;&#x7406;&#x4E0D;&#x540C;&#x73AF;&#x5883;&#x3001;&#x4E0D;&#x540C;&#x7248;&#x672C;&#x7684;&#x96C6;&#x7FA4;&#x914D;&#x7F6E;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x914D;&#x7F6E;&#x7684;&#x5B9E;&#x65F6;&#x66F4;&#x65B0;&#x3001;&#x56DE;&#x8C03;&#x3001;&#x5BA1;&#x6279;&#x3001;&#x6743;&#x9650;&#x7BA1;&#x7406;&#x7B49;&#x529F;&#x80FD;&#x3002;</p>\n<blockquote>\n<p><a href=\"https://github.com/nadia-repository/nadia-config\">https://github.com/nadia-repository/nadia-config</a></p>\n</blockquote>\n<h1 id=\"Nadia-Config-Center\"><a href=\"#Nadia-Config-Center\" class=\"headerlink\" title=\"Nadia Config Center\"></a>Nadia Config Center</h1><h2 id=\"&#x7EC4;&#x4EF6;&#x4ECB;&#x7ECD;\"><a href=\"#&#x7EC4;&#x4EF6;&#x4ECB;&#x7ECD;\" class=\"headerlink\" title=\"&#x7EC4;&#x4EF6;&#x4ECB;&#x7ECD;\"></a>&#x7EC4;&#x4EF6;&#x4ECB;&#x7ECD;</h2><ul>\n<li><a href=\"nadia-client/README.md\">nadia-client</a></li>\n<li><a href=\"nadia-server/README.md\">nadia-server</a></li>\n</ul>\n<h2 id=\"Release-Note\"><a href=\"#Release-Note\" class=\"headerlink\" title=\"Release-Note\"></a>Release-Note</h2><ul>\n<li><p>v1.0</p></li></ul></body></html>","more":"<h2 id=\"主要目标：\"><a href=\"#主要目标：\" class=\"headerlink\" title=\"主要目标：\"></a>主要目标：</h2>\n<li><p>兼容springboot框架，业务系统无需代码变更</p>\n</li>\n<li><p>快速接入，jar包引用</p>\n</li>\n<li><p>配置动态更新，实时生效</p>\n</li>\n<li><p>支持集群分组，配置差异化</p>\n</li>\n<li><p>提供配置统一变更平台，支持平台用户的权限管理和配置变更的权限管理</p>\n</li>\n\n<h4 id=\"部署图\"><a href=\"#部署图\" class=\"headerlink\" title=\"部署图\"></a>部署图</h4><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/%E6%9C%8D%E5%8A%A1%E9%83%A8%E7%BD%B2%E5%9B%BE.png\" alt=\"01\"></p>\n<h4 id=\"项目构成\"><a href=\"#项目构成\" class=\"headerlink\" title=\"项目构成\"></a>项目构成</h4><blockquote>\n<p>nadia-config 项目根目录</p>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>nadia-client 客户端</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>nadia-core 通用代码</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>nadia-server 服务端</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>nadia-web 前端页面</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>nadia-demo 客户端demo</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<p>docs 文档</p>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>desgin 设计文档</p>\n</blockquote>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>sql 服务端脚本</p>\n</blockquote>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>DDL.sql 建表</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>DML.sql 初始数据</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<h4 id=\"管理平台介绍\"><a href=\"#管理平台介绍\" class=\"headerlink\" title=\"管理平台介绍\"></a>管理平台介绍</h4><h4 id=\"1-登录页面\"><a href=\"#1-登录页面\" class=\"headerlink\" title=\"1. 登录页面\"></a>1. 登录页面</h4><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/%E7%99%BB%E5%BD%95.png\" alt=\"02\"></p>\n<h4 id=\"2-注册页面\"><a href=\"#2-注册页面\" class=\"headerlink\" title=\"2. 注册页面\"></a>2. 注册页面</h4><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/%E6%B3%A8%E5%86%8C.png\" alt=\"03\"></p>\n<h4 id=\"3-主界面\"><a href=\"#3-主界面\" class=\"headerlink\" title=\"3. 主界面\"></a>3. 主界面</h4><h6 id=\"根据登录用户的角色不同，菜单按钮会有相应变化\"><a href=\"#根据登录用户的角色不同，菜单按钮会有相应变化\" class=\"headerlink\" title=\"根据登录用户的角色不同，菜单按钮会有相应变化\"></a>根据登录用户的角色不同，菜单按钮会有相应变化</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/%E4%B8%BB%E9%A1%B5%E9%9D%A2.png\" alt=\"04\"></p>\n<h4 id=\"4-配置管理–元数据管理\"><a href=\"#4-配置管理–元数据管理\" class=\"headerlink\" title=\"4. 配置管理–元数据管理\"></a>4. 配置管理–元数据管理</h4><h6 id=\"元数据管理是所有配置的基础，客户端使用配置项时需要指定相关的元数据\"><a href=\"#元数据管理是所有配置的基础，客户端使用配置项时需要指定相关的元数据\" class=\"headerlink\" title=\"元数据管理是所有配置的基础，客户端使用配置项时需要指定相关的元数据\"></a>元数据管理是所有配置的基础，客户端使用配置项时需要指定相关的元数据</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/metadata.png\" alt=\"05\"></p>\n<h6 id=\"名词解释\"><a href=\"#名词解释\" class=\"headerlink\" title=\"名词解释\"></a>名词解释</h6><ul>\n<li>Application 系统名称，客户端可以指定使用任意一套系统下的配置。</li>\n<li>Group 组名称，客户端指定系统后，仍需要指定使用系统下的某个组。若不强制指定，客户端启动后会默认使用Default组下的配置，后期可使用组切换功能切换至不同组。</li>\n</ul>\n<h6 id=\"功能说明\"><a href=\"#功能说明\" class=\"headerlink\" title=\"功能说明\"></a>功能说明</h6><ul>\n<li>Add 新增Application，同时新增默认Group(Default)。</li>\n<li>Delete 删除Application\\Group信息。当前Group如果正在被使用，或当前组为Default组且存在非Default组时，不能删除。Defualt组删除后将同时删除Application。</li>\n<li>Compare 比较同一Application下不同Group的配置差异，可多选，但至少选两个组。</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/compare.png\" alt=\"06\"></p>\n<ul>\n<li>Edit 修改Application信息</li>\n<li>Group 新增组。可选择从某个组复制所有已发布配置项，或生产新的空组。</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/addGroup.png\" alt=\"07\"></p>\n<ul>\n<li>Instances 可将某实例调整至另一组。</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/switch.png\" alt=\"08\"></p>\n<ul>\n<li>Inscance 查看弄实例当前的配置与服务端配置的差异。</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/instance.png\" alt=\"09\"></p>\n<h4 id=\"5-配置管理–配置项管理\"><a href=\"#5-配置管理–配置项管理\" class=\"headerlink\" title=\"5. 配置管理–配置项管理\"></a>5. 配置管理–配置项管理</h4><h6 id=\"配置项管理提供具体配置的增删改查、发布等功能\"><a href=\"#配置项管理提供具体配置的增删改查、发布等功能\" class=\"headerlink\" title=\"配置项管理提供具体配置的增删改查、发布等功能\"></a>配置项管理提供具体配置的增删改查、发布等功能</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/configs.png\" alt=\"10\"></p>\n<h6 id=\"名词解释-1\"><a href=\"#名词解释-1\" class=\"headerlink\" title=\"名词解释\"></a>名词解释</h6><ul>\n<li>Key 配置项的key，与客户端中@Value({key})相对应</li>\n<li>Value 值</li>\n<li>Status <ul>\n<li>new 新建配置</li>\n<li>edited 配置已变更，带审批</li>\n<li>approved 配置审批通过，可发布</li>\n<li>published 配置已发布</li>\n<li>removing 配置删除，待审批</li>\n<li>deleted 配置已删除，不显示</li>\n<li>invalid 配置无效，不显示</li>\n</ul>\n</li>\n</ul>\n<h6 id=\"功能说明-1\"><a href=\"#功能说明-1\" class=\"headerlink\" title=\"功能说明\"></a>功能说明</h6><ul>\n<li>Add 新增配置，可选择配置的可见权限。若不选择，则该配置为当前登录用户的角色可见。需要审批。</li>\n<li>Delete 删除配置，需要审批。</li>\n<li>Export 导出配置。</li>\n<li>Import 导入配置，需要审批。</li>\n<li>Edit 编辑配置，需要审批。</li>\n<li>Instance 查看当前配置的使用情况。</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/instanceConfig.png\" alt=\"11\"></p>\n<ul>\n<li>History 配置修改历史</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/history.png\" alt=\"12\"></p>\n<h4 id=\"6-配置管理–配置项分配\"><a href=\"#6-配置管理–配置项分配\" class=\"headerlink\" title=\"6. 配置管理–配置项分配\"></a>6. 配置管理–配置项分配</h4><h6 id=\"配置项分配提供全局的角色配置可见权限设置。\"><a href=\"#配置项分配提供全局的角色配置可见权限设置。\" class=\"headerlink\" title=\"配置项分配提供全局的角色配置可见权限设置。\"></a>配置项分配提供全局的角色配置可见权限设置。</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/allocate.png\" alt=\"13\"></p>\n<h6 id=\"功能说明-2\"><a href=\"#功能说明-2\" class=\"headerlink\" title=\"功能说明\"></a>功能说明</h6><ul>\n<li>Allocate 分配角色可见配置</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/allocateConfigs.png\" alt=\"14\"></p>\n<h4 id=\"7-消息中心–操作日志\"><a href=\"#7-消息中心–操作日志\" class=\"headerlink\" title=\"7. 消息中心–操作日志\"></a>7. 消息中心–操作日志</h4><h6 id=\"提供管理平台所有增删改的操作日志查询和回溯。\"><a href=\"#提供管理平台所有增删改的操作日志查询和回溯。\" class=\"headerlink\" title=\"提供管理平台所有增删改的操作日志查询和回溯。\"></a>提供管理平台所有增删改的操作日志查询和回溯。</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/operationLog.png\" alt=\"15\"></p>\n<h4 id=\"8-消息中心–任务中心\"><a href=\"#8-消息中心–任务中心\" class=\"headerlink\" title=\"8. 消息中心–任务中心\"></a>8. 消息中心–任务中心</h4><h6 id=\"提供审批查看、审批操作-通过、拒绝-等功能。\"><a href=\"#提供审批查看、审批操作-通过、拒绝-等功能。\" class=\"headerlink\" title=\"提供审批查看、审批操作(通过、拒绝)等功能。\"></a>提供审批查看、审批操作(通过、拒绝)等功能。</h6><ul>\n<li>Pending Task 待审批列表，提供审批通过、决绝，审配内容查看等功能。</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/pendingTask.png\" alt=\"16\"></p>\n<ul>\n<li>Processing Task 审批进度列表，提供审批进度的查询。</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/processingTask.png\" alt=\"17\"></p>\n<ul>\n<li>Complete Task 完成任务列表，提供历史审批通过、拒绝的任务的查询。</li>\n</ul>\n<p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/completeTask.png\" alt=\"18\"></p>\n<h4 id=\"9-消息中心–操作日志\"><a href=\"#9-消息中心–操作日志\" class=\"headerlink\" title=\"9. 消息中心–操作日志\"></a>9. 消息中心–操作日志</h4><h6 id=\"提供客户端上报日志的查询。\"><a href=\"#提供客户端上报日志的查询。\" class=\"headerlink\" title=\"提供客户端上报日志的查询。\"></a>提供客户端上报日志的查询。</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/clientLog.png\" alt=\"19\"></p>\n<h4 id=\"10-用户中心–角色管理\"><a href=\"#10-用户中心–角色管理\" class=\"headerlink\" title=\"10. 用户中心–角色管理\"></a>10. 用户中心–角色管理</h4><h6 id=\"提供角色的增删改查，角色的菜单权限、按钮权限的设置。\"><a href=\"#提供角色的增删改查，角色的菜单权限、按钮权限的设置。\" class=\"headerlink\" title=\"提供角色的增删改查，角色的菜单权限、按钮权限的设置。\"></a>提供角色的增删改查，角色的菜单权限、按钮权限的设置。</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/role.png\" alt=\"20\"></p>\n<h4 id=\"11-用户中心–用户管理\"><a href=\"#11-用户中心–用户管理\" class=\"headerlink\" title=\"11. 用户中心–用户管理\"></a>11. 用户中心–用户管理</h4><h6 id=\"提供用户的增删改查，用户的角色分配设置。\"><a href=\"#提供用户的增删改查，用户的角色分配设置。\" class=\"headerlink\" title=\"提供用户的增删改查，用户的角色分配设置。\"></a>提供用户的增删改查，用户的角色分配设置。</h6><p><img src=\"/2020/03/20/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E4%BB%8B%E7%BB%8D%E7%AF%87/user.png\" alt=\"21\"></p>"},{"title":"我为什么会手撸一个配置中心-设计篇（一）","date":"2020-03-24T06:12:24.000Z","_content":"## 开篇\n从这篇开始，我们开始介绍整个配置中心的设计思想和架构的流程，主要会分为下面几个部分：\n\n1. 配置中心基础功能分析\n2. 配置中心技术选型\n3. 配置中心架构部署\n\n## 基础功能分析--配置结构\n开始设计前我们先分析下一个配置中心到底需要哪些功能，同时工作中有哪些痛点是可以通过配置中心来解决的。\n<!-- more -->\n#### 1.配置的管理\n原始的配置项管理大量采用了代码维护的方式，如spring的yml配置文件、代码中的@Value注解、各种中间件的配置文件等。不仅不利于配置的动态变更，更不利于统一管理配置信息，因此现有的配置中心解决方案会通常会将配置中心分为客户端和服务端。\n* 客户端负责业务系统的配置收集与实时同步等。\n* 服务端负责配置的统一管理和实时更新等。\n\n结合上面的思路，我们在设计的初期也会将整个配置中心的技术架构分为客户端和服务端两部分。\n\n回到配置管理的话题上，我们还需要考虑一个重要的功能点【如何管理配置】。这里的“管理”不单单只是将配置在某个页面上给用户展示而已，还要细化到：\n* 配置如何划分范围？\n* 配置差异化如何处理？\n* 配置权限如何处理？\n\n###### 配置如何划分范围？\n各个业务服务连接到配置中心后，他们都有怎么不同的配置，我们不能把他们的配置全部混为一谈。不同的服务的配置有自己的作用域，多个相同服务共享同一个作用域下的配置。\n\n通过服务来划分配置范围是一个办法，我们在编写代码的时候其实也是这么处理的。但是仅仅如此是不够的。我们可以想象一个场景，业务场景上我们经常会遇到AB test，我们解决的办法常常是通过灰度发布或蓝绿发版。通过不同的规则将前端流量引向相同服务的不同版本从而实现生产上的差异化。\n\n如果我们只是简单的通过服务来划分配置，但遇到上诉问题的时候往往痛疼不已。1.0 Ver需要看到A文案，1.1 Ver需要看到B文案。我们假象下，如果通过过去的配置文件方式，我们要怎么处理？首先要在代码里判断当前服务的版本，然后根据不同的版本读取不同的配置，最终达到不同版本不同展示效果的功能。\n\n```Java\n\n@Vaule(\"{test.a}\")\nprivate String testA;\n\n@Vaule(\"{test.b}\")\nprivate String testB;\n\npublic void getTest(String version) {\n    if('1.0'.equel(version)){\n        System.out.println(testA);\n    }else if('1.1'.equel(version)){\n        System.out.println(testB);\n    }\n}\n```\n\n可能会有更好的处理方法，但大多数情况下我们会像上面写代码。长此以往可想而知，后面的同学不知道之前的逻辑就看不懂这段代码在写什么。而且每次有版本的变更，都需要硬编码。\n\n那有没有更优雅的解决方案，既然我们都有配置中心了，同时我们的配置也都交由配置中心管理了，配置变更时我们也能实时的同步配置。那么我们能不能区分出相同服务的差异化配置呢？\n\n答案肯定是可以的。在已服务作为配置的作用域下，我们再定义一个组的概念：\n\n|Application|Group|\n---|---\nService1|Default\nService1|V1.0\nService1|V1.1\nService2|Default\n\n同一个应用可以划分多个组，每个组中的配置存在差异化，相同配置的服务可以使用同一个组的配置。\n\n以上就是我们划分配置范围的过程，既可以解决配置的差异化，也可以将各个服务的配置统一管理起来。当然这个配置的模型还需要不断的进化，比如：我们是否可以提炼出相同的配置，类似于jar在我们服务中相互引用的方式一样，在我们给个应用中共享。未来我们也会针对类似的需求不断的优化。\n\n\n\n","source":"_posts/我为什么会重新写一个配置中心-设计篇.md","raw":"---\ntitle: 我为什么会手撸一个配置中心-设计篇（一）\ndate: 2020-03-24 14:12:24\ntags: \n    - Java\n    - Redis\n    - 配置中心\ncategories :\n    - Technology\n---\n## 开篇\n从这篇开始，我们开始介绍整个配置中心的设计思想和架构的流程，主要会分为下面几个部分：\n\n1. 配置中心基础功能分析\n2. 配置中心技术选型\n3. 配置中心架构部署\n\n## 基础功能分析--配置结构\n开始设计前我们先分析下一个配置中心到底需要哪些功能，同时工作中有哪些痛点是可以通过配置中心来解决的。\n<!-- more -->\n#### 1.配置的管理\n原始的配置项管理大量采用了代码维护的方式，如spring的yml配置文件、代码中的@Value注解、各种中间件的配置文件等。不仅不利于配置的动态变更，更不利于统一管理配置信息，因此现有的配置中心解决方案会通常会将配置中心分为客户端和服务端。\n* 客户端负责业务系统的配置收集与实时同步等。\n* 服务端负责配置的统一管理和实时更新等。\n\n结合上面的思路，我们在设计的初期也会将整个配置中心的技术架构分为客户端和服务端两部分。\n\n回到配置管理的话题上，我们还需要考虑一个重要的功能点【如何管理配置】。这里的“管理”不单单只是将配置在某个页面上给用户展示而已，还要细化到：\n* 配置如何划分范围？\n* 配置差异化如何处理？\n* 配置权限如何处理？\n\n###### 配置如何划分范围？\n各个业务服务连接到配置中心后，他们都有怎么不同的配置，我们不能把他们的配置全部混为一谈。不同的服务的配置有自己的作用域，多个相同服务共享同一个作用域下的配置。\n\n通过服务来划分配置范围是一个办法，我们在编写代码的时候其实也是这么处理的。但是仅仅如此是不够的。我们可以想象一个场景，业务场景上我们经常会遇到AB test，我们解决的办法常常是通过灰度发布或蓝绿发版。通过不同的规则将前端流量引向相同服务的不同版本从而实现生产上的差异化。\n\n如果我们只是简单的通过服务来划分配置，但遇到上诉问题的时候往往痛疼不已。1.0 Ver需要看到A文案，1.1 Ver需要看到B文案。我们假象下，如果通过过去的配置文件方式，我们要怎么处理？首先要在代码里判断当前服务的版本，然后根据不同的版本读取不同的配置，最终达到不同版本不同展示效果的功能。\n\n```Java\n\n@Vaule(\"{test.a}\")\nprivate String testA;\n\n@Vaule(\"{test.b}\")\nprivate String testB;\n\npublic void getTest(String version) {\n    if('1.0'.equel(version)){\n        System.out.println(testA);\n    }else if('1.1'.equel(version)){\n        System.out.println(testB);\n    }\n}\n```\n\n可能会有更好的处理方法，但大多数情况下我们会像上面写代码。长此以往可想而知，后面的同学不知道之前的逻辑就看不懂这段代码在写什么。而且每次有版本的变更，都需要硬编码。\n\n那有没有更优雅的解决方案，既然我们都有配置中心了，同时我们的配置也都交由配置中心管理了，配置变更时我们也能实时的同步配置。那么我们能不能区分出相同服务的差异化配置呢？\n\n答案肯定是可以的。在已服务作为配置的作用域下，我们再定义一个组的概念：\n\n|Application|Group|\n---|---\nService1|Default\nService1|V1.0\nService1|V1.1\nService2|Default\n\n同一个应用可以划分多个组，每个组中的配置存在差异化，相同配置的服务可以使用同一个组的配置。\n\n以上就是我们划分配置范围的过程，既可以解决配置的差异化，也可以将各个服务的配置统一管理起来。当然这个配置的模型还需要不断的进化，比如：我们是否可以提炼出相同的配置，类似于jar在我们服务中相互引用的方式一样，在我们给个应用中共享。未来我们也会针对类似的需求不断的优化。\n\n\n\n","slug":"我为什么会重新写一个配置中心-设计篇","published":1,"updated":"2020-12-14T09:51:24.047Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htl0015v2521jmd29wg","content":"<html><head></head><body><h2 id=\"&#x5F00;&#x7BC7;\"><a href=\"#&#x5F00;&#x7BC7;\" class=\"headerlink\" title=\"&#x5F00;&#x7BC7;\"></a>&#x5F00;&#x7BC7;</h2><p>&#x4ECE;&#x8FD9;&#x7BC7;&#x5F00;&#x59CB;&#xFF0C;&#x6211;&#x4EEC;&#x5F00;&#x59CB;&#x4ECB;&#x7ECD;&#x6574;&#x4E2A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x8BBE;&#x8BA1;&#x601D;&#x60F3;&#x548C;&#x67B6;&#x6784;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x4E3B;&#x8981;&#x4F1A;&#x5206;&#x4E3A;&#x4E0B;&#x9762;&#x51E0;&#x4E2A;&#x90E8;&#x5206;&#xFF1A;</p>\n<ol>\n<li>&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;</li>\n<li>&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x6280;&#x672F;&#x9009;&#x578B;</li>\n<li>&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x67B6;&#x6784;&#x90E8;&#x7F72;</li>\n</ol>\n<h2 id=\"&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7ED3;&#x6784;\"><a href=\"#&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7ED3;&#x6784;\" class=\"headerlink\" title=\"&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7ED3;&#x6784;\"></a>&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7ED3;&#x6784;</h2><p>&#x5F00;&#x59CB;&#x8BBE;&#x8BA1;&#x524D;&#x6211;&#x4EEC;&#x5148;&#x5206;&#x6790;&#x4E0B;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5230;&#x5E95;&#x9700;&#x8981;&#x54EA;&#x4E9B;&#x529F;&#x80FD;&#xFF0C;&#x540C;&#x65F6;&#x5DE5;&#x4F5C;&#x4E2D;&#x6709;&#x54EA;&#x4E9B;&#x75DB;&#x70B9;&#x662F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x6765;&#x89E3;&#x51B3;&#x7684;&#x3002;</p>\n<a id=\"more\"></a>\n<h4 id=\"1-&#x914D;&#x7F6E;&#x7684;&#x7BA1;&#x7406;\"><a href=\"#1-&#x914D;&#x7F6E;&#x7684;&#x7BA1;&#x7406;\" class=\"headerlink\" title=\"1.&#x914D;&#x7F6E;&#x7684;&#x7BA1;&#x7406;\"></a>1.&#x914D;&#x7F6E;&#x7684;&#x7BA1;&#x7406;</h4><p>&#x539F;&#x59CB;&#x7684;&#x914D;&#x7F6E;&#x9879;&#x7BA1;&#x7406;&#x5927;&#x91CF;&#x91C7;&#x7528;&#x4E86;&#x4EE3;&#x7801;&#x7EF4;&#x62A4;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5982;spring&#x7684;yml&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3001;&#x4EE3;&#x7801;&#x4E2D;&#x7684;@Value&#x6CE8;&#x89E3;&#x3001;&#x5404;&#x79CD;&#x4E2D;&#x95F4;&#x4EF6;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7B49;&#x3002;&#x4E0D;&#x4EC5;&#x4E0D;&#x5229;&#x4E8E;&#x914D;&#x7F6E;&#x7684;&#x52A8;&#x6001;&#x53D8;&#x66F4;&#xFF0C;&#x66F4;&#x4E0D;&#x5229;&#x4E8E;&#x7EDF;&#x4E00;&#x7BA1;&#x7406;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;&#x56E0;&#x6B64;&#x73B0;&#x6709;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x4F1A;&#x901A;&#x5E38;&#x4F1A;&#x5C06;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5206;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x7AEF;&#x3002;</p>\n<ul>\n<li>&#x5BA2;&#x6237;&#x7AEF;&#x8D1F;&#x8D23;&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;&#x7684;&#x914D;&#x7F6E;&#x6536;&#x96C6;&#x4E0E;&#x5B9E;&#x65F6;&#x540C;&#x6B65;&#x7B49;&#x3002;</li>\n<li>&#x670D;&#x52A1;&#x7AEF;&#x8D1F;&#x8D23;&#x914D;&#x7F6E;&#x7684;&#x7EDF;&#x4E00;&#x7BA1;&#x7406;&#x548C;&#x5B9E;&#x65F6;&#x66F4;&#x65B0;&#x7B49;&#x3002;</li>\n</ul>\n<p>&#x7ED3;&#x5408;&#x4E0A;&#x9762;&#x7684;&#x601D;&#x8DEF;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x8BBE;&#x8BA1;&#x7684;&#x521D;&#x671F;&#x4E5F;&#x4F1A;&#x5C06;&#x6574;&#x4E2A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x6280;&#x672F;&#x67B6;&#x6784;&#x5206;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x7AEF;&#x4E24;&#x90E8;&#x5206;&#x3002;</p>\n<p>&#x56DE;&#x5230;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x7684;&#x8BDD;&#x9898;&#x4E0A;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x9700;&#x8981;&#x8003;&#x8651;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x7684;&#x529F;&#x80FD;&#x70B9;&#x3010;&#x5982;&#x4F55;&#x7BA1;&#x7406;&#x914D;&#x7F6E;&#x3011;&#x3002;&#x8FD9;&#x91CC;&#x7684;&#x201C;&#x7BA1;&#x7406;&#x201D;&#x4E0D;&#x5355;&#x5355;&#x53EA;&#x662F;&#x5C06;&#x914D;&#x7F6E;&#x5728;&#x67D0;&#x4E2A;&#x9875;&#x9762;&#x4E0A;&#x7ED9;&#x7528;&#x6237;&#x5C55;&#x793A;&#x800C;&#x5DF2;&#xFF0C;&#x8FD8;&#x8981;&#x7EC6;&#x5316;&#x5230;&#xFF1A;</p>\n<ul>\n<li>&#x914D;&#x7F6E;&#x5982;&#x4F55;&#x5212;&#x5206;&#x8303;&#x56F4;&#xFF1F;</li>\n<li>&#x914D;&#x7F6E;&#x5DEE;&#x5F02;&#x5316;&#x5982;&#x4F55;&#x5904;&#x7406;&#xFF1F;</li>\n<li>&#x914D;&#x7F6E;&#x6743;&#x9650;&#x5982;&#x4F55;&#x5904;&#x7406;&#xFF1F;</li>\n</ul>\n<h6 id=\"&#x914D;&#x7F6E;&#x5982;&#x4F55;&#x5212;&#x5206;&#x8303;&#x56F4;&#xFF1F;\"><a href=\"#&#x914D;&#x7F6E;&#x5982;&#x4F55;&#x5212;&#x5206;&#x8303;&#x56F4;&#xFF1F;\" class=\"headerlink\" title=\"&#x914D;&#x7F6E;&#x5982;&#x4F55;&#x5212;&#x5206;&#x8303;&#x56F4;&#xFF1F;\"></a>&#x914D;&#x7F6E;&#x5982;&#x4F55;&#x5212;&#x5206;&#x8303;&#x56F4;&#xFF1F;</h6><p>&#x5404;&#x4E2A;&#x4E1A;&#x52A1;&#x670D;&#x52A1;&#x8FDE;&#x63A5;&#x5230;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x540E;&#xFF0C;&#x4ED6;&#x4EEC;&#x90FD;&#x6709;&#x600E;&#x4E48;&#x4E0D;&#x540C;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x6211;&#x4EEC;&#x4E0D;&#x80FD;&#x628A;&#x4ED6;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x5168;&#x90E8;&#x6DF7;&#x4E3A;&#x4E00;&#x8C08;&#x3002;&#x4E0D;&#x540C;&#x7684;&#x670D;&#x52A1;&#x7684;&#x914D;&#x7F6E;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x4F5C;&#x7528;&#x57DF;&#xFF0C;&#x591A;&#x4E2A;&#x76F8;&#x540C;&#x670D;&#x52A1;&#x5171;&#x4EAB;&#x540C;&#x4E00;&#x4E2A;&#x4F5C;&#x7528;&#x57DF;&#x4E0B;&#x7684;&#x914D;&#x7F6E;&#x3002;</p>\n<p>&#x901A;&#x8FC7;&#x670D;&#x52A1;&#x6765;&#x5212;&#x5206;&#x914D;&#x7F6E;&#x8303;&#x56F4;&#x662F;&#x4E00;&#x4E2A;&#x529E;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x7F16;&#x5199;&#x4EE3;&#x7801;&#x7684;&#x65F6;&#x5019;&#x5176;&#x5B9E;&#x4E5F;&#x662F;&#x8FD9;&#x4E48;&#x5904;&#x7406;&#x7684;&#x3002;&#x4F46;&#x662F;&#x4EC5;&#x4EC5;&#x5982;&#x6B64;&#x662F;&#x4E0D;&#x591F;&#x7684;&#x3002;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x60F3;&#x8C61;&#x4E00;&#x4E2A;&#x573A;&#x666F;&#xFF0C;&#x4E1A;&#x52A1;&#x573A;&#x666F;&#x4E0A;&#x6211;&#x4EEC;&#x7ECF;&#x5E38;&#x4F1A;&#x9047;&#x5230;AB test&#xFF0C;&#x6211;&#x4EEC;&#x89E3;&#x51B3;&#x7684;&#x529E;&#x6CD5;&#x5E38;&#x5E38;&#x662F;&#x901A;&#x8FC7;&#x7070;&#x5EA6;&#x53D1;&#x5E03;&#x6216;&#x84DD;&#x7EFF;&#x53D1;&#x7248;&#x3002;&#x901A;&#x8FC7;&#x4E0D;&#x540C;&#x7684;&#x89C4;&#x5219;&#x5C06;&#x524D;&#x7AEF;&#x6D41;&#x91CF;&#x5F15;&#x5411;&#x76F8;&#x540C;&#x670D;&#x52A1;&#x7684;&#x4E0D;&#x540C;&#x7248;&#x672C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x751F;&#x4EA7;&#x4E0A;&#x7684;&#x5DEE;&#x5F02;&#x5316;&#x3002;</p>\n<p>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x53EA;&#x662F;&#x7B80;&#x5355;&#x7684;&#x901A;&#x8FC7;&#x670D;&#x52A1;&#x6765;&#x5212;&#x5206;&#x914D;&#x7F6E;&#xFF0C;&#x4F46;&#x9047;&#x5230;&#x4E0A;&#x8BC9;&#x95EE;&#x9898;&#x7684;&#x65F6;&#x5019;&#x5F80;&#x5F80;&#x75DB;&#x75BC;&#x4E0D;&#x5DF2;&#x3002;1.0 Ver&#x9700;&#x8981;&#x770B;&#x5230;A&#x6587;&#x6848;&#xFF0C;1.1 Ver&#x9700;&#x8981;&#x770B;&#x5230;B&#x6587;&#x6848;&#x3002;&#x6211;&#x4EEC;&#x5047;&#x8C61;&#x4E0B;&#xFF0C;&#x5982;&#x679C;&#x901A;&#x8FC7;&#x8FC7;&#x53BB;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x65B9;&#x5F0F;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x600E;&#x4E48;&#x5904;&#x7406;&#xFF1F;&#x9996;&#x5148;&#x8981;&#x5728;&#x4EE3;&#x7801;&#x91CC;&#x5224;&#x65AD;&#x5F53;&#x524D;&#x670D;&#x52A1;&#x7684;&#x7248;&#x672C;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x7248;&#x672C;&#x8BFB;&#x53D6;&#x4E0D;&#x540C;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x6700;&#x7EC8;&#x8FBE;&#x5230;&#x4E0D;&#x540C;&#x7248;&#x672C;&#x4E0D;&#x540C;&#x5C55;&#x793A;&#x6548;&#x679C;&#x7684;&#x529F;&#x80FD;&#x3002;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-meta\">@Vaule(&quot;{test.a}&quot;)</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">private</span> String testA;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-meta\">@Vaule(&quot;{test.b}&quot;)</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">private</span> String testB;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">getTest</span><span class=\"hljs-params\">(String version)</span> </span>{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-string\">&apos;1.0&apos;</span>.equel(version)){</span><br><span class=\"line\">        System.out.println(testA);</span><br><span class=\"line\">    }<span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-string\">&apos;1.1&apos;</span>.equel(version)){</span><br><span class=\"line\">        System.out.println(testB);</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x53EF;&#x80FD;&#x4F1A;&#x6709;&#x66F4;&#x597D;&#x7684;&#x5904;&#x7406;&#x65B9;&#x6CD5;&#xFF0C;&#x4F46;&#x5927;&#x591A;&#x6570;&#x60C5;&#x51B5;&#x4E0B;&#x6211;&#x4EEC;&#x4F1A;&#x50CF;&#x4E0A;&#x9762;&#x5199;&#x4EE3;&#x7801;&#x3002;&#x957F;&#x6B64;&#x4EE5;&#x5F80;&#x53EF;&#x60F3;&#x800C;&#x77E5;&#xFF0C;&#x540E;&#x9762;&#x7684;&#x540C;&#x5B66;&#x4E0D;&#x77E5;&#x9053;&#x4E4B;&#x524D;&#x7684;&#x903B;&#x8F91;&#x5C31;&#x770B;&#x4E0D;&#x61C2;&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x5728;&#x5199;&#x4EC0;&#x4E48;&#x3002;&#x800C;&#x4E14;&#x6BCF;&#x6B21;&#x6709;&#x7248;&#x672C;&#x7684;&#x53D8;&#x66F4;&#xFF0C;&#x90FD;&#x9700;&#x8981;&#x786C;&#x7F16;&#x7801;&#x3002;</p>\n<p>&#x90A3;&#x6709;&#x6CA1;&#x6709;&#x66F4;&#x4F18;&#x96C5;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF0C;&#x65E2;&#x7136;&#x6211;&#x4EEC;&#x90FD;&#x6709;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x4E86;&#xFF0C;&#x540C;&#x65F6;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x4E5F;&#x90FD;&#x4EA4;&#x7531;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7BA1;&#x7406;&#x4E86;&#xFF0C;&#x914D;&#x7F6E;&#x53D8;&#x66F4;&#x65F6;&#x6211;&#x4EEC;&#x4E5F;&#x80FD;&#x5B9E;&#x65F6;&#x7684;&#x540C;&#x6B65;&#x914D;&#x7F6E;&#x3002;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x80FD;&#x4E0D;&#x80FD;&#x533A;&#x5206;&#x51FA;&#x76F8;&#x540C;&#x670D;&#x52A1;&#x7684;&#x5DEE;&#x5F02;&#x5316;&#x914D;&#x7F6E;&#x5462;&#xFF1F;</p>\n<p>&#x7B54;&#x6848;&#x80AF;&#x5B9A;&#x662F;&#x53EF;&#x4EE5;&#x7684;&#x3002;&#x5728;&#x5DF2;&#x670D;&#x52A1;&#x4F5C;&#x4E3A;&#x914D;&#x7F6E;&#x7684;&#x4F5C;&#x7528;&#x57DF;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x518D;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x7EC4;&#x7684;&#x6982;&#x5FF5;&#xFF1A;</p>\n<table>\n<thead>\n<tr>\n<th>Application</th>\n<th>Group</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Service1</td>\n<td>Default</td>\n</tr>\n<tr>\n<td>Service1</td>\n<td>V1.0</td>\n</tr>\n<tr>\n<td>Service1</td>\n<td>V1.1</td>\n</tr>\n<tr>\n<td>Service2</td>\n<td>Default</td>\n</tr>\n</tbody></table>\n<p>&#x540C;&#x4E00;&#x4E2A;&#x5E94;&#x7528;&#x53EF;&#x4EE5;&#x5212;&#x5206;&#x591A;&#x4E2A;&#x7EC4;&#xFF0C;&#x6BCF;&#x4E2A;&#x7EC4;&#x4E2D;&#x7684;&#x914D;&#x7F6E;&#x5B58;&#x5728;&#x5DEE;&#x5F02;&#x5316;&#xFF0C;&#x76F8;&#x540C;&#x914D;&#x7F6E;&#x7684;&#x670D;&#x52A1;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x540C;&#x4E00;&#x4E2A;&#x7EC4;&#x7684;&#x914D;&#x7F6E;&#x3002;</p>\n<p>&#x4EE5;&#x4E0A;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x5212;&#x5206;&#x914D;&#x7F6E;&#x8303;&#x56F4;&#x7684;&#x8FC7;&#x7A0B;&#xFF0C;&#x65E2;&#x53EF;&#x4EE5;&#x89E3;&#x51B3;&#x914D;&#x7F6E;&#x7684;&#x5DEE;&#x5F02;&#x5316;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5C06;&#x5404;&#x4E2A;&#x670D;&#x52A1;&#x7684;&#x914D;&#x7F6E;&#x7EDF;&#x4E00;&#x7BA1;&#x7406;&#x8D77;&#x6765;&#x3002;&#x5F53;&#x7136;&#x8FD9;&#x4E2A;&#x914D;&#x7F6E;&#x7684;&#x6A21;&#x578B;&#x8FD8;&#x9700;&#x8981;&#x4E0D;&#x65AD;&#x7684;&#x8FDB;&#x5316;&#xFF0C;&#x6BD4;&#x5982;&#xFF1A;&#x6211;&#x4EEC;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x63D0;&#x70BC;&#x51FA;&#x76F8;&#x540C;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x7C7B;&#x4F3C;&#x4E8E;jar&#x5728;&#x6211;&#x4EEC;&#x670D;&#x52A1;&#x4E2D;&#x76F8;&#x4E92;&#x5F15;&#x7528;&#x7684;&#x65B9;&#x5F0F;&#x4E00;&#x6837;&#xFF0C;&#x5728;&#x6211;&#x4EEC;&#x7ED9;&#x4E2A;&#x5E94;&#x7528;&#x4E2D;&#x5171;&#x4EAB;&#x3002;&#x672A;&#x6765;&#x6211;&#x4EEC;&#x4E5F;&#x4F1A;&#x9488;&#x5BF9;&#x7C7B;&#x4F3C;&#x7684;&#x9700;&#x6C42;&#x4E0D;&#x65AD;&#x7684;&#x4F18;&#x5316;&#x3002;</p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Redis","path":"tags/Redis/"},{"name":"配置中心","path":"tags/配置中心/"}],"excerpt":"<html><head></head><body><h2 id=\"&#x5F00;&#x7BC7;\"><a href=\"#&#x5F00;&#x7BC7;\" class=\"headerlink\" title=\"&#x5F00;&#x7BC7;\"></a>&#x5F00;&#x7BC7;</h2><p>&#x4ECE;&#x8FD9;&#x7BC7;&#x5F00;&#x59CB;&#xFF0C;&#x6211;&#x4EEC;&#x5F00;&#x59CB;&#x4ECB;&#x7ECD;&#x6574;&#x4E2A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x8BBE;&#x8BA1;&#x601D;&#x60F3;&#x548C;&#x67B6;&#x6784;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x4E3B;&#x8981;&#x4F1A;&#x5206;&#x4E3A;&#x4E0B;&#x9762;&#x51E0;&#x4E2A;&#x90E8;&#x5206;&#xFF1A;</p>\n<ol>\n<li>&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;</li>\n<li>&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x6280;&#x672F;&#x9009;&#x578B;</li>\n<li>&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x67B6;&#x6784;&#x90E8;&#x7F72;</li>\n</ol>\n<h2 id=\"&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7ED3;&#x6784;\"><a href=\"#&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7ED3;&#x6784;\" class=\"headerlink\" title=\"&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7ED3;&#x6784;\"></a>&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7ED3;&#x6784;</h2><p>&#x5F00;&#x59CB;&#x8BBE;&#x8BA1;&#x524D;&#x6211;&#x4EEC;&#x5148;&#x5206;&#x6790;&#x4E0B;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5230;&#x5E95;&#x9700;&#x8981;&#x54EA;&#x4E9B;&#x529F;&#x80FD;&#xFF0C;&#x540C;&#x65F6;&#x5DE5;&#x4F5C;&#x4E2D;&#x6709;&#x54EA;&#x4E9B;&#x75DB;&#x70B9;&#x662F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x6765;&#x89E3;&#x51B3;&#x7684;&#x3002;</p></body></html>","more":"<h4 id=\"1-配置的管理\"><a href=\"#1-配置的管理\" class=\"headerlink\" title=\"1.配置的管理\"></a>1.配置的管理</h4><p>原始的配置项管理大量采用了代码维护的方式，如spring的yml配置文件、代码中的@Value注解、各种中间件的配置文件等。不仅不利于配置的动态变更，更不利于统一管理配置信息，因此现有的配置中心解决方案会通常会将配置中心分为客户端和服务端。</p>\n<ul>\n<li>客户端负责业务系统的配置收集与实时同步等。</li>\n<li>服务端负责配置的统一管理和实时更新等。</li>\n</ul>\n<p>结合上面的思路，我们在设计的初期也会将整个配置中心的技术架构分为客户端和服务端两部分。</p>\n<p>回到配置管理的话题上，我们还需要考虑一个重要的功能点【如何管理配置】。这里的“管理”不单单只是将配置在某个页面上给用户展示而已，还要细化到：</p>\n<ul>\n<li>配置如何划分范围？</li>\n<li>配置差异化如何处理？</li>\n<li>配置权限如何处理？</li>\n</ul>\n<h6 id=\"配置如何划分范围？\"><a href=\"#配置如何划分范围？\" class=\"headerlink\" title=\"配置如何划分范围？\"></a>配置如何划分范围？</h6><p>各个业务服务连接到配置中心后，他们都有怎么不同的配置，我们不能把他们的配置全部混为一谈。不同的服务的配置有自己的作用域，多个相同服务共享同一个作用域下的配置。</p>\n<p>通过服务来划分配置范围是一个办法，我们在编写代码的时候其实也是这么处理的。但是仅仅如此是不够的。我们可以想象一个场景，业务场景上我们经常会遇到AB test，我们解决的办法常常是通过灰度发布或蓝绿发版。通过不同的规则将前端流量引向相同服务的不同版本从而实现生产上的差异化。</p>\n<p>如果我们只是简单的通过服务来划分配置，但遇到上诉问题的时候往往痛疼不已。1.0 Ver需要看到A文案，1.1 Ver需要看到B文案。我们假象下，如果通过过去的配置文件方式，我们要怎么处理？首先要在代码里判断当前服务的版本，然后根据不同的版本读取不同的配置，最终达到不同版本不同展示效果的功能。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Vaule(&quot;&#123;test.a&#125;&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String testA;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@Vaule(&quot;&#123;test.b&#125;&quot;)</span></span><br><span class=\"line\"><span class=\"keyword\">private</span> String testB;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">getTest</span><span class=\"params\">(String version)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"string\">&#x27;1.0&#x27;</span>.equel(version))&#123;</span><br><span class=\"line\">        System.out.println(testA);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"string\">&#x27;1.1&#x27;</span>.equel(version))&#123;</span><br><span class=\"line\">        System.out.println(testB);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>可能会有更好的处理方法，但大多数情况下我们会像上面写代码。长此以往可想而知，后面的同学不知道之前的逻辑就看不懂这段代码在写什么。而且每次有版本的变更，都需要硬编码。</p>\n<p>那有没有更优雅的解决方案，既然我们都有配置中心了，同时我们的配置也都交由配置中心管理了，配置变更时我们也能实时的同步配置。那么我们能不能区分出相同服务的差异化配置呢？</p>\n<p>答案肯定是可以的。在已服务作为配置的作用域下，我们再定义一个组的概念：</p>\n<table>\n<thead>\n<tr>\n<th>Application</th>\n<th>Group</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Service1</td>\n<td>Default</td>\n</tr>\n<tr>\n<td>Service1</td>\n<td>V1.0</td>\n</tr>\n<tr>\n<td>Service1</td>\n<td>V1.1</td>\n</tr>\n<tr>\n<td>Service2</td>\n<td>Default</td>\n</tr>\n</tbody></table>\n<p>同一个应用可以划分多个组，每个组中的配置存在差异化，相同配置的服务可以使用同一个组的配置。</p>\n<p>以上就是我们划分配置范围的过程，既可以解决配置的差异化，也可以将各个服务的配置统一管理起来。当然这个配置的模型还需要不断的进化，比如：我们是否可以提炼出相同的配置，类似于jar在我们服务中相互引用的方式一样，在我们给个应用中共享。未来我们也会针对类似的需求不断的优化。</p>"},{"title":"我为什么会手撸一个配置中心-设计篇（二）","date":"2020-04-11T12:45:24.000Z","_content":"\n## 基础功能分析--配置管理&维护\n上文我们分析了配置域管理相关的功能，这次我们要分析下配置中心的核心功能：配置更新。\n我们将从几个角度分析配置更新功能：\n\n* 客户端配置收集与本地维护\n* 服务端配置管理\n* 配置的热更新\n<!-- more -->\n#### 客户端配置收集与本地维护\n首先我们来讨论下我们平时使用配置的场景，前面一篇我们提到过，通过spring的@Value我们可以本地的管理配置。除此以为我们也可以实现自身的配置管理机制，最常见的如数据库管理并加载、KV中间件存储并加载、本地文件存储并加载等。\n\n考虑到项目本身希望更少的依赖第三方服务，同时能够实现配置的收集和管理，spring提供的@Valule不失为一个不错的选择。首先，spring容器会为我们自动收集并管理配置信息；其次，也提供了良好的环境配置隔离和本地配置维护。如果我们能够获取spring容器中维护的配置对象那不就能手工干预客户端配置的维护过程吗！\n\n#### 服务端配置管理\n相比客户端配置的管理，服务端就容易很多。通过上篇的分析，我们完全能够构建出自己的配置项结构，并交由DB持久化从而达到服务端配置管理的功能。\n\n#### 配置的热更新\n有了之前的客户端配置的收集和服务端配置管理的分析，我们要实现一套配置的热更新的技术方向就非常明确了。\n\n首先，客户端启动的时候，我们需要从远程服务端拉取到最新的配置，如果拉取不到则使用本地默认的。\n\n![01](我为什么会重新写一个配置中心-设计篇2/客户端启动并更新配置.png)\n\n\n其次，为了实现热更新。每当服务端对配置进行变更后，需要实时通知相应的客户端，并且客户端要同时更新最新的配置。\n\n![02](我为什么会重新写一个配置中心-设计篇2/服务端热更新配置.png)\n\n\n## 其他\n以上功能保证了我们的配置中心最基本的配置管理功能的整个生命周期。但围绕整个配置中心，还有许多其他功能需要分析，如配置的权限、用户的管理等。接下来的博客中，我们讲会讨论实现一个完整的配置中心，我们至少还需要哪些功能。最后围绕这些功能，我们会进入下一个重要篇章：选型篇。\n\n先做一个预告，后面的更新我们会围绕以下几个功能去展开：\n* 选型\n* 功能实现与源码\n* 与其他配置中心的比较\n* 未来的优化与展望\n","source":"_posts/我为什么会重新写一个配置中心-设计篇2.md","raw":"---\ntitle: 我为什么会手撸一个配置中心-设计篇（二）\ndate: 2020-04-11 20:45:24\ntags: \n    - Java\n    - Redis\n    - 配置中心\ncategories :\n    - Technology\n---\n\n## 基础功能分析--配置管理&维护\n上文我们分析了配置域管理相关的功能，这次我们要分析下配置中心的核心功能：配置更新。\n我们将从几个角度分析配置更新功能：\n\n* 客户端配置收集与本地维护\n* 服务端配置管理\n* 配置的热更新\n<!-- more -->\n#### 客户端配置收集与本地维护\n首先我们来讨论下我们平时使用配置的场景，前面一篇我们提到过，通过spring的@Value我们可以本地的管理配置。除此以为我们也可以实现自身的配置管理机制，最常见的如数据库管理并加载、KV中间件存储并加载、本地文件存储并加载等。\n\n考虑到项目本身希望更少的依赖第三方服务，同时能够实现配置的收集和管理，spring提供的@Valule不失为一个不错的选择。首先，spring容器会为我们自动收集并管理配置信息；其次，也提供了良好的环境配置隔离和本地配置维护。如果我们能够获取spring容器中维护的配置对象那不就能手工干预客户端配置的维护过程吗！\n\n#### 服务端配置管理\n相比客户端配置的管理，服务端就容易很多。通过上篇的分析，我们完全能够构建出自己的配置项结构，并交由DB持久化从而达到服务端配置管理的功能。\n\n#### 配置的热更新\n有了之前的客户端配置的收集和服务端配置管理的分析，我们要实现一套配置的热更新的技术方向就非常明确了。\n\n首先，客户端启动的时候，我们需要从远程服务端拉取到最新的配置，如果拉取不到则使用本地默认的。\n\n![01](我为什么会重新写一个配置中心-设计篇2/客户端启动并更新配置.png)\n\n\n其次，为了实现热更新。每当服务端对配置进行变更后，需要实时通知相应的客户端，并且客户端要同时更新最新的配置。\n\n![02](我为什么会重新写一个配置中心-设计篇2/服务端热更新配置.png)\n\n\n## 其他\n以上功能保证了我们的配置中心最基本的配置管理功能的整个生命周期。但围绕整个配置中心，还有许多其他功能需要分析，如配置的权限、用户的管理等。接下来的博客中，我们讲会讨论实现一个完整的配置中心，我们至少还需要哪些功能。最后围绕这些功能，我们会进入下一个重要篇章：选型篇。\n\n先做一个预告，后面的更新我们会围绕以下几个功能去展开：\n* 选型\n* 功能实现与源码\n* 与其他配置中心的比较\n* 未来的优化与展望\n","slug":"我为什么会重新写一个配置中心-设计篇2","published":1,"updated":"2020-12-14T10:34:34.801Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htm0018v252039k1qwo","content":"<html><head></head><body><h2 id=\"&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7BA1;&#x7406;-amp-&#x7EF4;&#x62A4;\"><a href=\"#&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7BA1;&#x7406;-amp-&#x7EF4;&#x62A4;\" class=\"headerlink\" title=\"&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&amp;&#x7EF4;&#x62A4;\"></a>&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&amp;&#x7EF4;&#x62A4;</h2><p>&#x4E0A;&#x6587;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x4E86;&#x914D;&#x7F6E;&#x57DF;&#x7BA1;&#x7406;&#x76F8;&#x5173;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x8981;&#x5206;&#x6790;&#x4E0B;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x6838;&#x5FC3;&#x529F;&#x80FD;&#xFF1A;&#x914D;&#x7F6E;&#x66F4;&#x65B0;&#x3002;<br>&#x6211;&#x4EEC;&#x5C06;&#x4ECE;&#x51E0;&#x4E2A;&#x89D2;&#x5EA6;&#x5206;&#x6790;&#x914D;&#x7F6E;&#x66F4;&#x65B0;&#x529F;&#x80FD;&#xFF1A;</p>\n<ul>\n<li>&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x6536;&#x96C6;&#x4E0E;&#x672C;&#x5730;&#x7EF4;&#x62A4;</li>\n<li>&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x7BA1;&#x7406;</li>\n<li>&#x914D;&#x7F6E;&#x7684;&#x70ED;&#x66F4;&#x65B0;<a id=\"more\"></a>\n<h4 id=\"&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x6536;&#x96C6;&#x4E0E;&#x672C;&#x5730;&#x7EF4;&#x62A4;\"><a href=\"#&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x6536;&#x96C6;&#x4E0E;&#x672C;&#x5730;&#x7EF4;&#x62A4;\" class=\"headerlink\" title=\"&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x6536;&#x96C6;&#x4E0E;&#x672C;&#x5730;&#x7EF4;&#x62A4;\"></a>&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x6536;&#x96C6;&#x4E0E;&#x672C;&#x5730;&#x7EF4;&#x62A4;</h4>&#x9996;&#x5148;&#x6211;&#x4EEC;&#x6765;&#x8BA8;&#x8BBA;&#x4E0B;&#x6211;&#x4EEC;&#x5E73;&#x65F6;&#x4F7F;&#x7528;&#x914D;&#x7F6E;&#x7684;&#x573A;&#x666F;&#xFF0C;&#x524D;&#x9762;&#x4E00;&#x7BC7;&#x6211;&#x4EEC;&#x63D0;&#x5230;&#x8FC7;&#xFF0C;&#x901A;&#x8FC7;spring&#x7684;@Value&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x672C;&#x5730;&#x7684;&#x7BA1;&#x7406;&#x914D;&#x7F6E;&#x3002;&#x9664;&#x6B64;&#x4EE5;&#x4E3A;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x81EA;&#x8EAB;&#x7684;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x673A;&#x5236;&#xFF0C;&#x6700;&#x5E38;&#x89C1;&#x7684;&#x5982;&#x6570;&#x636E;&#x5E93;&#x7BA1;&#x7406;&#x5E76;&#x52A0;&#x8F7D;&#x3001;KV&#x4E2D;&#x95F4;&#x4EF6;&#x5B58;&#x50A8;&#x5E76;&#x52A0;&#x8F7D;&#x3001;&#x672C;&#x5730;&#x6587;&#x4EF6;&#x5B58;&#x50A8;&#x5E76;&#x52A0;&#x8F7D;&#x7B49;&#x3002;</li>\n</ul>\n<p>&#x8003;&#x8651;&#x5230;&#x9879;&#x76EE;&#x672C;&#x8EAB;&#x5E0C;&#x671B;&#x66F4;&#x5C11;&#x7684;&#x4F9D;&#x8D56;&#x7B2C;&#x4E09;&#x65B9;&#x670D;&#x52A1;&#xFF0C;&#x540C;&#x65F6;&#x80FD;&#x591F;&#x5B9E;&#x73B0;&#x914D;&#x7F6E;&#x7684;&#x6536;&#x96C6;&#x548C;&#x7BA1;&#x7406;&#xFF0C;spring&#x63D0;&#x4F9B;&#x7684;@Valule&#x4E0D;&#x5931;&#x4E3A;&#x4E00;&#x4E2A;&#x4E0D;&#x9519;&#x7684;&#x9009;&#x62E9;&#x3002;&#x9996;&#x5148;&#xFF0C;spring&#x5BB9;&#x5668;&#x4F1A;&#x4E3A;&#x6211;&#x4EEC;&#x81EA;&#x52A8;&#x6536;&#x96C6;&#x5E76;&#x7BA1;&#x7406;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF1B;&#x5176;&#x6B21;&#xFF0C;&#x4E5F;&#x63D0;&#x4F9B;&#x4E86;&#x826F;&#x597D;&#x7684;&#x73AF;&#x5883;&#x914D;&#x7F6E;&#x9694;&#x79BB;&#x548C;&#x672C;&#x5730;&#x914D;&#x7F6E;&#x7EF4;&#x62A4;&#x3002;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x80FD;&#x591F;&#x83B7;&#x53D6;spring&#x5BB9;&#x5668;&#x4E2D;&#x7EF4;&#x62A4;&#x7684;&#x914D;&#x7F6E;&#x5BF9;&#x8C61;&#x90A3;&#x4E0D;&#x5C31;&#x80FD;&#x624B;&#x5DE5;&#x5E72;&#x9884;&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x7684;&#x7EF4;&#x62A4;&#x8FC7;&#x7A0B;&#x5417;&#xFF01;</p>\n<h4 id=\"&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x7BA1;&#x7406;\"><a href=\"#&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x7BA1;&#x7406;\" class=\"headerlink\" title=\"&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x7BA1;&#x7406;\"></a>&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x7BA1;&#x7406;</h4><p>&#x76F8;&#x6BD4;&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x7684;&#x7BA1;&#x7406;&#xFF0C;&#x670D;&#x52A1;&#x7AEF;&#x5C31;&#x5BB9;&#x6613;&#x5F88;&#x591A;&#x3002;&#x901A;&#x8FC7;&#x4E0A;&#x7BC7;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x6211;&#x4EEC;&#x5B8C;&#x5168;&#x80FD;&#x591F;&#x6784;&#x5EFA;&#x51FA;&#x81EA;&#x5DF1;&#x7684;&#x914D;&#x7F6E;&#x9879;&#x7ED3;&#x6784;&#xFF0C;&#x5E76;&#x4EA4;&#x7531;DB&#x6301;&#x4E45;&#x5316;&#x4ECE;&#x800C;&#x8FBE;&#x5230;&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x7684;&#x529F;&#x80FD;&#x3002;</p>\n<h4 id=\"&#x914D;&#x7F6E;&#x7684;&#x70ED;&#x66F4;&#x65B0;\"><a href=\"#&#x914D;&#x7F6E;&#x7684;&#x70ED;&#x66F4;&#x65B0;\" class=\"headerlink\" title=\"&#x914D;&#x7F6E;&#x7684;&#x70ED;&#x66F4;&#x65B0;\"></a>&#x914D;&#x7F6E;&#x7684;&#x70ED;&#x66F4;&#x65B0;</h4><p>&#x6709;&#x4E86;&#x4E4B;&#x524D;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x7684;&#x6536;&#x96C6;&#x548C;&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x6211;&#x4EEC;&#x8981;&#x5B9E;&#x73B0;&#x4E00;&#x5957;&#x914D;&#x7F6E;&#x7684;&#x70ED;&#x66F4;&#x65B0;&#x7684;&#x6280;&#x672F;&#x65B9;&#x5411;&#x5C31;&#x975E;&#x5E38;&#x660E;&#x786E;&#x4E86;&#x3002;</p>\n<p>&#x9996;&#x5148;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4ECE;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x7AEF;&#x62C9;&#x53D6;&#x5230;&#x6700;&#x65B0;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x5982;&#x679C;&#x62C9;&#x53D6;&#x4E0D;&#x5230;&#x5219;&#x4F7F;&#x7528;&#x672C;&#x5730;&#x9ED8;&#x8BA4;&#x7684;&#x3002;</p>\n<p><img src=\"/2020/04/11/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E8%AE%BE%E8%AE%A1%E7%AF%872/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%AF%E5%8A%A8%E5%B9%B6%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE.png\" alt=\"01\"></p>\n<p>&#x5176;&#x6B21;&#xFF0C;&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x70ED;&#x66F4;&#x65B0;&#x3002;&#x6BCF;&#x5F53;&#x670D;&#x52A1;&#x7AEF;&#x5BF9;&#x914D;&#x7F6E;&#x8FDB;&#x884C;&#x53D8;&#x66F4;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x5B9E;&#x65F6;&#x901A;&#x77E5;&#x76F8;&#x5E94;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5E76;&#x4E14;&#x5BA2;&#x6237;&#x7AEF;&#x8981;&#x540C;&#x65F6;&#x66F4;&#x65B0;&#x6700;&#x65B0;&#x7684;&#x914D;&#x7F6E;&#x3002;</p>\n<p><img src=\"/2020/04/11/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E8%AE%BE%E8%AE%A1%E7%AF%872/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%83%AD%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE.png\" alt=\"02\"></p>\n<h2 id=\"&#x5176;&#x4ED6;\"><a href=\"#&#x5176;&#x4ED6;\" class=\"headerlink\" title=\"&#x5176;&#x4ED6;\"></a>&#x5176;&#x4ED6;</h2><p>&#x4EE5;&#x4E0A;&#x529F;&#x80FD;&#x4FDD;&#x8BC1;&#x4E86;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x6700;&#x57FA;&#x672C;&#x7684;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x529F;&#x80FD;&#x7684;&#x6574;&#x4E2A;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;&#x4F46;&#x56F4;&#x7ED5;&#x6574;&#x4E2A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#xFF0C;&#x8FD8;&#x6709;&#x8BB8;&#x591A;&#x5176;&#x4ED6;&#x529F;&#x80FD;&#x9700;&#x8981;&#x5206;&#x6790;&#xFF0C;&#x5982;&#x914D;&#x7F6E;&#x7684;&#x6743;&#x9650;&#x3001;&#x7528;&#x6237;&#x7684;&#x7BA1;&#x7406;&#x7B49;&#x3002;&#x63A5;&#x4E0B;&#x6765;&#x7684;&#x535A;&#x5BA2;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x8BB2;&#x4F1A;&#x8BA8;&#x8BBA;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#xFF0C;&#x6211;&#x4EEC;&#x81F3;&#x5C11;&#x8FD8;&#x9700;&#x8981;&#x54EA;&#x4E9B;&#x529F;&#x80FD;&#x3002;&#x6700;&#x540E;&#x56F4;&#x7ED5;&#x8FD9;&#x4E9B;&#x529F;&#x80FD;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x8FDB;&#x5165;&#x4E0B;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x7BC7;&#x7AE0;&#xFF1A;&#x9009;&#x578B;&#x7BC7;&#x3002;</p>\n<p>&#x5148;&#x505A;&#x4E00;&#x4E2A;&#x9884;&#x544A;&#xFF0C;&#x540E;&#x9762;&#x7684;&#x66F4;&#x65B0;&#x6211;&#x4EEC;&#x4F1A;&#x56F4;&#x7ED5;&#x4EE5;&#x4E0B;&#x51E0;&#x4E2A;&#x529F;&#x80FD;&#x53BB;&#x5C55;&#x5F00;&#xFF1A;</p>\n<ul>\n<li>&#x9009;&#x578B;</li>\n<li>&#x529F;&#x80FD;&#x5B9E;&#x73B0;&#x4E0E;&#x6E90;&#x7801;</li>\n<li>&#x4E0E;&#x5176;&#x4ED6;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x6BD4;&#x8F83;</li>\n<li>&#x672A;&#x6765;&#x7684;&#x4F18;&#x5316;&#x4E0E;&#x5C55;&#x671B;</li>\n</ul>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Redis","path":"tags/Redis/"},{"name":"配置中心","path":"tags/配置中心/"}],"excerpt":"<html><head></head><body><h2 id=\"&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7BA1;&#x7406;-amp-&#x7EF4;&#x62A4;\"><a href=\"#&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7BA1;&#x7406;-amp-&#x7EF4;&#x62A4;\" class=\"headerlink\" title=\"&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&amp;&#x7EF4;&#x62A4;\"></a>&#x57FA;&#x7840;&#x529F;&#x80FD;&#x5206;&#x6790;&#x2013;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&amp;&#x7EF4;&#x62A4;</h2><p>&#x4E0A;&#x6587;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x4E86;&#x914D;&#x7F6E;&#x57DF;&#x7BA1;&#x7406;&#x76F8;&#x5173;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x8981;&#x5206;&#x6790;&#x4E0B;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x6838;&#x5FC3;&#x529F;&#x80FD;&#xFF1A;&#x914D;&#x7F6E;&#x66F4;&#x65B0;&#x3002;<br>&#x6211;&#x4EEC;&#x5C06;&#x4ECE;&#x51E0;&#x4E2A;&#x89D2;&#x5EA6;&#x5206;&#x6790;&#x914D;&#x7F6E;&#x66F4;&#x65B0;&#x529F;&#x80FD;&#xFF1A;</p>\n<ul>\n<li>&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x6536;&#x96C6;&#x4E0E;&#x672C;&#x5730;&#x7EF4;&#x62A4;</li>\n<li>&#x670D;&#x52A1;&#x7AEF;&#x914D;&#x7F6E;&#x7BA1;&#x7406;</li>\n<li>&#x914D;&#x7F6E;&#x7684;&#x70ED;&#x66F4;&#x65B0;</li></ul></body></html>","more":"<h4 id=\"客户端配置收集与本地维护\"><a href=\"#客户端配置收集与本地维护\" class=\"headerlink\" title=\"客户端配置收集与本地维护\"></a>客户端配置收集与本地维护</h4>首先我们来讨论下我们平时使用配置的场景，前面一篇我们提到过，通过spring的@Value我们可以本地的管理配置。除此以为我们也可以实现自身的配置管理机制，最常见的如数据库管理并加载、KV中间件存储并加载、本地文件存储并加载等。\n\n<p>考虑到项目本身希望更少的依赖第三方服务，同时能够实现配置的收集和管理，spring提供的@Valule不失为一个不错的选择。首先，spring容器会为我们自动收集并管理配置信息；其次，也提供了良好的环境配置隔离和本地配置维护。如果我们能够获取spring容器中维护的配置对象那不就能手工干预客户端配置的维护过程吗！</p>\n<h4 id=\"服务端配置管理\"><a href=\"#服务端配置管理\" class=\"headerlink\" title=\"服务端配置管理\"></a>服务端配置管理</h4><p>相比客户端配置的管理，服务端就容易很多。通过上篇的分析，我们完全能够构建出自己的配置项结构，并交由DB持久化从而达到服务端配置管理的功能。</p>\n<h4 id=\"配置的热更新\"><a href=\"#配置的热更新\" class=\"headerlink\" title=\"配置的热更新\"></a>配置的热更新</h4><p>有了之前的客户端配置的收集和服务端配置管理的分析，我们要实现一套配置的热更新的技术方向就非常明确了。</p>\n<p>首先，客户端启动的时候，我们需要从远程服务端拉取到最新的配置，如果拉取不到则使用本地默认的。</p>\n<p><img src=\"/2020/04/11/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E8%AE%BE%E8%AE%A1%E7%AF%872/%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%90%AF%E5%8A%A8%E5%B9%B6%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE.png\" alt=\"01\"></p>\n<p>其次，为了实现热更新。每当服务端对配置进行变更后，需要实时通知相应的客户端，并且客户端要同时更新最新的配置。</p>\n<p><img src=\"/2020/04/11/%E6%88%91%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E9%87%8D%E6%96%B0%E5%86%99%E4%B8%80%E4%B8%AA%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83-%E8%AE%BE%E8%AE%A1%E7%AF%872/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%83%AD%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE.png\" alt=\"02\"></p>\n<h2 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h2><p>以上功能保证了我们的配置中心最基本的配置管理功能的整个生命周期。但围绕整个配置中心，还有许多其他功能需要分析，如配置的权限、用户的管理等。接下来的博客中，我们讲会讨论实现一个完整的配置中心，我们至少还需要哪些功能。最后围绕这些功能，我们会进入下一个重要篇章：选型篇。</p>\n<p>先做一个预告，后面的更新我们会围绕以下几个功能去展开：</p>\n<ul>\n<li>选型</li>\n<li>功能实现与源码</li>\n<li>与其他配置中心的比较</li>\n<li>未来的优化与展望</li>\n</ul>"},{"title":"我为什么会手撸一个配置中心-设计篇（三）","date":"2020-04-12T06:29:58.000Z","_content":"\n## 功能&架构选型\n在做具体的架构选型前，先要明确两个问题：我们的技术栈是什么？我们是为怎样的技术团队提供服务的。\n\n#### 选型前的讨论\n当前公司后端团队大量的采用了JAVA的技术栈，随着公司的发展围绕着Spring Cloud全家桶，团队已经搭建了相当多的业务服务。可以说我们设计的配合中心服务在最大限度上会以JAVA为基础，围绕着Spring的生态圈进行设计并开发。\n\n那么回到我们之前的架构选型话题，可以将问题改为：如何围绕Spring的生命周期，实现一套配置灵活、管理简洁、值热更新的系统。\n<!-- more -->\n确定我们必须结合Spring后，接下来需要明确的就是，如何实现配置的热更新。目前开源的配置中心有这么几种解决方案：\n\n方式|中间件|优点|缺点\n|---|---|---|---|\n|服务端调用客户端Api进行推送|无需|实现简单<br>无需引入第三方中间件|依赖Http请求过于重<br>自定义协议开发复杂<br>需要自己保证请求的可靠性 |\n|客户端调用服务端Api进行拉取|无需|实现简单<br>无需引入第三方中间件|依赖Http请求过于重<br>自定义协议开发复杂<br>需要自己保证请求的可靠性 |\n|依赖第三方中间件推送|Zookeeper、Redis、Nasco等|开发简单、不需要自己实现通讯<br>可依赖中间件自身的HA做高可用|增加了项目的复杂度<br>需要考虑中间件和当前项目的冲突问题|\n\n对比了市场上的设计和我们的自身的人力成本，我们决定引入一款成熟中间件来解决大部分的通讯和配置发现问题。这个时候摆在我们面前的可选项其实还是很有限的，能胜任我们的需求的无非就是Zk、redis、MQ这几个。\n\n这几个耳熟能详的中间件上来我们就放弃了zk，考虑主要有以下几点。\n1. zk不适合做大量数据的存储，特别是配置这种结构化的数据。虽然zk的CP特性能为我们带来精准的配置推送特性，但是遇到大量的配置内容zk就显得力不从心。\n2. zk的snapshot功能，一旦发现数据对其问题，需要停机人工处理。\n3. 近年来zk在服务注册发现上大展拳脚，但我始终认为zk在作为注册中心时会显得捉襟见肘，元数据管理才是它真正运用的领域。这一点正好契合我们的契机，不过不巧的是我们想要开发的并不是一个分布式的配置中心，或者说分布式并不是我们的中心。反而分布式的配置管理才是我们最好的选择。\n   \n剩下就是MQ和redis中做选择，他们两个就比较好抉择了。MQ和Redis都可以做到HA、变更的实时推送、但是MQ没法做到数据的管理。加上我们的系统里已近大量的使用到了redis，对redis的操作也比较熟悉。最终我们选择了redis作为中间件为我们的配置中心做配置的统一管理。","source":"_posts/我为什么会重新写一个配置中心-设计篇3.md","raw":"---\ntitle: 我为什么会手撸一个配置中心-设计篇（三）\ndate: 2020-04-12 14:29:58\ntags: \n    - Java\n    - Redis\n    - 配置中心\ncategories :\n    - Technology\n---\n\n## 功能&架构选型\n在做具体的架构选型前，先要明确两个问题：我们的技术栈是什么？我们是为怎样的技术团队提供服务的。\n\n#### 选型前的讨论\n当前公司后端团队大量的采用了JAVA的技术栈，随着公司的发展围绕着Spring Cloud全家桶，团队已经搭建了相当多的业务服务。可以说我们设计的配合中心服务在最大限度上会以JAVA为基础，围绕着Spring的生态圈进行设计并开发。\n\n那么回到我们之前的架构选型话题，可以将问题改为：如何围绕Spring的生命周期，实现一套配置灵活、管理简洁、值热更新的系统。\n<!-- more -->\n确定我们必须结合Spring后，接下来需要明确的就是，如何实现配置的热更新。目前开源的配置中心有这么几种解决方案：\n\n方式|中间件|优点|缺点\n|---|---|---|---|\n|服务端调用客户端Api进行推送|无需|实现简单<br>无需引入第三方中间件|依赖Http请求过于重<br>自定义协议开发复杂<br>需要自己保证请求的可靠性 |\n|客户端调用服务端Api进行拉取|无需|实现简单<br>无需引入第三方中间件|依赖Http请求过于重<br>自定义协议开发复杂<br>需要自己保证请求的可靠性 |\n|依赖第三方中间件推送|Zookeeper、Redis、Nasco等|开发简单、不需要自己实现通讯<br>可依赖中间件自身的HA做高可用|增加了项目的复杂度<br>需要考虑中间件和当前项目的冲突问题|\n\n对比了市场上的设计和我们的自身的人力成本，我们决定引入一款成熟中间件来解决大部分的通讯和配置发现问题。这个时候摆在我们面前的可选项其实还是很有限的，能胜任我们的需求的无非就是Zk、redis、MQ这几个。\n\n这几个耳熟能详的中间件上来我们就放弃了zk，考虑主要有以下几点。\n1. zk不适合做大量数据的存储，特别是配置这种结构化的数据。虽然zk的CP特性能为我们带来精准的配置推送特性，但是遇到大量的配置内容zk就显得力不从心。\n2. zk的snapshot功能，一旦发现数据对其问题，需要停机人工处理。\n3. 近年来zk在服务注册发现上大展拳脚，但我始终认为zk在作为注册中心时会显得捉襟见肘，元数据管理才是它真正运用的领域。这一点正好契合我们的契机，不过不巧的是我们想要开发的并不是一个分布式的配置中心，或者说分布式并不是我们的中心。反而分布式的配置管理才是我们最好的选择。\n   \n剩下就是MQ和redis中做选择，他们两个就比较好抉择了。MQ和Redis都可以做到HA、变更的实时推送、但是MQ没法做到数据的管理。加上我们的系统里已近大量的使用到了redis，对redis的操作也比较熟悉。最终我们选择了redis作为中间件为我们的配置中心做配置的统一管理。","slug":"我为什么会重新写一个配置中心-设计篇3","published":1,"updated":"2020-12-14T09:51:24.049Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htn001av252bj839727","content":"<html><head></head><body><h2 id=\"&#x529F;&#x80FD;-amp-&#x67B6;&#x6784;&#x9009;&#x578B;\"><a href=\"#&#x529F;&#x80FD;-amp-&#x67B6;&#x6784;&#x9009;&#x578B;\" class=\"headerlink\" title=\"&#x529F;&#x80FD;&amp;&#x67B6;&#x6784;&#x9009;&#x578B;\"></a>&#x529F;&#x80FD;&amp;&#x67B6;&#x6784;&#x9009;&#x578B;</h2><p>&#x5728;&#x505A;&#x5177;&#x4F53;&#x7684;&#x67B6;&#x6784;&#x9009;&#x578B;&#x524D;&#xFF0C;&#x5148;&#x8981;&#x660E;&#x786E;&#x4E24;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x6211;&#x4EEC;&#x7684;&#x6280;&#x672F;&#x6808;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x6211;&#x4EEC;&#x662F;&#x4E3A;&#x600E;&#x6837;&#x7684;&#x6280;&#x672F;&#x56E2;&#x961F;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x7684;&#x3002;</p>\n<h4 id=\"&#x9009;&#x578B;&#x524D;&#x7684;&#x8BA8;&#x8BBA;\"><a href=\"#&#x9009;&#x578B;&#x524D;&#x7684;&#x8BA8;&#x8BBA;\" class=\"headerlink\" title=\"&#x9009;&#x578B;&#x524D;&#x7684;&#x8BA8;&#x8BBA;\"></a>&#x9009;&#x578B;&#x524D;&#x7684;&#x8BA8;&#x8BBA;</h4><p>&#x5F53;&#x524D;&#x516C;&#x53F8;&#x540E;&#x7AEF;&#x56E2;&#x961F;&#x5927;&#x91CF;&#x7684;&#x91C7;&#x7528;&#x4E86;JAVA&#x7684;&#x6280;&#x672F;&#x6808;&#xFF0C;&#x968F;&#x7740;&#x516C;&#x53F8;&#x7684;&#x53D1;&#x5C55;&#x56F4;&#x7ED5;&#x7740;Spring Cloud&#x5168;&#x5BB6;&#x6876;&#xFF0C;&#x56E2;&#x961F;&#x5DF2;&#x7ECF;&#x642D;&#x5EFA;&#x4E86;&#x76F8;&#x5F53;&#x591A;&#x7684;&#x4E1A;&#x52A1;&#x670D;&#x52A1;&#x3002;&#x53EF;&#x4EE5;&#x8BF4;&#x6211;&#x4EEC;&#x8BBE;&#x8BA1;&#x7684;&#x914D;&#x5408;&#x4E2D;&#x5FC3;&#x670D;&#x52A1;&#x5728;&#x6700;&#x5927;&#x9650;&#x5EA6;&#x4E0A;&#x4F1A;&#x4EE5;JAVA&#x4E3A;&#x57FA;&#x7840;&#xFF0C;&#x56F4;&#x7ED5;&#x7740;Spring&#x7684;&#x751F;&#x6001;&#x5708;&#x8FDB;&#x884C;&#x8BBE;&#x8BA1;&#x5E76;&#x5F00;&#x53D1;&#x3002;</p>\n<p>&#x90A3;&#x4E48;&#x56DE;&#x5230;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x7684;&#x67B6;&#x6784;&#x9009;&#x578B;&#x8BDD;&#x9898;&#xFF0C;&#x53EF;&#x4EE5;&#x5C06;&#x95EE;&#x9898;&#x6539;&#x4E3A;&#xFF1A;&#x5982;&#x4F55;&#x56F4;&#x7ED5;Spring&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF0C;&#x5B9E;&#x73B0;&#x4E00;&#x5957;&#x914D;&#x7F6E;&#x7075;&#x6D3B;&#x3001;&#x7BA1;&#x7406;&#x7B80;&#x6D01;&#x3001;&#x503C;&#x70ED;&#x66F4;&#x65B0;&#x7684;&#x7CFB;&#x7EDF;&#x3002;</p>\n<a id=\"more\"></a>\n<p>&#x786E;&#x5B9A;&#x6211;&#x4EEC;&#x5FC5;&#x987B;&#x7ED3;&#x5408;Spring&#x540E;&#xFF0C;&#x63A5;&#x4E0B;&#x6765;&#x9700;&#x8981;&#x660E;&#x786E;&#x7684;&#x5C31;&#x662F;&#xFF0C;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x914D;&#x7F6E;&#x7684;&#x70ED;&#x66F4;&#x65B0;&#x3002;&#x76EE;&#x524D;&#x5F00;&#x6E90;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x6709;&#x8FD9;&#x4E48;&#x51E0;&#x79CD;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF1A;</p>\n<p>&#x65B9;&#x5F0F;|&#x4E2D;&#x95F4;&#x4EF6;|&#x4F18;&#x70B9;|&#x7F3A;&#x70B9;<br>|&#x2014;|&#x2014;|&#x2014;|&#x2014;|<br>|&#x670D;&#x52A1;&#x7AEF;&#x8C03;&#x7528;&#x5BA2;&#x6237;&#x7AEF;Api&#x8FDB;&#x884C;&#x63A8;&#x9001;|&#x65E0;&#x9700;|&#x5B9E;&#x73B0;&#x7B80;&#x5355;<br>&#x65E0;&#x9700;&#x5F15;&#x5165;&#x7B2C;&#x4E09;&#x65B9;&#x4E2D;&#x95F4;&#x4EF6;|&#x4F9D;&#x8D56;Http&#x8BF7;&#x6C42;&#x8FC7;&#x4E8E;&#x91CD;<br>&#x81EA;&#x5B9A;&#x4E49;&#x534F;&#x8BAE;&#x5F00;&#x53D1;&#x590D;&#x6742;<br>&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x4FDD;&#x8BC1;&#x8BF7;&#x6C42;&#x7684;&#x53EF;&#x9760;&#x6027; |<br>|&#x5BA2;&#x6237;&#x7AEF;&#x8C03;&#x7528;&#x670D;&#x52A1;&#x7AEF;Api&#x8FDB;&#x884C;&#x62C9;&#x53D6;|&#x65E0;&#x9700;|&#x5B9E;&#x73B0;&#x7B80;&#x5355;<br>&#x65E0;&#x9700;&#x5F15;&#x5165;&#x7B2C;&#x4E09;&#x65B9;&#x4E2D;&#x95F4;&#x4EF6;|&#x4F9D;&#x8D56;Http&#x8BF7;&#x6C42;&#x8FC7;&#x4E8E;&#x91CD;<br>&#x81EA;&#x5B9A;&#x4E49;&#x534F;&#x8BAE;&#x5F00;&#x53D1;&#x590D;&#x6742;<br>&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x4FDD;&#x8BC1;&#x8BF7;&#x6C42;&#x7684;&#x53EF;&#x9760;&#x6027; |<br>|&#x4F9D;&#x8D56;&#x7B2C;&#x4E09;&#x65B9;&#x4E2D;&#x95F4;&#x4EF6;&#x63A8;&#x9001;|Zookeeper&#x3001;Redis&#x3001;Nasco&#x7B49;|&#x5F00;&#x53D1;&#x7B80;&#x5355;&#x3001;&#x4E0D;&#x9700;&#x8981;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;&#x901A;&#x8BAF;<br>&#x53EF;&#x4F9D;&#x8D56;&#x4E2D;&#x95F4;&#x4EF6;&#x81EA;&#x8EAB;&#x7684;HA&#x505A;&#x9AD8;&#x53EF;&#x7528;|&#x589E;&#x52A0;&#x4E86;&#x9879;&#x76EE;&#x7684;&#x590D;&#x6742;&#x5EA6;<br>&#x9700;&#x8981;&#x8003;&#x8651;&#x4E2D;&#x95F4;&#x4EF6;&#x548C;&#x5F53;&#x524D;&#x9879;&#x76EE;&#x7684;&#x51B2;&#x7A81;&#x95EE;&#x9898;|</p>\n<p>&#x5BF9;&#x6BD4;&#x4E86;&#x5E02;&#x573A;&#x4E0A;&#x7684;&#x8BBE;&#x8BA1;&#x548C;&#x6211;&#x4EEC;&#x7684;&#x81EA;&#x8EAB;&#x7684;&#x4EBA;&#x529B;&#x6210;&#x672C;&#xFF0C;&#x6211;&#x4EEC;&#x51B3;&#x5B9A;&#x5F15;&#x5165;&#x4E00;&#x6B3E;&#x6210;&#x719F;&#x4E2D;&#x95F4;&#x4EF6;&#x6765;&#x89E3;&#x51B3;&#x5927;&#x90E8;&#x5206;&#x7684;&#x901A;&#x8BAF;&#x548C;&#x914D;&#x7F6E;&#x53D1;&#x73B0;&#x95EE;&#x9898;&#x3002;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x6446;&#x5728;&#x6211;&#x4EEC;&#x9762;&#x524D;&#x7684;&#x53EF;&#x9009;&#x9879;&#x5176;&#x5B9E;&#x8FD8;&#x662F;&#x5F88;&#x6709;&#x9650;&#x7684;&#xFF0C;&#x80FD;&#x80DC;&#x4EFB;&#x6211;&#x4EEC;&#x7684;&#x9700;&#x6C42;&#x7684;&#x65E0;&#x975E;&#x5C31;&#x662F;Zk&#x3001;redis&#x3001;MQ&#x8FD9;&#x51E0;&#x4E2A;&#x3002;</p>\n<p>&#x8FD9;&#x51E0;&#x4E2A;&#x8033;&#x719F;&#x80FD;&#x8BE6;&#x7684;&#x4E2D;&#x95F4;&#x4EF6;&#x4E0A;&#x6765;&#x6211;&#x4EEC;&#x5C31;&#x653E;&#x5F03;&#x4E86;zk&#xFF0C;&#x8003;&#x8651;&#x4E3B;&#x8981;&#x6709;&#x4EE5;&#x4E0B;&#x51E0;&#x70B9;&#x3002;</p>\n<ol>\n<li>zk&#x4E0D;&#x9002;&#x5408;&#x505A;&#x5927;&#x91CF;&#x6570;&#x636E;&#x7684;&#x5B58;&#x50A8;&#xFF0C;&#x7279;&#x522B;&#x662F;&#x914D;&#x7F6E;&#x8FD9;&#x79CD;&#x7ED3;&#x6784;&#x5316;&#x7684;&#x6570;&#x636E;&#x3002;&#x867D;&#x7136;zk&#x7684;CP&#x7279;&#x6027;&#x80FD;&#x4E3A;&#x6211;&#x4EEC;&#x5E26;&#x6765;&#x7CBE;&#x51C6;&#x7684;&#x914D;&#x7F6E;&#x63A8;&#x9001;&#x7279;&#x6027;&#xFF0C;&#x4F46;&#x662F;&#x9047;&#x5230;&#x5927;&#x91CF;&#x7684;&#x914D;&#x7F6E;&#x5185;&#x5BB9;zk&#x5C31;&#x663E;&#x5F97;&#x529B;&#x4E0D;&#x4ECE;&#x5FC3;&#x3002;</li>\n<li>zk&#x7684;snapshot&#x529F;&#x80FD;&#xFF0C;&#x4E00;&#x65E6;&#x53D1;&#x73B0;&#x6570;&#x636E;&#x5BF9;&#x5176;&#x95EE;&#x9898;&#xFF0C;&#x9700;&#x8981;&#x505C;&#x673A;&#x4EBA;&#x5DE5;&#x5904;&#x7406;&#x3002;</li>\n<li>&#x8FD1;&#x5E74;&#x6765;zk&#x5728;&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x53D1;&#x73B0;&#x4E0A;&#x5927;&#x5C55;&#x62F3;&#x811A;&#xFF0C;&#x4F46;&#x6211;&#x59CB;&#x7EC8;&#x8BA4;&#x4E3A;zk&#x5728;&#x4F5C;&#x4E3A;&#x6CE8;&#x518C;&#x4E2D;&#x5FC3;&#x65F6;&#x4F1A;&#x663E;&#x5F97;&#x6349;&#x895F;&#x89C1;&#x8098;&#xFF0C;&#x5143;&#x6570;&#x636E;&#x7BA1;&#x7406;&#x624D;&#x662F;&#x5B83;&#x771F;&#x6B63;&#x8FD0;&#x7528;&#x7684;&#x9886;&#x57DF;&#x3002;&#x8FD9;&#x4E00;&#x70B9;&#x6B63;&#x597D;&#x5951;&#x5408;&#x6211;&#x4EEC;&#x7684;&#x5951;&#x673A;&#xFF0C;&#x4E0D;&#x8FC7;&#x4E0D;&#x5DE7;&#x7684;&#x662F;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x5F00;&#x53D1;&#x7684;&#x5E76;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#xFF0C;&#x6216;&#x8005;&#x8BF4;&#x5206;&#x5E03;&#x5F0F;&#x5E76;&#x4E0D;&#x662F;&#x6211;&#x4EEC;&#x7684;&#x4E2D;&#x5FC3;&#x3002;&#x53CD;&#x800C;&#x5206;&#x5E03;&#x5F0F;&#x7684;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x624D;&#x662F;&#x6211;&#x4EEC;&#x6700;&#x597D;&#x7684;&#x9009;&#x62E9;&#x3002;</li>\n</ol>\n<p>&#x5269;&#x4E0B;&#x5C31;&#x662F;MQ&#x548C;redis&#x4E2D;&#x505A;&#x9009;&#x62E9;&#xFF0C;&#x4ED6;&#x4EEC;&#x4E24;&#x4E2A;&#x5C31;&#x6BD4;&#x8F83;&#x597D;&#x6289;&#x62E9;&#x4E86;&#x3002;MQ&#x548C;Redis&#x90FD;&#x53EF;&#x4EE5;&#x505A;&#x5230;HA&#x3001;&#x53D8;&#x66F4;&#x7684;&#x5B9E;&#x65F6;&#x63A8;&#x9001;&#x3001;&#x4F46;&#x662F;MQ&#x6CA1;&#x6CD5;&#x505A;&#x5230;&#x6570;&#x636E;&#x7684;&#x7BA1;&#x7406;&#x3002;&#x52A0;&#x4E0A;&#x6211;&#x4EEC;&#x7684;&#x7CFB;&#x7EDF;&#x91CC;&#x5DF2;&#x8FD1;&#x5927;&#x91CF;&#x7684;&#x4F7F;&#x7528;&#x5230;&#x4E86;redis&#xFF0C;&#x5BF9;redis&#x7684;&#x64CD;&#x4F5C;&#x4E5F;&#x6BD4;&#x8F83;&#x719F;&#x6089;&#x3002;&#x6700;&#x7EC8;&#x6211;&#x4EEC;&#x9009;&#x62E9;&#x4E86;redis&#x4F5C;&#x4E3A;&#x4E2D;&#x95F4;&#x4EF6;&#x4E3A;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x505A;&#x914D;&#x7F6E;&#x7684;&#x7EDF;&#x4E00;&#x7BA1;&#x7406;&#x3002;</p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Redis","path":"tags/Redis/"},{"name":"配置中心","path":"tags/配置中心/"}],"excerpt":"<html><head></head><body><h2 id=\"&#x529F;&#x80FD;-amp-&#x67B6;&#x6784;&#x9009;&#x578B;\"><a href=\"#&#x529F;&#x80FD;-amp-&#x67B6;&#x6784;&#x9009;&#x578B;\" class=\"headerlink\" title=\"&#x529F;&#x80FD;&amp;&#x67B6;&#x6784;&#x9009;&#x578B;\"></a>&#x529F;&#x80FD;&amp;&#x67B6;&#x6784;&#x9009;&#x578B;</h2><p>&#x5728;&#x505A;&#x5177;&#x4F53;&#x7684;&#x67B6;&#x6784;&#x9009;&#x578B;&#x524D;&#xFF0C;&#x5148;&#x8981;&#x660E;&#x786E;&#x4E24;&#x4E2A;&#x95EE;&#x9898;&#xFF1A;&#x6211;&#x4EEC;&#x7684;&#x6280;&#x672F;&#x6808;&#x662F;&#x4EC0;&#x4E48;&#xFF1F;&#x6211;&#x4EEC;&#x662F;&#x4E3A;&#x600E;&#x6837;&#x7684;&#x6280;&#x672F;&#x56E2;&#x961F;&#x63D0;&#x4F9B;&#x670D;&#x52A1;&#x7684;&#x3002;</p>\n<h4 id=\"&#x9009;&#x578B;&#x524D;&#x7684;&#x8BA8;&#x8BBA;\"><a href=\"#&#x9009;&#x578B;&#x524D;&#x7684;&#x8BA8;&#x8BBA;\" class=\"headerlink\" title=\"&#x9009;&#x578B;&#x524D;&#x7684;&#x8BA8;&#x8BBA;\"></a>&#x9009;&#x578B;&#x524D;&#x7684;&#x8BA8;&#x8BBA;</h4><p>&#x5F53;&#x524D;&#x516C;&#x53F8;&#x540E;&#x7AEF;&#x56E2;&#x961F;&#x5927;&#x91CF;&#x7684;&#x91C7;&#x7528;&#x4E86;JAVA&#x7684;&#x6280;&#x672F;&#x6808;&#xFF0C;&#x968F;&#x7740;&#x516C;&#x53F8;&#x7684;&#x53D1;&#x5C55;&#x56F4;&#x7ED5;&#x7740;Spring Cloud&#x5168;&#x5BB6;&#x6876;&#xFF0C;&#x56E2;&#x961F;&#x5DF2;&#x7ECF;&#x642D;&#x5EFA;&#x4E86;&#x76F8;&#x5F53;&#x591A;&#x7684;&#x4E1A;&#x52A1;&#x670D;&#x52A1;&#x3002;&#x53EF;&#x4EE5;&#x8BF4;&#x6211;&#x4EEC;&#x8BBE;&#x8BA1;&#x7684;&#x914D;&#x5408;&#x4E2D;&#x5FC3;&#x670D;&#x52A1;&#x5728;&#x6700;&#x5927;&#x9650;&#x5EA6;&#x4E0A;&#x4F1A;&#x4EE5;JAVA&#x4E3A;&#x57FA;&#x7840;&#xFF0C;&#x56F4;&#x7ED5;&#x7740;Spring&#x7684;&#x751F;&#x6001;&#x5708;&#x8FDB;&#x884C;&#x8BBE;&#x8BA1;&#x5E76;&#x5F00;&#x53D1;&#x3002;</p>\n<p>&#x90A3;&#x4E48;&#x56DE;&#x5230;&#x6211;&#x4EEC;&#x4E4B;&#x524D;&#x7684;&#x67B6;&#x6784;&#x9009;&#x578B;&#x8BDD;&#x9898;&#xFF0C;&#x53EF;&#x4EE5;&#x5C06;&#x95EE;&#x9898;&#x6539;&#x4E3A;&#xFF1A;&#x5982;&#x4F55;&#x56F4;&#x7ED5;Spring&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#xFF0C;&#x5B9E;&#x73B0;&#x4E00;&#x5957;&#x914D;&#x7F6E;&#x7075;&#x6D3B;&#x3001;&#x7BA1;&#x7406;&#x7B80;&#x6D01;&#x3001;&#x503C;&#x70ED;&#x66F4;&#x65B0;&#x7684;&#x7CFB;&#x7EDF;&#x3002;</p></body></html>","more":"<p>确定我们必须结合Spring后，接下来需要明确的就是，如何实现配置的热更新。目前开源的配置中心有这么几种解决方案：</p>\n<p>方式|中间件|优点|缺点<br>|—|—|—|—|<br>|服务端调用客户端Api进行推送|无需|实现简单<br>无需引入第三方中间件|依赖Http请求过于重<br>自定义协议开发复杂<br>需要自己保证请求的可靠性 |<br>|客户端调用服务端Api进行拉取|无需|实现简单<br>无需引入第三方中间件|依赖Http请求过于重<br>自定义协议开发复杂<br>需要自己保证请求的可靠性 |<br>|依赖第三方中间件推送|Zookeeper、Redis、Nasco等|开发简单、不需要自己实现通讯<br>可依赖中间件自身的HA做高可用|增加了项目的复杂度<br>需要考虑中间件和当前项目的冲突问题|</p>\n<p>对比了市场上的设计和我们的自身的人力成本，我们决定引入一款成熟中间件来解决大部分的通讯和配置发现问题。这个时候摆在我们面前的可选项其实还是很有限的，能胜任我们的需求的无非就是Zk、redis、MQ这几个。</p>\n<p>这几个耳熟能详的中间件上来我们就放弃了zk，考虑主要有以下几点。</p>\n<ol>\n<li>zk不适合做大量数据的存储，特别是配置这种结构化的数据。虽然zk的CP特性能为我们带来精准的配置推送特性，但是遇到大量的配置内容zk就显得力不从心。</li>\n<li>zk的snapshot功能，一旦发现数据对其问题，需要停机人工处理。</li>\n<li>近年来zk在服务注册发现上大展拳脚，但我始终认为zk在作为注册中心时会显得捉襟见肘，元数据管理才是它真正运用的领域。这一点正好契合我们的契机，不过不巧的是我们想要开发的并不是一个分布式的配置中心，或者说分布式并不是我们的中心。反而分布式的配置管理才是我们最好的选择。</li>\n</ol>\n<p>剩下就是MQ和redis中做选择，他们两个就比较好抉择了。MQ和Redis都可以做到HA、变更的实时推送、但是MQ没法做到数据的管理。加上我们的系统里已近大量的使用到了redis，对redis的操作也比较熟悉。最终我们选择了redis作为中间件为我们的配置中心做配置的统一管理。</p>"},{"title":"我为什么会手撸一个配置中心--起源篇","date":"2020-03-19T14:16:13.000Z","_content":"\n## 聊聊后端的工作\n作为一个后端狗最怕的有几件事：\n1. 需求做也做不完就罢辽，隔三差五的业务同学还会跑来说“大锅，昨天上架的产品麻烦调整下文案”。。。\n2. 好不容易做完了需求并且熬到了上线，第二天产品过来说“老弟，那个需求被监管部门勒令下架了，能把那个功能下了不”。。。\n3. 代码敲的开心的时候，隔壁老大跑过来说“兄弟，之前那个XX报表不错啊，也定时发我一份”。。。\n<!-- more -->\n上面的场景大家认识我的不要对号入座哈，作为个后端狗，最怕的就是重复劳动。\n\n产品的文案、业务的开关、报表的收件人等等这些我们都可以叫做业务配置，一个合格的开发也能在需求设计阶段将这些配置从需求中提炼出来并进行配置化，方便日后的变更。\n那么，不是说配置能变更我们就没事了。\n\n首先，如果基于spring开发的小伙伴肯定会想到spring自带的配置文件。\n通过配置文件的隔离，我们完全能够隔离出dev、staging、prod甚至更多环境的配置。每当配置有变更我们只需要修改相应环境的配置，并重新部署就OK了。\n\n<font color=red >这样好吗？</font>答案是没什么不好。<font color=red >但是优雅吗？</font>那必须是挫的一塌糊涂。\n互联网的根基就是快速尝试、快速落地、反复尝试从而寻找到最优的解决方案。\n业务在不断的尝试过程中，或许会蹦出个大神拍着脑袋说“我觉得客户要的就是这个，这么那么做准没错”。但现实往往证明我们都是普通人，成为别人肚子里的蛔虫那是多么困难的一件事。\n所以需求的反反复复，代码的来来回回就是一个后端狗的日常。\n\n## 配置中心的出现\n那在这种快速变化的场景下，我们作为开发能做些什么呢？答案其实很简答，古人都说了“大道化简”，那自然是有变化我们就拥抱变化。\n但一个聪明或者说懒惰的程序员在拥抱变化的同时最重要的工作就是寻找那个不变。代码的抽象、业务的抽象时我们日后服务搭建的根基。自然我们上面说道的配置当然也是。\n\n聪明的程序员早就把这些繁杂的工作抽离了出来，配置中心而然而然的孕育出世。百度的Disconf、携程的Apollo、阿里的Nacos、Spring Cloud的Spring Cloud Config。\n后面我会专门聊聊这几个常见的配置中心的优劣。\n\n## 我为什么手撸个配置中心\n那还要回到1年前，我们公司最为创业公司，业务刚刚起步。为了快速的业务落地，我们也是能来什么就来什么，时间长了我们发现了一个很重要的问题：<font color=red >发版成分太高</font>。\n\n相信每个做开发的小伙伴都有体会，晚上发版是一件多么让人惆怅的事情啊。。。但更让人惆怅的是，本来只是一个小小的配置变更，却还要等到晚上才能重新上线，着实让人受不了。从那个时候开始，我们就打算引入配置中心了。\n\n首先调研配置中心的小伙伴经过几个现存开源系统的比较，最后选定了百度的Disconf。说上就上，Disconf就在我们的系统中愉快的奔跑起来了。\n\n1年过去了，系统越来越复杂，业务越来越繁琐，当初那个人见人爱的Disconf不时的变成了我们午饭时诟病的谈资。当然并不是Disconf本身不好，不过失去维护的社区本身也是它问题的一环。但最重要的一点是，Disconf本身已经慢慢不适合我们的业务了。可能会有些小伙伴说，那就使用更强大的Apollo，或者Nacos。Apollo本身固然强大，但一个第三方系统始终无法契合我们现在的业务场景，Nacos也有同样的问题，才外由于我们使用的是Spring Cloud的全家桶，若引入Nacos，必然需要升级到Alibaba Spring Cloud。想必风险和工作量只增无减。\n\n因此在这样的一个大前提下，我们冒出了“我什么不自己手撸个配置中心”的想法。\n\n## 配置中心 nadia-config\n自我打个广告，我的配置中心已经上线了，并且第一版也已经开源，欢迎大家拍砖 \n>https://github.com/nadia-repository/nadia-config\n\n","source":"_posts/我为什么会重新写一个配置中心-起源篇.md","raw":"---\ntitle: 我为什么会手撸一个配置中心--起源篇\ndate: 2020-03-19 22:16:13\ntags: \n    - Java\n    - Redis\n    - 配置中心\ncategories :\n    - Technology\n---\n\n## 聊聊后端的工作\n作为一个后端狗最怕的有几件事：\n1. 需求做也做不完就罢辽，隔三差五的业务同学还会跑来说“大锅，昨天上架的产品麻烦调整下文案”。。。\n2. 好不容易做完了需求并且熬到了上线，第二天产品过来说“老弟，那个需求被监管部门勒令下架了，能把那个功能下了不”。。。\n3. 代码敲的开心的时候，隔壁老大跑过来说“兄弟，之前那个XX报表不错啊，也定时发我一份”。。。\n<!-- more -->\n上面的场景大家认识我的不要对号入座哈，作为个后端狗，最怕的就是重复劳动。\n\n产品的文案、业务的开关、报表的收件人等等这些我们都可以叫做业务配置，一个合格的开发也能在需求设计阶段将这些配置从需求中提炼出来并进行配置化，方便日后的变更。\n那么，不是说配置能变更我们就没事了。\n\n首先，如果基于spring开发的小伙伴肯定会想到spring自带的配置文件。\n通过配置文件的隔离，我们完全能够隔离出dev、staging、prod甚至更多环境的配置。每当配置有变更我们只需要修改相应环境的配置，并重新部署就OK了。\n\n<font color=red >这样好吗？</font>答案是没什么不好。<font color=red >但是优雅吗？</font>那必须是挫的一塌糊涂。\n互联网的根基就是快速尝试、快速落地、反复尝试从而寻找到最优的解决方案。\n业务在不断的尝试过程中，或许会蹦出个大神拍着脑袋说“我觉得客户要的就是这个，这么那么做准没错”。但现实往往证明我们都是普通人，成为别人肚子里的蛔虫那是多么困难的一件事。\n所以需求的反反复复，代码的来来回回就是一个后端狗的日常。\n\n## 配置中心的出现\n那在这种快速变化的场景下，我们作为开发能做些什么呢？答案其实很简答，古人都说了“大道化简”，那自然是有变化我们就拥抱变化。\n但一个聪明或者说懒惰的程序员在拥抱变化的同时最重要的工作就是寻找那个不变。代码的抽象、业务的抽象时我们日后服务搭建的根基。自然我们上面说道的配置当然也是。\n\n聪明的程序员早就把这些繁杂的工作抽离了出来，配置中心而然而然的孕育出世。百度的Disconf、携程的Apollo、阿里的Nacos、Spring Cloud的Spring Cloud Config。\n后面我会专门聊聊这几个常见的配置中心的优劣。\n\n## 我为什么手撸个配置中心\n那还要回到1年前，我们公司最为创业公司，业务刚刚起步。为了快速的业务落地，我们也是能来什么就来什么，时间长了我们发现了一个很重要的问题：<font color=red >发版成分太高</font>。\n\n相信每个做开发的小伙伴都有体会，晚上发版是一件多么让人惆怅的事情啊。。。但更让人惆怅的是，本来只是一个小小的配置变更，却还要等到晚上才能重新上线，着实让人受不了。从那个时候开始，我们就打算引入配置中心了。\n\n首先调研配置中心的小伙伴经过几个现存开源系统的比较，最后选定了百度的Disconf。说上就上，Disconf就在我们的系统中愉快的奔跑起来了。\n\n1年过去了，系统越来越复杂，业务越来越繁琐，当初那个人见人爱的Disconf不时的变成了我们午饭时诟病的谈资。当然并不是Disconf本身不好，不过失去维护的社区本身也是它问题的一环。但最重要的一点是，Disconf本身已经慢慢不适合我们的业务了。可能会有些小伙伴说，那就使用更强大的Apollo，或者Nacos。Apollo本身固然强大，但一个第三方系统始终无法契合我们现在的业务场景，Nacos也有同样的问题，才外由于我们使用的是Spring Cloud的全家桶，若引入Nacos，必然需要升级到Alibaba Spring Cloud。想必风险和工作量只增无减。\n\n因此在这样的一个大前提下，我们冒出了“我什么不自己手撸个配置中心”的想法。\n\n## 配置中心 nadia-config\n自我打个广告，我的配置中心已经上线了，并且第一版也已经开源，欢迎大家拍砖 \n>https://github.com/nadia-repository/nadia-config\n\n","slug":"我为什么会重新写一个配置中心-起源篇","published":1,"updated":"2020-12-14T09:51:24.050Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71hto001dv2527yj851zv","content":"<html><head></head><body><h2 id=\"&#x804A;&#x804A;&#x540E;&#x7AEF;&#x7684;&#x5DE5;&#x4F5C;\"><a href=\"#&#x804A;&#x804A;&#x540E;&#x7AEF;&#x7684;&#x5DE5;&#x4F5C;\" class=\"headerlink\" title=\"&#x804A;&#x804A;&#x540E;&#x7AEF;&#x7684;&#x5DE5;&#x4F5C;\"></a>&#x804A;&#x804A;&#x540E;&#x7AEF;&#x7684;&#x5DE5;&#x4F5C;</h2><p>&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x540E;&#x7AEF;&#x72D7;&#x6700;&#x6015;&#x7684;&#x6709;&#x51E0;&#x4EF6;&#x4E8B;&#xFF1A;</p>\n<ol>\n<li>&#x9700;&#x6C42;&#x505A;&#x4E5F;&#x505A;&#x4E0D;&#x5B8C;&#x5C31;&#x7F62;&#x8FBD;&#xFF0C;&#x9694;&#x4E09;&#x5DEE;&#x4E94;&#x7684;&#x4E1A;&#x52A1;&#x540C;&#x5B66;&#x8FD8;&#x4F1A;&#x8DD1;&#x6765;&#x8BF4;&#x201C;&#x5927;&#x9505;&#xFF0C;&#x6628;&#x5929;&#x4E0A;&#x67B6;&#x7684;&#x4EA7;&#x54C1;&#x9EBB;&#x70E6;&#x8C03;&#x6574;&#x4E0B;&#x6587;&#x6848;&#x201D;&#x3002;&#x3002;&#x3002;</li>\n<li>&#x597D;&#x4E0D;&#x5BB9;&#x6613;&#x505A;&#x5B8C;&#x4E86;&#x9700;&#x6C42;&#x5E76;&#x4E14;&#x71AC;&#x5230;&#x4E86;&#x4E0A;&#x7EBF;&#xFF0C;&#x7B2C;&#x4E8C;&#x5929;&#x4EA7;&#x54C1;&#x8FC7;&#x6765;&#x8BF4;&#x201C;&#x8001;&#x5F1F;&#xFF0C;&#x90A3;&#x4E2A;&#x9700;&#x6C42;&#x88AB;&#x76D1;&#x7BA1;&#x90E8;&#x95E8;&#x52D2;&#x4EE4;&#x4E0B;&#x67B6;&#x4E86;&#xFF0C;&#x80FD;&#x628A;&#x90A3;&#x4E2A;&#x529F;&#x80FD;&#x4E0B;&#x4E86;&#x4E0D;&#x201D;&#x3002;&#x3002;&#x3002;</li>\n<li>&#x4EE3;&#x7801;&#x6572;&#x7684;&#x5F00;&#x5FC3;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x9694;&#x58C1;&#x8001;&#x5927;&#x8DD1;&#x8FC7;&#x6765;&#x8BF4;&#x201C;&#x5144;&#x5F1F;&#xFF0C;&#x4E4B;&#x524D;&#x90A3;&#x4E2A;XX&#x62A5;&#x8868;&#x4E0D;&#x9519;&#x554A;&#xFF0C;&#x4E5F;&#x5B9A;&#x65F6;&#x53D1;&#x6211;&#x4E00;&#x4EFD;&#x201D;&#x3002;&#x3002;&#x3002;<a id=\"more\"></a>\n&#x4E0A;&#x9762;&#x7684;&#x573A;&#x666F;&#x5927;&#x5BB6;&#x8BA4;&#x8BC6;&#x6211;&#x7684;&#x4E0D;&#x8981;&#x5BF9;&#x53F7;&#x5165;&#x5EA7;&#x54C8;&#xFF0C;&#x4F5C;&#x4E3A;&#x4E2A;&#x540E;&#x7AEF;&#x72D7;&#xFF0C;&#x6700;&#x6015;&#x7684;&#x5C31;&#x662F;&#x91CD;&#x590D;&#x52B3;&#x52A8;&#x3002;</li>\n</ol>\n<p>&#x4EA7;&#x54C1;&#x7684;&#x6587;&#x6848;&#x3001;&#x4E1A;&#x52A1;&#x7684;&#x5F00;&#x5173;&#x3001;&#x62A5;&#x8868;&#x7684;&#x6536;&#x4EF6;&#x4EBA;&#x7B49;&#x7B49;&#x8FD9;&#x4E9B;&#x6211;&#x4EEC;&#x90FD;&#x53EF;&#x4EE5;&#x53EB;&#x505A;&#x4E1A;&#x52A1;&#x914D;&#x7F6E;&#xFF0C;&#x4E00;&#x4E2A;&#x5408;&#x683C;&#x7684;&#x5F00;&#x53D1;&#x4E5F;&#x80FD;&#x5728;&#x9700;&#x6C42;&#x8BBE;&#x8BA1;&#x9636;&#x6BB5;&#x5C06;&#x8FD9;&#x4E9B;&#x914D;&#x7F6E;&#x4ECE;&#x9700;&#x6C42;&#x4E2D;&#x63D0;&#x70BC;&#x51FA;&#x6765;&#x5E76;&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x5316;&#xFF0C;&#x65B9;&#x4FBF;&#x65E5;&#x540E;&#x7684;&#x53D8;&#x66F4;&#x3002;<br>&#x90A3;&#x4E48;&#xFF0C;&#x4E0D;&#x662F;&#x8BF4;&#x914D;&#x7F6E;&#x80FD;&#x53D8;&#x66F4;&#x6211;&#x4EEC;&#x5C31;&#x6CA1;&#x4E8B;&#x4E86;&#x3002;</p>\n<p>&#x9996;&#x5148;&#xFF0C;&#x5982;&#x679C;&#x57FA;&#x4E8E;spring&#x5F00;&#x53D1;&#x7684;&#x5C0F;&#x4F19;&#x4F34;&#x80AF;&#x5B9A;&#x4F1A;&#x60F3;&#x5230;spring&#x81EA;&#x5E26;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;<br>&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x9694;&#x79BB;&#xFF0C;&#x6211;&#x4EEC;&#x5B8C;&#x5168;&#x80FD;&#x591F;&#x9694;&#x79BB;&#x51FA;dev&#x3001;staging&#x3001;prod&#x751A;&#x81F3;&#x66F4;&#x591A;&#x73AF;&#x5883;&#x7684;&#x914D;&#x7F6E;&#x3002;&#x6BCF;&#x5F53;&#x914D;&#x7F6E;&#x6709;&#x53D8;&#x66F4;&#x6211;&#x4EEC;&#x53EA;&#x9700;&#x8981;&#x4FEE;&#x6539;&#x76F8;&#x5E94;&#x73AF;&#x5883;&#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x5E76;&#x91CD;&#x65B0;&#x90E8;&#x7F72;&#x5C31;OK&#x4E86;&#x3002;</p>\n<p><font color=\"red\">&#x8FD9;&#x6837;&#x597D;&#x5417;&#xFF1F;</font>&#x7B54;&#x6848;&#x662F;&#x6CA1;&#x4EC0;&#x4E48;&#x4E0D;&#x597D;&#x3002;<font color=\"red\">&#x4F46;&#x662F;&#x4F18;&#x96C5;&#x5417;&#xFF1F;</font>&#x90A3;&#x5FC5;&#x987B;&#x662F;&#x632B;&#x7684;&#x4E00;&#x584C;&#x7CCA;&#x6D82;&#x3002;<br>&#x4E92;&#x8054;&#x7F51;&#x7684;&#x6839;&#x57FA;&#x5C31;&#x662F;&#x5FEB;&#x901F;&#x5C1D;&#x8BD5;&#x3001;&#x5FEB;&#x901F;&#x843D;&#x5730;&#x3001;&#x53CD;&#x590D;&#x5C1D;&#x8BD5;&#x4ECE;&#x800C;&#x5BFB;&#x627E;&#x5230;&#x6700;&#x4F18;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x3002;<br>&#x4E1A;&#x52A1;&#x5728;&#x4E0D;&#x65AD;&#x7684;&#x5C1D;&#x8BD5;&#x8FC7;&#x7A0B;&#x4E2D;&#xFF0C;&#x6216;&#x8BB8;&#x4F1A;&#x8E66;&#x51FA;&#x4E2A;&#x5927;&#x795E;&#x62CD;&#x7740;&#x8111;&#x888B;&#x8BF4;&#x201C;&#x6211;&#x89C9;&#x5F97;&#x5BA2;&#x6237;&#x8981;&#x7684;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#xFF0C;&#x8FD9;&#x4E48;&#x90A3;&#x4E48;&#x505A;&#x51C6;&#x6CA1;&#x9519;&#x201D;&#x3002;&#x4F46;&#x73B0;&#x5B9E;&#x5F80;&#x5F80;&#x8BC1;&#x660E;&#x6211;&#x4EEC;&#x90FD;&#x662F;&#x666E;&#x901A;&#x4EBA;&#xFF0C;&#x6210;&#x4E3A;&#x522B;&#x4EBA;&#x809A;&#x5B50;&#x91CC;&#x7684;&#x86D4;&#x866B;&#x90A3;&#x662F;&#x591A;&#x4E48;&#x56F0;&#x96BE;&#x7684;&#x4E00;&#x4EF6;&#x4E8B;&#x3002;<br>&#x6240;&#x4EE5;&#x9700;&#x6C42;&#x7684;&#x53CD;&#x53CD;&#x590D;&#x590D;&#xFF0C;&#x4EE3;&#x7801;&#x7684;&#x6765;&#x6765;&#x56DE;&#x56DE;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x540E;&#x7AEF;&#x72D7;&#x7684;&#x65E5;&#x5E38;&#x3002;</p>\n<h2 id=\"&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x51FA;&#x73B0;\"><a href=\"#&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x51FA;&#x73B0;\" class=\"headerlink\" title=\"&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x51FA;&#x73B0;\"></a>&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x51FA;&#x73B0;</h2><p>&#x90A3;&#x5728;&#x8FD9;&#x79CD;&#x5FEB;&#x901F;&#x53D8;&#x5316;&#x7684;&#x573A;&#x666F;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x4F5C;&#x4E3A;&#x5F00;&#x53D1;&#x80FD;&#x505A;&#x4E9B;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;&#x7B54;&#x6848;&#x5176;&#x5B9E;&#x5F88;&#x7B80;&#x7B54;&#xFF0C;&#x53E4;&#x4EBA;&#x90FD;&#x8BF4;&#x4E86;&#x201C;&#x5927;&#x9053;&#x5316;&#x7B80;&#x201D;&#xFF0C;&#x90A3;&#x81EA;&#x7136;&#x662F;&#x6709;&#x53D8;&#x5316;&#x6211;&#x4EEC;&#x5C31;&#x62E5;&#x62B1;&#x53D8;&#x5316;&#x3002;<br>&#x4F46;&#x4E00;&#x4E2A;&#x806A;&#x660E;&#x6216;&#x8005;&#x8BF4;&#x61D2;&#x60F0;&#x7684;&#x7A0B;&#x5E8F;&#x5458;&#x5728;&#x62E5;&#x62B1;&#x53D8;&#x5316;&#x7684;&#x540C;&#x65F6;&#x6700;&#x91CD;&#x8981;&#x7684;&#x5DE5;&#x4F5C;&#x5C31;&#x662F;&#x5BFB;&#x627E;&#x90A3;&#x4E2A;&#x4E0D;&#x53D8;&#x3002;&#x4EE3;&#x7801;&#x7684;&#x62BD;&#x8C61;&#x3001;&#x4E1A;&#x52A1;&#x7684;&#x62BD;&#x8C61;&#x65F6;&#x6211;&#x4EEC;&#x65E5;&#x540E;&#x670D;&#x52A1;&#x642D;&#x5EFA;&#x7684;&#x6839;&#x57FA;&#x3002;&#x81EA;&#x7136;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x8BF4;&#x9053;&#x7684;&#x914D;&#x7F6E;&#x5F53;&#x7136;&#x4E5F;&#x662F;&#x3002;</p>\n<p>&#x806A;&#x660E;&#x7684;&#x7A0B;&#x5E8F;&#x5458;&#x65E9;&#x5C31;&#x628A;&#x8FD9;&#x4E9B;&#x7E41;&#x6742;&#x7684;&#x5DE5;&#x4F5C;&#x62BD;&#x79BB;&#x4E86;&#x51FA;&#x6765;&#xFF0C;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x800C;&#x7136;&#x800C;&#x7136;&#x7684;&#x5B55;&#x80B2;&#x51FA;&#x4E16;&#x3002;&#x767E;&#x5EA6;&#x7684;Disconf&#x3001;&#x643A;&#x7A0B;&#x7684;Apollo&#x3001;&#x963F;&#x91CC;&#x7684;Nacos&#x3001;Spring Cloud&#x7684;Spring Cloud Config&#x3002;<br>&#x540E;&#x9762;&#x6211;&#x4F1A;&#x4E13;&#x95E8;&#x804A;&#x804A;&#x8FD9;&#x51E0;&#x4E2A;&#x5E38;&#x89C1;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x4F18;&#x52A3;&#x3002;</p>\n<h2 id=\"&#x6211;&#x4E3A;&#x4EC0;&#x4E48;&#x624B;&#x64B8;&#x4E2A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;\"><a href=\"#&#x6211;&#x4E3A;&#x4EC0;&#x4E48;&#x624B;&#x64B8;&#x4E2A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;\" class=\"headerlink\" title=\"&#x6211;&#x4E3A;&#x4EC0;&#x4E48;&#x624B;&#x64B8;&#x4E2A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;\"></a>&#x6211;&#x4E3A;&#x4EC0;&#x4E48;&#x624B;&#x64B8;&#x4E2A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;</h2><p>&#x90A3;&#x8FD8;&#x8981;&#x56DE;&#x5230;1&#x5E74;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x516C;&#x53F8;&#x6700;&#x4E3A;&#x521B;&#x4E1A;&#x516C;&#x53F8;&#xFF0C;&#x4E1A;&#x52A1;&#x521A;&#x521A;&#x8D77;&#x6B65;&#x3002;&#x4E3A;&#x4E86;&#x5FEB;&#x901F;&#x7684;&#x4E1A;&#x52A1;&#x843D;&#x5730;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x662F;&#x80FD;&#x6765;&#x4EC0;&#x4E48;&#x5C31;&#x6765;&#x4EC0;&#x4E48;&#xFF0C;&#x65F6;&#x95F4;&#x957F;&#x4E86;&#x6211;&#x4EEC;&#x53D1;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x5F88;&#x91CD;&#x8981;&#x7684;&#x95EE;&#x9898;&#xFF1A;<font color=\"red\">&#x53D1;&#x7248;&#x6210;&#x5206;&#x592A;&#x9AD8;</font>&#x3002;</p>\n<p>&#x76F8;&#x4FE1;&#x6BCF;&#x4E2A;&#x505A;&#x5F00;&#x53D1;&#x7684;&#x5C0F;&#x4F19;&#x4F34;&#x90FD;&#x6709;&#x4F53;&#x4F1A;&#xFF0C;&#x665A;&#x4E0A;&#x53D1;&#x7248;&#x662F;&#x4E00;&#x4EF6;&#x591A;&#x4E48;&#x8BA9;&#x4EBA;&#x60C6;&#x6005;&#x7684;&#x4E8B;&#x60C5;&#x554A;&#x3002;&#x3002;&#x3002;&#x4F46;&#x66F4;&#x8BA9;&#x4EBA;&#x60C6;&#x6005;&#x7684;&#x662F;&#xFF0C;&#x672C;&#x6765;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x5C0F;&#x5C0F;&#x7684;&#x914D;&#x7F6E;&#x53D8;&#x66F4;&#xFF0C;&#x5374;&#x8FD8;&#x8981;&#x7B49;&#x5230;&#x665A;&#x4E0A;&#x624D;&#x80FD;&#x91CD;&#x65B0;&#x4E0A;&#x7EBF;&#xFF0C;&#x7740;&#x5B9E;&#x8BA9;&#x4EBA;&#x53D7;&#x4E0D;&#x4E86;&#x3002;&#x4ECE;&#x90A3;&#x4E2A;&#x65F6;&#x5019;&#x5F00;&#x59CB;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x6253;&#x7B97;&#x5F15;&#x5165;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x4E86;&#x3002;</p>\n<p>&#x9996;&#x5148;&#x8C03;&#x7814;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x5C0F;&#x4F19;&#x4F34;&#x7ECF;&#x8FC7;&#x51E0;&#x4E2A;&#x73B0;&#x5B58;&#x5F00;&#x6E90;&#x7CFB;&#x7EDF;&#x7684;&#x6BD4;&#x8F83;&#xFF0C;&#x6700;&#x540E;&#x9009;&#x5B9A;&#x4E86;&#x767E;&#x5EA6;&#x7684;Disconf&#x3002;&#x8BF4;&#x4E0A;&#x5C31;&#x4E0A;&#xFF0C;Disconf&#x5C31;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x7CFB;&#x7EDF;&#x4E2D;&#x6109;&#x5FEB;&#x7684;&#x5954;&#x8DD1;&#x8D77;&#x6765;&#x4E86;&#x3002;</p>\n<p>1&#x5E74;&#x8FC7;&#x53BB;&#x4E86;&#xFF0C;&#x7CFB;&#x7EDF;&#x8D8A;&#x6765;&#x8D8A;&#x590D;&#x6742;&#xFF0C;&#x4E1A;&#x52A1;&#x8D8A;&#x6765;&#x8D8A;&#x7E41;&#x7410;&#xFF0C;&#x5F53;&#x521D;&#x90A3;&#x4E2A;&#x4EBA;&#x89C1;&#x4EBA;&#x7231;&#x7684;Disconf&#x4E0D;&#x65F6;&#x7684;&#x53D8;&#x6210;&#x4E86;&#x6211;&#x4EEC;&#x5348;&#x996D;&#x65F6;&#x8BDF;&#x75C5;&#x7684;&#x8C08;&#x8D44;&#x3002;&#x5F53;&#x7136;&#x5E76;&#x4E0D;&#x662F;Disconf&#x672C;&#x8EAB;&#x4E0D;&#x597D;&#xFF0C;&#x4E0D;&#x8FC7;&#x5931;&#x53BB;&#x7EF4;&#x62A4;&#x7684;&#x793E;&#x533A;&#x672C;&#x8EAB;&#x4E5F;&#x662F;&#x5B83;&#x95EE;&#x9898;&#x7684;&#x4E00;&#x73AF;&#x3002;&#x4F46;&#x6700;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x70B9;&#x662F;&#xFF0C;Disconf&#x672C;&#x8EAB;&#x5DF2;&#x7ECF;&#x6162;&#x6162;&#x4E0D;&#x9002;&#x5408;&#x6211;&#x4EEC;&#x7684;&#x4E1A;&#x52A1;&#x4E86;&#x3002;&#x53EF;&#x80FD;&#x4F1A;&#x6709;&#x4E9B;&#x5C0F;&#x4F19;&#x4F34;&#x8BF4;&#xFF0C;&#x90A3;&#x5C31;&#x4F7F;&#x7528;&#x66F4;&#x5F3A;&#x5927;&#x7684;Apollo&#xFF0C;&#x6216;&#x8005;Nacos&#x3002;Apollo&#x672C;&#x8EAB;&#x56FA;&#x7136;&#x5F3A;&#x5927;&#xFF0C;&#x4F46;&#x4E00;&#x4E2A;&#x7B2C;&#x4E09;&#x65B9;&#x7CFB;&#x7EDF;&#x59CB;&#x7EC8;&#x65E0;&#x6CD5;&#x5951;&#x5408;&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x7684;&#x4E1A;&#x52A1;&#x573A;&#x666F;&#xFF0C;Nacos&#x4E5F;&#x6709;&#x540C;&#x6837;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x624D;&#x5916;&#x7531;&#x4E8E;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#x7684;&#x662F;Spring Cloud&#x7684;&#x5168;&#x5BB6;&#x6876;&#xFF0C;&#x82E5;&#x5F15;&#x5165;Nacos&#xFF0C;&#x5FC5;&#x7136;&#x9700;&#x8981;&#x5347;&#x7EA7;&#x5230;Alibaba Spring Cloud&#x3002;&#x60F3;&#x5FC5;&#x98CE;&#x9669;&#x548C;&#x5DE5;&#x4F5C;&#x91CF;&#x53EA;&#x589E;&#x65E0;&#x51CF;&#x3002;</p>\n<p>&#x56E0;&#x6B64;&#x5728;&#x8FD9;&#x6837;&#x7684;&#x4E00;&#x4E2A;&#x5927;&#x524D;&#x63D0;&#x4E0B;&#xFF0C;&#x6211;&#x4EEC;&#x5192;&#x51FA;&#x4E86;&#x201C;&#x6211;&#x4EC0;&#x4E48;&#x4E0D;&#x81EA;&#x5DF1;&#x624B;&#x64B8;&#x4E2A;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x201D;&#x7684;&#x60F3;&#x6CD5;&#x3002;</p>\n<h2 id=\"&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;-nadia-config\"><a href=\"#&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;-nadia-config\" class=\"headerlink\" title=\"&#x914D;&#x7F6E;&#x4E2D;&#x5FC3; nadia-config\"></a>&#x914D;&#x7F6E;&#x4E2D;&#x5FC3; nadia-config</h2><p>&#x81EA;&#x6211;&#x6253;&#x4E2A;&#x5E7F;&#x544A;&#xFF0C;&#x6211;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5DF2;&#x7ECF;&#x4E0A;&#x7EBF;&#x4E86;&#xFF0C;&#x5E76;&#x4E14;&#x7B2C;&#x4E00;&#x7248;&#x4E5F;&#x5DF2;&#x7ECF;&#x5F00;&#x6E90;&#xFF0C;&#x6B22;&#x8FCE;&#x5927;&#x5BB6;&#x62CD;&#x7816; </p>\n<blockquote>\n<p><a href=\"https://github.com/nadia-repository/nadia-config\">https://github.com/nadia-repository/nadia-config</a></p>\n</blockquote>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Redis","path":"tags/Redis/"},{"name":"配置中心","path":"tags/配置中心/"}],"excerpt":"<html><head></head><body><h2 id=\"&#x804A;&#x804A;&#x540E;&#x7AEF;&#x7684;&#x5DE5;&#x4F5C;\"><a href=\"#&#x804A;&#x804A;&#x540E;&#x7AEF;&#x7684;&#x5DE5;&#x4F5C;\" class=\"headerlink\" title=\"&#x804A;&#x804A;&#x540E;&#x7AEF;&#x7684;&#x5DE5;&#x4F5C;\"></a>&#x804A;&#x804A;&#x540E;&#x7AEF;&#x7684;&#x5DE5;&#x4F5C;</h2><p>&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x540E;&#x7AEF;&#x72D7;&#x6700;&#x6015;&#x7684;&#x6709;&#x51E0;&#x4EF6;&#x4E8B;&#xFF1A;</p>\n<ol>\n<li>&#x9700;&#x6C42;&#x505A;&#x4E5F;&#x505A;&#x4E0D;&#x5B8C;&#x5C31;&#x7F62;&#x8FBD;&#xFF0C;&#x9694;&#x4E09;&#x5DEE;&#x4E94;&#x7684;&#x4E1A;&#x52A1;&#x540C;&#x5B66;&#x8FD8;&#x4F1A;&#x8DD1;&#x6765;&#x8BF4;&#x201C;&#x5927;&#x9505;&#xFF0C;&#x6628;&#x5929;&#x4E0A;&#x67B6;&#x7684;&#x4EA7;&#x54C1;&#x9EBB;&#x70E6;&#x8C03;&#x6574;&#x4E0B;&#x6587;&#x6848;&#x201D;&#x3002;&#x3002;&#x3002;</li>\n<li>&#x597D;&#x4E0D;&#x5BB9;&#x6613;&#x505A;&#x5B8C;&#x4E86;&#x9700;&#x6C42;&#x5E76;&#x4E14;&#x71AC;&#x5230;&#x4E86;&#x4E0A;&#x7EBF;&#xFF0C;&#x7B2C;&#x4E8C;&#x5929;&#x4EA7;&#x54C1;&#x8FC7;&#x6765;&#x8BF4;&#x201C;&#x8001;&#x5F1F;&#xFF0C;&#x90A3;&#x4E2A;&#x9700;&#x6C42;&#x88AB;&#x76D1;&#x7BA1;&#x90E8;&#x95E8;&#x52D2;&#x4EE4;&#x4E0B;&#x67B6;&#x4E86;&#xFF0C;&#x80FD;&#x628A;&#x90A3;&#x4E2A;&#x529F;&#x80FD;&#x4E0B;&#x4E86;&#x4E0D;&#x201D;&#x3002;&#x3002;&#x3002;</li>\n<li>&#x4EE3;&#x7801;&#x6572;&#x7684;&#x5F00;&#x5FC3;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x9694;&#x58C1;&#x8001;&#x5927;&#x8DD1;&#x8FC7;&#x6765;&#x8BF4;&#x201C;&#x5144;&#x5F1F;&#xFF0C;&#x4E4B;&#x524D;&#x90A3;&#x4E2A;XX&#x62A5;&#x8868;&#x4E0D;&#x9519;&#x554A;&#xFF0C;&#x4E5F;&#x5B9A;&#x65F6;&#x53D1;&#x6211;&#x4E00;&#x4EFD;&#x201D;&#x3002;&#x3002;&#x3002;</li></ol></body></html>","more":"上面的场景大家认识我的不要对号入座哈，作为个后端狗，最怕的就是重复劳动。\n\n<p>产品的文案、业务的开关、报表的收件人等等这些我们都可以叫做业务配置，一个合格的开发也能在需求设计阶段将这些配置从需求中提炼出来并进行配置化，方便日后的变更。<br>那么，不是说配置能变更我们就没事了。</p>\n<p>首先，如果基于spring开发的小伙伴肯定会想到spring自带的配置文件。<br>通过配置文件的隔离，我们完全能够隔离出dev、staging、prod甚至更多环境的配置。每当配置有变更我们只需要修改相应环境的配置，并重新部署就OK了。</p>\n<p><font color=\"red\">这样好吗？</font>答案是没什么不好。<font color=\"red\">但是优雅吗？</font>那必须是挫的一塌糊涂。<br>互联网的根基就是快速尝试、快速落地、反复尝试从而寻找到最优的解决方案。<br>业务在不断的尝试过程中，或许会蹦出个大神拍着脑袋说“我觉得客户要的就是这个，这么那么做准没错”。但现实往往证明我们都是普通人，成为别人肚子里的蛔虫那是多么困难的一件事。<br>所以需求的反反复复，代码的来来回回就是一个后端狗的日常。</p>\n<h2 id=\"配置中心的出现\"><a href=\"#配置中心的出现\" class=\"headerlink\" title=\"配置中心的出现\"></a>配置中心的出现</h2><p>那在这种快速变化的场景下，我们作为开发能做些什么呢？答案其实很简答，古人都说了“大道化简”，那自然是有变化我们就拥抱变化。<br>但一个聪明或者说懒惰的程序员在拥抱变化的同时最重要的工作就是寻找那个不变。代码的抽象、业务的抽象时我们日后服务搭建的根基。自然我们上面说道的配置当然也是。</p>\n<p>聪明的程序员早就把这些繁杂的工作抽离了出来，配置中心而然而然的孕育出世。百度的Disconf、携程的Apollo、阿里的Nacos、Spring Cloud的Spring Cloud Config。<br>后面我会专门聊聊这几个常见的配置中心的优劣。</p>\n<h2 id=\"我为什么手撸个配置中心\"><a href=\"#我为什么手撸个配置中心\" class=\"headerlink\" title=\"我为什么手撸个配置中心\"></a>我为什么手撸个配置中心</h2><p>那还要回到1年前，我们公司最为创业公司，业务刚刚起步。为了快速的业务落地，我们也是能来什么就来什么，时间长了我们发现了一个很重要的问题：<font color=\"red\">发版成分太高</font>。</p>\n<p>相信每个做开发的小伙伴都有体会，晚上发版是一件多么让人惆怅的事情啊。。。但更让人惆怅的是，本来只是一个小小的配置变更，却还要等到晚上才能重新上线，着实让人受不了。从那个时候开始，我们就打算引入配置中心了。</p>\n<p>首先调研配置中心的小伙伴经过几个现存开源系统的比较，最后选定了百度的Disconf。说上就上，Disconf就在我们的系统中愉快的奔跑起来了。</p>\n<p>1年过去了，系统越来越复杂，业务越来越繁琐，当初那个人见人爱的Disconf不时的变成了我们午饭时诟病的谈资。当然并不是Disconf本身不好，不过失去维护的社区本身也是它问题的一环。但最重要的一点是，Disconf本身已经慢慢不适合我们的业务了。可能会有些小伙伴说，那就使用更强大的Apollo，或者Nacos。Apollo本身固然强大，但一个第三方系统始终无法契合我们现在的业务场景，Nacos也有同样的问题，才外由于我们使用的是Spring Cloud的全家桶，若引入Nacos，必然需要升级到Alibaba Spring Cloud。想必风险和工作量只增无减。</p>\n<p>因此在这样的一个大前提下，我们冒出了“我什么不自己手撸个配置中心”的想法。</p>\n<h2 id=\"配置中心-nadia-config\"><a href=\"#配置中心-nadia-config\" class=\"headerlink\" title=\"配置中心 nadia-config\"></a>配置中心 nadia-config</h2><p>自我打个广告，我的配置中心已经上线了，并且第一版也已经开源，欢迎大家拍砖 </p>\n<blockquote>\n<p><a href=\"https://github.com/nadia-repository/nadia-config\">https://github.com/nadia-repository/nadia-config</a></p>\n</blockquote>"},{"title":"搜寻流浪狗APP???","date":"2019-09-06T15:41:32.000Z","_content":"\n## 中国AI公司开发了用鼻纹搜索流浪狗的APP\n\n\n如果瞥到流浪狗的海报一定要看看。\n\n随着一个个寒冷的日子，又要到烟花大会的季节。也是家犬被鞭炮声吓跑的季节。\n<!-- more -->\n最近家里养狗的越来越多，蹭着窗门开着主人一不留神逃跑的也不在少数，我家的爱犬就是在这个季节逃跑的。\n\n爱犬走丢时一般来说就是张贴寻狗海报或者各处打听。但是中国的一家叫Megvii（旷世）的AI公司可不一样。\n\n根据Verge报道，该公司正在开发一种像人类指纹一样识别狗鼻子形状的【狗识别系统】。使用旷世的APP，通过手机摄像头多角度拍摄狗鼻子就能登录完成。并称具有95%的精度，因此通过这个APP，有1万5000条宠物犬能再和它的主人再会。\n\n但是在中国不是用在和主人的再会，而是和政府合作规范不良狗主人的行为。\n\n具体怎样监视还不清楚，可能是宠物第一次进入家庭的时候登录吧。然后如果想搜寻有问题的狗主人，需要工作人员当场扫描狗鼻子从而鉴别狗主人？\n\n就我的话还是希望能得到随地大小便的狗狗的主人信息，毕竟家门口落下的便便。。。。。。\n\n\n\n{% blockquote 中川真知子 https://www.gizmodo.jp/2019/07/ai-start-up-dog-nose.html 中国のAIスタートアップが迷い犬を鼻の指紋（？）を使って捜索するアプリを開発 %}\n本文译自\n{% endblockquote %}","source":"_posts/搜寻流浪狗APP.md","raw":"---\ntitle: 搜寻流浪狗APP???\ndate: 2019-09-06 23:41:32\ntags: \n    - AI\n    - APP\ncategories:\n    - Translation\n---\n\n## 中国AI公司开发了用鼻纹搜索流浪狗的APP\n\n\n如果瞥到流浪狗的海报一定要看看。\n\n随着一个个寒冷的日子，又要到烟花大会的季节。也是家犬被鞭炮声吓跑的季节。\n<!-- more -->\n最近家里养狗的越来越多，蹭着窗门开着主人一不留神逃跑的也不在少数，我家的爱犬就是在这个季节逃跑的。\n\n爱犬走丢时一般来说就是张贴寻狗海报或者各处打听。但是中国的一家叫Megvii（旷世）的AI公司可不一样。\n\n根据Verge报道，该公司正在开发一种像人类指纹一样识别狗鼻子形状的【狗识别系统】。使用旷世的APP，通过手机摄像头多角度拍摄狗鼻子就能登录完成。并称具有95%的精度，因此通过这个APP，有1万5000条宠物犬能再和它的主人再会。\n\n但是在中国不是用在和主人的再会，而是和政府合作规范不良狗主人的行为。\n\n具体怎样监视还不清楚，可能是宠物第一次进入家庭的时候登录吧。然后如果想搜寻有问题的狗主人，需要工作人员当场扫描狗鼻子从而鉴别狗主人？\n\n就我的话还是希望能得到随地大小便的狗狗的主人信息，毕竟家门口落下的便便。。。。。。\n\n\n\n{% blockquote 中川真知子 https://www.gizmodo.jp/2019/07/ai-start-up-dog-nose.html 中国のAIスタートアップが迷い犬を鼻の指紋（？）を使って捜索するアプリを開発 %}\n本文译自\n{% endblockquote %}","slug":"搜寻流浪狗APP","published":1,"updated":"2020-12-14T09:51:24.050Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htp001gv252ehia4tyn","content":"<html><head></head><body><h2 id=\"&#x4E2D;&#x56FD;AI&#x516C;&#x53F8;&#x5F00;&#x53D1;&#x4E86;&#x7528;&#x9F3B;&#x7EB9;&#x641C;&#x7D22;&#x6D41;&#x6D6A;&#x72D7;&#x7684;APP\"><a href=\"#&#x4E2D;&#x56FD;AI&#x516C;&#x53F8;&#x5F00;&#x53D1;&#x4E86;&#x7528;&#x9F3B;&#x7EB9;&#x641C;&#x7D22;&#x6D41;&#x6D6A;&#x72D7;&#x7684;APP\" class=\"headerlink\" title=\"&#x4E2D;&#x56FD;AI&#x516C;&#x53F8;&#x5F00;&#x53D1;&#x4E86;&#x7528;&#x9F3B;&#x7EB9;&#x641C;&#x7D22;&#x6D41;&#x6D6A;&#x72D7;&#x7684;APP\"></a>&#x4E2D;&#x56FD;AI&#x516C;&#x53F8;&#x5F00;&#x53D1;&#x4E86;&#x7528;&#x9F3B;&#x7EB9;&#x641C;&#x7D22;&#x6D41;&#x6D6A;&#x72D7;&#x7684;APP</h2><p>&#x5982;&#x679C;&#x77A5;&#x5230;&#x6D41;&#x6D6A;&#x72D7;&#x7684;&#x6D77;&#x62A5;&#x4E00;&#x5B9A;&#x8981;&#x770B;&#x770B;&#x3002;</p>\n<p>&#x968F;&#x7740;&#x4E00;&#x4E2A;&#x4E2A;&#x5BD2;&#x51B7;&#x7684;&#x65E5;&#x5B50;&#xFF0C;&#x53C8;&#x8981;&#x5230;&#x70DF;&#x82B1;&#x5927;&#x4F1A;&#x7684;&#x5B63;&#x8282;&#x3002;&#x4E5F;&#x662F;&#x5BB6;&#x72AC;&#x88AB;&#x97AD;&#x70AE;&#x58F0;&#x5413;&#x8DD1;&#x7684;&#x5B63;&#x8282;&#x3002;</p>\n<a id=\"more\"></a>\n<p>&#x6700;&#x8FD1;&#x5BB6;&#x91CC;&#x517B;&#x72D7;&#x7684;&#x8D8A;&#x6765;&#x8D8A;&#x591A;&#xFF0C;&#x8E6D;&#x7740;&#x7A97;&#x95E8;&#x5F00;&#x7740;&#x4E3B;&#x4EBA;&#x4E00;&#x4E0D;&#x7559;&#x795E;&#x9003;&#x8DD1;&#x7684;&#x4E5F;&#x4E0D;&#x5728;&#x5C11;&#x6570;&#xFF0C;&#x6211;&#x5BB6;&#x7684;&#x7231;&#x72AC;&#x5C31;&#x662F;&#x5728;&#x8FD9;&#x4E2A;&#x5B63;&#x8282;&#x9003;&#x8DD1;&#x7684;&#x3002;</p>\n<p>&#x7231;&#x72AC;&#x8D70;&#x4E22;&#x65F6;&#x4E00;&#x822C;&#x6765;&#x8BF4;&#x5C31;&#x662F;&#x5F20;&#x8D34;&#x5BFB;&#x72D7;&#x6D77;&#x62A5;&#x6216;&#x8005;&#x5404;&#x5904;&#x6253;&#x542C;&#x3002;&#x4F46;&#x662F;&#x4E2D;&#x56FD;&#x7684;&#x4E00;&#x5BB6;&#x53EB;Megvii&#xFF08;&#x65F7;&#x4E16;&#xFF09;&#x7684;AI&#x516C;&#x53F8;&#x53EF;&#x4E0D;&#x4E00;&#x6837;&#x3002;</p>\n<p>&#x6839;&#x636E;Verge&#x62A5;&#x9053;&#xFF0C;&#x8BE5;&#x516C;&#x53F8;&#x6B63;&#x5728;&#x5F00;&#x53D1;&#x4E00;&#x79CD;&#x50CF;&#x4EBA;&#x7C7B;&#x6307;&#x7EB9;&#x4E00;&#x6837;&#x8BC6;&#x522B;&#x72D7;&#x9F3B;&#x5B50;&#x5F62;&#x72B6;&#x7684;&#x3010;&#x72D7;&#x8BC6;&#x522B;&#x7CFB;&#x7EDF;&#x3011;&#x3002;&#x4F7F;&#x7528;&#x65F7;&#x4E16;&#x7684;APP&#xFF0C;&#x901A;&#x8FC7;&#x624B;&#x673A;&#x6444;&#x50CF;&#x5934;&#x591A;&#x89D2;&#x5EA6;&#x62CD;&#x6444;&#x72D7;&#x9F3B;&#x5B50;&#x5C31;&#x80FD;&#x767B;&#x5F55;&#x5B8C;&#x6210;&#x3002;&#x5E76;&#x79F0;&#x5177;&#x6709;95%&#x7684;&#x7CBE;&#x5EA6;&#xFF0C;&#x56E0;&#x6B64;&#x901A;&#x8FC7;&#x8FD9;&#x4E2A;APP&#xFF0C;&#x6709;1&#x4E07;5000&#x6761;&#x5BA0;&#x7269;&#x72AC;&#x80FD;&#x518D;&#x548C;&#x5B83;&#x7684;&#x4E3B;&#x4EBA;&#x518D;&#x4F1A;&#x3002;</p>\n<p>&#x4F46;&#x662F;&#x5728;&#x4E2D;&#x56FD;&#x4E0D;&#x662F;&#x7528;&#x5728;&#x548C;&#x4E3B;&#x4EBA;&#x7684;&#x518D;&#x4F1A;&#xFF0C;&#x800C;&#x662F;&#x548C;&#x653F;&#x5E9C;&#x5408;&#x4F5C;&#x89C4;&#x8303;&#x4E0D;&#x826F;&#x72D7;&#x4E3B;&#x4EBA;&#x7684;&#x884C;&#x4E3A;&#x3002;</p>\n<p>&#x5177;&#x4F53;&#x600E;&#x6837;&#x76D1;&#x89C6;&#x8FD8;&#x4E0D;&#x6E05;&#x695A;&#xFF0C;&#x53EF;&#x80FD;&#x662F;&#x5BA0;&#x7269;&#x7B2C;&#x4E00;&#x6B21;&#x8FDB;&#x5165;&#x5BB6;&#x5EAD;&#x7684;&#x65F6;&#x5019;&#x767B;&#x5F55;&#x5427;&#x3002;&#x7136;&#x540E;&#x5982;&#x679C;&#x60F3;&#x641C;&#x5BFB;&#x6709;&#x95EE;&#x9898;&#x7684;&#x72D7;&#x4E3B;&#x4EBA;&#xFF0C;&#x9700;&#x8981;&#x5DE5;&#x4F5C;&#x4EBA;&#x5458;&#x5F53;&#x573A;&#x626B;&#x63CF;&#x72D7;&#x9F3B;&#x5B50;&#x4ECE;&#x800C;&#x9274;&#x522B;&#x72D7;&#x4E3B;&#x4EBA;&#xFF1F;</p>\n<p>&#x5C31;&#x6211;&#x7684;&#x8BDD;&#x8FD8;&#x662F;&#x5E0C;&#x671B;&#x80FD;&#x5F97;&#x5230;&#x968F;&#x5730;&#x5927;&#x5C0F;&#x4FBF;&#x7684;&#x72D7;&#x72D7;&#x7684;&#x4E3B;&#x4EBA;&#x4FE1;&#x606F;&#xFF0C;&#x6BD5;&#x7ADF;&#x5BB6;&#x95E8;&#x53E3;&#x843D;&#x4E0B;&#x7684;&#x4FBF;&#x4FBF;&#x3002;&#x3002;&#x3002;&#x3002;&#x3002;&#x3002;</p>\n<blockquote><p>&#x672C;&#x6587;&#x8BD1;&#x81EA;</p>\n<footer><strong>&#x4E2D;&#x5DDD;&#x771F;&#x77E5;&#x5B50;</strong><cite><a href=\"https://www.gizmodo.jp/2019/07/ai-start-up-dog-nose.html\">&#x4E2D;&#x56FD;&#x306E;AI&#x30B9;&#x30BF;&#x30FC;&#x30C8;&#x30A2;&#x30C3;&#x30D7;&#x304C;&#x8FF7;&#x3044;&#x72AC;&#x3092;&#x9F3B;&#x306E;&#x6307;&#x7D0B;&#xFF08;&#xFF1F;&#xFF09;&#x3092;&#x4F7F;&#x3063;&#x3066;&#x635C;&#x7D22;&#x3059;&#x308B;&#x30A2;&#x30D7;&#x30EA;&#x3092;&#x958B;&#x767A;</a></cite></footer></blockquote></body></html>","site":{"data":{}},"_categories":[{"name":"Translation","path":"categories/Translation/"}],"_tags":[{"name":"AI","path":"tags/AI/"},{"name":"APP","path":"tags/APP/"}],"excerpt":"<html><head></head><body><h2 id=\"&#x4E2D;&#x56FD;AI&#x516C;&#x53F8;&#x5F00;&#x53D1;&#x4E86;&#x7528;&#x9F3B;&#x7EB9;&#x641C;&#x7D22;&#x6D41;&#x6D6A;&#x72D7;&#x7684;APP\"><a href=\"#&#x4E2D;&#x56FD;AI&#x516C;&#x53F8;&#x5F00;&#x53D1;&#x4E86;&#x7528;&#x9F3B;&#x7EB9;&#x641C;&#x7D22;&#x6D41;&#x6D6A;&#x72D7;&#x7684;APP\" class=\"headerlink\" title=\"&#x4E2D;&#x56FD;AI&#x516C;&#x53F8;&#x5F00;&#x53D1;&#x4E86;&#x7528;&#x9F3B;&#x7EB9;&#x641C;&#x7D22;&#x6D41;&#x6D6A;&#x72D7;&#x7684;APP\"></a>&#x4E2D;&#x56FD;AI&#x516C;&#x53F8;&#x5F00;&#x53D1;&#x4E86;&#x7528;&#x9F3B;&#x7EB9;&#x641C;&#x7D22;&#x6D41;&#x6D6A;&#x72D7;&#x7684;APP</h2><p>&#x5982;&#x679C;&#x77A5;&#x5230;&#x6D41;&#x6D6A;&#x72D7;&#x7684;&#x6D77;&#x62A5;&#x4E00;&#x5B9A;&#x8981;&#x770B;&#x770B;&#x3002;</p>\n<p>&#x968F;&#x7740;&#x4E00;&#x4E2A;&#x4E2A;&#x5BD2;&#x51B7;&#x7684;&#x65E5;&#x5B50;&#xFF0C;&#x53C8;&#x8981;&#x5230;&#x70DF;&#x82B1;&#x5927;&#x4F1A;&#x7684;&#x5B63;&#x8282;&#x3002;&#x4E5F;&#x662F;&#x5BB6;&#x72AC;&#x88AB;&#x97AD;&#x70AE;&#x58F0;&#x5413;&#x8DD1;&#x7684;&#x5B63;&#x8282;&#x3002;</p></body></html>","more":"<p>最近家里养狗的越来越多，蹭着窗门开着主人一不留神逃跑的也不在少数，我家的爱犬就是在这个季节逃跑的。</p>\n<p>爱犬走丢时一般来说就是张贴寻狗海报或者各处打听。但是中国的一家叫Megvii（旷世）的AI公司可不一样。</p>\n<p>根据Verge报道，该公司正在开发一种像人类指纹一样识别狗鼻子形状的【狗识别系统】。使用旷世的APP，通过手机摄像头多角度拍摄狗鼻子就能登录完成。并称具有95%的精度，因此通过这个APP，有1万5000条宠物犬能再和它的主人再会。</p>\n<p>但是在中国不是用在和主人的再会，而是和政府合作规范不良狗主人的行为。</p>\n<p>具体怎样监视还不清楚，可能是宠物第一次进入家庭的时候登录吧。然后如果想搜寻有问题的狗主人，需要工作人员当场扫描狗鼻子从而鉴别狗主人？</p>\n<p>就我的话还是希望能得到随地大小便的狗狗的主人信息，毕竟家门口落下的便便。。。。。。</p>\n<blockquote><p>本文译自</p>\n<footer><strong>中川真知子</strong><cite><a href=\"https://www.gizmodo.jp/2019/07/ai-start-up-dog-nose.html\">中国のAIスタートアップが迷い犬を鼻の指紋（？）を使って捜索するアプリを開発</a></cite></footer></blockquote>"},{"title":"自定义配置文件读取&解析","date":"2020-12-11T03:43:51.000Z","_content":"\n最近开发的项目中遇到了自定义配置文件的读取与解析，结合现有的知识储备设计了一套通用解析方案。\n\n<!-- more -->\n### 配置文件的结构介绍\nnadia-proxy的代理配置文件参考了nginx的配置文件，并进行了一定的精简。\n\n``` json\nhttp {\n    servers {\n        listen 80;\n        location / {\n            root /var/html1;\n            index index.html;\n        }\n        location = /exact {\n            alias /var/html2;\n        }\n        location ^~ /prefix {\n            proxy {\n                strategy ROUND_ROBIN;\n                server 127.0.0.1:8001;\n                server 127.0.0.1:8002;\n                server 127.0.0.1:8003;\n            }\n        }\n        location ^~ /prefix {\n            proxy {\n                strategy WEIGHTED_ROUND_ROBIN;\n                server 127.0.0.1:8001 weight=1;\n                server 127.0.0.1:8002 weight=2;\n                server 127.0.0.1:8003 weight=3;\n            }\n        }\n    }\n    servers {\n        listen 4321;\n        location / {\n            proxy {\n                strategy IP_HASH;\n                server 127.0.0.1:8001;\n                server 127.0.0.1:8002;\n                server 127.0.0.1:8003;\n            }\n        }\n    }\n}\n```\n\n|节点|描述|层级|\n|---|---|---|\n|http|配置http协议的代理|0|\n|servers|配置各个服务的代理|1|\n|listen|需要被代理服务对外暴露的端口|2|\n|location|代理服务相关的路径信息|2|\n|root|静态服务代理的文件夹，不包含uri路径|3|\n|alias|静态服务代理的文件夹，包含uri路径|3|\n|index|静态服务代理的默认页面|3|\n|proxy|动态代理的配置信息|3|\n|strategy|动态代理的负载策略，默认为轮训|4|\n|server|动态代理的服务列表|4|\n\n\n### 如何读取配置文件\n通过上面的介绍我们可以发现，配置文件是以层级的形式所体现的。为此我们为各个节点设计了数据结构，并已”伙伴“树的形式形成一颗语法书。\n\n* 配置文件节点的数据结构\n\n``` C\nenum config_node_type {PARENT,CHILD}; //为合并语法树标识该节点的层级属性\n\ntypedef struct config_node_struct{\n    enum config_node_type node_type;\n    void *content; //当前节点的字符串\n\n    struct config_node_struct *friend; //同级别的节点\n    struct config_node_struct *child;  //孩子节点\n} CONFIG_NODE;\n```\n\n### 文件解析\n采用自顶向下的解析方式，按照每行逐字符解析字符：\n1. 遇到\"{\"字符时，向配置节点栈中压入一个PARENT类型的节点。\n2. 遇到\";\"字符时，向配置节点栈中压入一个CHILD类型的节点。\n3. 遇到\"}\"字符时，对之前压入配置节点栈中的节点依次弹出，同为CHILD的节点形成伙伴节点，知道遇到PARENT节点后，将所有的CHILD节点挂载至父节点中，并将PARENT已CHILD节点的身份重新入栈。\n\n重复上述1-3的流程，直至文件解析完成。\n\n\n\n### 节点的语法树解析\n直至上一个步骤，我们将配置文件读取完成并解析成一颗包含配置信息的语法树。\n\n目前我们无法得知各个节点的具体配置内容及其配置信息，并且也无法得知解析的配置项是否满足我们的配置要求。\n\n为此我们需要一种机制，自动解析并生成我们最终定义的配置数据结构。这里我们采用方式为有限状态机(finite-state machine)。\n\n### 有限状态机(finite-state machine)\n有限状态机能很好的将我们需要解析的配置收束至一个我们可控的范围。我们简化了状态机的工作原理，主要采用状态机的状态流转性。已配置语法树的前置遍历来驱动状态机的扭转。\n\n* 有限状态机的数据结构\n\n``` C\nenum state {INIT,HTTP,SERVERS,LISTEN,LOCATION,ROOT,ALIAS,INDEX,STRATEGY,PROXY,SERVER}; //状态机中的各个状态\n\n\ntypedef struct finite_state_machine {\n    enum state current_state; //当前状态\n    char *tag; //状态名\n    void *(* parse)(char *line,void *config); //当前状态的执行器\n\n    ARRAYLIST *child_state_list; //子状态列表\n    ARRAYLIST *frient_state_list; //同级状态列表\n} FSM;\n```\n\n代码实现层面，我们通过”伙伴“树的递归遍历，并依靠状态机的列表来流转状态，最终生成我们需要的配置文件结构。\n\n``` C\n    CONFIG_NODE  *node = (CONFIG_NODE *)POP_STACK(stack);\n    FSM *init = status_machine_arrary[INIT];\n    for(int i = 0 ;i < ARRAYLIST_LENGTH(init->child_state_list) ; i++){\n        generate_proxy_config(node,nadia_proxy_config,ARRAYLIST_GET(init->child_state_list,i));\n    }\n\nstatic void generate_proxy_config(CONFIG_NODE  *node, void *config, FSM *fsm){\n    if(node == NULL){\n        return;\n    }\n    STRING *string = (STRING *)node->content;\n    void *node_config = NULL;\n    if(strstr(string->string,fsm->tag) != NULL){\n        node_config = fsm->parse(string->string,config);\n    }\n    //parse child\n    for(int i = 0 ;i < ARRAYLIST_LENGTH(fsm->child_state_list) ; i++){\n        generate_proxy_config(node->child,node_config,ARRAYLIST_GET(fsm->child_state_list,i));\n    }\n    //parse friend\n    for(int i = 0 ;i < ARRAYLIST_LENGTH(fsm->frient_state_list) ; i++){\n        generate_proxy_config(node->friend,config,ARRAYLIST_GET(fsm->frient_state_list,i));\n    }\n}\n```","source":"_posts/自定义配置文件读取-解析.md","raw":"---\ntitle: 自定义配置文件读取&解析\ndate: 2020-12-11 11:43:51\ntags: \n    - C\ncategories :\n    - Technology\n---\n\n最近开发的项目中遇到了自定义配置文件的读取与解析，结合现有的知识储备设计了一套通用解析方案。\n\n<!-- more -->\n### 配置文件的结构介绍\nnadia-proxy的代理配置文件参考了nginx的配置文件，并进行了一定的精简。\n\n``` json\nhttp {\n    servers {\n        listen 80;\n        location / {\n            root /var/html1;\n            index index.html;\n        }\n        location = /exact {\n            alias /var/html2;\n        }\n        location ^~ /prefix {\n            proxy {\n                strategy ROUND_ROBIN;\n                server 127.0.0.1:8001;\n                server 127.0.0.1:8002;\n                server 127.0.0.1:8003;\n            }\n        }\n        location ^~ /prefix {\n            proxy {\n                strategy WEIGHTED_ROUND_ROBIN;\n                server 127.0.0.1:8001 weight=1;\n                server 127.0.0.1:8002 weight=2;\n                server 127.0.0.1:8003 weight=3;\n            }\n        }\n    }\n    servers {\n        listen 4321;\n        location / {\n            proxy {\n                strategy IP_HASH;\n                server 127.0.0.1:8001;\n                server 127.0.0.1:8002;\n                server 127.0.0.1:8003;\n            }\n        }\n    }\n}\n```\n\n|节点|描述|层级|\n|---|---|---|\n|http|配置http协议的代理|0|\n|servers|配置各个服务的代理|1|\n|listen|需要被代理服务对外暴露的端口|2|\n|location|代理服务相关的路径信息|2|\n|root|静态服务代理的文件夹，不包含uri路径|3|\n|alias|静态服务代理的文件夹，包含uri路径|3|\n|index|静态服务代理的默认页面|3|\n|proxy|动态代理的配置信息|3|\n|strategy|动态代理的负载策略，默认为轮训|4|\n|server|动态代理的服务列表|4|\n\n\n### 如何读取配置文件\n通过上面的介绍我们可以发现，配置文件是以层级的形式所体现的。为此我们为各个节点设计了数据结构，并已”伙伴“树的形式形成一颗语法书。\n\n* 配置文件节点的数据结构\n\n``` C\nenum config_node_type {PARENT,CHILD}; //为合并语法树标识该节点的层级属性\n\ntypedef struct config_node_struct{\n    enum config_node_type node_type;\n    void *content; //当前节点的字符串\n\n    struct config_node_struct *friend; //同级别的节点\n    struct config_node_struct *child;  //孩子节点\n} CONFIG_NODE;\n```\n\n### 文件解析\n采用自顶向下的解析方式，按照每行逐字符解析字符：\n1. 遇到\"{\"字符时，向配置节点栈中压入一个PARENT类型的节点。\n2. 遇到\";\"字符时，向配置节点栈中压入一个CHILD类型的节点。\n3. 遇到\"}\"字符时，对之前压入配置节点栈中的节点依次弹出，同为CHILD的节点形成伙伴节点，知道遇到PARENT节点后，将所有的CHILD节点挂载至父节点中，并将PARENT已CHILD节点的身份重新入栈。\n\n重复上述1-3的流程，直至文件解析完成。\n\n\n\n### 节点的语法树解析\n直至上一个步骤，我们将配置文件读取完成并解析成一颗包含配置信息的语法树。\n\n目前我们无法得知各个节点的具体配置内容及其配置信息，并且也无法得知解析的配置项是否满足我们的配置要求。\n\n为此我们需要一种机制，自动解析并生成我们最终定义的配置数据结构。这里我们采用方式为有限状态机(finite-state machine)。\n\n### 有限状态机(finite-state machine)\n有限状态机能很好的将我们需要解析的配置收束至一个我们可控的范围。我们简化了状态机的工作原理，主要采用状态机的状态流转性。已配置语法树的前置遍历来驱动状态机的扭转。\n\n* 有限状态机的数据结构\n\n``` C\nenum state {INIT,HTTP,SERVERS,LISTEN,LOCATION,ROOT,ALIAS,INDEX,STRATEGY,PROXY,SERVER}; //状态机中的各个状态\n\n\ntypedef struct finite_state_machine {\n    enum state current_state; //当前状态\n    char *tag; //状态名\n    void *(* parse)(char *line,void *config); //当前状态的执行器\n\n    ARRAYLIST *child_state_list; //子状态列表\n    ARRAYLIST *frient_state_list; //同级状态列表\n} FSM;\n```\n\n代码实现层面，我们通过”伙伴“树的递归遍历，并依靠状态机的列表来流转状态，最终生成我们需要的配置文件结构。\n\n``` C\n    CONFIG_NODE  *node = (CONFIG_NODE *)POP_STACK(stack);\n    FSM *init = status_machine_arrary[INIT];\n    for(int i = 0 ;i < ARRAYLIST_LENGTH(init->child_state_list) ; i++){\n        generate_proxy_config(node,nadia_proxy_config,ARRAYLIST_GET(init->child_state_list,i));\n    }\n\nstatic void generate_proxy_config(CONFIG_NODE  *node, void *config, FSM *fsm){\n    if(node == NULL){\n        return;\n    }\n    STRING *string = (STRING *)node->content;\n    void *node_config = NULL;\n    if(strstr(string->string,fsm->tag) != NULL){\n        node_config = fsm->parse(string->string,config);\n    }\n    //parse child\n    for(int i = 0 ;i < ARRAYLIST_LENGTH(fsm->child_state_list) ; i++){\n        generate_proxy_config(node->child,node_config,ARRAYLIST_GET(fsm->child_state_list,i));\n    }\n    //parse friend\n    for(int i = 0 ;i < ARRAYLIST_LENGTH(fsm->frient_state_list) ; i++){\n        generate_proxy_config(node->friend,config,ARRAYLIST_GET(fsm->frient_state_list,i));\n    }\n}\n```","slug":"自定义配置文件读取-解析","published":1,"updated":"2020-12-14T09:51:24.054Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htq001kv252amvo3uoz","content":"<html><head></head><body><p>&#x6700;&#x8FD1;&#x5F00;&#x53D1;&#x7684;&#x9879;&#x76EE;&#x4E2D;&#x9047;&#x5230;&#x4E86;&#x81EA;&#x5B9A;&#x4E49;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x8BFB;&#x53D6;&#x4E0E;&#x89E3;&#x6790;&#xFF0C;&#x7ED3;&#x5408;&#x73B0;&#x6709;&#x7684;&#x77E5;&#x8BC6;&#x50A8;&#x5907;&#x8BBE;&#x8BA1;&#x4E86;&#x4E00;&#x5957;&#x901A;&#x7528;&#x89E3;&#x6790;&#x65B9;&#x6848;&#x3002;</p>\n<a id=\"more\"></a>\n<h3 id=\"&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x7ED3;&#x6784;&#x4ECB;&#x7ECD;\"><a href=\"#&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x7ED3;&#x6784;&#x4ECB;&#x7ECD;\" class=\"headerlink\" title=\"&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x7ED3;&#x6784;&#x4ECB;&#x7ECD;\"></a>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x7ED3;&#x6784;&#x4ECB;&#x7ECD;</h3><p>nadia-proxy&#x7684;&#x4EE3;&#x7406;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x53C2;&#x8003;&#x4E86;nginx&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x8FDB;&#x884C;&#x4E86;&#x4E00;&#x5B9A;&#x7684;&#x7CBE;&#x7B80;&#x3002;</p>\n<figure class=\"highlight hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http {</span><br><span class=\"line\">    servers {</span><br><span class=\"line\">        listen 80;</span><br><span class=\"line\">        location / {</span><br><span class=\"line\">            root /var/html1;</span><br><span class=\"line\">            index index.html;</span><br><span class=\"line\">        }</span><br><span class=\"line\">        location = /exact {</span><br><span class=\"line\">            alias /var/html2;</span><br><span class=\"line\">        }</span><br><span class=\"line\">        location ^~ /prefix {</span><br><span class=\"line\">            proxy {</span><br><span class=\"line\">                strategy ROUND_ROBIN;</span><br><span class=\"line\">                server 127.0.0.1:8001;</span><br><span class=\"line\">                server 127.0.0.1:8002;</span><br><span class=\"line\">                server 127.0.0.1:8003;</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\">        location ^~ /prefix {</span><br><span class=\"line\">            proxy {</span><br><span class=\"line\">                strategy WEIGHTED_ROUND_ROBIN;</span><br><span class=\"line\">                server 127.0.0.1:8001 weight=1;</span><br><span class=\"line\">                server 127.0.0.1:8002 weight=2;</span><br><span class=\"line\">                server 127.0.0.1:8003 weight=3;</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">    servers {</span><br><span class=\"line\">        listen 4321;</span><br><span class=\"line\">        location / {</span><br><span class=\"line\">            proxy {</span><br><span class=\"line\">                strategy IP_HASH;</span><br><span class=\"line\">                server 127.0.0.1:8001;</span><br><span class=\"line\">                server 127.0.0.1:8002;</span><br><span class=\"line\">                server 127.0.0.1:8003;</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>&#x8282;&#x70B9;</th>\n<th>&#x63CF;&#x8FF0;</th>\n<th>&#x5C42;&#x7EA7;</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>http</td>\n<td>&#x914D;&#x7F6E;http&#x534F;&#x8BAE;&#x7684;&#x4EE3;&#x7406;</td>\n<td>0</td>\n</tr>\n<tr>\n<td>servers</td>\n<td>&#x914D;&#x7F6E;&#x5404;&#x4E2A;&#x670D;&#x52A1;&#x7684;&#x4EE3;&#x7406;</td>\n<td>1</td>\n</tr>\n<tr>\n<td>listen</td>\n<td>&#x9700;&#x8981;&#x88AB;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5BF9;&#x5916;&#x66B4;&#x9732;&#x7684;&#x7AEF;&#x53E3;</td>\n<td>2</td>\n</tr>\n<tr>\n<td>location</td>\n<td>&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x76F8;&#x5173;&#x7684;&#x8DEF;&#x5F84;&#x4FE1;&#x606F;</td>\n<td>2</td>\n</tr>\n<tr>\n<td>root</td>\n<td>&#x9759;&#x6001;&#x670D;&#x52A1;&#x4EE3;&#x7406;&#x7684;&#x6587;&#x4EF6;&#x5939;&#xFF0C;&#x4E0D;&#x5305;&#x542B;uri&#x8DEF;&#x5F84;</td>\n<td>3</td>\n</tr>\n<tr>\n<td>alias</td>\n<td>&#x9759;&#x6001;&#x670D;&#x52A1;&#x4EE3;&#x7406;&#x7684;&#x6587;&#x4EF6;&#x5939;&#xFF0C;&#x5305;&#x542B;uri&#x8DEF;&#x5F84;</td>\n<td>3</td>\n</tr>\n<tr>\n<td>index</td>\n<td>&#x9759;&#x6001;&#x670D;&#x52A1;&#x4EE3;&#x7406;&#x7684;&#x9ED8;&#x8BA4;&#x9875;&#x9762;</td>\n<td>3</td>\n</tr>\n<tr>\n<td>proxy</td>\n<td>&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x7684;&#x914D;&#x7F6E;&#x4FE1;&#x606F;</td>\n<td>3</td>\n</tr>\n<tr>\n<td>strategy</td>\n<td>&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x7684;&#x8D1F;&#x8F7D;&#x7B56;&#x7565;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;&#x8F6E;&#x8BAD;</td>\n<td>4</td>\n</tr>\n<tr>\n<td>server</td>\n<td>&#x52A8;&#x6001;&#x4EE3;&#x7406;&#x7684;&#x670D;&#x52A1;&#x5217;&#x8868;</td>\n<td>4</td>\n</tr>\n</tbody></table>\n<h3 id=\"&#x5982;&#x4F55;&#x8BFB;&#x53D6;&#x914D;&#x7F6E;&#x6587;&#x4EF6;\"><a href=\"#&#x5982;&#x4F55;&#x8BFB;&#x53D6;&#x914D;&#x7F6E;&#x6587;&#x4EF6;\" class=\"headerlink\" title=\"&#x5982;&#x4F55;&#x8BFB;&#x53D6;&#x914D;&#x7F6E;&#x6587;&#x4EF6;\"></a>&#x5982;&#x4F55;&#x8BFB;&#x53D6;&#x914D;&#x7F6E;&#x6587;&#x4EF6;</h3><p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x4ECB;&#x7ECD;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x662F;&#x4EE5;&#x5C42;&#x7EA7;&#x7684;&#x5F62;&#x5F0F;&#x6240;&#x4F53;&#x73B0;&#x7684;&#x3002;&#x4E3A;&#x6B64;&#x6211;&#x4EEC;&#x4E3A;&#x5404;&#x4E2A;&#x8282;&#x70B9;&#x8BBE;&#x8BA1;&#x4E86;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x5E76;&#x5DF2;&#x201D;&#x4F19;&#x4F34;&#x201C;&#x6811;&#x7684;&#x5F62;&#x5F0F;&#x5F62;&#x6210;&#x4E00;&#x9897;&#x8BED;&#x6CD5;&#x4E66;&#x3002;</p>\n<ul>\n<li>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x8282;&#x70B9;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;</li>\n</ul>\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title\">config_node_type</span> {</span>PARENT,CHILD};&#xA0;<span class=\"hljs-comment\">//&#x4E3A;&#x5408;&#x5E76;&#x8BED;&#x6CD5;&#x6811;&#x6807;&#x8BC6;&#x8BE5;&#x8282;&#x70B9;&#x7684;&#x5C42;&#x7EA7;&#x5C5E;&#x6027;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">config_node_struct</span>{</span></span><br><span class=\"line\">    <span class=\"hljs-class\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title\">config_node_type</span> <span class=\"hljs-title\">node_type</span>;</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">void</span> *content; <span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x8282;&#x70B9;&#x7684;&#x5B57;&#x7B26;&#x4E32;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">config_node_struct</span> *<span class=\"hljs-title\">friend</span>;</span> <span class=\"hljs-comment\">//&#x540C;&#x7EA7;&#x522B;&#x7684;&#x8282;&#x70B9;</span></span><br><span class=\"line\">    <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">config_node_struct</span> *<span class=\"hljs-title\">child</span>;</span>  <span class=\"hljs-comment\">//&#x5B69;&#x5B50;&#x8282;&#x70B9;</span></span><br><span class=\"line\">} CONFIG_NODE;</span><br></pre></td></tr></tbody></table></figure>\n\n<h3 id=\"&#x6587;&#x4EF6;&#x89E3;&#x6790;\"><a href=\"#&#x6587;&#x4EF6;&#x89E3;&#x6790;\" class=\"headerlink\" title=\"&#x6587;&#x4EF6;&#x89E3;&#x6790;\"></a>&#x6587;&#x4EF6;&#x89E3;&#x6790;</h3><p>&#x91C7;&#x7528;&#x81EA;&#x9876;&#x5411;&#x4E0B;&#x7684;&#x89E3;&#x6790;&#x65B9;&#x5F0F;&#xFF0C;&#x6309;&#x7167;&#x6BCF;&#x884C;&#x9010;&#x5B57;&#x7B26;&#x89E3;&#x6790;&#x5B57;&#x7B26;&#xFF1A;</p>\n<ol>\n<li>&#x9047;&#x5230;&#x201D;{&#x201C;&#x5B57;&#x7B26;&#x65F6;&#xFF0C;&#x5411;&#x914D;&#x7F6E;&#x8282;&#x70B9;&#x6808;&#x4E2D;&#x538B;&#x5165;&#x4E00;&#x4E2A;PARENT&#x7C7B;&#x578B;&#x7684;&#x8282;&#x70B9;&#x3002;</li>\n<li>&#x9047;&#x5230;&#x201D;;&#x201D;&#x5B57;&#x7B26;&#x65F6;&#xFF0C;&#x5411;&#x914D;&#x7F6E;&#x8282;&#x70B9;&#x6808;&#x4E2D;&#x538B;&#x5165;&#x4E00;&#x4E2A;CHILD&#x7C7B;&#x578B;&#x7684;&#x8282;&#x70B9;&#x3002;</li>\n<li>&#x9047;&#x5230;&#x201D;}&#x201D;&#x5B57;&#x7B26;&#x65F6;&#xFF0C;&#x5BF9;&#x4E4B;&#x524D;&#x538B;&#x5165;&#x914D;&#x7F6E;&#x8282;&#x70B9;&#x6808;&#x4E2D;&#x7684;&#x8282;&#x70B9;&#x4F9D;&#x6B21;&#x5F39;&#x51FA;&#xFF0C;&#x540C;&#x4E3A;CHILD&#x7684;&#x8282;&#x70B9;&#x5F62;&#x6210;&#x4F19;&#x4F34;&#x8282;&#x70B9;&#xFF0C;&#x77E5;&#x9053;&#x9047;&#x5230;PARENT&#x8282;&#x70B9;&#x540E;&#xFF0C;&#x5C06;&#x6240;&#x6709;&#x7684;CHILD&#x8282;&#x70B9;&#x6302;&#x8F7D;&#x81F3;&#x7236;&#x8282;&#x70B9;&#x4E2D;&#xFF0C;&#x5E76;&#x5C06;PARENT&#x5DF2;CHILD&#x8282;&#x70B9;&#x7684;&#x8EAB;&#x4EFD;&#x91CD;&#x65B0;&#x5165;&#x6808;&#x3002;</li>\n</ol>\n<p>&#x91CD;&#x590D;&#x4E0A;&#x8FF0;1-3&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x76F4;&#x81F3;&#x6587;&#x4EF6;&#x89E3;&#x6790;&#x5B8C;&#x6210;&#x3002;</p>\n<h3 id=\"&#x8282;&#x70B9;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#x89E3;&#x6790;\"><a href=\"#&#x8282;&#x70B9;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#x89E3;&#x6790;\" class=\"headerlink\" title=\"&#x8282;&#x70B9;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#x89E3;&#x6790;\"></a>&#x8282;&#x70B9;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#x89E3;&#x6790;</h3><p>&#x76F4;&#x81F3;&#x4E0A;&#x4E00;&#x4E2A;&#x6B65;&#x9AA4;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x8BFB;&#x53D6;&#x5B8C;&#x6210;&#x5E76;&#x89E3;&#x6790;&#x6210;&#x4E00;&#x9897;&#x5305;&#x542B;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x7684;&#x8BED;&#x6CD5;&#x6811;&#x3002;</p>\n<p>&#x76EE;&#x524D;&#x6211;&#x4EEC;&#x65E0;&#x6CD5;&#x5F97;&#x77E5;&#x5404;&#x4E2A;&#x8282;&#x70B9;&#x7684;&#x5177;&#x4F53;&#x914D;&#x7F6E;&#x5185;&#x5BB9;&#x53CA;&#x5176;&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x4E14;&#x4E5F;&#x65E0;&#x6CD5;&#x5F97;&#x77E5;&#x89E3;&#x6790;&#x7684;&#x914D;&#x7F6E;&#x9879;&#x662F;&#x5426;&#x6EE1;&#x8DB3;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x8981;&#x6C42;&#x3002;</p>\n<p>&#x4E3A;&#x6B64;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4E00;&#x79CD;&#x673A;&#x5236;&#xFF0C;&#x81EA;&#x52A8;&#x89E3;&#x6790;&#x5E76;&#x751F;&#x6210;&#x6211;&#x4EEC;&#x6700;&#x7EC8;&#x5B9A;&#x4E49;&#x7684;&#x914D;&#x7F6E;&#x6570;&#x636E;&#x7ED3;&#x6784;&#x3002;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x91C7;&#x7528;&#x65B9;&#x5F0F;&#x4E3A;&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;(finite-state machine)&#x3002;</p>\n<h3 id=\"&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;-finite-state-machine\"><a href=\"#&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;-finite-state-machine\" class=\"headerlink\" title=\"&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;(finite-state machine)\"></a>&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;(finite-state machine)</h3><p>&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;&#x80FD;&#x5F88;&#x597D;&#x7684;&#x5C06;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x89E3;&#x6790;&#x7684;&#x914D;&#x7F6E;&#x6536;&#x675F;&#x81F3;&#x4E00;&#x4E2A;&#x6211;&#x4EEC;&#x53EF;&#x63A7;&#x7684;&#x8303;&#x56F4;&#x3002;&#x6211;&#x4EEC;&#x7B80;&#x5316;&#x4E86;&#x72B6;&#x6001;&#x673A;&#x7684;&#x5DE5;&#x4F5C;&#x539F;&#x7406;&#xFF0C;&#x4E3B;&#x8981;&#x91C7;&#x7528;&#x72B6;&#x6001;&#x673A;&#x7684;&#x72B6;&#x6001;&#x6D41;&#x8F6C;&#x6027;&#x3002;&#x5DF2;&#x914D;&#x7F6E;&#x8BED;&#x6CD5;&#x6811;&#x7684;&#x524D;&#x7F6E;&#x904D;&#x5386;&#x6765;&#x9A71;&#x52A8;&#x72B6;&#x6001;&#x673A;&#x7684;&#x626D;&#x8F6C;&#x3002;</p>\n<ul>\n<li>&#x6709;&#x9650;&#x72B6;&#x6001;&#x673A;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;</li>\n</ul>\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title\">state</span> {</span>INIT,HTTP,SERVERS,LISTEN,LOCATION,ROOT,ALIAS,INDEX,STRATEGY,PROXY,SERVER}; <span class=\"hljs-comment\">//&#x72B6;&#x6001;&#x673A;&#x4E2D;&#x7684;&#x5404;&#x4E2A;&#x72B6;&#x6001;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">finite_state_machine</span> {</span></span><br><span class=\"line\">    <span class=\"hljs-class\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title\">state</span> <span class=\"hljs-title\">current_state</span>;</span> <span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x72B6;&#x6001;</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">char</span> *tag; <span class=\"hljs-comment\">//&#x72B6;&#x6001;&#x540D;</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">void</span> *(* parse)(<span class=\"hljs-keyword\">char</span> *line,<span class=\"hljs-keyword\">void</span> *config); <span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x72B6;&#x6001;&#x7684;&#x6267;&#x884C;&#x5668;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    ARRAYLIST *child_state_list; <span class=\"hljs-comment\">//&#x5B50;&#x72B6;&#x6001;&#x5217;&#x8868;</span></span><br><span class=\"line\">    ARRAYLIST *frient_state_list; <span class=\"hljs-comment\">//&#x540C;&#x7EA7;&#x72B6;&#x6001;&#x5217;&#x8868;</span></span><br><span class=\"line\">} FSM;</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x4EE3;&#x7801;&#x5B9E;&#x73B0;&#x5C42;&#x9762;&#xFF0C;&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x201D;&#x4F19;&#x4F34;&#x201C;&#x6811;&#x7684;&#x9012;&#x5F52;&#x904D;&#x5386;&#xFF0C;&#x5E76;&#x4F9D;&#x9760;&#x72B6;&#x6001;&#x673A;&#x7684;&#x5217;&#x8868;&#x6765;&#x6D41;&#x8F6C;&#x72B6;&#x6001;&#xFF0C;&#x6700;&#x7EC8;&#x751F;&#x6210;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7ED3;&#x6784;&#x3002;</p>\n<figure class=\"highlight c hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    CONFIG_NODE  *node = (CONFIG_NODE *)POP_STACK(<span class=\"hljs-built_in\">stack</span>);</span><br><span class=\"line\">    FSM *init = status_machine_arrary[INIT];</span><br><span class=\"line\">    <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-keyword\">int</span> i = <span class=\"hljs-number\">0</span> ;i &lt; ARRAYLIST_LENGTH(init-&gt;child_state_list) ; i++){</span><br><span class=\"line\">        generate_proxy_config(node,nadia_proxy_config,ARRAYLIST_GET(init-&gt;child_state_list,i));</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">generate_proxy_config</span><span class=\"hljs-params\">(CONFIG_NODE  *node, <span class=\"hljs-keyword\">void</span> *config, FSM *fsm)</span></span>{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span>(node == <span class=\"hljs-literal\">NULL</span>){</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    STRING *<span class=\"hljs-built_in\">string</span> = (STRING *)node-&gt;content;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">void</span> *node_config = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span>(<span class=\"hljs-built_in\">strstr</span>(<span class=\"hljs-built_in\">string</span>-&gt;<span class=\"hljs-built_in\">string</span>,fsm-&gt;tag) != <span class=\"hljs-literal\">NULL</span>){</span><br><span class=\"line\">        node_config = fsm-&gt;parse(<span class=\"hljs-built_in\">string</span>-&gt;<span class=\"hljs-built_in\">string</span>,config);</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-comment\">//parse child</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-keyword\">int</span> i = <span class=\"hljs-number\">0</span> ;i &lt; ARRAYLIST_LENGTH(fsm-&gt;child_state_list) ; i++){</span><br><span class=\"line\">        generate_proxy_config(node-&gt;child,node_config,ARRAYLIST_GET(fsm-&gt;child_state_list,i));</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-comment\">//parse friend</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">for</span>(<span class=\"hljs-keyword\">int</span> i = <span class=\"hljs-number\">0</span> ;i &lt; ARRAYLIST_LENGTH(fsm-&gt;frient_state_list) ; i++){</span><br><span class=\"line\">        generate_proxy_config(node-&gt;<span class=\"hljs-keyword\">friend</span>,config,ARRAYLIST_GET(fsm-&gt;frient_state_list,i));</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure></body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"C","path":"tags/C/"}],"excerpt":"<html><head></head><body><p>&#x6700;&#x8FD1;&#x5F00;&#x53D1;&#x7684;&#x9879;&#x76EE;&#x4E2D;&#x9047;&#x5230;&#x4E86;&#x81EA;&#x5B9A;&#x4E49;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x8BFB;&#x53D6;&#x4E0E;&#x89E3;&#x6790;&#xFF0C;&#x7ED3;&#x5408;&#x73B0;&#x6709;&#x7684;&#x77E5;&#x8BC6;&#x50A8;&#x5907;&#x8BBE;&#x8BA1;&#x4E86;&#x4E00;&#x5957;&#x901A;&#x7528;&#x89E3;&#x6790;&#x65B9;&#x6848;&#x3002;</p></body></html>","more":"<h3 id=\"配置文件的结构介绍\"><a href=\"#配置文件的结构介绍\" class=\"headerlink\" title=\"配置文件的结构介绍\"></a>配置文件的结构介绍</h3><p>nadia-proxy的代理配置文件参考了nginx的配置文件，并进行了一定的精简。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http &#123;</span><br><span class=\"line\">    servers &#123;</span><br><span class=\"line\">        listen 80;</span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            root /var/html1;</span><br><span class=\"line\">            index index.html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        location = /exact &#123;</span><br><span class=\"line\">            alias /var/html2;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        location ^~ /prefix &#123;</span><br><span class=\"line\">            proxy &#123;</span><br><span class=\"line\">                strategy ROUND_ROBIN;</span><br><span class=\"line\">                server 127.0.0.1:8001;</span><br><span class=\"line\">                server 127.0.0.1:8002;</span><br><span class=\"line\">                server 127.0.0.1:8003;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        location ^~ /prefix &#123;</span><br><span class=\"line\">            proxy &#123;</span><br><span class=\"line\">                strategy WEIGHTED_ROUND_ROBIN;</span><br><span class=\"line\">                server 127.0.0.1:8001 weight=1;</span><br><span class=\"line\">                server 127.0.0.1:8002 weight=2;</span><br><span class=\"line\">                server 127.0.0.1:8003 weight=3;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    servers &#123;</span><br><span class=\"line\">        listen 4321;</span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            proxy &#123;</span><br><span class=\"line\">                strategy IP_HASH;</span><br><span class=\"line\">                server 127.0.0.1:8001;</span><br><span class=\"line\">                server 127.0.0.1:8002;</span><br><span class=\"line\">                server 127.0.0.1:8003;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>节点</th>\n<th>描述</th>\n<th>层级</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>http</td>\n<td>配置http协议的代理</td>\n<td>0</td>\n</tr>\n<tr>\n<td>servers</td>\n<td>配置各个服务的代理</td>\n<td>1</td>\n</tr>\n<tr>\n<td>listen</td>\n<td>需要被代理服务对外暴露的端口</td>\n<td>2</td>\n</tr>\n<tr>\n<td>location</td>\n<td>代理服务相关的路径信息</td>\n<td>2</td>\n</tr>\n<tr>\n<td>root</td>\n<td>静态服务代理的文件夹，不包含uri路径</td>\n<td>3</td>\n</tr>\n<tr>\n<td>alias</td>\n<td>静态服务代理的文件夹，包含uri路径</td>\n<td>3</td>\n</tr>\n<tr>\n<td>index</td>\n<td>静态服务代理的默认页面</td>\n<td>3</td>\n</tr>\n<tr>\n<td>proxy</td>\n<td>动态代理的配置信息</td>\n<td>3</td>\n</tr>\n<tr>\n<td>strategy</td>\n<td>动态代理的负载策略，默认为轮训</td>\n<td>4</td>\n</tr>\n<tr>\n<td>server</td>\n<td>动态代理的服务列表</td>\n<td>4</td>\n</tr>\n</tbody></table>\n<h3 id=\"如何读取配置文件\"><a href=\"#如何读取配置文件\" class=\"headerlink\" title=\"如何读取配置文件\"></a>如何读取配置文件</h3><p>通过上面的介绍我们可以发现，配置文件是以层级的形式所体现的。为此我们为各个节点设计了数据结构，并已”伙伴“树的形式形成一颗语法书。</p>\n<ul>\n<li>配置文件节点的数据结构</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">enum</span> <span class=\"title\">config_node_type</span> &#123;</span>PARENT,CHILD&#125;; <span class=\"comment\">//为合并语法树标识该节点的层级属性</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">config_node_struct</span>&#123;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">enum</span> <span class=\"title\">config_node_type</span> <span class=\"title\">node_type</span>;</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> *content; <span class=\"comment\">//当前节点的字符串</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">config_node_struct</span> *<span class=\"title\">friend</span>;</span> <span class=\"comment\">//同级别的节点</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">config_node_struct</span> *<span class=\"title\">child</span>;</span>  <span class=\"comment\">//孩子节点</span></span><br><span class=\"line\">&#125; CONFIG_NODE;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"文件解析\"><a href=\"#文件解析\" class=\"headerlink\" title=\"文件解析\"></a>文件解析</h3><p>采用自顶向下的解析方式，按照每行逐字符解析字符：</p>\n<ol>\n<li>遇到”{“字符时，向配置节点栈中压入一个PARENT类型的节点。</li>\n<li>遇到”;”字符时，向配置节点栈中压入一个CHILD类型的节点。</li>\n<li>遇到”}”字符时，对之前压入配置节点栈中的节点依次弹出，同为CHILD的节点形成伙伴节点，知道遇到PARENT节点后，将所有的CHILD节点挂载至父节点中，并将PARENT已CHILD节点的身份重新入栈。</li>\n</ol>\n<p>重复上述1-3的流程，直至文件解析完成。</p>\n<h3 id=\"节点的语法树解析\"><a href=\"#节点的语法树解析\" class=\"headerlink\" title=\"节点的语法树解析\"></a>节点的语法树解析</h3><p>直至上一个步骤，我们将配置文件读取完成并解析成一颗包含配置信息的语法树。</p>\n<p>目前我们无法得知各个节点的具体配置内容及其配置信息，并且也无法得知解析的配置项是否满足我们的配置要求。</p>\n<p>为此我们需要一种机制，自动解析并生成我们最终定义的配置数据结构。这里我们采用方式为有限状态机(finite-state machine)。</p>\n<h3 id=\"有限状态机-finite-state-machine\"><a href=\"#有限状态机-finite-state-machine\" class=\"headerlink\" title=\"有限状态机(finite-state machine)\"></a>有限状态机(finite-state machine)</h3><p>有限状态机能很好的将我们需要解析的配置收束至一个我们可控的范围。我们简化了状态机的工作原理，主要采用状态机的状态流转性。已配置语法树的前置遍历来驱动状态机的扭转。</p>\n<ul>\n<li>有限状态机的数据结构</li>\n</ul>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">enum</span> <span class=\"title\">state</span> &#123;</span>INIT,HTTP,SERVERS,LISTEN,LOCATION,ROOT,ALIAS,INDEX,STRATEGY,PROXY,SERVER&#125;; <span class=\"comment\">//状态机中的各个状态</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">typedef</span> <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">finite_state_machine</span> &#123;</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">enum</span> <span class=\"title\">state</span> <span class=\"title\">current_state</span>;</span> <span class=\"comment\">//当前状态</span></span><br><span class=\"line\">    <span class=\"keyword\">char</span> *tag; <span class=\"comment\">//状态名</span></span><br><span class=\"line\">    <span class=\"keyword\">void</span> *(* parse)(<span class=\"keyword\">char</span> *line,<span class=\"keyword\">void</span> *config); <span class=\"comment\">//当前状态的执行器</span></span><br><span class=\"line\"></span><br><span class=\"line\">    ARRAYLIST *child_state_list; <span class=\"comment\">//子状态列表</span></span><br><span class=\"line\">    ARRAYLIST *frient_state_list; <span class=\"comment\">//同级状态列表</span></span><br><span class=\"line\">&#125; FSM;</span><br></pre></td></tr></table></figure>\n\n<p>代码实现层面，我们通过”伙伴“树的递归遍历，并依靠状态机的列表来流转状态，最终生成我们需要的配置文件结构。</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    CONFIG_NODE  *node = (CONFIG_NODE *)POP_STACK(<span class=\"built_in\">stack</span>);</span><br><span class=\"line\">    FSM *init = status_machine_arrary[INIT];</span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span> ;i &lt; ARRAYLIST_LENGTH(init-&gt;child_state_list) ; i++)&#123;</span><br><span class=\"line\">        generate_proxy_config(node,nadia_proxy_config,ARRAYLIST_GET(init-&gt;child_state_list,i));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">generate_proxy_config</span><span class=\"params\">(CONFIG_NODE  *node, <span class=\"keyword\">void</span> *config, FSM *fsm)</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(node == <span class=\"literal\">NULL</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    STRING *<span class=\"built_in\">string</span> = (STRING *)node-&gt;content;</span><br><span class=\"line\">    <span class=\"keyword\">void</span> *node_config = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"built_in\">strstr</span>(<span class=\"built_in\">string</span>-&gt;<span class=\"built_in\">string</span>,fsm-&gt;tag) != <span class=\"literal\">NULL</span>)&#123;</span><br><span class=\"line\">        node_config = fsm-&gt;parse(<span class=\"built_in\">string</span>-&gt;<span class=\"built_in\">string</span>,config);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//parse child</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span> ;i &lt; ARRAYLIST_LENGTH(fsm-&gt;child_state_list) ; i++)&#123;</span><br><span class=\"line\">        generate_proxy_config(node-&gt;child,node_config,ARRAYLIST_GET(fsm-&gt;child_state_list,i));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">//parse friend</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span>(<span class=\"keyword\">int</span> i = <span class=\"number\">0</span> ;i &lt; ARRAYLIST_LENGTH(fsm-&gt;frient_state_list) ; i++)&#123;</span><br><span class=\"line\">        generate_proxy_config(node-&gt;<span class=\"keyword\">friend</span>,config,ARRAYLIST_GET(fsm-&gt;frient_state_list,i));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>"},{"title":"自己动手写Java虚拟机 笔记1","date":"2019-09-09T14:18:50.000Z","_content":"\n## 环境配置\n1. 安装Golang\n   \n{% blockquote %}\nhttps://golang.google.cn/\n{% endblockquote %}\n\n2. 设置Go环境变量\n\n![01](自己动手写Java虚拟机-笔记1/gopath.png)\n\n同时要注意，go的工作目录为该目录，如果需要切换需要改变此路径，不然可使用GoLand等ide切换。\n<!-- more -->\n\n## 简单实现java命令\njava SDK自带很多命令，如java、javac、javap等。\njava命令是其中最终要的一个，平时我们启动一个jar，如springboot工程。还是一个基于tomcat、weblogic、jboss的war包。其根本都是利用java命令执行main方法为入口。\n\n{% codeblock %}\njava [-options] class [args]\njava [-options] -jar jarfile [args]\njavaw [-options] class [args]\njavaw [-options] -jar jarfile [args]\n{% endcodeblock %}\n\n{% blockquote %}\n官方说明：  https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html\n{% endblockquote %}\n\n## 用Go实现java命令的参数读取\n1. java命令入参结构\n\n{% codeblock lang:go %}\ntype Cmd struct {\n\thelpFlag bool //命令为help 或 ? 时：true\n\tversionFlag bool //命令是否为version时：true\n\tcpOption string //命令为cp 或 classpath时，保存值\n\tXjreOption string //命令为Xjre时，保存值\n\tclass string //保存class\n\targs []string //保存其他入参\n}\n{% endcodeblock %}\n\n2. 解析入参\n\n{% codeblock lang:go %}\nfunc parseCmd() *Cmd {\n\tcmd := &Cmd{} //实例化入参对象\n\tflag.Usage = printUsage //设置用法说明\n\tflag.BoolVar(&cmd.helpFlag,\"help\",false,\"print help message\") //参数为help时，&cmd.helpFlag = true\n\tflag.BoolVar(&cmd.helpFlag,\"?\",false,\"print help message\") //参数为?时，&cmd.helpFlag = true\n\tflag.BoolVar(&cmd.versionFlag,\"version\",false,\"print version and exit\") //参数为version时，&cmd.versionFlag = true\n\tflag.StringVar(&cmd.cpOption,\"cp\",\"\",\"classpath\") //参数为version时，&cmd.versionFlag = true\n\tflag.StringVar(&cmd.cpOption,\"classpath\",\"\",\"classpath\")\n\tflag.StringVar(&cmd.XjreOption,\"Xjre\",\"\",\"path to jres\")\n\tflag.Parse()\n\targs := flag.Args()\n\tif len(args) > 0 {\n\t\tcmd.class = args[0]\n\t\tcmd.args = args[1:]\n\t}\n\treturn cmd\n}\n\nfunc printUsage() {\n\tfmt.Printf(\"Usage: %s [-options] class [args...]\\n\",os.Args[0])\n}\n{% endcodeblock %}\n\n3. 启动方法\n\n\n{% codeblock lang:go %}\nfunc main () {\n\tcmd := parseCmd() //解析方法\n\tif cmd.versionFlag {\n\t\tfmt.Println(\"version 0.0.1\") //入参为version时打印版本号\n\t} else if cmd.helpFlag || cmd.class == \"\" {\n\t\tprintUsage() //入参为help或?或classpath、cp为空时打印说明\n\t}else {\n\t\tstartJVM(cmd) //启动JVM\n\t}\n}\n\nfunc startJVM(cmd *Cmd){\n\tfmt.Printf(\"classpath:%s class:%s args:%v\",cmd.cpOption,cmd.class,cmd.args)\n}\n{% endcodeblock %}\n\n4. 试运行\n\n{% codeblock lang:shell %}\nD:\\work\\workspace_go\\src\\jvmgo\\ch01> go install\n\nPS D:\\work\\workspace_go\\bin> .\\ch01.exe -version\nversion 0.0.1\n\nPS D:\\work\\workspace_go\\bin> .\\ch01.exe -help\nUsage: D:\\work\\workspace_go\\bin\\ch01.exe [-options] class [args...]\n\nPS D:\\work\\workspace_go\\bin> .\\ch01.exe -cp test.class a b c\nclasspath:test.class class:a args:[b c]\n{% endcodeblock %}","source":"_posts/自己动手写Java虚拟机-笔记1.md","raw":"---\ntitle: 自己动手写Java虚拟机 笔记1\ndate: 2019-09-09 22:18:50\ntags: \n    - JVM\n    - Java\n    - Go\ncategories :\n    - Technology\n---\n\n## 环境配置\n1. 安装Golang\n   \n{% blockquote %}\nhttps://golang.google.cn/\n{% endblockquote %}\n\n2. 设置Go环境变量\n\n![01](自己动手写Java虚拟机-笔记1/gopath.png)\n\n同时要注意，go的工作目录为该目录，如果需要切换需要改变此路径，不然可使用GoLand等ide切换。\n<!-- more -->\n\n## 简单实现java命令\njava SDK自带很多命令，如java、javac、javap等。\njava命令是其中最终要的一个，平时我们启动一个jar，如springboot工程。还是一个基于tomcat、weblogic、jboss的war包。其根本都是利用java命令执行main方法为入口。\n\n{% codeblock %}\njava [-options] class [args]\njava [-options] -jar jarfile [args]\njavaw [-options] class [args]\njavaw [-options] -jar jarfile [args]\n{% endcodeblock %}\n\n{% blockquote %}\n官方说明：  https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html\n{% endblockquote %}\n\n## 用Go实现java命令的参数读取\n1. java命令入参结构\n\n{% codeblock lang:go %}\ntype Cmd struct {\n\thelpFlag bool //命令为help 或 ? 时：true\n\tversionFlag bool //命令是否为version时：true\n\tcpOption string //命令为cp 或 classpath时，保存值\n\tXjreOption string //命令为Xjre时，保存值\n\tclass string //保存class\n\targs []string //保存其他入参\n}\n{% endcodeblock %}\n\n2. 解析入参\n\n{% codeblock lang:go %}\nfunc parseCmd() *Cmd {\n\tcmd := &Cmd{} //实例化入参对象\n\tflag.Usage = printUsage //设置用法说明\n\tflag.BoolVar(&cmd.helpFlag,\"help\",false,\"print help message\") //参数为help时，&cmd.helpFlag = true\n\tflag.BoolVar(&cmd.helpFlag,\"?\",false,\"print help message\") //参数为?时，&cmd.helpFlag = true\n\tflag.BoolVar(&cmd.versionFlag,\"version\",false,\"print version and exit\") //参数为version时，&cmd.versionFlag = true\n\tflag.StringVar(&cmd.cpOption,\"cp\",\"\",\"classpath\") //参数为version时，&cmd.versionFlag = true\n\tflag.StringVar(&cmd.cpOption,\"classpath\",\"\",\"classpath\")\n\tflag.StringVar(&cmd.XjreOption,\"Xjre\",\"\",\"path to jres\")\n\tflag.Parse()\n\targs := flag.Args()\n\tif len(args) > 0 {\n\t\tcmd.class = args[0]\n\t\tcmd.args = args[1:]\n\t}\n\treturn cmd\n}\n\nfunc printUsage() {\n\tfmt.Printf(\"Usage: %s [-options] class [args...]\\n\",os.Args[0])\n}\n{% endcodeblock %}\n\n3. 启动方法\n\n\n{% codeblock lang:go %}\nfunc main () {\n\tcmd := parseCmd() //解析方法\n\tif cmd.versionFlag {\n\t\tfmt.Println(\"version 0.0.1\") //入参为version时打印版本号\n\t} else if cmd.helpFlag || cmd.class == \"\" {\n\t\tprintUsage() //入参为help或?或classpath、cp为空时打印说明\n\t}else {\n\t\tstartJVM(cmd) //启动JVM\n\t}\n}\n\nfunc startJVM(cmd *Cmd){\n\tfmt.Printf(\"classpath:%s class:%s args:%v\",cmd.cpOption,cmd.class,cmd.args)\n}\n{% endcodeblock %}\n\n4. 试运行\n\n{% codeblock lang:shell %}\nD:\\work\\workspace_go\\src\\jvmgo\\ch01> go install\n\nPS D:\\work\\workspace_go\\bin> .\\ch01.exe -version\nversion 0.0.1\n\nPS D:\\work\\workspace_go\\bin> .\\ch01.exe -help\nUsage: D:\\work\\workspace_go\\bin\\ch01.exe [-options] class [args...]\n\nPS D:\\work\\workspace_go\\bin> .\\ch01.exe -cp test.class a b c\nclasspath:test.class class:a args:[b c]\n{% endcodeblock %}","slug":"自己动手写Java虚拟机-笔记1","published":1,"updated":"2020-12-14T10:35:49.430Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71hts001nv252hbb3dttk","content":"<html><head></head><body><h2 id=\"&#x73AF;&#x5883;&#x914D;&#x7F6E;\"><a href=\"#&#x73AF;&#x5883;&#x914D;&#x7F6E;\" class=\"headerlink\" title=\"&#x73AF;&#x5883;&#x914D;&#x7F6E;\"></a>&#x73AF;&#x5883;&#x914D;&#x7F6E;</h2><ol>\n<li>&#x5B89;&#x88C5;Golang</li>\n</ol>\n<blockquote><p><a href=\"https://golang.google.cn/\">https://golang.google.cn/</a></p>\n</blockquote>\n\n<ol start=\"2\">\n<li>&#x8BBE;&#x7F6E;Go&#x73AF;&#x5883;&#x53D8;&#x91CF;</li>\n</ol>\n<p><img src=\"/2019/09/09/%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%E5%86%99Java%E8%99%9A%E6%8B%9F%E6%9C%BA-%E7%AC%94%E8%AE%B01/gopath.png\" alt=\"01\"></p>\n<p>&#x540C;&#x65F6;&#x8981;&#x6CE8;&#x610F;&#xFF0C;go&#x7684;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;&#x4E3A;&#x8BE5;&#x76EE;&#x5F55;&#xFF0C;&#x5982;&#x679C;&#x9700;&#x8981;&#x5207;&#x6362;&#x9700;&#x8981;&#x6539;&#x53D8;&#x6B64;&#x8DEF;&#x5F84;&#xFF0C;&#x4E0D;&#x7136;&#x53EF;&#x4F7F;&#x7528;GoLand&#x7B49;ide&#x5207;&#x6362;&#x3002;</p>\n<a id=\"more\"></a>\n\n<h2 id=\"&#x7B80;&#x5355;&#x5B9E;&#x73B0;java&#x547D;&#x4EE4;\"><a href=\"#&#x7B80;&#x5355;&#x5B9E;&#x73B0;java&#x547D;&#x4EE4;\" class=\"headerlink\" title=\"&#x7B80;&#x5355;&#x5B9E;&#x73B0;java&#x547D;&#x4EE4;\"></a>&#x7B80;&#x5355;&#x5B9E;&#x73B0;java&#x547D;&#x4EE4;</h2><p>java SDK&#x81EA;&#x5E26;&#x5F88;&#x591A;&#x547D;&#x4EE4;&#xFF0C;&#x5982;java&#x3001;javac&#x3001;javap&#x7B49;&#x3002;<br>java&#x547D;&#x4EE4;&#x662F;&#x5176;&#x4E2D;&#x6700;&#x7EC8;&#x8981;&#x7684;&#x4E00;&#x4E2A;&#xFF0C;&#x5E73;&#x65F6;&#x6211;&#x4EEC;&#x542F;&#x52A8;&#x4E00;&#x4E2A;jar&#xFF0C;&#x5982;springboot&#x5DE5;&#x7A0B;&#x3002;&#x8FD8;&#x662F;&#x4E00;&#x4E2A;&#x57FA;&#x4E8E;tomcat&#x3001;weblogic&#x3001;jboss&#x7684;war&#x5305;&#x3002;&#x5176;&#x6839;&#x672C;&#x90FD;&#x662F;&#x5229;&#x7528;java&#x547D;&#x4EE4;&#x6267;&#x884C;main&#x65B9;&#x6CD5;&#x4E3A;&#x5165;&#x53E3;&#x3002;</p>\n<figure class=\"highlight plain hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java [-options] class [args]</span><br><span class=\"line\">java [-options] -jar jarfile [args]</span><br><span class=\"line\">javaw [-options] class [args]</span><br><span class=\"line\">javaw [-options] -jar jarfile [args]</span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote><p>&#x5B98;&#x65B9;&#x8BF4;&#x660E;&#xFF1A;  <a href=\"https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html\">https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html</a></p>\n</blockquote>\n\n<h2 id=\"&#x7528;Go&#x5B9E;&#x73B0;java&#x547D;&#x4EE4;&#x7684;&#x53C2;&#x6570;&#x8BFB;&#x53D6;\"><a href=\"#&#x7528;Go&#x5B9E;&#x73B0;java&#x547D;&#x4EE4;&#x7684;&#x53C2;&#x6570;&#x8BFB;&#x53D6;\" class=\"headerlink\" title=\"&#x7528;Go&#x5B9E;&#x73B0;java&#x547D;&#x4EE4;&#x7684;&#x53C2;&#x6570;&#x8BFB;&#x53D6;\"></a>&#x7528;Go&#x5B9E;&#x73B0;java&#x547D;&#x4EE4;&#x7684;&#x53C2;&#x6570;&#x8BFB;&#x53D6;</h2><ol>\n<li>java&#x547D;&#x4EE4;&#x5165;&#x53C2;&#x7ED3;&#x6784;</li>\n</ol>\n<figure class=\"highlight go hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> Cmd <span class=\"hljs-keyword\">struct</span> {</span><br><span class=\"line\">\thelpFlag <span class=\"hljs-keyword\">bool</span> <span class=\"hljs-comment\">//&#x547D;&#x4EE4;&#x4E3A;help &#x6216; ? &#x65F6;&#xFF1A;true</span></span><br><span class=\"line\">\tversionFlag <span class=\"hljs-keyword\">bool</span> <span class=\"hljs-comment\">//&#x547D;&#x4EE4;&#x662F;&#x5426;&#x4E3A;version&#x65F6;&#xFF1A;true</span></span><br><span class=\"line\">\tcpOption <span class=\"hljs-keyword\">string</span> <span class=\"hljs-comment\">//&#x547D;&#x4EE4;&#x4E3A;cp &#x6216; classpath&#x65F6;&#xFF0C;&#x4FDD;&#x5B58;&#x503C;</span></span><br><span class=\"line\">\tXjreOption <span class=\"hljs-keyword\">string</span> <span class=\"hljs-comment\">//&#x547D;&#x4EE4;&#x4E3A;Xjre&#x65F6;&#xFF0C;&#x4FDD;&#x5B58;&#x503C;</span></span><br><span class=\"line\">\tclass <span class=\"hljs-keyword\">string</span> <span class=\"hljs-comment\">//&#x4FDD;&#x5B58;class</span></span><br><span class=\"line\">\targs []<span class=\"hljs-keyword\">string</span> <span class=\"hljs-comment\">//&#x4FDD;&#x5B58;&#x5176;&#x4ED6;&#x5165;&#x53C2;</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<ol start=\"2\">\n<li>&#x89E3;&#x6790;&#x5165;&#x53C2;</li>\n</ol>\n<figure class=\"highlight go hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">parseCmd</span><span class=\"hljs-params\">()</span> *<span class=\"hljs-title\">Cmd</span></span> {</span><br><span class=\"line\">\tcmd := &amp;Cmd{} <span class=\"hljs-comment\">//&#x5B9E;&#x4F8B;&#x5316;&#x5165;&#x53C2;&#x5BF9;&#x8C61;</span></span><br><span class=\"line\">\tflag.Usage = printUsage <span class=\"hljs-comment\">//&#x8BBE;&#x7F6E;&#x7528;&#x6CD5;&#x8BF4;&#x660E;</span></span><br><span class=\"line\">\tflag.BoolVar(&amp;cmd.helpFlag,<span class=\"hljs-string\">&quot;help&quot;</span>,<span class=\"hljs-literal\">false</span>,<span class=\"hljs-string\">&quot;print help message&quot;</span>) <span class=\"hljs-comment\">//&#x53C2;&#x6570;&#x4E3A;help&#x65F6;&#xFF0C;&amp;cmd.helpFlag = true</span></span><br><span class=\"line\">\tflag.BoolVar(&amp;cmd.helpFlag,<span class=\"hljs-string\">&quot;?&quot;</span>,<span class=\"hljs-literal\">false</span>,<span class=\"hljs-string\">&quot;print help message&quot;</span>) <span class=\"hljs-comment\">//&#x53C2;&#x6570;&#x4E3A;?&#x65F6;&#xFF0C;&amp;cmd.helpFlag = true</span></span><br><span class=\"line\">\tflag.BoolVar(&amp;cmd.versionFlag,<span class=\"hljs-string\">&quot;version&quot;</span>,<span class=\"hljs-literal\">false</span>,<span class=\"hljs-string\">&quot;print version and exit&quot;</span>) <span class=\"hljs-comment\">//&#x53C2;&#x6570;&#x4E3A;version&#x65F6;&#xFF0C;&amp;cmd.versionFlag = true</span></span><br><span class=\"line\">\tflag.StringVar(&amp;cmd.cpOption,<span class=\"hljs-string\">&quot;cp&quot;</span>,<span class=\"hljs-string\">&quot;&quot;</span>,<span class=\"hljs-string\">&quot;classpath&quot;</span>) <span class=\"hljs-comment\">//&#x53C2;&#x6570;&#x4E3A;version&#x65F6;&#xFF0C;&amp;cmd.versionFlag = true</span></span><br><span class=\"line\">\tflag.StringVar(&amp;cmd.cpOption,<span class=\"hljs-string\">&quot;classpath&quot;</span>,<span class=\"hljs-string\">&quot;&quot;</span>,<span class=\"hljs-string\">&quot;classpath&quot;</span>)</span><br><span class=\"line\">\tflag.StringVar(&amp;cmd.XjreOption,<span class=\"hljs-string\">&quot;Xjre&quot;</span>,<span class=\"hljs-string\">&quot;&quot;</span>,<span class=\"hljs-string\">&quot;path to jres&quot;</span>)</span><br><span class=\"line\">\tflag.Parse()</span><br><span class=\"line\">\targs := flag.Args()</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">len</span>(args) &gt; <span class=\"hljs-number\">0</span> {</span><br><span class=\"line\">\t\tcmd.class = args[<span class=\"hljs-number\">0</span>]</span><br><span class=\"line\">\t\tcmd.args = args[<span class=\"hljs-number\">1</span>:]</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> cmd</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">printUsage</span><span class=\"hljs-params\">()</span></span> {</span><br><span class=\"line\">\tfmt.Printf(<span class=\"hljs-string\">&quot;Usage: %s [-options] class [args...]\\n&quot;</span>,os.Args[<span class=\"hljs-number\">0</span>])</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<ol start=\"3\">\n<li>&#x542F;&#x52A8;&#x65B9;&#x6CD5;</li>\n</ol>\n<figure class=\"highlight go hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">main</span> <span class=\"hljs-params\">()</span></span> {</span><br><span class=\"line\">\tcmd := parseCmd() <span class=\"hljs-comment\">//&#x89E3;&#x6790;&#x65B9;&#x6CD5;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> cmd.versionFlag {</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"hljs-string\">&quot;version 0.0.1&quot;</span>) <span class=\"hljs-comment\">//&#x5165;&#x53C2;&#x4E3A;version&#x65F6;&#x6253;&#x5370;&#x7248;&#x672C;&#x53F7;</span></span><br><span class=\"line\">\t} <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> cmd.helpFlag || cmd.class == <span class=\"hljs-string\">&quot;&quot;</span> {</span><br><span class=\"line\">\t\tprintUsage() <span class=\"hljs-comment\">//&#x5165;&#x53C2;&#x4E3A;help&#x6216;?&#x6216;classpath&#x3001;cp&#x4E3A;&#x7A7A;&#x65F6;&#x6253;&#x5370;&#x8BF4;&#x660E;</span></span><br><span class=\"line\">\t}<span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">\t\tstartJVM(cmd) <span class=\"hljs-comment\">//&#x542F;&#x52A8;JVM</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">startJVM</span><span class=\"hljs-params\">(cmd *Cmd)</span></span>{</span><br><span class=\"line\">\tfmt.Printf(<span class=\"hljs-string\">&quot;classpath:%s class:%s args:%v&quot;</span>,cmd.cpOption,cmd.class,cmd.args)</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<ol start=\"4\">\n<li>&#x8BD5;&#x8FD0;&#x884C;</li>\n</ol>\n<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">D:\\work\\workspace_go\\src\\jvmgo\\ch01&gt; go install</span><br><span class=\"line\"></span><br><span class=\"line\">PS D:\\work\\workspace_go\\bin&gt; .\\ch01.exe -version</span><br><span class=\"line\">version 0.0.1</span><br><span class=\"line\"></span><br><span class=\"line\">PS D:\\work\\workspace_go\\bin&gt; .\\ch01.exe -help</span><br><span class=\"line\">Usage: D:\\work\\workspace_go\\bin\\ch01.exe [-options] class [args...]</span><br><span class=\"line\"></span><br><span class=\"line\">PS D:\\work\\workspace_go\\bin&gt; .\\ch01.exe -cp test.class a b c</span><br><span class=\"line\">classpath:test.class class:a args:[b c]</span><br></pre></td></tr></tbody></table></figure></body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"JVM","path":"tags/JVM/"},{"name":"Java","path":"tags/Java/"},{"name":"Go","path":"tags/Go/"}],"excerpt":"<html><head></head><body><h2 id=\"&#x73AF;&#x5883;&#x914D;&#x7F6E;\"><a href=\"#&#x73AF;&#x5883;&#x914D;&#x7F6E;\" class=\"headerlink\" title=\"&#x73AF;&#x5883;&#x914D;&#x7F6E;\"></a>&#x73AF;&#x5883;&#x914D;&#x7F6E;</h2><ol>\n<li>&#x5B89;&#x88C5;Golang</li>\n</ol>\n<blockquote><p><a href=\"https://golang.google.cn/\">https://golang.google.cn/</a></p>\n</blockquote>\n\n<ol start=\"2\">\n<li>&#x8BBE;&#x7F6E;Go&#x73AF;&#x5883;&#x53D8;&#x91CF;</li>\n</ol>\n<p><img src=\"/2019/09/09/%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%E5%86%99Java%E8%99%9A%E6%8B%9F%E6%9C%BA-%E7%AC%94%E8%AE%B01/gopath.png\" alt=\"01\"></p>\n<p>&#x540C;&#x65F6;&#x8981;&#x6CE8;&#x610F;&#xFF0C;go&#x7684;&#x5DE5;&#x4F5C;&#x76EE;&#x5F55;&#x4E3A;&#x8BE5;&#x76EE;&#x5F55;&#xFF0C;&#x5982;&#x679C;&#x9700;&#x8981;&#x5207;&#x6362;&#x9700;&#x8981;&#x6539;&#x53D8;&#x6B64;&#x8DEF;&#x5F84;&#xFF0C;&#x4E0D;&#x7136;&#x53EF;&#x4F7F;&#x7528;GoLand&#x7B49;ide&#x5207;&#x6362;&#x3002;</p></body></html>","more":"<h2 id=\"简单实现java命令\"><a href=\"#简单实现java命令\" class=\"headerlink\" title=\"简单实现java命令\"></a>简单实现java命令</h2><p>java SDK自带很多命令，如java、javac、javap等。<br>java命令是其中最终要的一个，平时我们启动一个jar，如springboot工程。还是一个基于tomcat、weblogic、jboss的war包。其根本都是利用java命令执行main方法为入口。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java [-options] class [args]</span><br><span class=\"line\">java [-options] -jar jarfile [args]</span><br><span class=\"line\">javaw [-options] class [args]</span><br><span class=\"line\">javaw [-options] -jar jarfile [args]</span><br></pre></td></tr></table></figure>\n\n<blockquote><p>官方说明：  <a href=\"https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html\">https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html</a></p>\n</blockquote>\n\n<h2 id=\"用Go实现java命令的参数读取\"><a href=\"#用Go实现java命令的参数读取\" class=\"headerlink\" title=\"用Go实现java命令的参数读取\"></a>用Go实现java命令的参数读取</h2><ol>\n<li>java命令入参结构</li>\n</ol>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Cmd <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\thelpFlag <span class=\"keyword\">bool</span> <span class=\"comment\">//命令为help 或 ? 时：true</span></span><br><span class=\"line\">\tversionFlag <span class=\"keyword\">bool</span> <span class=\"comment\">//命令是否为version时：true</span></span><br><span class=\"line\">\tcpOption <span class=\"keyword\">string</span> <span class=\"comment\">//命令为cp 或 classpath时，保存值</span></span><br><span class=\"line\">\tXjreOption <span class=\"keyword\">string</span> <span class=\"comment\">//命令为Xjre时，保存值</span></span><br><span class=\"line\">\tclass <span class=\"keyword\">string</span> <span class=\"comment\">//保存class</span></span><br><span class=\"line\">\targs []<span class=\"keyword\">string</span> <span class=\"comment\">//保存其他入参</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>解析入参</li>\n</ol>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">parseCmd</span><span class=\"params\">()</span> *<span class=\"title\">Cmd</span></span> &#123;</span><br><span class=\"line\">\tcmd := &amp;Cmd&#123;&#125; <span class=\"comment\">//实例化入参对象</span></span><br><span class=\"line\">\tflag.Usage = printUsage <span class=\"comment\">//设置用法说明</span></span><br><span class=\"line\">\tflag.BoolVar(&amp;cmd.helpFlag,<span class=\"string\">&quot;help&quot;</span>,<span class=\"literal\">false</span>,<span class=\"string\">&quot;print help message&quot;</span>) <span class=\"comment\">//参数为help时，&amp;cmd.helpFlag = true</span></span><br><span class=\"line\">\tflag.BoolVar(&amp;cmd.helpFlag,<span class=\"string\">&quot;?&quot;</span>,<span class=\"literal\">false</span>,<span class=\"string\">&quot;print help message&quot;</span>) <span class=\"comment\">//参数为?时，&amp;cmd.helpFlag = true</span></span><br><span class=\"line\">\tflag.BoolVar(&amp;cmd.versionFlag,<span class=\"string\">&quot;version&quot;</span>,<span class=\"literal\">false</span>,<span class=\"string\">&quot;print version and exit&quot;</span>) <span class=\"comment\">//参数为version时，&amp;cmd.versionFlag = true</span></span><br><span class=\"line\">\tflag.StringVar(&amp;cmd.cpOption,<span class=\"string\">&quot;cp&quot;</span>,<span class=\"string\">&quot;&quot;</span>,<span class=\"string\">&quot;classpath&quot;</span>) <span class=\"comment\">//参数为version时，&amp;cmd.versionFlag = true</span></span><br><span class=\"line\">\tflag.StringVar(&amp;cmd.cpOption,<span class=\"string\">&quot;classpath&quot;</span>,<span class=\"string\">&quot;&quot;</span>,<span class=\"string\">&quot;classpath&quot;</span>)</span><br><span class=\"line\">\tflag.StringVar(&amp;cmd.XjreOption,<span class=\"string\">&quot;Xjre&quot;</span>,<span class=\"string\">&quot;&quot;</span>,<span class=\"string\">&quot;path to jres&quot;</span>)</span><br><span class=\"line\">\tflag.Parse()</span><br><span class=\"line\">\targs := flag.Args()</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(args) &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\tcmd.class = args[<span class=\"number\">0</span>]</span><br><span class=\"line\">\t\tcmd.args = args[<span class=\"number\">1</span>:]</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> cmd</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">printUsage</span><span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">&quot;Usage: %s [-options] class [args...]\\n&quot;</span>,os.Args[<span class=\"number\">0</span>])</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li>启动方法</li>\n</ol>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">main</span> <span class=\"params\">()</span></span> &#123;</span><br><span class=\"line\">\tcmd := parseCmd() <span class=\"comment\">//解析方法</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> cmd.versionFlag &#123;</span><br><span class=\"line\">\t\tfmt.Println(<span class=\"string\">&quot;version 0.0.1&quot;</span>) <span class=\"comment\">//入参为version时打印版本号</span></span><br><span class=\"line\">\t&#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> cmd.helpFlag || cmd.class == <span class=\"string\">&quot;&quot;</span> &#123;</span><br><span class=\"line\">\t\tprintUsage() <span class=\"comment\">//入参为help或?或classpath、cp为空时打印说明</span></span><br><span class=\"line\">\t&#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\tstartJVM(cmd) <span class=\"comment\">//启动JVM</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">startJVM</span><span class=\"params\">(cmd *Cmd)</span></span>&#123;</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">&quot;classpath:%s class:%s args:%v&quot;</span>,cmd.cpOption,cmd.class,cmd.args)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>试运行</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">D:\\work\\workspace_go\\src\\jvmgo\\ch01&gt; go install</span><br><span class=\"line\"></span><br><span class=\"line\">PS D:\\work\\workspace_go\\bin&gt; .\\ch01.exe -version</span><br><span class=\"line\">version 0.0.1</span><br><span class=\"line\"></span><br><span class=\"line\">PS D:\\work\\workspace_go\\bin&gt; .\\ch01.exe -help</span><br><span class=\"line\">Usage: D:\\work\\workspace_go\\bin\\ch01.exe [-options] class [args...]</span><br><span class=\"line\"></span><br><span class=\"line\">PS D:\\work\\workspace_go\\bin&gt; .\\ch01.exe -cp test.class a b c</span><br><span class=\"line\">classpath:test.class class:a args:[b c]</span><br></pre></td></tr></table></figure>"},{"title":"自己动手写Java虚拟机 笔记2","date":"2019-09-10T13:47:52.000Z","_content":"\n## 实现cp/classpath 参数搜索class文件\n\n### java class path 搜索顺序：\n1. 启动类路径（bootstrap classpath）:jre\\lib （可通过-Xbootclasspath参数修改该路径）\n2. 扩展类路径（extension classpath）:jre\\lib\\ext\n3. 用户类路径（user classpath）:用户自己指定\n\n<!-- more -->\n\n### 实现\n1. Entry接口用来定义启动类的基本功能\n\n{% codeblock lang:go %}\nconst pathListSeparator = string(os.PathListSeparator) //获取当前操作系统分隔符\n\ntype Entry interface {\n\treadClass(classNme string) ([]byte,Entry,error) //定义按class名读取class文件的方\n\tString() string \n}\n\n//根据classpath生成对应的启动类\nfunc newEntry(path string) Entry {\n\tif strings.Contains(path,pathListSeparator){ //classpath路径包含系统分割符时，new组合启动类\n\t\treturn newCompositeEntry(path)\n\t}\n\n\tif strings.HasSuffix(path,\"*\") {\n\t\treturn newWildcardEntry(path) //classpath路径包含*时，new通配符启动类\n\t}\n\n\tif strings.HasSuffix(path, \".jar\") || strings.HasSuffix(path, \".JAR\") ||\n      strings.HasSuffix(path, \".zip\") || strings.HasSuffix(path, \".ZIP\") {\n      return newZipEntry(path) //classpath路径包含jar、JAR、zip、ZIP时，new文件夹启动类\n   }\n\treturn newDirEntry(path)\n\n}\n{% endcodeblock %}\n\n2. Entry接口的具体实现\n * DirEntry，按照文件路径读取文件二进制流 \n{% codeblock lang:golang %}\ntype DirEntry struct {\n\tabsDir string //存储文件夹路径\n}\n\nfunc newDirEntry(path string) *DirEntry {\n\tabsDir,err := filepath.Abs(path) //如果文件路径存在，获取文件夹路径\n\tif err != nil {\n\t\tpanic(err) //文件路径不存在时提示错误\n\t}\n\n\treturn &DirEntry{absDir} //返回DirEntry实例\n}\n\nfunc (self *DirEntry) readClass(className string) ([]byte,Entry,error){\n\tfileName := filepath.Join(self.absDir,className) //拼接文件夹路径和classname\n\tdata,err := ioutil.ReadFile(fileName) //读取文件\n\treturn data,self,err //返回文件内容\n}\n\nfunc(self *DirEntry) String() string {\n\treturn self.absDir //返回文件夹路径\n}\n{% endcodeblock %}\n\n * ZipEntry,读取压缩文件夹内的文件\n{% codeblock lang:golang %}\ntype ZipEnty struct {\n\tabsPath string //文件夹路径\n}\n\nfunc newZipEntry(path string) *ZipEnty {\n\tabsPath, err := filepath.Abs(path) //如果文件路径存在，获取文件夹路径\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\treturn &ZipEnty{absPath}\n}\n\nfunc (self *ZipEnty) readClass(className string) ([]byte,Entry,error){\n\tr, err := zip.OpenReader(self.absPath) //以压缩文件格式解压\n\tif err != nil {\n\t   return nil, nil, err\n\t}\n\tdefer r.Close() //最后关闭文件流\n\tfor _, f := range r.File { //循环解压出来的文件\n\t   if f.Name == className { //如果当前文件为指定文件\n\t\t  rc, err := f.Open() //打开该文件\n\t\t  if err != nil {\n\t\t\t return nil, nil, err\n\t\t  }\n\t\t  defer rc.Close() //最后关闭文件\n\t\t  data, err := ioutil.ReadAll(rc) //读取文件流\n\t\t  if err != nil {\n\t\t\t return nil, nil, err\n\t\t  }\n\t\t  return data, self, nil //返回文件流\n\t   }\n\t}\n\treturn nil, nil, errors.New(\"class not found: \" + className)\n}\n\nfunc (self *ZipEnty) String() string {\n\treturn self.absPath\n}\n{% endcodeblock %}\n\n * CompositeEntry,读取符合文件类型\n{% codeblock lang:golang %}\ntype CompositeEntry []Entry //CompositeEntry为多种Entry的数组（Dir、Zip）\n\nfunc newCompositeEntry(pathList string) CompositeEntry {\n\tcompositeEntry := []Entry{} //实例Entry接口数组\n\n\tfor _,path := range strings.Split(pathList,pathListSeparator){ //按照系统分割符截取path列表，并循环\n\t\tentry := newEntry(path) //按照每种path实例化不同的Entry(Dir、Zip、Wildcard)\n\t\tcompositeEntry = append(compositeEntry,entry) //将实例化的不同Entry放入CompositeEntry数组中\n\t}\n\treturn compositeEntry\n}\n\nfunc (self CompositeEntry) readClass(className string)([]byte,Entry,error){\n\tfor _, entry := range self { //循环compositeEntry数组\n\t\tdata, from, err := entry.readClass(className) //根据不同Entry(Dir、Zip、Wildcard)，按指定classname读取文件\n\t\tif err == nil {\n\t\t   return data, from, nil //返回读取结果\n\t\t}\n\t }\n\t return nil, nil, errors.New(\"class not found: \" + className) //无结果是返回错误信息\n}\n\nfunc (self CompositeEntry) String() string {\n\tstrs := make([]string, len(self)) //按照CompositeEntry的长度申明该长度的Sring数组\n\tfor i, entry := range self { //循环CompositeEntry\n\t   strs[i] = entry.String() //调用每个Entry(Dir、Zip、Wildcard)实现类的String()方法,并放入String数组中\n\t}\n\treturn strings.Join(strs, pathListSeparator) //将String数组中的结果以系统分隔符拼接并返回\n}\n{% endcodeblock %}\n\n * WildcardEntry，按照通配符解析文件\n{% codeblock lang:golang %}\nfunc newWildcardEntry(path string) CompositeEntry {\n\tbaseDir := path[:len(path)-1] // remove *\n\tcompositeEntry := []Entry{} //申明compositeEntry对象(Entry的数组)\n\twalkFn := func(path string, info os.FileInfo, err error) error {\n\t\tif err != nil {\n\t\t   return err\n\t\t}\n\t\tif info.IsDir() && path != baseDir { //如果当前目录是文件夹，并且是根目录\n\t\t   return filepath.SkipDir //返回SkipDir的错误\n\t\t}\n\t\tif strings.HasSuffix(path, \".jar\") || strings.HasSuffix(path, \".JAR\") { //如果当前路径是以.jar或.JAR结尾的\n\t\t\tjarEntry := newZipEntry(path) //实例化ZipEntry\n\t\t\tcompositeEntry = append(compositeEntry, jarEntry) //将实例化的ZipEntry对象放入compositeEntry数组中\n\t\t }\n\t\t return nil\n\t  }\n\tfilepath.Walk(baseDir, walkFn) //将walkFn方法传递给filepath.Walk\n\treturn compositeEntry //返回结果\n }\n{% endcodeblock %}\n\n* Classpath，-cp|classpath参数解析实现的入口方法\n{% codeblock lang:golang %}\ntype Classpath struct { //Classpath包含java的三种基础启动路径\n\tbootClasspath Entry \n\textClasspath Entry\n\tuserClasspath Entry\n}\n\nfunc Parse(jreOption, cpOption string) * Classpath  {\n\tcp := &Classpath{} //实例化Classpath对象\n\tcp.parseBootAndExtClasspath(jreOption) //按照-Xjre参数解析Boot和Ext启动路径\n\tcp.parseUserClasspath(cpOption) //按照-cp|classpath参数解析User启动路径\n\treturn cp //返回设置好启动路径的Classpath对象\n}\n\nfunc (self *Classpath) ReadClass(className string) ([]byte,Entry,error){\n\tclassName = className + \".class\" //初始化className文件名\n\tif data, entry, err := self.bootClasspath.readClass(className); err == nil { //先扫描Boot启动路径下是否存在该className.class文件\n\t   return data, entry, err //存在则返回\n\t}\n\tif data, entry, err := self.extClasspath.readClass(className); err == nil { //再扫描Ext启动路径下是否存在该className.class文件\n\t   return data, entry, err //存在则返回\n\t}\n\treturn self.userClasspath.readClass(className) //以上两个路径下都不存在，则扫描User启动路径\n}\n\nfunc (self *Classpath) String() string  {\n\treturn self.userClasspath.String()\n}\n\nfunc (self *Classpath) parseBootAndExtClasspath(jreOption string) { //按照-Xjre参数解析Boot和Ext启动路径\n\tjreDir := getJreDir(jreOption) //获取jre路径\n   // jre/lib/*\n   jreLibPath := filepath.Join(jreDir, \"lib\", \"*\")\n   self.bootClasspath = newWildcardEntry(jreLibPath)\n   // jre/lib/ext/*\n   jreExtPath := filepath.Join(jreDir, \"lib\", \"ext\", \"*\")\n   self.extClasspath = newWildcardEntry(jreExtPath)\n}\n\nfunc getJreDir(jreOption string) string {\n\tif jreOption != \"\" && exists(jreOption) { //jreOption不为空且存在时返回该路径\n\t   return jreOption\n\t}\n\tif exists(\"./jre\") { //./jre路径存在时，返回.jre\n\t   return \"./jre\"\n\t}\n\tif jh := os.Getenv(\"JAVA_HOME\"); jh != \"\" { //环境变量JAVA_HOME存在并且不为空时\n\t   return filepath.Join(jh, \"jre\") //返回JAVA_HOME + \"jre\"\n\t}\n\tpanic(\"Can not find jre folder!\")\n }\n\n func exists(path string) bool {\n\tif _, err := os.Stat(path); err != nil {\n\t   if os.IsNotExist(err) {\n\t\t  return false\n\t   }\n\t}\n\treturn true\n }\n\n func (self *Classpath) parseUserClasspath(cpOption string) { //按照-cp|classpath参数解析User启动参数\n\tif cpOption == \"\" { //cpOption为空时\n\t   cpOption = \".\" //返回相对路劲\n\t}\n\tself.userClasspath = newEntry(cpOption) //根据-cp|classpath参数实例化对应的Entry\n }\n{% endcodeblock %}\n\n * main，修改启动类\n{% codeblock lang:golang %}\nfunc startJVM(cmd *Cmd){\n\tcp := classpath.Parse(cmd.XjreOption, cmd.cpOption) //根据-Xjre和-cp|classpath参数实例化classpath对象实例\n\tfmt.Printf(\"classpath:%v class:%v args:%v\\n\",\n\t   cp, cmd.class, cmd.args)\n\tclassName := strings.Replace(cmd.class, \".\", \"/\", -1)\n\tclassData, _, err := cp.ReadClass(className) //按照3个启动路径查找并读取className文件\n\tif err != nil {\n\t   fmt.Printf(\"Could not find or load main class %s\\n\", cmd.class)\n\t   return\n\t}\n\tfmt.Printf(\"class data:%v\\n\", classData)\n}\n{% endcodeblock %}\n\n3. 试运行\n{% codeblock lang:shell %}\nPS D:\\work\\workspace_go\\src\\jvmgo\\ch02> go install\n\nPS D:\\work\\workspace_go\\bin> .\\ch02.exe -Xjre \"C:\\Program Files\\Java\\jre1.8.0_202\" java.lang.Object\nclasspath:D:\\work\\workspace_go\\bin class:java.lang.Object args:[]\nclass data:[202 254 186 190 0 0 0 52 0 75 3 0 15 66 63 8 0 16 8 0 36 8 0 40 1 0 3 40 41 73 1 0 20 40 41 76 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 59 1 0 20 40 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 1 0 3 40 41 86 1 0 21 40 73 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 1 0 4 40 74 41 86 1 0 5 40 74 73 41 86 1 0 21 40 76 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 59 41 90 1 0 21 40 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 41 86 1 0 8 60 99 108 105 110 105 116 62 1 0 6 60 105 110 105 116 62 1 0 1 64 1 0 4 67 111 100\n101 1 0 10 69 120 99 101 112 116 105 111 110 115 1 0 9 83 105 103 110 97 116 117 114 101 1 0 13 83 116 97 99 107 77 97 112 84 97 98 108 101 1 0 6 97 112 112 101 110 100 1 0 5 99 108 111 110 101 1 0 6 101 113\n117 97 108 115 1 0 8 102 105 110 97 108 105 122 101 1 0 8 103 101 116 67 108 97 115 115 1 0 7 103 101 116 78 97 109 101 1 0 8 104 97 115 104 67 111 100 101 1 0 15 106 97 118 97 47 108 97 110 103 47 67 108 97\n115 115 1 0 36 106 97 118 97 47 108 97 110 103 47 67 108 111 110 101 78 111 116 83 117 112 112 111 114 116 101 100 69 120 99 101 112 116 105 111 110 1 0 34 106 97 118 97 47 108 97 110 103 47 73 108 108 101 103 97 108 65 114 103 117 109 101 110 116 69 120 99 101 112 116 105 111 110 1 0 17 106 97 118 97 47 108 97 110 103 47 73 110 116 101 103 101 114 1 0 30 106 97 118 97 47 108 97 110 103 47 73 110 116 101 114 114\n117 112 116 101 100 69 120 99 101 112 116 105 111 110 1 0 16 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 1 0 23 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 66 117 105 108 100 101 114 1 0 19 106 97 118 97 47 108 97 110 103 47 84 104 114 111 119 97 98 108 101 1 0 37 110 97 110 111 115 101 99 111 110 100 32 116 105 109 101 111 117 116 32 118 97 108 117 101 32 111 117 116 32 111 102 32 114 97 110 103 101 1 0 6 110 111 116 105 102 121 1 0 9 110 111 116 105 102 121 65 108 108 1 0 15 114 101 103 105 115 116 101 114 78 97 116 105 118 101 115 1 0 25 116 105 109 101 111 117 116 32 118 97 108 117 101 32 105 115 32 110 101 103 97 116 105 118 101 1 0 11 116 111 72 101 120 83 116 114 105 110 103 1 0 8 116 111 83 116 114 105 110 103 1 0 4 119 97 105 116 7 0 28 7 0 29 7 0 30 7 0 31 7 0 32 7 0 33 7 0 34 7 0 35 1 0 19 40 41 76 106 97 118 97 47 108 97 110 103 47 67 108 97 115 115 59 1 0 22 40 41 76 106 97 118 97 47 108 97 110 103 47 67 108 97 115 115 60 42 62 59 1 0 45 40 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 66 117 105 108 100 101 114 59 12 0 27 0 5 12 0 15 0 8 12 0 39 0 8 12 0 43 0 10 12 0 25 0 52 12 0 26 0 7 12 0 42 0 7 12 0 41 0\n9 12 0 15 0 13 12 0 21 0 54 10 0 44 0 60 10 0 46 0 63 10 0 47 0 62 10 0 49 0 55 10 0 49 0 57 10 0 49 0 58 10 0 49 0 59 10 0 50 0 56 10 0 50 0 61 10 0 50 0 64 0 33 0 49 0 0 0 0 0 0 0 14 0 1 0 15 0 8 0 1 0 17 0 0 0 13 0 0 0 1 0 0 0 1 177 0 0 0 0 1 10 0 39 0 8 0 0 1 17 0 25 0 52 0 1 0 19 0 0 0 2 0 53 1 1 0 27 0 5 0 0 0 1 0 23 0 12 0 1 0 17 0 0 0 34 0 2 0 2 0 0 0 11 42 43 166 0 7 4 167 0 4 3 172 0 0 0 1 0 20 0 0 0 5\n0 2 9 64 1 1 4 0 22 0 6 0 1 0 18 0 0 0 4 0 1 0 45 0 1 0 42 0 7 0 1 0 17 0 0 0 48 0 2 0 1 0 0 0 36 187 0 50 89 183 0 72 42 182 0 71 182 0 65 182 0 74 18 2 182 0 74 42 182 0 68 184 0 67 182 0 74 182 0 73 176 0\n0 0 0 1 17 0 37 0 8 0 0 1 17 0 38 0 8 0 0 1 17 0 43 0 10 0 1 0 18 0 0 0 4 0 1 0 48 0 17 0 43 0 11 0 2 0 17 0 0 0 74 0 4 0 4 0 0 0 50 31 9 148 156 0 13 187 0 46 89 18 4 183 0 66 191 29 155 0 9 29 18 1 164 0 13 187 0 46 89 18 3 183 0 66 191 29 158 0 7 31 10 97 64 42 31 182 0 70 177 0 0 0 1 0 20 0 0 0 6 0 4 16 9 9 7 0 18 0 0 0 4 0 1 0 48 0 17 0 43 0 8 0 2 0 17 0 0 0 18 0 3 0 1 0 0 0 6 42 9 182 0 70 177 0 0 0 0 0 18\n0 0 0 4 0 1 0 48 0 4 0 24 0 8 0 2 0 17 0 0 0 13 0 0 0 1 0 0 0 1 177 0 0 0 0 0 18 0 0 0 4 0 1 0 51 0 8 0 14 0 8 0 1 0 17 0 0 0 16 0 0 0 0 0 0 0 4 184 0 69 177 0 0 0 0 0 0]\n{% endcodeblock %}\n","source":"_posts/自己动手写Java虚拟机-笔记2.md","raw":"---\ntitle: 自己动手写Java虚拟机 笔记2\ndate: 2019-09-10 21:47:52\ntags: \n    - JVM\n    - Java\n    - Go\ncategories :\n    - Technology\n---\n\n## 实现cp/classpath 参数搜索class文件\n\n### java class path 搜索顺序：\n1. 启动类路径（bootstrap classpath）:jre\\lib （可通过-Xbootclasspath参数修改该路径）\n2. 扩展类路径（extension classpath）:jre\\lib\\ext\n3. 用户类路径（user classpath）:用户自己指定\n\n<!-- more -->\n\n### 实现\n1. Entry接口用来定义启动类的基本功能\n\n{% codeblock lang:go %}\nconst pathListSeparator = string(os.PathListSeparator) //获取当前操作系统分隔符\n\ntype Entry interface {\n\treadClass(classNme string) ([]byte,Entry,error) //定义按class名读取class文件的方\n\tString() string \n}\n\n//根据classpath生成对应的启动类\nfunc newEntry(path string) Entry {\n\tif strings.Contains(path,pathListSeparator){ //classpath路径包含系统分割符时，new组合启动类\n\t\treturn newCompositeEntry(path)\n\t}\n\n\tif strings.HasSuffix(path,\"*\") {\n\t\treturn newWildcardEntry(path) //classpath路径包含*时，new通配符启动类\n\t}\n\n\tif strings.HasSuffix(path, \".jar\") || strings.HasSuffix(path, \".JAR\") ||\n      strings.HasSuffix(path, \".zip\") || strings.HasSuffix(path, \".ZIP\") {\n      return newZipEntry(path) //classpath路径包含jar、JAR、zip、ZIP时，new文件夹启动类\n   }\n\treturn newDirEntry(path)\n\n}\n{% endcodeblock %}\n\n2. Entry接口的具体实现\n * DirEntry，按照文件路径读取文件二进制流 \n{% codeblock lang:golang %}\ntype DirEntry struct {\n\tabsDir string //存储文件夹路径\n}\n\nfunc newDirEntry(path string) *DirEntry {\n\tabsDir,err := filepath.Abs(path) //如果文件路径存在，获取文件夹路径\n\tif err != nil {\n\t\tpanic(err) //文件路径不存在时提示错误\n\t}\n\n\treturn &DirEntry{absDir} //返回DirEntry实例\n}\n\nfunc (self *DirEntry) readClass(className string) ([]byte,Entry,error){\n\tfileName := filepath.Join(self.absDir,className) //拼接文件夹路径和classname\n\tdata,err := ioutil.ReadFile(fileName) //读取文件\n\treturn data,self,err //返回文件内容\n}\n\nfunc(self *DirEntry) String() string {\n\treturn self.absDir //返回文件夹路径\n}\n{% endcodeblock %}\n\n * ZipEntry,读取压缩文件夹内的文件\n{% codeblock lang:golang %}\ntype ZipEnty struct {\n\tabsPath string //文件夹路径\n}\n\nfunc newZipEntry(path string) *ZipEnty {\n\tabsPath, err := filepath.Abs(path) //如果文件路径存在，获取文件夹路径\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\treturn &ZipEnty{absPath}\n}\n\nfunc (self *ZipEnty) readClass(className string) ([]byte,Entry,error){\n\tr, err := zip.OpenReader(self.absPath) //以压缩文件格式解压\n\tif err != nil {\n\t   return nil, nil, err\n\t}\n\tdefer r.Close() //最后关闭文件流\n\tfor _, f := range r.File { //循环解压出来的文件\n\t   if f.Name == className { //如果当前文件为指定文件\n\t\t  rc, err := f.Open() //打开该文件\n\t\t  if err != nil {\n\t\t\t return nil, nil, err\n\t\t  }\n\t\t  defer rc.Close() //最后关闭文件\n\t\t  data, err := ioutil.ReadAll(rc) //读取文件流\n\t\t  if err != nil {\n\t\t\t return nil, nil, err\n\t\t  }\n\t\t  return data, self, nil //返回文件流\n\t   }\n\t}\n\treturn nil, nil, errors.New(\"class not found: \" + className)\n}\n\nfunc (self *ZipEnty) String() string {\n\treturn self.absPath\n}\n{% endcodeblock %}\n\n * CompositeEntry,读取符合文件类型\n{% codeblock lang:golang %}\ntype CompositeEntry []Entry //CompositeEntry为多种Entry的数组（Dir、Zip）\n\nfunc newCompositeEntry(pathList string) CompositeEntry {\n\tcompositeEntry := []Entry{} //实例Entry接口数组\n\n\tfor _,path := range strings.Split(pathList,pathListSeparator){ //按照系统分割符截取path列表，并循环\n\t\tentry := newEntry(path) //按照每种path实例化不同的Entry(Dir、Zip、Wildcard)\n\t\tcompositeEntry = append(compositeEntry,entry) //将实例化的不同Entry放入CompositeEntry数组中\n\t}\n\treturn compositeEntry\n}\n\nfunc (self CompositeEntry) readClass(className string)([]byte,Entry,error){\n\tfor _, entry := range self { //循环compositeEntry数组\n\t\tdata, from, err := entry.readClass(className) //根据不同Entry(Dir、Zip、Wildcard)，按指定classname读取文件\n\t\tif err == nil {\n\t\t   return data, from, nil //返回读取结果\n\t\t}\n\t }\n\t return nil, nil, errors.New(\"class not found: \" + className) //无结果是返回错误信息\n}\n\nfunc (self CompositeEntry) String() string {\n\tstrs := make([]string, len(self)) //按照CompositeEntry的长度申明该长度的Sring数组\n\tfor i, entry := range self { //循环CompositeEntry\n\t   strs[i] = entry.String() //调用每个Entry(Dir、Zip、Wildcard)实现类的String()方法,并放入String数组中\n\t}\n\treturn strings.Join(strs, pathListSeparator) //将String数组中的结果以系统分隔符拼接并返回\n}\n{% endcodeblock %}\n\n * WildcardEntry，按照通配符解析文件\n{% codeblock lang:golang %}\nfunc newWildcardEntry(path string) CompositeEntry {\n\tbaseDir := path[:len(path)-1] // remove *\n\tcompositeEntry := []Entry{} //申明compositeEntry对象(Entry的数组)\n\twalkFn := func(path string, info os.FileInfo, err error) error {\n\t\tif err != nil {\n\t\t   return err\n\t\t}\n\t\tif info.IsDir() && path != baseDir { //如果当前目录是文件夹，并且是根目录\n\t\t   return filepath.SkipDir //返回SkipDir的错误\n\t\t}\n\t\tif strings.HasSuffix(path, \".jar\") || strings.HasSuffix(path, \".JAR\") { //如果当前路径是以.jar或.JAR结尾的\n\t\t\tjarEntry := newZipEntry(path) //实例化ZipEntry\n\t\t\tcompositeEntry = append(compositeEntry, jarEntry) //将实例化的ZipEntry对象放入compositeEntry数组中\n\t\t }\n\t\t return nil\n\t  }\n\tfilepath.Walk(baseDir, walkFn) //将walkFn方法传递给filepath.Walk\n\treturn compositeEntry //返回结果\n }\n{% endcodeblock %}\n\n* Classpath，-cp|classpath参数解析实现的入口方法\n{% codeblock lang:golang %}\ntype Classpath struct { //Classpath包含java的三种基础启动路径\n\tbootClasspath Entry \n\textClasspath Entry\n\tuserClasspath Entry\n}\n\nfunc Parse(jreOption, cpOption string) * Classpath  {\n\tcp := &Classpath{} //实例化Classpath对象\n\tcp.parseBootAndExtClasspath(jreOption) //按照-Xjre参数解析Boot和Ext启动路径\n\tcp.parseUserClasspath(cpOption) //按照-cp|classpath参数解析User启动路径\n\treturn cp //返回设置好启动路径的Classpath对象\n}\n\nfunc (self *Classpath) ReadClass(className string) ([]byte,Entry,error){\n\tclassName = className + \".class\" //初始化className文件名\n\tif data, entry, err := self.bootClasspath.readClass(className); err == nil { //先扫描Boot启动路径下是否存在该className.class文件\n\t   return data, entry, err //存在则返回\n\t}\n\tif data, entry, err := self.extClasspath.readClass(className); err == nil { //再扫描Ext启动路径下是否存在该className.class文件\n\t   return data, entry, err //存在则返回\n\t}\n\treturn self.userClasspath.readClass(className) //以上两个路径下都不存在，则扫描User启动路径\n}\n\nfunc (self *Classpath) String() string  {\n\treturn self.userClasspath.String()\n}\n\nfunc (self *Classpath) parseBootAndExtClasspath(jreOption string) { //按照-Xjre参数解析Boot和Ext启动路径\n\tjreDir := getJreDir(jreOption) //获取jre路径\n   // jre/lib/*\n   jreLibPath := filepath.Join(jreDir, \"lib\", \"*\")\n   self.bootClasspath = newWildcardEntry(jreLibPath)\n   // jre/lib/ext/*\n   jreExtPath := filepath.Join(jreDir, \"lib\", \"ext\", \"*\")\n   self.extClasspath = newWildcardEntry(jreExtPath)\n}\n\nfunc getJreDir(jreOption string) string {\n\tif jreOption != \"\" && exists(jreOption) { //jreOption不为空且存在时返回该路径\n\t   return jreOption\n\t}\n\tif exists(\"./jre\") { //./jre路径存在时，返回.jre\n\t   return \"./jre\"\n\t}\n\tif jh := os.Getenv(\"JAVA_HOME\"); jh != \"\" { //环境变量JAVA_HOME存在并且不为空时\n\t   return filepath.Join(jh, \"jre\") //返回JAVA_HOME + \"jre\"\n\t}\n\tpanic(\"Can not find jre folder!\")\n }\n\n func exists(path string) bool {\n\tif _, err := os.Stat(path); err != nil {\n\t   if os.IsNotExist(err) {\n\t\t  return false\n\t   }\n\t}\n\treturn true\n }\n\n func (self *Classpath) parseUserClasspath(cpOption string) { //按照-cp|classpath参数解析User启动参数\n\tif cpOption == \"\" { //cpOption为空时\n\t   cpOption = \".\" //返回相对路劲\n\t}\n\tself.userClasspath = newEntry(cpOption) //根据-cp|classpath参数实例化对应的Entry\n }\n{% endcodeblock %}\n\n * main，修改启动类\n{% codeblock lang:golang %}\nfunc startJVM(cmd *Cmd){\n\tcp := classpath.Parse(cmd.XjreOption, cmd.cpOption) //根据-Xjre和-cp|classpath参数实例化classpath对象实例\n\tfmt.Printf(\"classpath:%v class:%v args:%v\\n\",\n\t   cp, cmd.class, cmd.args)\n\tclassName := strings.Replace(cmd.class, \".\", \"/\", -1)\n\tclassData, _, err := cp.ReadClass(className) //按照3个启动路径查找并读取className文件\n\tif err != nil {\n\t   fmt.Printf(\"Could not find or load main class %s\\n\", cmd.class)\n\t   return\n\t}\n\tfmt.Printf(\"class data:%v\\n\", classData)\n}\n{% endcodeblock %}\n\n3. 试运行\n{% codeblock lang:shell %}\nPS D:\\work\\workspace_go\\src\\jvmgo\\ch02> go install\n\nPS D:\\work\\workspace_go\\bin> .\\ch02.exe -Xjre \"C:\\Program Files\\Java\\jre1.8.0_202\" java.lang.Object\nclasspath:D:\\work\\workspace_go\\bin class:java.lang.Object args:[]\nclass data:[202 254 186 190 0 0 0 52 0 75 3 0 15 66 63 8 0 16 8 0 36 8 0 40 1 0 3 40 41 73 1 0 20 40 41 76 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 59 1 0 20 40 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 1 0 3 40 41 86 1 0 21 40 73 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 1 0 4 40 74 41 86 1 0 5 40 74 73 41 86 1 0 21 40 76 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 59 41 90 1 0 21 40 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 41 86 1 0 8 60 99 108 105 110 105 116 62 1 0 6 60 105 110 105 116 62 1 0 1 64 1 0 4 67 111 100\n101 1 0 10 69 120 99 101 112 116 105 111 110 115 1 0 9 83 105 103 110 97 116 117 114 101 1 0 13 83 116 97 99 107 77 97 112 84 97 98 108 101 1 0 6 97 112 112 101 110 100 1 0 5 99 108 111 110 101 1 0 6 101 113\n117 97 108 115 1 0 8 102 105 110 97 108 105 122 101 1 0 8 103 101 116 67 108 97 115 115 1 0 7 103 101 116 78 97 109 101 1 0 8 104 97 115 104 67 111 100 101 1 0 15 106 97 118 97 47 108 97 110 103 47 67 108 97\n115 115 1 0 36 106 97 118 97 47 108 97 110 103 47 67 108 111 110 101 78 111 116 83 117 112 112 111 114 116 101 100 69 120 99 101 112 116 105 111 110 1 0 34 106 97 118 97 47 108 97 110 103 47 73 108 108 101 103 97 108 65 114 103 117 109 101 110 116 69 120 99 101 112 116 105 111 110 1 0 17 106 97 118 97 47 108 97 110 103 47 73 110 116 101 103 101 114 1 0 30 106 97 118 97 47 108 97 110 103 47 73 110 116 101 114 114\n117 112 116 101 100 69 120 99 101 112 116 105 111 110 1 0 16 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 1 0 23 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 66 117 105 108 100 101 114 1 0 19 106 97 118 97 47 108 97 110 103 47 84 104 114 111 119 97 98 108 101 1 0 37 110 97 110 111 115 101 99 111 110 100 32 116 105 109 101 111 117 116 32 118 97 108 117 101 32 111 117 116 32 111 102 32 114 97 110 103 101 1 0 6 110 111 116 105 102 121 1 0 9 110 111 116 105 102 121 65 108 108 1 0 15 114 101 103 105 115 116 101 114 78 97 116 105 118 101 115 1 0 25 116 105 109 101 111 117 116 32 118 97 108 117 101 32 105 115 32 110 101 103 97 116 105 118 101 1 0 11 116 111 72 101 120 83 116 114 105 110 103 1 0 8 116 111 83 116 114 105 110 103 1 0 4 119 97 105 116 7 0 28 7 0 29 7 0 30 7 0 31 7 0 32 7 0 33 7 0 34 7 0 35 1 0 19 40 41 76 106 97 118 97 47 108 97 110 103 47 67 108 97 115 115 59 1 0 22 40 41 76 106 97 118 97 47 108 97 110 103 47 67 108 97 115 115 60 42 62 59 1 0 45 40 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 66 117 105 108 100 101 114 59 12 0 27 0 5 12 0 15 0 8 12 0 39 0 8 12 0 43 0 10 12 0 25 0 52 12 0 26 0 7 12 0 42 0 7 12 0 41 0\n9 12 0 15 0 13 12 0 21 0 54 10 0 44 0 60 10 0 46 0 63 10 0 47 0 62 10 0 49 0 55 10 0 49 0 57 10 0 49 0 58 10 0 49 0 59 10 0 50 0 56 10 0 50 0 61 10 0 50 0 64 0 33 0 49 0 0 0 0 0 0 0 14 0 1 0 15 0 8 0 1 0 17 0 0 0 13 0 0 0 1 0 0 0 1 177 0 0 0 0 1 10 0 39 0 8 0 0 1 17 0 25 0 52 0 1 0 19 0 0 0 2 0 53 1 1 0 27 0 5 0 0 0 1 0 23 0 12 0 1 0 17 0 0 0 34 0 2 0 2 0 0 0 11 42 43 166 0 7 4 167 0 4 3 172 0 0 0 1 0 20 0 0 0 5\n0 2 9 64 1 1 4 0 22 0 6 0 1 0 18 0 0 0 4 0 1 0 45 0 1 0 42 0 7 0 1 0 17 0 0 0 48 0 2 0 1 0 0 0 36 187 0 50 89 183 0 72 42 182 0 71 182 0 65 182 0 74 18 2 182 0 74 42 182 0 68 184 0 67 182 0 74 182 0 73 176 0\n0 0 0 1 17 0 37 0 8 0 0 1 17 0 38 0 8 0 0 1 17 0 43 0 10 0 1 0 18 0 0 0 4 0 1 0 48 0 17 0 43 0 11 0 2 0 17 0 0 0 74 0 4 0 4 0 0 0 50 31 9 148 156 0 13 187 0 46 89 18 4 183 0 66 191 29 155 0 9 29 18 1 164 0 13 187 0 46 89 18 3 183 0 66 191 29 158 0 7 31 10 97 64 42 31 182 0 70 177 0 0 0 1 0 20 0 0 0 6 0 4 16 9 9 7 0 18 0 0 0 4 0 1 0 48 0 17 0 43 0 8 0 2 0 17 0 0 0 18 0 3 0 1 0 0 0 6 42 9 182 0 70 177 0 0 0 0 0 18\n0 0 0 4 0 1 0 48 0 4 0 24 0 8 0 2 0 17 0 0 0 13 0 0 0 1 0 0 0 1 177 0 0 0 0 0 18 0 0 0 4 0 1 0 51 0 8 0 14 0 8 0 1 0 17 0 0 0 16 0 0 0 0 0 0 0 4 184 0 69 177 0 0 0 0 0 0]\n{% endcodeblock %}\n","slug":"自己动手写Java虚拟机-笔记2","published":1,"updated":"2020-12-14T09:51:24.055Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htt001rv2527zex6mbp","content":"<html><head></head><body><h2 id=\"&#x5B9E;&#x73B0;cp-classpath-&#x53C2;&#x6570;&#x641C;&#x7D22;class&#x6587;&#x4EF6;\"><a href=\"#&#x5B9E;&#x73B0;cp-classpath-&#x53C2;&#x6570;&#x641C;&#x7D22;class&#x6587;&#x4EF6;\" class=\"headerlink\" title=\"&#x5B9E;&#x73B0;cp/classpath &#x53C2;&#x6570;&#x641C;&#x7D22;class&#x6587;&#x4EF6;\"></a>&#x5B9E;&#x73B0;cp/classpath &#x53C2;&#x6570;&#x641C;&#x7D22;class&#x6587;&#x4EF6;</h2><h3 id=\"java-class-path-&#x641C;&#x7D22;&#x987A;&#x5E8F;&#xFF1A;\"><a href=\"#java-class-path-&#x641C;&#x7D22;&#x987A;&#x5E8F;&#xFF1A;\" class=\"headerlink\" title=\"java class path &#x641C;&#x7D22;&#x987A;&#x5E8F;&#xFF1A;\"></a>java class path &#x641C;&#x7D22;&#x987A;&#x5E8F;&#xFF1A;</h3><ol>\n<li>&#x542F;&#x52A8;&#x7C7B;&#x8DEF;&#x5F84;&#xFF08;bootstrap classpath&#xFF09;:jre\\lib &#xFF08;&#x53EF;&#x901A;&#x8FC7;-Xbootclasspath&#x53C2;&#x6570;&#x4FEE;&#x6539;&#x8BE5;&#x8DEF;&#x5F84;&#xFF09;</li>\n<li>&#x6269;&#x5C55;&#x7C7B;&#x8DEF;&#x5F84;&#xFF08;extension classpath&#xFF09;:jre\\lib\\ext</li>\n<li>&#x7528;&#x6237;&#x7C7B;&#x8DEF;&#x5F84;&#xFF08;user classpath&#xFF09;:&#x7528;&#x6237;&#x81EA;&#x5DF1;&#x6307;&#x5B9A;</li>\n</ol>\n<a id=\"more\"></a>\n\n<h3 id=\"&#x5B9E;&#x73B0;\"><a href=\"#&#x5B9E;&#x73B0;\" class=\"headerlink\" title=\"&#x5B9E;&#x73B0;\"></a>&#x5B9E;&#x73B0;</h3><ol>\n<li>Entry&#x63A5;&#x53E3;&#x7528;&#x6765;&#x5B9A;&#x4E49;&#x542F;&#x52A8;&#x7C7B;&#x7684;&#x57FA;&#x672C;&#x529F;&#x80FD;</li>\n</ol>\n<figure class=\"highlight go hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">const</span> pathListSeparator = <span class=\"hljs-keyword\">string</span>(os.PathListSeparator) <span class=\"hljs-comment\">//&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x5206;&#x9694;&#x7B26;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">type</span> Entry <span class=\"hljs-keyword\">interface</span> {</span><br><span class=\"line\">\treadClass(classNme <span class=\"hljs-keyword\">string</span>) ([]<span class=\"hljs-keyword\">byte</span>,Entry,error) <span class=\"hljs-comment\">//&#x5B9A;&#x4E49;&#x6309;class&#x540D;&#x8BFB;&#x53D6;class&#x6587;&#x4EF6;&#x7684;&#x65B9;</span></span><br><span class=\"line\">\tString() <span class=\"hljs-keyword\">string</span> </span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x6839;&#x636E;classpath&#x751F;&#x6210;&#x5BF9;&#x5E94;&#x7684;&#x542F;&#x52A8;&#x7C7B;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">newEntry</span><span class=\"hljs-params\">(path <span class=\"hljs-keyword\">string</span>)</span> <span class=\"hljs-title\">Entry</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> strings.Contains(path,pathListSeparator){ <span class=\"hljs-comment\">//classpath&#x8DEF;&#x5F84;&#x5305;&#x542B;&#x7CFB;&#x7EDF;&#x5206;&#x5272;&#x7B26;&#x65F6;&#xFF0C;new&#x7EC4;&#x5408;&#x542F;&#x52A8;&#x7C7B;</span></span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">return</span> newCompositeEntry(path)</span><br><span class=\"line\">\t}</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> strings.HasSuffix(path,<span class=\"hljs-string\">&quot;*&quot;</span>) {</span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">return</span> newWildcardEntry(path) <span class=\"hljs-comment\">//classpath&#x8DEF;&#x5F84;&#x5305;&#x542B;*&#x65F6;&#xFF0C;new&#x901A;&#x914D;&#x7B26;&#x542F;&#x52A8;&#x7C7B;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> strings.HasSuffix(path, <span class=\"hljs-string\">&quot;.jar&quot;</span>) || strings.HasSuffix(path, <span class=\"hljs-string\">&quot;.JAR&quot;</span>) ||</span><br><span class=\"line\">      strings.HasSuffix(path, <span class=\"hljs-string\">&quot;.zip&quot;</span>) || strings.HasSuffix(path, <span class=\"hljs-string\">&quot;.ZIP&quot;</span>) {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> newZipEntry(path) <span class=\"hljs-comment\">//classpath&#x8DEF;&#x5F84;&#x5305;&#x542B;jar&#x3001;JAR&#x3001;zip&#x3001;ZIP&#x65F6;&#xFF0C;new&#x6587;&#x4EF6;&#x5939;&#x542F;&#x52A8;&#x7C7B;</span></span><br><span class=\"line\">   }</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> newDirEntry(path)</span><br><span class=\"line\"></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<ol start=\"2\">\n<li>Entry&#x63A5;&#x53E3;&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;</li>\n</ol>\n<ul>\n<li><p>DirEntry&#xFF0C;&#x6309;&#x7167;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x8BFB;&#x53D6;&#x6587;&#x4EF6;&#x4E8C;&#x8FDB;&#x5236;&#x6D41; </p>\n<figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> DirEntry <span class=\"hljs-keyword\">struct</span> {</span><br><span class=\"line\">\tabsDir <span class=\"hljs-keyword\">string</span> <span class=\"hljs-comment\">//&#x5B58;&#x50A8;&#x6587;&#x4EF6;&#x5939;&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">newDirEntry</span><span class=\"hljs-params\">(path <span class=\"hljs-keyword\">string</span>)</span> *<span class=\"hljs-title\">DirEntry</span></span> {</span><br><span class=\"line\">\tabsDir,err := filepath.Abs(path) <span class=\"hljs-comment\">//&#x5982;&#x679C;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x5B58;&#x5728;&#xFF0C;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x5939;&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {</span><br><span class=\"line\">\t\t<span class=\"hljs-built_in\">panic</span>(err) <span class=\"hljs-comment\">//&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x4E0D;&#x5B58;&#x5728;&#x65F6;&#x63D0;&#x793A;&#x9519;&#x8BEF;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> &amp;DirEntry{absDir} <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;DirEntry&#x5B9E;&#x4F8B;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *DirEntry)</span> <span class=\"hljs-title\">readClass</span><span class=\"hljs-params\">(className <span class=\"hljs-keyword\">string</span>)</span> <span class=\"hljs-params\">([]<span class=\"hljs-keyword\">byte</span>,Entry,error)</span></span>{</span><br><span class=\"line\">\tfileName := filepath.Join(self.absDir,className) <span class=\"hljs-comment\">//&#x62FC;&#x63A5;&#x6587;&#x4EF6;&#x5939;&#x8DEF;&#x5F84;&#x548C;classname</span></span><br><span class=\"line\">\tdata,err := ioutil.ReadFile(fileName) <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;&#x6587;&#x4EF6;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> data,self,err <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;&#x6587;&#x4EF6;&#x5185;&#x5BB9;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span><span class=\"hljs-params\">(self *DirEntry)</span> <span class=\"hljs-title\">String</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">string</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.absDir <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;&#x6587;&#x4EF6;&#x5939;&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>ZipEntry,&#x8BFB;&#x53D6;&#x538B;&#x7F29;&#x6587;&#x4EF6;&#x5939;&#x5185;&#x7684;&#x6587;&#x4EF6;</p>\n<figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> ZipEnty <span class=\"hljs-keyword\">struct</span> {</span><br><span class=\"line\">\tabsPath <span class=\"hljs-keyword\">string</span> <span class=\"hljs-comment\">//&#x6587;&#x4EF6;&#x5939;&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">newZipEntry</span><span class=\"hljs-params\">(path <span class=\"hljs-keyword\">string</span>)</span> *<span class=\"hljs-title\">ZipEnty</span></span> {</span><br><span class=\"line\">\tabsPath, err := filepath.Abs(path) <span class=\"hljs-comment\">//&#x5982;&#x679C;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x5B58;&#x5728;&#xFF0C;&#x83B7;&#x53D6;&#x6587;&#x4EF6;&#x5939;&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {</span><br><span class=\"line\">\t\t<span class=\"hljs-built_in\">panic</span>(err)</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> &amp;ZipEnty{absPath}</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ZipEnty)</span> <span class=\"hljs-title\">readClass</span><span class=\"hljs-params\">(className <span class=\"hljs-keyword\">string</span>)</span> <span class=\"hljs-params\">([]<span class=\"hljs-keyword\">byte</span>,Entry,error)</span></span>{</span><br><span class=\"line\">\tr, err := zip.OpenReader(self.absPath) <span class=\"hljs-comment\">//&#x4EE5;&#x538B;&#x7F29;&#x6587;&#x4EF6;&#x683C;&#x5F0F;&#x89E3;&#x538B;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {</span><br><span class=\"line\">\t   <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span>, <span class=\"hljs-literal\">nil</span>, err</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">defer</span> r.Close() <span class=\"hljs-comment\">//&#x6700;&#x540E;&#x5173;&#x95ED;&#x6587;&#x4EF6;&#x6D41;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">for</span> _, f := <span class=\"hljs-keyword\">range</span> r.File { <span class=\"hljs-comment\">//&#x5FAA;&#x73AF;&#x89E3;&#x538B;&#x51FA;&#x6765;&#x7684;&#x6587;&#x4EF6;</span></span><br><span class=\"line\">\t   <span class=\"hljs-keyword\">if</span> f.Name == className { <span class=\"hljs-comment\">//&#x5982;&#x679C;&#x5F53;&#x524D;&#x6587;&#x4EF6;&#x4E3A;&#x6307;&#x5B9A;&#x6587;&#x4EF6;</span></span><br><span class=\"line\">\t\t  rc, err := f.Open() <span class=\"hljs-comment\">//&#x6253;&#x5F00;&#x8BE5;&#x6587;&#x4EF6;</span></span><br><span class=\"line\">\t\t  <span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {</span><br><span class=\"line\">\t\t\t <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span>, <span class=\"hljs-literal\">nil</span>, err</span><br><span class=\"line\">\t\t  }</span><br><span class=\"line\">\t\t  <span class=\"hljs-keyword\">defer</span> rc.Close() <span class=\"hljs-comment\">//&#x6700;&#x540E;&#x5173;&#x95ED;&#x6587;&#x4EF6;</span></span><br><span class=\"line\">\t\t  data, err := ioutil.ReadAll(rc) <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;&#x6587;&#x4EF6;&#x6D41;</span></span><br><span class=\"line\">\t\t  <span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {</span><br><span class=\"line\">\t\t\t <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span>, <span class=\"hljs-literal\">nil</span>, err</span><br><span class=\"line\">\t\t  }</span><br><span class=\"line\">\t\t  <span class=\"hljs-keyword\">return</span> data, self, <span class=\"hljs-literal\">nil</span> <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;&#x6587;&#x4EF6;&#x6D41;</span></span><br><span class=\"line\">\t   }</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span>, <span class=\"hljs-literal\">nil</span>, errors.New(<span class=\"hljs-string\">&quot;class not found: &quot;</span> + className)</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ZipEnty)</span> <span class=\"hljs-title\">String</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">string</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.absPath</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>CompositeEntry,&#x8BFB;&#x53D6;&#x7B26;&#x5408;&#x6587;&#x4EF6;&#x7C7B;&#x578B;</p>\n<figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> CompositeEntry []Entry <span class=\"hljs-comment\">//CompositeEntry&#x4E3A;&#x591A;&#x79CD;Entry&#x7684;&#x6570;&#x7EC4;&#xFF08;Dir&#x3001;Zip&#xFF09;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">newCompositeEntry</span><span class=\"hljs-params\">(pathList <span class=\"hljs-keyword\">string</span>)</span> <span class=\"hljs-title\">CompositeEntry</span></span> {</span><br><span class=\"line\">\tcompositeEntry := []Entry{} <span class=\"hljs-comment\">//&#x5B9E;&#x4F8B;Entry&#x63A5;&#x53E3;&#x6570;&#x7EC4;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">for</span> _,path := <span class=\"hljs-keyword\">range</span> strings.Split(pathList,pathListSeparator){ <span class=\"hljs-comment\">//&#x6309;&#x7167;&#x7CFB;&#x7EDF;&#x5206;&#x5272;&#x7B26;&#x622A;&#x53D6;path&#x5217;&#x8868;&#xFF0C;&#x5E76;&#x5FAA;&#x73AF;</span></span><br><span class=\"line\">\t\tentry := newEntry(path) <span class=\"hljs-comment\">//&#x6309;&#x7167;&#x6BCF;&#x79CD;path&#x5B9E;&#x4F8B;&#x5316;&#x4E0D;&#x540C;&#x7684;Entry(Dir&#x3001;Zip&#x3001;Wildcard)</span></span><br><span class=\"line\">\t\tcompositeEntry = <span class=\"hljs-built_in\">append</span>(compositeEntry,entry) <span class=\"hljs-comment\">//&#x5C06;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x4E0D;&#x540C;Entry&#x653E;&#x5165;CompositeEntry&#x6570;&#x7EC4;&#x4E2D;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> compositeEntry</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self CompositeEntry)</span> <span class=\"hljs-title\">readClass</span><span class=\"hljs-params\">(className <span class=\"hljs-keyword\">string</span>)</span><span class=\"hljs-params\">([]<span class=\"hljs-keyword\">byte</span>,Entry,error)</span></span>{</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">for</span> _, entry := <span class=\"hljs-keyword\">range</span> self { <span class=\"hljs-comment\">//&#x5FAA;&#x73AF;compositeEntry&#x6570;&#x7EC4;</span></span><br><span class=\"line\">\t\tdata, from, err := entry.readClass(className) <span class=\"hljs-comment\">//&#x6839;&#x636E;&#x4E0D;&#x540C;Entry(Dir&#x3001;Zip&#x3001;Wildcard)&#xFF0C;&#x6309;&#x6307;&#x5B9A;classname&#x8BFB;&#x53D6;&#x6587;&#x4EF6;</span></span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">if</span> err == <span class=\"hljs-literal\">nil</span> {</span><br><span class=\"line\">\t\t   <span class=\"hljs-keyword\">return</span> data, from, <span class=\"hljs-literal\">nil</span> <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;&#x8BFB;&#x53D6;&#x7ED3;&#x679C;</span></span><br><span class=\"line\">\t\t}</span><br><span class=\"line\">\t }</span><br><span class=\"line\">\t <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span>, <span class=\"hljs-literal\">nil</span>, errors.New(<span class=\"hljs-string\">&quot;class not found: &quot;</span> + className) <span class=\"hljs-comment\">//&#x65E0;&#x7ED3;&#x679C;&#x662F;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;&#x4FE1;&#x606F;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self CompositeEntry)</span> <span class=\"hljs-title\">String</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">string</span></span> {</span><br><span class=\"line\">\tstrs := <span class=\"hljs-built_in\">make</span>([]<span class=\"hljs-keyword\">string</span>, <span class=\"hljs-built_in\">len</span>(self)) <span class=\"hljs-comment\">//&#x6309;&#x7167;CompositeEntry&#x7684;&#x957F;&#x5EA6;&#x7533;&#x660E;&#x8BE5;&#x957F;&#x5EA6;&#x7684;Sring&#x6570;&#x7EC4;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">for</span> i, entry := <span class=\"hljs-keyword\">range</span> self { <span class=\"hljs-comment\">//&#x5FAA;&#x73AF;CompositeEntry</span></span><br><span class=\"line\">\t   strs[i] = entry.String() <span class=\"hljs-comment\">//&#x8C03;&#x7528;&#x6BCF;&#x4E2A;Entry(Dir&#x3001;Zip&#x3001;Wildcard)&#x5B9E;&#x73B0;&#x7C7B;&#x7684;String()&#x65B9;&#x6CD5;,&#x5E76;&#x653E;&#x5165;String&#x6570;&#x7EC4;&#x4E2D;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> strings.Join(strs, pathListSeparator) <span class=\"hljs-comment\">//&#x5C06;String&#x6570;&#x7EC4;&#x4E2D;&#x7684;&#x7ED3;&#x679C;&#x4EE5;&#x7CFB;&#x7EDF;&#x5206;&#x9694;&#x7B26;&#x62FC;&#x63A5;&#x5E76;&#x8FD4;&#x56DE;</span></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>WildcardEntry&#xFF0C;&#x6309;&#x7167;&#x901A;&#x914D;&#x7B26;&#x89E3;&#x6790;&#x6587;&#x4EF6;</p>\n<figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">newWildcardEntry</span><span class=\"hljs-params\">(path <span class=\"hljs-keyword\">string</span>)</span> <span class=\"hljs-title\">CompositeEntry</span></span> {</span><br><span class=\"line\">\tbaseDir := path[:<span class=\"hljs-built_in\">len</span>(path)<span class=\"hljs-number\">-1</span>] <span class=\"hljs-comment\">// remove *</span></span><br><span class=\"line\">\tcompositeEntry := []Entry{} <span class=\"hljs-comment\">//&#x7533;&#x660E;compositeEntry&#x5BF9;&#x8C61;(Entry&#x7684;&#x6570;&#x7EC4;)</span></span><br><span class=\"line\">\twalkFn := <span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span><span class=\"hljs-params\">(path <span class=\"hljs-keyword\">string</span>, info os.FileInfo, err error)</span> <span class=\"hljs-title\">error</span></span> {</span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {</span><br><span class=\"line\">\t\t   <span class=\"hljs-keyword\">return</span> err</span><br><span class=\"line\">\t\t}</span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">if</span> info.IsDir() &amp;&amp; path != baseDir { <span class=\"hljs-comment\">//&#x5982;&#x679C;&#x5F53;&#x524D;&#x76EE;&#x5F55;&#x662F;&#x6587;&#x4EF6;&#x5939;&#xFF0C;&#x5E76;&#x4E14;&#x662F;&#x6839;&#x76EE;&#x5F55;</span></span><br><span class=\"line\">\t\t   <span class=\"hljs-keyword\">return</span> filepath.SkipDir <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;SkipDir&#x7684;&#x9519;&#x8BEF;</span></span><br><span class=\"line\">\t\t}</span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">if</span> strings.HasSuffix(path, <span class=\"hljs-string\">&quot;.jar&quot;</span>) || strings.HasSuffix(path, <span class=\"hljs-string\">&quot;.JAR&quot;</span>) { <span class=\"hljs-comment\">//&#x5982;&#x679C;&#x5F53;&#x524D;&#x8DEF;&#x5F84;&#x662F;&#x4EE5;.jar&#x6216;.JAR&#x7ED3;&#x5C3E;&#x7684;</span></span><br><span class=\"line\">\t\t\tjarEntry := newZipEntry(path) <span class=\"hljs-comment\">//&#x5B9E;&#x4F8B;&#x5316;ZipEntry</span></span><br><span class=\"line\">\t\t\tcompositeEntry = <span class=\"hljs-built_in\">append</span>(compositeEntry, jarEntry) <span class=\"hljs-comment\">//&#x5C06;&#x5B9E;&#x4F8B;&#x5316;&#x7684;ZipEntry&#x5BF9;&#x8C61;&#x653E;&#x5165;compositeEntry&#x6570;&#x7EC4;&#x4E2D;</span></span><br><span class=\"line\">\t\t }</span><br><span class=\"line\">\t\t <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span></span><br><span class=\"line\">\t  }</span><br><span class=\"line\">\tfilepath.Walk(baseDir, walkFn) <span class=\"hljs-comment\">//&#x5C06;walkFn&#x65B9;&#x6CD5;&#x4F20;&#x9012;&#x7ED9;filepath.Walk</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> compositeEntry <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;&#x7ED3;&#x679C;</span></span><br><span class=\"line\"> }</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>Classpath&#xFF0C;-cp|classpath&#x53C2;&#x6570;&#x89E3;&#x6790;&#x5B9E;&#x73B0;&#x7684;&#x5165;&#x53E3;&#x65B9;&#x6CD5;</p>\n<figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> Classpath <span class=\"hljs-keyword\">struct</span> { <span class=\"hljs-comment\">//Classpath&#x5305;&#x542B;java&#x7684;&#x4E09;&#x79CD;&#x57FA;&#x7840;&#x542F;&#x52A8;&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">\tbootClasspath Entry </span><br><span class=\"line\">\textClasspath Entry</span><br><span class=\"line\">\tuserClasspath Entry</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">Parse</span><span class=\"hljs-params\">(jreOption, cpOption <span class=\"hljs-keyword\">string</span>)</span> * <span class=\"hljs-title\">Classpath</span></span>  {</span><br><span class=\"line\">\tcp := &amp;Classpath{} <span class=\"hljs-comment\">//&#x5B9E;&#x4F8B;&#x5316;Classpath&#x5BF9;&#x8C61;</span></span><br><span class=\"line\">\tcp.parseBootAndExtClasspath(jreOption) <span class=\"hljs-comment\">//&#x6309;&#x7167;-Xjre&#x53C2;&#x6570;&#x89E3;&#x6790;Boot&#x548C;Ext&#x542F;&#x52A8;&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">\tcp.parseUserClasspath(cpOption) <span class=\"hljs-comment\">//&#x6309;&#x7167;-cp|classpath&#x53C2;&#x6570;&#x89E3;&#x6790;User&#x542F;&#x52A8;&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> cp <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;&#x8BBE;&#x7F6E;&#x597D;&#x542F;&#x52A8;&#x8DEF;&#x5F84;&#x7684;Classpath&#x5BF9;&#x8C61;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Classpath)</span> <span class=\"hljs-title\">ReadClass</span><span class=\"hljs-params\">(className <span class=\"hljs-keyword\">string</span>)</span> <span class=\"hljs-params\">([]<span class=\"hljs-keyword\">byte</span>,Entry,error)</span></span>{</span><br><span class=\"line\">\tclassName = className + <span class=\"hljs-string\">&quot;.class&quot;</span> <span class=\"hljs-comment\">//&#x521D;&#x59CB;&#x5316;className&#x6587;&#x4EF6;&#x540D;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> data, entry, err := self.bootClasspath.readClass(className); err == <span class=\"hljs-literal\">nil</span> { <span class=\"hljs-comment\">//&#x5148;&#x626B;&#x63CF;Boot&#x542F;&#x52A8;&#x8DEF;&#x5F84;&#x4E0B;&#x662F;&#x5426;&#x5B58;&#x5728;&#x8BE5;className.class&#x6587;&#x4EF6;</span></span><br><span class=\"line\">\t   <span class=\"hljs-keyword\">return</span> data, entry, err <span class=\"hljs-comment\">//&#x5B58;&#x5728;&#x5219;&#x8FD4;&#x56DE;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> data, entry, err := self.extClasspath.readClass(className); err == <span class=\"hljs-literal\">nil</span> { <span class=\"hljs-comment\">//&#x518D;&#x626B;&#x63CF;Ext&#x542F;&#x52A8;&#x8DEF;&#x5F84;&#x4E0B;&#x662F;&#x5426;&#x5B58;&#x5728;&#x8BE5;className.class&#x6587;&#x4EF6;</span></span><br><span class=\"line\">\t   <span class=\"hljs-keyword\">return</span> data, entry, err <span class=\"hljs-comment\">//&#x5B58;&#x5728;&#x5219;&#x8FD4;&#x56DE;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.userClasspath.readClass(className) <span class=\"hljs-comment\">//&#x4EE5;&#x4E0A;&#x4E24;&#x4E2A;&#x8DEF;&#x5F84;&#x4E0B;&#x90FD;&#x4E0D;&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x626B;&#x63CF;User&#x542F;&#x52A8;&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Classpath)</span> <span class=\"hljs-title\">String</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">string</span></span>  {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.userClasspath.String()</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Classpath)</span> <span class=\"hljs-title\">parseBootAndExtClasspath</span><span class=\"hljs-params\">(jreOption <span class=\"hljs-keyword\">string</span>)</span></span> { <span class=\"hljs-comment\">//&#x6309;&#x7167;-Xjre&#x53C2;&#x6570;&#x89E3;&#x6790;Boot&#x548C;Ext&#x542F;&#x52A8;&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">\tjreDir := getJreDir(jreOption) <span class=\"hljs-comment\">//&#x83B7;&#x53D6;jre&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">   <span class=\"hljs-comment\">// jre/lib/*</span></span><br><span class=\"line\">   jreLibPath := filepath.Join(jreDir, <span class=\"hljs-string\">&quot;lib&quot;</span>, <span class=\"hljs-string\">&quot;*&quot;</span>)</span><br><span class=\"line\">   self.bootClasspath = newWildcardEntry(jreLibPath)</span><br><span class=\"line\">   <span class=\"hljs-comment\">// jre/lib/ext/*</span></span><br><span class=\"line\">   jreExtPath := filepath.Join(jreDir, <span class=\"hljs-string\">&quot;lib&quot;</span>, <span class=\"hljs-string\">&quot;ext&quot;</span>, <span class=\"hljs-string\">&quot;*&quot;</span>)</span><br><span class=\"line\">   self.extClasspath = newWildcardEntry(jreExtPath)</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">getJreDir</span><span class=\"hljs-params\">(jreOption <span class=\"hljs-keyword\">string</span>)</span> <span class=\"hljs-title\">string</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> jreOption != <span class=\"hljs-string\">&quot;&quot;</span> &amp;&amp; exists(jreOption) { <span class=\"hljs-comment\">//jreOption&#x4E0D;&#x4E3A;&#x7A7A;&#x4E14;&#x5B58;&#x5728;&#x65F6;&#x8FD4;&#x56DE;&#x8BE5;&#x8DEF;&#x5F84;</span></span><br><span class=\"line\">\t   <span class=\"hljs-keyword\">return</span> jreOption</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> exists(<span class=\"hljs-string\">&quot;./jre&quot;</span>) { <span class=\"hljs-comment\">//./jre&#x8DEF;&#x5F84;&#x5B58;&#x5728;&#x65F6;&#xFF0C;&#x8FD4;&#x56DE;.jre</span></span><br><span class=\"line\">\t   <span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;./jre&quot;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> jh := os.Getenv(<span class=\"hljs-string\">&quot;JAVA_HOME&quot;</span>); jh != <span class=\"hljs-string\">&quot;&quot;</span> { <span class=\"hljs-comment\">//&#x73AF;&#x5883;&#x53D8;&#x91CF;JAVA_HOME&#x5B58;&#x5728;&#x5E76;&#x4E14;&#x4E0D;&#x4E3A;&#x7A7A;&#x65F6;</span></span><br><span class=\"line\">\t   <span class=\"hljs-keyword\">return</span> filepath.Join(jh, <span class=\"hljs-string\">&quot;jre&quot;</span>) <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;JAVA_HOME + &quot;jre&quot;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-built_in\">panic</span>(<span class=\"hljs-string\">&quot;Can not find jre folder!&quot;</span>)</span><br><span class=\"line\"> }</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">exists</span><span class=\"hljs-params\">(path <span class=\"hljs-keyword\">string</span>)</span> <span class=\"hljs-title\">bool</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> _, err := os.Stat(path); err != <span class=\"hljs-literal\">nil</span> {</span><br><span class=\"line\">\t   <span class=\"hljs-keyword\">if</span> os.IsNotExist(err) {</span><br><span class=\"line\">\t\t  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span></span><br><span class=\"line\">\t   }</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">true</span></span><br><span class=\"line\"> }</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Classpath)</span> <span class=\"hljs-title\">parseUserClasspath</span><span class=\"hljs-params\">(cpOption <span class=\"hljs-keyword\">string</span>)</span></span> { <span class=\"hljs-comment\">//&#x6309;&#x7167;-cp|classpath&#x53C2;&#x6570;&#x89E3;&#x6790;User&#x542F;&#x52A8;&#x53C2;&#x6570;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> cpOption == <span class=\"hljs-string\">&quot;&quot;</span> { <span class=\"hljs-comment\">//cpOption&#x4E3A;&#x7A7A;&#x65F6;</span></span><br><span class=\"line\">\t   cpOption = <span class=\"hljs-string\">&quot;.&quot;</span> <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;&#x76F8;&#x5BF9;&#x8DEF;&#x52B2;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">\tself.userClasspath = newEntry(cpOption) <span class=\"hljs-comment\">//&#x6839;&#x636E;-cp|classpath&#x53C2;&#x6570;&#x5B9E;&#x4F8B;&#x5316;&#x5BF9;&#x5E94;&#x7684;Entry</span></span><br><span class=\"line\"> }</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>main&#xFF0C;&#x4FEE;&#x6539;&#x542F;&#x52A8;&#x7C7B;</p>\n<figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">startJVM</span><span class=\"hljs-params\">(cmd *Cmd)</span></span>{</span><br><span class=\"line\">\tcp := classpath.Parse(cmd.XjreOption, cmd.cpOption) <span class=\"hljs-comment\">//&#x6839;&#x636E;-Xjre&#x548C;-cp|classpath&#x53C2;&#x6570;&#x5B9E;&#x4F8B;&#x5316;classpath&#x5BF9;&#x8C61;&#x5B9E;&#x4F8B;</span></span><br><span class=\"line\">\tfmt.Printf(<span class=\"hljs-string\">&quot;classpath:%v class:%v args:%v\\n&quot;</span>,</span><br><span class=\"line\">\t   cp, cmd.class, cmd.args)</span><br><span class=\"line\">\tclassName := strings.Replace(cmd.class, <span class=\"hljs-string\">&quot;.&quot;</span>, <span class=\"hljs-string\">&quot;/&quot;</span>, <span class=\"hljs-number\">-1</span>)</span><br><span class=\"line\">\tclassData, _, err := cp.ReadClass(className) <span class=\"hljs-comment\">//&#x6309;&#x7167;3&#x4E2A;&#x542F;&#x52A8;&#x8DEF;&#x5F84;&#x67E5;&#x627E;&#x5E76;&#x8BFB;&#x53D6;className&#x6587;&#x4EF6;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> err != <span class=\"hljs-literal\">nil</span> {</span><br><span class=\"line\">\t   fmt.Printf(<span class=\"hljs-string\">&quot;Could not find or load main class %s\\n&quot;</span>, cmd.class)</span><br><span class=\"line\">\t   <span class=\"hljs-keyword\">return</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">\tfmt.Printf(<span class=\"hljs-string\">&quot;class data:%v\\n&quot;</span>, classData)</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n</li>\n</ul>\n<ol start=\"3\">\n<li>&#x8BD5;&#x8FD0;&#x884C;<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PS D:\\work\\workspace_go\\src\\jvmgo\\ch02&gt; go install</span><br><span class=\"line\"></span><br><span class=\"line\">PS D:\\work\\workspace_go\\bin&gt; .\\ch02.exe -Xjre &quot;C:\\Program Files\\Java\\jre1.8.0_202&quot; java.lang.Object</span><br><span class=\"line\">classpath:D:\\work\\workspace_go\\bin class:java.lang.Object args:[]</span><br><span class=\"line\">class data:[202 254 186 190 0 0 0 52 0 75 3 0 15 66 63 8 0 16 8 0 36 8 0 40 1 0 3 40 41 73 1 0 20 40 41 76 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 59 1 0 20 40 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 1 0 3 40 41 86 1 0 21 40 73 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 1 0 4 40 74 41 86 1 0 5 40 74 73 41 86 1 0 21 40 76 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 59 41 90 1 0 21 40 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 41 86 1 0 8 60 99 108 105 110 105 116 62 1 0 6 60 105 110 105 116 62 1 0 1 64 1 0 4 67 111 100</span><br><span class=\"line\">101 1 0 10 69 120 99 101 112 116 105 111 110 115 1 0 9 83 105 103 110 97 116 117 114 101 1 0 13 83 116 97 99 107 77 97 112 84 97 98 108 101 1 0 6 97 112 112 101 110 100 1 0 5 99 108 111 110 101 1 0 6 101 113</span><br><span class=\"line\">117 97 108 115 1 0 8 102 105 110 97 108 105 122 101 1 0 8 103 101 116 67 108 97 115 115 1 0 7 103 101 116 78 97 109 101 1 0 8 104 97 115 104 67 111 100 101 1 0 15 106 97 118 97 47 108 97 110 103 47 67 108 97</span><br><span class=\"line\">115 115 1 0 36 106 97 118 97 47 108 97 110 103 47 67 108 111 110 101 78 111 116 83 117 112 112 111 114 116 101 100 69 120 99 101 112 116 105 111 110 1 0 34 106 97 118 97 47 108 97 110 103 47 73 108 108 101 103 97 108 65 114 103 117 109 101 110 116 69 120 99 101 112 116 105 111 110 1 0 17 106 97 118 97 47 108 97 110 103 47 73 110 116 101 103 101 114 1 0 30 106 97 118 97 47 108 97 110 103 47 73 110 116 101 114 114</span><br><span class=\"line\">117 112 116 101 100 69 120 99 101 112 116 105 111 110 1 0 16 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 1 0 23 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 66 117 105 108 100 101 114 1 0 19 106 97 118 97 47 108 97 110 103 47 84 104 114 111 119 97 98 108 101 1 0 37 110 97 110 111 115 101 99 111 110 100 32 116 105 109 101 111 117 116 32 118 97 108 117 101 32 111 117 116 32 111 102 32 114 97 110 103 101 1 0 6 110 111 116 105 102 121 1 0 9 110 111 116 105 102 121 65 108 108 1 0 15 114 101 103 105 115 116 101 114 78 97 116 105 118 101 115 1 0 25 116 105 109 101 111 117 116 32 118 97 108 117 101 32 105 115 32 110 101 103 97 116 105 118 101 1 0 11 116 111 72 101 120 83 116 114 105 110 103 1 0 8 116 111 83 116 114 105 110 103 1 0 4 119 97 105 116 7 0 28 7 0 29 7 0 30 7 0 31 7 0 32 7 0 33 7 0 34 7 0 35 1 0 19 40 41 76 106 97 118 97 47 108 97 110 103 47 67 108 97 115 115 59 1 0 22 40 41 76 106 97 118 97 47 108 97 110 103 47 67 108 97 115 115 60 42 62 59 1 0 45 40 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 66 117 105 108 100 101 114 59 12 0 27 0 5 12 0 15 0 8 12 0 39 0 8 12 0 43 0 10 12 0 25 0 52 12 0 26 0 7 12 0 42 0 7 12 0 41 0</span><br><span class=\"line\">9 12 0 15 0 13 12 0 21 0 54 10 0 44 0 60 10 0 46 0 63 10 0 47 0 62 10 0 49 0 55 10 0 49 0 57 10 0 49 0 58 10 0 49 0 59 10 0 50 0 56 10 0 50 0 61 10 0 50 0 64 0 33 0 49 0 0 0 0 0 0 0 14 0 1 0 15 0 8 0 1 0 17 0 0 0 13 0 0 0 1 0 0 0 1 177 0 0 0 0 1 10 0 39 0 8 0 0 1 17 0 25 0 52 0 1 0 19 0 0 0 2 0 53 1 1 0 27 0 5 0 0 0 1 0 23 0 12 0 1 0 17 0 0 0 34 0 2 0 2 0 0 0 11 42 43 166 0 7 4 167 0 4 3 172 0 0 0 1 0 20 0 0 0 5</span><br><span class=\"line\">0 2 9 64 1 1 4 0 22 0 6 0 1 0 18 0 0 0 4 0 1 0 45 0 1 0 42 0 7 0 1 0 17 0 0 0 48 0 2 0 1 0 0 0 36 187 0 50 89 183 0 72 42 182 0 71 182 0 65 182 0 74 18 2 182 0 74 42 182 0 68 184 0 67 182 0 74 182 0 73 176 0</span><br><span class=\"line\">0 0 0 1 17 0 37 0 8 0 0 1 17 0 38 0 8 0 0 1 17 0 43 0 10 0 1 0 18 0 0 0 4 0 1 0 48 0 17 0 43 0 11 0 2 0 17 0 0 0 74 0 4 0 4 0 0 0 50 31 9 148 156 0 13 187 0 46 89 18 4 183 0 66 191 29 155 0 9 29 18 1 164 0 13 187 0 46 89 18 3 183 0 66 191 29 158 0 7 31 10 97 64 42 31 182 0 70 177 0 0 0 1 0 20 0 0 0 6 0 4 16 9 9 7 0 18 0 0 0 4 0 1 0 48 0 17 0 43 0 8 0 2 0 17 0 0 0 18 0 3 0 1 0 0 0 6 42 9 182 0 70 177 0 0 0 0 0 18</span><br><span class=\"line\">0 0 0 4 0 1 0 48 0 4 0 24 0 8 0 2 0 17 0 0 0 13 0 0 0 1 0 0 0 1 177 0 0 0 0 0 18 0 0 0 4 0 1 0 51 0 8 0 14 0 8 0 1 0 17 0 0 0 16 0 0 0 0 0 0 0 4 184 0 69 177 0 0 0 0 0 0]</span><br></pre></td></tr></tbody></table></figure>\n</li>\n</ol>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"JVM","path":"tags/JVM/"},{"name":"Java","path":"tags/Java/"},{"name":"Go","path":"tags/Go/"}],"excerpt":"<html><head></head><body><h2 id=\"&#x5B9E;&#x73B0;cp-classpath-&#x53C2;&#x6570;&#x641C;&#x7D22;class&#x6587;&#x4EF6;\"><a href=\"#&#x5B9E;&#x73B0;cp-classpath-&#x53C2;&#x6570;&#x641C;&#x7D22;class&#x6587;&#x4EF6;\" class=\"headerlink\" title=\"&#x5B9E;&#x73B0;cp/classpath &#x53C2;&#x6570;&#x641C;&#x7D22;class&#x6587;&#x4EF6;\"></a>&#x5B9E;&#x73B0;cp/classpath &#x53C2;&#x6570;&#x641C;&#x7D22;class&#x6587;&#x4EF6;</h2><h3 id=\"java-class-path-&#x641C;&#x7D22;&#x987A;&#x5E8F;&#xFF1A;\"><a href=\"#java-class-path-&#x641C;&#x7D22;&#x987A;&#x5E8F;&#xFF1A;\" class=\"headerlink\" title=\"java class path &#x641C;&#x7D22;&#x987A;&#x5E8F;&#xFF1A;\"></a>java class path &#x641C;&#x7D22;&#x987A;&#x5E8F;&#xFF1A;</h3><ol>\n<li>&#x542F;&#x52A8;&#x7C7B;&#x8DEF;&#x5F84;&#xFF08;bootstrap classpath&#xFF09;:jre\\lib &#xFF08;&#x53EF;&#x901A;&#x8FC7;-Xbootclasspath&#x53C2;&#x6570;&#x4FEE;&#x6539;&#x8BE5;&#x8DEF;&#x5F84;&#xFF09;</li>\n<li>&#x6269;&#x5C55;&#x7C7B;&#x8DEF;&#x5F84;&#xFF08;extension classpath&#xFF09;:jre\\lib\\ext</li>\n<li>&#x7528;&#x6237;&#x7C7B;&#x8DEF;&#x5F84;&#xFF08;user classpath&#xFF09;:&#x7528;&#x6237;&#x81EA;&#x5DF1;&#x6307;&#x5B9A;</li>\n</ol></body></html>","more":"<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><ol>\n<li>Entry接口用来定义启动类的基本功能</li>\n</ol>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> pathListSeparator = <span class=\"keyword\">string</span>(os.PathListSeparator) <span class=\"comment\">//获取当前操作系统分隔符</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> Entry <span class=\"keyword\">interface</span> &#123;</span><br><span class=\"line\">\treadClass(classNme <span class=\"keyword\">string</span>) ([]<span class=\"keyword\">byte</span>,Entry,error) <span class=\"comment\">//定义按class名读取class文件的方</span></span><br><span class=\"line\">\tString() <span class=\"keyword\">string</span> </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//根据classpath生成对应的启动类</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newEntry</span><span class=\"params\">(path <span class=\"keyword\">string</span>)</span> <span class=\"title\">Entry</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> strings.Contains(path,pathListSeparator)&#123; <span class=\"comment\">//classpath路径包含系统分割符时，new组合启动类</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> newCompositeEntry(path)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> strings.HasSuffix(path,<span class=\"string\">&quot;*&quot;</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> newWildcardEntry(path) <span class=\"comment\">//classpath路径包含*时，new通配符启动类</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> strings.HasSuffix(path, <span class=\"string\">&quot;.jar&quot;</span>) || strings.HasSuffix(path, <span class=\"string\">&quot;.JAR&quot;</span>) ||</span><br><span class=\"line\">      strings.HasSuffix(path, <span class=\"string\">&quot;.zip&quot;</span>) || strings.HasSuffix(path, <span class=\"string\">&quot;.ZIP&quot;</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> newZipEntry(path) <span class=\"comment\">//classpath路径包含jar、JAR、zip、ZIP时，new文件夹启动类</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> newDirEntry(path)</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>Entry接口的具体实现</li>\n</ol>\n<ul>\n<li><p>DirEntry，按照文件路径读取文件二进制流 </p>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> DirEntry <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tabsDir <span class=\"keyword\">string</span> <span class=\"comment\">//存储文件夹路径</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newDirEntry</span><span class=\"params\">(path <span class=\"keyword\">string</span>)</span> *<span class=\"title\">DirEntry</span></span> &#123;</span><br><span class=\"line\">\tabsDir,err := filepath.Abs(path) <span class=\"comment\">//如果文件路径存在，获取文件夹路径</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">panic</span>(err) <span class=\"comment\">//文件路径不存在时提示错误</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;DirEntry&#123;absDir&#125; <span class=\"comment\">//返回DirEntry实例</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *DirEntry)</span> <span class=\"title\">readClass</span><span class=\"params\">(className <span class=\"keyword\">string</span>)</span> <span class=\"params\">([]<span class=\"keyword\">byte</span>,Entry,error)</span></span>&#123;</span><br><span class=\"line\">\tfileName := filepath.Join(self.absDir,className) <span class=\"comment\">//拼接文件夹路径和classname</span></span><br><span class=\"line\">\tdata,err := ioutil.ReadFile(fileName) <span class=\"comment\">//读取文件</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> data,self,err <span class=\"comment\">//返回文件内容</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(self *DirEntry)</span> <span class=\"title\">String</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.absDir <span class=\"comment\">//返回文件夹路径</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ZipEntry,读取压缩文件夹内的文件</p>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> ZipEnty <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tabsPath <span class=\"keyword\">string</span> <span class=\"comment\">//文件夹路径</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newZipEntry</span><span class=\"params\">(path <span class=\"keyword\">string</span>)</span> *<span class=\"title\">ZipEnty</span></span> &#123;</span><br><span class=\"line\">\tabsPath, err := filepath.Abs(path) <span class=\"comment\">//如果文件路径存在，获取文件夹路径</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"built_in\">panic</span>(err)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;ZipEnty&#123;absPath&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ZipEnty)</span> <span class=\"title\">readClass</span><span class=\"params\">(className <span class=\"keyword\">string</span>)</span> <span class=\"params\">([]<span class=\"keyword\">byte</span>,Entry,error)</span></span>&#123;</span><br><span class=\"line\">\tr, err := zip.OpenReader(self.absPath) <span class=\"comment\">//以压缩文件格式解压</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t   <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, <span class=\"literal\">nil</span>, err</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> r.Close() <span class=\"comment\">//最后关闭文件流</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, f := <span class=\"keyword\">range</span> r.File &#123; <span class=\"comment\">//循环解压出来的文件</span></span><br><span class=\"line\">\t   <span class=\"keyword\">if</span> f.Name == className &#123; <span class=\"comment\">//如果当前文件为指定文件</span></span><br><span class=\"line\">\t\t  rc, err := f.Open() <span class=\"comment\">//打开该文件</span></span><br><span class=\"line\">\t\t  <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, <span class=\"literal\">nil</span>, err</span><br><span class=\"line\">\t\t  &#125;</span><br><span class=\"line\">\t\t  <span class=\"keyword\">defer</span> rc.Close() <span class=\"comment\">//最后关闭文件</span></span><br><span class=\"line\">\t\t  data, err := ioutil.ReadAll(rc) <span class=\"comment\">//读取文件流</span></span><br><span class=\"line\">\t\t  <span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, <span class=\"literal\">nil</span>, err</span><br><span class=\"line\">\t\t  &#125;</span><br><span class=\"line\">\t\t  <span class=\"keyword\">return</span> data, self, <span class=\"literal\">nil</span> <span class=\"comment\">//返回文件流</span></span><br><span class=\"line\">\t   &#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, <span class=\"literal\">nil</span>, errors.New(<span class=\"string\">&quot;class not found: &quot;</span> + className)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ZipEnty)</span> <span class=\"title\">String</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.absPath</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>CompositeEntry,读取符合文件类型</p>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> CompositeEntry []Entry <span class=\"comment\">//CompositeEntry为多种Entry的数组（Dir、Zip）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newCompositeEntry</span><span class=\"params\">(pathList <span class=\"keyword\">string</span>)</span> <span class=\"title\">CompositeEntry</span></span> &#123;</span><br><span class=\"line\">\tcompositeEntry := []Entry&#123;&#125; <span class=\"comment\">//实例Entry接口数组</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _,path := <span class=\"keyword\">range</span> strings.Split(pathList,pathListSeparator)&#123; <span class=\"comment\">//按照系统分割符截取path列表，并循环</span></span><br><span class=\"line\">\t\tentry := newEntry(path) <span class=\"comment\">//按照每种path实例化不同的Entry(Dir、Zip、Wildcard)</span></span><br><span class=\"line\">\t\tcompositeEntry = <span class=\"built_in\">append</span>(compositeEntry,entry) <span class=\"comment\">//将实例化的不同Entry放入CompositeEntry数组中</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> compositeEntry</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self CompositeEntry)</span> <span class=\"title\">readClass</span><span class=\"params\">(className <span class=\"keyword\">string</span>)</span><span class=\"params\">([]<span class=\"keyword\">byte</span>,Entry,error)</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> _, entry := <span class=\"keyword\">range</span> self &#123; <span class=\"comment\">//循环compositeEntry数组</span></span><br><span class=\"line\">\t\tdata, from, err := entry.readClass(className) <span class=\"comment\">//根据不同Entry(Dir、Zip、Wildcard)，按指定classname读取文件</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err == <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t   <span class=\"keyword\">return</span> data, from, <span class=\"literal\">nil</span> <span class=\"comment\">//返回读取结果</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t &#125;</span><br><span class=\"line\">\t <span class=\"keyword\">return</span> <span class=\"literal\">nil</span>, <span class=\"literal\">nil</span>, errors.New(<span class=\"string\">&quot;class not found: &quot;</span> + className) <span class=\"comment\">//无结果是返回错误信息</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self CompositeEntry)</span> <span class=\"title\">String</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\tstrs := <span class=\"built_in\">make</span>([]<span class=\"keyword\">string</span>, <span class=\"built_in\">len</span>(self)) <span class=\"comment\">//按照CompositeEntry的长度申明该长度的Sring数组</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, entry := <span class=\"keyword\">range</span> self &#123; <span class=\"comment\">//循环CompositeEntry</span></span><br><span class=\"line\">\t   strs[i] = entry.String() <span class=\"comment\">//调用每个Entry(Dir、Zip、Wildcard)实现类的String()方法,并放入String数组中</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> strings.Join(strs, pathListSeparator) <span class=\"comment\">//将String数组中的结果以系统分隔符拼接并返回</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>WildcardEntry，按照通配符解析文件</p>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newWildcardEntry</span><span class=\"params\">(path <span class=\"keyword\">string</span>)</span> <span class=\"title\">CompositeEntry</span></span> &#123;</span><br><span class=\"line\">\tbaseDir := path[:<span class=\"built_in\">len</span>(path)<span class=\"number\">-1</span>] <span class=\"comment\">// remove *</span></span><br><span class=\"line\">\tcompositeEntry := []Entry&#123;&#125; <span class=\"comment\">//申明compositeEntry对象(Entry的数组)</span></span><br><span class=\"line\">\twalkFn := <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">(path <span class=\"keyword\">string</span>, info os.FileInfo, err error)</span> <span class=\"title\">error</span></span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t   <span class=\"keyword\">return</span> err</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> info.IsDir() &amp;&amp; path != baseDir &#123; <span class=\"comment\">//如果当前目录是文件夹，并且是根目录</span></span><br><span class=\"line\">\t\t   <span class=\"keyword\">return</span> filepath.SkipDir <span class=\"comment\">//返回SkipDir的错误</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> strings.HasSuffix(path, <span class=\"string\">&quot;.jar&quot;</span>) || strings.HasSuffix(path, <span class=\"string\">&quot;.JAR&quot;</span>) &#123; <span class=\"comment\">//如果当前路径是以.jar或.JAR结尾的</span></span><br><span class=\"line\">\t\t\tjarEntry := newZipEntry(path) <span class=\"comment\">//实例化ZipEntry</span></span><br><span class=\"line\">\t\t\tcompositeEntry = <span class=\"built_in\">append</span>(compositeEntry, jarEntry) <span class=\"comment\">//将实例化的ZipEntry对象放入compositeEntry数组中</span></span><br><span class=\"line\">\t\t &#125;</span><br><span class=\"line\">\t\t <span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">\t  &#125;</span><br><span class=\"line\">\tfilepath.Walk(baseDir, walkFn) <span class=\"comment\">//将walkFn方法传递给filepath.Walk</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> compositeEntry <span class=\"comment\">//返回结果</span></span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>Classpath，-cp|classpath参数解析实现的入口方法</p>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Classpath <span class=\"keyword\">struct</span> &#123; <span class=\"comment\">//Classpath包含java的三种基础启动路径</span></span><br><span class=\"line\">\tbootClasspath Entry </span><br><span class=\"line\">\textClasspath Entry</span><br><span class=\"line\">\tuserClasspath Entry</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Parse</span><span class=\"params\">(jreOption, cpOption <span class=\"keyword\">string</span>)</span> * <span class=\"title\">Classpath</span></span>  &#123;</span><br><span class=\"line\">\tcp := &amp;Classpath&#123;&#125; <span class=\"comment\">//实例化Classpath对象</span></span><br><span class=\"line\">\tcp.parseBootAndExtClasspath(jreOption) <span class=\"comment\">//按照-Xjre参数解析Boot和Ext启动路径</span></span><br><span class=\"line\">\tcp.parseUserClasspath(cpOption) <span class=\"comment\">//按照-cp|classpath参数解析User启动路径</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> cp <span class=\"comment\">//返回设置好启动路径的Classpath对象</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Classpath)</span> <span class=\"title\">ReadClass</span><span class=\"params\">(className <span class=\"keyword\">string</span>)</span> <span class=\"params\">([]<span class=\"keyword\">byte</span>,Entry,error)</span></span>&#123;</span><br><span class=\"line\">\tclassName = className + <span class=\"string\">&quot;.class&quot;</span> <span class=\"comment\">//初始化className文件名</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> data, entry, err := self.bootClasspath.readClass(className); err == <span class=\"literal\">nil</span> &#123; <span class=\"comment\">//先扫描Boot启动路径下是否存在该className.class文件</span></span><br><span class=\"line\">\t   <span class=\"keyword\">return</span> data, entry, err <span class=\"comment\">//存在则返回</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> data, entry, err := self.extClasspath.readClass(className); err == <span class=\"literal\">nil</span> &#123; <span class=\"comment\">//再扫描Ext启动路径下是否存在该className.class文件</span></span><br><span class=\"line\">\t   <span class=\"keyword\">return</span> data, entry, err <span class=\"comment\">//存在则返回</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.userClasspath.readClass(className) <span class=\"comment\">//以上两个路径下都不存在，则扫描User启动路径</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Classpath)</span> <span class=\"title\">String</span><span class=\"params\">()</span> <span class=\"title\">string</span></span>  &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.userClasspath.String()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Classpath)</span> <span class=\"title\">parseBootAndExtClasspath</span><span class=\"params\">(jreOption <span class=\"keyword\">string</span>)</span></span> &#123; <span class=\"comment\">//按照-Xjre参数解析Boot和Ext启动路径</span></span><br><span class=\"line\">\tjreDir := getJreDir(jreOption) <span class=\"comment\">//获取jre路径</span></span><br><span class=\"line\">   <span class=\"comment\">// jre/lib/*</span></span><br><span class=\"line\">   jreLibPath := filepath.Join(jreDir, <span class=\"string\">&quot;lib&quot;</span>, <span class=\"string\">&quot;*&quot;</span>)</span><br><span class=\"line\">   self.bootClasspath = newWildcardEntry(jreLibPath)</span><br><span class=\"line\">   <span class=\"comment\">// jre/lib/ext/*</span></span><br><span class=\"line\">   jreExtPath := filepath.Join(jreDir, <span class=\"string\">&quot;lib&quot;</span>, <span class=\"string\">&quot;ext&quot;</span>, <span class=\"string\">&quot;*&quot;</span>)</span><br><span class=\"line\">   self.extClasspath = newWildcardEntry(jreExtPath)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">getJreDir</span><span class=\"params\">(jreOption <span class=\"keyword\">string</span>)</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> jreOption != <span class=\"string\">&quot;&quot;</span> &amp;&amp; exists(jreOption) &#123; <span class=\"comment\">//jreOption不为空且存在时返回该路径</span></span><br><span class=\"line\">\t   <span class=\"keyword\">return</span> jreOption</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> exists(<span class=\"string\">&quot;./jre&quot;</span>) &#123; <span class=\"comment\">//./jre路径存在时，返回.jre</span></span><br><span class=\"line\">\t   <span class=\"keyword\">return</span> <span class=\"string\">&quot;./jre&quot;</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> jh := os.Getenv(<span class=\"string\">&quot;JAVA_HOME&quot;</span>); jh != <span class=\"string\">&quot;&quot;</span> &#123; <span class=\"comment\">//环境变量JAVA_HOME存在并且不为空时</span></span><br><span class=\"line\">\t   <span class=\"keyword\">return</span> filepath.Join(jh, <span class=\"string\">&quot;jre&quot;</span>) <span class=\"comment\">//返回JAVA_HOME + &quot;jre&quot;</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"built_in\">panic</span>(<span class=\"string\">&quot;Can not find jre folder!&quot;</span>)</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">exists</span><span class=\"params\">(path <span class=\"keyword\">string</span>)</span> <span class=\"title\">bool</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> _, err := os.Stat(path); err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t   <span class=\"keyword\">if</span> os.IsNotExist(err) &#123;</span><br><span class=\"line\">\t\t  <span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t   &#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">true</span></span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Classpath)</span> <span class=\"title\">parseUserClasspath</span><span class=\"params\">(cpOption <span class=\"keyword\">string</span>)</span></span> &#123; <span class=\"comment\">//按照-cp|classpath参数解析User启动参数</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> cpOption == <span class=\"string\">&quot;&quot;</span> &#123; <span class=\"comment\">//cpOption为空时</span></span><br><span class=\"line\">\t   cpOption = <span class=\"string\">&quot;.&quot;</span> <span class=\"comment\">//返回相对路劲</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tself.userClasspath = newEntry(cpOption) <span class=\"comment\">//根据-cp|classpath参数实例化对应的Entry</span></span><br><span class=\"line\"> &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>main，修改启动类</p>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">startJVM</span><span class=\"params\">(cmd *Cmd)</span></span>&#123;</span><br><span class=\"line\">\tcp := classpath.Parse(cmd.XjreOption, cmd.cpOption) <span class=\"comment\">//根据-Xjre和-cp|classpath参数实例化classpath对象实例</span></span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">&quot;classpath:%v class:%v args:%v\\n&quot;</span>,</span><br><span class=\"line\">\t   cp, cmd.class, cmd.args)</span><br><span class=\"line\">\tclassName := strings.Replace(cmd.class, <span class=\"string\">&quot;.&quot;</span>, <span class=\"string\">&quot;/&quot;</span>, <span class=\"number\">-1</span>)</span><br><span class=\"line\">\tclassData, _, err := cp.ReadClass(className) <span class=\"comment\">//按照3个启动路径查找并读取className文件</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> err != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t   fmt.Printf(<span class=\"string\">&quot;Could not find or load main class %s\\n&quot;</span>, cmd.class)</span><br><span class=\"line\">\t   <span class=\"keyword\">return</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tfmt.Printf(<span class=\"string\">&quot;class data:%v\\n&quot;</span>, classData)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<ol start=\"3\">\n<li>试运行<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PS D:\\work\\workspace_go\\src\\jvmgo\\ch02&gt; go install</span><br><span class=\"line\"></span><br><span class=\"line\">PS D:\\work\\workspace_go\\bin&gt; .\\ch02.exe -Xjre &quot;C:\\Program Files\\Java\\jre1.8.0_202&quot; java.lang.Object</span><br><span class=\"line\">classpath:D:\\work\\workspace_go\\bin class:java.lang.Object args:[]</span><br><span class=\"line\">class data:[202 254 186 190 0 0 0 52 0 75 3 0 15 66 63 8 0 16 8 0 36 8 0 40 1 0 3 40 41 73 1 0 20 40 41 76 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 59 1 0 20 40 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 1 0 3 40 41 86 1 0 21 40 73 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 1 0 4 40 74 41 86 1 0 5 40 74 73 41 86 1 0 21 40 76 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 59 41 90 1 0 21 40 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 41 86 1 0 8 60 99 108 105 110 105 116 62 1 0 6 60 105 110 105 116 62 1 0 1 64 1 0 4 67 111 100</span><br><span class=\"line\">101 1 0 10 69 120 99 101 112 116 105 111 110 115 1 0 9 83 105 103 110 97 116 117 114 101 1 0 13 83 116 97 99 107 77 97 112 84 97 98 108 101 1 0 6 97 112 112 101 110 100 1 0 5 99 108 111 110 101 1 0 6 101 113</span><br><span class=\"line\">117 97 108 115 1 0 8 102 105 110 97 108 105 122 101 1 0 8 103 101 116 67 108 97 115 115 1 0 7 103 101 116 78 97 109 101 1 0 8 104 97 115 104 67 111 100 101 1 0 15 106 97 118 97 47 108 97 110 103 47 67 108 97</span><br><span class=\"line\">115 115 1 0 36 106 97 118 97 47 108 97 110 103 47 67 108 111 110 101 78 111 116 83 117 112 112 111 114 116 101 100 69 120 99 101 112 116 105 111 110 1 0 34 106 97 118 97 47 108 97 110 103 47 73 108 108 101 103 97 108 65 114 103 117 109 101 110 116 69 120 99 101 112 116 105 111 110 1 0 17 106 97 118 97 47 108 97 110 103 47 73 110 116 101 103 101 114 1 0 30 106 97 118 97 47 108 97 110 103 47 73 110 116 101 114 114</span><br><span class=\"line\">117 112 116 101 100 69 120 99 101 112 116 105 111 110 1 0 16 106 97 118 97 47 108 97 110 103 47 79 98 106 101 99 116 1 0 23 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 66 117 105 108 100 101 114 1 0 19 106 97 118 97 47 108 97 110 103 47 84 104 114 111 119 97 98 108 101 1 0 37 110 97 110 111 115 101 99 111 110 100 32 116 105 109 101 111 117 116 32 118 97 108 117 101 32 111 117 116 32 111 102 32 114 97 110 103 101 1 0 6 110 111 116 105 102 121 1 0 9 110 111 116 105 102 121 65 108 108 1 0 15 114 101 103 105 115 116 101 114 78 97 116 105 118 101 115 1 0 25 116 105 109 101 111 117 116 32 118 97 108 117 101 32 105 115 32 110 101 103 97 116 105 118 101 1 0 11 116 111 72 101 120 83 116 114 105 110 103 1 0 8 116 111 83 116 114 105 110 103 1 0 4 119 97 105 116 7 0 28 7 0 29 7 0 30 7 0 31 7 0 32 7 0 33 7 0 34 7 0 35 1 0 19 40 41 76 106 97 118 97 47 108 97 110 103 47 67 108 97 115 115 59 1 0 22 40 41 76 106 97 118 97 47 108 97 110 103 47 67 108 97 115 115 60 42 62 59 1 0 45 40 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 59 41 76 106 97 118 97 47 108 97 110 103 47 83 116 114 105 110 103 66 117 105 108 100 101 114 59 12 0 27 0 5 12 0 15 0 8 12 0 39 0 8 12 0 43 0 10 12 0 25 0 52 12 0 26 0 7 12 0 42 0 7 12 0 41 0</span><br><span class=\"line\">9 12 0 15 0 13 12 0 21 0 54 10 0 44 0 60 10 0 46 0 63 10 0 47 0 62 10 0 49 0 55 10 0 49 0 57 10 0 49 0 58 10 0 49 0 59 10 0 50 0 56 10 0 50 0 61 10 0 50 0 64 0 33 0 49 0 0 0 0 0 0 0 14 0 1 0 15 0 8 0 1 0 17 0 0 0 13 0 0 0 1 0 0 0 1 177 0 0 0 0 1 10 0 39 0 8 0 0 1 17 0 25 0 52 0 1 0 19 0 0 0 2 0 53 1 1 0 27 0 5 0 0 0 1 0 23 0 12 0 1 0 17 0 0 0 34 0 2 0 2 0 0 0 11 42 43 166 0 7 4 167 0 4 3 172 0 0 0 1 0 20 0 0 0 5</span><br><span class=\"line\">0 2 9 64 1 1 4 0 22 0 6 0 1 0 18 0 0 0 4 0 1 0 45 0 1 0 42 0 7 0 1 0 17 0 0 0 48 0 2 0 1 0 0 0 36 187 0 50 89 183 0 72 42 182 0 71 182 0 65 182 0 74 18 2 182 0 74 42 182 0 68 184 0 67 182 0 74 182 0 73 176 0</span><br><span class=\"line\">0 0 0 1 17 0 37 0 8 0 0 1 17 0 38 0 8 0 0 1 17 0 43 0 10 0 1 0 18 0 0 0 4 0 1 0 48 0 17 0 43 0 11 0 2 0 17 0 0 0 74 0 4 0 4 0 0 0 50 31 9 148 156 0 13 187 0 46 89 18 4 183 0 66 191 29 155 0 9 29 18 1 164 0 13 187 0 46 89 18 3 183 0 66 191 29 158 0 7 31 10 97 64 42 31 182 0 70 177 0 0 0 1 0 20 0 0 0 6 0 4 16 9 9 7 0 18 0 0 0 4 0 1 0 48 0 17 0 43 0 8 0 2 0 17 0 0 0 18 0 3 0 1 0 0 0 6 42 9 182 0 70 177 0 0 0 0 0 18</span><br><span class=\"line\">0 0 0 4 0 1 0 48 0 4 0 24 0 8 0 2 0 17 0 0 0 13 0 0 0 1 0 0 0 1 177 0 0 0 0 0 18 0 0 0 4 0 1 0 51 0 8 0 14 0 8 0 1 0 17 0 0 0 16 0 0 0 0 0 0 0 4 184 0 69 177 0 0 0 0 0 0]</span><br></pre></td></tr></table></figure>\n</li>\n</ol>"},{"title":"自己动手写Java虚拟机 笔记3","date":"2019-09-13T10:44:38.000Z","_content":"\n第三篇主要学习JVM中class文件的具体结构，和JVM是如何解析这些结构的。\n我们可以通过javac工具将一个java文件compile成一个.class文件，并通过我们自己写的jvm将该文件解析并打印出来。通过class文件的学习能让我们更加深刻的理解java是怎样实现跨平台，并且我们编写的java代码又是如何在JVM中体现的。\n<!-- more -->\n\n### JVM中class文件结构(ClassFile)\nLength|name\n---|---\nu4|magic\nu2|minor_version\nu2|major_version\nu2|constant_pool_count\ncp_info|constant_pool[constant_pool_count-1]\nu2|access_flags\nu2|this_class\nu2|super_class\nu2|interfaces_count\nu2|interfaces[interfaces_count]\nu2|fields_count\nfield_info|fields[fields_count]\nu2|methods_count\nmethod_info|methods[methods_count]\n\n### JVM中字段结构(field_info)\nLength|name\n---|---\nu2|access_flags\nu2|name_index\nu2|descriptor_index\nu2|attributes_count\nattribute_info|attributes[attributes_count]\n\n### JVM中访问控制符结构(access_flags)\n标志名|标志值|标志含义|针对的对象\n---|---|---|---\nACC_PUBLIC|0x0001|public类型|所有类型\nACC_FINAL|0x0010|final类型|类\nACC_SUPER|0x0020|使用新的invokespecial语义|类和接口\nACC_INTERFACE|0x0200|接口类型|接口\nACC_ABSTRACT|0x0400|抽象类型|类和接口\nACC_SYNTHETIC|0x1000|该类不由用户代码生成|所有类型\nACC_ANNOTATION|0x2000|注解类型|注解\nACC_ENUM|0x4000|枚举类型|枚举\n\n### 实现\n1. 定义Class文件的录取类(ClassReader)\n\n{% codeblock lang:golang %}\ntype ClassReader struct {\n\tdata []byte //class文件字节流\n}\n\n// 读取u1\nfunc (self *ClassReader) readUint8() uint8 {\n\tval := self.data[0] //读取1Byte\n\tself.data = self.data[1:]\n\treturn val\n}\n\n// u2\nfunc (self *ClassReader) readUint16() uint16 {\n\tval := binary.BigEndian.Uint16(self.data) //读取2Byte并转为uint16\n\tself.data = self.data[2:]\n\treturn val\n}\n\n// u4\nfunc (self *ClassReader) readUint32() uint32 {\n\tval := binary.BigEndian.Uint32(self.data) //读取4Byte并转为uint32\n\tself.data = self.data[4:]\n\treturn val\n}\n\nfunc (self *ClassReader) readUint64() uint64 {\n\tval := binary.BigEndian.Uint64(self.data) //读取8Byte并转为uint64\n\tself.data = self.data[8:]\n\treturn val\n}\n\nfunc (self *ClassReader) readUint16s() []uint16 {\n\tn := self.readUint16() //读取2Byte，该值为后续数组的长度\n\ts := make([]uint16, n) //生产长度为n的uint16类型数组\n\tfor i := range s {\n\t\ts[i] = self.readUint16() //读取class文件，每读取2Byte便放入数组\n\t}\n\treturn s\n}\n\nfunc (self *ClassReader) readBytes(n uint32) []byte {\n\tbytes := self.data[:n] //读取长度为n的字节\n\tself.data = self.data[n:]\n\treturn bytes\n}\n{% endcodeblock %}\n\n1. 定义Class文件的格式(ClassFile)\n\n{% codeblock lang:golang %}\ntype ClassFile struct { //按照jvm规范，定义class文件结构\n\t//magic      uint32\n\tminorVersion uint16\n\tmajorVersion uint16\n\tconstantPool ConstantPool\n\taccessFlags  uint16\n\tthisClass    uint16\n\tsuperClass   uint16\n\tinterfaces   []uint16\n\tfields       []*MemberInfo\n\tmethods      []*MemberInfo\n\tattributes   []AttributeInfo\n}\n\n//文件解析入口方法，入参class文件流，返回class文件对象\nfunc Parse(classData []byte) (cf *ClassFile, err error) {\n\tdefer func() { //捕获异常\n\t\tif r := recover(); r != nil {\n\t\t\tvar ok bool\n\t\t\terr, ok = r.(error)\n\t\t\tif !ok {\n\t\t\t\terr = fmt.Errorf(\"%v\", r)\n\t\t\t}\n\t\t}\n\t}()\n\n\tcr := &ClassReader{classData} //实例化classReader类\n\tcf = &ClassFile{} //实例化ClassFile类\n\tcf.read(cr) //读取class文件\n\treturn\n}\n\n//读取class文件的具体方法\nfunc (self *ClassFile) read(reader *ClassReader) {\n\tself.readAndCheckMagic(reader) //读取魔数\n\tself.readAndCheckVersion(reader) //读取主次版本号\n\tself.constantPool = readConstantPool(reader) //读取常量池\n\tself.accessFlags = reader.readUint16() //读取当前类（或者接口）的访问修饰符\n\tself.thisClass = reader.readUint16() //读取当前类索引\n\tself.superClass = reader.readUint16() //读取父类索引\n\tself.interfaces = reader.readUint16s() //读取所有接口索引\n\tself.fields = readMembers(reader, self.constantPool) //从常量池中读取所有成员\n\tself.methods = readMembers(reader, self.constantPool) //从常量池中读取所有方法\n\tself.attributes = readAttributes(reader, self.constantPool) //从常量池中读取所有属性\n}\n\nfunc (self *ClassFile) readAndCheckMagic(reader *ClassReader) {\n\tmagic := reader.readUint32() //读取4Byte魔数\n\tif magic != 0xCAFEBABE { //判断魔数是否为0xCAFEBABE\n\t\tpanic(\"java.lang.ClassFormatError: magic!\")\n\t}\n}\n\nfunc (self *ClassFile) readAndCheckVersion(reader *ClassReader) {\n\tself.minorVersion = reader.readUint16() //高2Byte为次版本号\n\tself.majorVersion = reader.readUint16() //低2Byte为主版本号\n\tswitch self.majorVersion { //检查版本号是否为45~52\n\tcase 45:\n\t\treturn\n\tcase 46, 47, 48, 49, 50, 51, 52:\n\t\tif self.minorVersion == 0 {\n\t\t\treturn\n\t\t}\n\t}\n\n\tpanic(\"java.lang.UnsupportedClassVersionError!\")\n}\n\n//对外暴露get方法\nfunc (self *ClassFile) MinorVersion() uint16 {\n\treturn self.minorVersion\n}\n//对外暴露get方法\nfunc (self *ClassFile) MajorVersion() uint16 {\n\treturn self.majorVersion\n}\n//对外暴露get方法\nfunc (self *ClassFile) ConstantPool() ConstantPool {\n\treturn self.constantPool\n}\n//对外暴露get方法\nfunc (self *ClassFile) AccessFlags() uint16 {\n\treturn self.accessFlags\n}\n//对外暴露get方法\nfunc (self *ClassFile) Fields() []*MemberInfo {\n\treturn self.fields\n}\n//对外暴露get方法\nfunc (self *ClassFile) Methods() []*MemberInfo {\n\treturn self.methods\n}\n//对外暴露get方法，根据thisClass索引在常量池中查找名称\nfunc (self *ClassFile) ClassName() string {\n\treturn self.constantPool.getClassName(self.thisClass)\n}\n//对外暴露get方法，根据superClass索引在常量池中查找名称\nfunc (self *ClassFile) SuperClassName() string {\n\tif self.superClass > 0 {\n\t\treturn self.constantPool.getClassName(self.superClass)\n\t}\n\treturn \"\"\n}\n//对外暴露get方法，根据interfaces索引在常量池中查找名称\nfunc (self *ClassFile) InterfaceNames() []string {\n\tinterfaceNames := make([]string, len(self.interfaces))\n\tfor i, cpIndex := range self.interfaces {\n\t\tinterfaceNames[i] = self.constantPool.getClassName(cpIndex)\n\t}\n\treturn interfaceNames\n}\n{% endcodeblock %}\n\n1. 定义字段和方法的结构(field_info、method_info)\n\n{% codeblock lang:golang %}\ntype MemberInfo struct { //field和method的结构类型，使用同一个结构\n\tcp              ConstantPool //当前常量池\n\taccessFlags     uint16 //访问标志\n\tnameIndex       uint16 //名称索引\n\tdescriptorIndex uint16 //描述索引\n\tattributes      []AttributeInfo //属性列表 \n}\n\n// read field or method table\nfunc readMembers(reader *ClassReader, cp ConstantPool) []*MemberInfo {\n\tmemberCount := reader.readUint16() //读取field或method数量\n\tmembers := make([]*MemberInfo, memberCount) //创建数组\n\tfor i := range members {\n\t\tmembers[i] = readMember(reader, cp)\n\t}\n\treturn members\n}\n\n//具体读取field和method的方法\nfunc readMember(reader *ClassReader, cp ConstantPool) *MemberInfo {\n\treturn &MemberInfo{\n\t\tcp:              cp,\n\t\taccessFlags:     reader.readUint16(), //读取2Byte的访问控制符\n\t\tnameIndex:       reader.readUint16(), //读取2Byte的名称索引\n\t\tdescriptorIndex: reader.readUint16(), //读取2Byte的描述索引\n\t\tattributes:      readAttributes(reader, cp), //读取属性列表\n\t}\n}\n\n//对外暴露get方法\nfunc (self *MemberInfo) AccessFlags() uint16 {\n\treturn self.accessFlags\n}\n//对外暴露get方法，通过名称索引访问常量池\nfunc (self *MemberInfo) Name() string {\n\treturn self.cp.getUtf8(self.nameIndex)\n}\n//对外暴露get方法，通过描述索引访问常量池\nfunc (self *MemberInfo) Descriptor() string {\n\treturn self.cp.getUtf8(self.descriptorIndex)\n}\n\n{% endcodeblock %}","source":"_posts/自己动手写Java虚拟机-笔记3.md","raw":"---\ntitle: 自己动手写Java虚拟机 笔记3\ndate: 2019-09-13 18:44:38\ntags: \n    - JVM\n    - Java\n    - Go\ncategories :\n    - Technology\n---\n\n第三篇主要学习JVM中class文件的具体结构，和JVM是如何解析这些结构的。\n我们可以通过javac工具将一个java文件compile成一个.class文件，并通过我们自己写的jvm将该文件解析并打印出来。通过class文件的学习能让我们更加深刻的理解java是怎样实现跨平台，并且我们编写的java代码又是如何在JVM中体现的。\n<!-- more -->\n\n### JVM中class文件结构(ClassFile)\nLength|name\n---|---\nu4|magic\nu2|minor_version\nu2|major_version\nu2|constant_pool_count\ncp_info|constant_pool[constant_pool_count-1]\nu2|access_flags\nu2|this_class\nu2|super_class\nu2|interfaces_count\nu2|interfaces[interfaces_count]\nu2|fields_count\nfield_info|fields[fields_count]\nu2|methods_count\nmethod_info|methods[methods_count]\n\n### JVM中字段结构(field_info)\nLength|name\n---|---\nu2|access_flags\nu2|name_index\nu2|descriptor_index\nu2|attributes_count\nattribute_info|attributes[attributes_count]\n\n### JVM中访问控制符结构(access_flags)\n标志名|标志值|标志含义|针对的对象\n---|---|---|---\nACC_PUBLIC|0x0001|public类型|所有类型\nACC_FINAL|0x0010|final类型|类\nACC_SUPER|0x0020|使用新的invokespecial语义|类和接口\nACC_INTERFACE|0x0200|接口类型|接口\nACC_ABSTRACT|0x0400|抽象类型|类和接口\nACC_SYNTHETIC|0x1000|该类不由用户代码生成|所有类型\nACC_ANNOTATION|0x2000|注解类型|注解\nACC_ENUM|0x4000|枚举类型|枚举\n\n### 实现\n1. 定义Class文件的录取类(ClassReader)\n\n{% codeblock lang:golang %}\ntype ClassReader struct {\n\tdata []byte //class文件字节流\n}\n\n// 读取u1\nfunc (self *ClassReader) readUint8() uint8 {\n\tval := self.data[0] //读取1Byte\n\tself.data = self.data[1:]\n\treturn val\n}\n\n// u2\nfunc (self *ClassReader) readUint16() uint16 {\n\tval := binary.BigEndian.Uint16(self.data) //读取2Byte并转为uint16\n\tself.data = self.data[2:]\n\treturn val\n}\n\n// u4\nfunc (self *ClassReader) readUint32() uint32 {\n\tval := binary.BigEndian.Uint32(self.data) //读取4Byte并转为uint32\n\tself.data = self.data[4:]\n\treturn val\n}\n\nfunc (self *ClassReader) readUint64() uint64 {\n\tval := binary.BigEndian.Uint64(self.data) //读取8Byte并转为uint64\n\tself.data = self.data[8:]\n\treturn val\n}\n\nfunc (self *ClassReader) readUint16s() []uint16 {\n\tn := self.readUint16() //读取2Byte，该值为后续数组的长度\n\ts := make([]uint16, n) //生产长度为n的uint16类型数组\n\tfor i := range s {\n\t\ts[i] = self.readUint16() //读取class文件，每读取2Byte便放入数组\n\t}\n\treturn s\n}\n\nfunc (self *ClassReader) readBytes(n uint32) []byte {\n\tbytes := self.data[:n] //读取长度为n的字节\n\tself.data = self.data[n:]\n\treturn bytes\n}\n{% endcodeblock %}\n\n1. 定义Class文件的格式(ClassFile)\n\n{% codeblock lang:golang %}\ntype ClassFile struct { //按照jvm规范，定义class文件结构\n\t//magic      uint32\n\tminorVersion uint16\n\tmajorVersion uint16\n\tconstantPool ConstantPool\n\taccessFlags  uint16\n\tthisClass    uint16\n\tsuperClass   uint16\n\tinterfaces   []uint16\n\tfields       []*MemberInfo\n\tmethods      []*MemberInfo\n\tattributes   []AttributeInfo\n}\n\n//文件解析入口方法，入参class文件流，返回class文件对象\nfunc Parse(classData []byte) (cf *ClassFile, err error) {\n\tdefer func() { //捕获异常\n\t\tif r := recover(); r != nil {\n\t\t\tvar ok bool\n\t\t\terr, ok = r.(error)\n\t\t\tif !ok {\n\t\t\t\terr = fmt.Errorf(\"%v\", r)\n\t\t\t}\n\t\t}\n\t}()\n\n\tcr := &ClassReader{classData} //实例化classReader类\n\tcf = &ClassFile{} //实例化ClassFile类\n\tcf.read(cr) //读取class文件\n\treturn\n}\n\n//读取class文件的具体方法\nfunc (self *ClassFile) read(reader *ClassReader) {\n\tself.readAndCheckMagic(reader) //读取魔数\n\tself.readAndCheckVersion(reader) //读取主次版本号\n\tself.constantPool = readConstantPool(reader) //读取常量池\n\tself.accessFlags = reader.readUint16() //读取当前类（或者接口）的访问修饰符\n\tself.thisClass = reader.readUint16() //读取当前类索引\n\tself.superClass = reader.readUint16() //读取父类索引\n\tself.interfaces = reader.readUint16s() //读取所有接口索引\n\tself.fields = readMembers(reader, self.constantPool) //从常量池中读取所有成员\n\tself.methods = readMembers(reader, self.constantPool) //从常量池中读取所有方法\n\tself.attributes = readAttributes(reader, self.constantPool) //从常量池中读取所有属性\n}\n\nfunc (self *ClassFile) readAndCheckMagic(reader *ClassReader) {\n\tmagic := reader.readUint32() //读取4Byte魔数\n\tif magic != 0xCAFEBABE { //判断魔数是否为0xCAFEBABE\n\t\tpanic(\"java.lang.ClassFormatError: magic!\")\n\t}\n}\n\nfunc (self *ClassFile) readAndCheckVersion(reader *ClassReader) {\n\tself.minorVersion = reader.readUint16() //高2Byte为次版本号\n\tself.majorVersion = reader.readUint16() //低2Byte为主版本号\n\tswitch self.majorVersion { //检查版本号是否为45~52\n\tcase 45:\n\t\treturn\n\tcase 46, 47, 48, 49, 50, 51, 52:\n\t\tif self.minorVersion == 0 {\n\t\t\treturn\n\t\t}\n\t}\n\n\tpanic(\"java.lang.UnsupportedClassVersionError!\")\n}\n\n//对外暴露get方法\nfunc (self *ClassFile) MinorVersion() uint16 {\n\treturn self.minorVersion\n}\n//对外暴露get方法\nfunc (self *ClassFile) MajorVersion() uint16 {\n\treturn self.majorVersion\n}\n//对外暴露get方法\nfunc (self *ClassFile) ConstantPool() ConstantPool {\n\treturn self.constantPool\n}\n//对外暴露get方法\nfunc (self *ClassFile) AccessFlags() uint16 {\n\treturn self.accessFlags\n}\n//对外暴露get方法\nfunc (self *ClassFile) Fields() []*MemberInfo {\n\treturn self.fields\n}\n//对外暴露get方法\nfunc (self *ClassFile) Methods() []*MemberInfo {\n\treturn self.methods\n}\n//对外暴露get方法，根据thisClass索引在常量池中查找名称\nfunc (self *ClassFile) ClassName() string {\n\treturn self.constantPool.getClassName(self.thisClass)\n}\n//对外暴露get方法，根据superClass索引在常量池中查找名称\nfunc (self *ClassFile) SuperClassName() string {\n\tif self.superClass > 0 {\n\t\treturn self.constantPool.getClassName(self.superClass)\n\t}\n\treturn \"\"\n}\n//对外暴露get方法，根据interfaces索引在常量池中查找名称\nfunc (self *ClassFile) InterfaceNames() []string {\n\tinterfaceNames := make([]string, len(self.interfaces))\n\tfor i, cpIndex := range self.interfaces {\n\t\tinterfaceNames[i] = self.constantPool.getClassName(cpIndex)\n\t}\n\treturn interfaceNames\n}\n{% endcodeblock %}\n\n1. 定义字段和方法的结构(field_info、method_info)\n\n{% codeblock lang:golang %}\ntype MemberInfo struct { //field和method的结构类型，使用同一个结构\n\tcp              ConstantPool //当前常量池\n\taccessFlags     uint16 //访问标志\n\tnameIndex       uint16 //名称索引\n\tdescriptorIndex uint16 //描述索引\n\tattributes      []AttributeInfo //属性列表 \n}\n\n// read field or method table\nfunc readMembers(reader *ClassReader, cp ConstantPool) []*MemberInfo {\n\tmemberCount := reader.readUint16() //读取field或method数量\n\tmembers := make([]*MemberInfo, memberCount) //创建数组\n\tfor i := range members {\n\t\tmembers[i] = readMember(reader, cp)\n\t}\n\treturn members\n}\n\n//具体读取field和method的方法\nfunc readMember(reader *ClassReader, cp ConstantPool) *MemberInfo {\n\treturn &MemberInfo{\n\t\tcp:              cp,\n\t\taccessFlags:     reader.readUint16(), //读取2Byte的访问控制符\n\t\tnameIndex:       reader.readUint16(), //读取2Byte的名称索引\n\t\tdescriptorIndex: reader.readUint16(), //读取2Byte的描述索引\n\t\tattributes:      readAttributes(reader, cp), //读取属性列表\n\t}\n}\n\n//对外暴露get方法\nfunc (self *MemberInfo) AccessFlags() uint16 {\n\treturn self.accessFlags\n}\n//对外暴露get方法，通过名称索引访问常量池\nfunc (self *MemberInfo) Name() string {\n\treturn self.cp.getUtf8(self.nameIndex)\n}\n//对外暴露get方法，通过描述索引访问常量池\nfunc (self *MemberInfo) Descriptor() string {\n\treturn self.cp.getUtf8(self.descriptorIndex)\n}\n\n{% endcodeblock %}","slug":"自己动手写Java虚拟机-笔记3","published":1,"updated":"2020-12-14T09:51:24.056Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htw001uv2525k2udzt3","content":"<html><head></head><body><p>&#x7B2C;&#x4E09;&#x7BC7;&#x4E3B;&#x8981;&#x5B66;&#x4E60;JVM&#x4E2D;class&#x6587;&#x4EF6;&#x7684;&#x5177;&#x4F53;&#x7ED3;&#x6784;&#xFF0C;&#x548C;JVM&#x662F;&#x5982;&#x4F55;&#x89E3;&#x6790;&#x8FD9;&#x4E9B;&#x7ED3;&#x6784;&#x7684;&#x3002;<br>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;javac&#x5DE5;&#x5177;&#x5C06;&#x4E00;&#x4E2A;java&#x6587;&#x4EF6;compile&#x6210;&#x4E00;&#x4E2A;.class&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x5199;&#x7684;jvm&#x5C06;&#x8BE5;&#x6587;&#x4EF6;&#x89E3;&#x6790;&#x5E76;&#x6253;&#x5370;&#x51FA;&#x6765;&#x3002;&#x901A;&#x8FC7;class&#x6587;&#x4EF6;&#x7684;&#x5B66;&#x4E60;&#x80FD;&#x8BA9;&#x6211;&#x4EEC;&#x66F4;&#x52A0;&#x6DF1;&#x523B;&#x7684;&#x7406;&#x89E3;java&#x662F;&#x600E;&#x6837;&#x5B9E;&#x73B0;&#x8DE8;&#x5E73;&#x53F0;&#xFF0C;&#x5E76;&#x4E14;&#x6211;&#x4EEC;&#x7F16;&#x5199;&#x7684;java&#x4EE3;&#x7801;&#x53C8;&#x662F;&#x5982;&#x4F55;&#x5728;JVM&#x4E2D;&#x4F53;&#x73B0;&#x7684;&#x3002;</p>\n<a id=\"more\"></a>\n\n<h3 id=\"JVM&#x4E2D;class&#x6587;&#x4EF6;&#x7ED3;&#x6784;-ClassFile\"><a href=\"#JVM&#x4E2D;class&#x6587;&#x4EF6;&#x7ED3;&#x6784;-ClassFile\" class=\"headerlink\" title=\"JVM&#x4E2D;class&#x6587;&#x4EF6;&#x7ED3;&#x6784;(ClassFile)\"></a>JVM&#x4E2D;class&#x6587;&#x4EF6;&#x7ED3;&#x6784;(ClassFile)</h3><table>\n<thead>\n<tr>\n<th>Length</th>\n<th>name</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>u4</td>\n<td>magic</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>minor_version</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>major_version</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>constant_pool_count</td>\n</tr>\n<tr>\n<td>cp_info</td>\n<td>constant_pool[constant_pool_count-1]</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>access_flags</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>this_class</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>super_class</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>interfaces_count</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>interfaces[interfaces_count]</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>fields_count</td>\n</tr>\n<tr>\n<td>field_info</td>\n<td>fields[fields_count]</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>methods_count</td>\n</tr>\n<tr>\n<td>method_info</td>\n<td>methods[methods_count]</td>\n</tr>\n</tbody></table>\n<h3 id=\"JVM&#x4E2D;&#x5B57;&#x6BB5;&#x7ED3;&#x6784;-field-info\"><a href=\"#JVM&#x4E2D;&#x5B57;&#x6BB5;&#x7ED3;&#x6784;-field-info\" class=\"headerlink\" title=\"JVM&#x4E2D;&#x5B57;&#x6BB5;&#x7ED3;&#x6784;(field_info)\"></a>JVM&#x4E2D;&#x5B57;&#x6BB5;&#x7ED3;&#x6784;(field_info)</h3><table>\n<thead>\n<tr>\n<th>Length</th>\n<th>name</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>u2</td>\n<td>access_flags</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>name_index</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>descriptor_index</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>attributes_count</td>\n</tr>\n<tr>\n<td>attribute_info</td>\n<td>attributes[attributes_count]</td>\n</tr>\n</tbody></table>\n<h3 id=\"JVM&#x4E2D;&#x8BBF;&#x95EE;&#x63A7;&#x5236;&#x7B26;&#x7ED3;&#x6784;-access-flags\"><a href=\"#JVM&#x4E2D;&#x8BBF;&#x95EE;&#x63A7;&#x5236;&#x7B26;&#x7ED3;&#x6784;-access-flags\" class=\"headerlink\" title=\"JVM&#x4E2D;&#x8BBF;&#x95EE;&#x63A7;&#x5236;&#x7B26;&#x7ED3;&#x6784;(access_flags)\"></a>JVM&#x4E2D;&#x8BBF;&#x95EE;&#x63A7;&#x5236;&#x7B26;&#x7ED3;&#x6784;(access_flags)</h3><table>\n<thead>\n<tr>\n<th>&#x6807;&#x5FD7;&#x540D;</th>\n<th>&#x6807;&#x5FD7;&#x503C;</th>\n<th>&#x6807;&#x5FD7;&#x542B;&#x4E49;</th>\n<th>&#x9488;&#x5BF9;&#x7684;&#x5BF9;&#x8C61;</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ACC_PUBLIC</td>\n<td>0x0001</td>\n<td>public&#x7C7B;&#x578B;</td>\n<td>&#x6240;&#x6709;&#x7C7B;&#x578B;</td>\n</tr>\n<tr>\n<td>ACC_FINAL</td>\n<td>0x0010</td>\n<td>final&#x7C7B;&#x578B;</td>\n<td>&#x7C7B;</td>\n</tr>\n<tr>\n<td>ACC_SUPER</td>\n<td>0x0020</td>\n<td>&#x4F7F;&#x7528;&#x65B0;&#x7684;invokespecial&#x8BED;&#x4E49;</td>\n<td>&#x7C7B;&#x548C;&#x63A5;&#x53E3;</td>\n</tr>\n<tr>\n<td>ACC_INTERFACE</td>\n<td>0x0200</td>\n<td>&#x63A5;&#x53E3;&#x7C7B;&#x578B;</td>\n<td>&#x63A5;&#x53E3;</td>\n</tr>\n<tr>\n<td>ACC_ABSTRACT</td>\n<td>0x0400</td>\n<td>&#x62BD;&#x8C61;&#x7C7B;&#x578B;</td>\n<td>&#x7C7B;&#x548C;&#x63A5;&#x53E3;</td>\n</tr>\n<tr>\n<td>ACC_SYNTHETIC</td>\n<td>0x1000</td>\n<td>&#x8BE5;&#x7C7B;&#x4E0D;&#x7531;&#x7528;&#x6237;&#x4EE3;&#x7801;&#x751F;&#x6210;</td>\n<td>&#x6240;&#x6709;&#x7C7B;&#x578B;</td>\n</tr>\n<tr>\n<td>ACC_ANNOTATION</td>\n<td>0x2000</td>\n<td>&#x6CE8;&#x89E3;&#x7C7B;&#x578B;</td>\n<td>&#x6CE8;&#x89E3;</td>\n</tr>\n<tr>\n<td>ACC_ENUM</td>\n<td>0x4000</td>\n<td>&#x679A;&#x4E3E;&#x7C7B;&#x578B;</td>\n<td>&#x679A;&#x4E3E;</td>\n</tr>\n</tbody></table>\n<h3 id=\"&#x5B9E;&#x73B0;\"><a href=\"#&#x5B9E;&#x73B0;\" class=\"headerlink\" title=\"&#x5B9E;&#x73B0;\"></a>&#x5B9E;&#x73B0;</h3><ol>\n<li>&#x5B9A;&#x4E49;Class&#x6587;&#x4EF6;&#x7684;&#x5F55;&#x53D6;&#x7C7B;(ClassReader)</li>\n</ol>\n<figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> ClassReader <span class=\"hljs-keyword\">struct</span> {</span><br><span class=\"line\">\tdata []<span class=\"hljs-keyword\">byte</span> <span class=\"hljs-comment\">//class&#x6587;&#x4EF6;&#x5B57;&#x8282;&#x6D41;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// &#x8BFB;&#x53D6;u1</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassReader)</span> <span class=\"hljs-title\">readUint8</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">uint8</span></span> {</span><br><span class=\"line\">\tval := self.data[<span class=\"hljs-number\">0</span>] <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;1Byte</span></span><br><span class=\"line\">\tself.data = self.data[<span class=\"hljs-number\">1</span>:]</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> val</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// u2</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassReader)</span> <span class=\"hljs-title\">readUint16</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">uint16</span></span> {</span><br><span class=\"line\">\tval := binary.BigEndian.Uint16(self.data) <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;2Byte&#x5E76;&#x8F6C;&#x4E3A;uint16</span></span><br><span class=\"line\">\tself.data = self.data[<span class=\"hljs-number\">2</span>:]</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> val</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// u4</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassReader)</span> <span class=\"hljs-title\">readUint32</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">uint32</span></span> {</span><br><span class=\"line\">\tval := binary.BigEndian.Uint32(self.data) <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;4Byte&#x5E76;&#x8F6C;&#x4E3A;uint32</span></span><br><span class=\"line\">\tself.data = self.data[<span class=\"hljs-number\">4</span>:]</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> val</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassReader)</span> <span class=\"hljs-title\">readUint64</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">uint64</span></span> {</span><br><span class=\"line\">\tval := binary.BigEndian.Uint64(self.data) <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;8Byte&#x5E76;&#x8F6C;&#x4E3A;uint64</span></span><br><span class=\"line\">\tself.data = self.data[<span class=\"hljs-number\">8</span>:]</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> val</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassReader)</span> <span class=\"hljs-title\">readUint16s</span><span class=\"hljs-params\">()</span> []<span class=\"hljs-title\">uint16</span></span> {</span><br><span class=\"line\">\tn := self.readUint16() <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;2Byte&#xFF0C;&#x8BE5;&#x503C;&#x4E3A;&#x540E;&#x7EED;&#x6570;&#x7EC4;&#x7684;&#x957F;&#x5EA6;</span></span><br><span class=\"line\">\ts := <span class=\"hljs-built_in\">make</span>([]<span class=\"hljs-keyword\">uint16</span>, n) <span class=\"hljs-comment\">//&#x751F;&#x4EA7;&#x957F;&#x5EA6;&#x4E3A;n&#x7684;uint16&#x7C7B;&#x578B;&#x6570;&#x7EC4;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">for</span> i := <span class=\"hljs-keyword\">range</span> s {</span><br><span class=\"line\">\t\ts[i] = self.readUint16() <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;class&#x6587;&#x4EF6;&#xFF0C;&#x6BCF;&#x8BFB;&#x53D6;2Byte&#x4FBF;&#x653E;&#x5165;&#x6570;&#x7EC4;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> s</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassReader)</span> <span class=\"hljs-title\">readBytes</span><span class=\"hljs-params\">(n <span class=\"hljs-keyword\">uint32</span>)</span> []<span class=\"hljs-title\">byte</span></span> {</span><br><span class=\"line\">\tbytes := self.data[:n] <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;&#x957F;&#x5EA6;&#x4E3A;n&#x7684;&#x5B57;&#x8282;</span></span><br><span class=\"line\">\tself.data = self.data[n:]</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> bytes</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<ol>\n<li>&#x5B9A;&#x4E49;Class&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;(ClassFile)</li>\n</ol>\n<figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> ClassFile <span class=\"hljs-keyword\">struct</span> { <span class=\"hljs-comment\">//&#x6309;&#x7167;jvm&#x89C4;&#x8303;&#xFF0C;&#x5B9A;&#x4E49;class&#x6587;&#x4EF6;&#x7ED3;&#x6784;</span></span><br><span class=\"line\">\t<span class=\"hljs-comment\">//magic      uint32</span></span><br><span class=\"line\">\tminorVersion <span class=\"hljs-keyword\">uint16</span></span><br><span class=\"line\">\tmajorVersion <span class=\"hljs-keyword\">uint16</span></span><br><span class=\"line\">\tconstantPool ConstantPool</span><br><span class=\"line\">\taccessFlags  <span class=\"hljs-keyword\">uint16</span></span><br><span class=\"line\">\tthisClass    <span class=\"hljs-keyword\">uint16</span></span><br><span class=\"line\">\tsuperClass   <span class=\"hljs-keyword\">uint16</span></span><br><span class=\"line\">\tinterfaces   []<span class=\"hljs-keyword\">uint16</span></span><br><span class=\"line\">\tfields       []*MemberInfo</span><br><span class=\"line\">\tmethods      []*MemberInfo</span><br><span class=\"line\">\tattributes   []AttributeInfo</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x6587;&#x4EF6;&#x89E3;&#x6790;&#x5165;&#x53E3;&#x65B9;&#x6CD5;&#xFF0C;&#x5165;&#x53C2;class&#x6587;&#x4EF6;&#x6D41;&#xFF0C;&#x8FD4;&#x56DE;class&#x6587;&#x4EF6;&#x5BF9;&#x8C61;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">Parse</span><span class=\"hljs-params\">(classData []<span class=\"hljs-keyword\">byte</span>)</span> <span class=\"hljs-params\">(cf *ClassFile, err error)</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">defer</span> <span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span><span class=\"hljs-params\">()</span></span> { <span class=\"hljs-comment\">//&#x6355;&#x83B7;&#x5F02;&#x5E38;</span></span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">if</span> r := <span class=\"hljs-built_in\">recover</span>(); r != <span class=\"hljs-literal\">nil</span> {</span><br><span class=\"line\">\t\t\t<span class=\"hljs-keyword\">var</span> ok <span class=\"hljs-keyword\">bool</span></span><br><span class=\"line\">\t\t\terr, ok = r.(error)</span><br><span class=\"line\">\t\t\t<span class=\"hljs-keyword\">if</span> !ok {</span><br><span class=\"line\">\t\t\t\terr = fmt.Errorf(<span class=\"hljs-string\">&quot;%v&quot;</span>, r)</span><br><span class=\"line\">\t\t\t}</span><br><span class=\"line\">\t\t}</span><br><span class=\"line\">\t}()</span><br><span class=\"line\"></span><br><span class=\"line\">\tcr := &amp;ClassReader{classData} <span class=\"hljs-comment\">//&#x5B9E;&#x4F8B;&#x5316;classReader&#x7C7B;</span></span><br><span class=\"line\">\tcf = &amp;ClassFile{} <span class=\"hljs-comment\">//&#x5B9E;&#x4F8B;&#x5316;ClassFile&#x7C7B;</span></span><br><span class=\"line\">\tcf.read(cr) <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;class&#x6587;&#x4EF6;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x8BFB;&#x53D6;class&#x6587;&#x4EF6;&#x7684;&#x5177;&#x4F53;&#x65B9;&#x6CD5;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">read</span><span class=\"hljs-params\">(reader *ClassReader)</span></span> {</span><br><span class=\"line\">\tself.readAndCheckMagic(reader) <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;&#x9B54;&#x6570;</span></span><br><span class=\"line\">\tself.readAndCheckVersion(reader) <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;&#x4E3B;&#x6B21;&#x7248;&#x672C;&#x53F7;</span></span><br><span class=\"line\">\tself.constantPool = readConstantPool(reader) <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;&#x5E38;&#x91CF;&#x6C60;</span></span><br><span class=\"line\">\tself.accessFlags = reader.readUint16() <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;&#x5F53;&#x524D;&#x7C7B;&#xFF08;&#x6216;&#x8005;&#x63A5;&#x53E3;&#xFF09;&#x7684;&#x8BBF;&#x95EE;&#x4FEE;&#x9970;&#x7B26;</span></span><br><span class=\"line\">\tself.thisClass = reader.readUint16() <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;&#x5F53;&#x524D;&#x7C7B;&#x7D22;&#x5F15;</span></span><br><span class=\"line\">\tself.superClass = reader.readUint16() <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;&#x7236;&#x7C7B;&#x7D22;&#x5F15;</span></span><br><span class=\"line\">\tself.interfaces = reader.readUint16s() <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;&#x6240;&#x6709;&#x63A5;&#x53E3;&#x7D22;&#x5F15;</span></span><br><span class=\"line\">\tself.fields = readMembers(reader, self.constantPool) <span class=\"hljs-comment\">//&#x4ECE;&#x5E38;&#x91CF;&#x6C60;&#x4E2D;&#x8BFB;&#x53D6;&#x6240;&#x6709;&#x6210;&#x5458;</span></span><br><span class=\"line\">\tself.methods = readMembers(reader, self.constantPool) <span class=\"hljs-comment\">//&#x4ECE;&#x5E38;&#x91CF;&#x6C60;&#x4E2D;&#x8BFB;&#x53D6;&#x6240;&#x6709;&#x65B9;&#x6CD5;</span></span><br><span class=\"line\">\tself.attributes = readAttributes(reader, self.constantPool) <span class=\"hljs-comment\">//&#x4ECE;&#x5E38;&#x91CF;&#x6C60;&#x4E2D;&#x8BFB;&#x53D6;&#x6240;&#x6709;&#x5C5E;&#x6027;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">readAndCheckMagic</span><span class=\"hljs-params\">(reader *ClassReader)</span></span> {</span><br><span class=\"line\">\tmagic := reader.readUint32() <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;4Byte&#x9B54;&#x6570;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> magic != <span class=\"hljs-number\">0xCAFEBABE</span> { <span class=\"hljs-comment\">//&#x5224;&#x65AD;&#x9B54;&#x6570;&#x662F;&#x5426;&#x4E3A;0xCAFEBABE</span></span><br><span class=\"line\">\t\t<span class=\"hljs-built_in\">panic</span>(<span class=\"hljs-string\">&quot;java.lang.ClassFormatError: magic!&quot;</span>)</span><br><span class=\"line\">\t}</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">readAndCheckVersion</span><span class=\"hljs-params\">(reader *ClassReader)</span></span> {</span><br><span class=\"line\">\tself.minorVersion = reader.readUint16() <span class=\"hljs-comment\">//&#x9AD8;2Byte&#x4E3A;&#x6B21;&#x7248;&#x672C;&#x53F7;</span></span><br><span class=\"line\">\tself.majorVersion = reader.readUint16() <span class=\"hljs-comment\">//&#x4F4E;2Byte&#x4E3A;&#x4E3B;&#x7248;&#x672C;&#x53F7;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">switch</span> self.majorVersion { <span class=\"hljs-comment\">//&#x68C0;&#x67E5;&#x7248;&#x672C;&#x53F7;&#x662F;&#x5426;&#x4E3A;45~52</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">case</span> <span class=\"hljs-number\">45</span>:</span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">return</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">case</span> <span class=\"hljs-number\">46</span>, <span class=\"hljs-number\">47</span>, <span class=\"hljs-number\">48</span>, <span class=\"hljs-number\">49</span>, <span class=\"hljs-number\">50</span>, <span class=\"hljs-number\">51</span>, <span class=\"hljs-number\">52</span>:</span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">if</span> self.minorVersion == <span class=\"hljs-number\">0</span> {</span><br><span class=\"line\">\t\t\t<span class=\"hljs-keyword\">return</span></span><br><span class=\"line\">\t\t}</span><br><span class=\"line\">\t}</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"hljs-built_in\">panic</span>(<span class=\"hljs-string\">&quot;java.lang.UnsupportedClassVersionError!&quot;</span>)</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">MinorVersion</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">uint16</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.minorVersion</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">MajorVersion</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">uint16</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.majorVersion</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">ConstantPool</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">ConstantPool</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.constantPool</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">AccessFlags</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">uint16</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.accessFlags</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">Fields</span><span class=\"hljs-params\">()</span> []*<span class=\"hljs-title\">MemberInfo</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.fields</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">Methods</span><span class=\"hljs-params\">()</span> []*<span class=\"hljs-title\">MemberInfo</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.methods</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;&#xFF0C;&#x6839;&#x636E;thisClass&#x7D22;&#x5F15;&#x5728;&#x5E38;&#x91CF;&#x6C60;&#x4E2D;&#x67E5;&#x627E;&#x540D;&#x79F0;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">ClassName</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">string</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.constantPool.getClassName(self.thisClass)</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;&#xFF0C;&#x6839;&#x636E;superClass&#x7D22;&#x5F15;&#x5728;&#x5E38;&#x91CF;&#x6C60;&#x4E2D;&#x67E5;&#x627E;&#x540D;&#x79F0;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">SuperClassName</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">string</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> self.superClass &gt; <span class=\"hljs-number\">0</span> {</span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">return</span> self.constantPool.getClassName(self.superClass)</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-string\">&quot;&quot;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;&#xFF0C;&#x6839;&#x636E;interfaces&#x7D22;&#x5F15;&#x5728;&#x5E38;&#x91CF;&#x6C60;&#x4E2D;&#x67E5;&#x627E;&#x540D;&#x79F0;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *ClassFile)</span> <span class=\"hljs-title\">InterfaceNames</span><span class=\"hljs-params\">()</span> []<span class=\"hljs-title\">string</span></span> {</span><br><span class=\"line\">\tinterfaceNames := <span class=\"hljs-built_in\">make</span>([]<span class=\"hljs-keyword\">string</span>, <span class=\"hljs-built_in\">len</span>(self.interfaces))</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">for</span> i, cpIndex := <span class=\"hljs-keyword\">range</span> self.interfaces {</span><br><span class=\"line\">\t\tinterfaceNames[i] = self.constantPool.getClassName(cpIndex)</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> interfaceNames</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<ol>\n<li>&#x5B9A;&#x4E49;&#x5B57;&#x6BB5;&#x548C;&#x65B9;&#x6CD5;&#x7684;&#x7ED3;&#x6784;(field_info&#x3001;method_info)</li>\n</ol>\n<figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> MemberInfo <span class=\"hljs-keyword\">struct</span> { <span class=\"hljs-comment\">//field&#x548C;method&#x7684;&#x7ED3;&#x6784;&#x7C7B;&#x578B;&#xFF0C;&#x4F7F;&#x7528;&#x540C;&#x4E00;&#x4E2A;&#x7ED3;&#x6784;</span></span><br><span class=\"line\">\tcp              ConstantPool <span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x5E38;&#x91CF;&#x6C60;</span></span><br><span class=\"line\">\taccessFlags     <span class=\"hljs-keyword\">uint16</span> <span class=\"hljs-comment\">//&#x8BBF;&#x95EE;&#x6807;&#x5FD7;</span></span><br><span class=\"line\">\tnameIndex       <span class=\"hljs-keyword\">uint16</span> <span class=\"hljs-comment\">//&#x540D;&#x79F0;&#x7D22;&#x5F15;</span></span><br><span class=\"line\">\tdescriptorIndex <span class=\"hljs-keyword\">uint16</span> <span class=\"hljs-comment\">//&#x63CF;&#x8FF0;&#x7D22;&#x5F15;</span></span><br><span class=\"line\">\tattributes      []AttributeInfo <span class=\"hljs-comment\">//&#x5C5E;&#x6027;&#x5217;&#x8868; </span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// read field or method table</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">readMembers</span><span class=\"hljs-params\">(reader *ClassReader, cp ConstantPool)</span> []*<span class=\"hljs-title\">MemberInfo</span></span> {</span><br><span class=\"line\">\tmemberCount := reader.readUint16() <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;field&#x6216;method&#x6570;&#x91CF;</span></span><br><span class=\"line\">\tmembers := <span class=\"hljs-built_in\">make</span>([]*MemberInfo, memberCount) <span class=\"hljs-comment\">//&#x521B;&#x5EFA;&#x6570;&#x7EC4;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">for</span> i := <span class=\"hljs-keyword\">range</span> members {</span><br><span class=\"line\">\t\tmembers[i] = readMember(reader, cp)</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> members</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5177;&#x4F53;&#x8BFB;&#x53D6;field&#x548C;method&#x7684;&#x65B9;&#x6CD5;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">readMember</span><span class=\"hljs-params\">(reader *ClassReader, cp ConstantPool)</span> *<span class=\"hljs-title\">MemberInfo</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> &amp;MemberInfo{</span><br><span class=\"line\">\t\tcp:              cp,</span><br><span class=\"line\">\t\taccessFlags:     reader.readUint16(), <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;2Byte&#x7684;&#x8BBF;&#x95EE;&#x63A7;&#x5236;&#x7B26;</span></span><br><span class=\"line\">\t\tnameIndex:       reader.readUint16(), <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;2Byte&#x7684;&#x540D;&#x79F0;&#x7D22;&#x5F15;</span></span><br><span class=\"line\">\t\tdescriptorIndex: reader.readUint16(), <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;2Byte&#x7684;&#x63CF;&#x8FF0;&#x7D22;&#x5F15;</span></span><br><span class=\"line\">\t\tattributes:      readAttributes(reader, cp), <span class=\"hljs-comment\">//&#x8BFB;&#x53D6;&#x5C5E;&#x6027;&#x5217;&#x8868;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *MemberInfo)</span> <span class=\"hljs-title\">AccessFlags</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">uint16</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.accessFlags</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;&#xFF0C;&#x901A;&#x8FC7;&#x540D;&#x79F0;&#x7D22;&#x5F15;&#x8BBF;&#x95EE;&#x5E38;&#x91CF;&#x6C60;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *MemberInfo)</span> <span class=\"hljs-title\">Name</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">string</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.cp.getUtf8(self.nameIndex)</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5BF9;&#x5916;&#x66B4;&#x9732;get&#x65B9;&#x6CD5;&#xFF0C;&#x901A;&#x8FC7;&#x63CF;&#x8FF0;&#x7D22;&#x5F15;&#x8BBF;&#x95EE;&#x5E38;&#x91CF;&#x6C60;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *MemberInfo)</span> <span class=\"hljs-title\">Descriptor</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">string</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.cp.getUtf8(self.descriptorIndex)</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure></body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"JVM","path":"tags/JVM/"},{"name":"Java","path":"tags/Java/"},{"name":"Go","path":"tags/Go/"}],"excerpt":"<html><head></head><body><p>&#x7B2C;&#x4E09;&#x7BC7;&#x4E3B;&#x8981;&#x5B66;&#x4E60;JVM&#x4E2D;class&#x6587;&#x4EF6;&#x7684;&#x5177;&#x4F53;&#x7ED3;&#x6784;&#xFF0C;&#x548C;JVM&#x662F;&#x5982;&#x4F55;&#x89E3;&#x6790;&#x8FD9;&#x4E9B;&#x7ED3;&#x6784;&#x7684;&#x3002;<br>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;javac&#x5DE5;&#x5177;&#x5C06;&#x4E00;&#x4E2A;java&#x6587;&#x4EF6;compile&#x6210;&#x4E00;&#x4E2A;.class&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x901A;&#x8FC7;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x5199;&#x7684;jvm&#x5C06;&#x8BE5;&#x6587;&#x4EF6;&#x89E3;&#x6790;&#x5E76;&#x6253;&#x5370;&#x51FA;&#x6765;&#x3002;&#x901A;&#x8FC7;class&#x6587;&#x4EF6;&#x7684;&#x5B66;&#x4E60;&#x80FD;&#x8BA9;&#x6211;&#x4EEC;&#x66F4;&#x52A0;&#x6DF1;&#x523B;&#x7684;&#x7406;&#x89E3;java&#x662F;&#x600E;&#x6837;&#x5B9E;&#x73B0;&#x8DE8;&#x5E73;&#x53F0;&#xFF0C;&#x5E76;&#x4E14;&#x6211;&#x4EEC;&#x7F16;&#x5199;&#x7684;java&#x4EE3;&#x7801;&#x53C8;&#x662F;&#x5982;&#x4F55;&#x5728;JVM&#x4E2D;&#x4F53;&#x73B0;&#x7684;&#x3002;</p></body></html>","more":"<h3 id=\"JVM中class文件结构-ClassFile\"><a href=\"#JVM中class文件结构-ClassFile\" class=\"headerlink\" title=\"JVM中class文件结构(ClassFile)\"></a>JVM中class文件结构(ClassFile)</h3><table>\n<thead>\n<tr>\n<th>Length</th>\n<th>name</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>u4</td>\n<td>magic</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>minor_version</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>major_version</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>constant_pool_count</td>\n</tr>\n<tr>\n<td>cp_info</td>\n<td>constant_pool[constant_pool_count-1]</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>access_flags</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>this_class</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>super_class</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>interfaces_count</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>interfaces[interfaces_count]</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>fields_count</td>\n</tr>\n<tr>\n<td>field_info</td>\n<td>fields[fields_count]</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>methods_count</td>\n</tr>\n<tr>\n<td>method_info</td>\n<td>methods[methods_count]</td>\n</tr>\n</tbody></table>\n<h3 id=\"JVM中字段结构-field-info\"><a href=\"#JVM中字段结构-field-info\" class=\"headerlink\" title=\"JVM中字段结构(field_info)\"></a>JVM中字段结构(field_info)</h3><table>\n<thead>\n<tr>\n<th>Length</th>\n<th>name</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>u2</td>\n<td>access_flags</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>name_index</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>descriptor_index</td>\n</tr>\n<tr>\n<td>u2</td>\n<td>attributes_count</td>\n</tr>\n<tr>\n<td>attribute_info</td>\n<td>attributes[attributes_count]</td>\n</tr>\n</tbody></table>\n<h3 id=\"JVM中访问控制符结构-access-flags\"><a href=\"#JVM中访问控制符结构-access-flags\" class=\"headerlink\" title=\"JVM中访问控制符结构(access_flags)\"></a>JVM中访问控制符结构(access_flags)</h3><table>\n<thead>\n<tr>\n<th>标志名</th>\n<th>标志值</th>\n<th>标志含义</th>\n<th>针对的对象</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ACC_PUBLIC</td>\n<td>0x0001</td>\n<td>public类型</td>\n<td>所有类型</td>\n</tr>\n<tr>\n<td>ACC_FINAL</td>\n<td>0x0010</td>\n<td>final类型</td>\n<td>类</td>\n</tr>\n<tr>\n<td>ACC_SUPER</td>\n<td>0x0020</td>\n<td>使用新的invokespecial语义</td>\n<td>类和接口</td>\n</tr>\n<tr>\n<td>ACC_INTERFACE</td>\n<td>0x0200</td>\n<td>接口类型</td>\n<td>接口</td>\n</tr>\n<tr>\n<td>ACC_ABSTRACT</td>\n<td>0x0400</td>\n<td>抽象类型</td>\n<td>类和接口</td>\n</tr>\n<tr>\n<td>ACC_SYNTHETIC</td>\n<td>0x1000</td>\n<td>该类不由用户代码生成</td>\n<td>所有类型</td>\n</tr>\n<tr>\n<td>ACC_ANNOTATION</td>\n<td>0x2000</td>\n<td>注解类型</td>\n<td>注解</td>\n</tr>\n<tr>\n<td>ACC_ENUM</td>\n<td>0x4000</td>\n<td>枚举类型</td>\n<td>枚举</td>\n</tr>\n</tbody></table>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><ol>\n<li>定义Class文件的录取类(ClassReader)</li>\n</ol>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> ClassReader <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tdata []<span class=\"keyword\">byte</span> <span class=\"comment\">//class文件字节流</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 读取u1</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassReader)</span> <span class=\"title\">readUint8</span><span class=\"params\">()</span> <span class=\"title\">uint8</span></span> &#123;</span><br><span class=\"line\">\tval := self.data[<span class=\"number\">0</span>] <span class=\"comment\">//读取1Byte</span></span><br><span class=\"line\">\tself.data = self.data[<span class=\"number\">1</span>:]</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> val</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// u2</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassReader)</span> <span class=\"title\">readUint16</span><span class=\"params\">()</span> <span class=\"title\">uint16</span></span> &#123;</span><br><span class=\"line\">\tval := binary.BigEndian.Uint16(self.data) <span class=\"comment\">//读取2Byte并转为uint16</span></span><br><span class=\"line\">\tself.data = self.data[<span class=\"number\">2</span>:]</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> val</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// u4</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassReader)</span> <span class=\"title\">readUint32</span><span class=\"params\">()</span> <span class=\"title\">uint32</span></span> &#123;</span><br><span class=\"line\">\tval := binary.BigEndian.Uint32(self.data) <span class=\"comment\">//读取4Byte并转为uint32</span></span><br><span class=\"line\">\tself.data = self.data[<span class=\"number\">4</span>:]</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> val</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassReader)</span> <span class=\"title\">readUint64</span><span class=\"params\">()</span> <span class=\"title\">uint64</span></span> &#123;</span><br><span class=\"line\">\tval := binary.BigEndian.Uint64(self.data) <span class=\"comment\">//读取8Byte并转为uint64</span></span><br><span class=\"line\">\tself.data = self.data[<span class=\"number\">8</span>:]</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> val</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassReader)</span> <span class=\"title\">readUint16s</span><span class=\"params\">()</span> []<span class=\"title\">uint16</span></span> &#123;</span><br><span class=\"line\">\tn := self.readUint16() <span class=\"comment\">//读取2Byte，该值为后续数组的长度</span></span><br><span class=\"line\">\ts := <span class=\"built_in\">make</span>([]<span class=\"keyword\">uint16</span>, n) <span class=\"comment\">//生产长度为n的uint16类型数组</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"keyword\">range</span> s &#123;</span><br><span class=\"line\">\t\ts[i] = self.readUint16() <span class=\"comment\">//读取class文件，每读取2Byte便放入数组</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> s</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassReader)</span> <span class=\"title\">readBytes</span><span class=\"params\">(n <span class=\"keyword\">uint32</span>)</span> []<span class=\"title\">byte</span></span> &#123;</span><br><span class=\"line\">\tbytes := self.data[:n] <span class=\"comment\">//读取长度为n的字节</span></span><br><span class=\"line\">\tself.data = self.data[n:]</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> bytes</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li>定义Class文件的格式(ClassFile)</li>\n</ol>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> ClassFile <span class=\"keyword\">struct</span> &#123; <span class=\"comment\">//按照jvm规范，定义class文件结构</span></span><br><span class=\"line\">\t<span class=\"comment\">//magic      uint32</span></span><br><span class=\"line\">\tminorVersion <span class=\"keyword\">uint16</span></span><br><span class=\"line\">\tmajorVersion <span class=\"keyword\">uint16</span></span><br><span class=\"line\">\tconstantPool ConstantPool</span><br><span class=\"line\">\taccessFlags  <span class=\"keyword\">uint16</span></span><br><span class=\"line\">\tthisClass    <span class=\"keyword\">uint16</span></span><br><span class=\"line\">\tsuperClass   <span class=\"keyword\">uint16</span></span><br><span class=\"line\">\tinterfaces   []<span class=\"keyword\">uint16</span></span><br><span class=\"line\">\tfields       []*MemberInfo</span><br><span class=\"line\">\tmethods      []*MemberInfo</span><br><span class=\"line\">\tattributes   []AttributeInfo</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//文件解析入口方法，入参class文件流，返回class文件对象</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">Parse</span><span class=\"params\">(classData []<span class=\"keyword\">byte</span>)</span> <span class=\"params\">(cf *ClassFile, err error)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">defer</span> <span class=\"function\"><span class=\"keyword\">func</span><span class=\"params\">()</span></span> &#123; <span class=\"comment\">//捕获异常</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> r := <span class=\"built_in\">recover</span>(); r != <span class=\"literal\">nil</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">var</span> ok <span class=\"keyword\">bool</span></span><br><span class=\"line\">\t\t\terr, ok = r.(error)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> !ok &#123;</span><br><span class=\"line\">\t\t\t\terr = fmt.Errorf(<span class=\"string\">&quot;%v&quot;</span>, r)</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;()</span><br><span class=\"line\"></span><br><span class=\"line\">\tcr := &amp;ClassReader&#123;classData&#125; <span class=\"comment\">//实例化classReader类</span></span><br><span class=\"line\">\tcf = &amp;ClassFile&#123;&#125; <span class=\"comment\">//实例化ClassFile类</span></span><br><span class=\"line\">\tcf.read(cr) <span class=\"comment\">//读取class文件</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//读取class文件的具体方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">read</span><span class=\"params\">(reader *ClassReader)</span></span> &#123;</span><br><span class=\"line\">\tself.readAndCheckMagic(reader) <span class=\"comment\">//读取魔数</span></span><br><span class=\"line\">\tself.readAndCheckVersion(reader) <span class=\"comment\">//读取主次版本号</span></span><br><span class=\"line\">\tself.constantPool = readConstantPool(reader) <span class=\"comment\">//读取常量池</span></span><br><span class=\"line\">\tself.accessFlags = reader.readUint16() <span class=\"comment\">//读取当前类（或者接口）的访问修饰符</span></span><br><span class=\"line\">\tself.thisClass = reader.readUint16() <span class=\"comment\">//读取当前类索引</span></span><br><span class=\"line\">\tself.superClass = reader.readUint16() <span class=\"comment\">//读取父类索引</span></span><br><span class=\"line\">\tself.interfaces = reader.readUint16s() <span class=\"comment\">//读取所有接口索引</span></span><br><span class=\"line\">\tself.fields = readMembers(reader, self.constantPool) <span class=\"comment\">//从常量池中读取所有成员</span></span><br><span class=\"line\">\tself.methods = readMembers(reader, self.constantPool) <span class=\"comment\">//从常量池中读取所有方法</span></span><br><span class=\"line\">\tself.attributes = readAttributes(reader, self.constantPool) <span class=\"comment\">//从常量池中读取所有属性</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">readAndCheckMagic</span><span class=\"params\">(reader *ClassReader)</span></span> &#123;</span><br><span class=\"line\">\tmagic := reader.readUint32() <span class=\"comment\">//读取4Byte魔数</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> magic != <span class=\"number\">0xCAFEBABE</span> &#123; <span class=\"comment\">//判断魔数是否为0xCAFEBABE</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">panic</span>(<span class=\"string\">&quot;java.lang.ClassFormatError: magic!&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">readAndCheckVersion</span><span class=\"params\">(reader *ClassReader)</span></span> &#123;</span><br><span class=\"line\">\tself.minorVersion = reader.readUint16() <span class=\"comment\">//高2Byte为次版本号</span></span><br><span class=\"line\">\tself.majorVersion = reader.readUint16() <span class=\"comment\">//低2Byte为主版本号</span></span><br><span class=\"line\">\t<span class=\"keyword\">switch</span> self.majorVersion &#123; <span class=\"comment\">//检查版本号是否为45~52</span></span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"number\">45</span>:</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t<span class=\"keyword\">case</span> <span class=\"number\">46</span>, <span class=\"number\">47</span>, <span class=\"number\">48</span>, <span class=\"number\">49</span>, <span class=\"number\">50</span>, <span class=\"number\">51</span>, <span class=\"number\">52</span>:</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> self.minorVersion == <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">panic</span>(<span class=\"string\">&quot;java.lang.UnsupportedClassVersionError!&quot;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">MinorVersion</span><span class=\"params\">()</span> <span class=\"title\">uint16</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.minorVersion</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">MajorVersion</span><span class=\"params\">()</span> <span class=\"title\">uint16</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.majorVersion</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">ConstantPool</span><span class=\"params\">()</span> <span class=\"title\">ConstantPool</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.constantPool</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">AccessFlags</span><span class=\"params\">()</span> <span class=\"title\">uint16</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.accessFlags</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">Fields</span><span class=\"params\">()</span> []*<span class=\"title\">MemberInfo</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.fields</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">Methods</span><span class=\"params\">()</span> []*<span class=\"title\">MemberInfo</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.methods</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法，根据thisClass索引在常量池中查找名称</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">ClassName</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.constantPool.getClassName(self.thisClass)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法，根据superClass索引在常量池中查找名称</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">SuperClassName</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> self.superClass &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> self.constantPool.getClassName(self.superClass)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法，根据interfaces索引在常量池中查找名称</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *ClassFile)</span> <span class=\"title\">InterfaceNames</span><span class=\"params\">()</span> []<span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\tinterfaceNames := <span class=\"built_in\">make</span>([]<span class=\"keyword\">string</span>, <span class=\"built_in\">len</span>(self.interfaces))</span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i, cpIndex := <span class=\"keyword\">range</span> self.interfaces &#123;</span><br><span class=\"line\">\t\tinterfaceNames[i] = self.constantPool.getClassName(cpIndex)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> interfaceNames</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<ol>\n<li>定义字段和方法的结构(field_info、method_info)</li>\n</ol>\n<figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> MemberInfo <span class=\"keyword\">struct</span> &#123; <span class=\"comment\">//field和method的结构类型，使用同一个结构</span></span><br><span class=\"line\">\tcp              ConstantPool <span class=\"comment\">//当前常量池</span></span><br><span class=\"line\">\taccessFlags     <span class=\"keyword\">uint16</span> <span class=\"comment\">//访问标志</span></span><br><span class=\"line\">\tnameIndex       <span class=\"keyword\">uint16</span> <span class=\"comment\">//名称索引</span></span><br><span class=\"line\">\tdescriptorIndex <span class=\"keyword\">uint16</span> <span class=\"comment\">//描述索引</span></span><br><span class=\"line\">\tattributes      []AttributeInfo <span class=\"comment\">//属性列表 </span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// read field or method table</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readMembers</span><span class=\"params\">(reader *ClassReader, cp ConstantPool)</span> []*<span class=\"title\">MemberInfo</span></span> &#123;</span><br><span class=\"line\">\tmemberCount := reader.readUint16() <span class=\"comment\">//读取field或method数量</span></span><br><span class=\"line\">\tmembers := <span class=\"built_in\">make</span>([]*MemberInfo, memberCount) <span class=\"comment\">//创建数组</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i := <span class=\"keyword\">range</span> members &#123;</span><br><span class=\"line\">\t\tmembers[i] = readMember(reader, cp)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> members</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//具体读取field和method的方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readMember</span><span class=\"params\">(reader *ClassReader, cp ConstantPool)</span> *<span class=\"title\">MemberInfo</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;MemberInfo&#123;</span><br><span class=\"line\">\t\tcp:              cp,</span><br><span class=\"line\">\t\taccessFlags:     reader.readUint16(), <span class=\"comment\">//读取2Byte的访问控制符</span></span><br><span class=\"line\">\t\tnameIndex:       reader.readUint16(), <span class=\"comment\">//读取2Byte的名称索引</span></span><br><span class=\"line\">\t\tdescriptorIndex: reader.readUint16(), <span class=\"comment\">//读取2Byte的描述索引</span></span><br><span class=\"line\">\t\tattributes:      readAttributes(reader, cp), <span class=\"comment\">//读取属性列表</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *MemberInfo)</span> <span class=\"title\">AccessFlags</span><span class=\"params\">()</span> <span class=\"title\">uint16</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.accessFlags</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法，通过名称索引访问常量池</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *MemberInfo)</span> <span class=\"title\">Name</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.cp.getUtf8(self.nameIndex)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//对外暴露get方法，通过描述索引访问常量池</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *MemberInfo)</span> <span class=\"title\">Descriptor</span><span class=\"params\">()</span> <span class=\"title\">string</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.cp.getUtf8(self.descriptorIndex)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>"},{"title":"自己动手写Java虚拟机 笔记4","date":"2019-09-26T13:49:11.000Z","_content":"\n### 运行时数据区\nJVM将需要用到的数据存放入内存中，这个内存区就叫运行时数据区\n可分为两种：\n1. 一类是多线程共享的，该数据区需要在Java虚拟机启动时创建好，在Java虚拟机退出时销毁。\n2. 一类则是线程私有的，该数据区则在创建线程时才创建，线程退出时销毁。\n\n<!-- more -->\n\n![01](自己动手写Java虚拟机-笔记4/运行时数据区.png)\n\n\n### 实现\n#### 定义对象结构\n\n{% codeblock lang:golang %}\ntype Object struct {\n\t// todo\n}\n\n{% endcodeblock %}\n\n#### 运行时数据区-线程\n\n{% codeblock lang:golang %}\ntype Thread struct {\n\tpc    int // the address of the instruction currently being executed\n\tstack *Stack //Java虚拟机栈指针\n\t// todo\n}\n\n//创建Thread实例\n//java命令提供了-Xss选项来设置Java虚拟机栈大小\nfunc NewThread() *Thread {\n\treturn &Thread{\n\t\tstack: newStack(1024), //最多容纳1024帧\n\t}\n}\n\nfunc (self *Thread) PC() int {\n\treturn self.pc\n}\nfunc (self *Thread) SetPC(pc int) {\n\tself.pc = pc\n}\n\n//当前帧进栈\nfunc (self *Thread) PushFrame(frame *Frame) {\n\tself.stack.push(frame)\n}\n//当前帧出栈\nfunc (self *Thread) PopFrame() *Frame {\n\treturn self.stack.pop()\n}\n//获取当前帧\nfunc (self *Thread) CurrentFrame() *Frame {\n\treturn self.stack.top()\n}\n\n\n\n\n{% endcodeblock %}\n\n\n#### 运行时数据区-Java虚拟机栈\n\n{% codeblock lang:golang %}\ntype Stack struct {\n\tmaxSize uint //最多可以容纳多少帧\n\tsize    uint //栈的当前大小\n\t_top    *Frame //保存栈顶指针\n}\n\n//实例一个栈\nfunc newStack(maxSize uint) *Stack {\n\treturn &Stack{\n\t\tmaxSize: maxSize,\n\t}\n}\n\n//当前帧进栈\nfunc (self *Stack) push(frame *Frame) {\n\tif self.size >= self.maxSize { //判断当前栈大小是否超过最大容量\n\t\tpanic(\"java.lang.StackOverflowError\") \n\t}\n\n\tif self._top != nil {  //当前栈顶不为空时\n\t\tframe.lower = self._top //将插入帧尾指向栈顶指针\n\t}\n\n\tself._top = frame //当前栈顶指向当前帧\n\tself.size++ //当前栈大小加1\n}\n\n//当前帧出栈\nfunc (self *Stack) pop() *Frame {\n\tif self._top == nil { //当前栈顶为空时报错\n\t\tpanic(\"jvm stack is empty!\")\n\t}\n\n\ttop := self._top //取出当前栈顶帧\n\tself._top = top.lower //将当前栈顶指向top的下一帧\n\ttop.lower = nil //断开top的尾指针\n\tself.size-- //当前栈大小减1\n\n\treturn top //返回top\n}\n\n//获取当前栈顶帧\nfunc (self *Stack) top() *Frame {\n\tif self._top == nil { ////当前栈顶为空时报错\n\t\tpanic(\"jvm stack is empty!\")\n\t}\n\n\treturn self._top //返回当前栈顶帧\n}\n\n{% endcodeblock %}\n\n#### 运行时数据区-帧\n\n{% codeblock lang:golang %}\ntype Frame struct {\n\tlower        *Frame //指向下一帧\n\tlocalVars    LocalVars //保存局部变量表指针\n\toperandStack *OperandStack //保存操作数栈指针\n\t// todo\n}\n\n//实例化帧\nfunc NewFrame(maxLocals, maxStack uint) *Frame {\n\treturn &Frame{\n\t\tlocalVars:    newLocalVars(maxLocals), //实例化局部变量对象\n\t\toperandStack: newOperandStack(maxStack), //实例化操作数栈对象\n\t}\n}\n\n// getters\nfunc (self *Frame) LocalVars() LocalVars {\n\treturn self.localVars\n}\nfunc (self *Frame) OperandStack() *OperandStack {\n\treturn self.operandStack\n}\n\n{% endcodeblock %}\n\n#### 运行时数据区-局部变量表\n\n{% codeblock lang:golang %}\ntype LocalVars []Slot\n\n//创建局部变量实例\nfunc newLocalVars(maxLocals uint) LocalVars {\n\tif maxLocals > 0 {\n\t\treturn make([]Slot, maxLocals) //申明大小为maxLocals的Slot数组\n\t}\n\treturn nil\n}\n\n//设置int类型\nfunc (self LocalVars) SetInt(index uint, val int32) {\n\tself[index].num = val\n}\n//取int类型\nfunc (self LocalVars) GetInt(index uint) int32 {\n\treturn self[index].num\n}\n//设置float32类型\nfunc (self LocalVars) SetFloat(index uint, val float32) {\n\tbits := math.Float32bits(val)//转为uint32\n\tself[index].num = int32(bits) //转为int32\n}\n//取float32类型\nfunc (self LocalVars) GetFloat(index uint) float32 {\n\tbits := uint32(self[index].num)//转为unit32\n\treturn math.Float32frombits(bits)//转为float\n}\n\n//设置long类型\nfunc (self LocalVars) SetLong(index uint, val int64) {\n\tself[index].num = int32(val)//取低位32位存储在index\n\tself[index+1].num = int32(val >> 32) //右移32位取高位32位存储在index+1\n}\n//取long类型\nfunc (self LocalVars) GetLong(index uint) int64 {\n\tlow := uint32(self[index].num) //取index低32位\n\thigh := uint32(self[index+1].num) //取index+1高32位\n\treturn int64(high)<<32 | int64(low) //左移高位32位，拼接高低位返回\n}\n\n//设置float64\nfunc (self LocalVars) SetDouble(index uint, val float64) {\n\tbits := math.Float64bits(val) //转为uint64\n\tself.SetLong(index, int64(bits)) //用long型设置方法设置int64\n}\n//取float64\nfunc (self LocalVars) GetDouble(index uint) float64 {\n\tbits := uint64(self.GetLong(index)) //按long型取值方法取出uint64\n\treturn math.Float64frombits(bits) //转为float64\n}\n//设置引用\nfunc (self LocalVars) SetRef(index uint, ref *Object) {\n\tself[index].ref = ref\n}\n//取引用\nfunc (self LocalVars) GetRef(index uint) *Object {\n\treturn self[index].ref\n}\n\n{% endcodeblock %}\n\n#### 运行时数据区-操作数栈\n\n{% codeblock lang:golang %}\ntype OperandStack struct {\n\tsize  uint //记录栈顶位置\n\tslots []Slot\n}\n//实例化操作数栈\nfunc newOperandStack(maxStack uint) *OperandStack {\n\tif maxStack > 0 {\n\t\treturn &OperandStack{\n\t\t\tslots: make([]Slot, maxStack),//申明maxStack大小的Slot数组\n\t\t}\n\t}\n\treturn nil\n}\n\nfunc (self *OperandStack) PushInt(val int32) {\n\tself.slots[self.size].num = val\n\tself.size++\n}\nfunc (self *OperandStack) PopInt() int32 {\n\tself.size--\n\treturn self.slots[self.size].num\n}\n\nfunc (self *OperandStack) PushFloat(val float32) {\n\tbits := math.Float32bits(val)\n\tself.slots[self.size].num = int32(bits)\n\tself.size++\n}\nfunc (self *OperandStack) PopFloat() float32 {\n\tself.size--\n\tbits := uint32(self.slots[self.size].num)\n\treturn math.Float32frombits(bits)\n}\n\n// long consumes two slots\nfunc (self *OperandStack) PushLong(val int64) {\n\tself.slots[self.size].num = int32(val)\n\tself.slots[self.size+1].num = int32(val >> 32)\n\tself.size += 2\n}\nfunc (self *OperandStack) PopLong() int64 {\n\tself.size -= 2\n\tlow := uint32(self.slots[self.size].num)\n\thigh := uint32(self.slots[self.size+1].num)\n\treturn int64(high)<<32 | int64(low)\n}\n\n// double consumes two slots\nfunc (self *OperandStack) PushDouble(val float64) {\n\tbits := math.Float64bits(val)\n\tself.PushLong(int64(bits))\n}\nfunc (self *OperandStack) PopDouble() float64 {\n\tbits := uint64(self.PopLong())\n\treturn math.Float64frombits(bits)\n}\n\nfunc (self *OperandStack) PushRef(ref *Object) {\n\tself.slots[self.size].ref = ref\n\tself.size++\n}\nfunc (self *OperandStack) PopRef() *Object {\n\tself.size--\n\tref := self.slots[self.size].ref\n\tself.slots[self.size].ref = nil\n\treturn ref\n}\n{% endcodeblock %}\n\n#### 运行时数据区-操作数栈\n\n{% codeblock lang:golang %}\n\n{% endcodeblock %}","source":"_posts/自己动手写Java虚拟机-笔记4.md","raw":"---\ntitle: 自己动手写Java虚拟机 笔记4\ndate: 2019-09-26 21:49:11\ntags: \n    - JVM\n    - Java\n    - Go\ncategories :\n    - Technology\n---\n\n### 运行时数据区\nJVM将需要用到的数据存放入内存中，这个内存区就叫运行时数据区\n可分为两种：\n1. 一类是多线程共享的，该数据区需要在Java虚拟机启动时创建好，在Java虚拟机退出时销毁。\n2. 一类则是线程私有的，该数据区则在创建线程时才创建，线程退出时销毁。\n\n<!-- more -->\n\n![01](自己动手写Java虚拟机-笔记4/运行时数据区.png)\n\n\n### 实现\n#### 定义对象结构\n\n{% codeblock lang:golang %}\ntype Object struct {\n\t// todo\n}\n\n{% endcodeblock %}\n\n#### 运行时数据区-线程\n\n{% codeblock lang:golang %}\ntype Thread struct {\n\tpc    int // the address of the instruction currently being executed\n\tstack *Stack //Java虚拟机栈指针\n\t// todo\n}\n\n//创建Thread实例\n//java命令提供了-Xss选项来设置Java虚拟机栈大小\nfunc NewThread() *Thread {\n\treturn &Thread{\n\t\tstack: newStack(1024), //最多容纳1024帧\n\t}\n}\n\nfunc (self *Thread) PC() int {\n\treturn self.pc\n}\nfunc (self *Thread) SetPC(pc int) {\n\tself.pc = pc\n}\n\n//当前帧进栈\nfunc (self *Thread) PushFrame(frame *Frame) {\n\tself.stack.push(frame)\n}\n//当前帧出栈\nfunc (self *Thread) PopFrame() *Frame {\n\treturn self.stack.pop()\n}\n//获取当前帧\nfunc (self *Thread) CurrentFrame() *Frame {\n\treturn self.stack.top()\n}\n\n\n\n\n{% endcodeblock %}\n\n\n#### 运行时数据区-Java虚拟机栈\n\n{% codeblock lang:golang %}\ntype Stack struct {\n\tmaxSize uint //最多可以容纳多少帧\n\tsize    uint //栈的当前大小\n\t_top    *Frame //保存栈顶指针\n}\n\n//实例一个栈\nfunc newStack(maxSize uint) *Stack {\n\treturn &Stack{\n\t\tmaxSize: maxSize,\n\t}\n}\n\n//当前帧进栈\nfunc (self *Stack) push(frame *Frame) {\n\tif self.size >= self.maxSize { //判断当前栈大小是否超过最大容量\n\t\tpanic(\"java.lang.StackOverflowError\") \n\t}\n\n\tif self._top != nil {  //当前栈顶不为空时\n\t\tframe.lower = self._top //将插入帧尾指向栈顶指针\n\t}\n\n\tself._top = frame //当前栈顶指向当前帧\n\tself.size++ //当前栈大小加1\n}\n\n//当前帧出栈\nfunc (self *Stack) pop() *Frame {\n\tif self._top == nil { //当前栈顶为空时报错\n\t\tpanic(\"jvm stack is empty!\")\n\t}\n\n\ttop := self._top //取出当前栈顶帧\n\tself._top = top.lower //将当前栈顶指向top的下一帧\n\ttop.lower = nil //断开top的尾指针\n\tself.size-- //当前栈大小减1\n\n\treturn top //返回top\n}\n\n//获取当前栈顶帧\nfunc (self *Stack) top() *Frame {\n\tif self._top == nil { ////当前栈顶为空时报错\n\t\tpanic(\"jvm stack is empty!\")\n\t}\n\n\treturn self._top //返回当前栈顶帧\n}\n\n{% endcodeblock %}\n\n#### 运行时数据区-帧\n\n{% codeblock lang:golang %}\ntype Frame struct {\n\tlower        *Frame //指向下一帧\n\tlocalVars    LocalVars //保存局部变量表指针\n\toperandStack *OperandStack //保存操作数栈指针\n\t// todo\n}\n\n//实例化帧\nfunc NewFrame(maxLocals, maxStack uint) *Frame {\n\treturn &Frame{\n\t\tlocalVars:    newLocalVars(maxLocals), //实例化局部变量对象\n\t\toperandStack: newOperandStack(maxStack), //实例化操作数栈对象\n\t}\n}\n\n// getters\nfunc (self *Frame) LocalVars() LocalVars {\n\treturn self.localVars\n}\nfunc (self *Frame) OperandStack() *OperandStack {\n\treturn self.operandStack\n}\n\n{% endcodeblock %}\n\n#### 运行时数据区-局部变量表\n\n{% codeblock lang:golang %}\ntype LocalVars []Slot\n\n//创建局部变量实例\nfunc newLocalVars(maxLocals uint) LocalVars {\n\tif maxLocals > 0 {\n\t\treturn make([]Slot, maxLocals) //申明大小为maxLocals的Slot数组\n\t}\n\treturn nil\n}\n\n//设置int类型\nfunc (self LocalVars) SetInt(index uint, val int32) {\n\tself[index].num = val\n}\n//取int类型\nfunc (self LocalVars) GetInt(index uint) int32 {\n\treturn self[index].num\n}\n//设置float32类型\nfunc (self LocalVars) SetFloat(index uint, val float32) {\n\tbits := math.Float32bits(val)//转为uint32\n\tself[index].num = int32(bits) //转为int32\n}\n//取float32类型\nfunc (self LocalVars) GetFloat(index uint) float32 {\n\tbits := uint32(self[index].num)//转为unit32\n\treturn math.Float32frombits(bits)//转为float\n}\n\n//设置long类型\nfunc (self LocalVars) SetLong(index uint, val int64) {\n\tself[index].num = int32(val)//取低位32位存储在index\n\tself[index+1].num = int32(val >> 32) //右移32位取高位32位存储在index+1\n}\n//取long类型\nfunc (self LocalVars) GetLong(index uint) int64 {\n\tlow := uint32(self[index].num) //取index低32位\n\thigh := uint32(self[index+1].num) //取index+1高32位\n\treturn int64(high)<<32 | int64(low) //左移高位32位，拼接高低位返回\n}\n\n//设置float64\nfunc (self LocalVars) SetDouble(index uint, val float64) {\n\tbits := math.Float64bits(val) //转为uint64\n\tself.SetLong(index, int64(bits)) //用long型设置方法设置int64\n}\n//取float64\nfunc (self LocalVars) GetDouble(index uint) float64 {\n\tbits := uint64(self.GetLong(index)) //按long型取值方法取出uint64\n\treturn math.Float64frombits(bits) //转为float64\n}\n//设置引用\nfunc (self LocalVars) SetRef(index uint, ref *Object) {\n\tself[index].ref = ref\n}\n//取引用\nfunc (self LocalVars) GetRef(index uint) *Object {\n\treturn self[index].ref\n}\n\n{% endcodeblock %}\n\n#### 运行时数据区-操作数栈\n\n{% codeblock lang:golang %}\ntype OperandStack struct {\n\tsize  uint //记录栈顶位置\n\tslots []Slot\n}\n//实例化操作数栈\nfunc newOperandStack(maxStack uint) *OperandStack {\n\tif maxStack > 0 {\n\t\treturn &OperandStack{\n\t\t\tslots: make([]Slot, maxStack),//申明maxStack大小的Slot数组\n\t\t}\n\t}\n\treturn nil\n}\n\nfunc (self *OperandStack) PushInt(val int32) {\n\tself.slots[self.size].num = val\n\tself.size++\n}\nfunc (self *OperandStack) PopInt() int32 {\n\tself.size--\n\treturn self.slots[self.size].num\n}\n\nfunc (self *OperandStack) PushFloat(val float32) {\n\tbits := math.Float32bits(val)\n\tself.slots[self.size].num = int32(bits)\n\tself.size++\n}\nfunc (self *OperandStack) PopFloat() float32 {\n\tself.size--\n\tbits := uint32(self.slots[self.size].num)\n\treturn math.Float32frombits(bits)\n}\n\n// long consumes two slots\nfunc (self *OperandStack) PushLong(val int64) {\n\tself.slots[self.size].num = int32(val)\n\tself.slots[self.size+1].num = int32(val >> 32)\n\tself.size += 2\n}\nfunc (self *OperandStack) PopLong() int64 {\n\tself.size -= 2\n\tlow := uint32(self.slots[self.size].num)\n\thigh := uint32(self.slots[self.size+1].num)\n\treturn int64(high)<<32 | int64(low)\n}\n\n// double consumes two slots\nfunc (self *OperandStack) PushDouble(val float64) {\n\tbits := math.Float64bits(val)\n\tself.PushLong(int64(bits))\n}\nfunc (self *OperandStack) PopDouble() float64 {\n\tbits := uint64(self.PopLong())\n\treturn math.Float64frombits(bits)\n}\n\nfunc (self *OperandStack) PushRef(ref *Object) {\n\tself.slots[self.size].ref = ref\n\tself.size++\n}\nfunc (self *OperandStack) PopRef() *Object {\n\tself.size--\n\tref := self.slots[self.size].ref\n\tself.slots[self.size].ref = nil\n\treturn ref\n}\n{% endcodeblock %}\n\n#### 运行时数据区-操作数栈\n\n{% codeblock lang:golang %}\n\n{% endcodeblock %}","slug":"自己动手写Java虚拟机-笔记4","published":1,"updated":"2020-12-14T10:36:14.566Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htx001yv252bj0094ri","content":"<html><head></head><body><h3 id=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;\"><a href=\"#&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;\" class=\"headerlink\" title=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;\"></a>&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;</h3><p>JVM&#x5C06;&#x9700;&#x8981;&#x7528;&#x5230;&#x7684;&#x6570;&#x636E;&#x5B58;&#x653E;&#x5165;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x8FD9;&#x4E2A;&#x5185;&#x5B58;&#x533A;&#x5C31;&#x53EB;&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;<br>&#x53EF;&#x5206;&#x4E3A;&#x4E24;&#x79CD;&#xFF1A;</p>\n<ol>\n<li>&#x4E00;&#x7C7B;&#x662F;&#x591A;&#x7EBF;&#x7A0B;&#x5171;&#x4EAB;&#x7684;&#xFF0C;&#x8BE5;&#x6570;&#x636E;&#x533A;&#x9700;&#x8981;&#x5728;Java&#x865A;&#x62DF;&#x673A;&#x542F;&#x52A8;&#x65F6;&#x521B;&#x5EFA;&#x597D;&#xFF0C;&#x5728;Java&#x865A;&#x62DF;&#x673A;&#x9000;&#x51FA;&#x65F6;&#x9500;&#x6BC1;&#x3002;</li>\n<li>&#x4E00;&#x7C7B;&#x5219;&#x662F;&#x7EBF;&#x7A0B;&#x79C1;&#x6709;&#x7684;&#xFF0C;&#x8BE5;&#x6570;&#x636E;&#x533A;&#x5219;&#x5728;&#x521B;&#x5EFA;&#x7EBF;&#x7A0B;&#x65F6;&#x624D;&#x521B;&#x5EFA;&#xFF0C;&#x7EBF;&#x7A0B;&#x9000;&#x51FA;&#x65F6;&#x9500;&#x6BC1;&#x3002;</li>\n</ol>\n<a id=\"more\"></a>\n\n<p><img src=\"/2019/09/26/%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%E5%86%99Java%E8%99%9A%E6%8B%9F%E6%9C%BA-%E7%AC%94%E8%AE%B04/%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.png\" alt=\"01\"></p>\n<h3 id=\"&#x5B9E;&#x73B0;\"><a href=\"#&#x5B9E;&#x73B0;\" class=\"headerlink\" title=\"&#x5B9E;&#x73B0;\"></a>&#x5B9E;&#x73B0;</h3><h4 id=\"&#x5B9A;&#x4E49;&#x5BF9;&#x8C61;&#x7ED3;&#x6784;\"><a href=\"#&#x5B9A;&#x4E49;&#x5BF9;&#x8C61;&#x7ED3;&#x6784;\" class=\"headerlink\" title=\"&#x5B9A;&#x4E49;&#x5BF9;&#x8C61;&#x7ED3;&#x6784;\"></a>&#x5B9A;&#x4E49;&#x5BF9;&#x8C61;&#x7ED3;&#x6784;</h4><figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> Object <span class=\"hljs-keyword\">struct</span> {</span><br><span class=\"line\">\t<span class=\"hljs-comment\">// todo</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<h4 id=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x7EBF;&#x7A0B;\"><a href=\"#&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x7EBF;&#x7A0B;\" class=\"headerlink\" title=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x7EBF;&#x7A0B;\"></a>&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x7EBF;&#x7A0B;</h4><figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> Thread <span class=\"hljs-keyword\">struct</span> {</span><br><span class=\"line\">\tpc    <span class=\"hljs-keyword\">int</span> <span class=\"hljs-comment\">// the address of the instruction currently being executed</span></span><br><span class=\"line\">\tstack *Stack <span class=\"hljs-comment\">//Java&#x865A;&#x62DF;&#x673A;&#x6808;&#x6307;&#x9488;</span></span><br><span class=\"line\">\t<span class=\"hljs-comment\">// todo</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x521B;&#x5EFA;Thread&#x5B9E;&#x4F8B;</span></span><br><span class=\"line\"><span class=\"hljs-comment\">//java&#x547D;&#x4EE4;&#x63D0;&#x4F9B;&#x4E86;-Xss&#x9009;&#x9879;&#x6765;&#x8BBE;&#x7F6E;Java&#x865A;&#x62DF;&#x673A;&#x6808;&#x5927;&#x5C0F;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">NewThread</span><span class=\"hljs-params\">()</span> *<span class=\"hljs-title\">Thread</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> &amp;Thread{</span><br><span class=\"line\">\t\tstack: newStack(<span class=\"hljs-number\">1024</span>), <span class=\"hljs-comment\">//&#x6700;&#x591A;&#x5BB9;&#x7EB3;1024&#x5E27;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Thread)</span> <span class=\"hljs-title\">PC</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">int</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.pc</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Thread)</span> <span class=\"hljs-title\">SetPC</span><span class=\"hljs-params\">(pc <span class=\"hljs-keyword\">int</span>)</span></span> {</span><br><span class=\"line\">\tself.pc = pc</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x5E27;&#x8FDB;&#x6808;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Thread)</span> <span class=\"hljs-title\">PushFrame</span><span class=\"hljs-params\">(frame *Frame)</span></span> {</span><br><span class=\"line\">\tself.stack.push(frame)</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x5E27;&#x51FA;&#x6808;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Thread)</span> <span class=\"hljs-title\">PopFrame</span><span class=\"hljs-params\">()</span> *<span class=\"hljs-title\">Frame</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.stack.pop()</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x5E27;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Thread)</span> <span class=\"hljs-title\">CurrentFrame</span><span class=\"hljs-params\">()</span> *<span class=\"hljs-title\">Frame</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.stack.top()</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n\n<h4 id=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-Java&#x865A;&#x62DF;&#x673A;&#x6808;\"><a href=\"#&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-Java&#x865A;&#x62DF;&#x673A;&#x6808;\" class=\"headerlink\" title=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-Java&#x865A;&#x62DF;&#x673A;&#x6808;\"></a>&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-Java&#x865A;&#x62DF;&#x673A;&#x6808;</h4><figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> Stack <span class=\"hljs-keyword\">struct</span> {</span><br><span class=\"line\">\tmaxSize <span class=\"hljs-keyword\">uint</span> <span class=\"hljs-comment\">//&#x6700;&#x591A;&#x53EF;&#x4EE5;&#x5BB9;&#x7EB3;&#x591A;&#x5C11;&#x5E27;</span></span><br><span class=\"line\">\tsize    <span class=\"hljs-keyword\">uint</span> <span class=\"hljs-comment\">//&#x6808;&#x7684;&#x5F53;&#x524D;&#x5927;&#x5C0F;</span></span><br><span class=\"line\">\t_top    *Frame <span class=\"hljs-comment\">//&#x4FDD;&#x5B58;&#x6808;&#x9876;&#x6307;&#x9488;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5B9E;&#x4F8B;&#x4E00;&#x4E2A;&#x6808;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">newStack</span><span class=\"hljs-params\">(maxSize <span class=\"hljs-keyword\">uint</span>)</span> *<span class=\"hljs-title\">Stack</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> &amp;Stack{</span><br><span class=\"line\">\t\tmaxSize: maxSize,</span><br><span class=\"line\">\t}</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x5E27;&#x8FDB;&#x6808;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Stack)</span> <span class=\"hljs-title\">push</span><span class=\"hljs-params\">(frame *Frame)</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> self.size &gt;= self.maxSize { <span class=\"hljs-comment\">//&#x5224;&#x65AD;&#x5F53;&#x524D;&#x6808;&#x5927;&#x5C0F;&#x662F;&#x5426;&#x8D85;&#x8FC7;&#x6700;&#x5927;&#x5BB9;&#x91CF;</span></span><br><span class=\"line\">\t\t<span class=\"hljs-built_in\">panic</span>(<span class=\"hljs-string\">&quot;java.lang.StackOverflowError&quot;</span>) </span><br><span class=\"line\">\t}</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> self._top != <span class=\"hljs-literal\">nil</span> {  <span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x6808;&#x9876;&#x4E0D;&#x4E3A;&#x7A7A;&#x65F6;</span></span><br><span class=\"line\">\t\tframe.lower = self._top <span class=\"hljs-comment\">//&#x5C06;&#x63D2;&#x5165;&#x5E27;&#x5C3E;&#x6307;&#x5411;&#x6808;&#x9876;&#x6307;&#x9488;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\"></span><br><span class=\"line\">\tself._top = frame <span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x6808;&#x9876;&#x6307;&#x5411;&#x5F53;&#x524D;&#x5E27;</span></span><br><span class=\"line\">\tself.size++ <span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x6808;&#x5927;&#x5C0F;&#x52A0;1</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x5E27;&#x51FA;&#x6808;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Stack)</span> <span class=\"hljs-title\">pop</span><span class=\"hljs-params\">()</span> *<span class=\"hljs-title\">Frame</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> self._top == <span class=\"hljs-literal\">nil</span> { <span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x6808;&#x9876;&#x4E3A;&#x7A7A;&#x65F6;&#x62A5;&#x9519;</span></span><br><span class=\"line\">\t\t<span class=\"hljs-built_in\">panic</span>(<span class=\"hljs-string\">&quot;jvm stack is empty!&quot;</span>)</span><br><span class=\"line\">\t}</span><br><span class=\"line\"></span><br><span class=\"line\">\ttop := self._top <span class=\"hljs-comment\">//&#x53D6;&#x51FA;&#x5F53;&#x524D;&#x6808;&#x9876;&#x5E27;</span></span><br><span class=\"line\">\tself._top = top.lower <span class=\"hljs-comment\">//&#x5C06;&#x5F53;&#x524D;&#x6808;&#x9876;&#x6307;&#x5411;top&#x7684;&#x4E0B;&#x4E00;&#x5E27;</span></span><br><span class=\"line\">\ttop.lower = <span class=\"hljs-literal\">nil</span> <span class=\"hljs-comment\">//&#x65AD;&#x5F00;top&#x7684;&#x5C3E;&#x6307;&#x9488;</span></span><br><span class=\"line\">\tself.size-- <span class=\"hljs-comment\">//&#x5F53;&#x524D;&#x6808;&#x5927;&#x5C0F;&#x51CF;1</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> top <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;top</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x6808;&#x9876;&#x5E27;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Stack)</span> <span class=\"hljs-title\">top</span><span class=\"hljs-params\">()</span> *<span class=\"hljs-title\">Frame</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> self._top == <span class=\"hljs-literal\">nil</span> { <span class=\"hljs-comment\">////&#x5F53;&#x524D;&#x6808;&#x9876;&#x4E3A;&#x7A7A;&#x65F6;&#x62A5;&#x9519;</span></span><br><span class=\"line\">\t\t<span class=\"hljs-built_in\">panic</span>(<span class=\"hljs-string\">&quot;jvm stack is empty!&quot;</span>)</span><br><span class=\"line\">\t}</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self._top <span class=\"hljs-comment\">//&#x8FD4;&#x56DE;&#x5F53;&#x524D;&#x6808;&#x9876;&#x5E27;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<h4 id=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x5E27;\"><a href=\"#&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x5E27;\" class=\"headerlink\" title=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x5E27;\"></a>&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x5E27;</h4><figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> Frame <span class=\"hljs-keyword\">struct</span> {</span><br><span class=\"line\">\tlower        *Frame <span class=\"hljs-comment\">//&#x6307;&#x5411;&#x4E0B;&#x4E00;&#x5E27;</span></span><br><span class=\"line\">\tlocalVars    LocalVars <span class=\"hljs-comment\">//&#x4FDD;&#x5B58;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;&#x6307;&#x9488;</span></span><br><span class=\"line\">\toperandStack *OperandStack <span class=\"hljs-comment\">//&#x4FDD;&#x5B58;&#x64CD;&#x4F5C;&#x6570;&#x6808;&#x6307;&#x9488;</span></span><br><span class=\"line\">\t<span class=\"hljs-comment\">// todo</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5B9E;&#x4F8B;&#x5316;&#x5E27;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">NewFrame</span><span class=\"hljs-params\">(maxLocals, maxStack <span class=\"hljs-keyword\">uint</span>)</span> *<span class=\"hljs-title\">Frame</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> &amp;Frame{</span><br><span class=\"line\">\t\tlocalVars:    newLocalVars(maxLocals), <span class=\"hljs-comment\">//&#x5B9E;&#x4F8B;&#x5316;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5BF9;&#x8C61;</span></span><br><span class=\"line\">\t\toperandStack: newOperandStack(maxStack), <span class=\"hljs-comment\">//&#x5B9E;&#x4F8B;&#x5316;&#x64CD;&#x4F5C;&#x6570;&#x6808;&#x5BF9;&#x8C61;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// getters</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Frame)</span> <span class=\"hljs-title\">LocalVars</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">LocalVars</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.localVars</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *Frame)</span> <span class=\"hljs-title\">OperandStack</span><span class=\"hljs-params\">()</span> *<span class=\"hljs-title\">OperandStack</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.operandStack</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<h4 id=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;\"><a href=\"#&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;\" class=\"headerlink\" title=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;\"></a>&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;</h4><figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> LocalVars []Slot</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x521B;&#x5EFA;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5B9E;&#x4F8B;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">newLocalVars</span><span class=\"hljs-params\">(maxLocals <span class=\"hljs-keyword\">uint</span>)</span> <span class=\"hljs-title\">LocalVars</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> maxLocals &gt; <span class=\"hljs-number\">0</span> {</span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">make</span>([]Slot, maxLocals) <span class=\"hljs-comment\">//&#x7533;&#x660E;&#x5927;&#x5C0F;&#x4E3A;maxLocals&#x7684;Slot&#x6570;&#x7EC4;</span></span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x8BBE;&#x7F6E;int&#x7C7B;&#x578B;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self LocalVars)</span> <span class=\"hljs-title\">SetInt</span><span class=\"hljs-params\">(index <span class=\"hljs-keyword\">uint</span>, val <span class=\"hljs-keyword\">int32</span>)</span></span> {</span><br><span class=\"line\">\tself[index].num = val</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x53D6;int&#x7C7B;&#x578B;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self LocalVars)</span> <span class=\"hljs-title\">GetInt</span><span class=\"hljs-params\">(index <span class=\"hljs-keyword\">uint</span>)</span> <span class=\"hljs-title\">int32</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self[index].num</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x8BBE;&#x7F6E;float32&#x7C7B;&#x578B;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self LocalVars)</span> <span class=\"hljs-title\">SetFloat</span><span class=\"hljs-params\">(index <span class=\"hljs-keyword\">uint</span>, val <span class=\"hljs-keyword\">float32</span>)</span></span> {</span><br><span class=\"line\">\tbits := math.Float32bits(val)<span class=\"hljs-comment\">//&#x8F6C;&#x4E3A;uint32</span></span><br><span class=\"line\">\tself[index].num = <span class=\"hljs-keyword\">int32</span>(bits) <span class=\"hljs-comment\">//&#x8F6C;&#x4E3A;int32</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x53D6;float32&#x7C7B;&#x578B;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self LocalVars)</span> <span class=\"hljs-title\">GetFloat</span><span class=\"hljs-params\">(index <span class=\"hljs-keyword\">uint</span>)</span> <span class=\"hljs-title\">float32</span></span> {</span><br><span class=\"line\">\tbits := <span class=\"hljs-keyword\">uint32</span>(self[index].num)<span class=\"hljs-comment\">//&#x8F6C;&#x4E3A;unit32</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> math.Float32frombits(bits)<span class=\"hljs-comment\">//&#x8F6C;&#x4E3A;float</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x8BBE;&#x7F6E;long&#x7C7B;&#x578B;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self LocalVars)</span> <span class=\"hljs-title\">SetLong</span><span class=\"hljs-params\">(index <span class=\"hljs-keyword\">uint</span>, val <span class=\"hljs-keyword\">int64</span>)</span></span> {</span><br><span class=\"line\">\tself[index].num = <span class=\"hljs-keyword\">int32</span>(val)<span class=\"hljs-comment\">//&#x53D6;&#x4F4E;&#x4F4D;32&#x4F4D;&#x5B58;&#x50A8;&#x5728;index</span></span><br><span class=\"line\">\tself[index+<span class=\"hljs-number\">1</span>].num = <span class=\"hljs-keyword\">int32</span>(val &gt;&gt; <span class=\"hljs-number\">32</span>) <span class=\"hljs-comment\">//&#x53F3;&#x79FB;32&#x4F4D;&#x53D6;&#x9AD8;&#x4F4D;32&#x4F4D;&#x5B58;&#x50A8;&#x5728;index+1</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x53D6;long&#x7C7B;&#x578B;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self LocalVars)</span> <span class=\"hljs-title\">GetLong</span><span class=\"hljs-params\">(index <span class=\"hljs-keyword\">uint</span>)</span> <span class=\"hljs-title\">int64</span></span> {</span><br><span class=\"line\">\tlow := <span class=\"hljs-keyword\">uint32</span>(self[index].num) <span class=\"hljs-comment\">//&#x53D6;index&#x4F4E;32&#x4F4D;</span></span><br><span class=\"line\">\thigh := <span class=\"hljs-keyword\">uint32</span>(self[index+<span class=\"hljs-number\">1</span>].num) <span class=\"hljs-comment\">//&#x53D6;index+1&#x9AD8;32&#x4F4D;</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">int64</span>(high)&lt;&lt;<span class=\"hljs-number\">32</span> | <span class=\"hljs-keyword\">int64</span>(low) <span class=\"hljs-comment\">//&#x5DE6;&#x79FB;&#x9AD8;&#x4F4D;32&#x4F4D;&#xFF0C;&#x62FC;&#x63A5;&#x9AD8;&#x4F4E;&#x4F4D;&#x8FD4;&#x56DE;</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x8BBE;&#x7F6E;float64</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self LocalVars)</span> <span class=\"hljs-title\">SetDouble</span><span class=\"hljs-params\">(index <span class=\"hljs-keyword\">uint</span>, val <span class=\"hljs-keyword\">float64</span>)</span></span> {</span><br><span class=\"line\">\tbits := math.Float64bits(val) <span class=\"hljs-comment\">//&#x8F6C;&#x4E3A;uint64</span></span><br><span class=\"line\">\tself.SetLong(index, <span class=\"hljs-keyword\">int64</span>(bits)) <span class=\"hljs-comment\">//&#x7528;long&#x578B;&#x8BBE;&#x7F6E;&#x65B9;&#x6CD5;&#x8BBE;&#x7F6E;int64</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x53D6;float64</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self LocalVars)</span> <span class=\"hljs-title\">GetDouble</span><span class=\"hljs-params\">(index <span class=\"hljs-keyword\">uint</span>)</span> <span class=\"hljs-title\">float64</span></span> {</span><br><span class=\"line\">\tbits := <span class=\"hljs-keyword\">uint64</span>(self.GetLong(index)) <span class=\"hljs-comment\">//&#x6309;long&#x578B;&#x53D6;&#x503C;&#x65B9;&#x6CD5;&#x53D6;&#x51FA;uint64</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> math.Float64frombits(bits) <span class=\"hljs-comment\">//&#x8F6C;&#x4E3A;float64</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x8BBE;&#x7F6E;&#x5F15;&#x7528;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self LocalVars)</span> <span class=\"hljs-title\">SetRef</span><span class=\"hljs-params\">(index <span class=\"hljs-keyword\">uint</span>, ref *Object)</span></span> {</span><br><span class=\"line\">\tself[index].ref = ref</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x53D6;&#x5F15;&#x7528;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self LocalVars)</span> <span class=\"hljs-title\">GetRef</span><span class=\"hljs-params\">(index <span class=\"hljs-keyword\">uint</span>)</span> *<span class=\"hljs-title\">Object</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self[index].ref</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<h4 id=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x64CD;&#x4F5C;&#x6570;&#x6808;\"><a href=\"#&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x64CD;&#x4F5C;&#x6570;&#x6808;\" class=\"headerlink\" title=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x64CD;&#x4F5C;&#x6570;&#x6808;\"></a>&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x64CD;&#x4F5C;&#x6570;&#x6808;</h4><figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">type</span> OperandStack <span class=\"hljs-keyword\">struct</span> {</span><br><span class=\"line\">\tsize  <span class=\"hljs-keyword\">uint</span> <span class=\"hljs-comment\">//&#x8BB0;&#x5F55;&#x6808;&#x9876;&#x4F4D;&#x7F6E;</span></span><br><span class=\"line\">\tslots []Slot</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x5B9E;&#x4F8B;&#x5316;&#x64CD;&#x4F5C;&#x6570;&#x6808;</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-title\">newOperandStack</span><span class=\"hljs-params\">(maxStack <span class=\"hljs-keyword\">uint</span>)</span> *<span class=\"hljs-title\">OperandStack</span></span> {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> maxStack &gt; <span class=\"hljs-number\">0</span> {</span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">return</span> &amp;OperandStack{</span><br><span class=\"line\">\t\t\tslots: <span class=\"hljs-built_in\">make</span>([]Slot, maxStack),<span class=\"hljs-comment\">//&#x7533;&#x660E;maxStack&#x5927;&#x5C0F;&#x7684;Slot&#x6570;&#x7EC4;</span></span><br><span class=\"line\">\t\t}</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">nil</span></span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *OperandStack)</span> <span class=\"hljs-title\">PushInt</span><span class=\"hljs-params\">(val <span class=\"hljs-keyword\">int32</span>)</span></span> {</span><br><span class=\"line\">\tself.slots[self.size].num = val</span><br><span class=\"line\">\tself.size++</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *OperandStack)</span> <span class=\"hljs-title\">PopInt</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">int32</span></span> {</span><br><span class=\"line\">\tself.size--</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> self.slots[self.size].num</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *OperandStack)</span> <span class=\"hljs-title\">PushFloat</span><span class=\"hljs-params\">(val <span class=\"hljs-keyword\">float32</span>)</span></span> {</span><br><span class=\"line\">\tbits := math.Float32bits(val)</span><br><span class=\"line\">\tself.slots[self.size].num = <span class=\"hljs-keyword\">int32</span>(bits)</span><br><span class=\"line\">\tself.size++</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *OperandStack)</span> <span class=\"hljs-title\">PopFloat</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">float32</span></span> {</span><br><span class=\"line\">\tself.size--</span><br><span class=\"line\">\tbits := <span class=\"hljs-keyword\">uint32</span>(self.slots[self.size].num)</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> math.Float32frombits(bits)</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// long consumes two slots</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *OperandStack)</span> <span class=\"hljs-title\">PushLong</span><span class=\"hljs-params\">(val <span class=\"hljs-keyword\">int64</span>)</span></span> {</span><br><span class=\"line\">\tself.slots[self.size].num = <span class=\"hljs-keyword\">int32</span>(val)</span><br><span class=\"line\">\tself.slots[self.size+<span class=\"hljs-number\">1</span>].num = <span class=\"hljs-keyword\">int32</span>(val &gt;&gt; <span class=\"hljs-number\">32</span>)</span><br><span class=\"line\">\tself.size += <span class=\"hljs-number\">2</span></span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *OperandStack)</span> <span class=\"hljs-title\">PopLong</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">int64</span></span> {</span><br><span class=\"line\">\tself.size -= <span class=\"hljs-number\">2</span></span><br><span class=\"line\">\tlow := <span class=\"hljs-keyword\">uint32</span>(self.slots[self.size].num)</span><br><span class=\"line\">\thigh := <span class=\"hljs-keyword\">uint32</span>(self.slots[self.size+<span class=\"hljs-number\">1</span>].num)</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">int64</span>(high)&lt;&lt;<span class=\"hljs-number\">32</span> | <span class=\"hljs-keyword\">int64</span>(low)</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-comment\">// double consumes two slots</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *OperandStack)</span> <span class=\"hljs-title\">PushDouble</span><span class=\"hljs-params\">(val <span class=\"hljs-keyword\">float64</span>)</span></span> {</span><br><span class=\"line\">\tbits := math.Float64bits(val)</span><br><span class=\"line\">\tself.PushLong(<span class=\"hljs-keyword\">int64</span>(bits))</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *OperandStack)</span> <span class=\"hljs-title\">PopDouble</span><span class=\"hljs-params\">()</span> <span class=\"hljs-title\">float64</span></span> {</span><br><span class=\"line\">\tbits := <span class=\"hljs-keyword\">uint64</span>(self.PopLong())</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> math.Float64frombits(bits)</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *OperandStack)</span> <span class=\"hljs-title\">PushRef</span><span class=\"hljs-params\">(ref *Object)</span></span> {</span><br><span class=\"line\">\tself.slots[self.size].ref = ref</span><br><span class=\"line\">\tself.size++</span><br><span class=\"line\">}</span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">func</span> <span class=\"hljs-params\">(self *OperandStack)</span> <span class=\"hljs-title\">PopRef</span><span class=\"hljs-params\">()</span> *<span class=\"hljs-title\">Object</span></span> {</span><br><span class=\"line\">\tself.size--</span><br><span class=\"line\">\tref := self.slots[self.size].ref</span><br><span class=\"line\">\tself.slots[self.size].ref = <span class=\"hljs-literal\">nil</span></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> ref</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h4 id=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x64CD;&#x4F5C;&#x6570;&#x6808;-1\"><a href=\"#&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x64CD;&#x4F5C;&#x6570;&#x6808;-1\" class=\"headerlink\" title=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x64CD;&#x4F5C;&#x6570;&#x6808;\"></a>&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;-&#x64CD;&#x4F5C;&#x6570;&#x6808;</h4><figure class=\"highlight golang hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure></body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"JVM","path":"tags/JVM/"},{"name":"Java","path":"tags/Java/"},{"name":"Go","path":"tags/Go/"}],"excerpt":"<html><head></head><body><h3 id=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;\"><a href=\"#&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;\" class=\"headerlink\" title=\"&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;\"></a>&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;</h3><p>JVM&#x5C06;&#x9700;&#x8981;&#x7528;&#x5230;&#x7684;&#x6570;&#x636E;&#x5B58;&#x653E;&#x5165;&#x5185;&#x5B58;&#x4E2D;&#xFF0C;&#x8FD9;&#x4E2A;&#x5185;&#x5B58;&#x533A;&#x5C31;&#x53EB;&#x8FD0;&#x884C;&#x65F6;&#x6570;&#x636E;&#x533A;<br>&#x53EF;&#x5206;&#x4E3A;&#x4E24;&#x79CD;&#xFF1A;</p>\n<ol>\n<li>&#x4E00;&#x7C7B;&#x662F;&#x591A;&#x7EBF;&#x7A0B;&#x5171;&#x4EAB;&#x7684;&#xFF0C;&#x8BE5;&#x6570;&#x636E;&#x533A;&#x9700;&#x8981;&#x5728;Java&#x865A;&#x62DF;&#x673A;&#x542F;&#x52A8;&#x65F6;&#x521B;&#x5EFA;&#x597D;&#xFF0C;&#x5728;Java&#x865A;&#x62DF;&#x673A;&#x9000;&#x51FA;&#x65F6;&#x9500;&#x6BC1;&#x3002;</li>\n<li>&#x4E00;&#x7C7B;&#x5219;&#x662F;&#x7EBF;&#x7A0B;&#x79C1;&#x6709;&#x7684;&#xFF0C;&#x8BE5;&#x6570;&#x636E;&#x533A;&#x5219;&#x5728;&#x521B;&#x5EFA;&#x7EBF;&#x7A0B;&#x65F6;&#x624D;&#x521B;&#x5EFA;&#xFF0C;&#x7EBF;&#x7A0B;&#x9000;&#x51FA;&#x65F6;&#x9500;&#x6BC1;&#x3002;</li>\n</ol></body></html>","more":"<p><img src=\"/2019/09/26/%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%E5%86%99Java%E8%99%9A%E6%8B%9F%E6%9C%BA-%E7%AC%94%E8%AE%B04/%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.png\" alt=\"01\"></p>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><h4 id=\"定义对象结构\"><a href=\"#定义对象结构\" class=\"headerlink\" title=\"定义对象结构\"></a>定义对象结构</h4><figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Object <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\t<span class=\"comment\">// todo</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"运行时数据区-线程\"><a href=\"#运行时数据区-线程\" class=\"headerlink\" title=\"运行时数据区-线程\"></a>运行时数据区-线程</h4><figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Thread <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tpc    <span class=\"keyword\">int</span> <span class=\"comment\">// the address of the instruction currently being executed</span></span><br><span class=\"line\">\tstack *Stack <span class=\"comment\">//Java虚拟机栈指针</span></span><br><span class=\"line\">\t<span class=\"comment\">// todo</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//创建Thread实例</span></span><br><span class=\"line\"><span class=\"comment\">//java命令提供了-Xss选项来设置Java虚拟机栈大小</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewThread</span><span class=\"params\">()</span> *<span class=\"title\">Thread</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;Thread&#123;</span><br><span class=\"line\">\t\tstack: newStack(<span class=\"number\">1024</span>), <span class=\"comment\">//最多容纳1024帧</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Thread)</span> <span class=\"title\">PC</span><span class=\"params\">()</span> <span class=\"title\">int</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.pc</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Thread)</span> <span class=\"title\">SetPC</span><span class=\"params\">(pc <span class=\"keyword\">int</span>)</span></span> &#123;</span><br><span class=\"line\">\tself.pc = pc</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//当前帧进栈</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Thread)</span> <span class=\"title\">PushFrame</span><span class=\"params\">(frame *Frame)</span></span> &#123;</span><br><span class=\"line\">\tself.stack.push(frame)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//当前帧出栈</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Thread)</span> <span class=\"title\">PopFrame</span><span class=\"params\">()</span> *<span class=\"title\">Frame</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.stack.pop()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//获取当前帧</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Thread)</span> <span class=\"title\">CurrentFrame</span><span class=\"params\">()</span> *<span class=\"title\">Frame</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.stack.top()</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"运行时数据区-Java虚拟机栈\"><a href=\"#运行时数据区-Java虚拟机栈\" class=\"headerlink\" title=\"运行时数据区-Java虚拟机栈\"></a>运行时数据区-Java虚拟机栈</h4><figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Stack <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tmaxSize <span class=\"keyword\">uint</span> <span class=\"comment\">//最多可以容纳多少帧</span></span><br><span class=\"line\">\tsize    <span class=\"keyword\">uint</span> <span class=\"comment\">//栈的当前大小</span></span><br><span class=\"line\">\t_top    *Frame <span class=\"comment\">//保存栈顶指针</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//实例一个栈</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newStack</span><span class=\"params\">(maxSize <span class=\"keyword\">uint</span>)</span> *<span class=\"title\">Stack</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;Stack&#123;</span><br><span class=\"line\">\t\tmaxSize: maxSize,</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//当前帧进栈</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Stack)</span> <span class=\"title\">push</span><span class=\"params\">(frame *Frame)</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> self.size &gt;= self.maxSize &#123; <span class=\"comment\">//判断当前栈大小是否超过最大容量</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">panic</span>(<span class=\"string\">&quot;java.lang.StackOverflowError&quot;</span>) </span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> self._top != <span class=\"literal\">nil</span> &#123;  <span class=\"comment\">//当前栈顶不为空时</span></span><br><span class=\"line\">\t\tframe.lower = self._top <span class=\"comment\">//将插入帧尾指向栈顶指针</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tself._top = frame <span class=\"comment\">//当前栈顶指向当前帧</span></span><br><span class=\"line\">\tself.size++ <span class=\"comment\">//当前栈大小加1</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//当前帧出栈</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Stack)</span> <span class=\"title\">pop</span><span class=\"params\">()</span> *<span class=\"title\">Frame</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> self._top == <span class=\"literal\">nil</span> &#123; <span class=\"comment\">//当前栈顶为空时报错</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">panic</span>(<span class=\"string\">&quot;jvm stack is empty!&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\ttop := self._top <span class=\"comment\">//取出当前栈顶帧</span></span><br><span class=\"line\">\tself._top = top.lower <span class=\"comment\">//将当前栈顶指向top的下一帧</span></span><br><span class=\"line\">\ttop.lower = <span class=\"literal\">nil</span> <span class=\"comment\">//断开top的尾指针</span></span><br><span class=\"line\">\tself.size-- <span class=\"comment\">//当前栈大小减1</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> top <span class=\"comment\">//返回top</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//获取当前栈顶帧</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Stack)</span> <span class=\"title\">top</span><span class=\"params\">()</span> *<span class=\"title\">Frame</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> self._top == <span class=\"literal\">nil</span> &#123; <span class=\"comment\">////当前栈顶为空时报错</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">panic</span>(<span class=\"string\">&quot;jvm stack is empty!&quot;</span>)</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self._top <span class=\"comment\">//返回当前栈顶帧</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"运行时数据区-帧\"><a href=\"#运行时数据区-帧\" class=\"headerlink\" title=\"运行时数据区-帧\"></a>运行时数据区-帧</h4><figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> Frame <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tlower        *Frame <span class=\"comment\">//指向下一帧</span></span><br><span class=\"line\">\tlocalVars    LocalVars <span class=\"comment\">//保存局部变量表指针</span></span><br><span class=\"line\">\toperandStack *OperandStack <span class=\"comment\">//保存操作数栈指针</span></span><br><span class=\"line\">\t<span class=\"comment\">// todo</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//实例化帧</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">NewFrame</span><span class=\"params\">(maxLocals, maxStack <span class=\"keyword\">uint</span>)</span> *<span class=\"title\">Frame</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> &amp;Frame&#123;</span><br><span class=\"line\">\t\tlocalVars:    newLocalVars(maxLocals), <span class=\"comment\">//实例化局部变量对象</span></span><br><span class=\"line\">\t\toperandStack: newOperandStack(maxStack), <span class=\"comment\">//实例化操作数栈对象</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// getters</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Frame)</span> <span class=\"title\">LocalVars</span><span class=\"params\">()</span> <span class=\"title\">LocalVars</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.localVars</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *Frame)</span> <span class=\"title\">OperandStack</span><span class=\"params\">()</span> *<span class=\"title\">OperandStack</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.operandStack</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"运行时数据区-局部变量表\"><a href=\"#运行时数据区-局部变量表\" class=\"headerlink\" title=\"运行时数据区-局部变量表\"></a>运行时数据区-局部变量表</h4><figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> LocalVars []Slot</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//创建局部变量实例</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newLocalVars</span><span class=\"params\">(maxLocals <span class=\"keyword\">uint</span>)</span> <span class=\"title\">LocalVars</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> maxLocals &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"built_in\">make</span>([]Slot, maxLocals) <span class=\"comment\">//申明大小为maxLocals的Slot数组</span></span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//设置int类型</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self LocalVars)</span> <span class=\"title\">SetInt</span><span class=\"params\">(index <span class=\"keyword\">uint</span>, val <span class=\"keyword\">int32</span>)</span></span> &#123;</span><br><span class=\"line\">\tself[index].num = val</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//取int类型</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self LocalVars)</span> <span class=\"title\">GetInt</span><span class=\"params\">(index <span class=\"keyword\">uint</span>)</span> <span class=\"title\">int32</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self[index].num</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//设置float32类型</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self LocalVars)</span> <span class=\"title\">SetFloat</span><span class=\"params\">(index <span class=\"keyword\">uint</span>, val <span class=\"keyword\">float32</span>)</span></span> &#123;</span><br><span class=\"line\">\tbits := math.Float32bits(val)<span class=\"comment\">//转为uint32</span></span><br><span class=\"line\">\tself[index].num = <span class=\"keyword\">int32</span>(bits) <span class=\"comment\">//转为int32</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//取float32类型</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self LocalVars)</span> <span class=\"title\">GetFloat</span><span class=\"params\">(index <span class=\"keyword\">uint</span>)</span> <span class=\"title\">float32</span></span> &#123;</span><br><span class=\"line\">\tbits := <span class=\"keyword\">uint32</span>(self[index].num)<span class=\"comment\">//转为unit32</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> math.Float32frombits(bits)<span class=\"comment\">//转为float</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//设置long类型</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self LocalVars)</span> <span class=\"title\">SetLong</span><span class=\"params\">(index <span class=\"keyword\">uint</span>, val <span class=\"keyword\">int64</span>)</span></span> &#123;</span><br><span class=\"line\">\tself[index].num = <span class=\"keyword\">int32</span>(val)<span class=\"comment\">//取低位32位存储在index</span></span><br><span class=\"line\">\tself[index+<span class=\"number\">1</span>].num = <span class=\"keyword\">int32</span>(val &gt;&gt; <span class=\"number\">32</span>) <span class=\"comment\">//右移32位取高位32位存储在index+1</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//取long类型</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self LocalVars)</span> <span class=\"title\">GetLong</span><span class=\"params\">(index <span class=\"keyword\">uint</span>)</span> <span class=\"title\">int64</span></span> &#123;</span><br><span class=\"line\">\tlow := <span class=\"keyword\">uint32</span>(self[index].num) <span class=\"comment\">//取index低32位</span></span><br><span class=\"line\">\thigh := <span class=\"keyword\">uint32</span>(self[index+<span class=\"number\">1</span>].num) <span class=\"comment\">//取index+1高32位</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"keyword\">int64</span>(high)&lt;&lt;<span class=\"number\">32</span> | <span class=\"keyword\">int64</span>(low) <span class=\"comment\">//左移高位32位，拼接高低位返回</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//设置float64</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self LocalVars)</span> <span class=\"title\">SetDouble</span><span class=\"params\">(index <span class=\"keyword\">uint</span>, val <span class=\"keyword\">float64</span>)</span></span> &#123;</span><br><span class=\"line\">\tbits := math.Float64bits(val) <span class=\"comment\">//转为uint64</span></span><br><span class=\"line\">\tself.SetLong(index, <span class=\"keyword\">int64</span>(bits)) <span class=\"comment\">//用long型设置方法设置int64</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//取float64</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self LocalVars)</span> <span class=\"title\">GetDouble</span><span class=\"params\">(index <span class=\"keyword\">uint</span>)</span> <span class=\"title\">float64</span></span> &#123;</span><br><span class=\"line\">\tbits := <span class=\"keyword\">uint64</span>(self.GetLong(index)) <span class=\"comment\">//按long型取值方法取出uint64</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> math.Float64frombits(bits) <span class=\"comment\">//转为float64</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//设置引用</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self LocalVars)</span> <span class=\"title\">SetRef</span><span class=\"params\">(index <span class=\"keyword\">uint</span>, ref *Object)</span></span> &#123;</span><br><span class=\"line\">\tself[index].ref = ref</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//取引用</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self LocalVars)</span> <span class=\"title\">GetRef</span><span class=\"params\">(index <span class=\"keyword\">uint</span>)</span> *<span class=\"title\">Object</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self[index].ref</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"运行时数据区-操作数栈\"><a href=\"#运行时数据区-操作数栈\" class=\"headerlink\" title=\"运行时数据区-操作数栈\"></a>运行时数据区-操作数栈</h4><figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">type</span> OperandStack <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">\tsize  <span class=\"keyword\">uint</span> <span class=\"comment\">//记录栈顶位置</span></span><br><span class=\"line\">\tslots []Slot</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\">//实例化操作数栈</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">newOperandStack</span><span class=\"params\">(maxStack <span class=\"keyword\">uint</span>)</span> *<span class=\"title\">OperandStack</span></span> &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> maxStack &gt; <span class=\"number\">0</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> &amp;OperandStack&#123;</span><br><span class=\"line\">\t\t\tslots: <span class=\"built_in\">make</span>([]Slot, maxStack),<span class=\"comment\">//申明maxStack大小的Slot数组</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"literal\">nil</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *OperandStack)</span> <span class=\"title\">PushInt</span><span class=\"params\">(val <span class=\"keyword\">int32</span>)</span></span> &#123;</span><br><span class=\"line\">\tself.slots[self.size].num = val</span><br><span class=\"line\">\tself.size++</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *OperandStack)</span> <span class=\"title\">PopInt</span><span class=\"params\">()</span> <span class=\"title\">int32</span></span> &#123;</span><br><span class=\"line\">\tself.size--</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> self.slots[self.size].num</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *OperandStack)</span> <span class=\"title\">PushFloat</span><span class=\"params\">(val <span class=\"keyword\">float32</span>)</span></span> &#123;</span><br><span class=\"line\">\tbits := math.Float32bits(val)</span><br><span class=\"line\">\tself.slots[self.size].num = <span class=\"keyword\">int32</span>(bits)</span><br><span class=\"line\">\tself.size++</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *OperandStack)</span> <span class=\"title\">PopFloat</span><span class=\"params\">()</span> <span class=\"title\">float32</span></span> &#123;</span><br><span class=\"line\">\tself.size--</span><br><span class=\"line\">\tbits := <span class=\"keyword\">uint32</span>(self.slots[self.size].num)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> math.Float32frombits(bits)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// long consumes two slots</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *OperandStack)</span> <span class=\"title\">PushLong</span><span class=\"params\">(val <span class=\"keyword\">int64</span>)</span></span> &#123;</span><br><span class=\"line\">\tself.slots[self.size].num = <span class=\"keyword\">int32</span>(val)</span><br><span class=\"line\">\tself.slots[self.size+<span class=\"number\">1</span>].num = <span class=\"keyword\">int32</span>(val &gt;&gt; <span class=\"number\">32</span>)</span><br><span class=\"line\">\tself.size += <span class=\"number\">2</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *OperandStack)</span> <span class=\"title\">PopLong</span><span class=\"params\">()</span> <span class=\"title\">int64</span></span> &#123;</span><br><span class=\"line\">\tself.size -= <span class=\"number\">2</span></span><br><span class=\"line\">\tlow := <span class=\"keyword\">uint32</span>(self.slots[self.size].num)</span><br><span class=\"line\">\thigh := <span class=\"keyword\">uint32</span>(self.slots[self.size+<span class=\"number\">1</span>].num)</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"keyword\">int64</span>(high)&lt;&lt;<span class=\"number\">32</span> | <span class=\"keyword\">int64</span>(low)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// double consumes two slots</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *OperandStack)</span> <span class=\"title\">PushDouble</span><span class=\"params\">(val <span class=\"keyword\">float64</span>)</span></span> &#123;</span><br><span class=\"line\">\tbits := math.Float64bits(val)</span><br><span class=\"line\">\tself.PushLong(<span class=\"keyword\">int64</span>(bits))</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *OperandStack)</span> <span class=\"title\">PopDouble</span><span class=\"params\">()</span> <span class=\"title\">float64</span></span> &#123;</span><br><span class=\"line\">\tbits := <span class=\"keyword\">uint64</span>(self.PopLong())</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> math.Float64frombits(bits)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *OperandStack)</span> <span class=\"title\">PushRef</span><span class=\"params\">(ref *Object)</span></span> &#123;</span><br><span class=\"line\">\tself.slots[self.size].ref = ref</span><br><span class=\"line\">\tself.size++</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"params\">(self *OperandStack)</span> <span class=\"title\">PopRef</span><span class=\"params\">()</span> *<span class=\"title\">Object</span></span> &#123;</span><br><span class=\"line\">\tself.size--</span><br><span class=\"line\">\tref := self.slots[self.size].ref</span><br><span class=\"line\">\tself.slots[self.size].ref = <span class=\"literal\">nil</span></span><br><span class=\"line\">\t<span class=\"keyword\">return</span> ref</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"运行时数据区-操作数栈-1\"><a href=\"#运行时数据区-操作数栈-1\" class=\"headerlink\" title=\"运行时数据区-操作数栈\"></a>运行时数据区-操作数栈</h4><figure class=\"highlight golang\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>"},{"title":"记一次序列化失败导致的生产问题","date":"2019-09-24T06:36:13.000Z","_content":"\n文件上传下载时出现以下错误：\n\n![01](记一次序列化失败导致的生产问题/wenti.png)\n<!-- more -->\n\n经过调查,由于重写了WebMvcConfigurationSupport.configureMessageConverters方法\n{% codeblock lang:java %}\n@Configuration\npublic class OpenServiceConfig extends WebMvcConfigurationSupport implements ApplicationRunner {\n\n    @Autowired\n    private Environment environment;\n\n    private ApiMappingHandlerMapping apiMappingHandlerMapping = new ApiMappingHandlerMapping();\n\n    @Override\n    protected RequestMappingHandlerMapping createRequestMappingHandlerMapping() {\n        return apiMappingHandlerMapping;\n    }\n\n    @Override\n    public void run(ApplicationArguments args) {\n        ApiMetaManager apiMetaManager = new ServiceZookeeperApiMetaManager(environment);\n        RequestMappingEvent requestMappingEvent = new DefaultRequestMappingEvent(apiMetaManager, environment);\n        requestMappingEvent.onRegisterSuccess(apiMappingHandlerMapping);\n    }\n\n    @Override\n    public void configureMessageConverters(List<HttpMessageConverter<?>> converters) {\n        converters.clear();\n        ObjectMapper objectMapper = new ObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_NULL);\n        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES,false);\n        converters.add(new MappingJackson2HttpMessageConverter(objectMapper));\n    }\n\n    @Override\n    protected void addResourceHandlers(ResourceHandlerRegistry registry) {\n        registry.addResourceHandler(\"swagger-ui.html\")\n                .addResourceLocations(\"classpath:/META-INF/resources/\");\n\n        registry.addResourceHandler(\"/webjars/**\")\n                .addResourceLocations(\"classpath:/META-INF/resources/webjars/\");\n    }\n}\n{% endcodeblock %}\n\nspringMVC开始加载转换器的时候会先走用户定制化方法\n{% codeblock lang:java %}\n\tprotected final List<HttpMessageConverter<?>> getMessageConverters() {\n\t\tif (this.messageConverters == null) {\n\t\t\tthis.messageConverters = new ArrayList<HttpMessageConverter<?>>();\n\t\t\tconfigureMessageConverters(this.messageConverters);\n\t\t\tif (this.messageConverters.isEmpty()) {\n\t\t\t\taddDefaultHttpMessageConverters(this.messageConverters);\n\t\t\t}\n\t\t\textendMessageConverters(this.messageConverters);\n\t\t}\n\t\treturn this.messageConverters;\n\t}\n{% endcodeblock %}\n\n如果用户没有定制化，springmvc会使用自定个的7个转换器\n{% codeblock lang:java %}\n\tprotected final void addDefaultHttpMessageConverters(List<HttpMessageConverter<?>> messageConverters) {\n\t\tStringHttpMessageConverter stringConverter = new StringHttpMessageConverter();\n\t\tstringConverter.setWriteAcceptCharset(false);\n\n\t\tmessageConverters.add(new ByteArrayHttpMessageConverter());\n\t\tmessageConverters.add(stringConverter);\n\t\tmessageConverters.add(new ResourceHttpMessageConverter());\n\t\tmessageConverters.add(new SourceHttpMessageConverter<Source>());\n\t\tmessageConverters.add(new AllEncompassingFormHttpMessageConverter());\n\n\t\tif (romePresent) {\n\t\t\tmessageConverters.add(new AtomFeedHttpMessageConverter());\n\t\t\tmessageConverters.add(new RssChannelHttpMessageConverter());\n\t\t}\n\n\t\tif (jackson2XmlPresent) {\n\t\t\tmessageConverters.add(new MappingJackson2XmlHttpMessageConverter(\n\t\t\t\t\tJackson2ObjectMapperBuilder.xml().applicationContext(this.applicationContext).build()));\n\t\t}\n\t\telse if (jaxb2Present) {\n\t\t\tmessageConverters.add(new Jaxb2RootElementHttpMessageConverter());\n\t\t}\n\n\t\tif (jackson2Present) {\n\t\t\tmessageConverters.add(new MappingJackson2HttpMessageConverter(\n\t\t\t\t\tJackson2ObjectMapperBuilder.json().applicationContext(this.applicationContext).build()));\n\t\t}\n\t\telse if (gsonPresent) {\n\t\t\tmessageConverters.add(new GsonHttpMessageConverter());\n\t\t}\n\t}\n{% endcodeblock %}\n\n由于项目在自定义的时候没有考虑到文件上传下载这种字节流的解析，导致序列化失败\n增加配置解决问题\n{% codeblock lang:java %}\nobjectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, false);\n{% endcodeblock %}","source":"_posts/记一次序列化失败导致的生产问题.md","raw":"---\ntitle: 记一次序列化失败导致的生产问题\ndate: 2019-09-24 14:36:13\ntags:\n    - Java\n    - Spring Boot\ncategories:\n    - Technology\n---\n\n文件上传下载时出现以下错误：\n\n![01](记一次序列化失败导致的生产问题/wenti.png)\n<!-- more -->\n\n经过调查,由于重写了WebMvcConfigurationSupport.configureMessageConverters方法\n{% codeblock lang:java %}\n@Configuration\npublic class OpenServiceConfig extends WebMvcConfigurationSupport implements ApplicationRunner {\n\n    @Autowired\n    private Environment environment;\n\n    private ApiMappingHandlerMapping apiMappingHandlerMapping = new ApiMappingHandlerMapping();\n\n    @Override\n    protected RequestMappingHandlerMapping createRequestMappingHandlerMapping() {\n        return apiMappingHandlerMapping;\n    }\n\n    @Override\n    public void run(ApplicationArguments args) {\n        ApiMetaManager apiMetaManager = new ServiceZookeeperApiMetaManager(environment);\n        RequestMappingEvent requestMappingEvent = new DefaultRequestMappingEvent(apiMetaManager, environment);\n        requestMappingEvent.onRegisterSuccess(apiMappingHandlerMapping);\n    }\n\n    @Override\n    public void configureMessageConverters(List<HttpMessageConverter<?>> converters) {\n        converters.clear();\n        ObjectMapper objectMapper = new ObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_NULL);\n        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES,false);\n        converters.add(new MappingJackson2HttpMessageConverter(objectMapper));\n    }\n\n    @Override\n    protected void addResourceHandlers(ResourceHandlerRegistry registry) {\n        registry.addResourceHandler(\"swagger-ui.html\")\n                .addResourceLocations(\"classpath:/META-INF/resources/\");\n\n        registry.addResourceHandler(\"/webjars/**\")\n                .addResourceLocations(\"classpath:/META-INF/resources/webjars/\");\n    }\n}\n{% endcodeblock %}\n\nspringMVC开始加载转换器的时候会先走用户定制化方法\n{% codeblock lang:java %}\n\tprotected final List<HttpMessageConverter<?>> getMessageConverters() {\n\t\tif (this.messageConverters == null) {\n\t\t\tthis.messageConverters = new ArrayList<HttpMessageConverter<?>>();\n\t\t\tconfigureMessageConverters(this.messageConverters);\n\t\t\tif (this.messageConverters.isEmpty()) {\n\t\t\t\taddDefaultHttpMessageConverters(this.messageConverters);\n\t\t\t}\n\t\t\textendMessageConverters(this.messageConverters);\n\t\t}\n\t\treturn this.messageConverters;\n\t}\n{% endcodeblock %}\n\n如果用户没有定制化，springmvc会使用自定个的7个转换器\n{% codeblock lang:java %}\n\tprotected final void addDefaultHttpMessageConverters(List<HttpMessageConverter<?>> messageConverters) {\n\t\tStringHttpMessageConverter stringConverter = new StringHttpMessageConverter();\n\t\tstringConverter.setWriteAcceptCharset(false);\n\n\t\tmessageConverters.add(new ByteArrayHttpMessageConverter());\n\t\tmessageConverters.add(stringConverter);\n\t\tmessageConverters.add(new ResourceHttpMessageConverter());\n\t\tmessageConverters.add(new SourceHttpMessageConverter<Source>());\n\t\tmessageConverters.add(new AllEncompassingFormHttpMessageConverter());\n\n\t\tif (romePresent) {\n\t\t\tmessageConverters.add(new AtomFeedHttpMessageConverter());\n\t\t\tmessageConverters.add(new RssChannelHttpMessageConverter());\n\t\t}\n\n\t\tif (jackson2XmlPresent) {\n\t\t\tmessageConverters.add(new MappingJackson2XmlHttpMessageConverter(\n\t\t\t\t\tJackson2ObjectMapperBuilder.xml().applicationContext(this.applicationContext).build()));\n\t\t}\n\t\telse if (jaxb2Present) {\n\t\t\tmessageConverters.add(new Jaxb2RootElementHttpMessageConverter());\n\t\t}\n\n\t\tif (jackson2Present) {\n\t\t\tmessageConverters.add(new MappingJackson2HttpMessageConverter(\n\t\t\t\t\tJackson2ObjectMapperBuilder.json().applicationContext(this.applicationContext).build()));\n\t\t}\n\t\telse if (gsonPresent) {\n\t\t\tmessageConverters.add(new GsonHttpMessageConverter());\n\t\t}\n\t}\n{% endcodeblock %}\n\n由于项目在自定义的时候没有考虑到文件上传下载这种字节流的解析，导致序列化失败\n增加配置解决问题\n{% codeblock lang:java %}\nobjectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, false);\n{% endcodeblock %}","slug":"记一次序列化失败导致的生产问题","published":1,"updated":"2020-12-14T10:25:51.707Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71hty0021v2526zju8kpj","content":"<html><head></head><body><p>&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x4E0B;&#x8F7D;&#x65F6;&#x51FA;&#x73B0;&#x4EE5;&#x4E0B;&#x9519;&#x8BEF;&#xFF1A;</p>\n<p><img src=\"/2019/09/24/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%B1%E8%B4%A5%E5%AF%BC%E8%87%B4%E7%9A%84%E7%94%9F%E4%BA%A7%E9%97%AE%E9%A2%98/wenti.png\" alt=\"01\"></p>\n<a id=\"more\"></a>\n\n<p>&#x7ECF;&#x8FC7;&#x8C03;&#x67E5;,&#x7531;&#x4E8E;&#x91CD;&#x5199;&#x4E86;WebMvcConfigurationSupport.configureMessageConverters&#x65B9;&#x6CD5;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">OpenServiceConfig</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">WebMvcConfigurationSupport</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">ApplicationRunner</span> </span>{</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> Environment environment;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> ApiMappingHandlerMapping apiMappingHandlerMapping = <span class=\"hljs-keyword\">new</span> ApiMappingHandlerMapping();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> RequestMappingHandlerMapping <span class=\"hljs-title\">createRequestMappingHandlerMapping</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> apiMappingHandlerMapping;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">run</span><span class=\"hljs-params\">(ApplicationArguments args)</span> </span>{</span><br><span class=\"line\">        ApiMetaManager apiMetaManager = <span class=\"hljs-keyword\">new</span> ServiceZookeeperApiMetaManager(environment);</span><br><span class=\"line\">        RequestMappingEvent requestMappingEvent = <span class=\"hljs-keyword\">new</span> DefaultRequestMappingEvent(apiMetaManager, environment);</span><br><span class=\"line\">        requestMappingEvent.onRegisterSuccess(apiMappingHandlerMapping);</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">configureMessageConverters</span><span class=\"hljs-params\">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>{</span><br><span class=\"line\">        converters.clear();</span><br><span class=\"line\">        ObjectMapper objectMapper = <span class=\"hljs-keyword\">new</span> ObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_NULL);</span><br><span class=\"line\">        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES,<span class=\"hljs-keyword\">false</span>);</span><br><span class=\"line\">        converters.add(<span class=\"hljs-keyword\">new</span> MappingJackson2HttpMessageConverter(objectMapper));</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">addResourceHandlers</span><span class=\"hljs-params\">(ResourceHandlerRegistry registry)</span> </span>{</span><br><span class=\"line\">        registry.addResourceHandler(<span class=\"hljs-string\">&quot;swagger-ui.html&quot;</span>)</span><br><span class=\"line\">                .addResourceLocations(<span class=\"hljs-string\">&quot;classpath:/META-INF/resources/&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        registry.addResourceHandler(<span class=\"hljs-string\">&quot;/webjars/**&quot;</span>)</span><br><span class=\"line\">                .addResourceLocations(<span class=\"hljs-string\">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>springMVC&#x5F00;&#x59CB;&#x52A0;&#x8F7D;&#x8F6C;&#x6362;&#x5668;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x5148;&#x8D70;&#x7528;&#x6237;&#x5B9A;&#x5236;&#x5316;&#x65B9;&#x6CD5;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">protected</span> <span class=\"hljs-keyword\">final</span> List&lt;HttpMessageConverter&lt;?&gt;&gt; getMessageConverters() {</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.messageConverters == <span class=\"hljs-keyword\">null</span>) {</span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">this</span>.messageConverters = <span class=\"hljs-keyword\">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;();</span><br><span class=\"line\">\t\tconfigureMessageConverters(<span class=\"hljs-keyword\">this</span>.messageConverters);</span><br><span class=\"line\">\t\t<span class=\"hljs-keyword\">if</span> (<span class=\"hljs-keyword\">this</span>.messageConverters.isEmpty()) {</span><br><span class=\"line\">\t\t\taddDefaultHttpMessageConverters(<span class=\"hljs-keyword\">this</span>.messageConverters);</span><br><span class=\"line\">\t\t}</span><br><span class=\"line\">\t\textendMessageConverters(<span class=\"hljs-keyword\">this</span>.messageConverters);</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">this</span>.messageConverters;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x5982;&#x679C;&#x7528;&#x6237;&#x6CA1;&#x6709;&#x5B9A;&#x5236;&#x5316;&#xFF0C;springmvc&#x4F1A;&#x4F7F;&#x7528;&#x81EA;&#x5B9A;&#x4E2A;&#x7684;7&#x4E2A;&#x8F6C;&#x6362;&#x5668;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> <span class=\"hljs-keyword\">final</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">addDefaultHttpMessageConverters</span><span class=\"hljs-params\">(List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters)</span> </span>{</span><br><span class=\"line\">\tStringHttpMessageConverter stringConverter = <span class=\"hljs-keyword\">new</span> StringHttpMessageConverter();</span><br><span class=\"line\">\tstringConverter.setWriteAcceptCharset(<span class=\"hljs-keyword\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tmessageConverters.add(<span class=\"hljs-keyword\">new</span> ByteArrayHttpMessageConverter());</span><br><span class=\"line\">\tmessageConverters.add(stringConverter);</span><br><span class=\"line\">\tmessageConverters.add(<span class=\"hljs-keyword\">new</span> ResourceHttpMessageConverter());</span><br><span class=\"line\">\tmessageConverters.add(<span class=\"hljs-keyword\">new</span> SourceHttpMessageConverter&lt;Source&gt;());</span><br><span class=\"line\">\tmessageConverters.add(<span class=\"hljs-keyword\">new</span> AllEncompassingFormHttpMessageConverter());</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> (romePresent) {</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"hljs-keyword\">new</span> AtomFeedHttpMessageConverter());</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"hljs-keyword\">new</span> RssChannelHttpMessageConverter());</span><br><span class=\"line\">\t}</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> (jackson2XmlPresent) {</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"hljs-keyword\">new</span> MappingJackson2XmlHttpMessageConverter(</span><br><span class=\"line\">\t\t\t\tJackson2ObjectMapperBuilder.xml().applicationContext(<span class=\"hljs-keyword\">this</span>.applicationContext).build()));</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (jaxb2Present) {</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"hljs-keyword\">new</span> Jaxb2RootElementHttpMessageConverter());</span><br><span class=\"line\">\t}</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"hljs-keyword\">if</span> (jackson2Present) {</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"hljs-keyword\">new</span> MappingJackson2HttpMessageConverter(</span><br><span class=\"line\">\t\t\t\tJackson2ObjectMapperBuilder.json().applicationContext(<span class=\"hljs-keyword\">this</span>.applicationContext).build()));</span><br><span class=\"line\">\t}</span><br><span class=\"line\">\t<span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (gsonPresent) {</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"hljs-keyword\">new</span> GsonHttpMessageConverter());</span><br><span class=\"line\">\t}</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x7531;&#x4E8E;&#x9879;&#x76EE;&#x5728;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x65F6;&#x5019;&#x6CA1;&#x6709;&#x8003;&#x8651;&#x5230;&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x4E0B;&#x8F7D;&#x8FD9;&#x79CD;&#x5B57;&#x8282;&#x6D41;&#x7684;&#x89E3;&#x6790;&#xFF0C;&#x5BFC;&#x81F4;&#x5E8F;&#x5217;&#x5316;&#x5931;&#x8D25;<br>&#x589E;&#x52A0;&#x914D;&#x7F6E;&#x89E3;&#x51B3;&#x95EE;&#x9898;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class=\"hljs-keyword\">false</span>);</span><br></pre></td></tr></tbody></table></figure></body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Spring Boot","path":"tags/Spring-Boot/"}],"excerpt":"<html><head></head><body><p>&#x6587;&#x4EF6;&#x4E0A;&#x4F20;&#x4E0B;&#x8F7D;&#x65F6;&#x51FA;&#x73B0;&#x4EE5;&#x4E0B;&#x9519;&#x8BEF;&#xFF1A;</p>\n<p><img src=\"/2019/09/24/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%B1%E8%B4%A5%E5%AF%BC%E8%87%B4%E7%9A%84%E7%94%9F%E4%BA%A7%E9%97%AE%E9%A2%98/wenti.png\" alt=\"01\"></p></body></html>","more":"<p>经过调查,由于重写了WebMvcConfigurationSupport.configureMessageConverters方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Configuration</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">OpenServiceConfig</span> <span class=\"keyword\">extends</span> <span class=\"title\">WebMvcConfigurationSupport</span> <span class=\"keyword\">implements</span> <span class=\"title\">ApplicationRunner</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Environment environment;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ApiMappingHandlerMapping apiMappingHandlerMapping = <span class=\"keyword\">new</span> ApiMappingHandlerMapping();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> RequestMappingHandlerMapping <span class=\"title\">createRequestMappingHandlerMapping</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> apiMappingHandlerMapping;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">(ApplicationArguments args)</span> </span>&#123;</span><br><span class=\"line\">        ApiMetaManager apiMetaManager = <span class=\"keyword\">new</span> ServiceZookeeperApiMetaManager(environment);</span><br><span class=\"line\">        RequestMappingEvent requestMappingEvent = <span class=\"keyword\">new</span> DefaultRequestMappingEvent(apiMetaManager, environment);</span><br><span class=\"line\">        requestMappingEvent.onRegisterSuccess(apiMappingHandlerMapping);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">configureMessageConverters</span><span class=\"params\">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>&#123;</span><br><span class=\"line\">        converters.clear();</span><br><span class=\"line\">        ObjectMapper objectMapper = <span class=\"keyword\">new</span> ObjectMapper().setSerializationInclusion(JsonInclude.Include.NON_NULL);</span><br><span class=\"line\">        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES,<span class=\"keyword\">false</span>);</span><br><span class=\"line\">        converters.add(<span class=\"keyword\">new</span> MappingJackson2HttpMessageConverter(objectMapper));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">addResourceHandlers</span><span class=\"params\">(ResourceHandlerRegistry registry)</span> </span>&#123;</span><br><span class=\"line\">        registry.addResourceHandler(<span class=\"string\">&quot;swagger-ui.html&quot;</span>)</span><br><span class=\"line\">                .addResourceLocations(<span class=\"string\">&quot;classpath:/META-INF/resources/&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        registry.addResourceHandler(<span class=\"string\">&quot;/webjars/**&quot;</span>)</span><br><span class=\"line\">                .addResourceLocations(<span class=\"string\">&quot;classpath:/META-INF/resources/webjars/&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>springMVC开始加载转换器的时候会先走用户定制化方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> List&lt;HttpMessageConverter&lt;?&gt;&gt; getMessageConverters() &#123;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.messageConverters == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">this</span>.messageConverters = <span class=\"keyword\">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;();</span><br><span class=\"line\">\t\tconfigureMessageConverters(<span class=\"keyword\">this</span>.messageConverters);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (<span class=\"keyword\">this</span>.messageConverters.isEmpty()) &#123;</span><br><span class=\"line\">\t\t\taddDefaultHttpMessageConverters(<span class=\"keyword\">this</span>.messageConverters);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\textendMessageConverters(<span class=\"keyword\">this</span>.messageConverters);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"keyword\">this</span>.messageConverters;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>如果用户没有定制化，springmvc会使用自定个的7个转换器</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> <span class=\"keyword\">void</span> <span class=\"title\">addDefaultHttpMessageConverters</span><span class=\"params\">(List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters)</span> </span>&#123;</span><br><span class=\"line\">\tStringHttpMessageConverter stringConverter = <span class=\"keyword\">new</span> StringHttpMessageConverter();</span><br><span class=\"line\">\tstringConverter.setWriteAcceptCharset(<span class=\"keyword\">false</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\tmessageConverters.add(<span class=\"keyword\">new</span> ByteArrayHttpMessageConverter());</span><br><span class=\"line\">\tmessageConverters.add(stringConverter);</span><br><span class=\"line\">\tmessageConverters.add(<span class=\"keyword\">new</span> ResourceHttpMessageConverter());</span><br><span class=\"line\">\tmessageConverters.add(<span class=\"keyword\">new</span> SourceHttpMessageConverter&lt;Source&gt;());</span><br><span class=\"line\">\tmessageConverters.add(<span class=\"keyword\">new</span> AllEncompassingFormHttpMessageConverter());</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (romePresent) &#123;</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"keyword\">new</span> AtomFeedHttpMessageConverter());</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"keyword\">new</span> RssChannelHttpMessageConverter());</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (jackson2XmlPresent) &#123;</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"keyword\">new</span> MappingJackson2XmlHttpMessageConverter(</span><br><span class=\"line\">\t\t\t\tJackson2ObjectMapperBuilder.xml().applicationContext(<span class=\"keyword\">this</span>.applicationContext).build()));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (jaxb2Present) &#123;</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"keyword\">new</span> Jaxb2RootElementHttpMessageConverter());</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (jackson2Present) &#123;</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"keyword\">new</span> MappingJackson2HttpMessageConverter(</span><br><span class=\"line\">\t\t\t\tJackson2ObjectMapperBuilder.json().applicationContext(<span class=\"keyword\">this</span>.applicationContext).build()));</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (gsonPresent) &#123;</span><br><span class=\"line\">\t\tmessageConverters.add(<span class=\"keyword\">new</span> GsonHttpMessageConverter());</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>由于项目在自定义的时候没有考虑到文件上传下载这种字节流的解析，导致序列化失败<br>增加配置解决问题</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class=\"keyword\">false</span>);</span><br></pre></td></tr></table></figure>"},{"title":"🐇","date":"2019-09-05T05:19:02.000Z","_content":"\n大白兔。。你变了。。。\n\n![01](🐇/牌子.jpeg)\n<!-- more -->\n\n![02](🐇/全景.jpeg)","source":"_posts/🐇.md","raw":"---\ntitle: \"\\U0001F407\"\ndate: 2019-09-05 13:19:02\ntags: \n    - Food\ncategories :\n    - Life\n---\n\n大白兔。。你变了。。。\n\n![01](🐇/牌子.jpeg)\n<!-- more -->\n\n![02](🐇/全景.jpeg)","slug":"🐇","published":1,"updated":"2020-12-14T10:17:56.593Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71htz0023v2523flh1jar","content":"<html><head></head><body><p>&#x5927;&#x767D;&#x5154;&#x3002;&#x3002;&#x4F60;&#x53D8;&#x4E86;&#x3002;&#x3002;&#x3002;</p>\n<p><img src=\"/2019/09/05/%F0%9F%90%87/%E7%89%8C%E5%AD%90.jpeg\" alt=\"01\"></p>\n<a id=\"more\"></a>\n\n<p><img src=\"/2019/09/05/%F0%9F%90%87/%E5%85%A8%E6%99%AF.jpeg\" alt=\"02\"></p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Life","path":"categories/Life/"}],"_tags":[{"name":"Food","path":"tags/Food/"}],"excerpt":"<html><head></head><body><p>&#x5927;&#x767D;&#x5154;&#x3002;&#x3002;&#x4F60;&#x53D8;&#x4E86;&#x3002;&#x3002;&#x3002;</p>\n<p><img src=\"/2019/09/05/%F0%9F%90%87/%E7%89%8C%E5%AD%90.jpeg\" alt=\"01\"></p></body></html>","more":"<p><img src=\"/2019/09/05/%F0%9F%90%87/%E5%85%A8%E6%99%AF.jpeg\" alt=\"02\"></p>"},{"title":"fastjson序列化异常排查","date":"2020-08-17T02:43:05.000Z","_content":"\nfastjson作为一个轻量级的java序列化类库，其最大的优势就是快，因此也被国内各个中小型公司大量的使用。但它也有不少短板，如可定制性低、API不够丰富、代码质量及文档缺失等一些列问题一直被人所诟病。\n\n本次我们碰到的问题就是由fastjson的一个简单bug而引起的一连串研究。\n<!-- more -->\n## 发现bug\n某日一位同学在调试新需求的时候发现如下错误日志：\n``` java\nException in thread \"collection-eventbus-thread-1\" java.lang.NoSuchMethodError: com.alibaba.fastjson.serializer.JavaBeanSerializer.processValue(Lcom/alibaba/fastjson/serializer/JSONSerializer;Lcom/alibaba/fastjson/serializer/BeanContext;Ljava/lang/Object;Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;Ljava/lang/Integer;\n\tat com.alibaba.fastjson.serializer.ASMSerializer_6_FastJsonSerializerWrapper.writeNormal(Unknown Source)\n\tat com.alibaba.fastjson.serializer.ASMSerializer_6_FastJsonSerializerWrapper.write(Unknown Source)\n\tat com.alibaba.fastjson.serializer.JSONSerializer.write(JSONSerializer.java:285)\n\tat com.alibaba.fastjson.JSON.toJSONString(JSON.java:663)\n\tat com.alibaba.fastjson.JSON.toJSONString(JSON.java:652)\n\tat com.oriente.cache.layeringCache.serializer.FastJsonRedisSerializer.serialize(FastJsonRedisSerializer.java:37)\n\tat org.springframework.data.redis.core.AbstractOperations.rawValue(AbstractOperations.java:117)\n\tat org.springframework.data.redis.core.DefaultValueOperations.multiSet(DefaultValueOperations.java:136)\n\tat com.oriente.collection.event.listener.RedisEventListener.schedule(RedisEventListener.java:75)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat com.google.common.eventbus.Subscriber.invokeSubscriberMethod(Subscriber.java:87)\n\tat com.google.common.eventbus.Subscriber$SynchronizedSubscriber.invokeSubscriberMethod(Subscriber.java:144)\n\tat com.google.common.eventbus.Subscriber$1.run(Subscriber.java:72)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:748)\n```\n\n通过观察错误，很快就能定位到是fastjson序列化的时候出现了错误。同时我们也确认的代码，在自定的RedisTemplate中，针对Value的序列化工具我们的确使用了fastjson的序列化方式。\n\n- RedisTemplate使用自定义的fastjoson序列化工具\n``` java\n        FastJsonRedisSerializer<Object> fastJsonRedisSerializer = new FastJsonRedisSerializer<>(Object.class);\n\n        redisTemplate.setValueSerializer(fastJsonRedisSerializer);\n```\n\n- FastJsonRedisSerializer中使用fastjson的API对统一包装类进行序列化\n``` java\n    @Override\n    public byte[] serialize(T t) throws SerializationException {\n        try {\n            return JSON.toJSONString(new FastJsonSerializerWrapper(t), SerializerFeature.WriteClassName).getBytes(DEFAULT_CHARSET);\n        } catch (Exception e) {\n            throw new SerializationException(String.format(\"FastJsonRedisSerializer 序列化异常: %s, 【JSON：%s】\",\n                    e.getMessage(), JSON.toJSONString(t)), e);\n\n        }\n    }\n```\n\n## 分析bug\n经过上面的一顿排查，问题已经很明确定位到是fastjson上了，并且错误信息给的相当明确：\n\n  <font color=red> ` java.lang.NoSuchMethodError: com.alibaba.fastjson.serializer.JavaBeanSerializer.processValue(Lcom/alibaba/fastjson/serializer/JSONSerializer;Lcom/alibaba/fastjson/serializer/BeanContext;Ljava/lang/Object;Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;Ljava/lang/Integer; ` </font>\n\n提示未找到JavaBeanSerializer.processValue方法。ok我们立马查询JavaBeanSerializer源码，发现processalue方法是继承自SerializeFilterable类：\n> 方法清单：com.alibaba.fastjson.serializer.JavaBeanSerializer\n``` java\n    protected Object processValue(JSONSerializer jsonBeanDeser, //\n                               BeanContext beanContext,\n                               Object object, //\n                               String key, //\n                               Object propertyValue, //\n                               int features) {\n```\n\n乍一看方法是存在的，这是我们又回到了错误本身。仔细查看错误，错误中提示我们processValue方法签名如下：\n\n入参：\n1. Lcom/alibaba/fastjson/serializer/JSONSerializer <font color=green>--JSONSerializer类型的对象</font>\n2. Lcom/alibaba/fastjson/serializer/BeanContext <font color=green>--BeanContext类型的对象</font>\n3. Ljava/lang/Object <font color=green>--Object对象</font>\n4. Ljava/lang/String <font color=green>--String 类型</font>\n5. Ljava/lang/Object <font color=green>--Object对象</font>\n\n返回参数：\n1. Ljava/lang/Object;Ljava/lang/Integer; <font color=green>--这是什么鬼？java的返回参数应该是不支持两个才对啊！</font>\n\n经过对比，果然方法签名不一致。源码中SerializeFilterable.processValue()方法中有6个入参，而错误日志中提示的只有5个入参。缺少了最后一个 <font color=blue> int features</font>\n\n#### 问题1\n从方法签名的对比我们可以发现，该错误的确是因为找不对对应的方法所导致的。由于fastjson序列化的对象是通过ASM动态生成字节码产生的，我们可以通多源码或者借助工具来验证这个bug的真实性。\n##### 1.代码验证\nfastjson在java平台下会默认使用ASM的方式动态生成序列化代理类\n> 方法清单：com.alibaba.fastjson.serializer.SerializeConfig\n``` java\nprivate boolean                                       asm             = !ASMUtils.IS_ANDROID;\n```\n> 方法清单：com.alibaba.fastjson.serializer.SerializeConfig\n``` java\nif (asm) {\n    try {\n        ObjectSerializer asmSerializer = createASMSerializer(beanInfo);\n        if (asmSerializer != null) {\n            return asmSerializer;\n        }\n    } catch (ClassNotFoundException ex) {\n        // skip\n    } catch (ClassFormatError e) {\n        // skip\n    } catch (ClassCastException e) {\n        // skip\n    } catch (OutOfMemoryError e) {\n        if (e.getMessage().indexOf(\"Metaspace\") != -1) {\n            throw e;\n        }\n        // skip\n    } catch (Throwable e) {\n        throw new JSONException(\"create asm serializer error, verson \" + JSON.VERSION + \", class \" + clazz, e);\n    }\n}\n```\n\n> 方法清单：com.alibaba.fastjson.serializer.ASMSerializerFactory\n``` java\nprivate void _processValue(MethodVisitor mw, FieldInfo fieldInfo, Context context, Label _end) {\n...\n        mw.visitMethodInsn(INVOKEVIRTUAL, JavaBeanSerializer, \"processValue\",\n                           \"(L\" + JSONSerializer  + \";\" //\n                                                                          + desc(BeanContext.class) //\n                                                                          + \"Ljava/lang/Object;Ljava/lang/String;\" //\n                                                                          + valueDesc + \")Ljava/lang/Object;Ljava/lang/Integer;\");\n\n                                                                          ...\n}\n```\n通过上述源码，可以发现在通过ASM生成processValue方法签名时，只定义了5个参数。同时也能看到返回参数多设置了个Ljava/lang/Integer类型。\n\n依赖代码阅读，我们已经可以确定错误代码的位置了。但由于毕竟是通过ASM动态字节码生成的类和对象，实际在JVM中的类是否也像我们现在看到的一样的话，我们就需要借助其他工具来帮助我们观察了。\n\n##### 2.通过HSDB观察JVM中的类\n* 已Debug模式启动Java服务\n* 将断点设置到代理类生产逻辑后\n> 方法清单：com.alibaba.fastjson.serializer.ASMSerializerFactory\n``` java\n//将动态生成的字节码对象装维字节数组\nbyte[] code = cw.toByteArray();\n//动态加载类\nClass<?> serializerClass = classLoader.defineClassPublic(classNameFull, code, 0, code.length);\n```\n\n![01](fastjson序列化异常排查/classload断点.png)\n\n* 打开HSDB\n``` shell\njava -cp sa-jdi.jar sun.jvm.hotspot.HSDB\n```\n\n* 获取当前java进程\n\n![02](fastjson序列化异常排查/jps.png)\n\n* HSDB attach当前java进程\n\n![03](fastjson序列化异常排查/hdbs_attach.png)\n\n\n* 执行方法至断点处后，在HSDB搜索代理类\n\n![04](fastjson序列化异常排查/class_browser.png)\n\n通过观察FastJsonSerializerWrapper.writeNormal()方法的字节码也可以发现，在调用processValue()方法的时候缺少了一个参数。\n\n* 查看FastJsonSerializerWrapper的常量池\n\n![05](fastjson序列化异常排查/constantpool.png)\n\n查看常量池中的内容，也再次确认了processValue()方法的签名存在问题：入参不对、返回参数也有问题。\n\n\n\n#### 问题2\nASMSerializer_6_FastJsonSerializerWrapper.processValue()方法的返回值有两个。这会带来什么问题？为什么在类动态加载的时候JVM没有检查出方法签名的问题?\n\n预知大道，必先为史。java也一样，java的历史就是JVM。要想了解动态加载类的时候到底做了什么，我们就必须参阅JVM源码。\n\n之前阅读fastjson源码的时候，我们曾经来到这么一段代码。\n\n![06](fastjson序列化异常排查/classload断点.png)\n\n显然源码是通过调用native方法，将类的字节流写入到JVM中的。jdk为开发者提供了丰富的类加载机制，但究其源还是依赖了这三个native方法，并且这三个方法仅仅是入参不同，其背后的实现原理其实是一样的。\n> 方法清单：java.lang.ClassLoader\n``` java\n    private native Class<?> defineClass0(String name, byte[] b, int off, int len,\n                                         ProtectionDomain pd);\n\n    private native Class<?> defineClass1(String name, byte[] b, int off, int len,\n                                         ProtectionDomain pd, String source);\n\n    private native Class<?> defineClass2(String name, java.nio.ByteBuffer b,\n                                         int off, int len, ProtectionDomain pd,\n                                         String source);\n```\n\n###### java native 方法入口\n按照jni的定义规范，native方法会按照以下的格式进行定义：\n__JNIEXPORT jclass JNICALL Java_packagepath(包路径已_分割)_方法名__\n\n根据上面的规定，我们很快就能还原出defineClass1方法在jdk中的定义：\n<font color=blue> JNIEXPORT jclass JNICALL Java_java_lang_ClassLoader_defineClass1</font>\n\n>代码清单：src/share/native/java/lang/ClassLoader.c\n``` C++\nJNIEXPORT jclass JNICALL\nJava_java_lang_ClassLoader_defineClass1(JNIEnv *env,\n                                        jobject loader,\n                                        jstring name,\n                                        jbyteArray data,\n                                        jint offset,\n                                        jint length,\n                                        jobject pd,\n                                        jstring source)\n{\n    jbyte *body;\n    char *utfName;\n    jclass result = 0;\n    char buf[128];\n    char* utfSource;\n    char sourceBuf[1024];\n\n    if (data == NULL) {\n        JNU_ThrowNullPointerException(env, 0);\n        return 0;\n    }\n\n    /* Work around 4153825. malloc crashes on Solaris when passed a\n     * negative size.\n     */\n    if (length < 0) {\n        JNU_ThrowArrayIndexOutOfBoundsException(env, 0);\n        return 0;\n    }\n\n    body = (jbyte *)malloc(length);\n\n    if (body == 0) {\n        JNU_ThrowOutOfMemoryError(env, 0);\n        return 0;\n    }\n\n    (*env)->GetByteArrayRegion(env, data, offset, length, body);\n\n    if ((*env)->ExceptionOccurred(env))\n        goto free_body;\n\n    if (name != NULL) {\n        utfName = getUTF(env, name, buf, sizeof(buf));\n        if (utfName == NULL) {\n            JNU_ThrowOutOfMemoryError(env, NULL);\n            goto free_body;\n        }\n        VerifyFixClassname(utfName);\n    } else {\n        utfName = NULL;\n    }\n\n    if (source != NULL) {\n        utfSource = getUTF(env, source, sourceBuf, sizeof(sourceBuf));\n        if (utfSource == NULL) {\n            JNU_ThrowOutOfMemoryError(env, NULL);\n            goto free_utfName;\n        }\n    } else {\n        utfSource = NULL;\n    }\n    result = JVM_DefineClassWithSource(env, utfName, loader, body, length, pd, utfSource);\n\n    if (utfSource && utfSource != sourceBuf)\n        free(utfSource);\n\n free_utfName:\n    if (utfName && utfName != buf)\n        free(utfName);\n\n free_body:\n    free(body);\n    return result;\n}\n```\n\n代码中调用了JVM_DefineClassWithSource方法，该方法定义在JVM源码中，下载JVM源码搜索该方法。\n> 代码清单：src/share/vm/prims/jvm.cpp\n``` C++\nJVM_ENTRY(jclass, JVM_DefineClassWithSource(JNIEnv *env, const char *name, jobject loader, const jbyte *buf, jsize len, jobject pd, const char *source))\n  JVMWrapper2(\"JVM_DefineClassWithSource %s\", name);\n\n  return jvm_define_class_common(env, name, loader, buf, len, pd, source, true, THREAD);\nJVM_END\n```\n经过一连串的内部调用,JVM才开始真正解析字节码流：\n> src/share/vm/prims/jvm.cpp --> JVM_DefineClassWithSource()\n>> src/share/vm/prims/jvm.cpp --> jvm_define_class_common()\n>>> src/share/vm/classfile/systemDictionary.cpp --> Klass* SystemDictionary::resolve_from_stream()\n>>>> src/share/vm/classfile/classFileParser.cpp --> instanceKlassHandle ClassFileParser::parseClassFile()\n\n\nJVM首先会判断是否需要进行格式校验\n> 代码清单：src/share/vm/classfile/classFileParser.cpp\n``` C++\n  // Figure out whether we can skip format checking (matching classic VM behavior)\n  if (DumpSharedSpaces) {\n    // verify == true means it's a 'remote' class (i.e., non-boot class)\n    // Verification decision is based on BytecodeVerificationRemote flag\n    // for those classes.\n    _need_verify = (verify) ? BytecodeVerificationRemote :\n                              BytecodeVerificationLocal;\n  } else {\n    _need_verify = Verifier::should_verify_for(class_loader(), verify);\n  }\n```\nDumpSharedSpaces默认为false，因此会走到下面的分支\n\n> 代码清单：src/share/vm/classfile/verifier.cpp\n``` C++\nbool Verifier::should_verify_for(oop class_loader, bool should_verify_class) {\n  return (class_loader == NULL || !should_verify_class) ?\n    BytecodeVerificationLocal : BytecodeVerificationRemote;\n}\n```\n\n当前class_loader为当前classLoad，并且should_verify_class在调用jvm_define_class_common方法时传值true\n> 代码清单：src/share/vm/prims/jvm.cpp\n``` C++\nJVM_ENTRY(jclass, JVM_DefineClassWithSource(JNIEnv *env, const char *name, jobject loader, const jbyte *buf, jsize len, jobject pd, const char *source))\n  JVMWrapper2(\"JVM_DefineClassWithSource %s\", name);\n\n  return jvm_define_class_common(env, name, loader, buf, len, pd, source, true, THREAD);\nJVM_END\n```\n\n因此判断_need_verify的结果最终落到了BytecodeVerificationRemote上。\n\n我们先看BytecodeVerificationRemote在jvm里的定义：\n> 代码清单：src/share/vm/runtime/globals.hpp\n``` C++\n  product(bool, BytecodeVerificationRemote, true,                           \\\n          \"Enable the Java bytecode verifier for remote classes\")           \\\n```\n可见BytecodeVerificationRemote在JVM初始化的时候默认值为true，代表非JVM自己的对象在加载的时候需要进行各种校验。\n\n为了证明这点，我们再看看解析方法时具体的逻辑：\n> 代码清单：src/share/vm/classfile/classFileParser.cpp --> methodHandle ClassFileParser::parse_method()\n``` C++\n  if (_need_verify) {\n    args_size = ((flags & JVM_ACC_STATIC) ? 0 : 1) +\n                 verify_legal_method_signature(name, signature, CHECK_(nullHandle));\n    if (args_size > MAX_ARGS_SIZE) {\n      classfile_parse_error(\"Too many arguments in method signature in class file %s\", CHECK_(nullHandle));\n    }\n  }\n```\n\nJVM在解析方法的逻辑中，会先对方法的合法性做各种校验。其中就有对方法签名的校验。如果_need_verify为false，则改校验会被跳过。\n\n通过上面的一连串的代码分析，我们得到了BytecodeVerificationRemote的值最终会影响Fastjson通过ASM动态字节码生成的类文件的解析。\n\n接下来我们搞明白BytecodeVerificationRemote的值是如何被更改的，老样子代码一顿乱搜：\n> 代码清单：src/share/vm/runtime/arguments.cpp --> jint Arguments::parse_each_vm_init_arg\n``` C++\n// -Xverify\n    } else if (match_option(option, \"-Xverify\", &tail)) {\n      if (strcmp(tail, \":all\") == 0 || strcmp(tail, \"\") == 0) {\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, true);\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, true);\n      } else if (strcmp(tail, \":remote\") == 0) {\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, false);\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, true);\n      } else if (strcmp(tail, \":none\") == 0) {\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, false);\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, false);\n      } else if (is_bad_option(option, args->ignoreUnrecognized, \"verification\")) {\n        return JNI_EINVAL;\n      }\n```\n\n| Xverify | BytecodeVerificationLocal | BytecodeVerificationRemote |\n| ------ | ------ | ------ |\n| all 或 不传 | true | true |\n| remote | false | true |\n| none | false | false |\n\n顺着这个思路我们再看看服务启动时的参数。由于是采用IDEA启动的springboot项目，我们没有手动指定各种启动参数。老样子我们还是借助其他工具进行查看。这次我们使用jdk自带的VisualVM。\n\n![07](fastjson序列化异常排查/visualVM.png)\n\n\n这回事真相大白了，通过IDEA默认启动springboot项目时，会默认带上<font color=red>-Xverify:none</font>参数。结合我们上面对JVM源码的分析，在Xverify==none时。加载类模板时不会对类结构的合法性进行校验，这也最终导致了为什么方法签名明明不正确，但是JVM还是成功的加载了这个类。\n\n至于为什么IDEA启动的时候会带上<font color=red>-Xverify:none</font>参数，我们可以参考官网的一句话。\n> https://www.jetbrains.com/help/idea/run-debug-configuration-spring-boot.html#configuration-tab\n\n![08](fastjson序列化异常排查/idea.png)\n\n## 总结\n至此，整个fastjson序列化引起的异常已经排查完了。\n\n回顾整个排查过程其实这一个错误引出了两个问题。\n* 第一个问题是fastjson通过ASM生成字节码文件的时候，processValue的参数个数不对。fastjson官方在后续版本中增加了processValue的重载方法，从而修复这个问题。\n* 第二个问题是processValue方法的方法签名不正确，方法返回类型写有两个参数。从而引起对JVM解析类时，方法签名合法性校验机制的研究。官方也在后续版本中修正了方法签名的错误。\n\n以上，虽然这次问题的发现和解决都很简单。但是牵扯出了一部分JVM源码的知识，借由这次机会，加深相关知识。\n\n","source":"_posts/fastjson序列化异常排查.md","raw":"---\ntitle: fastjson序列化异常排查\ndate: 2020-08-17 10:43:05\ntags: \n    - Java\n    - fastjson\n    - ASM\ncategories :\n    - Technology\n---\n\nfastjson作为一个轻量级的java序列化类库，其最大的优势就是快，因此也被国内各个中小型公司大量的使用。但它也有不少短板，如可定制性低、API不够丰富、代码质量及文档缺失等一些列问题一直被人所诟病。\n\n本次我们碰到的问题就是由fastjson的一个简单bug而引起的一连串研究。\n<!-- more -->\n## 发现bug\n某日一位同学在调试新需求的时候发现如下错误日志：\n``` java\nException in thread \"collection-eventbus-thread-1\" java.lang.NoSuchMethodError: com.alibaba.fastjson.serializer.JavaBeanSerializer.processValue(Lcom/alibaba/fastjson/serializer/JSONSerializer;Lcom/alibaba/fastjson/serializer/BeanContext;Ljava/lang/Object;Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;Ljava/lang/Integer;\n\tat com.alibaba.fastjson.serializer.ASMSerializer_6_FastJsonSerializerWrapper.writeNormal(Unknown Source)\n\tat com.alibaba.fastjson.serializer.ASMSerializer_6_FastJsonSerializerWrapper.write(Unknown Source)\n\tat com.alibaba.fastjson.serializer.JSONSerializer.write(JSONSerializer.java:285)\n\tat com.alibaba.fastjson.JSON.toJSONString(JSON.java:663)\n\tat com.alibaba.fastjson.JSON.toJSONString(JSON.java:652)\n\tat com.oriente.cache.layeringCache.serializer.FastJsonRedisSerializer.serialize(FastJsonRedisSerializer.java:37)\n\tat org.springframework.data.redis.core.AbstractOperations.rawValue(AbstractOperations.java:117)\n\tat org.springframework.data.redis.core.DefaultValueOperations.multiSet(DefaultValueOperations.java:136)\n\tat com.oriente.collection.event.listener.RedisEventListener.schedule(RedisEventListener.java:75)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat com.google.common.eventbus.Subscriber.invokeSubscriberMethod(Subscriber.java:87)\n\tat com.google.common.eventbus.Subscriber$SynchronizedSubscriber.invokeSubscriberMethod(Subscriber.java:144)\n\tat com.google.common.eventbus.Subscriber$1.run(Subscriber.java:72)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\n\tat java.lang.Thread.run(Thread.java:748)\n```\n\n通过观察错误，很快就能定位到是fastjson序列化的时候出现了错误。同时我们也确认的代码，在自定的RedisTemplate中，针对Value的序列化工具我们的确使用了fastjson的序列化方式。\n\n- RedisTemplate使用自定义的fastjoson序列化工具\n``` java\n        FastJsonRedisSerializer<Object> fastJsonRedisSerializer = new FastJsonRedisSerializer<>(Object.class);\n\n        redisTemplate.setValueSerializer(fastJsonRedisSerializer);\n```\n\n- FastJsonRedisSerializer中使用fastjson的API对统一包装类进行序列化\n``` java\n    @Override\n    public byte[] serialize(T t) throws SerializationException {\n        try {\n            return JSON.toJSONString(new FastJsonSerializerWrapper(t), SerializerFeature.WriteClassName).getBytes(DEFAULT_CHARSET);\n        } catch (Exception e) {\n            throw new SerializationException(String.format(\"FastJsonRedisSerializer 序列化异常: %s, 【JSON：%s】\",\n                    e.getMessage(), JSON.toJSONString(t)), e);\n\n        }\n    }\n```\n\n## 分析bug\n经过上面的一顿排查，问题已经很明确定位到是fastjson上了，并且错误信息给的相当明确：\n\n  <font color=red> ` java.lang.NoSuchMethodError: com.alibaba.fastjson.serializer.JavaBeanSerializer.processValue(Lcom/alibaba/fastjson/serializer/JSONSerializer;Lcom/alibaba/fastjson/serializer/BeanContext;Ljava/lang/Object;Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;Ljava/lang/Integer; ` </font>\n\n提示未找到JavaBeanSerializer.processValue方法。ok我们立马查询JavaBeanSerializer源码，发现processalue方法是继承自SerializeFilterable类：\n> 方法清单：com.alibaba.fastjson.serializer.JavaBeanSerializer\n``` java\n    protected Object processValue(JSONSerializer jsonBeanDeser, //\n                               BeanContext beanContext,\n                               Object object, //\n                               String key, //\n                               Object propertyValue, //\n                               int features) {\n```\n\n乍一看方法是存在的，这是我们又回到了错误本身。仔细查看错误，错误中提示我们processValue方法签名如下：\n\n入参：\n1. Lcom/alibaba/fastjson/serializer/JSONSerializer <font color=green>--JSONSerializer类型的对象</font>\n2. Lcom/alibaba/fastjson/serializer/BeanContext <font color=green>--BeanContext类型的对象</font>\n3. Ljava/lang/Object <font color=green>--Object对象</font>\n4. Ljava/lang/String <font color=green>--String 类型</font>\n5. Ljava/lang/Object <font color=green>--Object对象</font>\n\n返回参数：\n1. Ljava/lang/Object;Ljava/lang/Integer; <font color=green>--这是什么鬼？java的返回参数应该是不支持两个才对啊！</font>\n\n经过对比，果然方法签名不一致。源码中SerializeFilterable.processValue()方法中有6个入参，而错误日志中提示的只有5个入参。缺少了最后一个 <font color=blue> int features</font>\n\n#### 问题1\n从方法签名的对比我们可以发现，该错误的确是因为找不对对应的方法所导致的。由于fastjson序列化的对象是通过ASM动态生成字节码产生的，我们可以通多源码或者借助工具来验证这个bug的真实性。\n##### 1.代码验证\nfastjson在java平台下会默认使用ASM的方式动态生成序列化代理类\n> 方法清单：com.alibaba.fastjson.serializer.SerializeConfig\n``` java\nprivate boolean                                       asm             = !ASMUtils.IS_ANDROID;\n```\n> 方法清单：com.alibaba.fastjson.serializer.SerializeConfig\n``` java\nif (asm) {\n    try {\n        ObjectSerializer asmSerializer = createASMSerializer(beanInfo);\n        if (asmSerializer != null) {\n            return asmSerializer;\n        }\n    } catch (ClassNotFoundException ex) {\n        // skip\n    } catch (ClassFormatError e) {\n        // skip\n    } catch (ClassCastException e) {\n        // skip\n    } catch (OutOfMemoryError e) {\n        if (e.getMessage().indexOf(\"Metaspace\") != -1) {\n            throw e;\n        }\n        // skip\n    } catch (Throwable e) {\n        throw new JSONException(\"create asm serializer error, verson \" + JSON.VERSION + \", class \" + clazz, e);\n    }\n}\n```\n\n> 方法清单：com.alibaba.fastjson.serializer.ASMSerializerFactory\n``` java\nprivate void _processValue(MethodVisitor mw, FieldInfo fieldInfo, Context context, Label _end) {\n...\n        mw.visitMethodInsn(INVOKEVIRTUAL, JavaBeanSerializer, \"processValue\",\n                           \"(L\" + JSONSerializer  + \";\" //\n                                                                          + desc(BeanContext.class) //\n                                                                          + \"Ljava/lang/Object;Ljava/lang/String;\" //\n                                                                          + valueDesc + \")Ljava/lang/Object;Ljava/lang/Integer;\");\n\n                                                                          ...\n}\n```\n通过上述源码，可以发现在通过ASM生成processValue方法签名时，只定义了5个参数。同时也能看到返回参数多设置了个Ljava/lang/Integer类型。\n\n依赖代码阅读，我们已经可以确定错误代码的位置了。但由于毕竟是通过ASM动态字节码生成的类和对象，实际在JVM中的类是否也像我们现在看到的一样的话，我们就需要借助其他工具来帮助我们观察了。\n\n##### 2.通过HSDB观察JVM中的类\n* 已Debug模式启动Java服务\n* 将断点设置到代理类生产逻辑后\n> 方法清单：com.alibaba.fastjson.serializer.ASMSerializerFactory\n``` java\n//将动态生成的字节码对象装维字节数组\nbyte[] code = cw.toByteArray();\n//动态加载类\nClass<?> serializerClass = classLoader.defineClassPublic(classNameFull, code, 0, code.length);\n```\n\n![01](fastjson序列化异常排查/classload断点.png)\n\n* 打开HSDB\n``` shell\njava -cp sa-jdi.jar sun.jvm.hotspot.HSDB\n```\n\n* 获取当前java进程\n\n![02](fastjson序列化异常排查/jps.png)\n\n* HSDB attach当前java进程\n\n![03](fastjson序列化异常排查/hdbs_attach.png)\n\n\n* 执行方法至断点处后，在HSDB搜索代理类\n\n![04](fastjson序列化异常排查/class_browser.png)\n\n通过观察FastJsonSerializerWrapper.writeNormal()方法的字节码也可以发现，在调用processValue()方法的时候缺少了一个参数。\n\n* 查看FastJsonSerializerWrapper的常量池\n\n![05](fastjson序列化异常排查/constantpool.png)\n\n查看常量池中的内容，也再次确认了processValue()方法的签名存在问题：入参不对、返回参数也有问题。\n\n\n\n#### 问题2\nASMSerializer_6_FastJsonSerializerWrapper.processValue()方法的返回值有两个。这会带来什么问题？为什么在类动态加载的时候JVM没有检查出方法签名的问题?\n\n预知大道，必先为史。java也一样，java的历史就是JVM。要想了解动态加载类的时候到底做了什么，我们就必须参阅JVM源码。\n\n之前阅读fastjson源码的时候，我们曾经来到这么一段代码。\n\n![06](fastjson序列化异常排查/classload断点.png)\n\n显然源码是通过调用native方法，将类的字节流写入到JVM中的。jdk为开发者提供了丰富的类加载机制，但究其源还是依赖了这三个native方法，并且这三个方法仅仅是入参不同，其背后的实现原理其实是一样的。\n> 方法清单：java.lang.ClassLoader\n``` java\n    private native Class<?> defineClass0(String name, byte[] b, int off, int len,\n                                         ProtectionDomain pd);\n\n    private native Class<?> defineClass1(String name, byte[] b, int off, int len,\n                                         ProtectionDomain pd, String source);\n\n    private native Class<?> defineClass2(String name, java.nio.ByteBuffer b,\n                                         int off, int len, ProtectionDomain pd,\n                                         String source);\n```\n\n###### java native 方法入口\n按照jni的定义规范，native方法会按照以下的格式进行定义：\n__JNIEXPORT jclass JNICALL Java_packagepath(包路径已_分割)_方法名__\n\n根据上面的规定，我们很快就能还原出defineClass1方法在jdk中的定义：\n<font color=blue> JNIEXPORT jclass JNICALL Java_java_lang_ClassLoader_defineClass1</font>\n\n>代码清单：src/share/native/java/lang/ClassLoader.c\n``` C++\nJNIEXPORT jclass JNICALL\nJava_java_lang_ClassLoader_defineClass1(JNIEnv *env,\n                                        jobject loader,\n                                        jstring name,\n                                        jbyteArray data,\n                                        jint offset,\n                                        jint length,\n                                        jobject pd,\n                                        jstring source)\n{\n    jbyte *body;\n    char *utfName;\n    jclass result = 0;\n    char buf[128];\n    char* utfSource;\n    char sourceBuf[1024];\n\n    if (data == NULL) {\n        JNU_ThrowNullPointerException(env, 0);\n        return 0;\n    }\n\n    /* Work around 4153825. malloc crashes on Solaris when passed a\n     * negative size.\n     */\n    if (length < 0) {\n        JNU_ThrowArrayIndexOutOfBoundsException(env, 0);\n        return 0;\n    }\n\n    body = (jbyte *)malloc(length);\n\n    if (body == 0) {\n        JNU_ThrowOutOfMemoryError(env, 0);\n        return 0;\n    }\n\n    (*env)->GetByteArrayRegion(env, data, offset, length, body);\n\n    if ((*env)->ExceptionOccurred(env))\n        goto free_body;\n\n    if (name != NULL) {\n        utfName = getUTF(env, name, buf, sizeof(buf));\n        if (utfName == NULL) {\n            JNU_ThrowOutOfMemoryError(env, NULL);\n            goto free_body;\n        }\n        VerifyFixClassname(utfName);\n    } else {\n        utfName = NULL;\n    }\n\n    if (source != NULL) {\n        utfSource = getUTF(env, source, sourceBuf, sizeof(sourceBuf));\n        if (utfSource == NULL) {\n            JNU_ThrowOutOfMemoryError(env, NULL);\n            goto free_utfName;\n        }\n    } else {\n        utfSource = NULL;\n    }\n    result = JVM_DefineClassWithSource(env, utfName, loader, body, length, pd, utfSource);\n\n    if (utfSource && utfSource != sourceBuf)\n        free(utfSource);\n\n free_utfName:\n    if (utfName && utfName != buf)\n        free(utfName);\n\n free_body:\n    free(body);\n    return result;\n}\n```\n\n代码中调用了JVM_DefineClassWithSource方法，该方法定义在JVM源码中，下载JVM源码搜索该方法。\n> 代码清单：src/share/vm/prims/jvm.cpp\n``` C++\nJVM_ENTRY(jclass, JVM_DefineClassWithSource(JNIEnv *env, const char *name, jobject loader, const jbyte *buf, jsize len, jobject pd, const char *source))\n  JVMWrapper2(\"JVM_DefineClassWithSource %s\", name);\n\n  return jvm_define_class_common(env, name, loader, buf, len, pd, source, true, THREAD);\nJVM_END\n```\n经过一连串的内部调用,JVM才开始真正解析字节码流：\n> src/share/vm/prims/jvm.cpp --> JVM_DefineClassWithSource()\n>> src/share/vm/prims/jvm.cpp --> jvm_define_class_common()\n>>> src/share/vm/classfile/systemDictionary.cpp --> Klass* SystemDictionary::resolve_from_stream()\n>>>> src/share/vm/classfile/classFileParser.cpp --> instanceKlassHandle ClassFileParser::parseClassFile()\n\n\nJVM首先会判断是否需要进行格式校验\n> 代码清单：src/share/vm/classfile/classFileParser.cpp\n``` C++\n  // Figure out whether we can skip format checking (matching classic VM behavior)\n  if (DumpSharedSpaces) {\n    // verify == true means it's a 'remote' class (i.e., non-boot class)\n    // Verification decision is based on BytecodeVerificationRemote flag\n    // for those classes.\n    _need_verify = (verify) ? BytecodeVerificationRemote :\n                              BytecodeVerificationLocal;\n  } else {\n    _need_verify = Verifier::should_verify_for(class_loader(), verify);\n  }\n```\nDumpSharedSpaces默认为false，因此会走到下面的分支\n\n> 代码清单：src/share/vm/classfile/verifier.cpp\n``` C++\nbool Verifier::should_verify_for(oop class_loader, bool should_verify_class) {\n  return (class_loader == NULL || !should_verify_class) ?\n    BytecodeVerificationLocal : BytecodeVerificationRemote;\n}\n```\n\n当前class_loader为当前classLoad，并且should_verify_class在调用jvm_define_class_common方法时传值true\n> 代码清单：src/share/vm/prims/jvm.cpp\n``` C++\nJVM_ENTRY(jclass, JVM_DefineClassWithSource(JNIEnv *env, const char *name, jobject loader, const jbyte *buf, jsize len, jobject pd, const char *source))\n  JVMWrapper2(\"JVM_DefineClassWithSource %s\", name);\n\n  return jvm_define_class_common(env, name, loader, buf, len, pd, source, true, THREAD);\nJVM_END\n```\n\n因此判断_need_verify的结果最终落到了BytecodeVerificationRemote上。\n\n我们先看BytecodeVerificationRemote在jvm里的定义：\n> 代码清单：src/share/vm/runtime/globals.hpp\n``` C++\n  product(bool, BytecodeVerificationRemote, true,                           \\\n          \"Enable the Java bytecode verifier for remote classes\")           \\\n```\n可见BytecodeVerificationRemote在JVM初始化的时候默认值为true，代表非JVM自己的对象在加载的时候需要进行各种校验。\n\n为了证明这点，我们再看看解析方法时具体的逻辑：\n> 代码清单：src/share/vm/classfile/classFileParser.cpp --> methodHandle ClassFileParser::parse_method()\n``` C++\n  if (_need_verify) {\n    args_size = ((flags & JVM_ACC_STATIC) ? 0 : 1) +\n                 verify_legal_method_signature(name, signature, CHECK_(nullHandle));\n    if (args_size > MAX_ARGS_SIZE) {\n      classfile_parse_error(\"Too many arguments in method signature in class file %s\", CHECK_(nullHandle));\n    }\n  }\n```\n\nJVM在解析方法的逻辑中，会先对方法的合法性做各种校验。其中就有对方法签名的校验。如果_need_verify为false，则改校验会被跳过。\n\n通过上面的一连串的代码分析，我们得到了BytecodeVerificationRemote的值最终会影响Fastjson通过ASM动态字节码生成的类文件的解析。\n\n接下来我们搞明白BytecodeVerificationRemote的值是如何被更改的，老样子代码一顿乱搜：\n> 代码清单：src/share/vm/runtime/arguments.cpp --> jint Arguments::parse_each_vm_init_arg\n``` C++\n// -Xverify\n    } else if (match_option(option, \"-Xverify\", &tail)) {\n      if (strcmp(tail, \":all\") == 0 || strcmp(tail, \"\") == 0) {\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, true);\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, true);\n      } else if (strcmp(tail, \":remote\") == 0) {\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, false);\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, true);\n      } else if (strcmp(tail, \":none\") == 0) {\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationLocal, false);\n        FLAG_SET_CMDLINE(bool, BytecodeVerificationRemote, false);\n      } else if (is_bad_option(option, args->ignoreUnrecognized, \"verification\")) {\n        return JNI_EINVAL;\n      }\n```\n\n| Xverify | BytecodeVerificationLocal | BytecodeVerificationRemote |\n| ------ | ------ | ------ |\n| all 或 不传 | true | true |\n| remote | false | true |\n| none | false | false |\n\n顺着这个思路我们再看看服务启动时的参数。由于是采用IDEA启动的springboot项目，我们没有手动指定各种启动参数。老样子我们还是借助其他工具进行查看。这次我们使用jdk自带的VisualVM。\n\n![07](fastjson序列化异常排查/visualVM.png)\n\n\n这回事真相大白了，通过IDEA默认启动springboot项目时，会默认带上<font color=red>-Xverify:none</font>参数。结合我们上面对JVM源码的分析，在Xverify==none时。加载类模板时不会对类结构的合法性进行校验，这也最终导致了为什么方法签名明明不正确，但是JVM还是成功的加载了这个类。\n\n至于为什么IDEA启动的时候会带上<font color=red>-Xverify:none</font>参数，我们可以参考官网的一句话。\n> https://www.jetbrains.com/help/idea/run-debug-configuration-spring-boot.html#configuration-tab\n\n![08](fastjson序列化异常排查/idea.png)\n\n## 总结\n至此，整个fastjson序列化引起的异常已经排查完了。\n\n回顾整个排查过程其实这一个错误引出了两个问题。\n* 第一个问题是fastjson通过ASM生成字节码文件的时候，processValue的参数个数不对。fastjson官方在后续版本中增加了processValue的重载方法，从而修复这个问题。\n* 第二个问题是processValue方法的方法签名不正确，方法返回类型写有两个参数。从而引起对JVM解析类时，方法签名合法性校验机制的研究。官方也在后续版本中修正了方法签名的错误。\n\n以上，虽然这次问题的发现和解决都很简单。但是牵扯出了一部分JVM源码的知识，借由这次机会，加深相关知识。\n\n","slug":"fastjson序列化异常排查","published":1,"updated":"2020-12-14T10:39:46.423Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71huj004nv252f90fazco","content":"<html><head></head><body><p>fastjson&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x8F7B;&#x91CF;&#x7EA7;&#x7684;java&#x5E8F;&#x5217;&#x5316;&#x7C7B;&#x5E93;&#xFF0C;&#x5176;&#x6700;&#x5927;&#x7684;&#x4F18;&#x52BF;&#x5C31;&#x662F;&#x5FEB;&#xFF0C;&#x56E0;&#x6B64;&#x4E5F;&#x88AB;&#x56FD;&#x5185;&#x5404;&#x4E2A;&#x4E2D;&#x5C0F;&#x578B;&#x516C;&#x53F8;&#x5927;&#x91CF;&#x7684;&#x4F7F;&#x7528;&#x3002;&#x4F46;&#x5B83;&#x4E5F;&#x6709;&#x4E0D;&#x5C11;&#x77ED;&#x677F;&#xFF0C;&#x5982;&#x53EF;&#x5B9A;&#x5236;&#x6027;&#x4F4E;&#x3001;API&#x4E0D;&#x591F;&#x4E30;&#x5BCC;&#x3001;&#x4EE3;&#x7801;&#x8D28;&#x91CF;&#x53CA;&#x6587;&#x6863;&#x7F3A;&#x5931;&#x7B49;&#x4E00;&#x4E9B;&#x5217;&#x95EE;&#x9898;&#x4E00;&#x76F4;&#x88AB;&#x4EBA;&#x6240;&#x8BDF;&#x75C5;&#x3002;</p>\n<p>&#x672C;&#x6B21;&#x6211;&#x4EEC;&#x78B0;&#x5230;&#x7684;&#x95EE;&#x9898;&#x5C31;&#x662F;&#x7531;fastjson&#x7684;&#x4E00;&#x4E2A;&#x7B80;&#x5355;bug&#x800C;&#x5F15;&#x8D77;&#x7684;&#x4E00;&#x8FDE;&#x4E32;&#x7814;&#x7A76;&#x3002;</p>\n<a id=\"more\"></a>\n<h2 id=\"&#x53D1;&#x73B0;bug\"><a href=\"#&#x53D1;&#x73B0;bug\" class=\"headerlink\" title=\"&#x53D1;&#x73B0;bug\"></a>&#x53D1;&#x73B0;bug</h2><p>&#x67D0;&#x65E5;&#x4E00;&#x4F4D;&#x540C;&#x5B66;&#x5728;&#x8C03;&#x8BD5;&#x65B0;&#x9700;&#x6C42;&#x7684;&#x65F6;&#x5019;&#x53D1;&#x73B0;&#x5982;&#x4E0B;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#xFF1A;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Exception in thread <span class=\"hljs-string\">&quot;collection-eventbus-thread-1&quot;</span> java.lang.NoSuchMethodError: com.alibaba.fastjson.serializer.JavaBeanSerializer.processValue(Lcom/alibaba/fastjson/serializer/JSONSerializer;Lcom/alibaba/fastjson/serializer/BeanContext;Ljava/lang/Object;Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;Ljava/lang/Integer;</span><br><span class=\"line\">\tat com.alibaba.fastjson.serializer.ASMSerializer_6_FastJsonSerializerWrapper.writeNormal(Unknown Source)</span><br><span class=\"line\">\tat com.alibaba.fastjson.serializer.ASMSerializer_6_FastJsonSerializerWrapper.write(Unknown Source)</span><br><span class=\"line\">\tat com.alibaba.fastjson.serializer.JSONSerializer.write(JSONSerializer.java:<span class=\"hljs-number\">285</span>)</span><br><span class=\"line\">\tat com.alibaba.fastjson.JSON.toJSONString(JSON.java:<span class=\"hljs-number\">663</span>)</span><br><span class=\"line\">\tat com.alibaba.fastjson.JSON.toJSONString(JSON.java:<span class=\"hljs-number\">652</span>)</span><br><span class=\"line\">\tat com.oriente.cache.layeringCache.serializer.FastJsonRedisSerializer.serialize(FastJsonRedisSerializer.java:<span class=\"hljs-number\">37</span>)</span><br><span class=\"line\">\tat org.springframework.data.redis.core.AbstractOperations.rawValue(AbstractOperations.java:<span class=\"hljs-number\">117</span>)</span><br><span class=\"line\">\tat org.springframework.data.redis.core.DefaultValueOperations.multiSet(DefaultValueOperations.java:<span class=\"hljs-number\">136</span>)</span><br><span class=\"line\">\tat com.oriente.collection.event.listener.RedisEventListener.schedule(RedisEventListener.java:<span class=\"hljs-number\">75</span>)</span><br><span class=\"line\">\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class=\"line\">\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class=\"hljs-number\">62</span>)</span><br><span class=\"line\">\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class=\"hljs-number\">43</span>)</span><br><span class=\"line\">\tat java.lang.reflect.Method.invoke(Method.java:<span class=\"hljs-number\">498</span>)</span><br><span class=\"line\">\tat com.google.common.eventbus.Subscriber.invokeSubscriberMethod(Subscriber.java:<span class=\"hljs-number\">87</span>)</span><br><span class=\"line\">\tat com.google.common.eventbus.Subscriber$SynchronizedSubscriber.invokeSubscriberMethod(Subscriber.java:<span class=\"hljs-number\">144</span>)</span><br><span class=\"line\">\tat com.google.common.eventbus.Subscriber$<span class=\"hljs-number\">1.</span>run(Subscriber.java:<span class=\"hljs-number\">72</span>)</span><br><span class=\"line\">\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class=\"hljs-number\">1149</span>)</span><br><span class=\"line\">\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class=\"hljs-number\">624</span>)</span><br><span class=\"line\">\tat java.lang.Thread.run(Thread.java:<span class=\"hljs-number\">748</span>)</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x901A;&#x8FC7;&#x89C2;&#x5BDF;&#x9519;&#x8BEF;&#xFF0C;&#x5F88;&#x5FEB;&#x5C31;&#x80FD;&#x5B9A;&#x4F4D;&#x5230;&#x662F;fastjson&#x5E8F;&#x5217;&#x5316;&#x7684;&#x65F6;&#x5019;&#x51FA;&#x73B0;&#x4E86;&#x9519;&#x8BEF;&#x3002;&#x540C;&#x65F6;&#x6211;&#x4EEC;&#x4E5F;&#x786E;&#x8BA4;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x5728;&#x81EA;&#x5B9A;&#x7684;RedisTemplate&#x4E2D;&#xFF0C;&#x9488;&#x5BF9;Value&#x7684;&#x5E8F;&#x5217;&#x5316;&#x5DE5;&#x5177;&#x6211;&#x4EEC;&#x7684;&#x786E;&#x4F7F;&#x7528;&#x4E86;fastjson&#x7684;&#x5E8F;&#x5217;&#x5316;&#x65B9;&#x5F0F;&#x3002;</p>\n<ul>\n<li><p>RedisTemplate&#x4F7F;&#x7528;&#x81EA;&#x5B9A;&#x4E49;&#x7684;fastjoson&#x5E8F;&#x5217;&#x5316;&#x5DE5;&#x5177;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FastJsonRedisSerializer&lt;Object&gt; fastJsonRedisSerializer = <span class=\"hljs-keyword\">new</span> FastJsonRedisSerializer&lt;&gt;(Object.class);</span><br><span class=\"line\"></span><br><span class=\"line\">redisTemplate.setValueSerializer(fastJsonRedisSerializer);</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>FastJsonRedisSerializer&#x4E2D;&#x4F7F;&#x7528;fastjson&#x7684;API&#x5BF9;&#x7EDF;&#x4E00;&#x5305;&#x88C5;&#x7C7B;&#x8FDB;&#x884C;&#x5E8F;&#x5217;&#x5316;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">byte</span>[] serialize(T t) <span class=\"hljs-keyword\">throws</span> SerializationException {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">try</span> {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> JSON.toJSONString(<span class=\"hljs-keyword\">new</span> FastJsonSerializerWrapper(t), SerializerFeature.WriteClassName).getBytes(DEFAULT_CHARSET);</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">catch</span> (Exception e) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> SerializationException(String.format(<span class=\"hljs-string\">&quot;FastJsonRedisSerializer &#x5E8F;&#x5217;&#x5316;&#x5F02;&#x5E38;: %s, &#x3010;JSON&#xFF1A;%s&#x3011;&quot;</span>,</span><br><span class=\"line\">                e.getMessage(), JSON.toJSONString(t)), e);</span><br><span class=\"line\"></span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n</li>\n</ul>\n<h2 id=\"&#x5206;&#x6790;bug\"><a href=\"#&#x5206;&#x6790;bug\" class=\"headerlink\" title=\"&#x5206;&#x6790;bug\"></a>&#x5206;&#x6790;bug</h2><p>&#x7ECF;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x4E00;&#x987F;&#x6392;&#x67E5;&#xFF0C;&#x95EE;&#x9898;&#x5DF2;&#x7ECF;&#x5F88;&#x660E;&#x786E;&#x5B9A;&#x4F4D;&#x5230;&#x662F;fastjson&#x4E0A;&#x4E86;&#xFF0C;&#x5E76;&#x4E14;&#x9519;&#x8BEF;&#x4FE1;&#x606F;&#x7ED9;&#x7684;&#x76F8;&#x5F53;&#x660E;&#x786E;&#xFF1A;</p>\n<p>  <font color=\"red\"> <code>java.lang.NoSuchMethodError: com.alibaba.fastjson.serializer.JavaBeanSerializer.processValue(Lcom/alibaba/fastjson/serializer/JSONSerializer;Lcom/alibaba/fastjson/serializer/BeanContext;Ljava/lang/Object;Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;Ljava/lang/Integer;</code> </font></p>\n<p>&#x63D0;&#x793A;&#x672A;&#x627E;&#x5230;JavaBeanSerializer.processValue&#x65B9;&#x6CD5;&#x3002;ok&#x6211;&#x4EEC;&#x7ACB;&#x9A6C;&#x67E5;&#x8BE2;JavaBeanSerializer&#x6E90;&#x7801;&#xFF0C;&#x53D1;&#x73B0;processalue&#x65B9;&#x6CD5;&#x662F;&#x7EE7;&#x627F;&#x81EA;SerializeFilterable&#x7C7B;&#xFF1A;</p>\n<blockquote>\n<p>&#x65B9;&#x6CD5;&#x6E05;&#x5355;&#xFF1A;com.alibaba.fastjson.serializer.JavaBeanSerializer</p>\n</blockquote>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> Object <span class=\"hljs-title\">processValue</span><span class=\"hljs-params\">(JSONSerializer jsonBeanDeser, //</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">                           BeanContext beanContext,</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">                           Object object, //</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">                           String key, //</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">                           Object propertyValue, //</span></span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-params\">                           <span class=\"hljs-keyword\">int</span> features)</span> </span>{</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x4E4D;&#x4E00;&#x770B;&#x65B9;&#x6CD5;&#x662F;&#x5B58;&#x5728;&#x7684;&#xFF0C;&#x8FD9;&#x662F;&#x6211;&#x4EEC;&#x53C8;&#x56DE;&#x5230;&#x4E86;&#x9519;&#x8BEF;&#x672C;&#x8EAB;&#x3002;&#x4ED4;&#x7EC6;&#x67E5;&#x770B;&#x9519;&#x8BEF;&#xFF0C;&#x9519;&#x8BEF;&#x4E2D;&#x63D0;&#x793A;&#x6211;&#x4EEC;processValue&#x65B9;&#x6CD5;&#x7B7E;&#x540D;&#x5982;&#x4E0B;&#xFF1A;</p>\n<p>&#x5165;&#x53C2;&#xFF1A;</p>\n<ol>\n<li>Lcom/alibaba/fastjson/serializer/JSONSerializer <font color=\"green\">&#x2013;JSONSerializer&#x7C7B;&#x578B;&#x7684;&#x5BF9;&#x8C61;</font></li>\n<li>Lcom/alibaba/fastjson/serializer/BeanContext <font color=\"green\">&#x2013;BeanContext&#x7C7B;&#x578B;&#x7684;&#x5BF9;&#x8C61;</font></li>\n<li>Ljava/lang/Object <font color=\"green\">&#x2013;Object&#x5BF9;&#x8C61;</font></li>\n<li>Ljava/lang/String <font color=\"green\">&#x2013;String &#x7C7B;&#x578B;</font></li>\n<li>Ljava/lang/Object <font color=\"green\">&#x2013;Object&#x5BF9;&#x8C61;</font></li>\n</ol>\n<p>&#x8FD4;&#x56DE;&#x53C2;&#x6570;&#xFF1A;</p>\n<ol>\n<li>Ljava/lang/Object;Ljava/lang/Integer; <font color=\"green\">&#x2013;&#x8FD9;&#x662F;&#x4EC0;&#x4E48;&#x9B3C;&#xFF1F;java&#x7684;&#x8FD4;&#x56DE;&#x53C2;&#x6570;&#x5E94;&#x8BE5;&#x662F;&#x4E0D;&#x652F;&#x6301;&#x4E24;&#x4E2A;&#x624D;&#x5BF9;&#x554A;&#xFF01;</font></li>\n</ol>\n<p>&#x7ECF;&#x8FC7;&#x5BF9;&#x6BD4;&#xFF0C;&#x679C;&#x7136;&#x65B9;&#x6CD5;&#x7B7E;&#x540D;&#x4E0D;&#x4E00;&#x81F4;&#x3002;&#x6E90;&#x7801;&#x4E2D;SerializeFilterable.processValue()&#x65B9;&#x6CD5;&#x4E2D;&#x6709;6&#x4E2A;&#x5165;&#x53C2;&#xFF0C;&#x800C;&#x9519;&#x8BEF;&#x65E5;&#x5FD7;&#x4E2D;&#x63D0;&#x793A;&#x7684;&#x53EA;&#x6709;5&#x4E2A;&#x5165;&#x53C2;&#x3002;&#x7F3A;&#x5C11;&#x4E86;&#x6700;&#x540E;&#x4E00;&#x4E2A; <font color=\"blue\"> int features</font></p>\n<h4 id=\"&#x95EE;&#x9898;1\"><a href=\"#&#x95EE;&#x9898;1\" class=\"headerlink\" title=\"&#x95EE;&#x9898;1\"></a>&#x95EE;&#x9898;1</h4><p>&#x4ECE;&#x65B9;&#x6CD5;&#x7B7E;&#x540D;&#x7684;&#x5BF9;&#x6BD4;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;&#x8BE5;&#x9519;&#x8BEF;&#x7684;&#x786E;&#x662F;&#x56E0;&#x4E3A;&#x627E;&#x4E0D;&#x5BF9;&#x5BF9;&#x5E94;&#x7684;&#x65B9;&#x6CD5;&#x6240;&#x5BFC;&#x81F4;&#x7684;&#x3002;&#x7531;&#x4E8E;fastjson&#x5E8F;&#x5217;&#x5316;&#x7684;&#x5BF9;&#x8C61;&#x662F;&#x901A;&#x8FC7;ASM&#x52A8;&#x6001;&#x751F;&#x6210;&#x5B57;&#x8282;&#x7801;&#x4EA7;&#x751F;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x901A;&#x591A;&#x6E90;&#x7801;&#x6216;&#x8005;&#x501F;&#x52A9;&#x5DE5;&#x5177;&#x6765;&#x9A8C;&#x8BC1;&#x8FD9;&#x4E2A;bug&#x7684;&#x771F;&#x5B9E;&#x6027;&#x3002;</p>\n<h5 id=\"1-&#x4EE3;&#x7801;&#x9A8C;&#x8BC1;\"><a href=\"#1-&#x4EE3;&#x7801;&#x9A8C;&#x8BC1;\" class=\"headerlink\" title=\"1.&#x4EE3;&#x7801;&#x9A8C;&#x8BC1;\"></a>1.&#x4EE3;&#x7801;&#x9A8C;&#x8BC1;</h5><p>fastjson&#x5728;java&#x5E73;&#x53F0;&#x4E0B;&#x4F1A;&#x9ED8;&#x8BA4;&#x4F7F;&#x7528;ASM&#x7684;&#x65B9;&#x5F0F;&#x52A8;&#x6001;&#x751F;&#x6210;&#x5E8F;&#x5217;&#x5316;&#x4EE3;&#x7406;&#x7C7B;</p>\n<blockquote>\n<p>&#x65B9;&#x6CD5;&#x6E05;&#x5355;&#xFF1A;com.alibaba.fastjson.serializer.SerializeConfig</p>\n</blockquote>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">boolean</span>                                       asm             = !ASMUtils.IS_ANDROID;</span><br></pre></td></tr></tbody></table></figure>\n<blockquote>\n<p>&#x65B9;&#x6CD5;&#x6E05;&#x5355;&#xFF1A;com.alibaba.fastjson.serializer.SerializeConfig</p>\n</blockquote>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">if</span> (asm) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">try</span> {</span><br><span class=\"line\">        ObjectSerializer asmSerializer = createASMSerializer(beanInfo);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (asmSerializer != <span class=\"hljs-keyword\">null</span>) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">return</span> asmSerializer;</span><br><span class=\"line\">        }</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">catch</span> (ClassNotFoundException ex) {</span><br><span class=\"line\">        <span class=\"hljs-comment\">// skip</span></span><br><span class=\"line\">    } <span class=\"hljs-keyword\">catch</span> (ClassFormatError e) {</span><br><span class=\"line\">        <span class=\"hljs-comment\">// skip</span></span><br><span class=\"line\">    } <span class=\"hljs-keyword\">catch</span> (ClassCastException e) {</span><br><span class=\"line\">        <span class=\"hljs-comment\">// skip</span></span><br><span class=\"line\">    } <span class=\"hljs-keyword\">catch</span> (OutOfMemoryError e) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (e.getMessage().indexOf(<span class=\"hljs-string\">&quot;Metaspace&quot;</span>) != -<span class=\"hljs-number\">1</span>) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">throw</span> e;</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"hljs-comment\">// skip</span></span><br><span class=\"line\">    } <span class=\"hljs-keyword\">catch</span> (Throwable e) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">throw</span> <span class=\"hljs-keyword\">new</span> JSONException(<span class=\"hljs-string\">&quot;create asm serializer error, verson &quot;</span> + JSON.VERSION + <span class=\"hljs-string\">&quot;, class &quot;</span> + clazz, e);</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote>\n<p>&#x65B9;&#x6CD5;&#x6E05;&#x5355;&#xFF1A;com.alibaba.fastjson.serializer.ASMSerializerFactory</p>\n</blockquote>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">_processValue</span><span class=\"hljs-params\">(MethodVisitor mw, FieldInfo fieldInfo, Context context, Label _end)</span> </span>{</span><br><span class=\"line\">...</span><br><span class=\"line\">        mw.visitMethodInsn(INVOKEVIRTUAL, JavaBeanSerializer, <span class=\"hljs-string\">&quot;processValue&quot;</span>,</span><br><span class=\"line\">                           <span class=\"hljs-string\">&quot;(L&quot;</span> + JSONSerializer  + <span class=\"hljs-string\">&quot;;&quot;</span> <span class=\"hljs-comment\">//</span></span><br><span class=\"line\">                                                                          + desc(BeanContext.class) <span class=\"hljs-comment\">//</span></span><br><span class=\"line\">                                                                          + <span class=\"hljs-string\">&quot;Ljava/lang/Object;Ljava/lang/String;&quot;</span> <span class=\"hljs-comment\">//</span></span><br><span class=\"line\">                                                                          + valueDesc + <span class=\"hljs-string\">&quot;)Ljava/lang/Object;Ljava/lang/Integer;&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                                                                          ...</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<p>&#x901A;&#x8FC7;&#x4E0A;&#x8FF0;&#x6E90;&#x7801;&#xFF0C;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x5728;&#x901A;&#x8FC7;ASM&#x751F;&#x6210;processValue&#x65B9;&#x6CD5;&#x7B7E;&#x540D;&#x65F6;&#xFF0C;&#x53EA;&#x5B9A;&#x4E49;&#x4E86;5&#x4E2A;&#x53C2;&#x6570;&#x3002;&#x540C;&#x65F6;&#x4E5F;&#x80FD;&#x770B;&#x5230;&#x8FD4;&#x56DE;&#x53C2;&#x6570;&#x591A;&#x8BBE;&#x7F6E;&#x4E86;&#x4E2A;Ljava/lang/Integer&#x7C7B;&#x578B;&#x3002;</p>\n<p>&#x4F9D;&#x8D56;&#x4EE3;&#x7801;&#x9605;&#x8BFB;&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x53EF;&#x4EE5;&#x786E;&#x5B9A;&#x9519;&#x8BEF;&#x4EE3;&#x7801;&#x7684;&#x4F4D;&#x7F6E;&#x4E86;&#x3002;&#x4F46;&#x7531;&#x4E8E;&#x6BD5;&#x7ADF;&#x662F;&#x901A;&#x8FC7;ASM&#x52A8;&#x6001;&#x5B57;&#x8282;&#x7801;&#x751F;&#x6210;&#x7684;&#x7C7B;&#x548C;&#x5BF9;&#x8C61;&#xFF0C;&#x5B9E;&#x9645;&#x5728;JVM&#x4E2D;&#x7684;&#x7C7B;&#x662F;&#x5426;&#x4E5F;&#x50CF;&#x6211;&#x4EEC;&#x73B0;&#x5728;&#x770B;&#x5230;&#x7684;&#x4E00;&#x6837;&#x7684;&#x8BDD;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x9700;&#x8981;&#x501F;&#x52A9;&#x5176;&#x4ED6;&#x5DE5;&#x5177;&#x6765;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x89C2;&#x5BDF;&#x4E86;&#x3002;</p>\n<h5 id=\"2-&#x901A;&#x8FC7;HSDB&#x89C2;&#x5BDF;JVM&#x4E2D;&#x7684;&#x7C7B;\"><a href=\"#2-&#x901A;&#x8FC7;HSDB&#x89C2;&#x5BDF;JVM&#x4E2D;&#x7684;&#x7C7B;\" class=\"headerlink\" title=\"2.&#x901A;&#x8FC7;HSDB&#x89C2;&#x5BDF;JVM&#x4E2D;&#x7684;&#x7C7B;\"></a>2.&#x901A;&#x8FC7;HSDB&#x89C2;&#x5BDF;JVM&#x4E2D;&#x7684;&#x7C7B;</h5><ul>\n<li>&#x5DF2;Debug&#x6A21;&#x5F0F;&#x542F;&#x52A8;Java&#x670D;&#x52A1;</li>\n<li>&#x5C06;&#x65AD;&#x70B9;&#x8BBE;&#x7F6E;&#x5230;&#x4EE3;&#x7406;&#x7C7B;&#x751F;&#x4EA7;&#x903B;&#x8F91;&#x540E;<blockquote>\n<p>&#x65B9;&#x6CD5;&#x6E05;&#x5355;&#xFF1A;com.alibaba.fastjson.serializer.ASMSerializerFactory</p>\n</blockquote>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">//&#x5C06;&#x52A8;&#x6001;&#x751F;&#x6210;&#x7684;&#x5B57;&#x8282;&#x7801;&#x5BF9;&#x8C61;&#x88C5;&#x7EF4;&#x5B57;&#x8282;&#x6570;&#x7EC4;</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">byte</span>[] code = cw.toByteArray();</span><br><span class=\"line\"><span class=\"hljs-comment\">//&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7C7B;</span></span><br><span class=\"line\">Class&lt;?&gt; serializerClass = classLoader.defineClassPublic(classNameFull, code, <span class=\"hljs-number\">0</span>, code.length);</span><br></pre></td></tr></tbody></table></figure>\n\n</li>\n</ul>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/classload%E6%96%AD%E7%82%B9.png\" alt=\"01\"></p>\n<ul>\n<li><p>&#x6253;&#x5F00;HSDB</p>\n<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -cp sa-jdi.jar sun.jvm.hotspot.HSDB</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>&#x83B7;&#x53D6;&#x5F53;&#x524D;java&#x8FDB;&#x7A0B;</p>\n</li>\n</ul>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/jps.png\" alt=\"02\"></p>\n<ul>\n<li>HSDB attach&#x5F53;&#x524D;java&#x8FDB;&#x7A0B;</li>\n</ul>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/hdbs_attach.png\" alt=\"03\"></p>\n<ul>\n<li>&#x6267;&#x884C;&#x65B9;&#x6CD5;&#x81F3;&#x65AD;&#x70B9;&#x5904;&#x540E;&#xFF0C;&#x5728;HSDB&#x641C;&#x7D22;&#x4EE3;&#x7406;&#x7C7B;</li>\n</ul>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/class_browser.png\" alt=\"04\"></p>\n<p>&#x901A;&#x8FC7;&#x89C2;&#x5BDF;FastJsonSerializerWrapper.writeNormal()&#x65B9;&#x6CD5;&#x7684;&#x5B57;&#x8282;&#x7801;&#x4E5F;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#xFF0C;&#x5728;&#x8C03;&#x7528;processValue()&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#x7F3A;&#x5C11;&#x4E86;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x3002;</p>\n<ul>\n<li>&#x67E5;&#x770B;FastJsonSerializerWrapper&#x7684;&#x5E38;&#x91CF;&#x6C60;</li>\n</ul>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/constantpool.png\" alt=\"05\"></p>\n<p>&#x67E5;&#x770B;&#x5E38;&#x91CF;&#x6C60;&#x4E2D;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x4E5F;&#x518D;&#x6B21;&#x786E;&#x8BA4;&#x4E86;processValue()&#x65B9;&#x6CD5;&#x7684;&#x7B7E;&#x540D;&#x5B58;&#x5728;&#x95EE;&#x9898;&#xFF1A;&#x5165;&#x53C2;&#x4E0D;&#x5BF9;&#x3001;&#x8FD4;&#x56DE;&#x53C2;&#x6570;&#x4E5F;&#x6709;&#x95EE;&#x9898;&#x3002;</p>\n<h4 id=\"&#x95EE;&#x9898;2\"><a href=\"#&#x95EE;&#x9898;2\" class=\"headerlink\" title=\"&#x95EE;&#x9898;2\"></a>&#x95EE;&#x9898;2</h4><p>ASMSerializer_6_FastJsonSerializerWrapper.processValue()&#x65B9;&#x6CD5;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x6709;&#x4E24;&#x4E2A;&#x3002;&#x8FD9;&#x4F1A;&#x5E26;&#x6765;&#x4EC0;&#x4E48;&#x95EE;&#x9898;&#xFF1F;&#x4E3A;&#x4EC0;&#x4E48;&#x5728;&#x7C7B;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7684;&#x65F6;&#x5019;JVM&#x6CA1;&#x6709;&#x68C0;&#x67E5;&#x51FA;&#x65B9;&#x6CD5;&#x7B7E;&#x540D;&#x7684;&#x95EE;&#x9898;?</p>\n<p>&#x9884;&#x77E5;&#x5927;&#x9053;&#xFF0C;&#x5FC5;&#x5148;&#x4E3A;&#x53F2;&#x3002;java&#x4E5F;&#x4E00;&#x6837;&#xFF0C;java&#x7684;&#x5386;&#x53F2;&#x5C31;&#x662F;JVM&#x3002;&#x8981;&#x60F3;&#x4E86;&#x89E3;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x7C7B;&#x7684;&#x65F6;&#x5019;&#x5230;&#x5E95;&#x505A;&#x4E86;&#x4EC0;&#x4E48;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x5FC5;&#x987B;&#x53C2;&#x9605;JVM&#x6E90;&#x7801;&#x3002;</p>\n<p>&#x4E4B;&#x524D;&#x9605;&#x8BFB;fastjson&#x6E90;&#x7801;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x4EEC;&#x66FE;&#x7ECF;&#x6765;&#x5230;&#x8FD9;&#x4E48;&#x4E00;&#x6BB5;&#x4EE3;&#x7801;&#x3002;</p>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/classload%E6%96%AD%E7%82%B9.png\" alt=\"06\"></p>\n<p>&#x663E;&#x7136;&#x6E90;&#x7801;&#x662F;&#x901A;&#x8FC7;&#x8C03;&#x7528;native&#x65B9;&#x6CD5;&#xFF0C;&#x5C06;&#x7C7B;&#x7684;&#x5B57;&#x8282;&#x6D41;&#x5199;&#x5165;&#x5230;JVM&#x4E2D;&#x7684;&#x3002;jdk&#x4E3A;&#x5F00;&#x53D1;&#x8005;&#x63D0;&#x4F9B;&#x4E86;&#x4E30;&#x5BCC;&#x7684;&#x7C7B;&#x52A0;&#x8F7D;&#x673A;&#x5236;&#xFF0C;&#x4F46;&#x7A76;&#x5176;&#x6E90;&#x8FD8;&#x662F;&#x4F9D;&#x8D56;&#x4E86;&#x8FD9;&#x4E09;&#x4E2A;native&#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x4E14;&#x8FD9;&#x4E09;&#x4E2A;&#x65B9;&#x6CD5;&#x4EC5;&#x4EC5;&#x662F;&#x5165;&#x53C2;&#x4E0D;&#x540C;&#xFF0C;&#x5176;&#x80CC;&#x540E;&#x7684;&#x5B9E;&#x73B0;&#x539F;&#x7406;&#x5176;&#x5B9E;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>\n<blockquote>\n<p>&#x65B9;&#x6CD5;&#x6E05;&#x5355;&#xFF1A;java.lang.ClassLoader</p>\n</blockquote>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">native</span> Class&lt;?&gt; defineClass0(String name, <span class=\"hljs-keyword\">byte</span>[] b, <span class=\"hljs-keyword\">int</span> off, <span class=\"hljs-keyword\">int</span> len,</span><br><span class=\"line\">                                     ProtectionDomain pd);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">native</span> Class&lt;?&gt; defineClass1(String name, <span class=\"hljs-keyword\">byte</span>[] b, <span class=\"hljs-keyword\">int</span> off, <span class=\"hljs-keyword\">int</span> len,</span><br><span class=\"line\">                                     ProtectionDomain pd, String source);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">native</span> Class&lt;?&gt; defineClass2(String name, java.nio.ByteBuffer b,</span><br><span class=\"line\">                                     <span class=\"hljs-keyword\">int</span> off, <span class=\"hljs-keyword\">int</span> len, ProtectionDomain pd,</span><br><span class=\"line\">                                     String source);</span><br></pre></td></tr></tbody></table></figure>\n\n<h6 id=\"java-native-&#x65B9;&#x6CD5;&#x5165;&#x53E3;\"><a href=\"#java-native-&#x65B9;&#x6CD5;&#x5165;&#x53E3;\" class=\"headerlink\" title=\"java native &#x65B9;&#x6CD5;&#x5165;&#x53E3;\"></a>java native &#x65B9;&#x6CD5;&#x5165;&#x53E3;</h6><p>&#x6309;&#x7167;jni&#x7684;&#x5B9A;&#x4E49;&#x89C4;&#x8303;&#xFF0C;native&#x65B9;&#x6CD5;&#x4F1A;&#x6309;&#x7167;&#x4EE5;&#x4E0B;&#x7684;&#x683C;&#x5F0F;&#x8FDB;&#x884C;&#x5B9A;&#x4E49;&#xFF1A;<br>__JNIEXPORT jclass JNICALL Java_packagepath(&#x5305;&#x8DEF;&#x5F84;&#x5DF2;<em>&#x5206;&#x5272;)<em>&#x65B9;&#x6CD5;&#x540D;</em></em></p>\n<p>&#x6839;&#x636E;&#x4E0A;&#x9762;&#x7684;&#x89C4;&#x5B9A;&#xFF0C;&#x6211;&#x4EEC;&#x5F88;&#x5FEB;&#x5C31;&#x80FD;&#x8FD8;&#x539F;&#x51FA;defineClass1&#x65B9;&#x6CD5;&#x5728;jdk&#x4E2D;&#x7684;&#x5B9A;&#x4E49;&#xFF1A;<br><font color=\"blue\"> JNIEXPORT jclass JNICALL Java_java_lang_ClassLoader_defineClass1</font></p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/native/java/lang/ClassLoader.c</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JNIEXPORT jclass JNICALL</span><br><span class=\"line\">Java_java_lang_ClassLoader_defineClass1(JNIEnv *env,</span><br><span class=\"line\">                                        jobject loader,</span><br><span class=\"line\">                                        jstring name,</span><br><span class=\"line\">                                        jbyteArray data,</span><br><span class=\"line\">                                        jint offset,</span><br><span class=\"line\">                                        jint length,</span><br><span class=\"line\">                                        jobject pd,</span><br><span class=\"line\">                                        jstring source)</span><br><span class=\"line\">{</span><br><span class=\"line\">    jbyte *body;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">char</span> *utfName;</span><br><span class=\"line\">    jclass result = <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">char</span> buf[<span class=\"hljs-number\">128</span>];</span><br><span class=\"line\">    <span class=\"hljs-keyword\">char</span>* utfSource;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">char</span> sourceBuf[<span class=\"hljs-number\">1024</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (data == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">        JNU_ThrowNullPointerException(env, <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">/* Work around 4153825. malloc crashes on Solaris when passed a</span></span><br><span class=\"line\"><span class=\"hljs-comment\">     * negative size.</span></span><br><span class=\"line\"><span class=\"hljs-comment\">     */</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (length &lt; <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">        JNU_ThrowArrayIndexOutOfBoundsException(env, <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    body = (jbyte *)<span class=\"hljs-built_in\">malloc</span>(length);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (body == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">        JNU_ThrowOutOfMemoryError(env, <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    (*env)-&gt;GetByteArrayRegion(env, data, offset, length, body);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> ((*env)-&gt;ExceptionOccurred(env))</span><br><span class=\"line\">        <span class=\"hljs-keyword\">goto</span> free_body;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (name != <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">        utfName = getUTF(env, name, buf, <span class=\"hljs-keyword\">sizeof</span>(buf));</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (utfName == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">            JNU_ThrowOutOfMemoryError(env, <span class=\"hljs-literal\">NULL</span>);</span><br><span class=\"line\">            <span class=\"hljs-keyword\">goto</span> free_body;</span><br><span class=\"line\">        }</span><br><span class=\"line\">        VerifyFixClassname(utfName);</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        utfName = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (source != <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">        utfSource = getUTF(env, source, sourceBuf, <span class=\"hljs-keyword\">sizeof</span>(sourceBuf));</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (utfSource == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">            JNU_ThrowOutOfMemoryError(env, <span class=\"hljs-literal\">NULL</span>);</span><br><span class=\"line\">            <span class=\"hljs-keyword\">goto</span> free_utfName;</span><br><span class=\"line\">        }</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        utfSource = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    result = JVM_DefineClassWithSource(env, utfName, loader, body, length, pd, utfSource);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (utfSource &amp;&amp; utfSource != sourceBuf)</span><br><span class=\"line\">        <span class=\"hljs-built_in\">free</span>(utfSource);</span><br><span class=\"line\"></span><br><span class=\"line\"> free_utfName:</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (utfName &amp;&amp; utfName != buf)</span><br><span class=\"line\">        <span class=\"hljs-built_in\">free</span>(utfName);</span><br><span class=\"line\"></span><br><span class=\"line\"> free_body:</span><br><span class=\"line\">    <span class=\"hljs-built_in\">free</span>(body);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> result;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x4EE3;&#x7801;&#x4E2D;&#x8C03;&#x7528;&#x4E86;JVM_DefineClassWithSource&#x65B9;&#x6CD5;&#xFF0C;&#x8BE5;&#x65B9;&#x6CD5;&#x5B9A;&#x4E49;&#x5728;JVM&#x6E90;&#x7801;&#x4E2D;&#xFF0C;&#x4E0B;&#x8F7D;JVM&#x6E90;&#x7801;&#x641C;&#x7D22;&#x8BE5;&#x65B9;&#x6CD5;&#x3002;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/prims/jvm.cpp</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JVM_ENTRY(jclass, JVM_DefineClassWithSource(JNIEnv *env, <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">char</span> *name, jobject loader, <span class=\"hljs-keyword\">const</span> jbyte *buf, jsize len, jobject pd, <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">char</span> *source))</span><br><span class=\"line\">  JVMWrapper2(<span class=\"hljs-string\">&quot;JVM_DefineClassWithSource %s&quot;</span>, name);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> jvm_define_class_common(env, name, loader, buf, len, pd, source, <span class=\"hljs-literal\">true</span>, THREAD);</span><br><span class=\"line\">JVM_END</span><br></pre></td></tr></tbody></table></figure>\n<p>&#x7ECF;&#x8FC7;&#x4E00;&#x8FDE;&#x4E32;&#x7684;&#x5185;&#x90E8;&#x8C03;&#x7528;,JVM&#x624D;&#x5F00;&#x59CB;&#x771F;&#x6B63;&#x89E3;&#x6790;&#x5B57;&#x8282;&#x7801;&#x6D41;&#xFF1A;</p>\n<blockquote>\n<p>src/share/vm/prims/jvm.cpp &#x2013;&gt; JVM_DefineClassWithSource()</p>\n<blockquote>\n<p>src/share/vm/prims/jvm.cpp &#x2013;&gt; jvm_define_class_common()</p>\n<blockquote>\n<p>src/share/vm/classfile/systemDictionary.cpp &#x2013;&gt; Klass* SystemDictionary::resolve_from_stream()</p>\n<blockquote>\n<p>src/share/vm/classfile/classFileParser.cpp &#x2013;&gt; instanceKlassHandle ClassFileParser::parseClassFile()</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<p>JVM&#x9996;&#x5148;&#x4F1A;&#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x683C;&#x5F0F;&#x6821;&#x9A8C;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/classfile/classFileParser.cpp</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// Figure out whether we can skip format checking (matching classic VM behavior)</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">if</span> (DumpSharedSpaces) {</span><br><span class=\"line\">  <span class=\"hljs-comment\">// verify == true means it&apos;s a &apos;remote&apos; class (i.e., non-boot class)</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Verification decision is based on BytecodeVerificationRemote flag</span></span><br><span class=\"line\">  <span class=\"hljs-comment\">// for those classes.</span></span><br><span class=\"line\">  _need_verify = (verify) ? BytecodeVerificationRemote :</span><br><span class=\"line\">                            BytecodeVerificationLocal;</span><br><span class=\"line\">} <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">  _need_verify = Verifier::should_verify_for(class_loader(), verify);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n<p>DumpSharedSpaces&#x9ED8;&#x8BA4;&#x4E3A;false&#xFF0C;&#x56E0;&#x6B64;&#x4F1A;&#x8D70;&#x5230;&#x4E0B;&#x9762;&#x7684;&#x5206;&#x652F;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/classfile/verifier.cpp</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">bool</span> <span class=\"hljs-title\">Verifier::should_verify_for</span><span class=\"hljs-params\">(oop class_loader, <span class=\"hljs-keyword\">bool</span> should_verify_class)</span> </span>{</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> (class_loader == <span class=\"hljs-literal\">NULL</span> || !should_verify_class) ?</span><br><span class=\"line\">    BytecodeVerificationLocal : BytecodeVerificationRemote;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x5F53;&#x524D;class_loader&#x4E3A;&#x5F53;&#x524D;classLoad&#xFF0C;&#x5E76;&#x4E14;should_verify_class&#x5728;&#x8C03;&#x7528;jvm_define_class_common&#x65B9;&#x6CD5;&#x65F6;&#x4F20;&#x503C;true</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/prims/jvm.cpp</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JVM_ENTRY(jclass, JVM_DefineClassWithSource(JNIEnv *env, <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">char</span> *name, jobject loader, <span class=\"hljs-keyword\">const</span> jbyte *buf, jsize len, jobject pd, <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">char</span> *source))</span><br><span class=\"line\">  JVMWrapper2(<span class=\"hljs-string\">&quot;JVM_DefineClassWithSource %s&quot;</span>, name);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> jvm_define_class_common(env, name, loader, buf, len, pd, source, <span class=\"hljs-literal\">true</span>, THREAD);</span><br><span class=\"line\">JVM_END</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x56E0;&#x6B64;&#x5224;&#x65AD;_need_verify&#x7684;&#x7ED3;&#x679C;&#x6700;&#x7EC8;&#x843D;&#x5230;&#x4E86;BytecodeVerificationRemote&#x4E0A;&#x3002;</p>\n<p>&#x6211;&#x4EEC;&#x5148;&#x770B;BytecodeVerificationRemote&#x5728;jvm&#x91CC;&#x7684;&#x5B9A;&#x4E49;&#xFF1A;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/runtime/globals.hpp</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">product(<span class=\"hljs-keyword\">bool</span>, BytecodeVerificationRemote, <span class=\"hljs-literal\">true</span>,                           \\</span><br><span class=\"line\">        <span class=\"hljs-string\">&quot;Enable the Java bytecode verifier for remote classes&quot;</span>)           \\</span><br></pre></td></tr></tbody></table></figure>\n<p>&#x53EF;&#x89C1;BytecodeVerificationRemote&#x5728;JVM&#x521D;&#x59CB;&#x5316;&#x7684;&#x65F6;&#x5019;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A;true&#xFF0C;&#x4EE3;&#x8868;&#x975E;JVM&#x81EA;&#x5DF1;&#x7684;&#x5BF9;&#x8C61;&#x5728;&#x52A0;&#x8F7D;&#x7684;&#x65F6;&#x5019;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x5404;&#x79CD;&#x6821;&#x9A8C;&#x3002;</p>\n<p>&#x4E3A;&#x4E86;&#x8BC1;&#x660E;&#x8FD9;&#x70B9;&#xFF0C;&#x6211;&#x4EEC;&#x518D;&#x770B;&#x770B;&#x89E3;&#x6790;&#x65B9;&#x6CD5;&#x65F6;&#x5177;&#x4F53;&#x7684;&#x903B;&#x8F91;&#xFF1A;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/classfile/classFileParser.cpp &#x2013;&gt; methodHandle ClassFileParser::parse_method()</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">if</span> (_need_verify) {</span><br><span class=\"line\">  args_size = ((flags &amp; JVM_ACC_STATIC) ? <span class=\"hljs-number\">0</span> : <span class=\"hljs-number\">1</span>) +</span><br><span class=\"line\">               verify_legal_method_signature(name, signature, CHECK_(nullHandle));</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (args_size &gt; MAX_ARGS_SIZE) {</span><br><span class=\"line\">    classfile_parse_error(<span class=\"hljs-string\">&quot;Too many arguments in method signature in class file %s&quot;</span>, CHECK_(nullHandle));</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>JVM&#x5728;&#x89E3;&#x6790;&#x65B9;&#x6CD5;&#x7684;&#x903B;&#x8F91;&#x4E2D;&#xFF0C;&#x4F1A;&#x5148;&#x5BF9;&#x65B9;&#x6CD5;&#x7684;&#x5408;&#x6CD5;&#x6027;&#x505A;&#x5404;&#x79CD;&#x6821;&#x9A8C;&#x3002;&#x5176;&#x4E2D;&#x5C31;&#x6709;&#x5BF9;&#x65B9;&#x6CD5;&#x7B7E;&#x540D;&#x7684;&#x6821;&#x9A8C;&#x3002;&#x5982;&#x679C;_need_verify&#x4E3A;false&#xFF0C;&#x5219;&#x6539;&#x6821;&#x9A8C;&#x4F1A;&#x88AB;&#x8DF3;&#x8FC7;&#x3002;</p>\n<p>&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x4E00;&#x8FDE;&#x4E32;&#x7684;&#x4EE3;&#x7801;&#x5206;&#x6790;&#xFF0C;&#x6211;&#x4EEC;&#x5F97;&#x5230;&#x4E86;BytecodeVerificationRemote&#x7684;&#x503C;&#x6700;&#x7EC8;&#x4F1A;&#x5F71;&#x54CD;Fastjson&#x901A;&#x8FC7;ASM&#x52A8;&#x6001;&#x5B57;&#x8282;&#x7801;&#x751F;&#x6210;&#x7684;&#x7C7B;&#x6587;&#x4EF6;&#x7684;&#x89E3;&#x6790;&#x3002;</p>\n<p>&#x63A5;&#x4E0B;&#x6765;&#x6211;&#x4EEC;&#x641E;&#x660E;&#x767D;BytecodeVerificationRemote&#x7684;&#x503C;&#x662F;&#x5982;&#x4F55;&#x88AB;&#x66F4;&#x6539;&#x7684;&#xFF0C;&#x8001;&#x6837;&#x5B50;&#x4EE3;&#x7801;&#x4E00;&#x987F;&#x4E71;&#x641C;&#xFF1A;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/runtime/arguments.cpp &#x2013;&gt; jint Arguments::parse_each_vm_init_arg</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">// -Xverify</span></span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (match_option(option, <span class=\"hljs-string\">&quot;-Xverify&quot;</span>, &amp;tail)) {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">strcmp</span>(tail, <span class=\"hljs-string\">&quot;:all&quot;</span>) == <span class=\"hljs-number\">0</span> || <span class=\"hljs-built_in\">strcmp</span>(tail, <span class=\"hljs-string\">&quot;&quot;</span>) == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"hljs-keyword\">bool</span>, BytecodeVerificationLocal, <span class=\"hljs-literal\">true</span>);</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"hljs-keyword\">bool</span>, BytecodeVerificationRemote, <span class=\"hljs-literal\">true</span>);</span><br><span class=\"line\">      } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">strcmp</span>(tail, <span class=\"hljs-string\">&quot;:remote&quot;</span>) == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"hljs-keyword\">bool</span>, BytecodeVerificationLocal, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"hljs-keyword\">bool</span>, BytecodeVerificationRemote, <span class=\"hljs-literal\">true</span>);</span><br><span class=\"line\">      } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">strcmp</span>(tail, <span class=\"hljs-string\">&quot;:none&quot;</span>) == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"hljs-keyword\">bool</span>, BytecodeVerificationLocal, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"hljs-keyword\">bool</span>, BytecodeVerificationRemote, <span class=\"hljs-literal\">false</span>);</span><br><span class=\"line\">      } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (is_bad_option(option, args-&gt;ignoreUnrecognized, <span class=\"hljs-string\">&quot;verification&quot;</span>)) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> JNI_EINVAL;</span><br><span class=\"line\">      }</span><br></pre></td></tr></tbody></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>Xverify</th>\n<th>BytecodeVerificationLocal</th>\n<th>BytecodeVerificationRemote</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>all &#x6216; &#x4E0D;&#x4F20;</td>\n<td>true</td>\n<td>true</td>\n</tr>\n<tr>\n<td>remote</td>\n<td>false</td>\n<td>true</td>\n</tr>\n<tr>\n<td>none</td>\n<td>false</td>\n<td>false</td>\n</tr>\n</tbody></table>\n<p>&#x987A;&#x7740;&#x8FD9;&#x4E2A;&#x601D;&#x8DEF;&#x6211;&#x4EEC;&#x518D;&#x770B;&#x770B;&#x670D;&#x52A1;&#x542F;&#x52A8;&#x65F6;&#x7684;&#x53C2;&#x6570;&#x3002;&#x7531;&#x4E8E;&#x662F;&#x91C7;&#x7528;IDEA&#x542F;&#x52A8;&#x7684;springboot&#x9879;&#x76EE;&#xFF0C;&#x6211;&#x4EEC;&#x6CA1;&#x6709;&#x624B;&#x52A8;&#x6307;&#x5B9A;&#x5404;&#x79CD;&#x542F;&#x52A8;&#x53C2;&#x6570;&#x3002;&#x8001;&#x6837;&#x5B50;&#x6211;&#x4EEC;&#x8FD8;&#x662F;&#x501F;&#x52A9;&#x5176;&#x4ED6;&#x5DE5;&#x5177;&#x8FDB;&#x884C;&#x67E5;&#x770B;&#x3002;&#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x4F7F;&#x7528;jdk&#x81EA;&#x5E26;&#x7684;VisualVM&#x3002;</p>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/visualVM.png\" alt=\"07\"></p>\n<p>&#x8FD9;&#x56DE;&#x4E8B;&#x771F;&#x76F8;&#x5927;&#x767D;&#x4E86;&#xFF0C;&#x901A;&#x8FC7;IDEA&#x9ED8;&#x8BA4;&#x542F;&#x52A8;springboot&#x9879;&#x76EE;&#x65F6;&#xFF0C;&#x4F1A;&#x9ED8;&#x8BA4;&#x5E26;&#x4E0A;<font color=\"red\">-Xverify:none</font>&#x53C2;&#x6570;&#x3002;&#x7ED3;&#x5408;&#x6211;&#x4EEC;&#x4E0A;&#x9762;&#x5BF9;JVM&#x6E90;&#x7801;&#x7684;&#x5206;&#x6790;&#xFF0C;&#x5728;Xverify==none&#x65F6;&#x3002;&#x52A0;&#x8F7D;&#x7C7B;&#x6A21;&#x677F;&#x65F6;&#x4E0D;&#x4F1A;&#x5BF9;&#x7C7B;&#x7ED3;&#x6784;&#x7684;&#x5408;&#x6CD5;&#x6027;&#x8FDB;&#x884C;&#x6821;&#x9A8C;&#xFF0C;&#x8FD9;&#x4E5F;&#x6700;&#x7EC8;&#x5BFC;&#x81F4;&#x4E86;&#x4E3A;&#x4EC0;&#x4E48;&#x65B9;&#x6CD5;&#x7B7E;&#x540D;&#x660E;&#x660E;&#x4E0D;&#x6B63;&#x786E;&#xFF0C;&#x4F46;&#x662F;JVM&#x8FD8;&#x662F;&#x6210;&#x529F;&#x7684;&#x52A0;&#x8F7D;&#x4E86;&#x8FD9;&#x4E2A;&#x7C7B;&#x3002;</p>\n<p>&#x81F3;&#x4E8E;&#x4E3A;&#x4EC0;&#x4E48;IDEA&#x542F;&#x52A8;&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x5E26;&#x4E0A;<font color=\"red\">-Xverify:none</font>&#x53C2;&#x6570;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x53C2;&#x8003;&#x5B98;&#x7F51;&#x7684;&#x4E00;&#x53E5;&#x8BDD;&#x3002;</p>\n<blockquote>\n<p><a href=\"https://www.jetbrains.com/help/idea/run-debug-configuration-spring-boot.html#configuration-tab\">https://www.jetbrains.com/help/idea/run-debug-configuration-spring-boot.html#configuration-tab</a></p>\n</blockquote>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/idea.png\" alt=\"08\"></p>\n<h2 id=\"&#x603B;&#x7ED3;\"><a href=\"#&#x603B;&#x7ED3;\" class=\"headerlink\" title=\"&#x603B;&#x7ED3;\"></a>&#x603B;&#x7ED3;</h2><p>&#x81F3;&#x6B64;&#xFF0C;&#x6574;&#x4E2A;fastjson&#x5E8F;&#x5217;&#x5316;&#x5F15;&#x8D77;&#x7684;&#x5F02;&#x5E38;&#x5DF2;&#x7ECF;&#x6392;&#x67E5;&#x5B8C;&#x4E86;&#x3002;</p>\n<p>&#x56DE;&#x987E;&#x6574;&#x4E2A;&#x6392;&#x67E5;&#x8FC7;&#x7A0B;&#x5176;&#x5B9E;&#x8FD9;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x5F15;&#x51FA;&#x4E86;&#x4E24;&#x4E2A;&#x95EE;&#x9898;&#x3002;</p>\n<ul>\n<li>&#x7B2C;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#x662F;fastjson&#x901A;&#x8FC7;ASM&#x751F;&#x6210;&#x5B57;&#x8282;&#x7801;&#x6587;&#x4EF6;&#x7684;&#x65F6;&#x5019;&#xFF0C;processValue&#x7684;&#x53C2;&#x6570;&#x4E2A;&#x6570;&#x4E0D;&#x5BF9;&#x3002;fastjson&#x5B98;&#x65B9;&#x5728;&#x540E;&#x7EED;&#x7248;&#x672C;&#x4E2D;&#x589E;&#x52A0;&#x4E86;processValue&#x7684;&#x91CD;&#x8F7D;&#x65B9;&#x6CD5;&#xFF0C;&#x4ECE;&#x800C;&#x4FEE;&#x590D;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x3002;</li>\n<li>&#x7B2C;&#x4E8C;&#x4E2A;&#x95EE;&#x9898;&#x662F;processValue&#x65B9;&#x6CD5;&#x7684;&#x65B9;&#x6CD5;&#x7B7E;&#x540D;&#x4E0D;&#x6B63;&#x786E;&#xFF0C;&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7C7B;&#x578B;&#x5199;&#x6709;&#x4E24;&#x4E2A;&#x53C2;&#x6570;&#x3002;&#x4ECE;&#x800C;&#x5F15;&#x8D77;&#x5BF9;JVM&#x89E3;&#x6790;&#x7C7B;&#x65F6;&#xFF0C;&#x65B9;&#x6CD5;&#x7B7E;&#x540D;&#x5408;&#x6CD5;&#x6027;&#x6821;&#x9A8C;&#x673A;&#x5236;&#x7684;&#x7814;&#x7A76;&#x3002;&#x5B98;&#x65B9;&#x4E5F;&#x5728;&#x540E;&#x7EED;&#x7248;&#x672C;&#x4E2D;&#x4FEE;&#x6B63;&#x4E86;&#x65B9;&#x6CD5;&#x7B7E;&#x540D;&#x7684;&#x9519;&#x8BEF;&#x3002;</li>\n</ul>\n<p>&#x4EE5;&#x4E0A;&#xFF0C;&#x867D;&#x7136;&#x8FD9;&#x6B21;&#x95EE;&#x9898;&#x7684;&#x53D1;&#x73B0;&#x548C;&#x89E3;&#x51B3;&#x90FD;&#x5F88;&#x7B80;&#x5355;&#x3002;&#x4F46;&#x662F;&#x7275;&#x626F;&#x51FA;&#x4E86;&#x4E00;&#x90E8;&#x5206;JVM&#x6E90;&#x7801;&#x7684;&#x77E5;&#x8BC6;&#xFF0C;&#x501F;&#x7531;&#x8FD9;&#x6B21;&#x673A;&#x4F1A;&#xFF0C;&#x52A0;&#x6DF1;&#x76F8;&#x5173;&#x77E5;&#x8BC6;&#x3002;</p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"fastjson","path":"tags/fastjson/"},{"name":"ASM","path":"tags/ASM/"}],"excerpt":"<html><head></head><body><p>fastjson&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x8F7B;&#x91CF;&#x7EA7;&#x7684;java&#x5E8F;&#x5217;&#x5316;&#x7C7B;&#x5E93;&#xFF0C;&#x5176;&#x6700;&#x5927;&#x7684;&#x4F18;&#x52BF;&#x5C31;&#x662F;&#x5FEB;&#xFF0C;&#x56E0;&#x6B64;&#x4E5F;&#x88AB;&#x56FD;&#x5185;&#x5404;&#x4E2A;&#x4E2D;&#x5C0F;&#x578B;&#x516C;&#x53F8;&#x5927;&#x91CF;&#x7684;&#x4F7F;&#x7528;&#x3002;&#x4F46;&#x5B83;&#x4E5F;&#x6709;&#x4E0D;&#x5C11;&#x77ED;&#x677F;&#xFF0C;&#x5982;&#x53EF;&#x5B9A;&#x5236;&#x6027;&#x4F4E;&#x3001;API&#x4E0D;&#x591F;&#x4E30;&#x5BCC;&#x3001;&#x4EE3;&#x7801;&#x8D28;&#x91CF;&#x53CA;&#x6587;&#x6863;&#x7F3A;&#x5931;&#x7B49;&#x4E00;&#x4E9B;&#x5217;&#x95EE;&#x9898;&#x4E00;&#x76F4;&#x88AB;&#x4EBA;&#x6240;&#x8BDF;&#x75C5;&#x3002;</p>\n<p>&#x672C;&#x6B21;&#x6211;&#x4EEC;&#x78B0;&#x5230;&#x7684;&#x95EE;&#x9898;&#x5C31;&#x662F;&#x7531;fastjson&#x7684;&#x4E00;&#x4E2A;&#x7B80;&#x5355;bug&#x800C;&#x5F15;&#x8D77;&#x7684;&#x4E00;&#x8FDE;&#x4E32;&#x7814;&#x7A76;&#x3002;</p></body></html>","more":"<h2 id=\"发现bug\"><a href=\"#发现bug\" class=\"headerlink\" title=\"发现bug\"></a>发现bug</h2><p>某日一位同学在调试新需求的时候发现如下错误日志：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Exception in thread <span class=\"string\">&quot;collection-eventbus-thread-1&quot;</span> java.lang.NoSuchMethodError: com.alibaba.fastjson.serializer.JavaBeanSerializer.processValue(Lcom/alibaba/fastjson/serializer/JSONSerializer;Lcom/alibaba/fastjson/serializer/BeanContext;Ljava/lang/Object;Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;Ljava/lang/Integer;</span><br><span class=\"line\">\tat com.alibaba.fastjson.serializer.ASMSerializer_6_FastJsonSerializerWrapper.writeNormal(Unknown Source)</span><br><span class=\"line\">\tat com.alibaba.fastjson.serializer.ASMSerializer_6_FastJsonSerializerWrapper.write(Unknown Source)</span><br><span class=\"line\">\tat com.alibaba.fastjson.serializer.JSONSerializer.write(JSONSerializer.java:<span class=\"number\">285</span>)</span><br><span class=\"line\">\tat com.alibaba.fastjson.JSON.toJSONString(JSON.java:<span class=\"number\">663</span>)</span><br><span class=\"line\">\tat com.alibaba.fastjson.JSON.toJSONString(JSON.java:<span class=\"number\">652</span>)</span><br><span class=\"line\">\tat com.oriente.cache.layeringCache.serializer.FastJsonRedisSerializer.serialize(FastJsonRedisSerializer.java:<span class=\"number\">37</span>)</span><br><span class=\"line\">\tat org.springframework.data.redis.core.AbstractOperations.rawValue(AbstractOperations.java:<span class=\"number\">117</span>)</span><br><span class=\"line\">\tat org.springframework.data.redis.core.DefaultValueOperations.multiSet(DefaultValueOperations.java:<span class=\"number\">136</span>)</span><br><span class=\"line\">\tat com.oriente.collection.event.listener.RedisEventListener.schedule(RedisEventListener.java:<span class=\"number\">75</span>)</span><br><span class=\"line\">\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class=\"line\">\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class=\"number\">62</span>)</span><br><span class=\"line\">\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class=\"number\">43</span>)</span><br><span class=\"line\">\tat java.lang.reflect.Method.invoke(Method.java:<span class=\"number\">498</span>)</span><br><span class=\"line\">\tat com.google.common.eventbus.Subscriber.invokeSubscriberMethod(Subscriber.java:<span class=\"number\">87</span>)</span><br><span class=\"line\">\tat com.google.common.eventbus.Subscriber$SynchronizedSubscriber.invokeSubscriberMethod(Subscriber.java:<span class=\"number\">144</span>)</span><br><span class=\"line\">\tat com.google.common.eventbus.Subscriber$<span class=\"number\">1.</span>run(Subscriber.java:<span class=\"number\">72</span>)</span><br><span class=\"line\">\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class=\"number\">1149</span>)</span><br><span class=\"line\">\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class=\"number\">624</span>)</span><br><span class=\"line\">\tat java.lang.Thread.run(Thread.java:<span class=\"number\">748</span>)</span><br></pre></td></tr></table></figure>\n\n<p>通过观察错误，很快就能定位到是fastjson序列化的时候出现了错误。同时我们也确认的代码，在自定的RedisTemplate中，针对Value的序列化工具我们的确使用了fastjson的序列化方式。</p>\n<ul>\n<li><p>RedisTemplate使用自定义的fastjoson序列化工具</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FastJsonRedisSerializer&lt;Object&gt; fastJsonRedisSerializer = <span class=\"keyword\">new</span> FastJsonRedisSerializer&lt;&gt;(Object.class);</span><br><span class=\"line\"></span><br><span class=\"line\">redisTemplate.setValueSerializer(fastJsonRedisSerializer);</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>FastJsonRedisSerializer中使用fastjson的API对统一包装类进行序列化</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Override</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">byte</span>[] serialize(T t) <span class=\"keyword\">throws</span> SerializationException &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JSON.toJSONString(<span class=\"keyword\">new</span> FastJsonSerializerWrapper(t), SerializerFeature.WriteClassName).getBytes(DEFAULT_CHARSET);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Exception e) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> SerializationException(String.format(<span class=\"string\">&quot;FastJsonRedisSerializer 序列化异常: %s, 【JSON：%s】&quot;</span>,</span><br><span class=\"line\">                e.getMessage(), JSON.toJSONString(t)), e);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<h2 id=\"分析bug\"><a href=\"#分析bug\" class=\"headerlink\" title=\"分析bug\"></a>分析bug</h2><p>经过上面的一顿排查，问题已经很明确定位到是fastjson上了，并且错误信息给的相当明确：</p>\n<p>  <font color=\"red\"> <code>java.lang.NoSuchMethodError: com.alibaba.fastjson.serializer.JavaBeanSerializer.processValue(Lcom/alibaba/fastjson/serializer/JSONSerializer;Lcom/alibaba/fastjson/serializer/BeanContext;Ljava/lang/Object;Ljava/lang/String;Ljava/lang/Object;)Ljava/lang/Object;Ljava/lang/Integer;</code> </font></p>\n<p>提示未找到JavaBeanSerializer.processValue方法。ok我们立马查询JavaBeanSerializer源码，发现processalue方法是继承自SerializeFilterable类：</p>\n<blockquote>\n<p>方法清单：com.alibaba.fastjson.serializer.JavaBeanSerializer</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">protected</span> Object <span class=\"title\">processValue</span><span class=\"params\">(JSONSerializer jsonBeanDeser, //</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                           BeanContext beanContext,</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                           Object object, //</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                           String key, //</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                           Object propertyValue, //</span></span></span><br><span class=\"line\"><span class=\"function\"><span class=\"params\">                           <span class=\"keyword\">int</span> features)</span> </span>&#123;</span><br></pre></td></tr></table></figure>\n\n<p>乍一看方法是存在的，这是我们又回到了错误本身。仔细查看错误，错误中提示我们processValue方法签名如下：</p>\n<p>入参：</p>\n<ol>\n<li>Lcom/alibaba/fastjson/serializer/JSONSerializer <font color=\"green\">–JSONSerializer类型的对象</font></li>\n<li>Lcom/alibaba/fastjson/serializer/BeanContext <font color=\"green\">–BeanContext类型的对象</font></li>\n<li>Ljava/lang/Object <font color=\"green\">–Object对象</font></li>\n<li>Ljava/lang/String <font color=\"green\">–String 类型</font></li>\n<li>Ljava/lang/Object <font color=\"green\">–Object对象</font></li>\n</ol>\n<p>返回参数：</p>\n<ol>\n<li>Ljava/lang/Object;Ljava/lang/Integer; <font color=\"green\">–这是什么鬼？java的返回参数应该是不支持两个才对啊！</font></li>\n</ol>\n<p>经过对比，果然方法签名不一致。源码中SerializeFilterable.processValue()方法中有6个入参，而错误日志中提示的只有5个入参。缺少了最后一个 <font color=\"blue\"> int features</font></p>\n<h4 id=\"问题1\"><a href=\"#问题1\" class=\"headerlink\" title=\"问题1\"></a>问题1</h4><p>从方法签名的对比我们可以发现，该错误的确是因为找不对对应的方法所导致的。由于fastjson序列化的对象是通过ASM动态生成字节码产生的，我们可以通多源码或者借助工具来验证这个bug的真实性。</p>\n<h5 id=\"1-代码验证\"><a href=\"#1-代码验证\" class=\"headerlink\" title=\"1.代码验证\"></a>1.代码验证</h5><p>fastjson在java平台下会默认使用ASM的方式动态生成序列化代理类</p>\n<blockquote>\n<p>方法清单：com.alibaba.fastjson.serializer.SerializeConfig</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span>                                       asm             = !ASMUtils.IS_ANDROID;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>方法清单：com.alibaba.fastjson.serializer.SerializeConfig</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (asm) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        ObjectSerializer asmSerializer = createASMSerializer(beanInfo);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (asmSerializer != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> asmSerializer;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// skip</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ClassFormatError e) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// skip</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (ClassCastException e) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// skip</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (OutOfMemoryError e) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e.getMessage().indexOf(<span class=\"string\">&quot;Metaspace&quot;</span>) != -<span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">throw</span> e;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// skip</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (Throwable e) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> JSONException(<span class=\"string\">&quot;create asm serializer error, verson &quot;</span> + JSON.VERSION + <span class=\"string\">&quot;, class &quot;</span> + clazz, e);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>方法清单：com.alibaba.fastjson.serializer.ASMSerializerFactory</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">_processValue</span><span class=\"params\">(MethodVisitor mw, FieldInfo fieldInfo, Context context, Label _end)</span> </span>&#123;</span><br><span class=\"line\">...</span><br><span class=\"line\">        mw.visitMethodInsn(INVOKEVIRTUAL, JavaBeanSerializer, <span class=\"string\">&quot;processValue&quot;</span>,</span><br><span class=\"line\">                           <span class=\"string\">&quot;(L&quot;</span> + JSONSerializer  + <span class=\"string\">&quot;;&quot;</span> <span class=\"comment\">//</span></span><br><span class=\"line\">                                                                          + desc(BeanContext.class) <span class=\"comment\">//</span></span><br><span class=\"line\">                                                                          + <span class=\"string\">&quot;Ljava/lang/Object;Ljava/lang/String;&quot;</span> <span class=\"comment\">//</span></span><br><span class=\"line\">                                                                          + valueDesc + <span class=\"string\">&quot;)Ljava/lang/Object;Ljava/lang/Integer;&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">                                                                          ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过上述源码，可以发现在通过ASM生成processValue方法签名时，只定义了5个参数。同时也能看到返回参数多设置了个Ljava/lang/Integer类型。</p>\n<p>依赖代码阅读，我们已经可以确定错误代码的位置了。但由于毕竟是通过ASM动态字节码生成的类和对象，实际在JVM中的类是否也像我们现在看到的一样的话，我们就需要借助其他工具来帮助我们观察了。</p>\n<h5 id=\"2-通过HSDB观察JVM中的类\"><a href=\"#2-通过HSDB观察JVM中的类\" class=\"headerlink\" title=\"2.通过HSDB观察JVM中的类\"></a>2.通过HSDB观察JVM中的类</h5><ul>\n<li>已Debug模式启动Java服务</li>\n<li>将断点设置到代理类生产逻辑后<blockquote>\n<p>方法清单：com.alibaba.fastjson.serializer.ASMSerializerFactory</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//将动态生成的字节码对象装维字节数组</span></span><br><span class=\"line\"><span class=\"keyword\">byte</span>[] code = cw.toByteArray();</span><br><span class=\"line\"><span class=\"comment\">//动态加载类</span></span><br><span class=\"line\">Class&lt;?&gt; serializerClass = classLoader.defineClassPublic(classNameFull, code, <span class=\"number\">0</span>, code.length);</span><br></pre></td></tr></table></figure>\n\n</li>\n</ul>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/classload%E6%96%AD%E7%82%B9.png\" alt=\"01\"></p>\n<ul>\n<li><p>打开HSDB</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -cp sa-jdi.jar sun.jvm.hotspot.HSDB</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>获取当前java进程</p>\n</li>\n</ul>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/jps.png\" alt=\"02\"></p>\n<ul>\n<li>HSDB attach当前java进程</li>\n</ul>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/hdbs_attach.png\" alt=\"03\"></p>\n<ul>\n<li>执行方法至断点处后，在HSDB搜索代理类</li>\n</ul>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/class_browser.png\" alt=\"04\"></p>\n<p>通过观察FastJsonSerializerWrapper.writeNormal()方法的字节码也可以发现，在调用processValue()方法的时候缺少了一个参数。</p>\n<ul>\n<li>查看FastJsonSerializerWrapper的常量池</li>\n</ul>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/constantpool.png\" alt=\"05\"></p>\n<p>查看常量池中的内容，也再次确认了processValue()方法的签名存在问题：入参不对、返回参数也有问题。</p>\n<h4 id=\"问题2\"><a href=\"#问题2\" class=\"headerlink\" title=\"问题2\"></a>问题2</h4><p>ASMSerializer_6_FastJsonSerializerWrapper.processValue()方法的返回值有两个。这会带来什么问题？为什么在类动态加载的时候JVM没有检查出方法签名的问题?</p>\n<p>预知大道，必先为史。java也一样，java的历史就是JVM。要想了解动态加载类的时候到底做了什么，我们就必须参阅JVM源码。</p>\n<p>之前阅读fastjson源码的时候，我们曾经来到这么一段代码。</p>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/classload%E6%96%AD%E7%82%B9.png\" alt=\"06\"></p>\n<p>显然源码是通过调用native方法，将类的字节流写入到JVM中的。jdk为开发者提供了丰富的类加载机制，但究其源还是依赖了这三个native方法，并且这三个方法仅仅是入参不同，其背后的实现原理其实是一样的。</p>\n<blockquote>\n<p>方法清单：java.lang.ClassLoader</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">native</span> Class&lt;?&gt; defineClass0(String name, <span class=\"keyword\">byte</span>[] b, <span class=\"keyword\">int</span> off, <span class=\"keyword\">int</span> len,</span><br><span class=\"line\">                                     ProtectionDomain pd);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">native</span> Class&lt;?&gt; defineClass1(String name, <span class=\"keyword\">byte</span>[] b, <span class=\"keyword\">int</span> off, <span class=\"keyword\">int</span> len,</span><br><span class=\"line\">                                     ProtectionDomain pd, String source);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">native</span> Class&lt;?&gt; defineClass2(String name, java.nio.ByteBuffer b,</span><br><span class=\"line\">                                     <span class=\"keyword\">int</span> off, <span class=\"keyword\">int</span> len, ProtectionDomain pd,</span><br><span class=\"line\">                                     String source);</span><br></pre></td></tr></table></figure>\n\n<h6 id=\"java-native-方法入口\"><a href=\"#java-native-方法入口\" class=\"headerlink\" title=\"java native 方法入口\"></a>java native 方法入口</h6><p>按照jni的定义规范，native方法会按照以下的格式进行定义：<br>__JNIEXPORT jclass JNICALL Java_packagepath(包路径已<em>分割)<em>方法名</em></em></p>\n<p>根据上面的规定，我们很快就能还原出defineClass1方法在jdk中的定义：<br><font color=\"blue\"> JNIEXPORT jclass JNICALL Java_java_lang_ClassLoader_defineClass1</font></p>\n<blockquote>\n<p>代码清单：src/share/native/java/lang/ClassLoader.c</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JNIEXPORT jclass JNICALL</span><br><span class=\"line\">Java_java_lang_ClassLoader_defineClass1(JNIEnv *env,</span><br><span class=\"line\">                                        jobject loader,</span><br><span class=\"line\">                                        jstring name,</span><br><span class=\"line\">                                        jbyteArray data,</span><br><span class=\"line\">                                        jint offset,</span><br><span class=\"line\">                                        jint length,</span><br><span class=\"line\">                                        jobject pd,</span><br><span class=\"line\">                                        jstring source)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    jbyte *body;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> *utfName;</span><br><span class=\"line\">    jclass result = <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> buf[<span class=\"number\">128</span>];</span><br><span class=\"line\">    <span class=\"keyword\">char</span>* utfSource;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> sourceBuf[<span class=\"number\">1024</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (data == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">        JNU_ThrowNullPointerException(env, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">/* Work around 4153825. malloc crashes on Solaris when passed a</span></span><br><span class=\"line\"><span class=\"comment\">     * negative size.</span></span><br><span class=\"line\"><span class=\"comment\">     */</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (length &lt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        JNU_ThrowArrayIndexOutOfBoundsException(env, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    body = (jbyte *)<span class=\"built_in\">malloc</span>(length);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (body == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        JNU_ThrowOutOfMemoryError(env, <span class=\"number\">0</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    (*env)-&gt;GetByteArrayRegion(env, data, offset, length, body);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ((*env)-&gt;ExceptionOccurred(env))</span><br><span class=\"line\">        <span class=\"keyword\">goto</span> free_body;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (name != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">        utfName = getUTF(env, name, buf, <span class=\"keyword\">sizeof</span>(buf));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (utfName == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">            JNU_ThrowOutOfMemoryError(env, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">            <span class=\"keyword\">goto</span> free_body;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        VerifyFixClassname(utfName);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        utfName = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (source != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">        utfSource = getUTF(env, source, sourceBuf, <span class=\"keyword\">sizeof</span>(sourceBuf));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (utfSource == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">            JNU_ThrowOutOfMemoryError(env, <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">            <span class=\"keyword\">goto</span> free_utfName;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        utfSource = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    result = JVM_DefineClassWithSource(env, utfName, loader, body, length, pd, utfSource);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (utfSource &amp;&amp; utfSource != sourceBuf)</span><br><span class=\"line\">        <span class=\"built_in\">free</span>(utfSource);</span><br><span class=\"line\"></span><br><span class=\"line\"> free_utfName:</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (utfName &amp;&amp; utfName != buf)</span><br><span class=\"line\">        <span class=\"built_in\">free</span>(utfName);</span><br><span class=\"line\"></span><br><span class=\"line\"> free_body:</span><br><span class=\"line\">    <span class=\"built_in\">free</span>(body);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>代码中调用了JVM_DefineClassWithSource方法，该方法定义在JVM源码中，下载JVM源码搜索该方法。</p>\n<blockquote>\n<p>代码清单：src/share/vm/prims/jvm.cpp</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JVM_ENTRY(jclass, JVM_DefineClassWithSource(JNIEnv *env, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *name, jobject loader, <span class=\"keyword\">const</span> jbyte *buf, jsize len, jobject pd, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *source))</span><br><span class=\"line\">  JVMWrapper2(<span class=\"string\">&quot;JVM_DefineClassWithSource %s&quot;</span>, name);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> jvm_define_class_common(env, name, loader, buf, len, pd, source, <span class=\"literal\">true</span>, THREAD);</span><br><span class=\"line\">JVM_END</span><br></pre></td></tr></table></figure>\n<p>经过一连串的内部调用,JVM才开始真正解析字节码流：</p>\n<blockquote>\n<p>src/share/vm/prims/jvm.cpp –&gt; JVM_DefineClassWithSource()</p>\n<blockquote>\n<p>src/share/vm/prims/jvm.cpp –&gt; jvm_define_class_common()</p>\n<blockquote>\n<p>src/share/vm/classfile/systemDictionary.cpp –&gt; Klass* SystemDictionary::resolve_from_stream()</p>\n<blockquote>\n<p>src/share/vm/classfile/classFileParser.cpp –&gt; instanceKlassHandle ClassFileParser::parseClassFile()</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<p>JVM首先会判断是否需要进行格式校验</p>\n<blockquote>\n<p>代码清单：src/share/vm/classfile/classFileParser.cpp</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Figure out whether we can skip format checking (matching classic VM behavior)</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (DumpSharedSpaces) &#123;</span><br><span class=\"line\">  <span class=\"comment\">// verify == true means it&#x27;s a &#x27;remote&#x27; class (i.e., non-boot class)</span></span><br><span class=\"line\">  <span class=\"comment\">// Verification decision is based on BytecodeVerificationRemote flag</span></span><br><span class=\"line\">  <span class=\"comment\">// for those classes.</span></span><br><span class=\"line\">  _need_verify = (verify) ? BytecodeVerificationRemote :</span><br><span class=\"line\">                            BytecodeVerificationLocal;</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">  _need_verify = Verifier::should_verify_for(class_loader(), verify);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>DumpSharedSpaces默认为false，因此会走到下面的分支</p>\n<blockquote>\n<p>代码清单：src/share/vm/classfile/verifier.cpp</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">bool</span> <span class=\"title\">Verifier::should_verify_for</span><span class=\"params\">(oop class_loader, <span class=\"keyword\">bool</span> should_verify_class)</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> (class_loader == <span class=\"literal\">NULL</span> || !should_verify_class) ?</span><br><span class=\"line\">    BytecodeVerificationLocal : BytecodeVerificationRemote;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>当前class_loader为当前classLoad，并且should_verify_class在调用jvm_define_class_common方法时传值true</p>\n<blockquote>\n<p>代码清单：src/share/vm/prims/jvm.cpp</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JVM_ENTRY(jclass, JVM_DefineClassWithSource(JNIEnv *env, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *name, jobject loader, <span class=\"keyword\">const</span> jbyte *buf, jsize len, jobject pd, <span class=\"keyword\">const</span> <span class=\"keyword\">char</span> *source))</span><br><span class=\"line\">  JVMWrapper2(<span class=\"string\">&quot;JVM_DefineClassWithSource %s&quot;</span>, name);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">return</span> jvm_define_class_common(env, name, loader, buf, len, pd, source, <span class=\"literal\">true</span>, THREAD);</span><br><span class=\"line\">JVM_END</span><br></pre></td></tr></table></figure>\n\n<p>因此判断_need_verify的结果最终落到了BytecodeVerificationRemote上。</p>\n<p>我们先看BytecodeVerificationRemote在jvm里的定义：</p>\n<blockquote>\n<p>代码清单：src/share/vm/runtime/globals.hpp</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">product(<span class=\"keyword\">bool</span>, BytecodeVerificationRemote, <span class=\"literal\">true</span>,                           \\</span><br><span class=\"line\">        <span class=\"string\">&quot;Enable the Java bytecode verifier for remote classes&quot;</span>)           \\</span><br></pre></td></tr></table></figure>\n<p>可见BytecodeVerificationRemote在JVM初始化的时候默认值为true，代表非JVM自己的对象在加载的时候需要进行各种校验。</p>\n<p>为了证明这点，我们再看看解析方法时具体的逻辑：</p>\n<blockquote>\n<p>代码清单：src/share/vm/classfile/classFileParser.cpp –&gt; methodHandle ClassFileParser::parse_method()</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (_need_verify) &#123;</span><br><span class=\"line\">  args_size = ((flags &amp; JVM_ACC_STATIC) ? <span class=\"number\">0</span> : <span class=\"number\">1</span>) +</span><br><span class=\"line\">               verify_legal_method_signature(name, signature, CHECK_(nullHandle));</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (args_size &gt; MAX_ARGS_SIZE) &#123;</span><br><span class=\"line\">    classfile_parse_error(<span class=\"string\">&quot;Too many arguments in method signature in class file %s&quot;</span>, CHECK_(nullHandle));</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>JVM在解析方法的逻辑中，会先对方法的合法性做各种校验。其中就有对方法签名的校验。如果_need_verify为false，则改校验会被跳过。</p>\n<p>通过上面的一连串的代码分析，我们得到了BytecodeVerificationRemote的值最终会影响Fastjson通过ASM动态字节码生成的类文件的解析。</p>\n<p>接下来我们搞明白BytecodeVerificationRemote的值是如何被更改的，老样子代码一顿乱搜：</p>\n<blockquote>\n<p>代码清单：src/share/vm/runtime/arguments.cpp –&gt; jint Arguments::parse_each_vm_init_arg</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// -Xverify</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (match_option(option, <span class=\"string\">&quot;-Xverify&quot;</span>, &amp;tail)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(tail, <span class=\"string\">&quot;:all&quot;</span>) == <span class=\"number\">0</span> || <span class=\"built_in\">strcmp</span>(tail, <span class=\"string\">&quot;&quot;</span>) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"keyword\">bool</span>, BytecodeVerificationLocal, <span class=\"literal\">true</span>);</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"keyword\">bool</span>, BytecodeVerificationRemote, <span class=\"literal\">true</span>);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(tail, <span class=\"string\">&quot;:remote&quot;</span>) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"keyword\">bool</span>, BytecodeVerificationLocal, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"keyword\">bool</span>, BytecodeVerificationRemote, <span class=\"literal\">true</span>);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(tail, <span class=\"string\">&quot;:none&quot;</span>) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"keyword\">bool</span>, BytecodeVerificationLocal, <span class=\"literal\">false</span>);</span><br><span class=\"line\">        FLAG_SET_CMDLINE(<span class=\"keyword\">bool</span>, BytecodeVerificationRemote, <span class=\"literal\">false</span>);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (is_bad_option(option, args-&gt;ignoreUnrecognized, <span class=\"string\">&quot;verification&quot;</span>)) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> JNI_EINVAL;</span><br><span class=\"line\">      &#125;</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>Xverify</th>\n<th>BytecodeVerificationLocal</th>\n<th>BytecodeVerificationRemote</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>all 或 不传</td>\n<td>true</td>\n<td>true</td>\n</tr>\n<tr>\n<td>remote</td>\n<td>false</td>\n<td>true</td>\n</tr>\n<tr>\n<td>none</td>\n<td>false</td>\n<td>false</td>\n</tr>\n</tbody></table>\n<p>顺着这个思路我们再看看服务启动时的参数。由于是采用IDEA启动的springboot项目，我们没有手动指定各种启动参数。老样子我们还是借助其他工具进行查看。这次我们使用jdk自带的VisualVM。</p>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/visualVM.png\" alt=\"07\"></p>\n<p>这回事真相大白了，通过IDEA默认启动springboot项目时，会默认带上<font color=\"red\">-Xverify:none</font>参数。结合我们上面对JVM源码的分析，在Xverify==none时。加载类模板时不会对类结构的合法性进行校验，这也最终导致了为什么方法签名明明不正确，但是JVM还是成功的加载了这个类。</p>\n<p>至于为什么IDEA启动的时候会带上<font color=\"red\">-Xverify:none</font>参数，我们可以参考官网的一句话。</p>\n<blockquote>\n<p><a href=\"https://www.jetbrains.com/help/idea/run-debug-configuration-spring-boot.html#configuration-tab\">https://www.jetbrains.com/help/idea/run-debug-configuration-spring-boot.html#configuration-tab</a></p>\n</blockquote>\n<p><img src=\"/2020/08/17/fastjson%E5%BA%8F%E5%88%97%E5%8C%96%E5%BC%82%E5%B8%B8%E6%8E%92%E6%9F%A5/idea.png\" alt=\"08\"></p>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p>至此，整个fastjson序列化引起的异常已经排查完了。</p>\n<p>回顾整个排查过程其实这一个错误引出了两个问题。</p>\n<ul>\n<li>第一个问题是fastjson通过ASM生成字节码文件的时候，processValue的参数个数不对。fastjson官方在后续版本中增加了processValue的重载方法，从而修复这个问题。</li>\n<li>第二个问题是processValue方法的方法签名不正确，方法返回类型写有两个参数。从而引起对JVM解析类时，方法签名合法性校验机制的研究。官方也在后续版本中修正了方法签名的错误。</li>\n</ul>\n<p>以上，虽然这次问题的发现和解决都很简单。但是牵扯出了一部分JVM源码的知识，借由这次机会，加深相关知识。</p>"},{"title":"我为什么会手撸一个配置中心-代码篇","date":"2020-04-18T07:12:58.000Z","_content":"\n上期我们确定了以Spring的方向和采用Redis来做配置关系，我们就开始围绕这两个大头具体的开始设计客户端功能。\n\n## 1.让Spring启动我们的配置中心客户端\n我们定义了配置中心的启动注解。同大多数Spring的整合项目一样，不仅能通过启动注解启用功能，同时还能对配置的应用进行初始设定。\n<!-- more -->\n``` java\n@Retention(RetentionPolicy.RUNTIME)\n@Target(ElementType.TYPE)\n@Documented\n@Import(ConfigRegistrar.class)\npublic @interface EnableNadiaConfig {\n    //启用环境\n    //未设置时所有环境启动\n    String[] actives() default {};\n\n    //指定配置所属的Application\n    String application() default \"\";\n\n    //默认分组\n    //未设置时为默认分组\n    String group() default \"\";\n\n    //指定配置的包路径，避免解析无用的配置\n    String[] basePackages() default {};\n}\n```\n\n## 2.注册配置中心相关类\n通过实现ImportBeanDefinitionRegistrar方法我们可以获得Bean定义的注册器，此时就可以将我们的功能优雅的注册至spring生命周期内。\n\n值得注意的是，我们设计时采用了spi的方式，在实现的时候采用的是Redis。这就意味着未来如果我们想更换配置管理的方式，完全可以继承现有接口实现一套新的机制。为未来的拓展提供了可能性。\n\n``` java\npublic class ConfigRegistrar implements ImportBeanDefinitionRegistrar, EnvironmentAware {\n\n    .....\n\n    @Override\n    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {\n        AnnotationAttributes attributes = AnnotationAttributes\n                .fromMap(importingClassMetadata.getAnnotationAttributes(EnableNadiaConfig.class.getName()));\n\n        //检查是否需要启动\n        if (!enableConfig(importingClassMetadata, attributes)) {\n            return;\n        }\n\n        //初始化需要扫描的包\n        ConfigRegistrar.setBasePackages(attributes);\n\n        //工具\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, SpringUtils.class.getName(), SpringUtils.class);\n\n        //收集本地环境变量、生成服务信息\n        //----->SPI实现，本地变量的手机和Service端显示的服务信息可自定义实现\n        Map<String, Object> envPropertyValues = new HashMap<>();\n        envPropertyValues.put(\"importingClassMetadata\", importingClassMetadata);\n        InitEnvironment env = SpiServiceUtil.loadFirst(InitEnvironment.class);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, InitEnvironment.class.getName(), env.getClass(), envPropertyValues);\n\n        //收集本地配置&回调方法\n        Map<String, Object> processorPropertyValues = new HashMap<>();\n        processorPropertyValues.put(\"importingClassMetadata\", importingClassMetadata);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, SpringValueProcessor.class.getName(), SpringValueProcessor.class, processorPropertyValues);\n\n        //启动器注册\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigPostConstructProcessor.class.getName(), ConfigPostConstructProcessor.class);\n\n        //redis装载\n        ConfigCenter configCenter = SpiServiceUtil.loadFirst(ConfigCenter.class);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigCenter.class.getName(), configCenter.getClass());\n\n        //按照本地环境变量收集redis中的配置（）\n        //向redis提供当前服务信息\n        //------>SPI实现，可替换redis为其他中间件\n        LoadConfig loadConfig = SpiServiceUtil.loadFirst(LoadConfig.class);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, LoadConfig.class.getName(), loadConfig.getClass());\n\n        //配置变更订阅\n        Listener listener = SpiServiceUtil.loadFirst(Listener.class);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, Listener.class.getName(), listener.getClass());\n\n        //客户端通知服务端\n        NotifyFactory notifyFactory = SpiServiceUtil.loadFirst(NotifyFactory.class);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, NotifyFactory.class.getName(), notifyFactory.getClass());\n\n        //配置变更启动类\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigPostConstructProcessor.class.getName(), ConfigPostConstructProcessor.class);\n\n        //spring容器关闭时，销毁当前实例信息\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ApplicationEventListener.class.getName(), ApplicationEventListener.class);\n\n    }\n```\n\n## 3.客户端配置的统一收集\n收集配置时，考虑到把对开发人员的代码侵入性降到最低，我们决定针对Spring自身@Value注解和@ConfigurationProperties注解进行收集。好处是开发人员无需引入其他的学习成本，在不变更现有开发模式下就能进行配置项的收集与管理。\n\n此外，针对配置管理的一些特殊更能，我们设计了扫包路径。开发人员可以根据需要设定扫包路径，从而对关心的配置进行远程管理。同时我们提供了@NadiaConfig注解，一旦标记上该注解后。开发人员可以针对配置的变更进行自定义的回调处理。\n\n```java\n@Target({ElementType.FIELD,ElementType.CONSTRUCTOR})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface NadiaConfig {\n    Class<? extends Callback> clazz();\n\n    CallbackScenes[] callbackScenes() default {CallbackScenes.UPDATE_VALUE, CallbackScenes.SWITCH_GROUP};\n\n    boolean exclude() default false;\n\n    enum CallbackScenes {\n        INIT,\n        SWITCH_GROUP,\n        UPDATE_VALUE,\n    }\n}\n```\n\n实现BeanPostProcessor接口后，在Bean的后置处理逻辑中我们会收集指定包下的配置\n\n```java\npublic class SpringValueProcessor extends AbstractMetadata implements BeanPostProcessor, PriorityOrdered {\n\n    ....\n\n    private void processField(Object bean, String beanName, Field field) {\n        // register @Value on field\n        Value value = field.getAnnotation(Value.class);\n        if (value == null) {\n            return;\n        }\n        Set<String> keys = PlaceholderHelper.extractPlaceholderKeys(value.value());\n        if (keys.isEmpty()) {\n            return;\n        }\n\n        for (String key : keys) {\n            Config config = generateConfig(bean, beanName, key, field);\n            ConfigContextHolder.setConfigHolder(key, config);\n        }\n    }\n\n    private Config generateConfig(Object bean, String beanName, String key, Field field) {\n        NadiaConfig nadiaConfig = field.getAnnotation(NadiaConfig.class);\n        Class<? extends Callback> callback = null;\n        Set<NadiaConfig.CallbackScenes> callbackScenesSet = null;\n        if (nadiaConfig != null) {\n            if(nadiaConfig.exclude()){\n                return null;\n            }\n            callback = nadiaConfig.clazz();\n            callbackScenesSet = getCallbackScenes(nadiaConfig);\n        }\n        return new Config(ConfigTypeEnum.FIELD,\n                beanName,\n                bean.getClass(),\n                key, field,\n                null,\n                FieldUtil.getValue(bean, field),\n                callback,\n                callbackScenesSet,\n                field.getType(),\n                bean);\n    }\n\n    ....\n}\n```\n\n## 4.启动配置本地配置更新的模板流程\n可以看到，模板模式指定了一套远程配置更新至本地的流程。结合SPI的特性，可以存在多种的实现方式。\n\n```java\n@Component\npublic class ConfigBootstart {\n\n    @Autowired\n    private InitEnvironment initEnvironment;\n    @Autowired\n    private LoadConfig loadConfig;\n    @Autowired\n    private Listener listener;\n    @Autowired\n    private NotifyFactory notifyFactory;\n\n    public void start(){\n        //bootstart notify start\n        notifyFactory.startPush();\n        //env\n        initEnvironment.init();\n        //config\n        loadConfig.load();\n        loadConfig.updateClientValues();\n        loadConfig.onlineClientInGroup();\n        loadConfig.pushClientConfigs();\n        loadConfig.keepClientAlive();\n        //watch\n        listener.init();\n        //bootstart notify end\n        notifyFactory.stopPush();\n    }\n\n}\n```\n\n## 5.Redis实现配置的更新，客户端的上下线\n这里我们用Redis实现AbstractLoadConfig定义好的模板方法，包括配置从redis的拉取、更新本地配置、客户端心跳的上报、客户端上线通知、客户端下线通知\n\n\n```java\npublic class RedisLoadConfig extends AbstractLoadConfig {\n    @Resource\n    private ConfigCenterRedisService configCenterRedisService;\n    @Resource\n    private RedisPubSub redisPubSub;\n\n    @Override\n    public void load() {\n        //get redis info\n        this.load(initEnvironment.getClientInfo().getApplication(), initEnvironment.getClientInfo().getGroup());\n    }\n\n    @Override\n    public void load(String application, String group) {\n        String configKey = RedisKeyUtil.getGroupConfig(application, group);\n        Map<String, String> configs = configCenterRedisService.hgetAll(configKey);\n        RemoteContextHolder.setRemoteHolder(configKey, configs);\n    }\n\n    @Override\n    public Object getValue(String key) {\n        return null;\n    }\n\n    @Override\n    public void onlineClientInGroup() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        String applicationGroup = RedisKeyUtil.getInstance(clientInfo.getApplication(), clientInfo.getGroup());\n        configCenterRedisService.sadd(applicationGroup, clientInfo.getName());\n        log.info(\"========================= onlineClientInGroup key[{}] value[{}] =========================\", applicationGroup, clientInfo.getName());\n    }\n\n    @Override\n    public void offlineClientInGroup() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        String applicationGroup = RedisKeyUtil.getInstance(clientInfo.getApplication(), clientInfo.getGroup());\n        configCenterRedisService.del(applicationGroup, clientInfo.getName());\n        log.info(\"========================= offlineClientInGroup key[{}] value[{}] =========================\", applicationGroup, clientInfo.getName());\n    }\n\n    @Override\n    public void offlineClientConfigs() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        String instanceConfig = RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName());\n        configCenterRedisService.del(instanceConfig);\n        log.info(\"========================= offlineClientConfigs key[{}] =========================\", instanceConfig);\n    }\n\n    @Override\n    public void keepClientAlive() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        //push client info to redis schedule\n        Executors.newScheduledThreadPool(1).scheduleAtFixedRate(new Runnable() {\n            @Override\n            public void run() {\n                log.info(\"========================= Client Keep Alive with Redis Start =========================\");\n                clientInfo.setTimestamp(new Date().getTime());\n                String hashCode = String.valueOf(clientInfo.hashCode());\n                log.info(\"========================= Client Keep Alive hashCode:[{}] clientInfo:[{}] =========================\", hashCode, clientInfo);\n                configCenterRedisService.hset(RedisKeyUtil.getClints(), hashCode, JSONObject.toJSONString(clientInfo));\n                log.info(\"========================= Client Keep Alive with Redis End   =========================\");\n            }\n        }, 0, 1, TimeUnit.MINUTES);\n    }\n\n    @Override\n    public void pushClientConfig(String key, String value) {\n        String configKey = RedisKeyUtil.getInstanceConfig(initEnvironment.getClientInfo().getApplication(),\n                initEnvironment.getClientInfo().getGroup(), initEnvironment.getClientInfo().getName());\n        configCenterRedisService.hset(configKey, key, value);\n    }\n\n    @Override\n    public void pushClientConfigs() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        configCenterRedisService.del(RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName()));\n        Map<String, String> clientConfigs = ConfigContextHolder.getClientConfigs();\n        clientConfigs.forEach((k, v) -> {\n            configCenterRedisService.hset(RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName()), k, v);\n        });\n    }\n\n    @Override\n    protected void notificServer(String message,EventType type , LogLevelEnum level) {\n        redisPubSub.notifyServer(initEnvironment.getClientInfo(), type, level,message);\n    }\n\n    @Override\n    public void offlineClientInfo() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        configCenterRedisService.del(RedisKeyUtil.getClints(),String.valueOf(clientInfo.hashCode()));\n        log.info(\"========================= delete client info  key[{}] value[{}]=========================\", RedisKeyUtil.getClints(),clientInfo.hashCode());\n    }\n\n    @Override\n    public void pushClinetInfo() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        configCenterRedisService.hset(RedisKeyUtil.getClints(), String.valueOf(clientInfo.hashCode()), JSONObject.toJSONString(clientInfo));\n        log.info(\"========================= push client info  key[{}] value[{}]=========================\", RedisKeyUtil.getClints(),clientInfo.hashCode());\n    }\n}\n```\n\n## 6.Redis实现远程配置的实时同步\n配置信息的实时同步主要采用了Redis的监听功能，客户端启动后监听特殊通道的信息，并剥离出自己感兴趣的信息进行处理。\n\n```java\nclass MyMessageListener implements MessageListener {\n\n        private LoadConfig loadConfig;\n\n        MyMessageListener(LoadConfig loadConfig) {\n            this.loadConfig = loadConfig;\n        }\n\n        @Override\n        public void onMessage(Message message, byte[] pattern) {\n            notifyFactory.startPush();\n            MessageBody messageBody = MessageConvert.unpackageMessage(message.toString());\n            if (messageBody instanceof UpdateValueMessageBody) {\n                log.info(\"receive UpdateValueMessageBody start\");\n                redisPubSub.notifyServer(initEnvironment.getClientInfo(), EventType.CLIENT_MESSAGE, LogLevelEnum.LOG,\"receive UpdateValueMessageBody start\");\n                UpdateValueMessageBody updateValueMessageBody = (UpdateValueMessageBody) messageBody;\n                String group = initEnvironment.getClientInfo().getGroup();\n                if (group.equals(updateValueMessageBody.getGroup())) {\n                    //updateClientValue local value\n                    boolean hasFaile = loadConfig.updateClientValue(updateValueMessageBody.getKey(), updateValueMessageBody.getValue(), NadiaConfig.CallbackScenes.UPDATE_VALUE);\n                    if(!hasFaile){\n                        Object oldValue = ConfigContextHolder.getOldValue(updateValueMessageBody.getKey());\n                        // update server value\n                        loadConfig.pushClientConfig(updateValueMessageBody.getKey(), ClientValueUtil.serializer(updateValueMessageBody.getValue(), oldValue));\n                    }\n                }\n            } else if (messageBody instanceof SwitchInstanceMessageBody) {\n                log.info(\"receive SwitchInstanceMessageBody start\");\n                redisPubSub.notifyServer(initEnvironment.getClientInfo(), EventType.CLIENT_MESSAGE, LogLevelEnum.LOG,\"receive SwitchInstanceMessageBody start\");\n                SwitchInstanceMessageBody switchInstanceMessageBody = (SwitchInstanceMessageBody) messageBody;\n                //update local value\n                loadConfig.switchGroup(switchInstanceMessageBody.getApplication(),switchInstanceMessageBody.getGroupFrom(),switchInstanceMessageBody.getGroupTo(),switchInstanceMessageBody.getInstance());\n            } else if (messageBody instanceof HeartbeatMessageBody) {\n                log.info(\"receive HeartbeatMessageBody\");\n\n            }\n            notifyFactory.stopPush();\n        }\n    }\n```\n\n\n","source":"_posts/我为什么会重新写一个配置中心-代码篇.md","raw":"---\ntitle: 我为什么会手撸一个配置中心-代码篇\ndate: 2020-04-18 15:12:58\ntags: \n    - Java\n    - Redis\n    - 配置中心\ncategories :\n    - Technology\n---\n\n上期我们确定了以Spring的方向和采用Redis来做配置关系，我们就开始围绕这两个大头具体的开始设计客户端功能。\n\n## 1.让Spring启动我们的配置中心客户端\n我们定义了配置中心的启动注解。同大多数Spring的整合项目一样，不仅能通过启动注解启用功能，同时还能对配置的应用进行初始设定。\n<!-- more -->\n``` java\n@Retention(RetentionPolicy.RUNTIME)\n@Target(ElementType.TYPE)\n@Documented\n@Import(ConfigRegistrar.class)\npublic @interface EnableNadiaConfig {\n    //启用环境\n    //未设置时所有环境启动\n    String[] actives() default {};\n\n    //指定配置所属的Application\n    String application() default \"\";\n\n    //默认分组\n    //未设置时为默认分组\n    String group() default \"\";\n\n    //指定配置的包路径，避免解析无用的配置\n    String[] basePackages() default {};\n}\n```\n\n## 2.注册配置中心相关类\n通过实现ImportBeanDefinitionRegistrar方法我们可以获得Bean定义的注册器，此时就可以将我们的功能优雅的注册至spring生命周期内。\n\n值得注意的是，我们设计时采用了spi的方式，在实现的时候采用的是Redis。这就意味着未来如果我们想更换配置管理的方式，完全可以继承现有接口实现一套新的机制。为未来的拓展提供了可能性。\n\n``` java\npublic class ConfigRegistrar implements ImportBeanDefinitionRegistrar, EnvironmentAware {\n\n    .....\n\n    @Override\n    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {\n        AnnotationAttributes attributes = AnnotationAttributes\n                .fromMap(importingClassMetadata.getAnnotationAttributes(EnableNadiaConfig.class.getName()));\n\n        //检查是否需要启动\n        if (!enableConfig(importingClassMetadata, attributes)) {\n            return;\n        }\n\n        //初始化需要扫描的包\n        ConfigRegistrar.setBasePackages(attributes);\n\n        //工具\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, SpringUtils.class.getName(), SpringUtils.class);\n\n        //收集本地环境变量、生成服务信息\n        //----->SPI实现，本地变量的手机和Service端显示的服务信息可自定义实现\n        Map<String, Object> envPropertyValues = new HashMap<>();\n        envPropertyValues.put(\"importingClassMetadata\", importingClassMetadata);\n        InitEnvironment env = SpiServiceUtil.loadFirst(InitEnvironment.class);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, InitEnvironment.class.getName(), env.getClass(), envPropertyValues);\n\n        //收集本地配置&回调方法\n        Map<String, Object> processorPropertyValues = new HashMap<>();\n        processorPropertyValues.put(\"importingClassMetadata\", importingClassMetadata);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, SpringValueProcessor.class.getName(), SpringValueProcessor.class, processorPropertyValues);\n\n        //启动器注册\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigPostConstructProcessor.class.getName(), ConfigPostConstructProcessor.class);\n\n        //redis装载\n        ConfigCenter configCenter = SpiServiceUtil.loadFirst(ConfigCenter.class);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigCenter.class.getName(), configCenter.getClass());\n\n        //按照本地环境变量收集redis中的配置（）\n        //向redis提供当前服务信息\n        //------>SPI实现，可替换redis为其他中间件\n        LoadConfig loadConfig = SpiServiceUtil.loadFirst(LoadConfig.class);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, LoadConfig.class.getName(), loadConfig.getClass());\n\n        //配置变更订阅\n        Listener listener = SpiServiceUtil.loadFirst(Listener.class);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, Listener.class.getName(), listener.getClass());\n\n        //客户端通知服务端\n        NotifyFactory notifyFactory = SpiServiceUtil.loadFirst(NotifyFactory.class);\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, NotifyFactory.class.getName(), notifyFactory.getClass());\n\n        //配置变更启动类\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigPostConstructProcessor.class.getName(), ConfigPostConstructProcessor.class);\n\n        //spring容器关闭时，销毁当前实例信息\n        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ApplicationEventListener.class.getName(), ApplicationEventListener.class);\n\n    }\n```\n\n## 3.客户端配置的统一收集\n收集配置时，考虑到把对开发人员的代码侵入性降到最低，我们决定针对Spring自身@Value注解和@ConfigurationProperties注解进行收集。好处是开发人员无需引入其他的学习成本，在不变更现有开发模式下就能进行配置项的收集与管理。\n\n此外，针对配置管理的一些特殊更能，我们设计了扫包路径。开发人员可以根据需要设定扫包路径，从而对关心的配置进行远程管理。同时我们提供了@NadiaConfig注解，一旦标记上该注解后。开发人员可以针对配置的变更进行自定义的回调处理。\n\n```java\n@Target({ElementType.FIELD,ElementType.CONSTRUCTOR})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\npublic @interface NadiaConfig {\n    Class<? extends Callback> clazz();\n\n    CallbackScenes[] callbackScenes() default {CallbackScenes.UPDATE_VALUE, CallbackScenes.SWITCH_GROUP};\n\n    boolean exclude() default false;\n\n    enum CallbackScenes {\n        INIT,\n        SWITCH_GROUP,\n        UPDATE_VALUE,\n    }\n}\n```\n\n实现BeanPostProcessor接口后，在Bean的后置处理逻辑中我们会收集指定包下的配置\n\n```java\npublic class SpringValueProcessor extends AbstractMetadata implements BeanPostProcessor, PriorityOrdered {\n\n    ....\n\n    private void processField(Object bean, String beanName, Field field) {\n        // register @Value on field\n        Value value = field.getAnnotation(Value.class);\n        if (value == null) {\n            return;\n        }\n        Set<String> keys = PlaceholderHelper.extractPlaceholderKeys(value.value());\n        if (keys.isEmpty()) {\n            return;\n        }\n\n        for (String key : keys) {\n            Config config = generateConfig(bean, beanName, key, field);\n            ConfigContextHolder.setConfigHolder(key, config);\n        }\n    }\n\n    private Config generateConfig(Object bean, String beanName, String key, Field field) {\n        NadiaConfig nadiaConfig = field.getAnnotation(NadiaConfig.class);\n        Class<? extends Callback> callback = null;\n        Set<NadiaConfig.CallbackScenes> callbackScenesSet = null;\n        if (nadiaConfig != null) {\n            if(nadiaConfig.exclude()){\n                return null;\n            }\n            callback = nadiaConfig.clazz();\n            callbackScenesSet = getCallbackScenes(nadiaConfig);\n        }\n        return new Config(ConfigTypeEnum.FIELD,\n                beanName,\n                bean.getClass(),\n                key, field,\n                null,\n                FieldUtil.getValue(bean, field),\n                callback,\n                callbackScenesSet,\n                field.getType(),\n                bean);\n    }\n\n    ....\n}\n```\n\n## 4.启动配置本地配置更新的模板流程\n可以看到，模板模式指定了一套远程配置更新至本地的流程。结合SPI的特性，可以存在多种的实现方式。\n\n```java\n@Component\npublic class ConfigBootstart {\n\n    @Autowired\n    private InitEnvironment initEnvironment;\n    @Autowired\n    private LoadConfig loadConfig;\n    @Autowired\n    private Listener listener;\n    @Autowired\n    private NotifyFactory notifyFactory;\n\n    public void start(){\n        //bootstart notify start\n        notifyFactory.startPush();\n        //env\n        initEnvironment.init();\n        //config\n        loadConfig.load();\n        loadConfig.updateClientValues();\n        loadConfig.onlineClientInGroup();\n        loadConfig.pushClientConfigs();\n        loadConfig.keepClientAlive();\n        //watch\n        listener.init();\n        //bootstart notify end\n        notifyFactory.stopPush();\n    }\n\n}\n```\n\n## 5.Redis实现配置的更新，客户端的上下线\n这里我们用Redis实现AbstractLoadConfig定义好的模板方法，包括配置从redis的拉取、更新本地配置、客户端心跳的上报、客户端上线通知、客户端下线通知\n\n\n```java\npublic class RedisLoadConfig extends AbstractLoadConfig {\n    @Resource\n    private ConfigCenterRedisService configCenterRedisService;\n    @Resource\n    private RedisPubSub redisPubSub;\n\n    @Override\n    public void load() {\n        //get redis info\n        this.load(initEnvironment.getClientInfo().getApplication(), initEnvironment.getClientInfo().getGroup());\n    }\n\n    @Override\n    public void load(String application, String group) {\n        String configKey = RedisKeyUtil.getGroupConfig(application, group);\n        Map<String, String> configs = configCenterRedisService.hgetAll(configKey);\n        RemoteContextHolder.setRemoteHolder(configKey, configs);\n    }\n\n    @Override\n    public Object getValue(String key) {\n        return null;\n    }\n\n    @Override\n    public void onlineClientInGroup() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        String applicationGroup = RedisKeyUtil.getInstance(clientInfo.getApplication(), clientInfo.getGroup());\n        configCenterRedisService.sadd(applicationGroup, clientInfo.getName());\n        log.info(\"========================= onlineClientInGroup key[{}] value[{}] =========================\", applicationGroup, clientInfo.getName());\n    }\n\n    @Override\n    public void offlineClientInGroup() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        String applicationGroup = RedisKeyUtil.getInstance(clientInfo.getApplication(), clientInfo.getGroup());\n        configCenterRedisService.del(applicationGroup, clientInfo.getName());\n        log.info(\"========================= offlineClientInGroup key[{}] value[{}] =========================\", applicationGroup, clientInfo.getName());\n    }\n\n    @Override\n    public void offlineClientConfigs() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        String instanceConfig = RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName());\n        configCenterRedisService.del(instanceConfig);\n        log.info(\"========================= offlineClientConfigs key[{}] =========================\", instanceConfig);\n    }\n\n    @Override\n    public void keepClientAlive() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        //push client info to redis schedule\n        Executors.newScheduledThreadPool(1).scheduleAtFixedRate(new Runnable() {\n            @Override\n            public void run() {\n                log.info(\"========================= Client Keep Alive with Redis Start =========================\");\n                clientInfo.setTimestamp(new Date().getTime());\n                String hashCode = String.valueOf(clientInfo.hashCode());\n                log.info(\"========================= Client Keep Alive hashCode:[{}] clientInfo:[{}] =========================\", hashCode, clientInfo);\n                configCenterRedisService.hset(RedisKeyUtil.getClints(), hashCode, JSONObject.toJSONString(clientInfo));\n                log.info(\"========================= Client Keep Alive with Redis End   =========================\");\n            }\n        }, 0, 1, TimeUnit.MINUTES);\n    }\n\n    @Override\n    public void pushClientConfig(String key, String value) {\n        String configKey = RedisKeyUtil.getInstanceConfig(initEnvironment.getClientInfo().getApplication(),\n                initEnvironment.getClientInfo().getGroup(), initEnvironment.getClientInfo().getName());\n        configCenterRedisService.hset(configKey, key, value);\n    }\n\n    @Override\n    public void pushClientConfigs() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        configCenterRedisService.del(RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName()));\n        Map<String, String> clientConfigs = ConfigContextHolder.getClientConfigs();\n        clientConfigs.forEach((k, v) -> {\n            configCenterRedisService.hset(RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName()), k, v);\n        });\n    }\n\n    @Override\n    protected void notificServer(String message,EventType type , LogLevelEnum level) {\n        redisPubSub.notifyServer(initEnvironment.getClientInfo(), type, level,message);\n    }\n\n    @Override\n    public void offlineClientInfo() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        configCenterRedisService.del(RedisKeyUtil.getClints(),String.valueOf(clientInfo.hashCode()));\n        log.info(\"========================= delete client info  key[{}] value[{}]=========================\", RedisKeyUtil.getClints(),clientInfo.hashCode());\n    }\n\n    @Override\n    public void pushClinetInfo() {\n        ClientInfo clientInfo = initEnvironment.getClientInfo();\n        configCenterRedisService.hset(RedisKeyUtil.getClints(), String.valueOf(clientInfo.hashCode()), JSONObject.toJSONString(clientInfo));\n        log.info(\"========================= push client info  key[{}] value[{}]=========================\", RedisKeyUtil.getClints(),clientInfo.hashCode());\n    }\n}\n```\n\n## 6.Redis实现远程配置的实时同步\n配置信息的实时同步主要采用了Redis的监听功能，客户端启动后监听特殊通道的信息，并剥离出自己感兴趣的信息进行处理。\n\n```java\nclass MyMessageListener implements MessageListener {\n\n        private LoadConfig loadConfig;\n\n        MyMessageListener(LoadConfig loadConfig) {\n            this.loadConfig = loadConfig;\n        }\n\n        @Override\n        public void onMessage(Message message, byte[] pattern) {\n            notifyFactory.startPush();\n            MessageBody messageBody = MessageConvert.unpackageMessage(message.toString());\n            if (messageBody instanceof UpdateValueMessageBody) {\n                log.info(\"receive UpdateValueMessageBody start\");\n                redisPubSub.notifyServer(initEnvironment.getClientInfo(), EventType.CLIENT_MESSAGE, LogLevelEnum.LOG,\"receive UpdateValueMessageBody start\");\n                UpdateValueMessageBody updateValueMessageBody = (UpdateValueMessageBody) messageBody;\n                String group = initEnvironment.getClientInfo().getGroup();\n                if (group.equals(updateValueMessageBody.getGroup())) {\n                    //updateClientValue local value\n                    boolean hasFaile = loadConfig.updateClientValue(updateValueMessageBody.getKey(), updateValueMessageBody.getValue(), NadiaConfig.CallbackScenes.UPDATE_VALUE);\n                    if(!hasFaile){\n                        Object oldValue = ConfigContextHolder.getOldValue(updateValueMessageBody.getKey());\n                        // update server value\n                        loadConfig.pushClientConfig(updateValueMessageBody.getKey(), ClientValueUtil.serializer(updateValueMessageBody.getValue(), oldValue));\n                    }\n                }\n            } else if (messageBody instanceof SwitchInstanceMessageBody) {\n                log.info(\"receive SwitchInstanceMessageBody start\");\n                redisPubSub.notifyServer(initEnvironment.getClientInfo(), EventType.CLIENT_MESSAGE, LogLevelEnum.LOG,\"receive SwitchInstanceMessageBody start\");\n                SwitchInstanceMessageBody switchInstanceMessageBody = (SwitchInstanceMessageBody) messageBody;\n                //update local value\n                loadConfig.switchGroup(switchInstanceMessageBody.getApplication(),switchInstanceMessageBody.getGroupFrom(),switchInstanceMessageBody.getGroupTo(),switchInstanceMessageBody.getInstance());\n            } else if (messageBody instanceof HeartbeatMessageBody) {\n                log.info(\"receive HeartbeatMessageBody\");\n\n            }\n            notifyFactory.stopPush();\n        }\n    }\n```\n\n\n","slug":"我为什么会重新写一个配置中心-代码篇","published":1,"updated":"2020-12-14T09:51:24.047Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71huk004ov252bwtrab0t","content":"<html><head></head><body><p>&#x4E0A;&#x671F;&#x6211;&#x4EEC;&#x786E;&#x5B9A;&#x4E86;&#x4EE5;Spring&#x7684;&#x65B9;&#x5411;&#x548C;&#x91C7;&#x7528;Redis&#x6765;&#x505A;&#x914D;&#x7F6E;&#x5173;&#x7CFB;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x5F00;&#x59CB;&#x56F4;&#x7ED5;&#x8FD9;&#x4E24;&#x4E2A;&#x5927;&#x5934;&#x5177;&#x4F53;&#x7684;&#x5F00;&#x59CB;&#x8BBE;&#x8BA1;&#x5BA2;&#x6237;&#x7AEF;&#x529F;&#x80FD;&#x3002;</p>\n<h2 id=\"1-&#x8BA9;Spring&#x542F;&#x52A8;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5BA2;&#x6237;&#x7AEF;\"><a href=\"#1-&#x8BA9;Spring&#x542F;&#x52A8;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5BA2;&#x6237;&#x7AEF;\" class=\"headerlink\" title=\"1.&#x8BA9;Spring&#x542F;&#x52A8;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5BA2;&#x6237;&#x7AEF;\"></a>1.&#x8BA9;Spring&#x542F;&#x52A8;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5BA2;&#x6237;&#x7AEF;</h2><p>&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x4E86;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x542F;&#x52A8;&#x6CE8;&#x89E3;&#x3002;&#x540C;&#x5927;&#x591A;&#x6570;Spring&#x7684;&#x6574;&#x5408;&#x9879;&#x76EE;&#x4E00;&#x6837;&#xFF0C;&#x4E0D;&#x4EC5;&#x80FD;&#x901A;&#x8FC7;&#x542F;&#x52A8;&#x6CE8;&#x89E3;&#x542F;&#x7528;&#x529F;&#x80FD;&#xFF0C;&#x540C;&#x65F6;&#x8FD8;&#x80FD;&#x5BF9;&#x914D;&#x7F6E;&#x7684;&#x5E94;&#x7528;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x8BBE;&#x5B9A;&#x3002;</p>\n<a id=\"more\"></a>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"hljs-meta\">@Target(ElementType.TYPE)</span></span><br><span class=\"line\"><span class=\"hljs-meta\">@Documented</span></span><br><span class=\"line\"><span class=\"hljs-meta\">@Import(ConfigRegistrar.class)</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-meta\">@interface</span> EnableNadiaConfig {</span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x542F;&#x7528;&#x73AF;&#x5883;</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x672A;&#x8BBE;&#x7F6E;&#x65F6;&#x6240;&#x6709;&#x73AF;&#x5883;&#x542F;&#x52A8;</span></span><br><span class=\"line\">    String[] actives() <span class=\"hljs-keyword\">default</span> {};</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x6307;&#x5B9A;&#x914D;&#x7F6E;&#x6240;&#x5C5E;&#x7684;Application</span></span><br><span class=\"line\">    <span class=\"hljs-function\">String <span class=\"hljs-title\">application</span><span class=\"hljs-params\">()</span> <span class=\"hljs-keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x9ED8;&#x8BA4;&#x5206;&#x7EC4;</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x672A;&#x8BBE;&#x7F6E;&#x65F6;&#x4E3A;&#x9ED8;&#x8BA4;&#x5206;&#x7EC4;</span></span><br><span class=\"line\">    <span class=\"hljs-function\">String <span class=\"hljs-title\">group</span><span class=\"hljs-params\">()</span> <span class=\"hljs-keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x6307;&#x5B9A;&#x914D;&#x7F6E;&#x7684;&#x5305;&#x8DEF;&#x5F84;&#xFF0C;&#x907F;&#x514D;&#x89E3;&#x6790;&#x65E0;&#x7528;&#x7684;&#x914D;&#x7F6E;</span></span><br><span class=\"line\">    String[] basePackages() <span class=\"hljs-keyword\">default</span> {};</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"2-&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x76F8;&#x5173;&#x7C7B;\"><a href=\"#2-&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x76F8;&#x5173;&#x7C7B;\" class=\"headerlink\" title=\"2.&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x76F8;&#x5173;&#x7C7B;\"></a>2.&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x76F8;&#x5173;&#x7C7B;</h2><p>&#x901A;&#x8FC7;&#x5B9E;&#x73B0;ImportBeanDefinitionRegistrar&#x65B9;&#x6CD5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;Bean&#x5B9A;&#x4E49;&#x7684;&#x6CE8;&#x518C;&#x5668;&#xFF0C;&#x6B64;&#x65F6;&#x5C31;&#x53EF;&#x4EE5;&#x5C06;&#x6211;&#x4EEC;&#x7684;&#x529F;&#x80FD;&#x4F18;&#x96C5;&#x7684;&#x6CE8;&#x518C;&#x81F3;spring&#x751F;&#x547D;&#x5468;&#x671F;&#x5185;&#x3002;</p>\n<p>&#x503C;&#x5F97;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x8BBE;&#x8BA1;&#x65F6;&#x91C7;&#x7528;&#x4E86;spi&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5728;&#x5B9E;&#x73B0;&#x7684;&#x65F6;&#x5019;&#x91C7;&#x7528;&#x7684;&#x662F;Redis&#x3002;&#x8FD9;&#x5C31;&#x610F;&#x5473;&#x7740;&#x672A;&#x6765;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x60F3;&#x66F4;&#x6362;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x7684;&#x65B9;&#x5F0F;&#xFF0C;&#x5B8C;&#x5168;&#x53EF;&#x4EE5;&#x7EE7;&#x627F;&#x73B0;&#x6709;&#x63A5;&#x53E3;&#x5B9E;&#x73B0;&#x4E00;&#x5957;&#x65B0;&#x7684;&#x673A;&#x5236;&#x3002;&#x4E3A;&#x672A;&#x6765;&#x7684;&#x62D3;&#x5C55;&#x63D0;&#x4F9B;&#x4E86;&#x53EF;&#x80FD;&#x6027;&#x3002;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigRegistrar</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">ImportBeanDefinitionRegistrar</span>, <span class=\"hljs-title\">EnvironmentAware</span> </span>{</span><br><span class=\"line\"></span><br><span class=\"line\">    .....</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">registerBeanDefinitions</span><span class=\"hljs-params\">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>{</span><br><span class=\"line\">        AnnotationAttributes attributes = AnnotationAttributes</span><br><span class=\"line\">                .fromMap(importingClassMetadata.getAnnotationAttributes(EnableNadiaConfig.class.getName()));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x68C0;&#x67E5;&#x662F;&#x5426;&#x9700;&#x8981;&#x542F;&#x52A8;</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (!enableConfig(importingClassMetadata, attributes)) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x521D;&#x59CB;&#x5316;&#x9700;&#x8981;&#x626B;&#x63CF;&#x7684;&#x5305;</span></span><br><span class=\"line\">        ConfigRegistrar.setBasePackages(attributes);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x5DE5;&#x5177;</span></span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, SpringUtils.class.getName(), SpringUtils.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x6536;&#x96C6;&#x672C;&#x5730;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x3001;&#x751F;&#x6210;&#x670D;&#x52A1;&#x4FE1;&#x606F;</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">//-----&gt;SPI&#x5B9E;&#x73B0;&#xFF0C;&#x672C;&#x5730;&#x53D8;&#x91CF;&#x7684;&#x624B;&#x673A;&#x548C;Service&#x7AEF;&#x663E;&#x793A;&#x7684;&#x670D;&#x52A1;&#x4FE1;&#x606F;&#x53EF;&#x81EA;&#x5B9A;&#x4E49;&#x5B9E;&#x73B0;</span></span><br><span class=\"line\">        Map&lt;String, Object&gt; envPropertyValues = <span class=\"hljs-keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">        envPropertyValues.put(<span class=\"hljs-string\">&quot;importingClassMetadata&quot;</span>, importingClassMetadata);</span><br><span class=\"line\">        InitEnvironment env = SpiServiceUtil.loadFirst(InitEnvironment.class);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, InitEnvironment.class.getName(), env.getClass(), envPropertyValues);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x6536;&#x96C6;&#x672C;&#x5730;&#x914D;&#x7F6E;&amp;&#x56DE;&#x8C03;&#x65B9;&#x6CD5;</span></span><br><span class=\"line\">        Map&lt;String, Object&gt; processorPropertyValues = <span class=\"hljs-keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">        processorPropertyValues.put(<span class=\"hljs-string\">&quot;importingClassMetadata&quot;</span>, importingClassMetadata);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, SpringValueProcessor.class.getName(), SpringValueProcessor.class, processorPropertyValues);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x542F;&#x52A8;&#x5668;&#x6CE8;&#x518C;</span></span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigPostConstructProcessor.class.getName(), ConfigPostConstructProcessor.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//redis&#x88C5;&#x8F7D;</span></span><br><span class=\"line\">        ConfigCenter configCenter = SpiServiceUtil.loadFirst(ConfigCenter.class);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigCenter.class.getName(), configCenter.getClass());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x6309;&#x7167;&#x672C;&#x5730;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x6536;&#x96C6;redis&#x4E2D;&#x7684;&#x914D;&#x7F6E;&#xFF08;&#xFF09;</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x5411;redis&#x63D0;&#x4F9B;&#x5F53;&#x524D;&#x670D;&#x52A1;&#x4FE1;&#x606F;</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">//------&gt;SPI&#x5B9E;&#x73B0;&#xFF0C;&#x53EF;&#x66FF;&#x6362;redis&#x4E3A;&#x5176;&#x4ED6;&#x4E2D;&#x95F4;&#x4EF6;</span></span><br><span class=\"line\">        LoadConfig loadConfig = SpiServiceUtil.loadFirst(LoadConfig.class);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, LoadConfig.class.getName(), loadConfig.getClass());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x914D;&#x7F6E;&#x53D8;&#x66F4;&#x8BA2;&#x9605;</span></span><br><span class=\"line\">        Listener listener = SpiServiceUtil.loadFirst(Listener.class);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, Listener.class.getName(), listener.getClass());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x5BA2;&#x6237;&#x7AEF;&#x901A;&#x77E5;&#x670D;&#x52A1;&#x7AEF;</span></span><br><span class=\"line\">        NotifyFactory notifyFactory = SpiServiceUtil.loadFirst(NotifyFactory.class);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, NotifyFactory.class.getName(), notifyFactory.getClass());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x914D;&#x7F6E;&#x53D8;&#x66F4;&#x542F;&#x52A8;&#x7C7B;</span></span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigPostConstructProcessor.class.getName(), ConfigPostConstructProcessor.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//spring&#x5BB9;&#x5668;&#x5173;&#x95ED;&#x65F6;&#xFF0C;&#x9500;&#x6BC1;&#x5F53;&#x524D;&#x5B9E;&#x4F8B;&#x4FE1;&#x606F;</span></span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ApplicationEventListener.class.getName(), ApplicationEventListener.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    }</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"3-&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x7684;&#x7EDF;&#x4E00;&#x6536;&#x96C6;\"><a href=\"#3-&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x7684;&#x7EDF;&#x4E00;&#x6536;&#x96C6;\" class=\"headerlink\" title=\"3.&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x7684;&#x7EDF;&#x4E00;&#x6536;&#x96C6;\"></a>3.&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x7684;&#x7EDF;&#x4E00;&#x6536;&#x96C6;</h2><p>&#x6536;&#x96C6;&#x914D;&#x7F6E;&#x65F6;&#xFF0C;&#x8003;&#x8651;&#x5230;&#x628A;&#x5BF9;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x7684;&#x4EE3;&#x7801;&#x4FB5;&#x5165;&#x6027;&#x964D;&#x5230;&#x6700;&#x4F4E;&#xFF0C;&#x6211;&#x4EEC;&#x51B3;&#x5B9A;&#x9488;&#x5BF9;Spring&#x81EA;&#x8EAB;@Value&#x6CE8;&#x89E3;&#x548C;@ConfigurationProperties&#x6CE8;&#x89E3;&#x8FDB;&#x884C;&#x6536;&#x96C6;&#x3002;&#x597D;&#x5904;&#x662F;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x65E0;&#x9700;&#x5F15;&#x5165;&#x5176;&#x4ED6;&#x7684;&#x5B66;&#x4E60;&#x6210;&#x672C;&#xFF0C;&#x5728;&#x4E0D;&#x53D8;&#x66F4;&#x73B0;&#x6709;&#x5F00;&#x53D1;&#x6A21;&#x5F0F;&#x4E0B;&#x5C31;&#x80FD;&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x9879;&#x7684;&#x6536;&#x96C6;&#x4E0E;&#x7BA1;&#x7406;&#x3002;</p>\n<p>&#x6B64;&#x5916;&#xFF0C;&#x9488;&#x5BF9;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x7684;&#x4E00;&#x4E9B;&#x7279;&#x6B8A;&#x66F4;&#x80FD;&#xFF0C;&#x6211;&#x4EEC;&#x8BBE;&#x8BA1;&#x4E86;&#x626B;&#x5305;&#x8DEF;&#x5F84;&#x3002;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x9700;&#x8981;&#x8BBE;&#x5B9A;&#x626B;&#x5305;&#x8DEF;&#x5F84;&#xFF0C;&#x4ECE;&#x800C;&#x5BF9;&#x5173;&#x5FC3;&#x7684;&#x914D;&#x7F6E;&#x8FDB;&#x884C;&#x8FDC;&#x7A0B;&#x7BA1;&#x7406;&#x3002;&#x540C;&#x65F6;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;@NadiaConfig&#x6CE8;&#x89E3;&#xFF0C;&#x4E00;&#x65E6;&#x6807;&#x8BB0;&#x4E0A;&#x8BE5;&#x6CE8;&#x89E3;&#x540E;&#x3002;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x53EF;&#x4EE5;&#x9488;&#x5BF9;&#x914D;&#x7F6E;&#x7684;&#x53D8;&#x66F4;&#x8FDB;&#x884C;&#x81EA;&#x5B9A;&#x4E49;&#x7684;&#x56DE;&#x8C03;&#x5904;&#x7406;&#x3002;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">@Target({ElementType.FIELD,ElementType.CONSTRUCTOR})</span></span><br><span class=\"line\"><span class=\"hljs-meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"hljs-meta\">@Documented</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-meta\">@interface</span> NadiaConfig {</span><br><span class=\"line\">    Class&lt;? extends Callback&gt; clazz();</span><br><span class=\"line\"></span><br><span class=\"line\">    CallbackScenes[] callbackScenes() <span class=\"hljs-keyword\">default</span> {CallbackScenes.UPDATE_VALUE, CallbackScenes.SWITCH_GROUP};</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">boolean</span> <span class=\"hljs-title\">exclude</span><span class=\"hljs-params\">()</span> <span class=\"hljs-keyword\">default</span> <span class=\"hljs-keyword\">false</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-class\"><span class=\"hljs-keyword\">enum</span> <span class=\"hljs-title\">CallbackScenes</span> </span>{</span><br><span class=\"line\">        INIT,</span><br><span class=\"line\">        SWITCH_GROUP,</span><br><span class=\"line\">        UPDATE_VALUE,</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x5B9E;&#x73B0;BeanPostProcessor&#x63A5;&#x53E3;&#x540E;&#xFF0C;&#x5728;Bean&#x7684;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x903B;&#x8F91;&#x4E2D;&#x6211;&#x4EEC;&#x4F1A;&#x6536;&#x96C6;&#x6307;&#x5B9A;&#x5305;&#x4E0B;&#x7684;&#x914D;&#x7F6E;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">SpringValueProcessor</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractMetadata</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">BeanPostProcessor</span>, <span class=\"hljs-title\">PriorityOrdered</span> </span>{</span><br><span class=\"line\"></span><br><span class=\"line\">    ....</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">processField</span><span class=\"hljs-params\">(Object bean, String beanName, Field field)</span> </span>{</span><br><span class=\"line\">        <span class=\"hljs-comment\">// register @Value on field</span></span><br><span class=\"line\">        Value value = field.getAnnotation(Value.class);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (value == <span class=\"hljs-keyword\">null</span>) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\">        Set&lt;String&gt; keys = PlaceholderHelper.extractPlaceholderKeys(value.value());</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (keys.isEmpty()) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-keyword\">for</span> (String key : keys) {</span><br><span class=\"line\">            Config config = generateConfig(bean, beanName, key, field);</span><br><span class=\"line\">            ConfigContextHolder.setConfigHolder(key, config);</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">private</span> Config <span class=\"hljs-title\">generateConfig</span><span class=\"hljs-params\">(Object bean, String beanName, String key, Field field)</span> </span>{</span><br><span class=\"line\">        NadiaConfig nadiaConfig = field.getAnnotation(NadiaConfig.class);</span><br><span class=\"line\">        Class&lt;? extends Callback&gt; callback = <span class=\"hljs-keyword\">null</span>;</span><br><span class=\"line\">        Set&lt;NadiaConfig.CallbackScenes&gt; callbackScenesSet = <span class=\"hljs-keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (nadiaConfig != <span class=\"hljs-keyword\">null</span>) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">if</span>(nadiaConfig.exclude()){</span><br><span class=\"line\">                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">null</span>;</span><br><span class=\"line\">            }</span><br><span class=\"line\">            callback = nadiaConfig.clazz();</span><br><span class=\"line\">            callbackScenesSet = getCallbackScenes(nadiaConfig);</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">new</span> Config(ConfigTypeEnum.FIELD,</span><br><span class=\"line\">                beanName,</span><br><span class=\"line\">                bean.getClass(),</span><br><span class=\"line\">                key, field,</span><br><span class=\"line\">                <span class=\"hljs-keyword\">null</span>,</span><br><span class=\"line\">                FieldUtil.getValue(bean, field),</span><br><span class=\"line\">                callback,</span><br><span class=\"line\">                callbackScenesSet,</span><br><span class=\"line\">                field.getType(),</span><br><span class=\"line\">                bean);</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    ....</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"4-&#x542F;&#x52A8;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x914D;&#x7F6E;&#x66F4;&#x65B0;&#x7684;&#x6A21;&#x677F;&#x6D41;&#x7A0B;\"><a href=\"#4-&#x542F;&#x52A8;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x914D;&#x7F6E;&#x66F4;&#x65B0;&#x7684;&#x6A21;&#x677F;&#x6D41;&#x7A0B;\" class=\"headerlink\" title=\"4.&#x542F;&#x52A8;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x914D;&#x7F6E;&#x66F4;&#x65B0;&#x7684;&#x6A21;&#x677F;&#x6D41;&#x7A0B;\"></a>4.&#x542F;&#x52A8;&#x914D;&#x7F6E;&#x672C;&#x5730;&#x914D;&#x7F6E;&#x66F4;&#x65B0;&#x7684;&#x6A21;&#x677F;&#x6D41;&#x7A0B;</h2><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x6A21;&#x677F;&#x6A21;&#x5F0F;&#x6307;&#x5B9A;&#x4E86;&#x4E00;&#x5957;&#x8FDC;&#x7A0B;&#x914D;&#x7F6E;&#x66F4;&#x65B0;&#x81F3;&#x672C;&#x5730;&#x7684;&#x6D41;&#x7A0B;&#x3002;&#x7ED3;&#x5408;SPI&#x7684;&#x7279;&#x6027;&#xFF0C;&#x53EF;&#x4EE5;&#x5B58;&#x5728;&#x591A;&#x79CD;&#x7684;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x3002;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-meta\">@Component</span></span><br><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">ConfigBootstart</span> </span>{</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> InitEnvironment initEnvironment;</span><br><span class=\"line\">    <span class=\"hljs-meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> LoadConfig loadConfig;</span><br><span class=\"line\">    <span class=\"hljs-meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> Listener listener;</span><br><span class=\"line\">    <span class=\"hljs-meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> NotifyFactory notifyFactory;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">start</span><span class=\"hljs-params\">()</span></span>{</span><br><span class=\"line\">        <span class=\"hljs-comment\">//bootstart notify start</span></span><br><span class=\"line\">        notifyFactory.startPush();</span><br><span class=\"line\">        <span class=\"hljs-comment\">//env</span></span><br><span class=\"line\">        initEnvironment.init();</span><br><span class=\"line\">        <span class=\"hljs-comment\">//config</span></span><br><span class=\"line\">        loadConfig.load();</span><br><span class=\"line\">        loadConfig.updateClientValues();</span><br><span class=\"line\">        loadConfig.onlineClientInGroup();</span><br><span class=\"line\">        loadConfig.pushClientConfigs();</span><br><span class=\"line\">        loadConfig.keepClientAlive();</span><br><span class=\"line\">        <span class=\"hljs-comment\">//watch</span></span><br><span class=\"line\">        listener.init();</span><br><span class=\"line\">        <span class=\"hljs-comment\">//bootstart notify end</span></span><br><span class=\"line\">        notifyFactory.stopPush();</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"5-Redis&#x5B9E;&#x73B0;&#x914D;&#x7F6E;&#x7684;&#x66F4;&#x65B0;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x4E0A;&#x4E0B;&#x7EBF;\"><a href=\"#5-Redis&#x5B9E;&#x73B0;&#x914D;&#x7F6E;&#x7684;&#x66F4;&#x65B0;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x4E0A;&#x4E0B;&#x7EBF;\" class=\"headerlink\" title=\"5.Redis&#x5B9E;&#x73B0;&#x914D;&#x7F6E;&#x7684;&#x66F4;&#x65B0;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x4E0A;&#x4E0B;&#x7EBF;\"></a>5.Redis&#x5B9E;&#x73B0;&#x914D;&#x7F6E;&#x7684;&#x66F4;&#x65B0;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x4E0A;&#x4E0B;&#x7EBF;</h2><p>&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x7528;Redis&#x5B9E;&#x73B0;AbstractLoadConfig&#x5B9A;&#x4E49;&#x597D;&#x7684;&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#xFF0C;&#x5305;&#x62EC;&#x914D;&#x7F6E;&#x4ECE;redis&#x7684;&#x62C9;&#x53D6;&#x3001;&#x66F4;&#x65B0;&#x672C;&#x5730;&#x914D;&#x7F6E;&#x3001;&#x5BA2;&#x6237;&#x7AEF;&#x5FC3;&#x8DF3;&#x7684;&#x4E0A;&#x62A5;&#x3001;&#x5BA2;&#x6237;&#x7AEF;&#x4E0A;&#x7EBF;&#x901A;&#x77E5;&#x3001;&#x5BA2;&#x6237;&#x7AEF;&#x4E0B;&#x7EBF;&#x901A;&#x77E5;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">RedisLoadConfig</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title\">AbstractLoadConfig</span> </span>{</span><br><span class=\"line\">    <span class=\"hljs-meta\">@Resource</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> ConfigCenterRedisService configCenterRedisService;</span><br><span class=\"line\">    <span class=\"hljs-meta\">@Resource</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">private</span> RedisPubSub redisPubSub;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">load</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">        <span class=\"hljs-comment\">//get redis info</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">this</span>.load(initEnvironment.getClientInfo().getApplication(), initEnvironment.getClientInfo().getGroup());</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">load</span><span class=\"hljs-params\">(String application, String group)</span> </span>{</span><br><span class=\"line\">        String configKey = RedisKeyUtil.getGroupConfig(application, group);</span><br><span class=\"line\">        Map&lt;String, String&gt; configs = configCenterRedisService.hgetAll(configKey);</span><br><span class=\"line\">        RemoteContextHolder.setRemoteHolder(configKey, configs);</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> Object <span class=\"hljs-title\">getValue</span><span class=\"hljs-params\">(String key)</span> </span>{</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-keyword\">null</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">onlineClientInGroup</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        String applicationGroup = RedisKeyUtil.getInstance(clientInfo.getApplication(), clientInfo.getGroup());</span><br><span class=\"line\">        configCenterRedisService.sadd(applicationGroup, clientInfo.getName());</span><br><span class=\"line\">        log.info(<span class=\"hljs-string\">&quot;========================= onlineClientInGroup key[{}] value[{}] =========================&quot;</span>, applicationGroup, clientInfo.getName());</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">offlineClientInGroup</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        String applicationGroup = RedisKeyUtil.getInstance(clientInfo.getApplication(), clientInfo.getGroup());</span><br><span class=\"line\">        configCenterRedisService.del(applicationGroup, clientInfo.getName());</span><br><span class=\"line\">        log.info(<span class=\"hljs-string\">&quot;========================= offlineClientInGroup key[{}] value[{}] =========================&quot;</span>, applicationGroup, clientInfo.getName());</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">offlineClientConfigs</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        String instanceConfig = RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName());</span><br><span class=\"line\">        configCenterRedisService.del(instanceConfig);</span><br><span class=\"line\">        log.info(<span class=\"hljs-string\">&quot;========================= offlineClientConfigs key[{}] =========================&quot;</span>, instanceConfig);</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">keepClientAlive</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        <span class=\"hljs-comment\">//push client info to redis schedule</span></span><br><span class=\"line\">        Executors.newScheduledThreadPool(<span class=\"hljs-number\">1</span>).scheduleAtFixedRate(<span class=\"hljs-keyword\">new</span> Runnable() {</span><br><span class=\"line\">            <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">            <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">run</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">                log.info(<span class=\"hljs-string\">&quot;========================= Client Keep Alive with Redis Start =========================&quot;</span>);</span><br><span class=\"line\">                clientInfo.setTimestamp(<span class=\"hljs-keyword\">new</span> Date().getTime());</span><br><span class=\"line\">                String hashCode = String.valueOf(clientInfo.hashCode());</span><br><span class=\"line\">                log.info(<span class=\"hljs-string\">&quot;========================= Client Keep Alive hashCode:[{}] clientInfo:[{}] =========================&quot;</span>, hashCode, clientInfo);</span><br><span class=\"line\">                configCenterRedisService.hset(RedisKeyUtil.getClints(), hashCode, JSONObject.toJSONString(clientInfo));</span><br><span class=\"line\">                log.info(<span class=\"hljs-string\">&quot;========================= Client Keep Alive with Redis End   =========================&quot;</span>);</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">1</span>, TimeUnit.MINUTES);</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">pushClientConfig</span><span class=\"hljs-params\">(String key, String value)</span> </span>{</span><br><span class=\"line\">        String configKey = RedisKeyUtil.getInstanceConfig(initEnvironment.getClientInfo().getApplication(),</span><br><span class=\"line\">                initEnvironment.getClientInfo().getGroup(), initEnvironment.getClientInfo().getName());</span><br><span class=\"line\">        configCenterRedisService.hset(configKey, key, value);</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">pushClientConfigs</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        configCenterRedisService.del(RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName()));</span><br><span class=\"line\">        Map&lt;String, String&gt; clientConfigs = ConfigContextHolder.getClientConfigs();</span><br><span class=\"line\">        clientConfigs.forEach((k, v) -&gt; {</span><br><span class=\"line\">            configCenterRedisService.hset(RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName()), k, v);</span><br><span class=\"line\">        });</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">protected</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">notificServer</span><span class=\"hljs-params\">(String message,EventType type , LogLevelEnum level)</span> </span>{</span><br><span class=\"line\">        redisPubSub.notifyServer(initEnvironment.getClientInfo(), type, level,message);</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">offlineClientInfo</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        configCenterRedisService.del(RedisKeyUtil.getClints(),String.valueOf(clientInfo.hashCode()));</span><br><span class=\"line\">        log.info(<span class=\"hljs-string\">&quot;========================= delete client info  key[{}] value[{}]=========================&quot;</span>, RedisKeyUtil.getClints(),clientInfo.hashCode());</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">pushClinetInfo</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        configCenterRedisService.hset(RedisKeyUtil.getClints(), String.valueOf(clientInfo.hashCode()), JSONObject.toJSONString(clientInfo));</span><br><span class=\"line\">        log.info(<span class=\"hljs-string\">&quot;========================= push client info  key[{}] value[{}]=========================&quot;</span>, RedisKeyUtil.getClints(),clientInfo.hashCode());</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<h2 id=\"6-Redis&#x5B9E;&#x73B0;&#x8FDC;&#x7A0B;&#x914D;&#x7F6E;&#x7684;&#x5B9E;&#x65F6;&#x540C;&#x6B65;\"><a href=\"#6-Redis&#x5B9E;&#x73B0;&#x8FDC;&#x7A0B;&#x914D;&#x7F6E;&#x7684;&#x5B9E;&#x65F6;&#x540C;&#x6B65;\" class=\"headerlink\" title=\"6.Redis&#x5B9E;&#x73B0;&#x8FDC;&#x7A0B;&#x914D;&#x7F6E;&#x7684;&#x5B9E;&#x65F6;&#x540C;&#x6B65;\"></a>6.Redis&#x5B9E;&#x73B0;&#x8FDC;&#x7A0B;&#x914D;&#x7F6E;&#x7684;&#x5B9E;&#x65F6;&#x540C;&#x6B65;</h2><p>&#x914D;&#x7F6E;&#x4FE1;&#x606F;&#x7684;&#x5B9E;&#x65F6;&#x540C;&#x6B65;&#x4E3B;&#x8981;&#x91C7;&#x7528;&#x4E86;Redis&#x7684;&#x76D1;&#x542C;&#x529F;&#x80FD;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x542F;&#x52A8;&#x540E;&#x76D1;&#x542C;&#x7279;&#x6B8A;&#x901A;&#x9053;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x5265;&#x79BB;&#x51FA;&#x81EA;&#x5DF1;&#x611F;&#x5174;&#x8DA3;&#x7684;&#x4FE1;&#x606F;&#x8FDB;&#x884C;&#x5904;&#x7406;&#x3002;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">MyMessageListener</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">MessageListener</span> </span>{</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-keyword\">private</span> LoadConfig loadConfig;</span><br><span class=\"line\"></span><br><span class=\"line\">        MyMessageListener(LoadConfig loadConfig) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">this</span>.loadConfig = loadConfig;</span><br><span class=\"line\">        }</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">        <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">onMessage</span><span class=\"hljs-params\">(Message message, <span class=\"hljs-keyword\">byte</span>[] pattern)</span> </span>{</span><br><span class=\"line\">            notifyFactory.startPush();</span><br><span class=\"line\">            MessageBody messageBody = MessageConvert.unpackageMessage(message.toString());</span><br><span class=\"line\">            <span class=\"hljs-keyword\">if</span> (messageBody <span class=\"hljs-keyword\">instanceof</span> UpdateValueMessageBody) {</span><br><span class=\"line\">                log.info(<span class=\"hljs-string\">&quot;receive UpdateValueMessageBody start&quot;</span>);</span><br><span class=\"line\">                redisPubSub.notifyServer(initEnvironment.getClientInfo(), EventType.CLIENT_MESSAGE, LogLevelEnum.LOG,<span class=\"hljs-string\">&quot;receive UpdateValueMessageBody start&quot;</span>);</span><br><span class=\"line\">                UpdateValueMessageBody updateValueMessageBody = (UpdateValueMessageBody) messageBody;</span><br><span class=\"line\">                String group = initEnvironment.getClientInfo().getGroup();</span><br><span class=\"line\">                <span class=\"hljs-keyword\">if</span> (group.equals(updateValueMessageBody.getGroup())) {</span><br><span class=\"line\">                    <span class=\"hljs-comment\">//updateClientValue local value</span></span><br><span class=\"line\">                    <span class=\"hljs-keyword\">boolean</span> hasFaile = loadConfig.updateClientValue(updateValueMessageBody.getKey(), updateValueMessageBody.getValue(), NadiaConfig.CallbackScenes.UPDATE_VALUE);</span><br><span class=\"line\">                    <span class=\"hljs-keyword\">if</span>(!hasFaile){</span><br><span class=\"line\">                        Object oldValue = ConfigContextHolder.getOldValue(updateValueMessageBody.getKey());</span><br><span class=\"line\">                        <span class=\"hljs-comment\">// update server value</span></span><br><span class=\"line\">                        loadConfig.pushClientConfig(updateValueMessageBody.getKey(), ClientValueUtil.serializer(updateValueMessageBody.getValue(), oldValue));</span><br><span class=\"line\">                    }</span><br><span class=\"line\">                }</span><br><span class=\"line\">            } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (messageBody <span class=\"hljs-keyword\">instanceof</span> SwitchInstanceMessageBody) {</span><br><span class=\"line\">                log.info(<span class=\"hljs-string\">&quot;receive SwitchInstanceMessageBody start&quot;</span>);</span><br><span class=\"line\">                redisPubSub.notifyServer(initEnvironment.getClientInfo(), EventType.CLIENT_MESSAGE, LogLevelEnum.LOG,<span class=\"hljs-string\">&quot;receive SwitchInstanceMessageBody start&quot;</span>);</span><br><span class=\"line\">                SwitchInstanceMessageBody switchInstanceMessageBody = (SwitchInstanceMessageBody) messageBody;</span><br><span class=\"line\">                <span class=\"hljs-comment\">//update local value</span></span><br><span class=\"line\">                loadConfig.switchGroup(switchInstanceMessageBody.getApplication(),switchInstanceMessageBody.getGroupFrom(),switchInstanceMessageBody.getGroupTo(),switchInstanceMessageBody.getInstance());</span><br><span class=\"line\">            } <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (messageBody <span class=\"hljs-keyword\">instanceof</span> HeartbeatMessageBody) {</span><br><span class=\"line\">                log.info(<span class=\"hljs-string\">&quot;receive HeartbeatMessageBody&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            }</span><br><span class=\"line\">            notifyFactory.stopPush();</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br></pre></td></tr></tbody></table></figure>\n\n\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"Java","path":"tags/Java/"},{"name":"Redis","path":"tags/Redis/"},{"name":"配置中心","path":"tags/配置中心/"}],"excerpt":"<html><head></head><body><p>&#x4E0A;&#x671F;&#x6211;&#x4EEC;&#x786E;&#x5B9A;&#x4E86;&#x4EE5;Spring&#x7684;&#x65B9;&#x5411;&#x548C;&#x91C7;&#x7528;Redis&#x6765;&#x505A;&#x914D;&#x7F6E;&#x5173;&#x7CFB;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x5F00;&#x59CB;&#x56F4;&#x7ED5;&#x8FD9;&#x4E24;&#x4E2A;&#x5927;&#x5934;&#x5177;&#x4F53;&#x7684;&#x5F00;&#x59CB;&#x8BBE;&#x8BA1;&#x5BA2;&#x6237;&#x7AEF;&#x529F;&#x80FD;&#x3002;</p>\n<h2 id=\"1-&#x8BA9;Spring&#x542F;&#x52A8;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5BA2;&#x6237;&#x7AEF;\"><a href=\"#1-&#x8BA9;Spring&#x542F;&#x52A8;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5BA2;&#x6237;&#x7AEF;\" class=\"headerlink\" title=\"1.&#x8BA9;Spring&#x542F;&#x52A8;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5BA2;&#x6237;&#x7AEF;\"></a>1.&#x8BA9;Spring&#x542F;&#x52A8;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x5BA2;&#x6237;&#x7AEF;</h2><p>&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x4E86;&#x914D;&#x7F6E;&#x4E2D;&#x5FC3;&#x7684;&#x542F;&#x52A8;&#x6CE8;&#x89E3;&#x3002;&#x540C;&#x5927;&#x591A;&#x6570;Spring&#x7684;&#x6574;&#x5408;&#x9879;&#x76EE;&#x4E00;&#x6837;&#xFF0C;&#x4E0D;&#x4EC5;&#x80FD;&#x901A;&#x8FC7;&#x542F;&#x52A8;&#x6CE8;&#x89E3;&#x542F;&#x7528;&#x529F;&#x80FD;&#xFF0C;&#x540C;&#x65F6;&#x8FD8;&#x80FD;&#x5BF9;&#x914D;&#x7F6E;&#x7684;&#x5E94;&#x7528;&#x8FDB;&#x884C;&#x521D;&#x59CB;&#x8BBE;&#x5B9A;&#x3002;</p></body></html>","more":"<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Target(ElementType.TYPE)</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"meta\">@Import(ConfigRegistrar.class)</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> EnableNadiaConfig &#123;</span><br><span class=\"line\">    <span class=\"comment\">//启用环境</span></span><br><span class=\"line\">    <span class=\"comment\">//未设置时所有环境启动</span></span><br><span class=\"line\">    String[] actives() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//指定配置所属的Application</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">application</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//默认分组</span></span><br><span class=\"line\">    <span class=\"comment\">//未设置时为默认分组</span></span><br><span class=\"line\">    <span class=\"function\">String <span class=\"title\">group</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> &quot;&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//指定配置的包路径，避免解析无用的配置</span></span><br><span class=\"line\">    String[] basePackages() <span class=\"keyword\">default</span> &#123;&#125;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-注册配置中心相关类\"><a href=\"#2-注册配置中心相关类\" class=\"headerlink\" title=\"2.注册配置中心相关类\"></a>2.注册配置中心相关类</h2><p>通过实现ImportBeanDefinitionRegistrar方法我们可以获得Bean定义的注册器，此时就可以将我们的功能优雅的注册至spring生命周期内。</p>\n<p>值得注意的是，我们设计时采用了spi的方式，在实现的时候采用的是Redis。这就意味着未来如果我们想更换配置管理的方式，完全可以继承现有接口实现一套新的机制。为未来的拓展提供了可能性。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConfigRegistrar</span> <span class=\"keyword\">implements</span> <span class=\"title\">ImportBeanDefinitionRegistrar</span>, <span class=\"title\">EnvironmentAware</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    .....</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">registerBeanDefinitions</span><span class=\"params\">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class=\"line\">        AnnotationAttributes attributes = AnnotationAttributes</span><br><span class=\"line\">                .fromMap(importingClassMetadata.getAnnotationAttributes(EnableNadiaConfig.class.getName()));</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//检查是否需要启动</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!enableConfig(importingClassMetadata, attributes)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//初始化需要扫描的包</span></span><br><span class=\"line\">        ConfigRegistrar.setBasePackages(attributes);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//工具</span></span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, SpringUtils.class.getName(), SpringUtils.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//收集本地环境变量、生成服务信息</span></span><br><span class=\"line\">        <span class=\"comment\">//-----&gt;SPI实现，本地变量的手机和Service端显示的服务信息可自定义实现</span></span><br><span class=\"line\">        Map&lt;String, Object&gt; envPropertyValues = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">        envPropertyValues.put(<span class=\"string\">&quot;importingClassMetadata&quot;</span>, importingClassMetadata);</span><br><span class=\"line\">        InitEnvironment env = SpiServiceUtil.loadFirst(InitEnvironment.class);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, InitEnvironment.class.getName(), env.getClass(), envPropertyValues);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//收集本地配置&amp;回调方法</span></span><br><span class=\"line\">        Map&lt;String, Object&gt; processorPropertyValues = <span class=\"keyword\">new</span> HashMap&lt;&gt;();</span><br><span class=\"line\">        processorPropertyValues.put(<span class=\"string\">&quot;importingClassMetadata&quot;</span>, importingClassMetadata);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, SpringValueProcessor.class.getName(), SpringValueProcessor.class, processorPropertyValues);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//启动器注册</span></span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigPostConstructProcessor.class.getName(), ConfigPostConstructProcessor.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//redis装载</span></span><br><span class=\"line\">        ConfigCenter configCenter = SpiServiceUtil.loadFirst(ConfigCenter.class);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigCenter.class.getName(), configCenter.getClass());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//按照本地环境变量收集redis中的配置（）</span></span><br><span class=\"line\">        <span class=\"comment\">//向redis提供当前服务信息</span></span><br><span class=\"line\">        <span class=\"comment\">//------&gt;SPI实现，可替换redis为其他中间件</span></span><br><span class=\"line\">        LoadConfig loadConfig = SpiServiceUtil.loadFirst(LoadConfig.class);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, LoadConfig.class.getName(), loadConfig.getClass());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//配置变更订阅</span></span><br><span class=\"line\">        Listener listener = SpiServiceUtil.loadFirst(Listener.class);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, Listener.class.getName(), listener.getClass());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//客户端通知服务端</span></span><br><span class=\"line\">        NotifyFactory notifyFactory = SpiServiceUtil.loadFirst(NotifyFactory.class);</span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, NotifyFactory.class.getName(), notifyFactory.getClass());</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//配置变更启动类</span></span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ConfigPostConstructProcessor.class.getName(), ConfigPostConstructProcessor.class);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//spring容器关闭时，销毁当前实例信息</span></span><br><span class=\"line\">        BeanRegistrationUtil.registerBeanDefinitionIfNotExists(registry, ApplicationEventListener.class.getName(), ApplicationEventListener.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-客户端配置的统一收集\"><a href=\"#3-客户端配置的统一收集\" class=\"headerlink\" title=\"3.客户端配置的统一收集\"></a>3.客户端配置的统一收集</h2><p>收集配置时，考虑到把对开发人员的代码侵入性降到最低，我们决定针对Spring自身@Value注解和@ConfigurationProperties注解进行收集。好处是开发人员无需引入其他的学习成本，在不变更现有开发模式下就能进行配置项的收集与管理。</p>\n<p>此外，针对配置管理的一些特殊更能，我们设计了扫包路径。开发人员可以根据需要设定扫包路径，从而对关心的配置进行远程管理。同时我们提供了@NadiaConfig注解，一旦标记上该注解后。开发人员可以针对配置的变更进行自定义的回调处理。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Target(&#123;ElementType.FIELD,ElementType.CONSTRUCTOR&#125;)</span></span><br><span class=\"line\"><span class=\"meta\">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class=\"line\"><span class=\"meta\">@Documented</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"meta\">@interface</span> NadiaConfig &#123;</span><br><span class=\"line\">    Class&lt;? extends Callback&gt; clazz();</span><br><span class=\"line\"></span><br><span class=\"line\">    CallbackScenes[] callbackScenes() <span class=\"keyword\">default</span> &#123;CallbackScenes.UPDATE_VALUE, CallbackScenes.SWITCH_GROUP&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">boolean</span> <span class=\"title\">exclude</span><span class=\"params\">()</span> <span class=\"keyword\">default</span> <span class=\"keyword\">false</span></span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">enum</span> <span class=\"title\">CallbackScenes</span> </span>&#123;</span><br><span class=\"line\">        INIT,</span><br><span class=\"line\">        SWITCH_GROUP,</span><br><span class=\"line\">        UPDATE_VALUE,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>实现BeanPostProcessor接口后，在Bean的后置处理逻辑中我们会收集指定包下的配置</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SpringValueProcessor</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractMetadata</span> <span class=\"keyword\">implements</span> <span class=\"title\">BeanPostProcessor</span>, <span class=\"title\">PriorityOrdered</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    ....</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title\">processField</span><span class=\"params\">(Object bean, String beanName, Field field)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// register @Value on field</span></span><br><span class=\"line\">        Value value = field.getAnnotation(Value.class);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (value == <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        Set&lt;String&gt; keys = PlaceholderHelper.extractPlaceholderKeys(value.value());</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (keys.isEmpty()) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">for</span> (String key : keys) &#123;</span><br><span class=\"line\">            Config config = generateConfig(bean, beanName, key, field);</span><br><span class=\"line\">            ConfigContextHolder.setConfigHolder(key, config);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">private</span> Config <span class=\"title\">generateConfig</span><span class=\"params\">(Object bean, String beanName, String key, Field field)</span> </span>&#123;</span><br><span class=\"line\">        NadiaConfig nadiaConfig = field.getAnnotation(NadiaConfig.class);</span><br><span class=\"line\">        Class&lt;? extends Callback&gt; callback = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        Set&lt;NadiaConfig.CallbackScenes&gt; callbackScenesSet = <span class=\"keyword\">null</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (nadiaConfig != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(nadiaConfig.exclude())&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            callback = nadiaConfig.clazz();</span><br><span class=\"line\">            callbackScenesSet = getCallbackScenes(nadiaConfig);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> Config(ConfigTypeEnum.FIELD,</span><br><span class=\"line\">                beanName,</span><br><span class=\"line\">                bean.getClass(),</span><br><span class=\"line\">                key, field,</span><br><span class=\"line\">                <span class=\"keyword\">null</span>,</span><br><span class=\"line\">                FieldUtil.getValue(bean, field),</span><br><span class=\"line\">                callback,</span><br><span class=\"line\">                callbackScenesSet,</span><br><span class=\"line\">                field.getType(),</span><br><span class=\"line\">                bean);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ....</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-启动配置本地配置更新的模板流程\"><a href=\"#4-启动配置本地配置更新的模板流程\" class=\"headerlink\" title=\"4.启动配置本地配置更新的模板流程\"></a>4.启动配置本地配置更新的模板流程</h2><p>可以看到，模板模式指定了一套远程配置更新至本地的流程。结合SPI的特性，可以存在多种的实现方式。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">@Component</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ConfigBootstart</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> InitEnvironment initEnvironment;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> LoadConfig loadConfig;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> Listener listener;</span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> NotifyFactory notifyFactory;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">start</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//bootstart notify start</span></span><br><span class=\"line\">        notifyFactory.startPush();</span><br><span class=\"line\">        <span class=\"comment\">//env</span></span><br><span class=\"line\">        initEnvironment.init();</span><br><span class=\"line\">        <span class=\"comment\">//config</span></span><br><span class=\"line\">        loadConfig.load();</span><br><span class=\"line\">        loadConfig.updateClientValues();</span><br><span class=\"line\">        loadConfig.onlineClientInGroup();</span><br><span class=\"line\">        loadConfig.pushClientConfigs();</span><br><span class=\"line\">        loadConfig.keepClientAlive();</span><br><span class=\"line\">        <span class=\"comment\">//watch</span></span><br><span class=\"line\">        listener.init();</span><br><span class=\"line\">        <span class=\"comment\">//bootstart notify end</span></span><br><span class=\"line\">        notifyFactory.stopPush();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-Redis实现配置的更新，客户端的上下线\"><a href=\"#5-Redis实现配置的更新，客户端的上下线\" class=\"headerlink\" title=\"5.Redis实现配置的更新，客户端的上下线\"></a>5.Redis实现配置的更新，客户端的上下线</h2><p>这里我们用Redis实现AbstractLoadConfig定义好的模板方法，包括配置从redis的拉取、更新本地配置、客户端心跳的上报、客户端上线通知、客户端下线通知</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">RedisLoadConfig</span> <span class=\"keyword\">extends</span> <span class=\"title\">AbstractLoadConfig</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"meta\">@Resource</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> ConfigCenterRedisService configCenterRedisService;</span><br><span class=\"line\">    <span class=\"meta\">@Resource</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> RedisPubSub redisPubSub;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">load</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//get redis info</span></span><br><span class=\"line\">        <span class=\"keyword\">this</span>.load(initEnvironment.getClientInfo().getApplication(), initEnvironment.getClientInfo().getGroup());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">load</span><span class=\"params\">(String application, String group)</span> </span>&#123;</span><br><span class=\"line\">        String configKey = RedisKeyUtil.getGroupConfig(application, group);</span><br><span class=\"line\">        Map&lt;String, String&gt; configs = configCenterRedisService.hgetAll(configKey);</span><br><span class=\"line\">        RemoteContextHolder.setRemoteHolder(configKey, configs);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> Object <span class=\"title\">getValue</span><span class=\"params\">(String key)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onlineClientInGroup</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        String applicationGroup = RedisKeyUtil.getInstance(clientInfo.getApplication(), clientInfo.getGroup());</span><br><span class=\"line\">        configCenterRedisService.sadd(applicationGroup, clientInfo.getName());</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;========================= onlineClientInGroup key[&#123;&#125;] value[&#123;&#125;] =========================&quot;</span>, applicationGroup, clientInfo.getName());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">offlineClientInGroup</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        String applicationGroup = RedisKeyUtil.getInstance(clientInfo.getApplication(), clientInfo.getGroup());</span><br><span class=\"line\">        configCenterRedisService.del(applicationGroup, clientInfo.getName());</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;========================= offlineClientInGroup key[&#123;&#125;] value[&#123;&#125;] =========================&quot;</span>, applicationGroup, clientInfo.getName());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">offlineClientConfigs</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        String instanceConfig = RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName());</span><br><span class=\"line\">        configCenterRedisService.del(instanceConfig);</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;========================= offlineClientConfigs key[&#123;&#125;] =========================&quot;</span>, instanceConfig);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">keepClientAlive</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        <span class=\"comment\">//push client info to redis schedule</span></span><br><span class=\"line\">        Executors.newScheduledThreadPool(<span class=\"number\">1</span>).scheduleAtFixedRate(<span class=\"keyword\">new</span> Runnable() &#123;</span><br><span class=\"line\">            <span class=\"meta\">@Override</span></span><br><span class=\"line\">            <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">run</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot;========================= Client Keep Alive with Redis Start =========================&quot;</span>);</span><br><span class=\"line\">                clientInfo.setTimestamp(<span class=\"keyword\">new</span> Date().getTime());</span><br><span class=\"line\">                String hashCode = String.valueOf(clientInfo.hashCode());</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot;========================= Client Keep Alive hashCode:[&#123;&#125;] clientInfo:[&#123;&#125;] =========================&quot;</span>, hashCode, clientInfo);</span><br><span class=\"line\">                configCenterRedisService.hset(RedisKeyUtil.getClints(), hashCode, JSONObject.toJSONString(clientInfo));</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot;========================= Client Keep Alive with Redis End   =========================&quot;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;, <span class=\"number\">0</span>, <span class=\"number\">1</span>, TimeUnit.MINUTES);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">pushClientConfig</span><span class=\"params\">(String key, String value)</span> </span>&#123;</span><br><span class=\"line\">        String configKey = RedisKeyUtil.getInstanceConfig(initEnvironment.getClientInfo().getApplication(),</span><br><span class=\"line\">                initEnvironment.getClientInfo().getGroup(), initEnvironment.getClientInfo().getName());</span><br><span class=\"line\">        configCenterRedisService.hset(configKey, key, value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">pushClientConfigs</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        configCenterRedisService.del(RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName()));</span><br><span class=\"line\">        Map&lt;String, String&gt; clientConfigs = ConfigContextHolder.getClientConfigs();</span><br><span class=\"line\">        clientConfigs.forEach((k, v) -&gt; &#123;</span><br><span class=\"line\">            configCenterRedisService.hset(RedisKeyUtil.getInstanceConfig(clientInfo.getApplication(), clientInfo.getGroup(), clientInfo.getName()), k, v);</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">protected</span> <span class=\"keyword\">void</span> <span class=\"title\">notificServer</span><span class=\"params\">(String message,EventType type , LogLevelEnum level)</span> </span>&#123;</span><br><span class=\"line\">        redisPubSub.notifyServer(initEnvironment.getClientInfo(), type, level,message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">offlineClientInfo</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        configCenterRedisService.del(RedisKeyUtil.getClints(),String.valueOf(clientInfo.hashCode()));</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;========================= delete client info  key[&#123;&#125;] value[&#123;&#125;]=========================&quot;</span>, RedisKeyUtil.getClints(),clientInfo.hashCode());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Override</span></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">pushClinetInfo</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        ClientInfo clientInfo = initEnvironment.getClientInfo();</span><br><span class=\"line\">        configCenterRedisService.hset(RedisKeyUtil.getClints(), String.valueOf(clientInfo.hashCode()), JSONObject.toJSONString(clientInfo));</span><br><span class=\"line\">        log.info(<span class=\"string\">&quot;========================= push client info  key[&#123;&#125;] value[&#123;&#125;]=========================&quot;</span>, RedisKeyUtil.getClints(),clientInfo.hashCode());</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-Redis实现远程配置的实时同步\"><a href=\"#6-Redis实现远程配置的实时同步\" class=\"headerlink\" title=\"6.Redis实现远程配置的实时同步\"></a>6.Redis实现远程配置的实时同步</h2><p>配置信息的实时同步主要采用了Redis的监听功能，客户端启动后监听特殊通道的信息，并剥离出自己感兴趣的信息进行处理。</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyMessageListener</span> <span class=\"keyword\">implements</span> <span class=\"title\">MessageListener</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">private</span> LoadConfig loadConfig;</span><br><span class=\"line\"></span><br><span class=\"line\">        MyMessageListener(LoadConfig loadConfig) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.loadConfig = loadConfig;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">onMessage</span><span class=\"params\">(Message message, <span class=\"keyword\">byte</span>[] pattern)</span> </span>&#123;</span><br><span class=\"line\">            notifyFactory.startPush();</span><br><span class=\"line\">            MessageBody messageBody = MessageConvert.unpackageMessage(message.toString());</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (messageBody <span class=\"keyword\">instanceof</span> UpdateValueMessageBody) &#123;</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot;receive UpdateValueMessageBody start&quot;</span>);</span><br><span class=\"line\">                redisPubSub.notifyServer(initEnvironment.getClientInfo(), EventType.CLIENT_MESSAGE, LogLevelEnum.LOG,<span class=\"string\">&quot;receive UpdateValueMessageBody start&quot;</span>);</span><br><span class=\"line\">                UpdateValueMessageBody updateValueMessageBody = (UpdateValueMessageBody) messageBody;</span><br><span class=\"line\">                String group = initEnvironment.getClientInfo().getGroup();</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (group.equals(updateValueMessageBody.getGroup())) &#123;</span><br><span class=\"line\">                    <span class=\"comment\">//updateClientValue local value</span></span><br><span class=\"line\">                    <span class=\"keyword\">boolean</span> hasFaile = loadConfig.updateClientValue(updateValueMessageBody.getKey(), updateValueMessageBody.getValue(), NadiaConfig.CallbackScenes.UPDATE_VALUE);</span><br><span class=\"line\">                    <span class=\"keyword\">if</span>(!hasFaile)&#123;</span><br><span class=\"line\">                        Object oldValue = ConfigContextHolder.getOldValue(updateValueMessageBody.getKey());</span><br><span class=\"line\">                        <span class=\"comment\">// update server value</span></span><br><span class=\"line\">                        loadConfig.pushClientConfig(updateValueMessageBody.getKey(), ClientValueUtil.serializer(updateValueMessageBody.getValue(), oldValue));</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (messageBody <span class=\"keyword\">instanceof</span> SwitchInstanceMessageBody) &#123;</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot;receive SwitchInstanceMessageBody start&quot;</span>);</span><br><span class=\"line\">                redisPubSub.notifyServer(initEnvironment.getClientInfo(), EventType.CLIENT_MESSAGE, LogLevelEnum.LOG,<span class=\"string\">&quot;receive SwitchInstanceMessageBody start&quot;</span>);</span><br><span class=\"line\">                SwitchInstanceMessageBody switchInstanceMessageBody = (SwitchInstanceMessageBody) messageBody;</span><br><span class=\"line\">                <span class=\"comment\">//update local value</span></span><br><span class=\"line\">                loadConfig.switchGroup(switchInstanceMessageBody.getApplication(),switchInstanceMessageBody.getGroupFrom(),switchInstanceMessageBody.getGroupTo(),switchInstanceMessageBody.getInstance());</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (messageBody <span class=\"keyword\">instanceof</span> HeartbeatMessageBody) &#123;</span><br><span class=\"line\">                log.info(<span class=\"string\">&quot;receive HeartbeatMessageBody&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            notifyFactory.stopPush();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>"},{"title":"深度剖析JVM 动态Attach原理","date":"2020-09-21T11:01:04.000Z","_content":"\n相信很多小伙伴都使用过javaagent探针技术，javaagent可以在不侵入原代码不的前提下，通过指定方法并利用动态字节码技术增强我们的代码。很多成熟的框架也运用到了该技术，如skywalking等。这么好用的功能，JDK的开发人员没道理不玩出些新花头，因此在JDK1.6中，更加强大的JVM 动态Attach技术展现在我们的面前。大名鼎鼎的Btrace、Arthas等都运用了动态Attach技术。在JVM运行期进拦截并增强我们的代码，使得以往生产难以定位的问题变得更加容易排查。\n<!-- more -->\nJVM的动态Attach固然好，相信大家或多或少已经知道如何去使用该技术了，所以这次我们研究的重点是JVM是如何实现动态Attach，至于JVM如何加载动态Jar包、分发方法并传递jvm上下文就不在我们的研究范围之内。\n\n为了更好的研究JVM的实现，我们将由浅入深，分为几个阶段进行研究：\n* 动态Attach是什么？\n* 有几种方案可以实现动态Attach\n* 举一个栗子\n* 看看JVM是怎么做的\n\n## 一、动态Attach是什么\n虽然我们这次研究的是具体的实现，但在这之前，我们需要像分析需求一样分析下动态Attach到底是什么。\n\n我们都知道javaagent参数是伴随着java命令，在JVM启动的过程中加载javaagent参数指定的Jar包路径，并执行约定类的premain方法。在premain方法中可以获取Instrumentation类型参数，从而对我们的类进行动态增强增强。\n\n我们可以这样使用javaagent：\n1. 先实现一个我们需要挂在的类，其中需要实现premain()方法，并将它打包为可执行Jar包\n``` java\npublic class Javaagent {\n    public static void premain(String agentArgs, Instrumentation inst) {\n        System.out.println(\"agentArgs : \" + agentArgs);\n        inst.addTransformer(new TestTransformer(), true);\n    }\n\n    static class TestTransformer implements ClassFileTransformer {\n\n        @Override\n        public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {\n            System.out.println(\"premain load Class:\" + className);\n            return classfileBuffer;\n        }\n    }\n}\n```\n\n2. 配置MANIFEST.MF配置文件\n```xml\nPremain-Class: Javaagent\nAgent-Class: Javaagent\nCan-Redefine-Classes: true\nCan-Retransform-Classes: true\n```\n\n3. 启动我们的服务\n```shell\njava -javaagent:Javaagent.jar 自己的服务.jar\n```\n\n以上就是一个简单的javaagent运用场景。javaagent可以在不侵入业务代码的前提下修改我们已加载的类，但唯一的问题是需要伴随着业务服务一同启动。也就是说我们无法侵入已经运行在JVM中的代码，因此JDK开发的大神们为我们带来了动态Attach API。其功能与javaagent是一样的，但最大的好处就是我们能够在一个已经运行的JVM上动态的挂载一个我们自己开发的Jar包，从而实现任何时间点我们都能手动的增强业务代码。比如通过attach Arthas，我们能增强指定方法的入口&出口，从而获取出入参的相关信息。这在缺少日志输出的场景下是非常有效的问题定位手段。此外我们也能为方法的调用链做埋点，帮助我们分析业务流程中的慢方法等等。\n\n总结下，动态Attach就是JVM运行期中提供的指定类型的类加载机制。通过增强类的加载，实现各式各样有趣的功能。\n\n## 二、有几种方案可以实现动态Attach\n现在我们已经知道什么是动态Attach了，倘若我们是JDK的工程师，当产品交给我们需要实现动态Attach这个需求时，我们会怎么实现呢？\n#### 1.直接类加载法\nJDK已经提供了一套完善的类加载机制，如果提供获取Instrumentation对象的JNI，开发人员就可以自行通过动态类加载后进行字节码动态增强。这个方案看似很美好，现有Java生态圈已经拥有丰富的Class动态加载方案，利用这些现有方案，开发人员能够很快的搭建出自己的字节码动态加载机制，而无需JVM提供大量的native支持。但是这个方案存在重大的安全问题，一旦服务的动态加载机制被黑客破解，那么他完全能够加载一个自己编写好的侵入类，通过入侵类任意修改业务代码最终导致无法挽回的损失。所以作为一个JDK开发工程师，一定要在初期就屏蔽这种安全问题。同时Java最为一种安全语言，不安全的操作需要尽量避免引入Java生态中。\n#### 2.Socket通信法\n既然提供JNI不安全，那么我们是否可以考虑让JVM自己处理。假设我们能和JVM建立起Socket通讯。并将我们希望加载的类告知JVM，JVM在加载完成后按照约定执行指定的入口方法，这样也能实现我们对动态Attach的实现。\n\nSocket通信可以分为远程通信和本地通信。我们需要考虑，如果采用远程通信，的确能给我们带来更强大的Attach灵活性，但需要JVM暴露端口，同样具有一定的安全问题。\n本地通讯我们可以采用UNIX Domain Socket，通过文件形式通讯。不但具有较高的通信速度，同时具有一定的安全性。\n\n如果采用Socket Local通信，那我们又如何与JVM建立起通信呢？\n#### 3.信号监听法\n其实这个方法是Socket通信法的补充。在与JVM建立起本地通信前，JVM需要知道用户想要开始动态Attach。而信号监听就能补充这方面的功能。客户端以约定的形式向JVM进程发起指定信号，同时JVM在监听到Attach信号后与客户端建立Socket链接。客户端以Socket方式将需要加载的类告知JVM并进行加载并最终运行我们后面熟悉的javaagent流程。\n\n我虽然不是JDK的工程师，上面的3个方案也是结合了JDK1.8的具体实现后大胆的揣测了当时开发工程师的想法。可能当时摆在他面前的方案更是成千上万，但是最终确定下这个技术方案的心路历程我觉得是我们每个开发都需要感同身受的。\n\n## 三、举一个栗子\n前面我们分析了实现方案，我们先丢一份代码来验证上面的方案（代码为JDK1.8源码相关功能的简化版）\n\n### 开始实验\n\n<font color=blue>需求：</font>实现动态Attach API，接收java -jar xxx.jar pid发起的挂载请求，并将loadAgent指定的Jar包完整路径显示在控制台。\n\n<font color=blue>实验环境：</font>MacOS 10.15.6\n\n<font color=blue>项目地址：</font>\n> https://github.com/xzenge/JVM_ATTACH/tree/dev\n\n##### 我们先启动项目。该项目模拟了JVM运行环境，但只实现了Attach API的部分功能。项目启动成功后，我们可以看到当前的JVM进程ID为：<font color=red>32910</font>\n\n![01](深度解析JVM-动态Attach原理/JVM_start.png)\n\n----\n\n##### 按照JDK规范编写JAVA测Attach方法。为了简便，方法中我们手动指定了attach的线程号，并提供了JVM需要加载的Jar包路径。\n\n```java\npublic class Attach {\n    public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException {\n        VirtualMachine attach = VirtualMachine.attach(\"32910\");\n        attach.loadAgentPath(\"/Users/xiangshi/.gradle/caches/modules-2/files-2.1/cglib/cglib/3.1/1f1cb6c7a7479e0c7fd7987109e503914bebe84a/cglib-3.1.jar\");\n\n\n    }\n}\n\n```\n\n----\n##### 运行Java attach方法，我们可以观察到模拟的JVM已经读取到了我们希望classloader的Jar包\n\n![02](深度解析JVM-动态Attach原理/load_agent_library.png)\n\n----\n\n### 实验分析\n实验过程很简单，我们伪造了个JVM运行时环境。并通过JAVA原生的Attach API成功的实现了与JVM之间通讯的功能。下面我们开始逐步分析具体的实现过程：\n\n* 监听signal\n初始化OS信号监听的相关数据\n\n``` C++\n/**\n * JVM启动时监听signal\n */\nvoid os::signal_init() {\n    //初始化signal监听pending_signals\n    os::signal_init_pd();\n    //创建线程监听pending_signals状态并进行相应处理\n    pthread_t tids;\n    int ret = pthread_create(&tids, NULL, reinterpret_cast<void *(*)(void *)>(signal_thread_entry), NULL);\n    //注册signal处理器\n    os::signal(SIGBREAK,os::user_handler());\n}\n```\n\nsigaction方法提供os信号的监听并注册信号处理器，我们监听-3 SIGQUIT信号。\n\n```C++\n/**\n * 注册监听信号&处理器\n * @param signal_number 信号编号\n * @param handler 信号处理器\n * @return\n */\nvoid *os::signal(int signal_number, void *handler) {\n    struct sigaction sigAct, oldSigAct;\n\n    sigfillset(&(sigAct.sa_mask));\n    sigAct.sa_flags   = SA_RESTART|SA_SIGINFO;\n    sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);\n\n    if (sigaction(signal_number, &sigAct, &oldSigAct)) {\n        // -1 means registration failed\n        return (void *)-1;\n    }\n\n    return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);\n}\n```\n\n信号处理器中简单的模拟的收到信号的处理过程，数组对应的信号位置为1时，说明收到了对应的信号。\n\n```C++\n/**\n * 通过pending_signals保留监听到的信息，交由专门的线程处理该信息\n * @param signal_number\n */\nvoid os::signal_notify(int signal_number) {\n    cout << \"enter signal_notify sig:\" << signal_number << endl;\n    //将监听到的信号为竖为1\n    //改操作应该为原子操作，确保不会被其他线程修改\n    //JVM中混编平台相关汇编指令实现原子操作，演示代码中不研究相关实现\n    pending_signals[signal_number] = 1;\n\n    semaphore_signal(sig_sem);\n}\n```\n\n单独起一个线程，该线程轮训信号接受数组的状态，将置为1的信号码传给下游处理。当信号位-3 SIGQUIT信号时，开始初始化attach的监听方法。\n\n```C++\n/**\n * 单独线程对pending_signals状态并进行相应处理\n */\nstatic void signal_thread_entry() {\n    cout << \"enter signal_thread_entry\" << endl;\n    while (true){\n        int sig;\n        {\n            sig = os::signal_wait();\n        }\n        switch (sig) {\n            case SIGBREAK: {\n                if (AttachListener::init()) {\n                    continue;\n                }\n            }\n        }\n\n    }\n}\n```\n\n初始化attach监听方法时，会创建一个Domain Socket的文件监听，并accept在改文件上。\n\n```C++\n/**\n * 初始化domain socket监听\n * JVM通过监听指定线程文件文件\n * 获取client想JVM发送的指令并进行相关操作\n * @return\n */\nint AttachListener::pd_init() {\n    char path[UNIX_PATH_MAX];          // socket file\n    char initial_path[UNIX_PATH_MAX];  // socket file during setup\n    int listener;                      // listener socket (file descriptor)\n\n    // register function to cleanup\n    ::atexit(listener_cleanup);\n\n    int n = snprintf(path, UNIX_PATH_MAX, \"%s/.java_pid%d\",\n                     TEMP_PATH, getpid());\n    if (n < (int) UNIX_PATH_MAX) {\n        n = snprintf(initial_path, UNIX_PATH_MAX, \"%s.tmp\", path);\n    }\n    if (n >= (int) UNIX_PATH_MAX) {\n        return -1;\n    }\n    cout << \"path:\" << path << endl;\n    // create the listener socket\n    listener = ::socket(PF_UNIX, SOCK_STREAM, 0);\n    if (listener == -1) {\n        return -1;\n    }\n\n    // bind socket\n    struct sockaddr_un addr;\n    addr.sun_family = AF_UNIX;\n    strcpy(addr.sun_path, initial_path);\n    ::unlink(initial_path);\n    int res = ::bind(listener, (struct sockaddr *) &addr, sizeof(addr));\n    if (res == -1) {\n        ::close(listener);\n        return -1;\n    }\n\n    // put in listen mode, set permissions, and rename into place\n    res = ::listen(listener, 5);\n    if (res == 0) {\n        RESTARTABLE(::chmod(initial_path, S_IREAD | S_IWRITE), res);\n        if (res == 0) {\n            if (res == 0) {\n                res = ::rename(initial_path, path);\n            }\n        }\n    }\n    if (res == -1) {\n        ::close(listener);\n        ::unlink(initial_path);\n        return -1;\n    }\n    set_path(path);\n    set_listener(listener);\n\n    return 0;\n}\n```\n\n一旦收到java发送过来的socket请求，则解析该请求并包装为AttachOperation对象。\n\n```C++\n/**\n * accept domain socket，读取到内容后生成对应的AttachOperation\n * @return\n */\nAttachOperation *AttachListener::dequeue() {\n    for (;;) {\n        int s;\n\n        // wait for client to connect\n        struct sockaddr addr;\n        socklen_t len = sizeof(addr);\n        RESTARTABLE(::accept(listener(), &addr, &len), s);\n        if (s == -1) {\n            return NULL;      // log a warning?\n        }\n\n        // get the credentials of the peer and check the effective uid/guid\n        // - check with jeff on this.\n        uid_t puid;\n        gid_t pgid;\n        if (::getpeereid(s, &puid, &pgid) != 0) {\n            ::close(s);\n            continue;\n        }\n        uid_t euid = geteuid();\n        gid_t egid = getegid();\n\n        //检查DS文件是否为同一个用户创建\n        if (puid != euid || pgid != egid) {\n            ::close(s);\n            continue;\n        }\n\n        // 读取文件内容，生成AttachOperation对象\n        AttachOperation *op = read_request(s);\n        if (op == NULL) {\n            ::close(s);\n            continue;\n        } else {\n            return op;\n        }\n    }\n}\n```\n\n最后用包装后的AttachOperation，通过函数指针调用已绑定的处理函数。\n\n```C++\nstatic void attach_listener_thread_entry() {\n    int pdint = AttachListener::pd_init();\n    if (pdint != 0) {\n        return;\n    }\n    AttachListener::set_initialized();\n\n    for (;;) {\n        AttachOperation* op = AttachListener::dequeue();\n        if (op == NULL) {\n            return;   // dequeue failed or shutdown\n        }\n\n        // find the function to dispatch too\n        AttachOperationFunctionInfo* info = NULL;\n        for (int i=0; funcs[i].name != NULL; i++) {\n            const char* name = funcs[i].name;\n            if (strcmp(op->name(), name) == 0) {\n                info = &(funcs[i]);\n                break;\n            }\n        }\n\n        if (info != NULL) {\n            // dispatch to the function that implements this operation\n            (info->func)(op);\n        }\n    }\n}\n```\n\n<font color=red>总结</font> ，通过信号监听-->socket通信-->调用指定方法的流程，实现了我们实验的预期。\n\n## 四、看看JVM是怎么做的\n最后我们回到JVM内部，看看JVM是如何实现的。\n\n由于实验代码大量的采用了JVM的实现，我们这里主要观察JVM的流程。\n\n* JVM启动时会初始化信号的监听\n\n> 代码清单：src/share/vm/runtime/thread.cpp\n\n```C++\njint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {\n    ...\n\n  // Signal Dispatcher needs to be started before VMInit event is posted\n  os::signal_init();\n\n  // Start Attach Listener if +StartAttachListener or it can't be started lazily\n  if (!DisableAttachMechanism) {\n    AttachListener::vm_start();\n    if (StartAttachListener || AttachListener::init_at_startup()) {\n      AttachListener::init();\n    }\n  }\n    ...\n}\n```\n\nos::signal_init();功能我们前面已经分析过，JVM会注册kill -3信号的监听和对应的信号处理器，同时会启动一个单独的线程对监听到的信号做后续业务处理。\n\n<font color=blue>DisableAttachMechanism</font> & <font color=blue>StartAttachListener</font> 默认为false，在JVM默认启动的情况下不会初始化Attach的监听。\n\n> 代码清单：src/share/vm/runtime/globals.hpp\n\n```C+++\n  product(bool, DisableAttachMechanism, false,                              \\\n          \"Disable mechanism that allows tools to attach to this VM\") \n  product(bool, StartAttachListener, false,                                 \\\n          \"Always start Attach Listener at VM startup\")      \n```\n\nJVM监听到信号后，当信号位kill -3时如果还未初始化attach监听，将会进行相应初始化过程。\n> 代码清单：src/share/vm/runtime/thread.cpp->create_vm()\n>             ---- src/share/vm/runtime/os.cpp->signal_init()\n>                 ---- src/share/vm/runtime/os.cpp->signal_thread_entry()\n\n\n```C++\nstatic void signal_thread_entry(JavaThread* thread, TRAPS) {\n  os::set_priority(thread, NearMaxPriority);\n  while (true) {\n    int sig;\n    {\n      // FIXME : Currently we have not decieded what should be the status\n      //         for this java thread blocked here. Once we decide about\n      //         that we should fix this.\n      sig = os::signal_wait();\n    }\n    if (sig == os::sigexitnum_pd()) {\n       // Terminate the signal thread\n       return;\n    }\n\n    switch (sig) {\n      case SIGBREAK: {\n        // Check if the signal is a trigger to start the Attach Listener - in that\n        // case don't print stack traces.\n        if (!DisableAttachMechanism && AttachListener::is_init_trigger()) {\n          continue;\n        }\n        // Print stack traces\n        // Any SIGBREAK operations added here should make sure to flush\n        // the output stream (e.g. tty->flush()) after output.  See 4803766.\n        // Each module also prints an extra carriage return after its output.\n        VM_PrintThreads op;\n        VMThread::execute(&op);\n        VM_PrintJNI jni_op;\n        VMThread::execute(&jni_op);\n        VM_FindDeadlocks op1(tty);\n        VMThread::execute(&op1);\n        Universe::print_heap_at_SIGBREAK();\n        if (PrintClassHistogram) {\n          VM_GC_HeapInspection op1(gclog_or_tty, true /* force full GC before heap inspection */);\n          VMThread::execute(&op1);\n        }\n        if (JvmtiExport::should_post_data_dump()) {\n          JvmtiExport::post_data_dump();\n        }\n        break;\n      }\n      ...\n  }\n}\n```\n\n初始化Attach监听时会检查Java客户端生成的attach文件。\n> 代码清单：src/share/vm/runtime/thread.cpp->create_vm()\n>             ---- src/share/vm/runtime/os.cpp->signal_init()\n>                 ---- src/share/vm/runtime/os.cpp->signal_thread_entry()\n>                      ---- src/os/bsd/vm/attachListener_bsd.cpp->is_init_trigger()\n\n\n```C++\nbool AttachListener::is_init_trigger() {\n  if (init_at_startup() || is_initialized()) {\n    return false;               // initialized at startup or already initialized\n  }\n  char path[PATH_MAX + 1];\n  int ret;\n  struct stat st;\n\n  snprintf(path, PATH_MAX + 1, \"%s/.attach_pid%d\",\n           os::get_temp_directory(), os::current_process_id());\n  RESTARTABLE(::stat(path, &st), ret);\n  if (ret == 0) {\n    // simple check to avoid starting the attach mechanism when\n    // a bogus user creates the file\n    if (st.st_uid == geteuid()) {\n      init();\n      return true;\n    }\n  }\n  return false;\n}\n```\n\n确认Java客户端开始attach并且权限校验通过后开始socket通讯，首先初始化socket并绑定监听。\n>代码清单： src/os/bsd/vm/attachListener_bsd.cpp->is_init_trigger()\n>             ---- src/share/vm/services/attachListener.cpp->init()\n\n\n```C++\nbool AttachListener::is_init_trigger() {\n  if (init_at_startup() || is_initialized()) {\n    return false;               // initialized at startup or already initialized\n  }\n  char path[PATH_MAX + 1];\n  int ret;\n  struct stat st;\n\n  snprintf(path, PATH_MAX + 1, \"%s/.attach_pid%d\",\n           os::get_temp_directory(), os::current_process_id());\n  RESTARTABLE(::stat(path, &st), ret);\n  if (ret == 0) {\n    // simple check to avoid starting the attach mechanism when\n    // a bogus user creates the file\n    if (st.st_uid == geteuid()) {\n      init();\n      return true;\n    }\n  }\n  return false;\n}\n```\n\n最终JVM创建了一个单独的线程执行Attach监听方法，方法accept从Java客户端发送的指令，并解析为对应的函数。\n>代码清单： src/share/vm/services/attachListener.cpp->init()\n>             ---- src/share/vm/services/attachListener.cpp->attach_listener_thread_entry()\n\n\n```C++\nstatic void attach_listener_thread_entry(JavaThread* thread, TRAPS) {\n  os::set_priority(thread, NearMaxPriority);\n\n  thread->record_stack_base_and_size();\n\n  if (AttachListener::pd_init() != 0) {\n    return;\n  }\n  AttachListener::set_initialized();\n\n  for (;;) {\n    AttachOperation* op = AttachListener::dequeue();\n    if (op == NULL) {\n      return;   // dequeue failed or shutdown\n    }\n\n    ResourceMark rm;\n    bufferedStream st;\n    jint res = JNI_OK;\n\n    // handle special detachall operation\n    if (strcmp(op->name(), AttachOperation::detachall_operation_name()) == 0) {\n      AttachListener::detachall();\n    } else {\n      // find the function to dispatch too\n      AttachOperationFunctionInfo* info = NULL;\n      for (int i=0; funcs[i].name != NULL; i++) {\n        const char* name = funcs[i].name;\n        assert(strlen(name) <= AttachOperation::name_length_max, \"operation <= name_length_max\");\n        if (strcmp(op->name(), name) == 0) {\n          info = &(funcs[i]);\n          break;\n        }\n      }\n\n      // check for platform dependent attach operation\n      if (info == NULL) {\n        info = AttachListener::pd_find_operation(op->name());\n      }\n\n      if (info != NULL) {\n        // dispatch to the function that implements this operation\n        res = (info->func)(op, &st);\n      } else {\n        st.print(\"Operation %s not recognized!\", op->name());\n        res = JNI_ERR;\n      }\n    }\n\n    // operation complete - send result and output to client\n    op->complete(res, &st);\n  }\n}\n```\n\n>代码清单： src/share/vm/services/attachListener.cpp->attach_listener_thread_entry()\n>             ---- src/os/bsd/vm/attachListener_bsd.cpp->dequeue()\n>                  ---- src/os/bsd/vm/attachListener_bsd.cpp->BsdAttachListener::dequeue()\n\n\n```C++\nBsdAttachOperation* BsdAttachListener::dequeue() {\n  for (;;) {\n    int s;\n\n    // wait for client to connect\n    struct sockaddr addr;\n    socklen_t len = sizeof(addr);\n    RESTARTABLE(::accept(listener(), &addr, &len), s);\n    if (s == -1) {\n      return NULL;      // log a warning?\n    }\n\n    // get the credentials of the peer and check the effective uid/guid\n    // - check with jeff on this.\n    uid_t puid;\n    gid_t pgid;\n    if (::getpeereid(s, &puid, &pgid) != 0) {\n      ::close(s);\n      continue;\n    }\n    uid_t euid = geteuid();\n    gid_t egid = getegid();\n\n    if (puid != euid || pgid != egid) {\n      ::close(s);\n      continue;\n    }\n\n    // peer credential look okay so we read the request\n    BsdAttachOperation* op = read_request(s);\n    if (op == NULL) {\n      ::close(s);\n      continue;\n    } else {\n      return op;\n    }\n  }\n}\n```\n\n指令与方法的映射是事先准备好的\n> 代码清单：src/share/vm/services/attachListener.cpp\n```C++\nstatic AttachOperationFunctionInfo funcs[] = {\n  { \"agentProperties\",  get_agent_properties },\n  { \"datadump\",         data_dump },\n  { \"dumpheap\",         dump_heap },\n  { \"load\",             JvmtiExport::load_agent_library },\n  { \"properties\",       get_system_properties },\n  { \"threaddump\",       thread_dump },\n  { \"inspectheap\",      heap_inspection },\n  { \"setflag\",          set_flag },\n  { \"printflag\",        print_flag },\n  { \"jcmd\",             jcmd },\n  { NULL,               NULL }\n};\n```\n\n\n<font color=red>总结</font>,相信通过上面的分析我们已经清楚的了解JVM是如何接收到Java客户端发起的请求，从而实现动态Attach的功能。具体流程如图：\n![03](深度解析JVM-动态Attach原理/flow.png)","source":"_posts/深度解析JVM-动态Attach原理.md","raw":"---\ntitle: 深度剖析JVM 动态Attach原理\ndate: 2020-09-21 19:01:04\ntags:\n    - Java\n    - JVM\ncategories:\n    - Technology\n---\n\n相信很多小伙伴都使用过javaagent探针技术，javaagent可以在不侵入原代码不的前提下，通过指定方法并利用动态字节码技术增强我们的代码。很多成熟的框架也运用到了该技术，如skywalking等。这么好用的功能，JDK的开发人员没道理不玩出些新花头，因此在JDK1.6中，更加强大的JVM 动态Attach技术展现在我们的面前。大名鼎鼎的Btrace、Arthas等都运用了动态Attach技术。在JVM运行期进拦截并增强我们的代码，使得以往生产难以定位的问题变得更加容易排查。\n<!-- more -->\nJVM的动态Attach固然好，相信大家或多或少已经知道如何去使用该技术了，所以这次我们研究的重点是JVM是如何实现动态Attach，至于JVM如何加载动态Jar包、分发方法并传递jvm上下文就不在我们的研究范围之内。\n\n为了更好的研究JVM的实现，我们将由浅入深，分为几个阶段进行研究：\n* 动态Attach是什么？\n* 有几种方案可以实现动态Attach\n* 举一个栗子\n* 看看JVM是怎么做的\n\n## 一、动态Attach是什么\n虽然我们这次研究的是具体的实现，但在这之前，我们需要像分析需求一样分析下动态Attach到底是什么。\n\n我们都知道javaagent参数是伴随着java命令，在JVM启动的过程中加载javaagent参数指定的Jar包路径，并执行约定类的premain方法。在premain方法中可以获取Instrumentation类型参数，从而对我们的类进行动态增强增强。\n\n我们可以这样使用javaagent：\n1. 先实现一个我们需要挂在的类，其中需要实现premain()方法，并将它打包为可执行Jar包\n``` java\npublic class Javaagent {\n    public static void premain(String agentArgs, Instrumentation inst) {\n        System.out.println(\"agentArgs : \" + agentArgs);\n        inst.addTransformer(new TestTransformer(), true);\n    }\n\n    static class TestTransformer implements ClassFileTransformer {\n\n        @Override\n        public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {\n            System.out.println(\"premain load Class:\" + className);\n            return classfileBuffer;\n        }\n    }\n}\n```\n\n2. 配置MANIFEST.MF配置文件\n```xml\nPremain-Class: Javaagent\nAgent-Class: Javaagent\nCan-Redefine-Classes: true\nCan-Retransform-Classes: true\n```\n\n3. 启动我们的服务\n```shell\njava -javaagent:Javaagent.jar 自己的服务.jar\n```\n\n以上就是一个简单的javaagent运用场景。javaagent可以在不侵入业务代码的前提下修改我们已加载的类，但唯一的问题是需要伴随着业务服务一同启动。也就是说我们无法侵入已经运行在JVM中的代码，因此JDK开发的大神们为我们带来了动态Attach API。其功能与javaagent是一样的，但最大的好处就是我们能够在一个已经运行的JVM上动态的挂载一个我们自己开发的Jar包，从而实现任何时间点我们都能手动的增强业务代码。比如通过attach Arthas，我们能增强指定方法的入口&出口，从而获取出入参的相关信息。这在缺少日志输出的场景下是非常有效的问题定位手段。此外我们也能为方法的调用链做埋点，帮助我们分析业务流程中的慢方法等等。\n\n总结下，动态Attach就是JVM运行期中提供的指定类型的类加载机制。通过增强类的加载，实现各式各样有趣的功能。\n\n## 二、有几种方案可以实现动态Attach\n现在我们已经知道什么是动态Attach了，倘若我们是JDK的工程师，当产品交给我们需要实现动态Attach这个需求时，我们会怎么实现呢？\n#### 1.直接类加载法\nJDK已经提供了一套完善的类加载机制，如果提供获取Instrumentation对象的JNI，开发人员就可以自行通过动态类加载后进行字节码动态增强。这个方案看似很美好，现有Java生态圈已经拥有丰富的Class动态加载方案，利用这些现有方案，开发人员能够很快的搭建出自己的字节码动态加载机制，而无需JVM提供大量的native支持。但是这个方案存在重大的安全问题，一旦服务的动态加载机制被黑客破解，那么他完全能够加载一个自己编写好的侵入类，通过入侵类任意修改业务代码最终导致无法挽回的损失。所以作为一个JDK开发工程师，一定要在初期就屏蔽这种安全问题。同时Java最为一种安全语言，不安全的操作需要尽量避免引入Java生态中。\n#### 2.Socket通信法\n既然提供JNI不安全，那么我们是否可以考虑让JVM自己处理。假设我们能和JVM建立起Socket通讯。并将我们希望加载的类告知JVM，JVM在加载完成后按照约定执行指定的入口方法，这样也能实现我们对动态Attach的实现。\n\nSocket通信可以分为远程通信和本地通信。我们需要考虑，如果采用远程通信，的确能给我们带来更强大的Attach灵活性，但需要JVM暴露端口，同样具有一定的安全问题。\n本地通讯我们可以采用UNIX Domain Socket，通过文件形式通讯。不但具有较高的通信速度，同时具有一定的安全性。\n\n如果采用Socket Local通信，那我们又如何与JVM建立起通信呢？\n#### 3.信号监听法\n其实这个方法是Socket通信法的补充。在与JVM建立起本地通信前，JVM需要知道用户想要开始动态Attach。而信号监听就能补充这方面的功能。客户端以约定的形式向JVM进程发起指定信号，同时JVM在监听到Attach信号后与客户端建立Socket链接。客户端以Socket方式将需要加载的类告知JVM并进行加载并最终运行我们后面熟悉的javaagent流程。\n\n我虽然不是JDK的工程师，上面的3个方案也是结合了JDK1.8的具体实现后大胆的揣测了当时开发工程师的想法。可能当时摆在他面前的方案更是成千上万，但是最终确定下这个技术方案的心路历程我觉得是我们每个开发都需要感同身受的。\n\n## 三、举一个栗子\n前面我们分析了实现方案，我们先丢一份代码来验证上面的方案（代码为JDK1.8源码相关功能的简化版）\n\n### 开始实验\n\n<font color=blue>需求：</font>实现动态Attach API，接收java -jar xxx.jar pid发起的挂载请求，并将loadAgent指定的Jar包完整路径显示在控制台。\n\n<font color=blue>实验环境：</font>MacOS 10.15.6\n\n<font color=blue>项目地址：</font>\n> https://github.com/xzenge/JVM_ATTACH/tree/dev\n\n##### 我们先启动项目。该项目模拟了JVM运行环境，但只实现了Attach API的部分功能。项目启动成功后，我们可以看到当前的JVM进程ID为：<font color=red>32910</font>\n\n![01](深度解析JVM-动态Attach原理/JVM_start.png)\n\n----\n\n##### 按照JDK规范编写JAVA测Attach方法。为了简便，方法中我们手动指定了attach的线程号，并提供了JVM需要加载的Jar包路径。\n\n```java\npublic class Attach {\n    public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException {\n        VirtualMachine attach = VirtualMachine.attach(\"32910\");\n        attach.loadAgentPath(\"/Users/xiangshi/.gradle/caches/modules-2/files-2.1/cglib/cglib/3.1/1f1cb6c7a7479e0c7fd7987109e503914bebe84a/cglib-3.1.jar\");\n\n\n    }\n}\n\n```\n\n----\n##### 运行Java attach方法，我们可以观察到模拟的JVM已经读取到了我们希望classloader的Jar包\n\n![02](深度解析JVM-动态Attach原理/load_agent_library.png)\n\n----\n\n### 实验分析\n实验过程很简单，我们伪造了个JVM运行时环境。并通过JAVA原生的Attach API成功的实现了与JVM之间通讯的功能。下面我们开始逐步分析具体的实现过程：\n\n* 监听signal\n初始化OS信号监听的相关数据\n\n``` C++\n/**\n * JVM启动时监听signal\n */\nvoid os::signal_init() {\n    //初始化signal监听pending_signals\n    os::signal_init_pd();\n    //创建线程监听pending_signals状态并进行相应处理\n    pthread_t tids;\n    int ret = pthread_create(&tids, NULL, reinterpret_cast<void *(*)(void *)>(signal_thread_entry), NULL);\n    //注册signal处理器\n    os::signal(SIGBREAK,os::user_handler());\n}\n```\n\nsigaction方法提供os信号的监听并注册信号处理器，我们监听-3 SIGQUIT信号。\n\n```C++\n/**\n * 注册监听信号&处理器\n * @param signal_number 信号编号\n * @param handler 信号处理器\n * @return\n */\nvoid *os::signal(int signal_number, void *handler) {\n    struct sigaction sigAct, oldSigAct;\n\n    sigfillset(&(sigAct.sa_mask));\n    sigAct.sa_flags   = SA_RESTART|SA_SIGINFO;\n    sigAct.sa_handler = CAST_TO_FN_PTR(sa_handler_t, handler);\n\n    if (sigaction(signal_number, &sigAct, &oldSigAct)) {\n        // -1 means registration failed\n        return (void *)-1;\n    }\n\n    return CAST_FROM_FN_PTR(void*, oldSigAct.sa_handler);\n}\n```\n\n信号处理器中简单的模拟的收到信号的处理过程，数组对应的信号位置为1时，说明收到了对应的信号。\n\n```C++\n/**\n * 通过pending_signals保留监听到的信息，交由专门的线程处理该信息\n * @param signal_number\n */\nvoid os::signal_notify(int signal_number) {\n    cout << \"enter signal_notify sig:\" << signal_number << endl;\n    //将监听到的信号为竖为1\n    //改操作应该为原子操作，确保不会被其他线程修改\n    //JVM中混编平台相关汇编指令实现原子操作，演示代码中不研究相关实现\n    pending_signals[signal_number] = 1;\n\n    semaphore_signal(sig_sem);\n}\n```\n\n单独起一个线程，该线程轮训信号接受数组的状态，将置为1的信号码传给下游处理。当信号位-3 SIGQUIT信号时，开始初始化attach的监听方法。\n\n```C++\n/**\n * 单独线程对pending_signals状态并进行相应处理\n */\nstatic void signal_thread_entry() {\n    cout << \"enter signal_thread_entry\" << endl;\n    while (true){\n        int sig;\n        {\n            sig = os::signal_wait();\n        }\n        switch (sig) {\n            case SIGBREAK: {\n                if (AttachListener::init()) {\n                    continue;\n                }\n            }\n        }\n\n    }\n}\n```\n\n初始化attach监听方法时，会创建一个Domain Socket的文件监听，并accept在改文件上。\n\n```C++\n/**\n * 初始化domain socket监听\n * JVM通过监听指定线程文件文件\n * 获取client想JVM发送的指令并进行相关操作\n * @return\n */\nint AttachListener::pd_init() {\n    char path[UNIX_PATH_MAX];          // socket file\n    char initial_path[UNIX_PATH_MAX];  // socket file during setup\n    int listener;                      // listener socket (file descriptor)\n\n    // register function to cleanup\n    ::atexit(listener_cleanup);\n\n    int n = snprintf(path, UNIX_PATH_MAX, \"%s/.java_pid%d\",\n                     TEMP_PATH, getpid());\n    if (n < (int) UNIX_PATH_MAX) {\n        n = snprintf(initial_path, UNIX_PATH_MAX, \"%s.tmp\", path);\n    }\n    if (n >= (int) UNIX_PATH_MAX) {\n        return -1;\n    }\n    cout << \"path:\" << path << endl;\n    // create the listener socket\n    listener = ::socket(PF_UNIX, SOCK_STREAM, 0);\n    if (listener == -1) {\n        return -1;\n    }\n\n    // bind socket\n    struct sockaddr_un addr;\n    addr.sun_family = AF_UNIX;\n    strcpy(addr.sun_path, initial_path);\n    ::unlink(initial_path);\n    int res = ::bind(listener, (struct sockaddr *) &addr, sizeof(addr));\n    if (res == -1) {\n        ::close(listener);\n        return -1;\n    }\n\n    // put in listen mode, set permissions, and rename into place\n    res = ::listen(listener, 5);\n    if (res == 0) {\n        RESTARTABLE(::chmod(initial_path, S_IREAD | S_IWRITE), res);\n        if (res == 0) {\n            if (res == 0) {\n                res = ::rename(initial_path, path);\n            }\n        }\n    }\n    if (res == -1) {\n        ::close(listener);\n        ::unlink(initial_path);\n        return -1;\n    }\n    set_path(path);\n    set_listener(listener);\n\n    return 0;\n}\n```\n\n一旦收到java发送过来的socket请求，则解析该请求并包装为AttachOperation对象。\n\n```C++\n/**\n * accept domain socket，读取到内容后生成对应的AttachOperation\n * @return\n */\nAttachOperation *AttachListener::dequeue() {\n    for (;;) {\n        int s;\n\n        // wait for client to connect\n        struct sockaddr addr;\n        socklen_t len = sizeof(addr);\n        RESTARTABLE(::accept(listener(), &addr, &len), s);\n        if (s == -1) {\n            return NULL;      // log a warning?\n        }\n\n        // get the credentials of the peer and check the effective uid/guid\n        // - check with jeff on this.\n        uid_t puid;\n        gid_t pgid;\n        if (::getpeereid(s, &puid, &pgid) != 0) {\n            ::close(s);\n            continue;\n        }\n        uid_t euid = geteuid();\n        gid_t egid = getegid();\n\n        //检查DS文件是否为同一个用户创建\n        if (puid != euid || pgid != egid) {\n            ::close(s);\n            continue;\n        }\n\n        // 读取文件内容，生成AttachOperation对象\n        AttachOperation *op = read_request(s);\n        if (op == NULL) {\n            ::close(s);\n            continue;\n        } else {\n            return op;\n        }\n    }\n}\n```\n\n最后用包装后的AttachOperation，通过函数指针调用已绑定的处理函数。\n\n```C++\nstatic void attach_listener_thread_entry() {\n    int pdint = AttachListener::pd_init();\n    if (pdint != 0) {\n        return;\n    }\n    AttachListener::set_initialized();\n\n    for (;;) {\n        AttachOperation* op = AttachListener::dequeue();\n        if (op == NULL) {\n            return;   // dequeue failed or shutdown\n        }\n\n        // find the function to dispatch too\n        AttachOperationFunctionInfo* info = NULL;\n        for (int i=0; funcs[i].name != NULL; i++) {\n            const char* name = funcs[i].name;\n            if (strcmp(op->name(), name) == 0) {\n                info = &(funcs[i]);\n                break;\n            }\n        }\n\n        if (info != NULL) {\n            // dispatch to the function that implements this operation\n            (info->func)(op);\n        }\n    }\n}\n```\n\n<font color=red>总结</font> ，通过信号监听-->socket通信-->调用指定方法的流程，实现了我们实验的预期。\n\n## 四、看看JVM是怎么做的\n最后我们回到JVM内部，看看JVM是如何实现的。\n\n由于实验代码大量的采用了JVM的实现，我们这里主要观察JVM的流程。\n\n* JVM启动时会初始化信号的监听\n\n> 代码清单：src/share/vm/runtime/thread.cpp\n\n```C++\njint Threads::create_vm(JavaVMInitArgs* args, bool* canTryAgain) {\n    ...\n\n  // Signal Dispatcher needs to be started before VMInit event is posted\n  os::signal_init();\n\n  // Start Attach Listener if +StartAttachListener or it can't be started lazily\n  if (!DisableAttachMechanism) {\n    AttachListener::vm_start();\n    if (StartAttachListener || AttachListener::init_at_startup()) {\n      AttachListener::init();\n    }\n  }\n    ...\n}\n```\n\nos::signal_init();功能我们前面已经分析过，JVM会注册kill -3信号的监听和对应的信号处理器，同时会启动一个单独的线程对监听到的信号做后续业务处理。\n\n<font color=blue>DisableAttachMechanism</font> & <font color=blue>StartAttachListener</font> 默认为false，在JVM默认启动的情况下不会初始化Attach的监听。\n\n> 代码清单：src/share/vm/runtime/globals.hpp\n\n```C+++\n  product(bool, DisableAttachMechanism, false,                              \\\n          \"Disable mechanism that allows tools to attach to this VM\") \n  product(bool, StartAttachListener, false,                                 \\\n          \"Always start Attach Listener at VM startup\")      \n```\n\nJVM监听到信号后，当信号位kill -3时如果还未初始化attach监听，将会进行相应初始化过程。\n> 代码清单：src/share/vm/runtime/thread.cpp->create_vm()\n>             ---- src/share/vm/runtime/os.cpp->signal_init()\n>                 ---- src/share/vm/runtime/os.cpp->signal_thread_entry()\n\n\n```C++\nstatic void signal_thread_entry(JavaThread* thread, TRAPS) {\n  os::set_priority(thread, NearMaxPriority);\n  while (true) {\n    int sig;\n    {\n      // FIXME : Currently we have not decieded what should be the status\n      //         for this java thread blocked here. Once we decide about\n      //         that we should fix this.\n      sig = os::signal_wait();\n    }\n    if (sig == os::sigexitnum_pd()) {\n       // Terminate the signal thread\n       return;\n    }\n\n    switch (sig) {\n      case SIGBREAK: {\n        // Check if the signal is a trigger to start the Attach Listener - in that\n        // case don't print stack traces.\n        if (!DisableAttachMechanism && AttachListener::is_init_trigger()) {\n          continue;\n        }\n        // Print stack traces\n        // Any SIGBREAK operations added here should make sure to flush\n        // the output stream (e.g. tty->flush()) after output.  See 4803766.\n        // Each module also prints an extra carriage return after its output.\n        VM_PrintThreads op;\n        VMThread::execute(&op);\n        VM_PrintJNI jni_op;\n        VMThread::execute(&jni_op);\n        VM_FindDeadlocks op1(tty);\n        VMThread::execute(&op1);\n        Universe::print_heap_at_SIGBREAK();\n        if (PrintClassHistogram) {\n          VM_GC_HeapInspection op1(gclog_or_tty, true /* force full GC before heap inspection */);\n          VMThread::execute(&op1);\n        }\n        if (JvmtiExport::should_post_data_dump()) {\n          JvmtiExport::post_data_dump();\n        }\n        break;\n      }\n      ...\n  }\n}\n```\n\n初始化Attach监听时会检查Java客户端生成的attach文件。\n> 代码清单：src/share/vm/runtime/thread.cpp->create_vm()\n>             ---- src/share/vm/runtime/os.cpp->signal_init()\n>                 ---- src/share/vm/runtime/os.cpp->signal_thread_entry()\n>                      ---- src/os/bsd/vm/attachListener_bsd.cpp->is_init_trigger()\n\n\n```C++\nbool AttachListener::is_init_trigger() {\n  if (init_at_startup() || is_initialized()) {\n    return false;               // initialized at startup or already initialized\n  }\n  char path[PATH_MAX + 1];\n  int ret;\n  struct stat st;\n\n  snprintf(path, PATH_MAX + 1, \"%s/.attach_pid%d\",\n           os::get_temp_directory(), os::current_process_id());\n  RESTARTABLE(::stat(path, &st), ret);\n  if (ret == 0) {\n    // simple check to avoid starting the attach mechanism when\n    // a bogus user creates the file\n    if (st.st_uid == geteuid()) {\n      init();\n      return true;\n    }\n  }\n  return false;\n}\n```\n\n确认Java客户端开始attach并且权限校验通过后开始socket通讯，首先初始化socket并绑定监听。\n>代码清单： src/os/bsd/vm/attachListener_bsd.cpp->is_init_trigger()\n>             ---- src/share/vm/services/attachListener.cpp->init()\n\n\n```C++\nbool AttachListener::is_init_trigger() {\n  if (init_at_startup() || is_initialized()) {\n    return false;               // initialized at startup or already initialized\n  }\n  char path[PATH_MAX + 1];\n  int ret;\n  struct stat st;\n\n  snprintf(path, PATH_MAX + 1, \"%s/.attach_pid%d\",\n           os::get_temp_directory(), os::current_process_id());\n  RESTARTABLE(::stat(path, &st), ret);\n  if (ret == 0) {\n    // simple check to avoid starting the attach mechanism when\n    // a bogus user creates the file\n    if (st.st_uid == geteuid()) {\n      init();\n      return true;\n    }\n  }\n  return false;\n}\n```\n\n最终JVM创建了一个单独的线程执行Attach监听方法，方法accept从Java客户端发送的指令，并解析为对应的函数。\n>代码清单： src/share/vm/services/attachListener.cpp->init()\n>             ---- src/share/vm/services/attachListener.cpp->attach_listener_thread_entry()\n\n\n```C++\nstatic void attach_listener_thread_entry(JavaThread* thread, TRAPS) {\n  os::set_priority(thread, NearMaxPriority);\n\n  thread->record_stack_base_and_size();\n\n  if (AttachListener::pd_init() != 0) {\n    return;\n  }\n  AttachListener::set_initialized();\n\n  for (;;) {\n    AttachOperation* op = AttachListener::dequeue();\n    if (op == NULL) {\n      return;   // dequeue failed or shutdown\n    }\n\n    ResourceMark rm;\n    bufferedStream st;\n    jint res = JNI_OK;\n\n    // handle special detachall operation\n    if (strcmp(op->name(), AttachOperation::detachall_operation_name()) == 0) {\n      AttachListener::detachall();\n    } else {\n      // find the function to dispatch too\n      AttachOperationFunctionInfo* info = NULL;\n      for (int i=0; funcs[i].name != NULL; i++) {\n        const char* name = funcs[i].name;\n        assert(strlen(name) <= AttachOperation::name_length_max, \"operation <= name_length_max\");\n        if (strcmp(op->name(), name) == 0) {\n          info = &(funcs[i]);\n          break;\n        }\n      }\n\n      // check for platform dependent attach operation\n      if (info == NULL) {\n        info = AttachListener::pd_find_operation(op->name());\n      }\n\n      if (info != NULL) {\n        // dispatch to the function that implements this operation\n        res = (info->func)(op, &st);\n      } else {\n        st.print(\"Operation %s not recognized!\", op->name());\n        res = JNI_ERR;\n      }\n    }\n\n    // operation complete - send result and output to client\n    op->complete(res, &st);\n  }\n}\n```\n\n>代码清单： src/share/vm/services/attachListener.cpp->attach_listener_thread_entry()\n>             ---- src/os/bsd/vm/attachListener_bsd.cpp->dequeue()\n>                  ---- src/os/bsd/vm/attachListener_bsd.cpp->BsdAttachListener::dequeue()\n\n\n```C++\nBsdAttachOperation* BsdAttachListener::dequeue() {\n  for (;;) {\n    int s;\n\n    // wait for client to connect\n    struct sockaddr addr;\n    socklen_t len = sizeof(addr);\n    RESTARTABLE(::accept(listener(), &addr, &len), s);\n    if (s == -1) {\n      return NULL;      // log a warning?\n    }\n\n    // get the credentials of the peer and check the effective uid/guid\n    // - check with jeff on this.\n    uid_t puid;\n    gid_t pgid;\n    if (::getpeereid(s, &puid, &pgid) != 0) {\n      ::close(s);\n      continue;\n    }\n    uid_t euid = geteuid();\n    gid_t egid = getegid();\n\n    if (puid != euid || pgid != egid) {\n      ::close(s);\n      continue;\n    }\n\n    // peer credential look okay so we read the request\n    BsdAttachOperation* op = read_request(s);\n    if (op == NULL) {\n      ::close(s);\n      continue;\n    } else {\n      return op;\n    }\n  }\n}\n```\n\n指令与方法的映射是事先准备好的\n> 代码清单：src/share/vm/services/attachListener.cpp\n```C++\nstatic AttachOperationFunctionInfo funcs[] = {\n  { \"agentProperties\",  get_agent_properties },\n  { \"datadump\",         data_dump },\n  { \"dumpheap\",         dump_heap },\n  { \"load\",             JvmtiExport::load_agent_library },\n  { \"properties\",       get_system_properties },\n  { \"threaddump\",       thread_dump },\n  { \"inspectheap\",      heap_inspection },\n  { \"setflag\",          set_flag },\n  { \"printflag\",        print_flag },\n  { \"jcmd\",             jcmd },\n  { NULL,               NULL }\n};\n```\n\n\n<font color=red>总结</font>,相信通过上面的分析我们已经清楚的了解JVM是如何接收到Java客户端发起的请求，从而实现动态Attach的功能。具体流程如图：\n![03](深度解析JVM-动态Attach原理/flow.png)","slug":"深度解析JVM-动态Attach原理","published":1,"updated":"2020-12-14T10:27:57.231Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckis71hul004qv252637lc9sc","content":"<html><head></head><body><p>&#x76F8;&#x4FE1;&#x5F88;&#x591A;&#x5C0F;&#x4F19;&#x4F34;&#x90FD;&#x4F7F;&#x7528;&#x8FC7;javaagent&#x63A2;&#x9488;&#x6280;&#x672F;&#xFF0C;javaagent&#x53EF;&#x4EE5;&#x5728;&#x4E0D;&#x4FB5;&#x5165;&#x539F;&#x4EE3;&#x7801;&#x4E0D;&#x7684;&#x524D;&#x63D0;&#x4E0B;&#xFF0C;&#x901A;&#x8FC7;&#x6307;&#x5B9A;&#x65B9;&#x6CD5;&#x5E76;&#x5229;&#x7528;&#x52A8;&#x6001;&#x5B57;&#x8282;&#x7801;&#x6280;&#x672F;&#x589E;&#x5F3A;&#x6211;&#x4EEC;&#x7684;&#x4EE3;&#x7801;&#x3002;&#x5F88;&#x591A;&#x6210;&#x719F;&#x7684;&#x6846;&#x67B6;&#x4E5F;&#x8FD0;&#x7528;&#x5230;&#x4E86;&#x8BE5;&#x6280;&#x672F;&#xFF0C;&#x5982;skywalking&#x7B49;&#x3002;&#x8FD9;&#x4E48;&#x597D;&#x7528;&#x7684;&#x529F;&#x80FD;&#xFF0C;JDK&#x7684;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x6CA1;&#x9053;&#x7406;&#x4E0D;&#x73A9;&#x51FA;&#x4E9B;&#x65B0;&#x82B1;&#x5934;&#xFF0C;&#x56E0;&#x6B64;&#x5728;JDK1.6&#x4E2D;&#xFF0C;&#x66F4;&#x52A0;&#x5F3A;&#x5927;&#x7684;JVM &#x52A8;&#x6001;Attach&#x6280;&#x672F;&#x5C55;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x9762;&#x524D;&#x3002;&#x5927;&#x540D;&#x9F0E;&#x9F0E;&#x7684;Btrace&#x3001;Arthas&#x7B49;&#x90FD;&#x8FD0;&#x7528;&#x4E86;&#x52A8;&#x6001;Attach&#x6280;&#x672F;&#x3002;&#x5728;JVM&#x8FD0;&#x884C;&#x671F;&#x8FDB;&#x62E6;&#x622A;&#x5E76;&#x589E;&#x5F3A;&#x6211;&#x4EEC;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x4F7F;&#x5F97;&#x4EE5;&#x5F80;&#x751F;&#x4EA7;&#x96BE;&#x4EE5;&#x5B9A;&#x4F4D;&#x7684;&#x95EE;&#x9898;&#x53D8;&#x5F97;&#x66F4;&#x52A0;&#x5BB9;&#x6613;&#x6392;&#x67E5;&#x3002;</p>\n<a id=\"more\"></a>\n<p>JVM&#x7684;&#x52A8;&#x6001;Attach&#x56FA;&#x7136;&#x597D;&#xFF0C;&#x76F8;&#x4FE1;&#x5927;&#x5BB6;&#x6216;&#x591A;&#x6216;&#x5C11;&#x5DF2;&#x7ECF;&#x77E5;&#x9053;&#x5982;&#x4F55;&#x53BB;&#x4F7F;&#x7528;&#x8BE5;&#x6280;&#x672F;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x6B21;&#x6211;&#x4EEC;&#x7814;&#x7A76;&#x7684;&#x91CD;&#x70B9;&#x662F;JVM&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x52A8;&#x6001;Attach&#xFF0C;&#x81F3;&#x4E8E;JVM&#x5982;&#x4F55;&#x52A0;&#x8F7D;&#x52A8;&#x6001;Jar&#x5305;&#x3001;&#x5206;&#x53D1;&#x65B9;&#x6CD5;&#x5E76;&#x4F20;&#x9012;jvm&#x4E0A;&#x4E0B;&#x6587;&#x5C31;&#x4E0D;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x7814;&#x7A76;&#x8303;&#x56F4;&#x4E4B;&#x5185;&#x3002;</p>\n<p>&#x4E3A;&#x4E86;&#x66F4;&#x597D;&#x7684;&#x7814;&#x7A76;JVM&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x7531;&#x6D45;&#x5165;&#x6DF1;&#xFF0C;&#x5206;&#x4E3A;&#x51E0;&#x4E2A;&#x9636;&#x6BB5;&#x8FDB;&#x884C;&#x7814;&#x7A76;&#xFF1A;</p>\n<ul>\n<li>&#x52A8;&#x6001;Attach&#x662F;&#x4EC0;&#x4E48;&#xFF1F;</li>\n<li>&#x6709;&#x51E0;&#x79CD;&#x65B9;&#x6848;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x52A8;&#x6001;Attach</li>\n<li>&#x4E3E;&#x4E00;&#x4E2A;&#x6817;&#x5B50;</li>\n<li>&#x770B;&#x770B;JVM&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;</li>\n</ul>\n<h2 id=\"&#x4E00;&#x3001;&#x52A8;&#x6001;Attach&#x662F;&#x4EC0;&#x4E48;\"><a href=\"#&#x4E00;&#x3001;&#x52A8;&#x6001;Attach&#x662F;&#x4EC0;&#x4E48;\" class=\"headerlink\" title=\"&#x4E00;&#x3001;&#x52A8;&#x6001;Attach&#x662F;&#x4EC0;&#x4E48;\"></a>&#x4E00;&#x3001;&#x52A8;&#x6001;Attach&#x662F;&#x4EC0;&#x4E48;</h2><p>&#x867D;&#x7136;&#x6211;&#x4EEC;&#x8FD9;&#x6B21;&#x7814;&#x7A76;&#x7684;&#x662F;&#x5177;&#x4F53;&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x4F46;&#x5728;&#x8FD9;&#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x50CF;&#x5206;&#x6790;&#x9700;&#x6C42;&#x4E00;&#x6837;&#x5206;&#x6790;&#x4E0B;&#x52A8;&#x6001;Attach&#x5230;&#x5E95;&#x662F;&#x4EC0;&#x4E48;&#x3002;</p>\n<p>&#x6211;&#x4EEC;&#x90FD;&#x77E5;&#x9053;javaagent&#x53C2;&#x6570;&#x662F;&#x4F34;&#x968F;&#x7740;java&#x547D;&#x4EE4;&#xFF0C;&#x5728;JVM&#x542F;&#x52A8;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x52A0;&#x8F7D;javaagent&#x53C2;&#x6570;&#x6307;&#x5B9A;&#x7684;Jar&#x5305;&#x8DEF;&#x5F84;&#xFF0C;&#x5E76;&#x6267;&#x884C;&#x7EA6;&#x5B9A;&#x7C7B;&#x7684;premain&#x65B9;&#x6CD5;&#x3002;&#x5728;premain&#x65B9;&#x6CD5;&#x4E2D;&#x53EF;&#x4EE5;&#x83B7;&#x53D6;Instrumentation&#x7C7B;&#x578B;&#x53C2;&#x6570;&#xFF0C;&#x4ECE;&#x800C;&#x5BF9;&#x6211;&#x4EEC;&#x7684;&#x7C7B;&#x8FDB;&#x884C;&#x52A8;&#x6001;&#x589E;&#x5F3A;&#x589E;&#x5F3A;&#x3002;</p>\n<p>&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x8FD9;&#x6837;&#x4F7F;&#x7528;javaagent&#xFF1A;</p>\n<ol>\n<li><p>&#x5148;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x6302;&#x5728;&#x7684;&#x7C7B;&#xFF0C;&#x5176;&#x4E2D;&#x9700;&#x8981;&#x5B9E;&#x73B0;premain()&#x65B9;&#x6CD5;&#xFF0C;&#x5E76;&#x5C06;&#x5B83;&#x6253;&#x5305;&#x4E3A;&#x53EF;&#x6267;&#x884C;Jar&#x5305;</p>\n<figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Javaagent</span> </span>{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">premain</span><span class=\"hljs-params\">(String agentArgs, Instrumentation inst)</span> </span>{</span><br><span class=\"line\">        System.out.println(<span class=\"hljs-string\">&quot;agentArgs : &quot;</span> + agentArgs);</span><br><span class=\"line\">        inst.addTransformer(<span class=\"hljs-keyword\">new</span> TestTransformer(), <span class=\"hljs-keyword\">true</span>);</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">static</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">TestTransformer</span> <span class=\"hljs-keyword\">implements</span> <span class=\"hljs-title\">ClassFileTransformer</span> </span>{</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-meta\">@Override</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class=\"hljs-keyword\">byte</span>[] classfileBuffer) <span class=\"hljs-keyword\">throws</span> IllegalClassFormatException {</span><br><span class=\"line\">            System.out.println(<span class=\"hljs-string\">&quot;premain load Class:&quot;</span> + className);</span><br><span class=\"line\">            <span class=\"hljs-keyword\">return</span> classfileBuffer;</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>&#x914D;&#x7F6E;MANIFEST.MF&#x914D;&#x7F6E;&#x6587;&#x4EF6;</p>\n<figure class=\"highlight xml hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Premain-Class: Javaagent</span><br><span class=\"line\">Agent-Class: Javaagent</span><br><span class=\"line\">Can-Redefine-Classes: true</span><br><span class=\"line\">Can-Retransform-Classes: true</span><br></pre></td></tr></tbody></table></figure>\n</li>\n<li><p>&#x542F;&#x52A8;&#x6211;&#x4EEC;&#x7684;&#x670D;&#x52A1;</p>\n<figure class=\"highlight shell hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -javaagent:Javaagent.jar &#x81EA;&#x5DF1;&#x7684;&#x670D;&#x52A1;.jar</span><br></pre></td></tr></tbody></table></figure>\n\n</li>\n</ol>\n<p>&#x4EE5;&#x4E0A;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x7B80;&#x5355;&#x7684;javaagent&#x8FD0;&#x7528;&#x573A;&#x666F;&#x3002;javaagent&#x53EF;&#x4EE5;&#x5728;&#x4E0D;&#x4FB5;&#x5165;&#x4E1A;&#x52A1;&#x4EE3;&#x7801;&#x7684;&#x524D;&#x63D0;&#x4E0B;&#x4FEE;&#x6539;&#x6211;&#x4EEC;&#x5DF2;&#x52A0;&#x8F7D;&#x7684;&#x7C7B;&#xFF0C;&#x4F46;&#x552F;&#x4E00;&#x7684;&#x95EE;&#x9898;&#x662F;&#x9700;&#x8981;&#x4F34;&#x968F;&#x7740;&#x4E1A;&#x52A1;&#x670D;&#x52A1;&#x4E00;&#x540C;&#x542F;&#x52A8;&#x3002;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;&#x6211;&#x4EEC;&#x65E0;&#x6CD5;&#x4FB5;&#x5165;&#x5DF2;&#x7ECF;&#x8FD0;&#x884C;&#x5728;JVM&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x56E0;&#x6B64;JDK&#x5F00;&#x53D1;&#x7684;&#x5927;&#x795E;&#x4EEC;&#x4E3A;&#x6211;&#x4EEC;&#x5E26;&#x6765;&#x4E86;&#x52A8;&#x6001;Attach API&#x3002;&#x5176;&#x529F;&#x80FD;&#x4E0E;javaagent&#x662F;&#x4E00;&#x6837;&#x7684;&#xFF0C;&#x4F46;&#x6700;&#x5927;&#x7684;&#x597D;&#x5904;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x80FD;&#x591F;&#x5728;&#x4E00;&#x4E2A;&#x5DF2;&#x7ECF;&#x8FD0;&#x884C;&#x7684;JVM&#x4E0A;&#x52A8;&#x6001;&#x7684;&#x6302;&#x8F7D;&#x4E00;&#x4E2A;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x5F00;&#x53D1;&#x7684;Jar&#x5305;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x4EFB;&#x4F55;&#x65F6;&#x95F4;&#x70B9;&#x6211;&#x4EEC;&#x90FD;&#x80FD;&#x624B;&#x52A8;&#x7684;&#x589E;&#x5F3A;&#x4E1A;&#x52A1;&#x4EE3;&#x7801;&#x3002;&#x6BD4;&#x5982;&#x901A;&#x8FC7;attach Arthas&#xFF0C;&#x6211;&#x4EEC;&#x80FD;&#x589E;&#x5F3A;&#x6307;&#x5B9A;&#x65B9;&#x6CD5;&#x7684;&#x5165;&#x53E3;&amp;&#x51FA;&#x53E3;&#xFF0C;&#x4ECE;&#x800C;&#x83B7;&#x53D6;&#x51FA;&#x5165;&#x53C2;&#x7684;&#x76F8;&#x5173;&#x4FE1;&#x606F;&#x3002;&#x8FD9;&#x5728;&#x7F3A;&#x5C11;&#x65E5;&#x5FD7;&#x8F93;&#x51FA;&#x7684;&#x573A;&#x666F;&#x4E0B;&#x662F;&#x975E;&#x5E38;&#x6709;&#x6548;&#x7684;&#x95EE;&#x9898;&#x5B9A;&#x4F4D;&#x624B;&#x6BB5;&#x3002;&#x6B64;&#x5916;&#x6211;&#x4EEC;&#x4E5F;&#x80FD;&#x4E3A;&#x65B9;&#x6CD5;&#x7684;&#x8C03;&#x7528;&#x94FE;&#x505A;&#x57CB;&#x70B9;&#xFF0C;&#x5E2E;&#x52A9;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x4E1A;&#x52A1;&#x6D41;&#x7A0B;&#x4E2D;&#x7684;&#x6162;&#x65B9;&#x6CD5;&#x7B49;&#x7B49;&#x3002;</p>\n<p>&#x603B;&#x7ED3;&#x4E0B;&#xFF0C;&#x52A8;&#x6001;Attach&#x5C31;&#x662F;JVM&#x8FD0;&#x884C;&#x671F;&#x4E2D;&#x63D0;&#x4F9B;&#x7684;&#x6307;&#x5B9A;&#x7C7B;&#x578B;&#x7684;&#x7C7B;&#x52A0;&#x8F7D;&#x673A;&#x5236;&#x3002;&#x901A;&#x8FC7;&#x589E;&#x5F3A;&#x7C7B;&#x7684;&#x52A0;&#x8F7D;&#xFF0C;&#x5B9E;&#x73B0;&#x5404;&#x5F0F;&#x5404;&#x6837;&#x6709;&#x8DA3;&#x7684;&#x529F;&#x80FD;&#x3002;</p>\n<h2 id=\"&#x4E8C;&#x3001;&#x6709;&#x51E0;&#x79CD;&#x65B9;&#x6848;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x52A8;&#x6001;Attach\"><a href=\"#&#x4E8C;&#x3001;&#x6709;&#x51E0;&#x79CD;&#x65B9;&#x6848;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x52A8;&#x6001;Attach\" class=\"headerlink\" title=\"&#x4E8C;&#x3001;&#x6709;&#x51E0;&#x79CD;&#x65B9;&#x6848;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x52A8;&#x6001;Attach\"></a>&#x4E8C;&#x3001;&#x6709;&#x51E0;&#x79CD;&#x65B9;&#x6848;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x52A8;&#x6001;Attach</h2><p>&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x77E5;&#x9053;&#x4EC0;&#x4E48;&#x662F;&#x52A8;&#x6001;Attach&#x4E86;&#xFF0C;&#x5018;&#x82E5;&#x6211;&#x4EEC;&#x662F;JDK&#x7684;&#x5DE5;&#x7A0B;&#x5E08;&#xFF0C;&#x5F53;&#x4EA7;&#x54C1;&#x4EA4;&#x7ED9;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5B9E;&#x73B0;&#x52A8;&#x6001;Attach&#x8FD9;&#x4E2A;&#x9700;&#x6C42;&#x65F6;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x600E;&#x4E48;&#x5B9E;&#x73B0;&#x5462;&#xFF1F;</p>\n<h4 id=\"1-&#x76F4;&#x63A5;&#x7C7B;&#x52A0;&#x8F7D;&#x6CD5;\"><a href=\"#1-&#x76F4;&#x63A5;&#x7C7B;&#x52A0;&#x8F7D;&#x6CD5;\" class=\"headerlink\" title=\"1.&#x76F4;&#x63A5;&#x7C7B;&#x52A0;&#x8F7D;&#x6CD5;\"></a>1.&#x76F4;&#x63A5;&#x7C7B;&#x52A0;&#x8F7D;&#x6CD5;</h4><p>JDK&#x5DF2;&#x7ECF;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x5957;&#x5B8C;&#x5584;&#x7684;&#x7C7B;&#x52A0;&#x8F7D;&#x673A;&#x5236;&#xFF0C;&#x5982;&#x679C;&#x63D0;&#x4F9B;&#x83B7;&#x53D6;Instrumentation&#x5BF9;&#x8C61;&#x7684;JNI&#xFF0C;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x5C31;&#x53EF;&#x4EE5;&#x81EA;&#x884C;&#x901A;&#x8FC7;&#x52A8;&#x6001;&#x7C7B;&#x52A0;&#x8F7D;&#x540E;&#x8FDB;&#x884C;&#x5B57;&#x8282;&#x7801;&#x52A8;&#x6001;&#x589E;&#x5F3A;&#x3002;&#x8FD9;&#x4E2A;&#x65B9;&#x6848;&#x770B;&#x4F3C;&#x5F88;&#x7F8E;&#x597D;&#xFF0C;&#x73B0;&#x6709;Java&#x751F;&#x6001;&#x5708;&#x5DF2;&#x7ECF;&#x62E5;&#x6709;&#x4E30;&#x5BCC;&#x7684;Class&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x65B9;&#x6848;&#xFF0C;&#x5229;&#x7528;&#x8FD9;&#x4E9B;&#x73B0;&#x6709;&#x65B9;&#x6848;&#xFF0C;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x80FD;&#x591F;&#x5F88;&#x5FEB;&#x7684;&#x642D;&#x5EFA;&#x51FA;&#x81EA;&#x5DF1;&#x7684;&#x5B57;&#x8282;&#x7801;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x673A;&#x5236;&#xFF0C;&#x800C;&#x65E0;&#x9700;JVM&#x63D0;&#x4F9B;&#x5927;&#x91CF;&#x7684;native&#x652F;&#x6301;&#x3002;&#x4F46;&#x662F;&#x8FD9;&#x4E2A;&#x65B9;&#x6848;&#x5B58;&#x5728;&#x91CD;&#x5927;&#x7684;&#x5B89;&#x5168;&#x95EE;&#x9898;&#xFF0C;&#x4E00;&#x65E6;&#x670D;&#x52A1;&#x7684;&#x52A8;&#x6001;&#x52A0;&#x8F7D;&#x673A;&#x5236;&#x88AB;&#x9ED1;&#x5BA2;&#x7834;&#x89E3;&#xFF0C;&#x90A3;&#x4E48;&#x4ED6;&#x5B8C;&#x5168;&#x80FD;&#x591F;&#x52A0;&#x8F7D;&#x4E00;&#x4E2A;&#x81EA;&#x5DF1;&#x7F16;&#x5199;&#x597D;&#x7684;&#x4FB5;&#x5165;&#x7C7B;&#xFF0C;&#x901A;&#x8FC7;&#x5165;&#x4FB5;&#x7C7B;&#x4EFB;&#x610F;&#x4FEE;&#x6539;&#x4E1A;&#x52A1;&#x4EE3;&#x7801;&#x6700;&#x7EC8;&#x5BFC;&#x81F4;&#x65E0;&#x6CD5;&#x633D;&#x56DE;&#x7684;&#x635F;&#x5931;&#x3002;&#x6240;&#x4EE5;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;JDK&#x5F00;&#x53D1;&#x5DE5;&#x7A0B;&#x5E08;&#xFF0C;&#x4E00;&#x5B9A;&#x8981;&#x5728;&#x521D;&#x671F;&#x5C31;&#x5C4F;&#x853D;&#x8FD9;&#x79CD;&#x5B89;&#x5168;&#x95EE;&#x9898;&#x3002;&#x540C;&#x65F6;Java&#x6700;&#x4E3A;&#x4E00;&#x79CD;&#x5B89;&#x5168;&#x8BED;&#x8A00;&#xFF0C;&#x4E0D;&#x5B89;&#x5168;&#x7684;&#x64CD;&#x4F5C;&#x9700;&#x8981;&#x5C3D;&#x91CF;&#x907F;&#x514D;&#x5F15;&#x5165;Java&#x751F;&#x6001;&#x4E2D;&#x3002;</p>\n<h4 id=\"2-Socket&#x901A;&#x4FE1;&#x6CD5;\"><a href=\"#2-Socket&#x901A;&#x4FE1;&#x6CD5;\" class=\"headerlink\" title=\"2.Socket&#x901A;&#x4FE1;&#x6CD5;\"></a>2.Socket&#x901A;&#x4FE1;&#x6CD5;</h4><p>&#x65E2;&#x7136;&#x63D0;&#x4F9B;JNI&#x4E0D;&#x5B89;&#x5168;&#xFF0C;&#x90A3;&#x4E48;&#x6211;&#x4EEC;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x8003;&#x8651;&#x8BA9;JVM&#x81EA;&#x5DF1;&#x5904;&#x7406;&#x3002;&#x5047;&#x8BBE;&#x6211;&#x4EEC;&#x80FD;&#x548C;JVM&#x5EFA;&#x7ACB;&#x8D77;Socket&#x901A;&#x8BAF;&#x3002;&#x5E76;&#x5C06;&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x52A0;&#x8F7D;&#x7684;&#x7C7B;&#x544A;&#x77E5;JVM&#xFF0C;JVM&#x5728;&#x52A0;&#x8F7D;&#x5B8C;&#x6210;&#x540E;&#x6309;&#x7167;&#x7EA6;&#x5B9A;&#x6267;&#x884C;&#x6307;&#x5B9A;&#x7684;&#x5165;&#x53E3;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x6837;&#x4E5F;&#x80FD;&#x5B9E;&#x73B0;&#x6211;&#x4EEC;&#x5BF9;&#x52A8;&#x6001;Attach&#x7684;&#x5B9E;&#x73B0;&#x3002;</p>\n<p>Socket&#x901A;&#x4FE1;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;&#x8FDC;&#x7A0B;&#x901A;&#x4FE1;&#x548C;&#x672C;&#x5730;&#x901A;&#x4FE1;&#x3002;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x8003;&#x8651;&#xFF0C;&#x5982;&#x679C;&#x91C7;&#x7528;&#x8FDC;&#x7A0B;&#x901A;&#x4FE1;&#xFF0C;&#x7684;&#x786E;&#x80FD;&#x7ED9;&#x6211;&#x4EEC;&#x5E26;&#x6765;&#x66F4;&#x5F3A;&#x5927;&#x7684;Attach&#x7075;&#x6D3B;&#x6027;&#xFF0C;&#x4F46;&#x9700;&#x8981;JVM&#x66B4;&#x9732;&#x7AEF;&#x53E3;&#xFF0C;&#x540C;&#x6837;&#x5177;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x5B89;&#x5168;&#x95EE;&#x9898;&#x3002;<br>&#x672C;&#x5730;&#x901A;&#x8BAF;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x91C7;&#x7528;UNIX Domain Socket&#xFF0C;&#x901A;&#x8FC7;&#x6587;&#x4EF6;&#x5F62;&#x5F0F;&#x901A;&#x8BAF;&#x3002;&#x4E0D;&#x4F46;&#x5177;&#x6709;&#x8F83;&#x9AD8;&#x7684;&#x901A;&#x4FE1;&#x901F;&#x5EA6;&#xFF0C;&#x540C;&#x65F6;&#x5177;&#x6709;&#x4E00;&#x5B9A;&#x7684;&#x5B89;&#x5168;&#x6027;&#x3002;</p>\n<p>&#x5982;&#x679C;&#x91C7;&#x7528;Socket Local&#x901A;&#x4FE1;&#xFF0C;&#x90A3;&#x6211;&#x4EEC;&#x53C8;&#x5982;&#x4F55;&#x4E0E;JVM&#x5EFA;&#x7ACB;&#x8D77;&#x901A;&#x4FE1;&#x5462;&#xFF1F;</p>\n<h4 id=\"3-&#x4FE1;&#x53F7;&#x76D1;&#x542C;&#x6CD5;\"><a href=\"#3-&#x4FE1;&#x53F7;&#x76D1;&#x542C;&#x6CD5;\" class=\"headerlink\" title=\"3.&#x4FE1;&#x53F7;&#x76D1;&#x542C;&#x6CD5;\"></a>3.&#x4FE1;&#x53F7;&#x76D1;&#x542C;&#x6CD5;</h4><p>&#x5176;&#x5B9E;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;Socket&#x901A;&#x4FE1;&#x6CD5;&#x7684;&#x8865;&#x5145;&#x3002;&#x5728;&#x4E0E;JVM&#x5EFA;&#x7ACB;&#x8D77;&#x672C;&#x5730;&#x901A;&#x4FE1;&#x524D;&#xFF0C;JVM&#x9700;&#x8981;&#x77E5;&#x9053;&#x7528;&#x6237;&#x60F3;&#x8981;&#x5F00;&#x59CB;&#x52A8;&#x6001;Attach&#x3002;&#x800C;&#x4FE1;&#x53F7;&#x76D1;&#x542C;&#x5C31;&#x80FD;&#x8865;&#x5145;&#x8FD9;&#x65B9;&#x9762;&#x7684;&#x529F;&#x80FD;&#x3002;&#x5BA2;&#x6237;&#x7AEF;&#x4EE5;&#x7EA6;&#x5B9A;&#x7684;&#x5F62;&#x5F0F;&#x5411;JVM&#x8FDB;&#x7A0B;&#x53D1;&#x8D77;&#x6307;&#x5B9A;&#x4FE1;&#x53F7;&#xFF0C;&#x540C;&#x65F6;JVM&#x5728;&#x76D1;&#x542C;&#x5230;Attach&#x4FE1;&#x53F7;&#x540E;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x5EFA;&#x7ACB;Socket&#x94FE;&#x63A5;&#x3002;&#x5BA2;&#x6237;&#x7AEF;&#x4EE5;Socket&#x65B9;&#x5F0F;&#x5C06;&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x7684;&#x7C7B;&#x544A;&#x77E5;JVM&#x5E76;&#x8FDB;&#x884C;&#x52A0;&#x8F7D;&#x5E76;&#x6700;&#x7EC8;&#x8FD0;&#x884C;&#x6211;&#x4EEC;&#x540E;&#x9762;&#x719F;&#x6089;&#x7684;javaagent&#x6D41;&#x7A0B;&#x3002;</p>\n<p>&#x6211;&#x867D;&#x7136;&#x4E0D;&#x662F;JDK&#x7684;&#x5DE5;&#x7A0B;&#x5E08;&#xFF0C;&#x4E0A;&#x9762;&#x7684;3&#x4E2A;&#x65B9;&#x6848;&#x4E5F;&#x662F;&#x7ED3;&#x5408;&#x4E86;JDK1.8&#x7684;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x540E;&#x5927;&#x80C6;&#x7684;&#x63E3;&#x6D4B;&#x4E86;&#x5F53;&#x65F6;&#x5F00;&#x53D1;&#x5DE5;&#x7A0B;&#x5E08;&#x7684;&#x60F3;&#x6CD5;&#x3002;&#x53EF;&#x80FD;&#x5F53;&#x65F6;&#x6446;&#x5728;&#x4ED6;&#x9762;&#x524D;&#x7684;&#x65B9;&#x6848;&#x66F4;&#x662F;&#x6210;&#x5343;&#x4E0A;&#x4E07;&#xFF0C;&#x4F46;&#x662F;&#x6700;&#x7EC8;&#x786E;&#x5B9A;&#x4E0B;&#x8FD9;&#x4E2A;&#x6280;&#x672F;&#x65B9;&#x6848;&#x7684;&#x5FC3;&#x8DEF;&#x5386;&#x7A0B;&#x6211;&#x89C9;&#x5F97;&#x662F;&#x6211;&#x4EEC;&#x6BCF;&#x4E2A;&#x5F00;&#x53D1;&#x90FD;&#x9700;&#x8981;&#x611F;&#x540C;&#x8EAB;&#x53D7;&#x7684;&#x3002;</p>\n<h2 id=\"&#x4E09;&#x3001;&#x4E3E;&#x4E00;&#x4E2A;&#x6817;&#x5B50;\"><a href=\"#&#x4E09;&#x3001;&#x4E3E;&#x4E00;&#x4E2A;&#x6817;&#x5B50;\" class=\"headerlink\" title=\"&#x4E09;&#x3001;&#x4E3E;&#x4E00;&#x4E2A;&#x6817;&#x5B50;\"></a>&#x4E09;&#x3001;&#x4E3E;&#x4E00;&#x4E2A;&#x6817;&#x5B50;</h2><p>&#x524D;&#x9762;&#x6211;&#x4EEC;&#x5206;&#x6790;&#x4E86;&#x5B9E;&#x73B0;&#x65B9;&#x6848;&#xFF0C;&#x6211;&#x4EEC;&#x5148;&#x4E22;&#x4E00;&#x4EFD;&#x4EE3;&#x7801;&#x6765;&#x9A8C;&#x8BC1;&#x4E0A;&#x9762;&#x7684;&#x65B9;&#x6848;&#xFF08;&#x4EE3;&#x7801;&#x4E3A;JDK1.8&#x6E90;&#x7801;&#x76F8;&#x5173;&#x529F;&#x80FD;&#x7684;&#x7B80;&#x5316;&#x7248;&#xFF09;</p>\n<h3 id=\"&#x5F00;&#x59CB;&#x5B9E;&#x9A8C;\"><a href=\"#&#x5F00;&#x59CB;&#x5B9E;&#x9A8C;\" class=\"headerlink\" title=\"&#x5F00;&#x59CB;&#x5B9E;&#x9A8C;\"></a>&#x5F00;&#x59CB;&#x5B9E;&#x9A8C;</h3><p><font color=\"blue\">&#x9700;&#x6C42;&#xFF1A;</font>&#x5B9E;&#x73B0;&#x52A8;&#x6001;Attach API&#xFF0C;&#x63A5;&#x6536;java -jar xxx.jar pid&#x53D1;&#x8D77;&#x7684;&#x6302;&#x8F7D;&#x8BF7;&#x6C42;&#xFF0C;&#x5E76;&#x5C06;loadAgent&#x6307;&#x5B9A;&#x7684;Jar&#x5305;&#x5B8C;&#x6574;&#x8DEF;&#x5F84;&#x663E;&#x793A;&#x5728;&#x63A7;&#x5236;&#x53F0;&#x3002;</p>\n<p><font color=\"blue\">&#x5B9E;&#x9A8C;&#x73AF;&#x5883;&#xFF1A;</font>MacOS 10.15.6</p>\n<p><font color=\"blue\">&#x9879;&#x76EE;&#x5730;&#x5740;&#xFF1A;</font></p>\n<blockquote>\n<p><a href=\"https://github.com/xzenge/JVM_ATTACH/tree/dev\">https://github.com/xzenge/JVM_ATTACH/tree/dev</a></p>\n</blockquote>\n<h5 id=\"&#x6211;&#x4EEC;&#x5148;&#x542F;&#x52A8;&#x9879;&#x76EE;&#x3002;&#x8BE5;&#x9879;&#x76EE;&#x6A21;&#x62DF;&#x4E86;JVM&#x8FD0;&#x884C;&#x73AF;&#x5883;&#xFF0C;&#x4F46;&#x53EA;&#x5B9E;&#x73B0;&#x4E86;Attach-API&#x7684;&#x90E8;&#x5206;&#x529F;&#x80FD;&#x3002;&#x9879;&#x76EE;&#x542F;&#x52A8;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5F53;&#x524D;&#x7684;JVM&#x8FDB;&#x7A0B;ID&#x4E3A;&#xFF1A;32910\"><a href=\"#&#x6211;&#x4EEC;&#x5148;&#x542F;&#x52A8;&#x9879;&#x76EE;&#x3002;&#x8BE5;&#x9879;&#x76EE;&#x6A21;&#x62DF;&#x4E86;JVM&#x8FD0;&#x884C;&#x73AF;&#x5883;&#xFF0C;&#x4F46;&#x53EA;&#x5B9E;&#x73B0;&#x4E86;Attach-API&#x7684;&#x90E8;&#x5206;&#x529F;&#x80FD;&#x3002;&#x9879;&#x76EE;&#x542F;&#x52A8;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5F53;&#x524D;&#x7684;JVM&#x8FDB;&#x7A0B;ID&#x4E3A;&#xFF1A;32910\" class=\"headerlink\" title=\"&#x6211;&#x4EEC;&#x5148;&#x542F;&#x52A8;&#x9879;&#x76EE;&#x3002;&#x8BE5;&#x9879;&#x76EE;&#x6A21;&#x62DF;&#x4E86;JVM&#x8FD0;&#x884C;&#x73AF;&#x5883;&#xFF0C;&#x4F46;&#x53EA;&#x5B9E;&#x73B0;&#x4E86;Attach API&#x7684;&#x90E8;&#x5206;&#x529F;&#x80FD;&#x3002;&#x9879;&#x76EE;&#x542F;&#x52A8;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5F53;&#x524D;&#x7684;JVM&#x8FDB;&#x7A0B;ID&#x4E3A;&#xFF1A;32910\"></a>&#x6211;&#x4EEC;&#x5148;&#x542F;&#x52A8;&#x9879;&#x76EE;&#x3002;&#x8BE5;&#x9879;&#x76EE;&#x6A21;&#x62DF;&#x4E86;JVM&#x8FD0;&#x884C;&#x73AF;&#x5883;&#xFF0C;&#x4F46;&#x53EA;&#x5B9E;&#x73B0;&#x4E86;Attach API&#x7684;&#x90E8;&#x5206;&#x529F;&#x80FD;&#x3002;&#x9879;&#x76EE;&#x542F;&#x52A8;&#x6210;&#x529F;&#x540E;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5F53;&#x524D;&#x7684;JVM&#x8FDB;&#x7A0B;ID&#x4E3A;&#xFF1A;<font color=\"red\">32910</font></h5><p><img src=\"/2020/09/21/%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90JVM-%E5%8A%A8%E6%80%81Attach%E5%8E%9F%E7%90%86/JVM_start.png\" alt=\"01\"></p>\n<hr>\n<h5 id=\"&#x6309;&#x7167;JDK&#x89C4;&#x8303;&#x7F16;&#x5199;JAVA&#x6D4B;Attach&#x65B9;&#x6CD5;&#x3002;&#x4E3A;&#x4E86;&#x7B80;&#x4FBF;&#xFF0C;&#x65B9;&#x6CD5;&#x4E2D;&#x6211;&#x4EEC;&#x624B;&#x52A8;&#x6307;&#x5B9A;&#x4E86;attach&#x7684;&#x7EBF;&#x7A0B;&#x53F7;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x4E86;JVM&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x7684;Jar&#x5305;&#x8DEF;&#x5F84;&#x3002;\"><a href=\"#&#x6309;&#x7167;JDK&#x89C4;&#x8303;&#x7F16;&#x5199;JAVA&#x6D4B;Attach&#x65B9;&#x6CD5;&#x3002;&#x4E3A;&#x4E86;&#x7B80;&#x4FBF;&#xFF0C;&#x65B9;&#x6CD5;&#x4E2D;&#x6211;&#x4EEC;&#x624B;&#x52A8;&#x6307;&#x5B9A;&#x4E86;attach&#x7684;&#x7EBF;&#x7A0B;&#x53F7;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x4E86;JVM&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x7684;Jar&#x5305;&#x8DEF;&#x5F84;&#x3002;\" class=\"headerlink\" title=\"&#x6309;&#x7167;JDK&#x89C4;&#x8303;&#x7F16;&#x5199;JAVA&#x6D4B;Attach&#x65B9;&#x6CD5;&#x3002;&#x4E3A;&#x4E86;&#x7B80;&#x4FBF;&#xFF0C;&#x65B9;&#x6CD5;&#x4E2D;&#x6211;&#x4EEC;&#x624B;&#x52A8;&#x6307;&#x5B9A;&#x4E86;attach&#x7684;&#x7EBF;&#x7A0B;&#x53F7;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x4E86;JVM&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x7684;Jar&#x5305;&#x8DEF;&#x5F84;&#x3002;\"></a>&#x6309;&#x7167;JDK&#x89C4;&#x8303;&#x7F16;&#x5199;JAVA&#x6D4B;Attach&#x65B9;&#x6CD5;&#x3002;&#x4E3A;&#x4E86;&#x7B80;&#x4FBF;&#xFF0C;&#x65B9;&#x6CD5;&#x4E2D;&#x6211;&#x4EEC;&#x624B;&#x52A8;&#x6307;&#x5B9A;&#x4E86;attach&#x7684;&#x7EBF;&#x7A0B;&#x53F7;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x4E86;JVM&#x9700;&#x8981;&#x52A0;&#x8F7D;&#x7684;Jar&#x5305;&#x8DEF;&#x5F84;&#x3002;</h5><figure class=\"highlight java hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-class\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title\">Attach</span> </span>{</span><br><span class=\"line\">    <span class=\"hljs-function\"><span class=\"hljs-keyword\">public</span> <span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">main</span><span class=\"hljs-params\">(String[] args)</span> <span class=\"hljs-keyword\">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException </span>{</span><br><span class=\"line\">        VirtualMachine attach = VirtualMachine.attach(<span class=\"hljs-string\">&quot;32910&quot;</span>);</span><br><span class=\"line\">        attach.loadAgentPath(<span class=\"hljs-string\">&quot;/Users/xiangshi/.gradle/caches/modules-2/files-2.1/cglib/cglib/3.1/1f1cb6c7a7479e0c7fd7987109e503914bebe84a/cglib-3.1.jar&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br><span class=\"line\"></span><br></pre></td></tr></tbody></table></figure>\n\n<hr>\n<h5 id=\"&#x8FD0;&#x884C;Java-attach&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x89C2;&#x5BDF;&#x5230;&#x6A21;&#x62DF;&#x7684;JVM&#x5DF2;&#x7ECF;&#x8BFB;&#x53D6;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x5E0C;&#x671B;classloader&#x7684;Jar&#x5305;\"><a href=\"#&#x8FD0;&#x884C;Java-attach&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x89C2;&#x5BDF;&#x5230;&#x6A21;&#x62DF;&#x7684;JVM&#x5DF2;&#x7ECF;&#x8BFB;&#x53D6;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x5E0C;&#x671B;classloader&#x7684;Jar&#x5305;\" class=\"headerlink\" title=\"&#x8FD0;&#x884C;Java attach&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x89C2;&#x5BDF;&#x5230;&#x6A21;&#x62DF;&#x7684;JVM&#x5DF2;&#x7ECF;&#x8BFB;&#x53D6;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x5E0C;&#x671B;classloader&#x7684;Jar&#x5305;\"></a>&#x8FD0;&#x884C;Java attach&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x89C2;&#x5BDF;&#x5230;&#x6A21;&#x62DF;&#x7684;JVM&#x5DF2;&#x7ECF;&#x8BFB;&#x53D6;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x5E0C;&#x671B;classloader&#x7684;Jar&#x5305;</h5><p><img src=\"/2020/09/21/%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90JVM-%E5%8A%A8%E6%80%81Attach%E5%8E%9F%E7%90%86/load_agent_library.png\" alt=\"02\"></p>\n<hr>\n<h3 id=\"&#x5B9E;&#x9A8C;&#x5206;&#x6790;\"><a href=\"#&#x5B9E;&#x9A8C;&#x5206;&#x6790;\" class=\"headerlink\" title=\"&#x5B9E;&#x9A8C;&#x5206;&#x6790;\"></a>&#x5B9E;&#x9A8C;&#x5206;&#x6790;</h3><p>&#x5B9E;&#x9A8C;&#x8FC7;&#x7A0B;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x6211;&#x4EEC;&#x4F2A;&#x9020;&#x4E86;&#x4E2A;JVM&#x8FD0;&#x884C;&#x65F6;&#x73AF;&#x5883;&#x3002;&#x5E76;&#x901A;&#x8FC7;JAVA&#x539F;&#x751F;&#x7684;Attach API&#x6210;&#x529F;&#x7684;&#x5B9E;&#x73B0;&#x4E86;&#x4E0E;JVM&#x4E4B;&#x95F4;&#x901A;&#x8BAF;&#x7684;&#x529F;&#x80FD;&#x3002;&#x4E0B;&#x9762;&#x6211;&#x4EEC;&#x5F00;&#x59CB;&#x9010;&#x6B65;&#x5206;&#x6790;&#x5177;&#x4F53;&#x7684;&#x5B9E;&#x73B0;&#x8FC7;&#x7A0B;&#xFF1A;</p>\n<ul>\n<li>&#x76D1;&#x542C;signal<br>&#x521D;&#x59CB;&#x5316;OS&#x4FE1;&#x53F7;&#x76D1;&#x542C;&#x7684;&#x76F8;&#x5173;&#x6570;&#x636E;</li>\n</ul>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">/**</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * JVM&#x542F;&#x52A8;&#x65F6;&#x76D1;&#x542C;signal</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> */</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">os::signal_init</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x521D;&#x59CB;&#x5316;signal&#x76D1;&#x542C;pending_signals</span></span><br><span class=\"line\">    os::signal_init_pd();</span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x521B;&#x5EFA;&#x7EBF;&#x7A0B;&#x76D1;&#x542C;pending_signals&#x72B6;&#x6001;&#x5E76;&#x8FDB;&#x884C;&#x76F8;&#x5E94;&#x5904;&#x7406;</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">pthread_t</span> tids;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">int</span> ret = pthread_create(&amp;tids, <span class=\"hljs-literal\">NULL</span>, <span class=\"hljs-keyword\">reinterpret_cast</span>&lt;<span class=\"hljs-keyword\">void</span> *(*)(<span class=\"hljs-keyword\">void</span> *)&gt;(signal_thread_entry), <span class=\"hljs-literal\">NULL</span>);</span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x6CE8;&#x518C;signal&#x5904;&#x7406;&#x5668;</span></span><br><span class=\"line\">    os::signal(SIGBREAK,os::user_handler());</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>sigaction&#x65B9;&#x6CD5;&#x63D0;&#x4F9B;os&#x4FE1;&#x53F7;&#x7684;&#x76D1;&#x542C;&#x5E76;&#x6CE8;&#x518C;&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x6211;&#x4EEC;&#x76D1;&#x542C;-3 SIGQUIT&#x4FE1;&#x53F7;&#x3002;</p>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">/**</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * &#x6CE8;&#x518C;&#x76D1;&#x542C;&#x4FE1;&#x53F7;&amp;&#x5904;&#x7406;&#x5668;</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * @param signal_number &#x4FE1;&#x53F7;&#x7F16;&#x53F7;</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * @param handler &#x4FE1;&#x53F7;&#x5904;&#x7406;&#x5668;</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * @return</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> */</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> *<span class=\"hljs-title\">os::signal</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">int</span> signal_number, <span class=\"hljs-keyword\">void</span> *handler)</span> </span>{</span><br><span class=\"line\">    <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">sigaction</span> <span class=\"hljs-title\">sigAct</span>, <span class=\"hljs-title\">oldSigAct</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    sigfillset(&amp;(sigAct.sa_mask));</span><br><span class=\"line\">    sigAct.sa_flags   = SA_RESTART|SA_SIGINFO;</span><br><span class=\"line\">    sigAct.sa_handler = CAST_TO_FN_PTR(<span class=\"hljs-keyword\">sa_handler_t</span>, handler);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) {</span><br><span class=\"line\">        <span class=\"hljs-comment\">// -1 means registration failed</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> (<span class=\"hljs-keyword\">void</span> *)<span class=\"hljs-number\">-1</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> CAST_FROM_FN_PTR(<span class=\"hljs-keyword\">void</span>*, oldSigAct.sa_handler);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x5668;&#x4E2D;&#x7B80;&#x5355;&#x7684;&#x6A21;&#x62DF;&#x7684;&#x6536;&#x5230;&#x4FE1;&#x53F7;&#x7684;&#x5904;&#x7406;&#x8FC7;&#x7A0B;&#xFF0C;&#x6570;&#x7EC4;&#x5BF9;&#x5E94;&#x7684;&#x4FE1;&#x53F7;&#x4F4D;&#x7F6E;&#x4E3A;1&#x65F6;&#xFF0C;&#x8BF4;&#x660E;&#x6536;&#x5230;&#x4E86;&#x5BF9;&#x5E94;&#x7684;&#x4FE1;&#x53F7;&#x3002;</p>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">/**</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * &#x901A;&#x8FC7;pending_signals&#x4FDD;&#x7559;&#x76D1;&#x542C;&#x5230;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x4EA4;&#x7531;&#x4E13;&#x95E8;&#x7684;&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x8BE5;&#x4FE1;&#x606F;</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * @param signal_number</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> */</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">os::signal_notify</span><span class=\"hljs-params\">(<span class=\"hljs-keyword\">int</span> signal_number)</span> </span>{</span><br><span class=\"line\">    <span class=\"hljs-built_in\">cout</span> &lt;&lt; <span class=\"hljs-string\">&quot;enter signal_notify sig:&quot;</span> &lt;&lt; signal_number &lt;&lt; <span class=\"hljs-built_in\">endl</span>;</span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x5C06;&#x76D1;&#x542C;&#x5230;&#x7684;&#x4FE1;&#x53F7;&#x4E3A;&#x7AD6;&#x4E3A;1</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">//&#x6539;&#x64CD;&#x4F5C;&#x5E94;&#x8BE5;&#x4E3A;&#x539F;&#x5B50;&#x64CD;&#x4F5C;&#xFF0C;&#x786E;&#x4FDD;&#x4E0D;&#x4F1A;&#x88AB;&#x5176;&#x4ED6;&#x7EBF;&#x7A0B;&#x4FEE;&#x6539;</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">//JVM&#x4E2D;&#x6DF7;&#x7F16;&#x5E73;&#x53F0;&#x76F8;&#x5173;&#x6C47;&#x7F16;&#x6307;&#x4EE4;&#x5B9E;&#x73B0;&#x539F;&#x5B50;&#x64CD;&#x4F5C;&#xFF0C;&#x6F14;&#x793A;&#x4EE3;&#x7801;&#x4E2D;&#x4E0D;&#x7814;&#x7A76;&#x76F8;&#x5173;&#x5B9E;&#x73B0;</span></span><br><span class=\"line\">    pending_signals[signal_number] = <span class=\"hljs-number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    semaphore_signal(sig_sem);</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x5355;&#x72EC;&#x8D77;&#x4E00;&#x4E2A;&#x7EBF;&#x7A0B;&#xFF0C;&#x8BE5;&#x7EBF;&#x7A0B;&#x8F6E;&#x8BAD;&#x4FE1;&#x53F7;&#x63A5;&#x53D7;&#x6570;&#x7EC4;&#x7684;&#x72B6;&#x6001;&#xFF0C;&#x5C06;&#x7F6E;&#x4E3A;1&#x7684;&#x4FE1;&#x53F7;&#x7801;&#x4F20;&#x7ED9;&#x4E0B;&#x6E38;&#x5904;&#x7406;&#x3002;&#x5F53;&#x4FE1;&#x53F7;&#x4F4D;-3 SIGQUIT&#x4FE1;&#x53F7;&#x65F6;&#xFF0C;&#x5F00;&#x59CB;&#x521D;&#x59CB;&#x5316;attach&#x7684;&#x76D1;&#x542C;&#x65B9;&#x6CD5;&#x3002;</p>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">/**</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * &#x5355;&#x72EC;&#x7EBF;&#x7A0B;&#x5BF9;pending_signals&#x72B6;&#x6001;&#x5E76;&#x8FDB;&#x884C;&#x76F8;&#x5E94;&#x5904;&#x7406;</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> */</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">signal_thread_entry</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">    <span class=\"hljs-built_in\">cout</span> &lt;&lt; <span class=\"hljs-string\">&quot;enter signal_thread_entry&quot;</span> &lt;&lt; <span class=\"hljs-built_in\">endl</span>;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">while</span> (<span class=\"hljs-literal\">true</span>){</span><br><span class=\"line\">        <span class=\"hljs-keyword\">int</span> sig;</span><br><span class=\"line\">        {</span><br><span class=\"line\">            sig = os::signal_wait();</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"hljs-keyword\">switch</span> (sig) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">case</span> SIGBREAK: {</span><br><span class=\"line\">                <span class=\"hljs-keyword\">if</span> (AttachListener::init()) {</span><br><span class=\"line\">                    <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">                }</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\"></span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x521D;&#x59CB;&#x5316;attach&#x76D1;&#x542C;&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;Domain Socket&#x7684;&#x6587;&#x4EF6;&#x76D1;&#x542C;&#xFF0C;&#x5E76;accept&#x5728;&#x6539;&#x6587;&#x4EF6;&#x4E0A;&#x3002;</p>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">/**</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * &#x521D;&#x59CB;&#x5316;domain socket&#x76D1;&#x542C;</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * JVM&#x901A;&#x8FC7;&#x76D1;&#x542C;&#x6307;&#x5B9A;&#x7EBF;&#x7A0B;&#x6587;&#x4EF6;&#x6587;&#x4EF6;</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * &#x83B7;&#x53D6;client&#x60F3;JVM&#x53D1;&#x9001;&#x7684;&#x6307;&#x4EE4;&#x5E76;&#x8FDB;&#x884C;&#x76F8;&#x5173;&#x64CD;&#x4F5C;</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * @return</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> */</span></span><br><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">int</span> <span class=\"hljs-title\">AttachListener::pd_init</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">char</span> path[UNIX_PATH_MAX];          <span class=\"hljs-comment\">// socket file</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">char</span> initial_path[UNIX_PATH_MAX];  <span class=\"hljs-comment\">// socket file during setup</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">int</span> listener;                      <span class=\"hljs-comment\">// listener socket (file descriptor)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// register function to cleanup</span></span><br><span class=\"line\">    ::atexit(listener_cleanup);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">int</span> n = <span class=\"hljs-built_in\">snprintf</span>(path, UNIX_PATH_MAX, <span class=\"hljs-string\">&quot;%s/.java_pid%d&quot;</span>,</span><br><span class=\"line\">                     TEMP_PATH, getpid());</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (n &lt; (<span class=\"hljs-keyword\">int</span>) UNIX_PATH_MAX) {</span><br><span class=\"line\">        n = <span class=\"hljs-built_in\">snprintf</span>(initial_path, UNIX_PATH_MAX, <span class=\"hljs-string\">&quot;%s.tmp&quot;</span>, path);</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (n &gt;= (<span class=\"hljs-keyword\">int</span>) UNIX_PATH_MAX) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-built_in\">cout</span> &lt;&lt; <span class=\"hljs-string\">&quot;path:&quot;</span> &lt;&lt; path &lt;&lt; <span class=\"hljs-built_in\">endl</span>;</span><br><span class=\"line\">    <span class=\"hljs-comment\">// create the listener socket</span></span><br><span class=\"line\">    listener = ::socket(PF_UNIX, SOCK_STREAM, <span class=\"hljs-number\">0</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (listener == <span class=\"hljs-number\">-1</span>) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// bind socket</span></span><br><span class=\"line\">    <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">sockaddr_un</span> <span class=\"hljs-title\">addr</span>;</span></span><br><span class=\"line\">    addr.sun_family = AF_UNIX;</span><br><span class=\"line\">    <span class=\"hljs-built_in\">strcpy</span>(addr.sun_path, initial_path);</span><br><span class=\"line\">    ::unlink(initial_path);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">int</span> res = ::bind(listener, (struct sockaddr *) &amp;addr, <span class=\"hljs-keyword\">sizeof</span>(addr));</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (res == <span class=\"hljs-number\">-1</span>) {</span><br><span class=\"line\">        ::close(listener);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// put in listen mode, set permissions, and rename into place</span></span><br><span class=\"line\">    res = ::listen(listener, <span class=\"hljs-number\">5</span>);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (res == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">        RESTARTABLE(::chmod(initial_path, S_IREAD | S_IWRITE), res);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (res == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">if</span> (res == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">                res = ::rename(initial_path, path);</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (res == <span class=\"hljs-number\">-1</span>) {</span><br><span class=\"line\">        ::close(listener);</span><br><span class=\"line\">        ::unlink(initial_path);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">-1</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    set_path(path);</span><br><span class=\"line\">    set_listener(listener);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x4E00;&#x65E6;&#x6536;&#x5230;java&#x53D1;&#x9001;&#x8FC7;&#x6765;&#x7684;socket&#x8BF7;&#x6C42;&#xFF0C;&#x5219;&#x89E3;&#x6790;&#x8BE5;&#x8BF7;&#x6C42;&#x5E76;&#x5305;&#x88C5;&#x4E3A;AttachOperation&#x5BF9;&#x8C61;&#x3002;</p>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-comment\">/**</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * accept domain socket&#xFF0C;&#x8BFB;&#x53D6;&#x5230;&#x5185;&#x5BB9;&#x540E;&#x751F;&#x6210;&#x5BF9;&#x5E94;&#x7684;AttachOperation</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> * @return</span></span><br><span class=\"line\"><span class=\"hljs-comment\"> */</span></span><br><span class=\"line\"><span class=\"hljs-function\">AttachOperation *<span class=\"hljs-title\">AttachListener::dequeue</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">for</span> (;;) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">int</span> s;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">// wait for client to connect</span></span><br><span class=\"line\">        <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">sockaddr</span> <span class=\"hljs-title\">addr</span>;</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">socklen_t</span> len = <span class=\"hljs-keyword\">sizeof</span>(addr);</span><br><span class=\"line\">        RESTARTABLE(::accept(listener(), &amp;addr, &amp;len), s);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (s == <span class=\"hljs-number\">-1</span>) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">NULL</span>;      <span class=\"hljs-comment\">// log a warning?</span></span><br><span class=\"line\">        }</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">// get the credentials of the peer and check the effective uid/guid</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">// - check with jeff on this.</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">uid_t</span> puid;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">gid_t</span> pgid;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (::getpeereid(s, &amp;puid, &amp;pgid) != <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">            ::close(s);</span><br><span class=\"line\">            <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"hljs-keyword\">uid_t</span> euid = geteuid();</span><br><span class=\"line\">        <span class=\"hljs-keyword\">gid_t</span> egid = getegid();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">//&#x68C0;&#x67E5;DS&#x6587;&#x4EF6;&#x662F;&#x5426;&#x4E3A;&#x540C;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x521B;&#x5EFA;</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (puid != euid || pgid != egid) {</span><br><span class=\"line\">            ::close(s);</span><br><span class=\"line\">            <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">// &#x8BFB;&#x53D6;&#x6587;&#x4EF6;&#x5185;&#x5BB9;&#xFF0C;&#x751F;&#x6210;AttachOperation&#x5BF9;&#x8C61;</span></span><br><span class=\"line\">        AttachOperation *op = read_request(s);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (op == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">            ::close(s);</span><br><span class=\"line\">            <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">        } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">return</span> op;</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x6700;&#x540E;&#x7528;&#x5305;&#x88C5;&#x540E;&#x7684;AttachOperation&#xFF0C;&#x901A;&#x8FC7;&#x51FD;&#x6570;&#x6307;&#x9488;&#x8C03;&#x7528;&#x5DF2;&#x7ED1;&#x5B9A;&#x7684;&#x5904;&#x7406;&#x51FD;&#x6570;&#x3002;</p>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">attach_listener_thread_entry</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">    <span class=\"hljs-keyword\">int</span> pdint = AttachListener::pd_init();</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (pdint != <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    AttachListener::set_initialized();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">for</span> (;;) {</span><br><span class=\"line\">        AttachOperation* op = AttachListener::dequeue();</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (op == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">return</span>;   <span class=\"hljs-comment\">// dequeue failed or shutdown</span></span><br><span class=\"line\">        }</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-comment\">// find the function to dispatch too</span></span><br><span class=\"line\">        AttachOperationFunctionInfo* info = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">        <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">int</span> i=<span class=\"hljs-number\">0</span>; funcs[i].name != <span class=\"hljs-literal\">NULL</span>; i++) {</span><br><span class=\"line\">            <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">char</span>* name = funcs[i].name;</span><br><span class=\"line\">            <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">strcmp</span>(op-&gt;name(), name) == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">                info = &amp;(funcs[i]);</span><br><span class=\"line\">                <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">            }</span><br><span class=\"line\">        }</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (info != <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">            <span class=\"hljs-comment\">// dispatch to the function that implements this operation</span></span><br><span class=\"line\">            (info-&gt;func)(op);</span><br><span class=\"line\">        }</span><br><span class=\"line\">    }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p><font color=\"red\">&#x603B;&#x7ED3;</font> &#xFF0C;&#x901A;&#x8FC7;&#x4FE1;&#x53F7;&#x76D1;&#x542C;&#x2013;&gt;socket&#x901A;&#x4FE1;&#x2013;&gt;&#x8C03;&#x7528;&#x6307;&#x5B9A;&#x65B9;&#x6CD5;&#x7684;&#x6D41;&#x7A0B;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;&#x6211;&#x4EEC;&#x5B9E;&#x9A8C;&#x7684;&#x9884;&#x671F;&#x3002;</p>\n<h2 id=\"&#x56DB;&#x3001;&#x770B;&#x770B;JVM&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;\"><a href=\"#&#x56DB;&#x3001;&#x770B;&#x770B;JVM&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;\" class=\"headerlink\" title=\"&#x56DB;&#x3001;&#x770B;&#x770B;JVM&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;\"></a>&#x56DB;&#x3001;&#x770B;&#x770B;JVM&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;</h2><p>&#x6700;&#x540E;&#x6211;&#x4EEC;&#x56DE;&#x5230;JVM&#x5185;&#x90E8;&#xFF0C;&#x770B;&#x770B;JVM&#x662F;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x7684;&#x3002;</p>\n<p>&#x7531;&#x4E8E;&#x5B9E;&#x9A8C;&#x4EE3;&#x7801;&#x5927;&#x91CF;&#x7684;&#x91C7;&#x7528;&#x4E86;JVM&#x7684;&#x5B9E;&#x73B0;&#xFF0C;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x4E3B;&#x8981;&#x89C2;&#x5BDF;JVM&#x7684;&#x6D41;&#x7A0B;&#x3002;</p>\n<ul>\n<li>JVM&#x542F;&#x52A8;&#x65F6;&#x4F1A;&#x521D;&#x59CB;&#x5316;&#x4FE1;&#x53F7;&#x7684;&#x76D1;&#x542C;</li>\n</ul>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/runtime/thread.cpp</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\">jint <span class=\"hljs-title\">Threads::create_vm</span><span class=\"hljs-params\">(JavaVMInitArgs* args, <span class=\"hljs-keyword\">bool</span>* canTryAgain)</span> </span>{</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Signal Dispatcher needs to be started before VMInit event is posted</span></span><br><span class=\"line\">  os::signal_init();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-comment\">// Start Attach Listener if +StartAttachListener or it can&apos;t be started lazily</span></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (!DisableAttachMechanism) {</span><br><span class=\"line\">    AttachListener::vm_start();</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (StartAttachListener || AttachListener::init_at_startup()) {</span><br><span class=\"line\">      AttachListener::init();</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">    ...</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>os::signal_init();&#x529F;&#x80FD;&#x6211;&#x4EEC;&#x524D;&#x9762;&#x5DF2;&#x7ECF;&#x5206;&#x6790;&#x8FC7;&#xFF0C;JVM&#x4F1A;&#x6CE8;&#x518C;kill -3&#x4FE1;&#x53F7;&#x7684;&#x76D1;&#x542C;&#x548C;&#x5BF9;&#x5E94;&#x7684;&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x540C;&#x65F6;&#x4F1A;&#x542F;&#x52A8;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x5BF9;&#x76D1;&#x542C;&#x5230;&#x7684;&#x4FE1;&#x53F7;&#x505A;&#x540E;&#x7EED;&#x4E1A;&#x52A1;&#x5904;&#x7406;&#x3002;</p>\n<p><font color=\"blue\">DisableAttachMechanism</font> &amp; <font color=\"blue\">StartAttachListener</font> &#x9ED8;&#x8BA4;&#x4E3A;false&#xFF0C;&#x5728;JVM&#x9ED8;&#x8BA4;&#x542F;&#x52A8;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x4E0D;&#x4F1A;&#x521D;&#x59CB;&#x5316;Attach&#x7684;&#x76D1;&#x542C;&#x3002;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/runtime/globals.hpp</p>\n</blockquote>\n<figure class=\"highlight plain hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">product(bool, DisableAttachMechanism, false,                              \\</span><br><span class=\"line\">        &quot;Disable mechanism that allows tools to attach to this VM&quot;) </span><br><span class=\"line\">product(bool, StartAttachListener, false,                                 \\</span><br><span class=\"line\">        &quot;Always start Attach Listener at VM startup&quot;)      </span><br></pre></td></tr></tbody></table></figure>\n\n<p>JVM&#x76D1;&#x542C;&#x5230;&#x4FE1;&#x53F7;&#x540E;&#xFF0C;&#x5F53;&#x4FE1;&#x53F7;&#x4F4D;kill -3&#x65F6;&#x5982;&#x679C;&#x8FD8;&#x672A;&#x521D;&#x59CB;&#x5316;attach&#x76D1;&#x542C;&#xFF0C;&#x5C06;&#x4F1A;&#x8FDB;&#x884C;&#x76F8;&#x5E94;&#x521D;&#x59CB;&#x5316;&#x8FC7;&#x7A0B;&#x3002;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/runtime/thread.cpp-&gt;create_vm()<br>            &#x2014;- src/share/vm/runtime/os.cpp-&gt;signal_init()<br>                &#x2014;- src/share/vm/runtime/os.cpp-&gt;signal_thread_entry()</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">signal_thread_entry</span><span class=\"hljs-params\">(JavaThread* thread, TRAPS)</span> </span>{</span><br><span class=\"line\">  os::set_priority(thread, NearMaxPriority);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">while</span> (<span class=\"hljs-literal\">true</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">int</span> sig;</span><br><span class=\"line\">    {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// FIXME : Currently we have not decieded what should be the status</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">//         for this java thread blocked here. Once we decide about</span></span><br><span class=\"line\">      <span class=\"hljs-comment\">//         that we should fix this.</span></span><br><span class=\"line\">      sig = os::signal_wait();</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (sig == os::sigexitnum_pd()) {</span><br><span class=\"line\">       <span class=\"hljs-comment\">// Terminate the signal thread</span></span><br><span class=\"line\">       <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">switch</span> (sig) {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">case</span> SIGBREAK: {</span><br><span class=\"line\">        <span class=\"hljs-comment\">// Check if the signal is a trigger to start the Attach Listener - in that</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">// case don&apos;t print stack traces.</span></span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (!DisableAttachMechanism &amp;&amp; AttachListener::is_init_trigger()) {</span><br><span class=\"line\">          <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"hljs-comment\">// Print stack traces</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">// Any SIGBREAK operations added here should make sure to flush</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">// the output stream (e.g. tty-&gt;flush()) after output.  See 4803766.</span></span><br><span class=\"line\">        <span class=\"hljs-comment\">// Each module also prints an extra carriage return after its output.</span></span><br><span class=\"line\">        VM_PrintThreads op;</span><br><span class=\"line\">        VMThread::execute(&amp;op);</span><br><span class=\"line\">        VM_PrintJNI jni_op;</span><br><span class=\"line\">        VMThread::execute(&amp;jni_op);</span><br><span class=\"line\">        <span class=\"hljs-function\">VM_FindDeadlocks <span class=\"hljs-title\">op1</span><span class=\"hljs-params\">(tty)</span></span>;</span><br><span class=\"line\">        VMThread::execute(&amp;op1);</span><br><span class=\"line\">        Universe::print_heap_at_SIGBREAK();</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (PrintClassHistogram) {</span><br><span class=\"line\">          <span class=\"hljs-function\">VM_GC_HeapInspection <span class=\"hljs-title\">op1</span><span class=\"hljs-params\">(gclog_or_tty, <span class=\"hljs-literal\">true</span> <span class=\"hljs-comment\">/* force full GC before heap inspection */</span>)</span></span>;</span><br><span class=\"line\">          VMThread::execute(&amp;op1);</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (JvmtiExport::should_post_data_dump()) {</span><br><span class=\"line\">          JvmtiExport::post_data_dump();</span><br><span class=\"line\">        }</span><br><span class=\"line\">        <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">      }</span><br><span class=\"line\">      ...</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x521D;&#x59CB;&#x5316;Attach&#x76D1;&#x542C;&#x65F6;&#x4F1A;&#x68C0;&#x67E5;Java&#x5BA2;&#x6237;&#x7AEF;&#x751F;&#x6210;&#x7684;attach&#x6587;&#x4EF6;&#x3002;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/runtime/thread.cpp-&gt;create_vm()<br>            &#x2014;- src/share/vm/runtime/os.cpp-&gt;signal_init()<br>                &#x2014;- src/share/vm/runtime/os.cpp-&gt;signal_thread_entry()<br>                     &#x2014;- src/os/bsd/vm/attachListener_bsd.cpp-&gt;is_init_trigger()</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">bool</span> <span class=\"hljs-title\">AttachListener::is_init_trigger</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (init_at_startup() || is_initialized()) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>;               <span class=\"hljs-comment\">// initialized at startup or already initialized</span></span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-keyword\">char</span> path[PATH_MAX + <span class=\"hljs-number\">1</span>];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">int</span> ret;</span><br><span class=\"line\">  <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">stat</span> <span class=\"hljs-title\">st</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-built_in\">snprintf</span>(path, PATH_MAX + <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&quot;%s/.attach_pid%d&quot;</span>,</span><br><span class=\"line\">           os::get_temp_directory(), os::current_process_id());</span><br><span class=\"line\">  RESTARTABLE(::stat(path, &amp;st), ret);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (ret == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// simple check to avoid starting the attach mechanism when</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// a bogus user creates the file</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (st.st_uid == geteuid()) {</span><br><span class=\"line\">      init();</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x786E;&#x8BA4;Java&#x5BA2;&#x6237;&#x7AEF;&#x5F00;&#x59CB;attach&#x5E76;&#x4E14;&#x6743;&#x9650;&#x6821;&#x9A8C;&#x901A;&#x8FC7;&#x540E;&#x5F00;&#x59CB;socket&#x901A;&#x8BAF;&#xFF0C;&#x9996;&#x5148;&#x521D;&#x59CB;&#x5316;socket&#x5E76;&#x7ED1;&#x5B9A;&#x76D1;&#x542C;&#x3002;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A; src/os/bsd/vm/attachListener_bsd.cpp-&gt;is_init_trigger()<br>            &#x2014;- src/share/vm/services/attachListener.cpp-&gt;init()</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">bool</span> <span class=\"hljs-title\">AttachListener::is_init_trigger</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (init_at_startup() || is_initialized()) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>;               <span class=\"hljs-comment\">// initialized at startup or already initialized</span></span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-keyword\">char</span> path[PATH_MAX + <span class=\"hljs-number\">1</span>];</span><br><span class=\"line\">  <span class=\"hljs-keyword\">int</span> ret;</span><br><span class=\"line\">  <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">stat</span> <span class=\"hljs-title\">st</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-built_in\">snprintf</span>(path, PATH_MAX + <span class=\"hljs-number\">1</span>, <span class=\"hljs-string\">&quot;%s/.attach_pid%d&quot;</span>,</span><br><span class=\"line\">           os::get_temp_directory(), os::current_process_id());</span><br><span class=\"line\">  RESTARTABLE(::stat(path, &amp;st), ret);</span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (ret == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">    <span class=\"hljs-comment\">// simple check to avoid starting the attach mechanism when</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// a bogus user creates the file</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (st.st_uid == geteuid()) {</span><br><span class=\"line\">      init();</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">true</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">  <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">false</span>;</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x6700;&#x7EC8;JVM&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x7EBF;&#x7A0B;&#x6267;&#x884C;Attach&#x76D1;&#x542C;&#x65B9;&#x6CD5;&#xFF0C;&#x65B9;&#x6CD5;accept&#x4ECE;Java&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x9001;&#x7684;&#x6307;&#x4EE4;&#xFF0C;&#x5E76;&#x89E3;&#x6790;&#x4E3A;&#x5BF9;&#x5E94;&#x7684;&#x51FD;&#x6570;&#x3002;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A; src/share/vm/services/attachListener.cpp-&gt;init()<br>            &#x2014;- src/share/vm/services/attachListener.cpp-&gt;attach_listener_thread_entry()</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\"><span class=\"hljs-keyword\">static</span> <span class=\"hljs-keyword\">void</span> <span class=\"hljs-title\">attach_listener_thread_entry</span><span class=\"hljs-params\">(JavaThread* thread, TRAPS)</span> </span>{</span><br><span class=\"line\">  os::set_priority(thread, NearMaxPriority);</span><br><span class=\"line\"></span><br><span class=\"line\">  thread-&gt;record_stack_base_and_size();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">if</span> (AttachListener::pd_init() != <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">return</span>;</span><br><span class=\"line\">  }</span><br><span class=\"line\">  AttachListener::set_initialized();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (;;) {</span><br><span class=\"line\">    AttachOperation* op = AttachListener::dequeue();</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (op == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span>;   <span class=\"hljs-comment\">// dequeue failed or shutdown</span></span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    ResourceMark rm;</span><br><span class=\"line\">    bufferedStream st;</span><br><span class=\"line\">    jint res = JNI_OK;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// handle special detachall operation</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">strcmp</span>(op-&gt;name(), AttachOperation::detachall_operation_name()) == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">      AttachListener::detachall();</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">      <span class=\"hljs-comment\">// find the function to dispatch too</span></span><br><span class=\"line\">      AttachOperationFunctionInfo* info = <span class=\"hljs-literal\">NULL</span>;</span><br><span class=\"line\">      <span class=\"hljs-keyword\">for</span> (<span class=\"hljs-keyword\">int</span> i=<span class=\"hljs-number\">0</span>; funcs[i].name != <span class=\"hljs-literal\">NULL</span>; i++) {</span><br><span class=\"line\">        <span class=\"hljs-keyword\">const</span> <span class=\"hljs-keyword\">char</span>* name = funcs[i].name;</span><br><span class=\"line\">        assert(<span class=\"hljs-built_in\">strlen</span>(name) &lt;= AttachOperation::name_length_max, <span class=\"hljs-string\">&quot;operation &lt;= name_length_max&quot;</span>);</span><br><span class=\"line\">        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">strcmp</span>(op-&gt;name(), name) == <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">          info = &amp;(funcs[i]);</span><br><span class=\"line\">          <span class=\"hljs-keyword\">break</span>;</span><br><span class=\"line\">        }</span><br><span class=\"line\">      }</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-comment\">// check for platform dependent attach operation</span></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (info == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">        info = AttachListener::pd_find_operation(op-&gt;name());</span><br><span class=\"line\">      }</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"hljs-keyword\">if</span> (info != <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">        <span class=\"hljs-comment\">// dispatch to the function that implements this operation</span></span><br><span class=\"line\">        res = (info-&gt;func)(op, &amp;st);</span><br><span class=\"line\">      } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">        st.print(<span class=\"hljs-string\">&quot;Operation %s not recognized!&quot;</span>, op-&gt;name());</span><br><span class=\"line\">        res = JNI_ERR;</span><br><span class=\"line\">      }</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// operation complete - send result and output to client</span></span><br><span class=\"line\">    op-&gt;complete(res, &amp;st);</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A; src/share/vm/services/attachListener.cpp-&gt;attach_listener_thread_entry()<br>            &#x2014;- src/os/bsd/vm/attachListener_bsd.cpp-&gt;dequeue()<br>                 &#x2014;- src/os/bsd/vm/attachListener_bsd.cpp-&gt;BsdAttachListener::dequeue()</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-function\">BsdAttachOperation* <span class=\"hljs-title\">BsdAttachListener::dequeue</span><span class=\"hljs-params\">()</span> </span>{</span><br><span class=\"line\">  <span class=\"hljs-keyword\">for</span> (;;) {</span><br><span class=\"line\">    <span class=\"hljs-keyword\">int</span> s;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// wait for client to connect</span></span><br><span class=\"line\">    <span class=\"hljs-class\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title\">sockaddr</span> <span class=\"hljs-title\">addr</span>;</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">socklen_t</span> len = <span class=\"hljs-keyword\">sizeof</span>(addr);</span><br><span class=\"line\">    RESTARTABLE(::accept(listener(), &amp;addr, &amp;len), s);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (s == <span class=\"hljs-number\">-1</span>) {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> <span class=\"hljs-literal\">NULL</span>;      <span class=\"hljs-comment\">// log a warning?</span></span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// get the credentials of the peer and check the effective uid/guid</span></span><br><span class=\"line\">    <span class=\"hljs-comment\">// - check with jeff on this.</span></span><br><span class=\"line\">    <span class=\"hljs-keyword\">uid_t</span> puid;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">gid_t</span> pgid;</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (::getpeereid(s, &amp;puid, &amp;pgid) != <span class=\"hljs-number\">0</span>) {</span><br><span class=\"line\">      ::close(s);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\">    <span class=\"hljs-keyword\">uid_t</span> euid = geteuid();</span><br><span class=\"line\">    <span class=\"hljs-keyword\">gid_t</span> egid = getegid();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (puid != euid || pgid != egid) {</span><br><span class=\"line\">      ::close(s);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">    }</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"hljs-comment\">// peer credential look okay so we read the request</span></span><br><span class=\"line\">    BsdAttachOperation* op = read_request(s);</span><br><span class=\"line\">    <span class=\"hljs-keyword\">if</span> (op == <span class=\"hljs-literal\">NULL</span>) {</span><br><span class=\"line\">      ::close(s);</span><br><span class=\"line\">      <span class=\"hljs-keyword\">continue</span>;</span><br><span class=\"line\">    } <span class=\"hljs-keyword\">else</span> {</span><br><span class=\"line\">      <span class=\"hljs-keyword\">return</span> op;</span><br><span class=\"line\">    }</span><br><span class=\"line\">  }</span><br><span class=\"line\">}</span><br></pre></td></tr></tbody></table></figure>\n\n<p>&#x6307;&#x4EE4;&#x4E0E;&#x65B9;&#x6CD5;&#x7684;&#x6620;&#x5C04;&#x662F;&#x4E8B;&#x5148;&#x51C6;&#x5907;&#x597D;&#x7684;</p>\n<blockquote>\n<p>&#x4EE3;&#x7801;&#x6E05;&#x5355;&#xFF1A;src/share/vm/services/attachListener.cpp</p>\n</blockquote>\n<figure class=\"highlight c++ hljs\"><table><tbody><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"hljs-keyword\">static</span> AttachOperationFunctionInfo funcs[] = {</span><br><span class=\"line\">  { <span class=\"hljs-string\">&quot;agentProperties&quot;</span>,  get_agent_properties },</span><br><span class=\"line\">  { <span class=\"hljs-string\">&quot;datadump&quot;</span>,         data_dump },</span><br><span class=\"line\">  { <span class=\"hljs-string\">&quot;dumpheap&quot;</span>,         dump_heap },</span><br><span class=\"line\">  { <span class=\"hljs-string\">&quot;load&quot;</span>,             JvmtiExport::load_agent_library },</span><br><span class=\"line\">  { <span class=\"hljs-string\">&quot;properties&quot;</span>,       get_system_properties },</span><br><span class=\"line\">  { <span class=\"hljs-string\">&quot;threaddump&quot;</span>,       thread_dump },</span><br><span class=\"line\">  { <span class=\"hljs-string\">&quot;inspectheap&quot;</span>,      heap_inspection },</span><br><span class=\"line\">  { <span class=\"hljs-string\">&quot;setflag&quot;</span>,          set_flag },</span><br><span class=\"line\">  { <span class=\"hljs-string\">&quot;printflag&quot;</span>,        print_flag },</span><br><span class=\"line\">  { <span class=\"hljs-string\">&quot;jcmd&quot;</span>,             jcmd },</span><br><span class=\"line\">  { <span class=\"hljs-literal\">NULL</span>,               <span class=\"hljs-literal\">NULL</span> }</span><br><span class=\"line\">};</span><br></pre></td></tr></tbody></table></figure>\n\n\n<p><font color=\"red\">&#x603B;&#x7ED3;</font>,&#x76F8;&#x4FE1;&#x901A;&#x8FC7;&#x4E0A;&#x9762;&#x7684;&#x5206;&#x6790;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x6E05;&#x695A;&#x7684;&#x4E86;&#x89E3;JVM&#x662F;&#x5982;&#x4F55;&#x63A5;&#x6536;&#x5230;Java&#x5BA2;&#x6237;&#x7AEF;&#x53D1;&#x8D77;&#x7684;&#x8BF7;&#x6C42;&#xFF0C;&#x4ECE;&#x800C;&#x5B9E;&#x73B0;&#x52A8;&#x6001;Attach&#x7684;&#x529F;&#x80FD;&#x3002;&#x5177;&#x4F53;&#x6D41;&#x7A0B;&#x5982;&#x56FE;&#xFF1A;<br><img src=\"/2020/09/21/%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90JVM-%E5%8A%A8%E6%80%81Attach%E5%8E%9F%E7%90%86/flow.png\" alt=\"03\"></p>\n</body></html>","site":{"data":{}},"_categories":[{"name":"Technology","path":"categories/Technology/"}],"_tags":[{"name":"JVM","path":"tags/JVM/"},{"name":"Java","path":"tags/Java/"}],"excerpt":"<html><head></head><body><p>&#x76F8;&#x4FE1;&#x5F88;&#x591A;&#x5C0F;&#x4F19;&#x4F34;&#x90FD;&#x4F7F;&#x7528;&#x8FC7;javaagent&#x63A2;&#x9488;&#x6280;&#x672F;&#xFF0C;javaagent&#x53EF;&#x4EE5;&#x5728;&#x4E0D;&#x4FB5;&#x5165;&#x539F;&#x4EE3;&#x7801;&#x4E0D;&#x7684;&#x524D;&#x63D0;&#x4E0B;&#xFF0C;&#x901A;&#x8FC7;&#x6307;&#x5B9A;&#x65B9;&#x6CD5;&#x5E76;&#x5229;&#x7528;&#x52A8;&#x6001;&#x5B57;&#x8282;&#x7801;&#x6280;&#x672F;&#x589E;&#x5F3A;&#x6211;&#x4EEC;&#x7684;&#x4EE3;&#x7801;&#x3002;&#x5F88;&#x591A;&#x6210;&#x719F;&#x7684;&#x6846;&#x67B6;&#x4E5F;&#x8FD0;&#x7528;&#x5230;&#x4E86;&#x8BE5;&#x6280;&#x672F;&#xFF0C;&#x5982;skywalking&#x7B49;&#x3002;&#x8FD9;&#x4E48;&#x597D;&#x7528;&#x7684;&#x529F;&#x80FD;&#xFF0C;JDK&#x7684;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x6CA1;&#x9053;&#x7406;&#x4E0D;&#x73A9;&#x51FA;&#x4E9B;&#x65B0;&#x82B1;&#x5934;&#xFF0C;&#x56E0;&#x6B64;&#x5728;JDK1.6&#x4E2D;&#xFF0C;&#x66F4;&#x52A0;&#x5F3A;&#x5927;&#x7684;JVM &#x52A8;&#x6001;Attach&#x6280;&#x672F;&#x5C55;&#x73B0;&#x5728;&#x6211;&#x4EEC;&#x7684;&#x9762;&#x524D;&#x3002;&#x5927;&#x540D;&#x9F0E;&#x9F0E;&#x7684;Btrace&#x3001;Arthas&#x7B49;&#x90FD;&#x8FD0;&#x7528;&#x4E86;&#x52A8;&#x6001;Attach&#x6280;&#x672F;&#x3002;&#x5728;JVM&#x8FD0;&#x884C;&#x671F;&#x8FDB;&#x62E6;&#x622A;&#x5E76;&#x589E;&#x5F3A;&#x6211;&#x4EEC;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x4F7F;&#x5F97;&#x4EE5;&#x5F80;&#x751F;&#x4EA7;&#x96BE;&#x4EE5;&#x5B9A;&#x4F4D;&#x7684;&#x95EE;&#x9898;&#x53D8;&#x5F97;&#x66F4;&#x52A0;&#x5BB9;&#x6613;&#x6392;&#x67E5;&#x3002;</p></body></html>","more":"<p>JVM的动态Attach固然好，相信大家或多或少已经知道如何去使用该技术了，所以这次我们研究的重点是JVM是如何实现动态Attach，至于JVM如何加载动态Jar包、分发方法并传递jvm上下文就不在我们的研究范围之内。</p>\n<p>为了更好的研究JVM的实现，我们将由浅入深，分为几个阶段进行研究：</p>\n<ul>\n<li>动态Attach是什么？</li>\n<li>有几种方案可以实现动态Attach</li>\n<li>举一个栗子</li>\n<li>看看JVM是怎么做的</li>\n</ul>\n<h2 id=\"一、动态Attach是什么\"><a href=\"#一、动态Attach是什么\" class=\"headerlink\" title=\"一、动态Attach是什么\"></a>一、动态Attach是什么</h2><p>虽然我们这次研究的是具体的实现，但在这之前，我们需要像分析需求一样分析下动态Attach到底是什么。</p>\n<p>我们都知道javaagent参数是伴随着java命令，在JVM启动的过程中加载javaagent参数指定的Jar包路径，并执行约定类的premain方法。在premain方法中可以获取Instrumentation类型参数，从而对我们的类进行动态增强增强。</p>\n<p>我们可以这样使用javaagent：</p>\n<ol>\n<li><p>先实现一个我们需要挂在的类，其中需要实现premain()方法，并将它打包为可执行Jar包</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Javaagent</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">premain</span><span class=\"params\">(String agentArgs, Instrumentation inst)</span> </span>&#123;</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;agentArgs : &quot;</span> + agentArgs);</span><br><span class=\"line\">        inst.addTransformer(<span class=\"keyword\">new</span> TestTransformer(), <span class=\"keyword\">true</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">TestTransformer</span> <span class=\"keyword\">implements</span> <span class=\"title\">ClassFileTransformer</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"meta\">@Override</span></span><br><span class=\"line\">        <span class=\"keyword\">public</span> <span class=\"keyword\">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class=\"keyword\">byte</span>[] classfileBuffer) <span class=\"keyword\">throws</span> IllegalClassFormatException &#123;</span><br><span class=\"line\">            System.out.println(<span class=\"string\">&quot;premain load Class:&quot;</span> + className);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> classfileBuffer;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置MANIFEST.MF配置文件</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Premain-Class: Javaagent</span><br><span class=\"line\">Agent-Class: Javaagent</span><br><span class=\"line\">Can-Redefine-Classes: true</span><br><span class=\"line\">Can-Retransform-Classes: true</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>启动我们的服务</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -javaagent:Javaagent.jar 自己的服务.jar</span><br></pre></td></tr></table></figure>\n\n</li>\n</ol>\n<p>以上就是一个简单的javaagent运用场景。javaagent可以在不侵入业务代码的前提下修改我们已加载的类，但唯一的问题是需要伴随着业务服务一同启动。也就是说我们无法侵入已经运行在JVM中的代码，因此JDK开发的大神们为我们带来了动态Attach API。其功能与javaagent是一样的，但最大的好处就是我们能够在一个已经运行的JVM上动态的挂载一个我们自己开发的Jar包，从而实现任何时间点我们都能手动的增强业务代码。比如通过attach Arthas，我们能增强指定方法的入口&amp;出口，从而获取出入参的相关信息。这在缺少日志输出的场景下是非常有效的问题定位手段。此外我们也能为方法的调用链做埋点，帮助我们分析业务流程中的慢方法等等。</p>\n<p>总结下，动态Attach就是JVM运行期中提供的指定类型的类加载机制。通过增强类的加载，实现各式各样有趣的功能。</p>\n<h2 id=\"二、有几种方案可以实现动态Attach\"><a href=\"#二、有几种方案可以实现动态Attach\" class=\"headerlink\" title=\"二、有几种方案可以实现动态Attach\"></a>二、有几种方案可以实现动态Attach</h2><p>现在我们已经知道什么是动态Attach了，倘若我们是JDK的工程师，当产品交给我们需要实现动态Attach这个需求时，我们会怎么实现呢？</p>\n<h4 id=\"1-直接类加载法\"><a href=\"#1-直接类加载法\" class=\"headerlink\" title=\"1.直接类加载法\"></a>1.直接类加载法</h4><p>JDK已经提供了一套完善的类加载机制，如果提供获取Instrumentation对象的JNI，开发人员就可以自行通过动态类加载后进行字节码动态增强。这个方案看似很美好，现有Java生态圈已经拥有丰富的Class动态加载方案，利用这些现有方案，开发人员能够很快的搭建出自己的字节码动态加载机制，而无需JVM提供大量的native支持。但是这个方案存在重大的安全问题，一旦服务的动态加载机制被黑客破解，那么他完全能够加载一个自己编写好的侵入类，通过入侵类任意修改业务代码最终导致无法挽回的损失。所以作为一个JDK开发工程师，一定要在初期就屏蔽这种安全问题。同时Java最为一种安全语言，不安全的操作需要尽量避免引入Java生态中。</p>\n<h4 id=\"2-Socket通信法\"><a href=\"#2-Socket通信法\" class=\"headerlink\" title=\"2.Socket通信法\"></a>2.Socket通信法</h4><p>既然提供JNI不安全，那么我们是否可以考虑让JVM自己处理。假设我们能和JVM建立起Socket通讯。并将我们希望加载的类告知JVM，JVM在加载完成后按照约定执行指定的入口方法，这样也能实现我们对动态Attach的实现。</p>\n<p>Socket通信可以分为远程通信和本地通信。我们需要考虑，如果采用远程通信，的确能给我们带来更强大的Attach灵活性，但需要JVM暴露端口，同样具有一定的安全问题。<br>本地通讯我们可以采用UNIX Domain Socket，通过文件形式通讯。不但具有较高的通信速度，同时具有一定的安全性。</p>\n<p>如果采用Socket Local通信，那我们又如何与JVM建立起通信呢？</p>\n<h4 id=\"3-信号监听法\"><a href=\"#3-信号监听法\" class=\"headerlink\" title=\"3.信号监听法\"></a>3.信号监听法</h4><p>其实这个方法是Socket通信法的补充。在与JVM建立起本地通信前，JVM需要知道用户想要开始动态Attach。而信号监听就能补充这方面的功能。客户端以约定的形式向JVM进程发起指定信号，同时JVM在监听到Attach信号后与客户端建立Socket链接。客户端以Socket方式将需要加载的类告知JVM并进行加载并最终运行我们后面熟悉的javaagent流程。</p>\n<p>我虽然不是JDK的工程师，上面的3个方案也是结合了JDK1.8的具体实现后大胆的揣测了当时开发工程师的想法。可能当时摆在他面前的方案更是成千上万，但是最终确定下这个技术方案的心路历程我觉得是我们每个开发都需要感同身受的。</p>\n<h2 id=\"三、举一个栗子\"><a href=\"#三、举一个栗子\" class=\"headerlink\" title=\"三、举一个栗子\"></a>三、举一个栗子</h2><p>前面我们分析了实现方案，我们先丢一份代码来验证上面的方案（代码为JDK1.8源码相关功能的简化版）</p>\n<h3 id=\"开始实验\"><a href=\"#开始实验\" class=\"headerlink\" title=\"开始实验\"></a>开始实验</h3><p><font color=\"blue\">需求：</font>实现动态Attach API，接收java -jar xxx.jar pid发起的挂载请求，并将loadAgent指定的Jar包完整路径显示在控制台。</p>\n<p><font color=\"blue\">实验环境：</font>MacOS 10.15.6</p>\n<p><font color=\"blue\">项目地址：</font></p>\n<blockquote>\n<p><a href=\"https://github.com/xzenge/JVM_ATTACH/tree/dev\">https://github.com/xzenge/JVM_ATTACH/tree/dev</a></p>\n</blockquote>\n<h5 id=\"我们先启动项目。该项目模拟了JVM运行环境，但只实现了Attach-API的部分功能。项目启动成功后，我们可以看到当前的JVM进程ID为：32910\"><a href=\"#我们先启动项目。该项目模拟了JVM运行环境，但只实现了Attach-API的部分功能。项目启动成功后，我们可以看到当前的JVM进程ID为：32910\" class=\"headerlink\" title=\"我们先启动项目。该项目模拟了JVM运行环境，但只实现了Attach API的部分功能。项目启动成功后，我们可以看到当前的JVM进程ID为：32910\"></a>我们先启动项目。该项目模拟了JVM运行环境，但只实现了Attach API的部分功能。项目启动成功后，我们可以看到当前的JVM进程ID为：<font color=\"red\">32910</font></h5><p><img src=\"/2020/09/21/%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90JVM-%E5%8A%A8%E6%80%81Attach%E5%8E%9F%E7%90%86/JVM_start.png\" alt=\"01\"></p>\n<hr>\n<h5 id=\"按照JDK规范编写JAVA测Attach方法。为了简便，方法中我们手动指定了attach的线程号，并提供了JVM需要加载的Jar包路径。\"><a href=\"#按照JDK规范编写JAVA测Attach方法。为了简便，方法中我们手动指定了attach的线程号，并提供了JVM需要加载的Jar包路径。\" class=\"headerlink\" title=\"按照JDK规范编写JAVA测Attach方法。为了简便，方法中我们手动指定了attach的线程号，并提供了JVM需要加载的Jar包路径。\"></a>按照JDK规范编写JAVA测Attach方法。为了简便，方法中我们手动指定了attach的线程号，并提供了JVM需要加载的Jar包路径。</h5><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Attach</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException </span>&#123;</span><br><span class=\"line\">        VirtualMachine attach = VirtualMachine.attach(<span class=\"string\">&quot;32910&quot;</span>);</span><br><span class=\"line\">        attach.loadAgentPath(<span class=\"string\">&quot;/Users/xiangshi/.gradle/caches/modules-2/files-2.1/cglib/cglib/3.1/1f1cb6c7a7479e0c7fd7987109e503914bebe84a/cglib-3.1.jar&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<hr>\n<h5 id=\"运行Java-attach方法，我们可以观察到模拟的JVM已经读取到了我们希望classloader的Jar包\"><a href=\"#运行Java-attach方法，我们可以观察到模拟的JVM已经读取到了我们希望classloader的Jar包\" class=\"headerlink\" title=\"运行Java attach方法，我们可以观察到模拟的JVM已经读取到了我们希望classloader的Jar包\"></a>运行Java attach方法，我们可以观察到模拟的JVM已经读取到了我们希望classloader的Jar包</h5><p><img src=\"/2020/09/21/%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90JVM-%E5%8A%A8%E6%80%81Attach%E5%8E%9F%E7%90%86/load_agent_library.png\" alt=\"02\"></p>\n<hr>\n<h3 id=\"实验分析\"><a href=\"#实验分析\" class=\"headerlink\" title=\"实验分析\"></a>实验分析</h3><p>实验过程很简单，我们伪造了个JVM运行时环境。并通过JAVA原生的Attach API成功的实现了与JVM之间通讯的功能。下面我们开始逐步分析具体的实现过程：</p>\n<ul>\n<li>监听signal<br>初始化OS信号监听的相关数据</li>\n</ul>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * JVM启动时监听signal</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">os::signal_init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//初始化signal监听pending_signals</span></span><br><span class=\"line\">    os::signal_init_pd();</span><br><span class=\"line\">    <span class=\"comment\">//创建线程监听pending_signals状态并进行相应处理</span></span><br><span class=\"line\">    <span class=\"keyword\">pthread_t</span> tids;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> ret = pthread_create(&amp;tids, <span class=\"literal\">NULL</span>, <span class=\"keyword\">reinterpret_cast</span>&lt;<span class=\"keyword\">void</span> *(*)(<span class=\"keyword\">void</span> *)&gt;(signal_thread_entry), <span class=\"literal\">NULL</span>);</span><br><span class=\"line\">    <span class=\"comment\">//注册signal处理器</span></span><br><span class=\"line\">    os::signal(SIGBREAK,os::user_handler());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>sigaction方法提供os信号的监听并注册信号处理器，我们监听-3 SIGQUIT信号。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 注册监听信号&amp;处理器</span></span><br><span class=\"line\"><span class=\"comment\"> * @param signal_number 信号编号</span></span><br><span class=\"line\"><span class=\"comment\"> * @param handler 信号处理器</span></span><br><span class=\"line\"><span class=\"comment\"> * @return</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> *<span class=\"title\">os::signal</span><span class=\"params\">(<span class=\"keyword\">int</span> signal_number, <span class=\"keyword\">void</span> *handler)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sigaction</span> <span class=\"title\">sigAct</span>, <span class=\"title\">oldSigAct</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    sigfillset(&amp;(sigAct.sa_mask));</span><br><span class=\"line\">    sigAct.sa_flags   = SA_RESTART|SA_SIGINFO;</span><br><span class=\"line\">    sigAct.sa_handler = CAST_TO_FN_PTR(<span class=\"keyword\">sa_handler_t</span>, handler);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (sigaction(signal_number, &amp;sigAct, &amp;oldSigAct)) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// -1 means registration failed</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> (<span class=\"keyword\">void</span> *)<span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> CAST_FROM_FN_PTR(<span class=\"keyword\">void</span>*, oldSigAct.sa_handler);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>信号处理器中简单的模拟的收到信号的处理过程，数组对应的信号位置为1时，说明收到了对应的信号。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 通过pending_signals保留监听到的信息，交由专门的线程处理该信息</span></span><br><span class=\"line\"><span class=\"comment\"> * @param signal_number</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">os::signal_notify</span><span class=\"params\">(<span class=\"keyword\">int</span> signal_number)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;enter signal_notify sig:&quot;</span> &lt;&lt; signal_number &lt;&lt; <span class=\"built_in\">endl</span>;</span><br><span class=\"line\">    <span class=\"comment\">//将监听到的信号为竖为1</span></span><br><span class=\"line\">    <span class=\"comment\">//改操作应该为原子操作，确保不会被其他线程修改</span></span><br><span class=\"line\">    <span class=\"comment\">//JVM中混编平台相关汇编指令实现原子操作，演示代码中不研究相关实现</span></span><br><span class=\"line\">    pending_signals[signal_number] = <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    semaphore_signal(sig_sem);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>单独起一个线程，该线程轮训信号接受数组的状态，将置为1的信号码传给下游处理。当信号位-3 SIGQUIT信号时，开始初始化attach的监听方法。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 单独线程对pending_signals状态并进行相应处理</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">signal_thread_entry</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;enter signal_thread_entry&quot;</span> &lt;&lt; <span class=\"built_in\">endl</span>;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> sig;</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            sig = os::signal_wait();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">switch</span> (sig) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">case</span> SIGBREAK: &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (AttachListener::init()) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>初始化attach监听方法时，会创建一个Domain Socket的文件监听，并accept在改文件上。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * 初始化domain socket监听</span></span><br><span class=\"line\"><span class=\"comment\"> * JVM通过监听指定线程文件文件</span></span><br><span class=\"line\"><span class=\"comment\"> * 获取client想JVM发送的指令并进行相关操作</span></span><br><span class=\"line\"><span class=\"comment\"> * @return</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">AttachListener::pd_init</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">char</span> path[UNIX_PATH_MAX];          <span class=\"comment\">// socket file</span></span><br><span class=\"line\">    <span class=\"keyword\">char</span> initial_path[UNIX_PATH_MAX];  <span class=\"comment\">// socket file during setup</span></span><br><span class=\"line\">    <span class=\"keyword\">int</span> listener;                      <span class=\"comment\">// listener socket (file descriptor)</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// register function to cleanup</span></span><br><span class=\"line\">    ::atexit(listener_cleanup);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">int</span> n = <span class=\"built_in\">snprintf</span>(path, UNIX_PATH_MAX, <span class=\"string\">&quot;%s/.java_pid%d&quot;</span>,</span><br><span class=\"line\">                     TEMP_PATH, getpid());</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (n &lt; (<span class=\"keyword\">int</span>) UNIX_PATH_MAX) &#123;</span><br><span class=\"line\">        n = <span class=\"built_in\">snprintf</span>(initial_path, UNIX_PATH_MAX, <span class=\"string\">&quot;%s.tmp&quot;</span>, path);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (n &gt;= (<span class=\"keyword\">int</span>) UNIX_PATH_MAX) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"built_in\">cout</span> &lt;&lt; <span class=\"string\">&quot;path:&quot;</span> &lt;&lt; path &lt;&lt; <span class=\"built_in\">endl</span>;</span><br><span class=\"line\">    <span class=\"comment\">// create the listener socket</span></span><br><span class=\"line\">    listener = ::socket(PF_UNIX, SOCK_STREAM, <span class=\"number\">0</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (listener == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// bind socket</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sockaddr_un</span> <span class=\"title\">addr</span>;</span></span><br><span class=\"line\">    addr.sun_family = AF_UNIX;</span><br><span class=\"line\">    <span class=\"built_in\">strcpy</span>(addr.sun_path, initial_path);</span><br><span class=\"line\">    ::unlink(initial_path);</span><br><span class=\"line\">    <span class=\"keyword\">int</span> res = ::bind(listener, (struct sockaddr *) &amp;addr, <span class=\"keyword\">sizeof</span>(addr));</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (res == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        ::close(listener);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// put in listen mode, set permissions, and rename into place</span></span><br><span class=\"line\">    res = ::listen(listener, <span class=\"number\">5</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (res == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        RESTARTABLE(::chmod(initial_path, S_IREAD | S_IWRITE), res);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (res == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (res == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                res = ::rename(initial_path, path);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (res == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">        ::close(listener);</span><br><span class=\"line\">        ::unlink(initial_path);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"number\">-1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    set_path(path);</span><br><span class=\"line\">    set_listener(listener);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>一旦收到java发送过来的socket请求，则解析该请求并包装为AttachOperation对象。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * accept domain socket，读取到内容后生成对应的AttachOperation</span></span><br><span class=\"line\"><span class=\"comment\"> * @return</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"function\">AttachOperation *<span class=\"title\">AttachListener::dequeue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">int</span> s;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// wait for client to connect</span></span><br><span class=\"line\">        <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sockaddr</span> <span class=\"title\">addr</span>;</span></span><br><span class=\"line\">        <span class=\"keyword\">socklen_t</span> len = <span class=\"keyword\">sizeof</span>(addr);</span><br><span class=\"line\">        RESTARTABLE(::accept(listener(), &amp;addr, &amp;len), s);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (s == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;      <span class=\"comment\">// log a warning?</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// get the credentials of the peer and check the effective uid/guid</span></span><br><span class=\"line\">        <span class=\"comment\">// - check with jeff on this.</span></span><br><span class=\"line\">        <span class=\"keyword\">uid_t</span> puid;</span><br><span class=\"line\">        <span class=\"keyword\">gid_t</span> pgid;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (::getpeereid(s, &amp;puid, &amp;pgid) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            ::close(s);</span><br><span class=\"line\">            <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">uid_t</span> euid = geteuid();</span><br><span class=\"line\">        <span class=\"keyword\">gid_t</span> egid = getegid();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//检查DS文件是否为同一个用户创建</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (puid != euid || pgid != egid) &#123;</span><br><span class=\"line\">            ::close(s);</span><br><span class=\"line\">            <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 读取文件内容，生成AttachOperation对象</span></span><br><span class=\"line\">        AttachOperation *op = read_request(s);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (op == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">            ::close(s);</span><br><span class=\"line\">            <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> op;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>最后用包装后的AttachOperation，通过函数指针调用已绑定的处理函数。</p>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">attach_listener_thread_entry</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> pdint = AttachListener::pd_init();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (pdint != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    AttachListener::set_initialized();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">        AttachOperation* op = AttachListener::dequeue();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (op == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span>;   <span class=\"comment\">// dequeue failed or shutdown</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// find the function to dispatch too</span></span><br><span class=\"line\">        AttachOperationFunctionInfo* info = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; funcs[i].name != <span class=\"literal\">NULL</span>; i++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* name = funcs[i].name;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(op-&gt;name(), name) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">                info = &amp;(funcs[i]);</span><br><span class=\"line\">                <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (info != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">            <span class=\"comment\">// dispatch to the function that implements this operation</span></span><br><span class=\"line\">            (info-&gt;func)(op);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><font color=\"red\">总结</font> ，通过信号监听–&gt;socket通信–&gt;调用指定方法的流程，实现了我们实验的预期。</p>\n<h2 id=\"四、看看JVM是怎么做的\"><a href=\"#四、看看JVM是怎么做的\" class=\"headerlink\" title=\"四、看看JVM是怎么做的\"></a>四、看看JVM是怎么做的</h2><p>最后我们回到JVM内部，看看JVM是如何实现的。</p>\n<p>由于实验代码大量的采用了JVM的实现，我们这里主要观察JVM的流程。</p>\n<ul>\n<li>JVM启动时会初始化信号的监听</li>\n</ul>\n<blockquote>\n<p>代码清单：src/share/vm/runtime/thread.cpp</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">jint <span class=\"title\">Threads::create_vm</span><span class=\"params\">(JavaVMInitArgs* args, <span class=\"keyword\">bool</span>* canTryAgain)</span> </span>&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Signal Dispatcher needs to be started before VMInit event is posted</span></span><br><span class=\"line\">  os::signal_init();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Start Attach Listener if +StartAttachListener or it can&#x27;t be started lazily</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!DisableAttachMechanism) &#123;</span><br><span class=\"line\">    AttachListener::vm_start();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (StartAttachListener || AttachListener::init_at_startup()) &#123;</span><br><span class=\"line\">      AttachListener::init();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>os::signal_init();功能我们前面已经分析过，JVM会注册kill -3信号的监听和对应的信号处理器，同时会启动一个单独的线程对监听到的信号做后续业务处理。</p>\n<p><font color=\"blue\">DisableAttachMechanism</font> &amp; <font color=\"blue\">StartAttachListener</font> 默认为false，在JVM默认启动的情况下不会初始化Attach的监听。</p>\n<blockquote>\n<p>代码清单：src/share/vm/runtime/globals.hpp</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">product(bool, DisableAttachMechanism, false,                              \\</span><br><span class=\"line\">        &quot;Disable mechanism that allows tools to attach to this VM&quot;) </span><br><span class=\"line\">product(bool, StartAttachListener, false,                                 \\</span><br><span class=\"line\">        &quot;Always start Attach Listener at VM startup&quot;)      </span><br></pre></td></tr></table></figure>\n\n<p>JVM监听到信号后，当信号位kill -3时如果还未初始化attach监听，将会进行相应初始化过程。</p>\n<blockquote>\n<p>代码清单：src/share/vm/runtime/thread.cpp-&gt;create_vm()<br>            —- src/share/vm/runtime/os.cpp-&gt;signal_init()<br>                —- src/share/vm/runtime/os.cpp-&gt;signal_thread_entry()</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">signal_thread_entry</span><span class=\"params\">(JavaThread* thread, TRAPS)</span> </span>&#123;</span><br><span class=\"line\">  os::set_priority(thread, NearMaxPriority);</span><br><span class=\"line\">  <span class=\"keyword\">while</span> (<span class=\"literal\">true</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> sig;</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"comment\">// FIXME : Currently we have not decieded what should be the status</span></span><br><span class=\"line\">      <span class=\"comment\">//         for this java thread blocked here. Once we decide about</span></span><br><span class=\"line\">      <span class=\"comment\">//         that we should fix this.</span></span><br><span class=\"line\">      sig = os::signal_wait();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (sig == os::sigexitnum_pd()) &#123;</span><br><span class=\"line\">       <span class=\"comment\">// Terminate the signal thread</span></span><br><span class=\"line\">       <span class=\"keyword\">return</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">switch</span> (sig) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">case</span> SIGBREAK: &#123;</span><br><span class=\"line\">        <span class=\"comment\">// Check if the signal is a trigger to start the Attach Listener - in that</span></span><br><span class=\"line\">        <span class=\"comment\">// case don&#x27;t print stack traces.</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!DisableAttachMechanism &amp;&amp; AttachListener::is_init_trigger()) &#123;</span><br><span class=\"line\">          <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// Print stack traces</span></span><br><span class=\"line\">        <span class=\"comment\">// Any SIGBREAK operations added here should make sure to flush</span></span><br><span class=\"line\">        <span class=\"comment\">// the output stream (e.g. tty-&gt;flush()) after output.  See 4803766.</span></span><br><span class=\"line\">        <span class=\"comment\">// Each module also prints an extra carriage return after its output.</span></span><br><span class=\"line\">        VM_PrintThreads op;</span><br><span class=\"line\">        VMThread::execute(&amp;op);</span><br><span class=\"line\">        VM_PrintJNI jni_op;</span><br><span class=\"line\">        VMThread::execute(&amp;jni_op);</span><br><span class=\"line\">        <span class=\"function\">VM_FindDeadlocks <span class=\"title\">op1</span><span class=\"params\">(tty)</span></span>;</span><br><span class=\"line\">        VMThread::execute(&amp;op1);</span><br><span class=\"line\">        Universe::print_heap_at_SIGBREAK();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (PrintClassHistogram) &#123;</span><br><span class=\"line\">          <span class=\"function\">VM_GC_HeapInspection <span class=\"title\">op1</span><span class=\"params\">(gclog_or_tty, <span class=\"literal\">true</span> <span class=\"comment\">/* force full GC before heap inspection */</span>)</span></span>;</span><br><span class=\"line\">          VMThread::execute(&amp;op1);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (JvmtiExport::should_post_data_dump()) &#123;</span><br><span class=\"line\">          JvmtiExport::post_data_dump();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      ...</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>初始化Attach监听时会检查Java客户端生成的attach文件。</p>\n<blockquote>\n<p>代码清单：src/share/vm/runtime/thread.cpp-&gt;create_vm()<br>            —- src/share/vm/runtime/os.cpp-&gt;signal_init()<br>                —- src/share/vm/runtime/os.cpp-&gt;signal_thread_entry()<br>                     —- src/os/bsd/vm/attachListener_bsd.cpp-&gt;is_init_trigger()</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">bool</span> <span class=\"title\">AttachListener::is_init_trigger</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (init_at_startup() || is_initialized()) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;               <span class=\"comment\">// initialized at startup or already initialized</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">char</span> path[PATH_MAX + <span class=\"number\">1</span>];</span><br><span class=\"line\">  <span class=\"keyword\">int</span> ret;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stat</span> <span class=\"title\">st</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">snprintf</span>(path, PATH_MAX + <span class=\"number\">1</span>, <span class=\"string\">&quot;%s/.attach_pid%d&quot;</span>,</span><br><span class=\"line\">           os::get_temp_directory(), os::current_process_id());</span><br><span class=\"line\">  RESTARTABLE(::stat(path, &amp;st), ret);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ret == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// simple check to avoid starting the attach mechanism when</span></span><br><span class=\"line\">    <span class=\"comment\">// a bogus user creates the file</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (st.st_uid == geteuid()) &#123;</span><br><span class=\"line\">      init();</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>确认Java客户端开始attach并且权限校验通过后开始socket通讯，首先初始化socket并绑定监听。</p>\n<blockquote>\n<p>代码清单： src/os/bsd/vm/attachListener_bsd.cpp-&gt;is_init_trigger()<br>            —- src/share/vm/services/attachListener.cpp-&gt;init()</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">bool</span> <span class=\"title\">AttachListener::is_init_trigger</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (init_at_startup() || is_initialized()) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;               <span class=\"comment\">// initialized at startup or already initialized</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">char</span> path[PATH_MAX + <span class=\"number\">1</span>];</span><br><span class=\"line\">  <span class=\"keyword\">int</span> ret;</span><br><span class=\"line\">  <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">stat</span> <span class=\"title\">st</span>;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">snprintf</span>(path, PATH_MAX + <span class=\"number\">1</span>, <span class=\"string\">&quot;%s/.attach_pid%d&quot;</span>,</span><br><span class=\"line\">           os::get_temp_directory(), os::current_process_id());</span><br><span class=\"line\">  RESTARTABLE(::stat(path, &amp;st), ret);</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (ret == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// simple check to avoid starting the attach mechanism when</span></span><br><span class=\"line\">    <span class=\"comment\">// a bogus user creates the file</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (st.st_uid == geteuid()) &#123;</span><br><span class=\"line\">      init();</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>最终JVM创建了一个单独的线程执行Attach监听方法，方法accept从Java客户端发送的指令，并解析为对应的函数。</p>\n<blockquote>\n<p>代码清单： src/share/vm/services/attachListener.cpp-&gt;init()<br>            —- src/share/vm/services/attachListener.cpp-&gt;attach_listener_thread_entry()</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title\">attach_listener_thread_entry</span><span class=\"params\">(JavaThread* thread, TRAPS)</span> </span>&#123;</span><br><span class=\"line\">  os::set_priority(thread, NearMaxPriority);</span><br><span class=\"line\"></span><br><span class=\"line\">  thread-&gt;record_stack_base_and_size();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (AttachListener::pd_init() != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  AttachListener::set_initialized();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    AttachOperation* op = AttachListener::dequeue();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (op == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span>;   <span class=\"comment\">// dequeue failed or shutdown</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    ResourceMark rm;</span><br><span class=\"line\">    bufferedStream st;</span><br><span class=\"line\">    jint res = JNI_OK;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// handle special detachall operation</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(op-&gt;name(), AttachOperation::detachall_operation_name()) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">      AttachListener::detachall();</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"comment\">// find the function to dispatch too</span></span><br><span class=\"line\">      AttachOperationFunctionInfo* info = <span class=\"literal\">NULL</span>;</span><br><span class=\"line\">      <span class=\"keyword\">for</span> (<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>; funcs[i].name != <span class=\"literal\">NULL</span>; i++) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">const</span> <span class=\"keyword\">char</span>* name = funcs[i].name;</span><br><span class=\"line\">        assert(<span class=\"built_in\">strlen</span>(name) &lt;= AttachOperation::name_length_max, <span class=\"string\">&quot;operation &lt;= name_length_max&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"built_in\">strcmp</span>(op-&gt;name(), name) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">          info = &amp;(funcs[i]);</span><br><span class=\"line\">          <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\">// check for platform dependent attach operation</span></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (info == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">        info = AttachListener::pd_find_operation(op-&gt;name());</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"keyword\">if</span> (info != <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">        <span class=\"comment\">// dispatch to the function that implements this operation</span></span><br><span class=\"line\">        res = (info-&gt;func)(op, &amp;st);</span><br><span class=\"line\">      &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        st.print(<span class=\"string\">&quot;Operation %s not recognized!&quot;</span>, op-&gt;name());</span><br><span class=\"line\">        res = JNI_ERR;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// operation complete - send result and output to client</span></span><br><span class=\"line\">    op-&gt;complete(res, &amp;st);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>代码清单： src/share/vm/services/attachListener.cpp-&gt;attach_listener_thread_entry()<br>            —- src/os/bsd/vm/attachListener_bsd.cpp-&gt;dequeue()<br>                 —- src/os/bsd/vm/attachListener_bsd.cpp-&gt;BsdAttachListener::dequeue()</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\">BsdAttachOperation* <span class=\"title\">BsdAttachListener::dequeue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">  <span class=\"keyword\">for</span> (;;) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">int</span> s;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// wait for client to connect</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">struct</span> <span class=\"title\">sockaddr</span> <span class=\"title\">addr</span>;</span></span><br><span class=\"line\">    <span class=\"keyword\">socklen_t</span> len = <span class=\"keyword\">sizeof</span>(addr);</span><br><span class=\"line\">    RESTARTABLE(::accept(listener(), &amp;addr, &amp;len), s);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (s == <span class=\"number\">-1</span>) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> <span class=\"literal\">NULL</span>;      <span class=\"comment\">// log a warning?</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// get the credentials of the peer and check the effective uid/guid</span></span><br><span class=\"line\">    <span class=\"comment\">// - check with jeff on this.</span></span><br><span class=\"line\">    <span class=\"keyword\">uid_t</span> puid;</span><br><span class=\"line\">    <span class=\"keyword\">gid_t</span> pgid;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (::getpeereid(s, &amp;puid, &amp;pgid) != <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">      ::close(s);</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">uid_t</span> euid = geteuid();</span><br><span class=\"line\">    <span class=\"keyword\">gid_t</span> egid = getegid();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (puid != euid || pgid != egid) &#123;</span><br><span class=\"line\">      ::close(s);</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// peer credential look okay so we read the request</span></span><br><span class=\"line\">    BsdAttachOperation* op = read_request(s);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (op == <span class=\"literal\">NULL</span>) &#123;</span><br><span class=\"line\">      ::close(s);</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">return</span> op;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>指令与方法的映射是事先准备好的</p>\n<blockquote>\n<p>代码清单：src/share/vm/services/attachListener.cpp</p>\n</blockquote>\n<figure class=\"highlight c++\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">static</span> AttachOperationFunctionInfo funcs[] = &#123;</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;agentProperties&quot;</span>,  get_agent_properties &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;datadump&quot;</span>,         data_dump &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;dumpheap&quot;</span>,         dump_heap &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;load&quot;</span>,             JvmtiExport::load_agent_library &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;properties&quot;</span>,       get_system_properties &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;threaddump&quot;</span>,       thread_dump &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;inspectheap&quot;</span>,      heap_inspection &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;setflag&quot;</span>,          set_flag &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;printflag&quot;</span>,        print_flag &#125;,</span><br><span class=\"line\">  &#123; <span class=\"string\">&quot;jcmd&quot;</span>,             jcmd &#125;,</span><br><span class=\"line\">  &#123; <span class=\"literal\">NULL</span>,               <span class=\"literal\">NULL</span> &#125;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n\n\n<p><font color=\"red\">总结</font>,相信通过上面的分析我们已经清楚的了解JVM是如何接收到Java客户端发起的请求，从而实现动态Attach的功能。具体流程如图：<br><img src=\"/2020/09/21/%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90JVM-%E5%8A%A8%E6%80%81Attach%E5%8E%9F%E7%90%86/flow.png\" alt=\"03\"></p>"}],"PostAsset":[{"_id":"source/_posts/CSAPP-Docker实验环境搭建/pull.png","slug":"pull.png","post":"ckis71hsv0001v252awm830es","modified":0,"renderable":0},{"_id":"source/_posts/CSAPP-Docker实验环境搭建/search.png","slug":"search.png","post":"ckis71hsv0001v252awm830es","modified":0,"renderable":0},{"_id":"source/_posts/Harmonica/GodenMelody.jpeg","slug":"GodenMelody.jpeg","post":"ckis71hsz0003v2522odqc0cl","modified":0,"renderable":0},{"_id":"source/_posts/Harmonica/SilverStar.jpeg","slug":"SilverStar.jpeg","post":"ckis71hsz0003v2522odqc0cl","modified":0,"renderable":0},{"_id":"source/_posts/hexo搭建问题【-no-layout-index-html】/nolayout.jpg","slug":"nolayout.jpg","post":"ckis71ht6000cv2526aao0clh","modified":0,"renderable":0},{"_id":"source/_posts/一个事故引起的缓存/springCache.png","slug":"springCache.png","post":"ckis71hta000hv252gby12mkn","modified":0,"renderable":0},{"_id":"source/_posts/一个事故引起的缓存/多级缓存.png","slug":"多级缓存.png","post":"ckis71hta000hv252gby12mkn","modified":0,"renderable":0},{"_id":"source/_posts/基于Flink推送报警信息-测试/flink-local.png","slug":"flink-local.png","post":"ckis71hth000wv252el9hayof","modified":0,"renderable":0},{"_id":"source/_posts/基于Flink推送报警信息-测试/rocketmq-dashboard.png","slug":"rocketmq-dashboard.png","post":"ckis71hth000wv252el9hayof","modified":0,"renderable":0},{"_id":"source/_posts/基于Flink推送报警信息-测试/rocketmq-message.png","slug":"rocketmq-message.png","post":"ckis71hth000wv252el9hayof","modified":0,"renderable":0},{"_id":"source/_posts/基于Flink推送报警信息-测试/rocketmq-topic.png","slug":"rocketmq-topic.png","post":"ckis71hth000wv252el9hayof","modified":0,"renderable":0},{"_id":"source/_posts/基于Flink推送报警信息-测试/wechat-message.png","slug":"wechat-message.png","post":"ckis71hth000wv252el9hayof","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/addGroup.png","slug":"addGroup.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/allocate.png","slug":"allocate.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/allocateConfigs.png","slug":"allocateConfigs.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/clientLog.png","slug":"clientLog.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/compare.png","slug":"compare.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/completeTask.png","slug":"completeTask.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/configs.png","slug":"configs.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/history.png","slug":"history.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/instance.png","slug":"instance.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/instanceConfig.png","slug":"instanceConfig.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/metadata.png","slug":"metadata.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/operationLog.png","slug":"operationLog.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/pendingTask.png","slug":"pendingTask.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/processingTask.png","slug":"processingTask.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/role.png","slug":"role.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/switch.png","slug":"switch.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/user.png","slug":"user.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/主页面.png","slug":"主页面.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/服务部署图.png","slug":"服务部署图.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/注册.png","slug":"注册.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-介绍篇/登录.png","slug":"登录.png","post":"ckis71htk0012v252dysvfnfm","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-设计篇2/CentOS6-Base-163.repo","slug":"CentOS6-Base-163.repo","post":"ckis71htm0018v252039k1qwo","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-设计篇2/客户端启动并更新配置.png","slug":"客户端启动并更新配置.png","post":"ckis71htm0018v252039k1qwo","modified":0,"renderable":0},{"_id":"source/_posts/我为什么会重新写一个配置中心-设计篇2/服务端热更新配置.png","slug":"服务端热更新配置.png","post":"ckis71htm0018v252039k1qwo","modified":0,"renderable":0},{"_id":"source/_posts/自己动手写Java虚拟机-笔记1/gopath.png","slug":"gopath.png","post":"ckis71hts001nv252hbb3dttk","modified":0,"renderable":0},{"_id":"source/_posts/自己动手写Java虚拟机-笔记4/运行时数据区.png","slug":"运行时数据区.png","post":"ckis71htx001yv252bj0094ri","modified":0,"renderable":0},{"_id":"source/_posts/记一次序列化失败导致的生产问题/wenti.png","slug":"wenti.png","post":"ckis71hty0021v2526zju8kpj","modified":0,"renderable":0},{"_id":"source/_posts/🐇/全景.jpeg","slug":"全景.jpeg","post":"ckis71htz0023v2523flh1jar","modified":0,"renderable":0},{"_id":"source/_posts/🐇/牌子.jpeg","slug":"牌子.jpeg","post":"ckis71htz0023v2523flh1jar","modified":0,"renderable":0},{"_id":"source/_posts/fastjson序列化异常排查/BytecodeVerificationJunit.png","slug":"BytecodeVerificationJunit.png","post":"ckis71huj004nv252f90fazco","modified":0,"renderable":0},{"_id":"source/_posts/fastjson序列化异常排查/BytecodeVerificationWithApp.png","slug":"BytecodeVerificationWithApp.png","post":"ckis71huj004nv252f90fazco","modified":0,"renderable":0},{"_id":"source/_posts/fastjson序列化异常排查/class_browser.png","slug":"class_browser.png","post":"ckis71huj004nv252f90fazco","modified":0,"renderable":0},{"_id":"source/_posts/fastjson序列化异常排查/classload断点.png","slug":"classload断点.png","post":"ckis71huj004nv252f90fazco","modified":0,"renderable":0},{"_id":"source/_posts/fastjson序列化异常排查/constantpool.png","slug":"constantpool.png","post":"ckis71huj004nv252f90fazco","modified":0,"renderable":0},{"_id":"source/_posts/fastjson序列化异常排查/hdbs_attach.png","slug":"hdbs_attach.png","post":"ckis71huj004nv252f90fazco","modified":0,"renderable":0},{"_id":"source/_posts/fastjson序列化异常排查/idea.png","slug":"idea.png","post":"ckis71huj004nv252f90fazco","modified":0,"renderable":0},{"_id":"source/_posts/fastjson序列化异常排查/jps.png","slug":"jps.png","post":"ckis71huj004nv252f90fazco","modified":0,"renderable":0},{"_id":"source/_posts/fastjson序列化异常排查/visualVM.png","slug":"visualVM.png","post":"ckis71huj004nv252f90fazco","modified":0,"renderable":0},{"_id":"source/_posts/深度解析JVM-动态Attach原理/JVM_start.png","slug":"JVM_start.png","post":"ckis71hul004qv252637lc9sc","modified":0,"renderable":0},{"_id":"source/_posts/深度解析JVM-动态Attach原理/flow.png","slug":"flow.png","post":"ckis71hul004qv252637lc9sc","modified":0,"renderable":0},{"_id":"source/_posts/深度解析JVM-动态Attach原理/load_agent_library.png","slug":"load_agent_library.png","post":"ckis71hul004qv252637lc9sc","modified":0,"renderable":0}],"PostCategory":[{"post_id":"ckis71ht30008v252fd3b0ipn","category_id":"ckis71ht00004v25299na538q","_id":"ckis71ht8000ev2523azvacrl"},{"post_id":"ckis71hsv0001v252awm830es","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htb000iv252431z2hkd"},{"post_id":"ckis71ht40009v252hkw3edgq","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htc000lv2526fi1dtub"},{"post_id":"ckis71ht6000cv2526aao0clh","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hte000pv2523f1q26qb"},{"post_id":"ckis71hsz0003v2522odqc0cl","category_id":"ckis71ht5000av252cpwx47dv","_id":"ckis71htf000sv252exte8e30"},{"post_id":"ckis71ht7000dv2527ey8fo8p","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hth000vv2529xoi8lka"},{"post_id":"ckis71hta000hv252gby12mkn","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hth000xv252fhcsh36s"},{"post_id":"ckis71ht20007v252axr85fg5","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hti000zv2525zq18kvl"},{"post_id":"ckis71htc000kv25248magx16","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htl0013v2520t667rlu"},{"post_id":"ckis71htd000ov2529oao6um7","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htl0016v2526qypbi06"},{"post_id":"ckis71htf000rv2524z0l9tfk","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htn0019v25259akf9k6"},{"post_id":"ckis71htg000uv25243rb7mpl","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hto001bv2529qef1ot4"},{"post_id":"ckis71hth000wv252el9hayof","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htp001ev2528axk10ij"},{"post_id":"ckis71hti000yv252112dc7je","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htq001hv25294nodzfu"},{"post_id":"ckis71htk0012v252dysvfnfm","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htr001lv252evf85cnu"},{"post_id":"ckis71htl0015v2521jmd29wg","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hts001ov2526ehsghmg"},{"post_id":"ckis71htm0018v252039k1qwo","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htw001sv252c5r13qkd"},{"post_id":"ckis71htn001av252bj839727","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htw001vv2525e771v86"},{"post_id":"ckis71hto001dv2527yj851zv","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hty001zv252593mdnww"},{"post_id":"ckis71htq001kv252amvo3uoz","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htz0022v252eschewgh"},{"post_id":"ckis71hts001nv252hbb3dttk","category_id":"ckis71ht00004v25299na538q","_id":"ckis71htz0024v252fdo63uvb"},{"post_id":"ckis71htt001rv2527zex6mbp","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hu00027v2521x87hsuu"},{"post_id":"ckis71htp001gv252ehia4tyn","category_id":"ckis71htr001mv252fp9k9bwp","_id":"ckis71hu1002av252dwr3e2j0"},{"post_id":"ckis71htw001uv2525k2udzt3","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hu1002cv2526vhs8x9l"},{"post_id":"ckis71htx001yv252bj0094ri","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hu1002dv252die2940p"},{"post_id":"ckis71hty0021v2526zju8kpj","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hu2002fv2523uy6e781"},{"post_id":"ckis71htz0023v2523flh1jar","category_id":"ckis71hu00028v252enjlgu71","_id":"ckis71hu2002gv2527yyrc2rj"},{"post_id":"ckis71huj004nv252f90fazco","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hum004sv2529r5596fx"},{"post_id":"ckis71huk004ov252bwtrab0t","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hum004uv2524jcq953j"},{"post_id":"ckis71hul004qv252637lc9sc","category_id":"ckis71ht00004v25299na538q","_id":"ckis71hun004xv252dfq8ban2"}],"PostTag":[{"post_id":"ckis71hsv0001v252awm830es","tag_id":"ckis71ht10005v2523nu2hftc","_id":"ckis71htb000jv2528855f0re"},{"post_id":"ckis71hsv0001v252awm830es","tag_id":"ckis71ht5000bv2520enu5s1w","_id":"ckis71htc000mv25264x25m3q"},{"post_id":"ckis71hsz0003v2522odqc0cl","tag_id":"ckis71ht8000gv2522qizfd05","_id":"ckis71hte000qv252ax7w9uw6"},{"post_id":"ckis71ht20007v252axr85fg5","tag_id":"ckis71htd000nv2522dfn8srp","_id":"ckis71htk0011v2520pr8dcgx"},{"post_id":"ckis71ht20007v252axr85fg5","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71htl0014v2521hwx6ikk"},{"post_id":"ckis71ht30008v252fd3b0ipn","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71htp001fv252hgfkcsbc"},{"post_id":"ckis71ht30008v252fd3b0ipn","tag_id":"ckis71htm0017v25222fjhnur","_id":"ckis71htq001iv252brb160s1"},{"post_id":"ckis71htq001kv252amvo3uoz","tag_id":"ckis71ht5000bv2520enu5s1w","_id":"ckis71htt001qv252huak4144"},{"post_id":"ckis71ht40009v252hkw3edgq","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71htw001tv252aeo593cu"},{"post_id":"ckis71ht40009v252hkw3edgq","tag_id":"ckis71htq001jv252ed8p1rgy","_id":"ckis71htx001wv252g9sd4xvz"},{"post_id":"ckis71ht6000cv2526aao0clh","tag_id":"ckis71hts001pv25271l49ht8","_id":"ckis71hty0020v2522zq9hol4"},{"post_id":"ckis71ht7000dv2527ey8fo8p","tag_id":"ckis71htx001xv25245zncqgy","_id":"ckis71hu00026v252g6p4d3cf"},{"post_id":"ckis71ht7000dv2527ey8fo8p","tag_id":"ckis71ht5000bv2520enu5s1w","_id":"ckis71hu10029v252afrqga2n"},{"post_id":"ckis71hta000hv252gby12mkn","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hu2002iv2529i98g70x"},{"post_id":"ckis71hta000hv252gby12mkn","tag_id":"ckis71hu1002bv2527t6xh8tx","_id":"ckis71hu2002jv252a2hoabz2"},{"post_id":"ckis71hta000hv252gby12mkn","tag_id":"ckis71hu1002ev252au6f5qbk","_id":"ckis71hu3002lv2520pqchgf9"},{"post_id":"ckis71htc000kv25248magx16","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hu3002mv252erz67s3j"},{"post_id":"ckis71htd000ov2529oao6um7","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hu3002ov252a8dhdstx"},{"post_id":"ckis71htf000rv2524z0l9tfk","tag_id":"ckis71ht5000bv2520enu5s1w","_id":"ckis71hu4002rv2524z971tkm"},{"post_id":"ckis71htf000rv2524z0l9tfk","tag_id":"ckis71hu3002nv252bwb92m3t","_id":"ckis71hu4002sv252b7ht92i0"},{"post_id":"ckis71htf000rv2524z0l9tfk","tag_id":"ckis71hu3002pv252d2xw7o9u","_id":"ckis71hu4002uv2523nf664jj"},{"post_id":"ckis71htg000uv25243rb7mpl","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hu5002xv252ee62czix"},{"post_id":"ckis71htg000uv25243rb7mpl","tag_id":"ckis71hu4002tv252fsqre997","_id":"ckis71hu5002yv2528fgb5oe7"},{"post_id":"ckis71htg000uv25243rb7mpl","tag_id":"ckis71hu4002vv252bfxbdxgo","_id":"ckis71hu50030v2521cph26k8"},{"post_id":"ckis71hth000wv252el9hayof","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hu60032v252bf3tadu8"},{"post_id":"ckis71hth000wv252el9hayof","tag_id":"ckis71hu4002tv252fsqre997","_id":"ckis71hu60033v252dws96ap7"},{"post_id":"ckis71hth000wv252el9hayof","tag_id":"ckis71hu4002vv252bfxbdxgo","_id":"ckis71hu60035v2523gnob2je"},{"post_id":"ckis71hti000yv252112dc7je","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hu70037v252gwcu1j71"},{"post_id":"ckis71hti000yv252112dc7je","tag_id":"ckis71hu4002tv252fsqre997","_id":"ckis71hu70038v252frzoft72"},{"post_id":"ckis71hti000yv252112dc7je","tag_id":"ckis71hu4002vv252bfxbdxgo","_id":"ckis71hu7003av2524uord9dn"},{"post_id":"ckis71htk0012v252dysvfnfm","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hu8003cv2523dfoc12o"},{"post_id":"ckis71htk0012v252dysvfnfm","tag_id":"ckis71hu1002bv2527t6xh8tx","_id":"ckis71hu8003dv25284g0592p"},{"post_id":"ckis71htk0012v252dysvfnfm","tag_id":"ckis71hu70039v2522ca114iv","_id":"ckis71hu8003fv252001ngohs"},{"post_id":"ckis71htl0015v2521jmd29wg","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hu9003hv2524k9a745w"},{"post_id":"ckis71htl0015v2521jmd29wg","tag_id":"ckis71hu1002bv2527t6xh8tx","_id":"ckis71hu9003iv25201r5fclf"},{"post_id":"ckis71htl0015v2521jmd29wg","tag_id":"ckis71hu70039v2522ca114iv","_id":"ckis71hu9003kv252f4m8a16p"},{"post_id":"ckis71htm0018v252039k1qwo","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hua003mv2522hojds2i"},{"post_id":"ckis71htm0018v252039k1qwo","tag_id":"ckis71hu1002bv2527t6xh8tx","_id":"ckis71hua003nv2524hos2gi3"},{"post_id":"ckis71htm0018v252039k1qwo","tag_id":"ckis71hu70039v2522ca114iv","_id":"ckis71hua003pv2529d4cbhsj"},{"post_id":"ckis71htn001av252bj839727","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hub003rv2522b9w1aqa"},{"post_id":"ckis71htn001av252bj839727","tag_id":"ckis71hu1002bv2527t6xh8tx","_id":"ckis71hub003sv252e0xs87z8"},{"post_id":"ckis71htn001av252bj839727","tag_id":"ckis71hu70039v2522ca114iv","_id":"ckis71hub003uv252160h1na9"},{"post_id":"ckis71hto001dv2527yj851zv","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71huc003wv2526tnh1ki3"},{"post_id":"ckis71hto001dv2527yj851zv","tag_id":"ckis71hu1002bv2527t6xh8tx","_id":"ckis71huc003xv2520ggid11j"},{"post_id":"ckis71hto001dv2527yj851zv","tag_id":"ckis71hu70039v2522ca114iv","_id":"ckis71huc003zv2529z0t8wwv"},{"post_id":"ckis71htp001gv252ehia4tyn","tag_id":"ckis71hub003vv2523scgaxhb","_id":"ckis71hud0041v252bs4l3t8e"},{"post_id":"ckis71htp001gv252ehia4tyn","tag_id":"ckis71huc003yv2523kchbmxs","_id":"ckis71hud0042v2527j46hmmz"},{"post_id":"ckis71hts001nv252hbb3dttk","tag_id":"ckis71htd000nv2522dfn8srp","_id":"ckis71hud0044v2520t159hcr"},{"post_id":"ckis71hts001nv252hbb3dttk","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hud0045v2522vu676br"},{"post_id":"ckis71hts001nv252hbb3dttk","tag_id":"ckis71huc0040v252960e7h44","_id":"ckis71hue0047v25292s57kpi"},{"post_id":"ckis71htt001rv2527zex6mbp","tag_id":"ckis71htd000nv2522dfn8srp","_id":"ckis71hue0048v252bzvwcxcv"},{"post_id":"ckis71htt001rv2527zex6mbp","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71huf004av2526za0f6cp"},{"post_id":"ckis71htt001rv2527zex6mbp","tag_id":"ckis71huc0040v252960e7h44","_id":"ckis71huf004bv2523l998dot"},{"post_id":"ckis71htw001uv2525k2udzt3","tag_id":"ckis71htd000nv2522dfn8srp","_id":"ckis71huf004dv252amgc09b7"},{"post_id":"ckis71htw001uv2525k2udzt3","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hug004ev25227y4a41t"},{"post_id":"ckis71htw001uv2525k2udzt3","tag_id":"ckis71huc0040v252960e7h44","_id":"ckis71hug004gv252b91m2e3q"},{"post_id":"ckis71htx001yv252bj0094ri","tag_id":"ckis71htd000nv2522dfn8srp","_id":"ckis71hug004hv252aj2z2fsr"},{"post_id":"ckis71htx001yv252bj0094ri","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hug004iv252fwzja2vz"},{"post_id":"ckis71htx001yv252bj0094ri","tag_id":"ckis71huc0040v252960e7h44","_id":"ckis71hug004jv252bk941ktl"},{"post_id":"ckis71hty0021v2526zju8kpj","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hug004kv2528lug1c3i"},{"post_id":"ckis71hty0021v2526zju8kpj","tag_id":"ckis71huf004cv2524gq851pa","_id":"ckis71hug004lv2523g6p42p8"},{"post_id":"ckis71htz0023v2523flh1jar","tag_id":"ckis71hug004fv2523wbecrky","_id":"ckis71hug004mv252h38icqys"},{"post_id":"ckis71huk004ov252bwtrab0t","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hum004rv2529nxoddx6"},{"post_id":"ckis71huk004ov252bwtrab0t","tag_id":"ckis71hu1002bv2527t6xh8tx","_id":"ckis71hum004tv25219hqdyza"},{"post_id":"ckis71huk004ov252bwtrab0t","tag_id":"ckis71hu70039v2522ca114iv","_id":"ckis71hun004wv2520pu23myh"},{"post_id":"ckis71hul004qv252637lc9sc","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hun004yv2527hmahthr"},{"post_id":"ckis71hul004qv252637lc9sc","tag_id":"ckis71htd000nv2522dfn8srp","_id":"ckis71hun004zv252bfyqd1fw"},{"post_id":"ckis71huj004nv252f90fazco","tag_id":"ckis71htg000tv2529k5h69wd","_id":"ckis71hun0050v2526xq6f4ft"},{"post_id":"ckis71huj004nv252f90fazco","tag_id":"ckis71hul004pv2527a3v7m3q","_id":"ckis71hun0051v2521o7q9p7z"},{"post_id":"ckis71huj004nv252f90fazco","tag_id":"ckis71hum004vv252hv2309hj","_id":"ckis71hun0052v252357063d9"}],"Tag":[{"name":"CSAPP","_id":"ckis71ht10005v2523nu2hftc"},{"name":"C","_id":"ckis71ht5000bv2520enu5s1w"},{"name":"Harmonica","_id":"ckis71ht8000gv2522qizfd05"},{"name":"JVM","_id":"ckis71htd000nv2522dfn8srp"},{"name":"Java","_id":"ckis71htg000tv2529k5h69wd"},{"name":"IO","_id":"ckis71htm0017v25222fjhnur"},{"name":"Springboot","_id":"ckis71htq001jv252ed8p1rgy"},{"name":"Hexo","_id":"ckis71hts001pv25271l49ht8"},{"name":"Linux","_id":"ckis71htx001xv25245zncqgy"},{"name":"Redis","_id":"ckis71hu1002bv2527t6xh8tx"},{"name":"Cache","_id":"ckis71hu1002ev252au6f5qbk"},{"name":"GCC","_id":"ckis71hu3002nv252bwb92m3t"},{"name":"代码优化","_id":"ckis71hu3002pv252d2xw7o9u"},{"name":"Flink","_id":"ckis71hu4002tv252fsqre997"},{"name":"监控","_id":"ckis71hu4002vv252bfxbdxgo"},{"name":"配置中心","_id":"ckis71hu70039v2522ca114iv"},{"name":"AI","_id":"ckis71hub003vv2523scgaxhb"},{"name":"APP","_id":"ckis71huc003yv2523kchbmxs"},{"name":"Go","_id":"ckis71huc0040v252960e7h44"},{"name":"Spring Boot","_id":"ckis71huf004cv2524gq851pa"},{"name":"Food","_id":"ckis71hug004fv2523wbecrky"},{"name":"fastjson","_id":"ckis71hul004pv2527a3v7m3q"},{"name":"ASM","_id":"ckis71hum004vv252hv2309hj"}]}}